# æ€§èƒ½ç›‘æ§ä¸ç³»ç»Ÿä¼˜åŒ–

> APMç›‘æ§ã€æ€§èƒ½æµ‹è¯•ã€æ•°æ®åº“ä¼˜åŒ–ã€ç¼“å­˜ä¼˜åŒ–ã€ç³»ç»Ÿè°ƒä¼˜

---

## ğŸ“‹ ç›®å½•

1. [APMç›‘æ§ä½“ç³»](#1-apmç›‘æ§ä½“ç³»)
2. [æ€§èƒ½æµ‹è¯•](#2-æ€§èƒ½æµ‹è¯•)
3. [æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–](#3-æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–)
4. [ç¼“å­˜æ€§èƒ½ä¼˜åŒ–](#4-ç¼“å­˜æ€§èƒ½ä¼˜åŒ–)
5. [åº”ç”¨å±‚ä¼˜åŒ–](#5-åº”ç”¨å±‚ä¼˜åŒ–)
6. [ç³»ç»Ÿè°ƒä¼˜](#6-ç³»ç»Ÿè°ƒä¼˜)

---

## 1. APMç›‘æ§ä½“ç³»

### 1.1 Prometheus + Grafana

**æ¶æ„**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  App (JVM)  â”‚ â† Micrometeré‡‡é›†æŒ‡æ ‡
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ /actuator/prometheus
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Prometheus  â”‚ â† æ—¶åºæ•°æ®åº“ï¼Œå­˜å‚¨æŒ‡æ ‡
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ PromQLæŸ¥è¯¢
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Grafana    â”‚ â† å¯è§†åŒ–å±•ç¤º
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Spring Booté›†æˆ**ï¼š
```xml
<!-- pom.xml -->
<dependencies>
    <!-- Actuator -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-actuator</artifactId>
    </dependency>
    
    <!-- Micrometer Prometheus -->
    <dependency>
        <groupId>io.micrometer</groupId>
        <artifactId>micrometer-registry-prometheus</artifactId>
    </dependency>
</dependencies>
```

```yaml
# application.yml
management:
  endpoints:
    web:
      exposure:
        include: '*'  # æš´éœ²æ‰€æœ‰ç«¯ç‚¹
  metrics:
    export:
      prometheus:
        enabled: true
    tags:
      application: ${spring.application.name}
```

**è‡ªå®šä¹‰æŒ‡æ ‡**ï¼š
```java
@Service
public class OrderService {
    
    private final Counter orderCounter;
    private final Timer orderTimer;
    
    public OrderService(MeterRegistry meterRegistry) {
        // è®¡æ•°å™¨ï¼šç»Ÿè®¡è®¢å•æ•°é‡
        this.orderCounter = Counter.builder("orders.created")
            .description("Total orders created")
            .tag("type", "order")
            .register(meterRegistry);
        
        // è®¡æ—¶å™¨ï¼šç»Ÿè®¡è®¢å•å¤„ç†æ—¶é—´
        this.orderTimer = Timer.builder("orders.process.time")
            .description("Order processing time")
            .tag("type", "order")
            .register(meterRegistry);
    }
    
    public void createOrder(OrderDTO order) {
        orderTimer.record(() -> {
            // ä¸šåŠ¡é€»è¾‘
            doCreateOrder(order);
            
            // è®¡æ•°+1
            orderCounter.increment();
        });
    }
}
```

**Prometheusé…ç½®**ï¼š
```yaml
# prometheus.yml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  - job_name: 'spring-boot-app'
    metrics_path: '/actuator/prometheus'
    static_configs:
      - targets: ['localhost:8080']
        labels:
          app: 'order-service'
          env: 'production'
```

**Grafana Dashboardé…ç½®**ï¼š
```json
{
  "dashboard": {
    "title": "Spring Boot Metrics",
    "panels": [
      {
        "title": "JVM Heap Memory",
        "targets": [
          {
            "expr": "jvm_memory_used_bytes{area=\"heap\"}"
          }
        ]
      },
      {
        "title": "GC Time",
        "targets": [
          {
            "expr": "rate(jvm_gc_pause_seconds_sum[5m])"
          }
        ]
      },
      {
        "title": "HTTP Requests",
        "targets": [
          {
            "expr": "rate(http_server_requests_seconds_count[5m])"
          }
        ]
      }
    ]
  }
}
```

### 1.2 Skywalkingé“¾è·¯è¿½è¸ª

**æ¶æ„**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Service A   â”‚â”€â”€â”€â”€>â”‚  Service B   â”‚â”€â”€â”€â”€>â”‚  Service C   â”‚
â”‚  (Agent)     â”‚     â”‚  (Agent)     â”‚     â”‚  (Agent)     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                    â”‚                    â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  OAP Server    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  SkyWalking UI â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**éƒ¨ç½²Agent**ï¼š
```bash
# ä¸‹è½½Skywalking Agent
wget https://archive.apache.org/dist/skywalking/java-agent/8.16.0/apache-skywalking-java-agent-8.16.0.tgz
tar -zxvf apache-skywalking-java-agent-8.16.0.tgz

# å¯åŠ¨åº”ç”¨æ—¶åŠ è½½Agent
java -javaagent:/path/to/skywalking-agent.jar \
     -Dskywalking.agent.service_name=order-service \
     -Dskywalking.collector.backend_service=localhost:11800 \
     -jar app.jar
```

**Spring Booté›†æˆ**ï¼š
```yaml
# application.yml
skywalking:
  agent:
    service_name: ${spring.application.name}
    collector:
      backend_service: localhost:11800
    logging:
      level: INFO
```

**è‡ªå®šä¹‰è¿½è¸ª**ï¼š
```java
@Service
public class OrderService {
    
    /**
     * è‡ªå®šä¹‰Span
     */
    @Trace
    @Tag(key = "order_id", value = "arg[0]")
    public void processOrder(Long orderId) {
        // ä¸šåŠ¡é€»è¾‘
        ActiveSpan.tag("user_id", "12345");
        ActiveSpan.info("Processing order: " + orderId);
        
        // ... ä¸šåŠ¡å¤„ç†
    }
}
```

### 1.3 ELKæ—¥å¿—ç›‘æ§

**æ¶æ„**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  App (Logback)â”‚ â†’ å†™æ—¥å¿—æ–‡ä»¶
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Filebeat    â”‚ â†’ é‡‡é›†æ—¥å¿—
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Logstash    â”‚ â†’ å¤„ç†æ—¥å¿—
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Elasticsearchâ”‚ â†’ å­˜å‚¨æ—¥å¿—
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Kibana     â”‚ â†’ æŸ¥è¯¢ã€åˆ†æ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Logbacké…ç½®**ï¼š
```xml
<!-- logback-spring.xml -->
<configuration>
    <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>/var/log/app.log</file>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>/var/log/app.%d{yyyy-MM-dd}.log</fileNamePattern>
            <maxHistory>30</maxHistory>
        </rollingPolicy>
        <encoder class="net.logstash.logback.encoder.LogstashEncoder">
            <customFields>{"app":"order-service","env":"prod"}</customFields>
        </encoder>
    </appender>
    
    <root level="INFO">
        <appender-ref ref="FILE"/>
    </root>
</configuration>
```

**Filebeaté…ç½®**ï¼š
```yaml
# filebeat.yml
filebeat.inputs:
  - type: log
    enabled: true
    paths:
      - /var/log/app*.log
    fields:
      app: order-service
      env: production

output.logstash:
  hosts: ["localhost:5044"]
```

**Logstashé…ç½®**ï¼š
```ruby
# logstash.conf
input {
  beats {
    port => 5044
  }
}

filter {
  json {
    source => "message"
  }
  
  date {
    match => ["timestamp", "ISO8601"]
  }
}

output {
  elasticsearch {
    hosts => ["localhost:9200"]
    index => "app-logs-%{+YYYY.MM.dd}"
  }
}
```

---

## 2. æ€§èƒ½æµ‹è¯•

### 2.1 JMeterå‹æµ‹

**æµ‹è¯•è®¡åˆ’**ï¼š
```xml
<!-- test-plan.jmx -->
<jmeterTestPlan version="1.2">
  <hashTree>
    <TestPlan guiclass="TestPlanGui" testclass="TestPlan" testname="APIå‹æµ‹">
      <stringProp name="TestPlan.comments">è®¢å•æ¥å£å‹æµ‹</stringProp>
    </TestPlan>
    
    <hashTree>
      <!-- çº¿ç¨‹ç»„ -->
      <ThreadGroup guiclass="ThreadGroupGui" testclass="ThreadGroup" testname="ç”¨æˆ·çº¿ç¨‹">
        <stringProp name="ThreadGroup.num_threads">100</stringProp>  <!-- 100å¹¶å‘ -->
        <stringProp name="ThreadGroup.ramp_time">10</stringProp>      <!-- 10ç§’å¯åŠ¨ -->
        <stringProp name="ThreadGroup.duration">300</stringProp>      <!-- æŒç»­5åˆ†é’Ÿ -->
      </ThreadGroup>
      
      <hashTree>
        <!-- HTTPè¯·æ±‚ -->
        <HTTPSamplerProxy guiclass="HttpTestSampleGui" testclass="HTTPSamplerProxy" testname="åˆ›å»ºè®¢å•">
          <stringProp name="HTTPSampler.domain">localhost</stringProp>
          <stringProp name="HTTPSampler.port">8080</stringProp>
          <stringProp name="HTTPSampler.path">/api/orders</stringProp>
          <stringProp name="HTTPSampler.method">POST</stringProp>
          <boolProp name="HTTPSampler.follow_redirects">true</boolProp>
        </HTTPSamplerProxy>
      </hashTree>
    </hashTree>
  </hashTree>
</jmeterTestPlan>
```

**å…³é”®æŒ‡æ ‡**ï¼š
```
1. ååé‡ï¼ˆTPSï¼‰ï¼š
   - æ¯ç§’å¤„ç†çš„äº‹åŠ¡æ•°
   - ç›®æ ‡ï¼š>1000 TPS

2. å“åº”æ—¶é—´ï¼š
   - å¹³å‡å“åº”æ—¶é—´ï¼š<200ms
   - P95ï¼š<500ms
   - P99ï¼š<1000ms

3. é”™è¯¯ç‡ï¼š
   - ç›®æ ‡ï¼š<1%

4. èµ„æºä½¿ç”¨ï¼š
   - CPUï¼š<80%
   - å†…å­˜ï¼š<80%
   - æ•°æ®åº“è¿æ¥ï¼š<80%
```

### 2.2 Gatlingå‹æµ‹

```scala
// OrderSimulation.scala
import io.gatling.core.Predef._
import io.gatling.http.Predef._
import scala.concurrent.duration._

class OrderSimulation extends Simulation {
  
  val httpProtocol = http
    .baseUrl("http://localhost:8080")
    .acceptHeader("application/json")
  
  val scn = scenario("CreateOrder")
    .exec(http("åˆ›å»ºè®¢å•")
      .post("/api/orders")
      .body(StringBody("""{"productId":1,"count":2}"""))
      .check(status.is(200))
    )
  
  setUp(
    scn.inject(
      rampUsersPerSec(10) to 100 during (1 minute),  // 1åˆ†é’Ÿå†…ä»10å¢åŠ åˆ°100 RPS
      constantUsersPerSec(100) during (5 minutes)    // ä¿æŒ100 RPSæŒç»­5åˆ†é’Ÿ
    )
  ).protocols(httpProtocol)
}
```

### 2.3 æ€§èƒ½åŸºçº¿

```
åŸºçº¿æŒ‡æ ‡ï¼ˆSpring Bootåº”ç”¨ï¼‰ï¼š

æ¥å£ç±»å‹        | P99å»¶è¿Ÿ  | TPS   | CPU  | å†…å­˜
---------------|---------|-------|------|------
ç®€å•æŸ¥è¯¢        | 50ms    | 5000  | 40%  | 30%
å¤æ‚æŸ¥è¯¢        | 200ms   | 1000  | 60%  | 40%
å†™å…¥æ“ä½œ        | 100ms   | 2000  | 50%  | 35%
æ‰¹é‡æ“ä½œ        | 500ms   | 500   | 70%  | 50%
```

---

## 3. æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–

### 3.1 SQLä¼˜åŒ–

**æ…¢æŸ¥è¯¢åˆ†æ**ï¼š
```sql
-- å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—
SET GLOBAL slow_query_log = 'ON';
SET GLOBAL long_query_time = 1;  -- è¶…è¿‡1ç§’çš„SQLè®°å½•

-- æŸ¥çœ‹æ…¢æŸ¥è¯¢
SHOW VARIABLES LIKE '%slow_query%';

-- åˆ†ææ…¢æŸ¥è¯¢
SELECT * FROM mysql.slow_log ORDER BY query_time DESC LIMIT 10;
```

**EXPLAINåˆ†æ**ï¼š
```sql
EXPLAIN SELECT * FROM orders WHERE user_id = 123;

-- å…³é”®å­—æ®µï¼š
-- type: è®¿é—®ç±»å‹ï¼ˆconst > eq_ref > ref > range > index > ALLï¼‰
-- key: ä½¿ç”¨çš„ç´¢å¼•
-- rows: æ‰«æè¡Œæ•°
-- Extra: é¢å¤–ä¿¡æ¯
```

**ä¼˜åŒ–ç¤ºä¾‹**ï¼š
```sql
-- âŒ ä¸å¥½ï¼šå…¨è¡¨æ‰«æ
SELECT * FROM orders WHERE DATE(create_time) = '2025-10-27';

-- âœ… å¥½ï¼šä½¿ç”¨ç´¢å¼•
SELECT * FROM orders 
WHERE create_time >= '2025-10-27 00:00:00' 
  AND create_time < '2025-10-28 00:00:00';

-- âŒ ä¸å¥½ï¼šå‡½æ•°ç ´åç´¢å¼•
SELECT * FROM users WHERE UPPER(name) = 'JOHN';

-- âœ… å¥½ï¼šä¸ä½¿ç”¨å‡½æ•°
SELECT * FROM users WHERE name = 'john';

-- âŒ ä¸å¥½ï¼šORå¯¼è‡´ç´¢å¼•å¤±æ•ˆ
SELECT * FROM orders WHERE status = 1 OR amount > 100;

-- âœ… å¥½ï¼šä½¿ç”¨UNION
SELECT * FROM orders WHERE status = 1
UNION
SELECT * FROM orders WHERE amount > 100;
```

### 3.2 ç´¢å¼•ä¼˜åŒ–

```sql
-- åˆ›å»ºåˆé€‚çš„ç´¢å¼•
CREATE INDEX idx_user_create_time ON orders(user_id, create_time);

-- è¦†ç›–ç´¢å¼•ï¼ˆé¿å…å›è¡¨ï¼‰
CREATE INDEX idx_user_status_amount ON orders(user_id, status, amount);
SELECT amount FROM orders WHERE user_id = 123 AND status = 1;  -- ä¸éœ€è¦å›è¡¨

-- å‰ç¼€ç´¢å¼•ï¼ˆå­—ç¬¦ä¸²å­—æ®µï¼‰
CREATE INDEX idx_name_prefix ON users(name(10));

-- è”åˆç´¢å¼•é¡ºåºï¼ˆåŒºåˆ†åº¦é«˜çš„åœ¨å‰ï¼‰
CREATE INDEX idx_status_create_time ON orders(status, create_time);  -- âœ…
-- è€Œä¸æ˜¯ï¼š
CREATE INDEX idx_create_time_status ON orders(create_time, status);  -- âŒ
```

### 3.3 åˆ†åº“åˆ†è¡¨

**Sharding-JDBCé…ç½®**ï¼š
```yaml
# application.yml
spring:
  shardingsphere:
    datasource:
      names: ds0,ds1
      ds0:
        type: com.zaxxer.hikari.HikariDataSource
        driver-class-name: com.mysql.cj.jdbc.Driver
        jdbc-url: jdbc:mysql://localhost:3306/order_db_0
      ds1:
        type: com.zaxxer.hikari.HikariDataSource
        driver-class-name: com.mysql.cj.jdbc.Driver
        jdbc-url: jdbc:mysql://localhost:3306/order_db_1
    
    rules:
      sharding:
        tables:
          t_order:
            actual-data-nodes: ds$->{0..1}.t_order_$->{0..3}
            table-strategy:
              standard:
                sharding-column: order_id
                sharding-algorithm-name: order-inline
            database-strategy:
              standard:
                sharding-column: user_id
                sharding-algorithm-name: database-inline
        
        sharding-algorithms:
          database-inline:
            type: INLINE
            props:
              algorithm-expression: ds$->{user_id % 2}
          order-inline:
            type: INLINE
            props:
              algorithm-expression: t_order_$->{order_id % 4}
```

---

## 4. ç¼“å­˜æ€§èƒ½ä¼˜åŒ–

### 4.1 å¤šçº§ç¼“å­˜

```java
@Service
public class ProductService {
    
    // L1: æœ¬åœ°ç¼“å­˜ï¼ˆCaffeineï¼‰
    private final Cache<Long, Product> localCache = Caffeine.newBuilder()
        .maximumSize(10000)
        .expireAfterWrite(5, TimeUnit.MINUTES)
        .build();
    
    // L2: Redisç¼“å­˜
    @Autowired
    private StringRedisTemplate redisTemplate;
    
    // L3: æ•°æ®åº“
    @Autowired
    private ProductMapper productMapper;
    
    public Product getProduct(Long id) {
        // 1. å°è¯•æœ¬åœ°ç¼“å­˜
        Product product = localCache.getIfPresent(id);
        if (product != null) {
            return product;
        }
        
        // 2. å°è¯•Redis
        String json = redisTemplate.opsForValue().get("product:" + id);
        if (json != null) {
            product = JSON.parseObject(json, Product.class);
            localCache.put(id, product);
            return product;
        }
        
        // 3. æŸ¥è¯¢æ•°æ®åº“
        product = productMapper.selectById(id);
        if (product != null) {
            // æ›´æ–°ç¼“å­˜
            redisTemplate.opsForValue().set(
                "product:" + id,
                JSON.toJSONString(product),
                1,
                TimeUnit.HOURS
            );
            localCache.put(id, product);
        }
        
        return product;
    }
}
```

### 4.2 ç¼“å­˜ç©¿é€/å‡»ç©¿/é›ªå´©

```java
@Service
public class CacheService {
    
    /**
     * ç¼“å­˜ç©¿é€ï¼šå¸ƒéš†è¿‡æ»¤å™¨
     */
    private final BloomFilter<Long> bloomFilter = BloomFilter.create(
        Funnels.longFunnel(),
        100000,
        0.01
    );
    
    public Product getProduct(Long id) {
        // å¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­
        if (!bloomFilter.mightContain(id)) {
            return null;  // æ•°æ®è‚¯å®šä¸å­˜åœ¨
        }
        
        // æŸ¥è¯¢ç¼“å­˜...
    }
    
    /**
     * ç¼“å­˜å‡»ç©¿ï¼šåˆ†å¸ƒå¼é”
     */
    public Product getProductWithLock(Long id) {
        String cacheKey = "product:" + id;
        String lockKey = "lock:product:" + id;
        
        // æŸ¥è¯¢ç¼“å­˜
        String json = redisTemplate.opsForValue().get(cacheKey);
        if (json != null) {
            return JSON.parseObject(json, Product.class);
        }
        
        // è·å–åˆ†å¸ƒå¼é”
        RLock lock = redissonClient.getLock(lockKey);
        try {
            if (lock.tryLock(5, 30, TimeUnit.SECONDS)) {
                // åŒé‡æ£€æŸ¥
                json = redisTemplate.opsForValue().get(cacheKey);
                if (json != null) {
                    return JSON.parseObject(json, Product.class);
                }
                
                // æŸ¥è¯¢æ•°æ®åº“
                Product product = productMapper.selectById(id);
                if (product != null) {
                    redisTemplate.opsForValue().set(
                        cacheKey,
                        JSON.toJSONString(product),
                        1,
                        TimeUnit.HOURS
                    );
                }
                return product;
            }
        } finally {
            if (lock.isHeldByCurrentThread()) {
                lock.unlock();
            }
        }
        
        return null;
    }
    
    /**
     * ç¼“å­˜é›ªå´©ï¼šéšæœºè¿‡æœŸæ—¶é—´
     */
    public void setCache(String key, Object value) {
        // åŸºç¡€è¿‡æœŸæ—¶é—´ + éšæœºæ—¶é—´ï¼ˆ0-300ç§’ï¼‰
        int expireTime = 3600 + RandomUtils.nextInt(0, 300);
        redisTemplate.opsForValue().set(
            key,
            JSON.toJSONString(value),
            expireTime,
            TimeUnit.SECONDS
        );
    }
}
```

---

## 5. åº”ç”¨å±‚ä¼˜åŒ–

### 5.1 å¼‚æ­¥å¤„ç†

```java
@Configuration
@EnableAsync
public class AsyncConfig implements AsyncConfigurer {
    
    @Override
    public Executor getAsyncExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(10);
        executor.setMaxPoolSize(20);
        executor.setQueueCapacity(200);
        executor.setThreadNamePrefix("async-");
        executor.setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy());
        executor.initialize();
        return executor;
    }
}

@Service
public class OrderService {
    
    /**
     * å¼‚æ­¥å‘é€é€šçŸ¥
     */
    @Async
    public CompletableFuture<Void> sendNotification(Order order) {
        // å‘é€çŸ­ä¿¡
        smsService.send(order.getPhone(), "è®¢å•åˆ›å»ºæˆåŠŸ");
        
        // å‘é€é‚®ä»¶
        emailService.send(order.getEmail(), "è®¢å•åˆ›å»ºæˆåŠŸ");
        
        return CompletableFuture.completedFuture(null);
    }
    
    public void createOrder(OrderDTO orderDTO) {
        // 1. åˆ›å»ºè®¢å•ï¼ˆåŒæ­¥ï¼‰
        Order order = new Order();
        orderMapper.insert(order);
        
        // 2. å‘é€é€šçŸ¥ï¼ˆå¼‚æ­¥ï¼Œä¸é˜»å¡ä¸»æµç¨‹ï¼‰
        sendNotification(order);
    }
}
```

### 5.2 æ‰¹é‡æ“ä½œ

```java
@Service
public class BatchService {
    
    /**
     * æ‰¹é‡æ’å…¥
     */
    public void batchInsert(List<Order> orders) {
        // âŒ ä¸å¥½ï¼šé€æ¡æ’å…¥
        for (Order order : orders) {
            orderMapper.insert(order);  // Næ¬¡æ•°æ®åº“äº¤äº’
        }
        
        // âœ… å¥½ï¼šæ‰¹é‡æ’å…¥
        int batchSize = 500;
        for (int i = 0; i < orders.size(); i += batchSize) {
            int end = Math.min(i + batchSize, orders.size());
            List<Order> batch = orders.subList(i, end);
            orderMapper.insertBatch(batch);  // 1æ¬¡æ•°æ®åº“äº¤äº’
        }
    }
}
```

### 5.3 è¿æ¥æ± ä¼˜åŒ–

```yaml
# HikariCPé…ç½®
spring:
  datasource:
    type: com.zaxxer.hikari.HikariDataSource
    hikari:
      minimum-idle: 10           # æœ€å°ç©ºé—²è¿æ¥
      maximum-pool-size: 20      # æœ€å¤§è¿æ¥æ•°
      connection-timeout: 30000  # è¿æ¥è¶…æ—¶30ç§’
      idle-timeout: 600000       # ç©ºé—²è¶…æ—¶10åˆ†é’Ÿ
      max-lifetime: 1800000      # è¿æ¥æœ€å¤§å­˜æ´»30åˆ†é’Ÿ
      connection-test-query: SELECT 1
```

---

## 6. ç³»ç»Ÿè°ƒä¼˜

### 6.1 Linuxå†…æ ¸å‚æ•°

```bash
# /etc/sysctl.conf

# TCPè¿æ¥é˜Ÿåˆ—
net.core.somaxconn = 4096
net.ipv4.tcp_max_syn_backlog = 8192

# TCPé‡ç”¨å’Œå›æ”¶
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_tw_recycle = 1

# TCP keepalive
net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp_keepalive_probes = 3
net.ipv4.tcp_keepalive_intvl = 15

# æ–‡ä»¶å¥æŸ„æ•°
fs.file-max = 1000000

# åº”ç”¨ç”Ÿæ•ˆ
sysctl -p
```

### 6.2 JVMå‚æ•°ä¼˜åŒ–

```bash
# ç”Ÿäº§ç¯å¢ƒæ¨èé…ç½®
JAVA_OPTS="-server \
-Xms8g -Xmx8g \
-Xmn4g \
-Xss256k \
-XX:MetaspaceSize=256m \
-XX:MaxMetaspaceSize=512m \
-XX:+UseG1GC \
-XX:MaxGCPauseMillis=200 \
-XX:G1HeapRegionSize=16m \
-XX:+ParallelRefProcEnabled \
-XX:+DisableExplicitGC \
-XX:+HeapDumpOnOutOfMemoryError \
-XX:HeapDumpPath=/var/log/heapdump/ \
-Xlog:gc*:file=/var/log/gc.log:time,uptime,level,tags:filecount=5,filesize=100m"
```

---

## ğŸ“š å‚è€ƒèµ„æ–™

- ğŸ”— [Prometheuså®˜æ–¹æ–‡æ¡£](https://prometheus.io/docs/)
- ğŸ”— [Grafanaå®˜æ–¹æ–‡æ¡£](https://grafana.com/docs/)
- ğŸ”— [Skywalkingå®˜æ–¹æ–‡æ¡£](https://skywalking.apache.org/)
- ğŸ“– ã€ŠJavaæ€§èƒ½æƒå¨æŒ‡å—ã€‹
- ğŸ“– ã€Šé«˜æ€§èƒ½MySQLã€‹

---

*æœ€åæ›´æ–°ï¼š2025-10-27*
