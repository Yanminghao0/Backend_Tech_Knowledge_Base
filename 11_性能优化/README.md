# æ€§èƒ½ä¼˜åŒ–è¯¦è§£

> JVMè°ƒä¼˜ã€APMç›‘æ§ã€æ€§èƒ½æµ‹è¯•ã€æ•°æ®åº“ä¼˜åŒ–ã€ç³»ç»Ÿè°ƒä¼˜

---

## ğŸ“‹ æ–‡æ¡£åˆ—è¡¨

### 1. JVMè°ƒä¼˜å®æˆ˜ â­â­â­ å¿…å­¦
ğŸ“„ [JVMè°ƒä¼˜å®æˆ˜.md](./JVMè°ƒä¼˜å®æˆ˜.md)

**æ ¸å¿ƒå†…å®¹**ï¼š
- âœ… **JVMå‚æ•°é…ç½®**ï¼šå †å†…å­˜ã€GCå‚æ•°ã€æ—¥å¿—å‚æ•°
- âœ… **GCè°ƒä¼˜**ï¼šG1 GCã€CMS GCã€ZGCè°ƒä¼˜ç­–ç•¥
- âœ… **å†…å­˜åˆ†æ**ï¼šHeap Dumpã€MATå·¥å…·ã€å†…å­˜æ³„æ¼æ’æŸ¥
- âœ… **æ•…éšœæ’æŸ¥**ï¼šCPUé£™é«˜ã€å†…å­˜æº¢å‡ºã€çº¿ç¨‹æ­»é”
- âœ… **æ€§èƒ½ç›‘æ§**ï¼šJMXã€Arthasè¯Šæ–­å·¥å…·
- âœ… **å®æˆ˜æ¡ˆä¾‹**ï¼šFull GCé¢‘ç¹ã€æ¥å£å“åº”æ…¢

### 2. æ€§èƒ½ç›‘æ§ä¸ç³»ç»Ÿä¼˜åŒ– â­â­â­ å¿…å­¦
ğŸ“„ [æ€§èƒ½ç›‘æ§ä¸ç³»ç»Ÿä¼˜åŒ–.md](./æ€§èƒ½ç›‘æ§ä¸ç³»ç»Ÿä¼˜åŒ–.md)

**æ ¸å¿ƒå†…å®¹**ï¼š
- âœ… **APMç›‘æ§**ï¼šPrometheus+Grafanaã€Skywalkingã€ELK
- âœ… **æ€§èƒ½æµ‹è¯•**ï¼šJMeterã€Gatlingã€æ€§èƒ½åŸºçº¿
- âœ… **æ•°æ®åº“ä¼˜åŒ–**ï¼šæ…¢æŸ¥è¯¢åˆ†æã€ç´¢å¼•ä¼˜åŒ–ã€åˆ†åº“åˆ†è¡¨
- âœ… **ç¼“å­˜ä¼˜åŒ–**ï¼šå¤šçº§ç¼“å­˜ã€ç¼“å­˜ç©¿é€/å‡»ç©¿/é›ªå´©
- âœ… **åº”ç”¨å±‚ä¼˜åŒ–**ï¼šå¼‚æ­¥å¤„ç†ã€æ‰¹é‡æ“ä½œã€è¿æ¥æ± 
- âœ… **ç³»ç»Ÿè°ƒä¼˜**ï¼šLinuxå†…æ ¸å‚æ•°ã€JVMå‚æ•°

---

## ğŸ¯ å­¦ä¹ è·¯å¾„

```mermaid
graph TD
    A[æ€§èƒ½ä¼˜åŒ–] --> B[JVMè°ƒä¼˜]
    A --> C[APMç›‘æ§]
    A --> D[ç³»ç»Ÿä¼˜åŒ–]
    
    B --> E[å‚æ•°é…ç½®]
    B --> F[GCè°ƒä¼˜]
    B --> G[æ•…éšœæ’æŸ¥]
    
    C --> H[Prometheus]
    C --> I[Skywalking]
    C --> J[ELK]
    
    D --> K[æ•°æ®åº“ä¼˜åŒ–]
    D --> L[ç¼“å­˜ä¼˜åŒ–]
    D --> M[åº”ç”¨ä¼˜åŒ–]
    
    style B fill:#99ccff
    style C fill:#ccffcc
    style D fill:#ffcc99
```

**æ¨èé¡ºåº**ï¼š
1. JVMåŸºç¡€å‚æ•°é…ç½®
2. GCè°ƒä¼˜ï¼ˆG1 GCï¼‰
3. APMç›‘æ§ä½“ç³»æ­å»º
4. æ€§èƒ½æµ‹è¯•ä¸åˆ†æ
5. æ•°æ®åº“ä¸ç¼“å­˜ä¼˜åŒ–
6. ç³»ç»Ÿå…¨é“¾è·¯è°ƒä¼˜

---

## ğŸ’¡ æ ¸å¿ƒçŸ¥è¯†ç‚¹é€ŸæŸ¥

**Q1: ç”Ÿäº§ç¯å¢ƒJVMå‚æ•°å¦‚ä½•é…ç½®ï¼Ÿ**
```bash
# 8Gå†…å­˜æœåŠ¡å™¨æ¨èé…ç½®
java -Xms4g -Xmx4g -Xmn2g -Xss256k \
     -XX:MetaspaceSize=256m -XX:MaxMetaspaceSize=512m \
     -XX:+UseG1GC \
     -XX:MaxGCPauseMillis=200 \
     -XX:+HeapDumpOnOutOfMemoryError \
     -Xlog:gc*:file=/var/log/gc.log \
     -jar app.jar

å†…å­˜åˆ†é…ï¼š
- å †å†…å­˜ï¼š4Gï¼ˆ50%ï¼‰
  - æ–°ç”Ÿä»£ï¼š2G
  - è€å¹´ä»£ï¼š2G
- å…ƒç©ºé—´ï¼š512M
- æ“ä½œç³»ç»Ÿï¼š2G
- ç¼“å†²ï¼š1.5G
```
- è¯¦è§ï¼š[JVMè°ƒä¼˜å®æˆ˜.md](./JVMè°ƒä¼˜å®æˆ˜.md#11-å†…å­˜å‚æ•°)

**Q2: G1 GCå¦‚ä½•è°ƒä¼˜ï¼Ÿ**
```
å…³é”®å‚æ•°ï¼š
-XX:MaxGCPauseMillis=200      # ç›®æ ‡åœé¡¿æ—¶é—´
-XX:InitiatingHeapOccupancyPercent=45  # è§¦å‘Mixed GC

è°ƒä¼˜ç­–ç•¥ï¼š
1. Minor GCé¢‘ç¹ â†’ å¢å¤§ -Xmn
2. Mixed GCé¢‘ç¹ â†’ é™ä½InitiatingHeapOccupancyPercent
3. Full GCå‘ç”Ÿ â†’ æ£€æŸ¥å†…å­˜æ³„æ¼ã€å¢å¤§å †
4. åœé¡¿æ—¶é—´é•¿ â†’ é™ä½MaxGCPauseMillis
```
- è¯¦è§ï¼š[JVMè°ƒä¼˜å®æˆ˜.md](./JVMè°ƒä¼˜å®æˆ˜.md#23-g1-gcè°ƒä¼˜)

**Q3: å¦‚ä½•æ’æŸ¥CPUé£™é«˜ï¼Ÿ**
```bash
# 1. æ‰¾åˆ°CPUé«˜çš„è¿›ç¨‹
top
# PID 1234, CPU 300%

# 2. æ‰¾åˆ°CPUé«˜çš„çº¿ç¨‹
top -Hp 1234
# TID 1250, CPU 150%

# 3. è½¬ä¸º16è¿›åˆ¶
printf "%x\n" 1250
# 4e2

# 4. æŸ¥çœ‹çº¿ç¨‹å †æ ˆ
jstack 1234 | grep 4e2 -A 50

# 5. åˆ†æä»£ç æ‰¾åˆ°é—®é¢˜
```
- è¯¦è§ï¼š[JVMè°ƒä¼˜å®æˆ˜.md](./JVMè°ƒä¼˜å®æˆ˜.md#41-cpué£™é«˜æ’æŸ¥)

**Q4: å¦‚ä½•æ­å»ºAPMç›‘æ§ï¼Ÿ**
```
æ¨èæ–¹æ¡ˆï¼šPrometheus + Grafana + Skywalking

1. Prometheusï¼šæŒ‡æ ‡é‡‡é›†
   - JVMå†…å­˜ã€GCã€çº¿ç¨‹
   - ä¸šåŠ¡æŒ‡æ ‡ï¼ˆQPSã€å»¶è¿Ÿï¼‰

2. Grafanaï¼šå¯è§†åŒ–
   - Dashboardå±•ç¤º
   - å‘Šè­¦é…ç½®

3. Skywalkingï¼šé“¾è·¯è¿½è¸ª
   - è°ƒç”¨é“¾åˆ†æ
   - æ€§èƒ½ç“¶é¢ˆå®šä½
```
- è¯¦è§ï¼š[æ€§èƒ½ç›‘æ§ä¸ç³»ç»Ÿä¼˜åŒ–.md](./æ€§èƒ½ç›‘æ§ä¸ç³»ç»Ÿä¼˜åŒ–.md#1-apmç›‘æ§ä½“ç³»)

**Q5: å¦‚ä½•è¿›è¡Œæ€§èƒ½æµ‹è¯•ï¼Ÿ**
```
æµ‹è¯•å·¥å…·ï¼šJMeter / Gatling

å…³é”®æŒ‡æ ‡ï¼š
1. ååé‡ï¼ˆTPSï¼‰ï¼š>1000
2. å“åº”æ—¶é—´ï¼š
   - å¹³å‡ï¼š<200ms
   - P95ï¼š<500ms
   - P99ï¼š<1000ms
3. é”™è¯¯ç‡ï¼š<1%
4. èµ„æºä½¿ç”¨ï¼šCPU/å†…å­˜ <80%

æµ‹è¯•ç­–ç•¥ï¼š
1. åŸºå‡†æµ‹è¯•ï¼šç¡®å®šæ€§èƒ½åŸºçº¿
2. è´Ÿè½½æµ‹è¯•ï¼šæ‰¾åˆ°æ€§èƒ½æ‹ç‚¹
3. å‹åŠ›æµ‹è¯•ï¼šæ‰¾åˆ°ç³»ç»Ÿæé™
4. ç¨³å®šæ€§æµ‹è¯•ï¼šé•¿æ—¶é—´è¿è¡Œ
```
- è¯¦è§ï¼š[æ€§èƒ½ç›‘æ§ä¸ç³»ç»Ÿä¼˜åŒ–.md](./æ€§èƒ½ç›‘æ§ä¸ç³»ç»Ÿä¼˜åŒ–.md#2-æ€§èƒ½æµ‹è¯•)

**Q6: å¦‚ä½•ä¼˜åŒ–æ•°æ®åº“æ€§èƒ½ï¼Ÿ**
```
1. SQLä¼˜åŒ–ï¼š
   - ä½¿ç”¨EXPLAINåˆ†æ
   - é¿å…å…¨è¡¨æ‰«æ
   - é¿å…å‡½æ•°ç ´åç´¢å¼•

2. ç´¢å¼•ä¼˜åŒ–ï¼š
   - åˆ›å»ºåˆé€‚çš„ç´¢å¼•
   - ä½¿ç”¨è¦†ç›–ç´¢å¼•
   - è”åˆç´¢å¼•é¡ºåº

3. åˆ†åº“åˆ†è¡¨ï¼š
   - Sharding-JDBC
   - æ°´å¹³æ‹†åˆ†
   - å‚ç›´æ‹†åˆ†

4. è¿æ¥æ± ä¼˜åŒ–ï¼š
   - HikariCPé…ç½®
   - åˆç†è®¾ç½®è¿æ¥æ•°
```
- è¯¦è§ï¼š[æ€§èƒ½ç›‘æ§ä¸ç³»ç»Ÿä¼˜åŒ–.md](./æ€§èƒ½ç›‘æ§ä¸ç³»ç»Ÿä¼˜åŒ–.md#3-æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–)

**Q7: ç¼“å­˜ä¸‰å¤§é—®é¢˜å¦‚ä½•è§£å†³ï¼Ÿ**
```
1. ç¼“å­˜ç©¿é€ï¼š
   è§£å†³ï¼šå¸ƒéš†è¿‡æ»¤å™¨

2. ç¼“å­˜å‡»ç©¿ï¼š
   è§£å†³ï¼šåˆ†å¸ƒå¼é”

3. ç¼“å­˜é›ªå´©ï¼š
   è§£å†³ï¼šéšæœºè¿‡æœŸæ—¶é—´ã€å¤šçº§ç¼“å­˜
```
- è¯¦è§ï¼š[æ€§èƒ½ç›‘æ§ä¸ç³»ç»Ÿä¼˜åŒ–.md](./æ€§èƒ½ç›‘æ§ä¸ç³»ç»Ÿä¼˜åŒ–.md#42-ç¼“å­˜ç©¿é€å‡»ç©¿é›ªå´©)

---

## ğŸ› ï¸ å¿«é€Ÿå¼€å§‹

### JVMè°ƒä¼˜

**ç”Ÿäº§ç¯å¢ƒå¯åŠ¨è„šæœ¬**ï¼š
```bash
#!/bin/bash
JAVA_OPTS="-server \
-Xms8g -Xmx8g -Xmn4g -Xss256k \
-XX:MetaspaceSize=256m -XX:MaxMetaspaceSize=512m \
-XX:+UseG1GC \
-XX:MaxGCPauseMillis=200 \
-XX:+HeapDumpOnOutOfMemoryError \
-XX:HeapDumpPath=/var/log/heapdump/ \
-Xlog:gc*:file=/var/log/gc.log"

java $JAVA_OPTS -jar app.jar
```

### APMç›‘æ§

**Spring Booté›†æˆ**ï¼š
```xml
<dependency>
    <groupId>io.micrometer</groupId>
    <artifactId>micrometer-registry-prometheus</artifactId>
</dependency>
```

```yaml
management:
  endpoints:
    web:
      exposure:
        include: prometheus
```

### æ€§èƒ½æµ‹è¯•

**JMeterè„šæœ¬**ï¼š
```
1. æ·»åŠ çº¿ç¨‹ç»„ï¼š100å¹¶å‘
2. æ·»åŠ HTTPè¯·æ±‚
3. æ·»åŠ ç›‘å¬å™¨ï¼ˆæŸ¥çœ‹ç»“æœæ ‘ï¼‰
4. è¿è¡Œæµ‹è¯•
5. åˆ†æç»“æœ
```

---

## ğŸ“Š æ€§èƒ½åŸºçº¿å‚è€ƒ

### Spring Bootåº”ç”¨æ€§èƒ½åŸºçº¿

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | ä¼˜ç§€ | è‰¯å¥½ | éœ€ä¼˜åŒ– |
|------|--------|------|------|--------|
| TPS | >1000 | >5000 | >2000 | <1000 |
| P99å»¶è¿Ÿ | <200ms | <50ms | <100ms | >500ms |
| CPUä½¿ç”¨ç‡ | <70% | <50% | <60% | >80% |
| å†…å­˜ä½¿ç”¨ç‡ | <70% | <50% | <60% | >80% |
| GCåœé¡¿ | <50ms | <20ms | <30ms | >100ms |

### å¸¸è§æ¥å£æ€§èƒ½æ ‡å‡†

| æ¥å£ç±»å‹ | P99å»¶è¿Ÿ | TPS | è¯´æ˜ |
|----------|---------|-----|------|
| ç®€å•æŸ¥è¯¢ | <50ms | >5000 | å•è¡¨æŸ¥è¯¢ |
| å¤æ‚æŸ¥è¯¢ | <200ms | >1000 | å¤šè¡¨Join |
| å†™å…¥æ“ä½œ | <100ms | >2000 | å•æ¡å†™å…¥ |
| æ‰¹é‡æ“ä½œ | <500ms | >500 | æ‰¹é‡å†™å…¥ |

---

## ğŸš¨ å¸¸è§é—®é¢˜

### 1ï¸âƒ£ Full GCé¢‘ç¹

**ç°è±¡**ï¼šæ¯5åˆ†é’ŸFull GCä¸€æ¬¡ï¼Œåœé¡¿2-3ç§’

**æ’æŸ¥**ï¼š
```bash
# 1. æŸ¥çœ‹GCæ—¥å¿—
tail -f /var/log/gc.log

# 2. Dumpå †åˆ†æ
jmap -dump:live,format=b,file=heap.hprof <pid>

# 3. MATåˆ†æå†…å­˜æ³„æ¼
```

**å¸¸è§åŸå› **ï¼š
- ThreadLocalæœªæ¸…ç†
- é™æ€é›†åˆæœªæ¸…ç†
- ç›‘å¬å™¨æœªç§»é™¤

### 2ï¸âƒ£ æ¥å£å“åº”æ…¢

**æ’æŸ¥å·¥å…·**ï¼š
```bash
# Arthasåˆ†æ
java -jar arthas-boot.jar

# ç›‘æ§æ–¹æ³•è€—æ—¶
trace com.example.OrderService createOrder -n 10
```

**å¸¸è§åŸå› **ï¼š
- N+1æŸ¥è¯¢é—®é¢˜
- åŒæ­¥è°ƒç”¨æ…¢æ¥å£
- æ•°æ®åº“ç´¢å¼•ç¼ºå¤±

### 3ï¸âƒ£ CPUé£™é«˜

**æ’æŸ¥æ­¥éª¤**ï¼š
1. topæ‰¾è¿›ç¨‹
2. top -Hpæ‰¾çº¿ç¨‹
3. jstackåˆ†æå †æ ˆ

**å¸¸è§åŸå› **ï¼š
- æ­»å¾ªç¯
- é¢‘ç¹GC
- æ­£åˆ™å›æº¯

---

## ğŸ“ˆ æœ€ä½³å®è·µ

### 1. JVMå‚æ•°é…ç½®

```bash
âœ… å †å†…å­˜Xmså’ŒXmxè®¾ç½®ç›¸åŒï¼ˆé¿å…åŠ¨æ€æ‰©å±•ï¼‰
âœ… æ–°ç”Ÿä»£å å †çš„1/2ï¼ˆ-Xmnï¼‰
âœ… ä½¿ç”¨G1 GCï¼ˆJDK 9+ï¼‰
âœ… å¼€å¯HeapDumpï¼ˆ-XX:+HeapDumpOnOutOfMemoryErrorï¼‰
âœ… é…ç½®GCæ—¥å¿—
âŒ é¿å…ä½¿ç”¨-XX:+DisableExplicitGCï¼ˆå½±å“NIOï¼‰
```

### 2. ç›‘æ§å‘Šè­¦

```
âœ… é…ç½®Prometheus + Grafana
âœ… è®¾ç½®å‘Šè­¦é˜ˆå€¼ï¼š
   - CPU >80%
   - å†…å­˜ >80%
   - GCåœé¡¿ >200ms
   - æ¥å£P99 >500ms
âœ… æ¥å…¥Skywalkingé“¾è·¯è¿½è¸ª
âœ… ELKæ—¥å¿—åˆ†æ
```

### 3. æ€§èƒ½æµ‹è¯•

```
âœ… å»ºç«‹æ€§èƒ½åŸºçº¿
âœ… æ¯æ¬¡å‘å¸ƒå‰å‹æµ‹
âœ… ç›‘æ§å…³é”®æŒ‡æ ‡
âœ… åˆ†ææ€§èƒ½ç“¶é¢ˆ
âœ… æŒç»­ä¼˜åŒ–
```

### 4. æ•°æ®åº“ä¼˜åŒ–

```java
// âœ… æ‰¹é‡æ“ä½œ
orderMapper.insertBatch(orders);

// âœ… ä½¿ç”¨ç´¢å¼•
@TableField(exist = false)  // é¿å…æŸ¥è¯¢ä¸å­˜åœ¨çš„å­—æ®µ

// âœ… è¿æ¥æ± é…ç½®
spring.datasource.hikari.maximum-pool-size=20

// âŒ é¿å…N+1æŸ¥è¯¢
for (User user : users) {
    List<Order> orders = orderMapper.selectByUserId(user.getId());
}
```

---

## ğŸŒŸ è¿›é˜¶æ–¹å‘

### 1. å…¨é“¾è·¯å‹æµ‹

```
- ç”Ÿäº§ç¯å¢ƒå‹æµ‹
- æµé‡å½•åˆ¶å›æ”¾
- æ•°æ®éš”ç¦»
- æ€§èƒ½ç“¶é¢ˆåˆ†æ
```

### 2. æ··æ²Œå·¥ç¨‹

```
- æ•…éšœæ³¨å…¥
- å®¹é”™æµ‹è¯•
- å¼¹æ€§éªŒè¯
```

### 3. æ™ºèƒ½è°ƒä¼˜

```
- AIè‡ªåŠ¨è°ƒå‚
- æ€§èƒ½é¢„æµ‹
- æ™ºèƒ½å‘Šè­¦
```

---

## ğŸ”— ç›¸å…³èµ„æº

- ğŸ”— [Oracle JVMè°ƒä¼˜æŒ‡å—](https://docs.oracle.com/javase/8/docs/technotes/guides/vm/gctuning/)
- ğŸ”— [Prometheuså®˜æ–¹æ–‡æ¡£](https://prometheus.io/docs/)
- ğŸ”— [Skywalkingå®˜æ–¹æ–‡æ¡£](https://skywalking.apache.org/)
- ğŸ”— [Arthaså®˜æ–¹æ–‡æ¡£](https://arthas.aliyun.com/)
- ğŸ“– ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹
- ğŸ“– ã€ŠJavaæ€§èƒ½æƒå¨æŒ‡å—ã€‹
- ğŸ“– ã€Šé«˜æ€§èƒ½MySQLã€‹

---

*æœ€åæ›´æ–°ï¼š2025-10-27*

