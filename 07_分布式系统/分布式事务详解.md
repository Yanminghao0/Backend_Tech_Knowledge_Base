# åˆ†å¸ƒå¼äº‹åŠ¡è¯¦è§£

> æ·±å…¥ç†è§£åˆ†å¸ƒå¼äº‹åŠ¡åŸç†ã€è§£å†³æ–¹æ¡ˆã€Seataæ¡†æ¶

---

## ğŸ“‹ ç›®å½•

1. [åˆ†å¸ƒå¼äº‹åŠ¡åŸºç¡€](#1-åˆ†å¸ƒå¼äº‹åŠ¡åŸºç¡€)
2. [CAPä¸BASEç†è®º](#2-capä¸baseç†è®º)
3. [åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ](#3-åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ)
4. [Seataæ¡†æ¶](#4-seataæ¡†æ¶)
5. [æœ¬åœ°æ¶ˆæ¯è¡¨](#5-æœ¬åœ°æ¶ˆæ¯è¡¨)
6. [æœ€ä½³å®è·µ](#6-æœ€ä½³å®è·µ)

---

## 1. åˆ†å¸ƒå¼äº‹åŠ¡åŸºç¡€

### 1.1 ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼äº‹åŠ¡

```
å•ä½“åº”ç”¨äº‹åŠ¡ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Application    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Service   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Database  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
äº‹åŠ¡åœ¨å•ä¸ªæ•°æ®åº“ä¸­å®Œæˆï¼ŒACIDç”±æ•°æ®åº“ä¿è¯

åˆ†å¸ƒå¼äº‹åŠ¡ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Service A   â”‚    â”‚  Service B   â”‚    â”‚  Service C   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚   DB A   â”‚ â”‚    â”‚ â”‚   DB B   â”‚ â”‚    â”‚ â”‚   DB C   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                   â”‚                   â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              éœ€è¦ä¿è¯æ•´ä½“äº‹åŠ¡ä¸€è‡´æ€§
```

**å…¸å‹åœºæ™¯**ï¼š
```
ç”µå•†ä¸‹å•ï¼š
1. è®¢å•æœåŠ¡ï¼šåˆ›å»ºè®¢å•
2. åº“å­˜æœåŠ¡ï¼šæ‰£å‡åº“å­˜
3. æ”¯ä»˜æœåŠ¡ï¼šæ‰£å‡ä½™é¢
4. ç§¯åˆ†æœåŠ¡ï¼šå¢åŠ ç§¯åˆ†

è¦æ±‚ï¼šè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥
```

### 1.2 åˆ†å¸ƒå¼äº‹åŠ¡çš„æŒ‘æˆ˜

```
1. ç½‘ç»œä¸å¯é ï¼š
   - ç½‘ç»œå»¶è¿Ÿ
   - ç½‘ç»œåˆ†åŒº
   - æ¶ˆæ¯ä¸¢å¤±

2. æ€§èƒ½é—®é¢˜ï¼š
   - ä¸¤é˜¶æ®µæäº¤é˜»å¡
   - é”ç­‰å¾…æ—¶é—´é•¿
   - ååé‡ä¸‹é™

3. å¤æ‚æ€§ï¼š
   - å¼‚å¸¸å¤„ç†
   - è¡¥å¿é€»è¾‘
   - å¹‚ç­‰æ€§

4. ä¸€è‡´æ€§ä¸å¯ç”¨æ€§çŸ›ç›¾ï¼š
   - CAPç†è®ºé™åˆ¶
   - å¼ºä¸€è‡´æ€§ vs é«˜å¯ç”¨
```

---

## 2. CAPä¸BASEç†è®º

### 2.1 CAPç†è®º

```
CAPå®šç†ï¼šåˆ†å¸ƒå¼ç³»ç»Ÿåªèƒ½æ»¡è¶³å…¶ä¸­ä¸¤ä¸ª

C - Consistencyï¼ˆä¸€è‡´æ€§ï¼‰ï¼š
    æ‰€æœ‰èŠ‚ç‚¹åŒæ—¶çœ‹åˆ°ç›¸åŒçš„æ•°æ®

A - Availabilityï¼ˆå¯ç”¨æ€§ï¼‰ï¼š
    ç³»ç»ŸæŒç»­å¯ç”¨ï¼Œè¯·æ±‚æ€»èƒ½å¾—åˆ°å“åº”

P - Partition toleranceï¼ˆåˆ†åŒºå®¹é”™æ€§ï¼‰ï¼š
    ç½‘ç»œåˆ†åŒºæ—¶ç³»ç»Ÿç»§ç»­è¿è¡Œ

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          CAPä¸‰è§’å½¢              â”‚
â”‚                                 â”‚
â”‚            C                    â”‚
â”‚           /  \                  â”‚
â”‚          /    \                 â”‚
â”‚         /  CP  \                â”‚
â”‚        /        \               â”‚
â”‚       /   CAP    \              â”‚
â”‚      /            \             â”‚
â”‚     /   CA    AP   \            â”‚
â”‚    /________________\           â”‚
â”‚   A                  P          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é€‰æ‹©ï¼š
- CPï¼šç‰ºç‰²å¯ç”¨æ€§ï¼Œä¿è¯ä¸€è‡´æ€§ï¼ˆå¦‚ï¼šZookeeperï¼‰
- APï¼šç‰ºç‰²ä¸€è‡´æ€§ï¼Œä¿è¯å¯ç”¨æ€§ï¼ˆå¦‚ï¼šEurekaï¼‰
- CAï¼šå•æœºç³»ç»Ÿï¼ˆåˆ†å¸ƒå¼ç³»ç»Ÿå¿…é¡»å®¹å¿åˆ†åŒºï¼‰
```

### 2.2 BASEç†è®º

```
BASEï¼šCAPçš„æŠ˜ä¸­æ–¹æ¡ˆ

BA - Basically Availableï¼ˆåŸºæœ¬å¯ç”¨ï¼‰ï¼š
     ç³»ç»Ÿå¤§éƒ¨åˆ†æ—¶é—´å¯ç”¨ï¼Œå…è®¸å¶å°”æ•…éšœ

S - Soft stateï¼ˆè½¯çŠ¶æ€ï¼‰ï¼š
    å…è®¸ä¸­é—´çŠ¶æ€ï¼Œä¸è¦æ±‚å®æ—¶ä¸€è‡´

E - Eventually consistentï¼ˆæœ€ç»ˆä¸€è‡´æ€§ï¼‰ï¼š
    ä¸è¦æ±‚å®æ—¶ä¸€è‡´ï¼Œä½†æœ€ç»ˆè¾¾åˆ°ä¸€è‡´

å¯¹æ¯”ï¼š
ACIDï¼ˆå¼ºä¸€è‡´æ€§ï¼‰ï¼š
- åŸå­æ€§ï¼ˆAtomicityï¼‰
- ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰
- éš”ç¦»æ€§ï¼ˆIsolationï¼‰
- æŒä¹…æ€§ï¼ˆDurabilityï¼‰

BASEï¼ˆæœ€ç»ˆä¸€è‡´æ€§ï¼‰ï¼š
- åŸºæœ¬å¯ç”¨
- è½¯çŠ¶æ€
- æœ€ç»ˆä¸€è‡´
```

---

## 3. åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ

### 3.1 ä¸¤é˜¶æ®µæäº¤ï¼ˆ2PCï¼‰

```mermaid
sequenceDiagram
    participant TM as äº‹åŠ¡ç®¡ç†å™¨
    participant RM1 as èµ„æºç®¡ç†å™¨1
    participant RM2 as èµ„æºç®¡ç†å™¨2
    
    Note over TM,RM2: ç¬¬ä¸€é˜¶æ®µï¼šå‡†å¤‡é˜¶æ®µ
    TM->>RM1: prepare
    RM1->>TM: yes
    TM->>RM2: prepare
    RM2->>TM: yes
    
    Note over TM,RM2: ç¬¬äºŒé˜¶æ®µï¼šæäº¤é˜¶æ®µ
    TM->>RM1: commit
    RM1->>TM: ack
    TM->>RM2: commit
    RM2->>TM: ack
```

**ä¼˜ç‚¹**ï¼š
- å¼ºä¸€è‡´æ€§
- å®ç°ç®€å•

**ç¼ºç‚¹**ï¼š
```
1. åŒæ­¥é˜»å¡ï¼š
   - ç¬¬ä¸€é˜¶æ®µé”å®šèµ„æº
   - å…¶ä»–äº‹åŠ¡éœ€è¦ç­‰å¾…

2. å•ç‚¹æ•…éšœï¼š
   - åè°ƒè€…æ•…éšœå¯¼è‡´é˜»å¡

3. æ•°æ®ä¸ä¸€è‡´ï¼š
   - ç¬¬äºŒé˜¶æ®µç½‘ç»œåˆ†åŒº
   - éƒ¨åˆ†èŠ‚ç‚¹æ”¶åˆ°commitï¼Œéƒ¨åˆ†æœªæ”¶åˆ°

4. æ€§èƒ½é—®é¢˜ï¼š
   - å¤šæ¬¡ç½‘ç»œå¾€è¿”
   - é”å®šæ—¶é—´é•¿
```

### 3.2 ä¸‰é˜¶æ®µæäº¤ï¼ˆ3PCï¼‰

```
3PCæ”¹è¿›ï¼š
1. CanCommité˜¶æ®µ
2. PreCommité˜¶æ®µ
3. DoCommité˜¶æ®µ

ä¼˜ç‚¹ï¼š
- å‡å°‘é˜»å¡
- å¼•å…¥è¶…æ—¶æœºåˆ¶

ç¼ºç‚¹ï¼š
- ä»å¯èƒ½æ•°æ®ä¸ä¸€è‡´
- å®ç°å¤æ‚
```

### 3.3 TCCï¼ˆTry-Confirm-Cancelï¼‰

```java
/**
 * TCCæ¨¡å¼
 */
public interface OrderTccService {
    
    /**
     * Tryé˜¶æ®µï¼šå°è¯•æ‰§è¡Œï¼Œé¢„ç•™èµ„æº
     */
    @TwoPhaseBusinessAction(
        name = "orderTcc",
        commitMethod = "confirm",
        rollbackMethod = "cancel"
    )
    boolean try(@BusinessActionContextParameter(paramName = "orderId") Long orderId);
    
    /**
     * Confirmé˜¶æ®µï¼šç¡®è®¤æäº¤
     */
    boolean confirm(BusinessActionContext context);
    
    /**
     * Cancelé˜¶æ®µï¼šå–æ¶ˆå›æ»š
     */
    boolean cancel(BusinessActionContext context);
}

@Service
public class OrderTccServiceImpl implements OrderTccService {
    
    @Override
    public boolean try(Long orderId) {
        // 1. æ ¡éªŒä¸šåŠ¡
        if (!validateOrder(orderId)) {
            return false;
        }
        
        // 2. é¢„ç•™èµ„æºï¼ˆå†»ç»“åº“å­˜ï¼‰
        inventoryService.freeze(orderId);
        
        // 3. è®°å½•äº‹åŠ¡æ—¥å¿—
        tccLogService.saveTryLog(orderId);
        
        return true;
    }
    
    @Override
    public boolean confirm(BusinessActionContext context) {
        Long orderId = context.getActionContext("orderId", Long.class);
        
        // 1. ç¡®è®¤æ‰£å‡åº“å­˜
        inventoryService.deduct(orderId);
        
        // 2. åˆ é™¤å†»ç»“è®°å½•
        inventoryService.deleteFrozen(orderId);
        
        // 3. è®°å½•æ—¥å¿—
        tccLogService.saveConfirmLog(orderId);
        
        return true;
    }
    
    @Override
    public boolean cancel(BusinessActionContext context) {
        Long orderId = context.getActionContext("orderId", Long.class);
        
        // 1. é‡Šæ”¾å†»ç»“åº“å­˜
        inventoryService.unfreeze(orderId);
        
        // 2. è®°å½•æ—¥å¿—
        tccLogService.saveCancelLog(orderId);
        
        return true;
    }
}
```

**TCCä¼˜ç¼ºç‚¹**ï¼š
```
ä¼˜ç‚¹ï¼š
âœ… æ€§èƒ½è¾ƒå¥½ï¼ˆä¸é”å…¨å±€èµ„æºï¼‰
âœ… çµæ´»æ€§é«˜
âœ… å¯ç”¨æ€§é«˜

ç¼ºç‚¹ï¼š
âŒ ä¾µå…¥æ€§å¼ºï¼ˆéœ€è¦å®ç°tryã€confirmã€cancelï¼‰
âŒ å¼€å‘æˆæœ¬é«˜
âŒ éœ€è¦è€ƒè™‘å¹‚ç­‰æ€§
```

### 3.4 Sagaæ¨¡å¼

```java
/**
 * Sagaç¼–æ’æ¨¡å¼
 */
@Service
public class OrderSagaService {
    
    public void createOrder(OrderDTO order) {
        Saga saga = sagaFactory.create("order-saga")
            // æ­¥éª¤1ï¼šåˆ›å»ºè®¢å•
            .addStep(
                () -> orderService.create(order),
                () -> orderService.delete(order.getId())
            )
            // æ­¥éª¤2ï¼šæ‰£å‡åº“å­˜
            .addStep(
                () -> inventoryService.deduct(order),
                () -> inventoryService.add(order)
            )
            // æ­¥éª¤3ï¼šæ‰£å‡ä½™é¢
            .addStep(
                () -> accountService.deduct(order),
                () -> accountService.add(order)
            )
            // æ­¥éª¤4ï¼šå¢åŠ ç§¯åˆ†
            .addStep(
                () -> pointService.add(order),
                () -> pointService.deduct(order)
            );
        
        // æ‰§è¡ŒSaga
        saga.execute();
    }
}
```

**Sagaä¼˜ç¼ºç‚¹**ï¼š
```
ä¼˜ç‚¹ï¼š
âœ… é•¿äº‹åŠ¡æ”¯æŒ
âœ… ä¸éœ€è¦é”èµ„æº
âœ… é€‚åˆå¤æ‚ä¸šåŠ¡æµç¨‹

ç¼ºç‚¹ï¼š
âŒ éš¾ä»¥ç†è§£å’Œè°ƒè¯•
âŒ éœ€è¦å®ç°è¡¥å¿é€»è¾‘
âŒ å¯èƒ½å­˜åœ¨è„è¯»ï¼ˆè¡¥å¿å‰çš„ä¸­é—´çŠ¶æ€ï¼‰
```

### 3.5 æœ¬åœ°æ¶ˆæ¯è¡¨

```java
/**
 * æœ¬åœ°æ¶ˆæ¯è¡¨æ¨¡å¼
 */
@Service
public class OrderWithMessageService {
    
    @Autowired
    private OrderMapper orderMapper;
    
    @Autowired
    private MessageLogMapper messageLogMapper;
    
    @Autowired
    private RocketMQTemplate rocketMQTemplate;
    
    /**
     * åˆ›å»ºè®¢å•ï¼ˆæœ¬åœ°äº‹åŠ¡ï¼‰
     */
    @Transactional
    public void createOrder(OrderDTO orderDTO) {
        // 1. åˆ›å»ºè®¢å•
        Order order = new Order();
        BeanUtils.copyProperties(orderDTO, order);
        orderMapper.insert(order);
        
        // 2. ä¿å­˜æ¶ˆæ¯æ—¥å¿—ï¼ˆåŒä¸€ä¸ªæœ¬åœ°äº‹åŠ¡ï¼‰
        MessageLog messageLog = new MessageLog();
        messageLog.setContent(JSON.toJSONString(orderDTO));
        messageLog.setStatus(MessageStatus.PENDING);
        messageLog.setBizType("ORDER_CREATED");
        messageLogMapper.insert(messageLog);
    }
    
    /**
     * å®šæ—¶å‘é€æœªå‘é€çš„æ¶ˆæ¯
     */
    @Scheduled(fixedDelay = 5000)
    public void sendPendingMessages() {
        List<MessageLog> pendingMessages = messageLogMapper.selectPending();
        
        for (MessageLog message : pendingMessages) {
            try {
                // å‘é€MQæ¶ˆæ¯
                rocketMQTemplate.syncSend("order-topic", message.getContent());
                
                // æ›´æ–°æ¶ˆæ¯çŠ¶æ€
                message.setStatus(MessageStatus.SENT);
                messageLogMapper.updateById(message);
            } catch (Exception e) {
                log.error("å‘é€æ¶ˆæ¯å¤±è´¥", e);
            }
        }
    }
}

/**
 * åº“å­˜æœåŠ¡æ¶ˆè´¹æ¶ˆæ¯
 */
@Service
@RocketMQMessageListener(topic = "order-topic", consumerGroup = "inventory-group")
public class InventoryMessageListener implements RocketMQListener<String> {
    
    @Override
    public void onMessage(String message) {
        OrderDTO order = JSON.parseObject(message, OrderDTO.class);
        
        // å¹‚ç­‰æ€§å¤„ç†
        if (inventoryService.isProcessed(order.getId())) {
            return;
        }
        
        // æ‰£å‡åº“å­˜
        inventoryService.deduct(order);
        
        // è®°å½•å·²å¤„ç†
        inventoryService.markProcessed(order.getId());
    }
}
```

---

## 4. Seataæ¡†æ¶

### 4.1 Seataæ¶æ„

```mermaid
graph TB
    A[Businessåº”ç”¨] --> B[TMäº‹åŠ¡ç®¡ç†å™¨]
    A --> C[RMèµ„æºç®¡ç†å™¨]
    B --> D[TCäº‹åŠ¡åè°ƒå™¨]
    C --> D
    
    style D fill:#99ccff
```

**æ ¸å¿ƒç»„ä»¶**ï¼š
```
TC (Transaction Coordinator)ï¼š
- äº‹åŠ¡åè°ƒå™¨
- ç»´æŠ¤å…¨å±€å’Œåˆ†æ”¯äº‹åŠ¡çš„çŠ¶æ€
- é©±åŠ¨å…¨å±€äº‹åŠ¡æäº¤æˆ–å›æ»š

TM (Transaction Manager)ï¼š
- äº‹åŠ¡ç®¡ç†å™¨
- å®šä¹‰å…¨å±€äº‹åŠ¡çš„èŒƒå›´
- å¼€å§‹ã€æäº¤æˆ–å›æ»šå…¨å±€äº‹åŠ¡

RM (Resource Manager)ï¼š
- èµ„æºç®¡ç†å™¨
- ç®¡ç†åˆ†æ”¯äº‹åŠ¡
- ä¸TCäº¤äº’æ³¨å†Œåˆ†æ”¯äº‹åŠ¡å’ŒæŠ¥å‘Šåˆ†æ”¯äº‹åŠ¡çŠ¶æ€
```

### 4.2 Seata ATæ¨¡å¼

**Mavenä¾èµ–**ï¼š
```xml
<dependencies>
    <dependency>
        <groupId>com.alibaba.cloud</groupId>
        <artifactId>spring-cloud-starter-alibaba-seata</artifactId>
    </dependency>
    
    <dependency>
        <groupId>io.seata</groupId>
        <artifactId>seata-spring-boot-starter</artifactId>
        <version>1.7.0</version>
    </dependency>
</dependencies>
```

**é…ç½®**ï¼š
```yaml
seata:
  enabled: true
  application-id: order-service
  tx-service-group: my_tx_group
  service:
    vgroup-mapping:
      my_tx_group: default
  registry:
    type: nacos
    nacos:
      server-addr: localhost:8848
      namespace: public
      group: SEATA_GROUP
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```java
/**
 * è®¢å•æœåŠ¡ï¼ˆTMï¼‰
 */
@Service
public class OrderService {
    
    @Autowired
    private OrderMapper orderMapper;
    
    @Autowired
    private InventoryFeignClient inventoryClient;
    
    @Autowired
    private AccountFeignClient accountClient;
    
    /**
     * åˆ›å»ºè®¢å•ï¼ˆå…¨å±€äº‹åŠ¡ï¼‰
     */
    @GlobalTransactional(name = "create-order", rollbackFor = Exception.class)
    public void createOrder(OrderDTO orderDTO) {
        // 1. åˆ›å»ºè®¢å•
        Order order = new Order();
        BeanUtils.copyProperties(orderDTO, order);
        orderMapper.insert(order);
        
        // 2. æ‰£å‡åº“å­˜ï¼ˆè¿œç¨‹è°ƒç”¨ï¼‰
        inventoryClient.deduct(orderDTO.getProductId(), orderDTO.getCount());
        
        // 3. æ‰£å‡ä½™é¢ï¼ˆè¿œç¨‹è°ƒç”¨ï¼‰
        accountClient.deduct(orderDTO.getUserId(), orderDTO.getMoney());
        
        // ä»»ä½•ä¸€æ­¥å¤±è´¥ï¼Œå…¨å±€äº‹åŠ¡è‡ªåŠ¨å›æ»š
    }
}

/**
 * åº“å­˜æœåŠ¡ï¼ˆRMï¼‰
 */
@Service
public class InventoryService {
    
    @Autowired
    private InventoryMapper inventoryMapper;
    
    /**
     * æ‰£å‡åº“å­˜ï¼ˆåˆ†æ”¯äº‹åŠ¡ï¼‰
     */
    @Transactional
    public void deduct(Long productId, Integer count) {
        Inventory inventory = inventoryMapper.selectById(productId);
        
        if (inventory.getStock() < count) {
            throw new BusinessException("åº“å­˜ä¸è¶³");
        }
        
        inventory.setStock(inventory.getStock() - count);
        inventoryMapper.updateById(inventory);
    }
}
```

### 4.3 Seataå·¥ä½œæµç¨‹

```mermaid
sequenceDiagram
    participant App as ä¸šåŠ¡åº”ç”¨
    participant TM as äº‹åŠ¡ç®¡ç†å™¨
    participant TC as äº‹åŠ¡åè°ƒå™¨
    participant RM1 as èµ„æºç®¡ç†å™¨1
    participant RM2 as èµ„æºç®¡ç†å™¨2
    
    App->>TM: å¼€å§‹å…¨å±€äº‹åŠ¡
    TM->>TC: begin(xid)
    TC-->>TM: xid
    
    App->>RM1: æ‰§è¡Œåˆ†æ”¯äº‹åŠ¡1
    RM1->>TC: register(xid, branchId1)
    RM1->>RM1: æ‰§è¡ŒSQLå¹¶ä¿å­˜undo_log
    
    App->>RM2: æ‰§è¡Œåˆ†æ”¯äº‹åŠ¡2
    RM2->>TC: register(xid, branchId2)
    RM2->>RM2: æ‰§è¡ŒSQLå¹¶ä¿å­˜undo_log
    
    App->>TM: æäº¤/å›æ»š
    TM->>TC: commit/rollback(xid)
    TC->>RM1: commit/rollback(branchId1)
    TC->>RM2: commit/rollback(branchId2)
```

### 4.4 Seata Undo Log

```sql
-- undo_logè¡¨ç»“æ„
CREATE TABLE `undo_log` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `branch_id` bigint(20) NOT NULL,
  `xid` varchar(100) NOT NULL,
  `context` varchar(128) NOT NULL,
  `rollback_info` longblob NOT NULL,
  `log_status` int(11) NOT NULL,
  `log_created` datetime NOT NULL,
  `log_modified` datetime NOT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `ux_undo_log` (`xid`,`branch_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
```

**ATæ¨¡å¼åŸç†**ï¼š
```
1. ä¸€é˜¶æ®µï¼š
   - è§£æSQL
   - æŸ¥è¯¢å‰é•œåƒï¼ˆbefore imageï¼‰
   - æ‰§è¡Œä¸šåŠ¡SQL
   - æŸ¥è¯¢åé•œåƒï¼ˆafter imageï¼‰
   - æ’å…¥undo_log
   - æäº¤æœ¬åœ°äº‹åŠ¡

2. äºŒé˜¶æ®µæäº¤ï¼š
   - åˆ é™¤undo_log
   - é‡Šæ”¾é”

3. äºŒé˜¶æ®µå›æ»šï¼š
   - æ ¡éªŒè„å†™
   - ç”Ÿæˆåå‘SQLï¼ˆæ ¹æ®undo_logï¼‰
   - æ‰§è¡Œåå‘SQL
   - åˆ é™¤undo_log
```

---

## 5. æœ¬åœ°æ¶ˆæ¯è¡¨

### 5.1 å®ç°æ–¹æ¡ˆ

```sql
-- æ¶ˆæ¯æ—¥å¿—è¡¨
CREATE TABLE `message_log` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `content` text NOT NULL COMMENT 'æ¶ˆæ¯å†…å®¹',
  `status` tinyint(4) NOT NULL COMMENT 'çŠ¶æ€ï¼š0-å¾…å‘é€ï¼Œ1-å·²å‘é€ï¼Œ2-å¤±è´¥',
  `biz_type` varchar(50) NOT NULL COMMENT 'ä¸šåŠ¡ç±»å‹',
  `retry_count` int(11) DEFAULT '0' COMMENT 'é‡è¯•æ¬¡æ•°',
  `create_time` datetime NOT NULL,
  `update_time` datetime NOT NULL,
  PRIMARY KEY (`id`),
  KEY `idx_status` (`status`),
  KEY `idx_create_time` (`create_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- æ¶ˆæ¯å¤„ç†è®°å½•è¡¨ï¼ˆå¹‚ç­‰æ€§ï¼‰
CREATE TABLE `message_process_log` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `message_id` varchar(100) NOT NULL COMMENT 'æ¶ˆæ¯ID',
  `consumer_group` varchar(100) NOT NULL COMMENT 'æ¶ˆè´¹è€…ç»„',
  `process_time` datetime NOT NULL COMMENT 'å¤„ç†æ—¶é—´',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_message_consumer` (`message_id`, `consumer_group`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### 5.2 å®Œæ•´å®ç°

```java
/**
 * æ¶ˆæ¯æœåŠ¡
 */
@Service
public class MessageService {
    
    @Autowired
    private MessageLogMapper messageLogMapper;
    
    @Autowired
    private RocketMQTemplate rocketMQTemplate;
    
    /**
     * ä¿å­˜å¹¶å‘é€æ¶ˆæ¯
     */
    @Transactional
    public void saveAndSend(String content, String bizType) {
        // 1. ä¿å­˜æ¶ˆæ¯æ—¥å¿—
        MessageLog messageLog = new MessageLog();
        messageLog.setContent(content);
        messageLog.setStatus(MessageStatus.PENDING);
        messageLog.setBizType(bizType);
        messageLog.setRetryCount(0);
        messageLogMapper.insert(messageLog);
        
        // 2. å¼‚æ­¥å‘é€ï¼ˆé˜²æ­¢é˜»å¡ï¼‰
        CompletableFuture.runAsync(() -> sendMessage(messageLog.getId()));
    }
    
    /**
     * å‘é€æ¶ˆæ¯
     */
    private void sendMessage(Long messageId) {
        MessageLog messageLog = messageLogMapper.selectById(messageId);
        
        try {
            SendResult result = rocketMQTemplate.syncSend(
                "order-topic",
                messageLog.getContent()
            );
            
            if (result.getSendStatus() == SendStatus.SEND_OK) {
                // æ›´æ–°çŠ¶æ€ä¸ºå·²å‘é€
                messageLog.setStatus(MessageStatus.SENT);
                messageLogMapper.updateById(messageLog);
            }
        } catch (Exception e) {
            log.error("å‘é€æ¶ˆæ¯å¤±è´¥ï¼ŒmessageId={}", messageId, e);
            // æ›´æ–°é‡è¯•æ¬¡æ•°
            messageLog.setRetryCount(messageLog.getRetryCount() + 1);
            messageLogMapper.updateById(messageLog);
        }
    }
    
    /**
     * å®šæ—¶é‡è¯•å¤±è´¥æ¶ˆæ¯
     */
    @Scheduled(cron = "0 */1 * * * ?")  // æ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
    public void retryFailedMessages() {
        // æŸ¥è¯¢å¾…å‘é€çš„æ¶ˆæ¯ï¼ˆé‡è¯•æ¬¡æ•°<5ï¼‰
        List<MessageLog> pendingMessages = messageLogMapper.selectList(
            new LambdaQueryWrapper<MessageLog>()
                .eq(MessageLog::getStatus, MessageStatus.PENDING)
                .lt(MessageLog::getRetryCount, 5)
                .lt(MessageLog::getCreateTime, 
                    LocalDateTime.now().minusMinutes(1))  // 1åˆ†é’Ÿå‰çš„æ¶ˆæ¯
        );
        
        for (MessageLog message : pendingMessages) {
            sendMessage(message.getId());
        }
    }
}

/**
 * æ¶ˆæ¯æ¶ˆè´¹è€…ï¼ˆå¹‚ç­‰æ€§å¤„ç†ï¼‰
 */
@Service
@RocketMQMessageListener(topic = "order-topic", consumerGroup = "inventory-group")
public class IdempotentMessageListener implements RocketMQListener<String> {
    
    @Autowired
    private MessageProcessLogMapper processLogMapper;
    
    @Autowired
    private InventoryService inventoryService;
    
    @Override
    @Transactional
    public void onMessage(String message) {
        OrderDTO order = JSON.parseObject(message, OrderDTO.class);
        String messageId = order.getId().toString();
        String consumerGroup = "inventory-group";
        
        // 1. å¹‚ç­‰æ€§æ£€æŸ¥
        MessageProcessLog existLog = processLogMapper.selectOne(
            new LambdaQueryWrapper<MessageProcessLog>()
                .eq(MessageProcessLog::getMessageId, messageId)
                .eq(MessageProcessLog::getConsumerGroup, consumerGroup)
        );
        
        if (existLog != null) {
            log.info("æ¶ˆæ¯å·²å¤„ç†ï¼Œè·³è¿‡ã€‚messageId={}", messageId);
            return;
        }
        
        try {
            // 2. å¤„ç†ä¸šåŠ¡
            inventoryService.deduct(order.getProductId(), order.getCount());
            
            // 3. è®°å½•å¤„ç†æ—¥å¿—
            MessageProcessLog processLog = new MessageProcessLog();
            processLog.setMessageId(messageId);
            processLog.setConsumerGroup(consumerGroup);
            processLog.setProcessTime(LocalDateTime.now());
            processLogMapper.insert(processLog);
            
        } catch (DuplicateKeyException e) {
            // å¹¶å‘æƒ…å†µä¸‹å¯èƒ½æ’å…¥é‡å¤ï¼Œå¿½ç•¥
            log.warn("æ¶ˆæ¯å¤„ç†è®°å½•å·²å­˜åœ¨ï¼ˆå¹¶å‘ï¼‰", e);
        }
    }
}
```

---

## 6. æœ€ä½³å®è·µ

### 6.1 æ–¹æ¡ˆé€‰å‹

```
åœºæ™¯1ï¼šå¼ºä¸€è‡´æ€§è¦æ±‚
æ–¹æ¡ˆï¼šSeata ATæ¨¡å¼
ç¤ºä¾‹ï¼šé‡‘èè½¬è´¦ã€è®¢å•æ”¯ä»˜

åœºæ™¯2ï¼šæ€§èƒ½è¦æ±‚é«˜
æ–¹æ¡ˆï¼šTCCæ¨¡å¼
ç¤ºä¾‹ï¼šç§’æ€ã€æŠ¢è´­

åœºæ™¯3ï¼šé•¿äº‹åŠ¡ã€å¤æ‚æµç¨‹
æ–¹æ¡ˆï¼šSagaæ¨¡å¼
ç¤ºä¾‹ï¼šæ—…æ¸¸é¢„è®¢ï¼ˆæœºç¥¨+é…’åº—+é—¨ç¥¨ï¼‰

åœºæ™¯4ï¼šæœ€ç»ˆä¸€è‡´æ€§å³å¯
æ–¹æ¡ˆï¼šæœ¬åœ°æ¶ˆæ¯è¡¨ + MQ
ç¤ºä¾‹ï¼šè®¢å•åˆ›å»ºåå‘é€çŸ­ä¿¡ã€ç§¯åˆ†å¢åŠ 
```

### 6.2 æ³¨æ„äº‹é¡¹

```java
// 1. å¹‚ç­‰æ€§è®¾è®¡
@Service
public class IdempotentService {
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    public boolean processWithIdempotent(String orderId) {
        String key = "order:processed:" + orderId;
        
        // ä½¿ç”¨Redisçš„SETNXå®ç°å¹‚ç­‰
        Boolean success = redisTemplate.opsForValue()
            .setIfAbsent(key, "1", 24, TimeUnit.HOURS);
        
        if (Boolean.FALSE.equals(success)) {
            log.info("è®¢å•å·²å¤„ç†ï¼ŒorderId={}", orderId);
            return false;
        }
        
        // å¤„ç†ä¸šåŠ¡...
        return true;
    }
}

// 2. è¶…æ—¶å¤„ç†
@GlobalTransactional(
    timeoutMills = 30000,  // è¶…æ—¶æ—¶é—´30ç§’
    rollbackFor = Exception.class
)
public void createOrder(OrderDTO order) {
    // ä¸šåŠ¡é€»è¾‘...
}

// 3. å¼‚å¸¸å¤„ç†
@GlobalTransactional(rollbackFor = Exception.class)
public void createOrder(OrderDTO order) {
    try {
        // ä¸šåŠ¡é€»è¾‘...
    } catch (BusinessException e) {
        // ä¸šåŠ¡å¼‚å¸¸ï¼Œå›æ»š
        throw e;
    } catch (Exception e) {
        // ç³»ç»Ÿå¼‚å¸¸ï¼Œå›æ»š
        log.error("åˆ›å»ºè®¢å•å¤±è´¥", e);
        throw new SystemException("ç³»ç»Ÿå¼‚å¸¸");
    }
}
```

---

## ğŸ“š å‚è€ƒèµ„æ–™

- ğŸ”— [Seataå®˜æ–¹æ–‡æ¡£](https://seata.io/zh-cn/)
- ğŸ“– ã€Šåˆ†å¸ƒå¼äº‹åŠ¡ï¼šåŸç†ä¸å®è·µã€‹
- ğŸ“– ã€Šå¾®æœåŠ¡æ¶æ„è®¾è®¡æ¨¡å¼ã€‹

---

*æœ€åæ›´æ–°ï¼š2025-10-27*
