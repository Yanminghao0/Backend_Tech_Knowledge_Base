# è®¾è®¡IMç³»ç»Ÿ

> é«˜é¢‘é¢è¯•é¢˜ï¼šè®¾è®¡ä¸€ä¸ªç±»ä¼¼å¾®ä¿¡çš„å³æ—¶é€šè®¯ç³»ç»Ÿ

## ğŸ“‹ é¢è¯•é¢˜ç›®

```
è®¾è®¡ä¸€ä¸ªå³æ—¶é€šè®¯ç³»ç»Ÿï¼Œæ”¯æŒå•èŠã€ç¾¤èŠã€æ¶ˆæ¯æ¨é€ã€æœªè¯»è®¡æ•°ç­‰åŠŸèƒ½ã€‚
è¦æ±‚ï¼š
1. æ”¯æŒç™¾ä¸‡çº§ç”¨æˆ·åœ¨çº¿
2. æ¶ˆæ¯å®æ—¶æ€§ï¼ˆå»¶è¿Ÿ<1sï¼‰
3. æ¶ˆæ¯å¯é æ€§ï¼ˆä¸ä¸¢å¤±ã€ä¸é‡å¤ï¼‰
4. æ”¯æŒæ–‡æœ¬ã€å›¾ç‰‡ã€è¯­éŸ³ç­‰æ¶ˆæ¯ç±»å‹
5. é«˜å¯ç”¨ã€å¯æ‰©å±•
```

---

## ä¸€ã€éœ€æ±‚æ¾„æ¸…

### åŠŸèƒ½éœ€æ±‚

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- [x] å•èŠï¼šä¸€å¯¹ä¸€å®æ—¶æ¶ˆæ¯
- [x] ç¾¤èŠï¼šå¤šäººç¾¤ç»„æ¶ˆæ¯ï¼ˆä¸Šé™500äººï¼‰
- [x] æ¶ˆæ¯ç±»å‹ï¼šæ–‡æœ¬ã€å›¾ç‰‡ã€è¯­éŸ³ã€æ–‡ä»¶
- [x] æ¶ˆæ¯çŠ¶æ€ï¼šå·²å‘é€ã€å·²é€è¾¾ã€å·²è¯»
- [x] æœªè¯»æ¶ˆæ¯è®¡æ•°
- [x] åœ¨çº¿çŠ¶æ€æ˜¾ç¤ºï¼ˆåœ¨çº¿/ç¦»çº¿/æ­£åœ¨è¾“å…¥ï¼‰
- [x] æ¶ˆæ¯å†å²è®°å½•
- [x] ç¦»çº¿æ¶ˆæ¯æ¨é€

### éåŠŸèƒ½éœ€æ±‚

- **æ€§èƒ½**ï¼šæ¶ˆæ¯å»¶è¿Ÿ<1sï¼Œæ”¯æŒ10ä¸‡å¹¶å‘è¿æ¥
- **å¯ç”¨æ€§**ï¼š99.9%ï¼ŒæœåŠ¡ä¸ä¸­æ–­
- **å¯é æ€§**ï¼šæ¶ˆæ¯ä¸ä¸¢å¤±ï¼ˆ99.99%é€è¾¾ç‡ï¼‰
- **å¯æ‰©å±•æ€§**ï¼šæ”¯æŒç”¨æˆ·è§„æ¨¡ä»ç™¾ä¸‡åˆ°åƒä¸‡çº§æ‰©å±•
- **å®‰å…¨æ€§**ï¼šæ¶ˆæ¯åŠ å¯†ä¼ è¾“ï¼Œé˜²ç¯¡æ”¹

---

## äºŒã€æ¶æ„è®¾è®¡

### 2.1 æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       å®¢æˆ·ç«¯å±‚                           â”‚
â”‚  - iOS/Android App  - Webå®¢æˆ·ç«¯  - æ¡Œé¢å®¢æˆ·ç«¯            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       æ¥å…¥å±‚                             â”‚
â”‚  - Nginxåå‘ä»£ç†  - è´Ÿè½½å‡è¡¡  - SSLç»ˆæ­¢                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       åº”ç”¨å±‚                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ä¼šè¯æœåŠ¡ â”‚  â”‚ æ¶ˆæ¯æœåŠ¡ â”‚  â”‚ ç”¨æˆ·æœåŠ¡ â”‚  â”‚ ç¾¤ç»„æœåŠ¡ â”‚  â”‚
â”‚  â”‚(WebSocket)â”‚ â”‚(æ¶ˆæ¯å¤„ç†)â”‚  â”‚(ç”¨æˆ·ç®¡ç†)â”‚  â”‚(ç¾¤ç»„ç®¡ç†)â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       æ•°æ®å±‚                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  MySQL   â”‚  â”‚ MongoDB  â”‚  â”‚  Redis   â”‚  â”‚  Kafka   â”‚  â”‚
â”‚  â”‚ç”¨æˆ·/ç¾¤ç»„ â”‚  â”‚æ¶ˆæ¯å†å²  â”‚  â”‚ç¼“å­˜/çŠ¶æ€ â”‚  â”‚æ¶ˆæ¯é˜Ÿåˆ—  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ ¸å¿ƒæµç¨‹

**å•èŠæ¶ˆæ¯æµç¨‹**ï¼š
```
1. å®¢æˆ·ç«¯Aå‘é€æ¶ˆæ¯ â†’ WebSocket â†’ ä¼šè¯æœåŠ¡
2. ä¼šè¯æœåŠ¡ â†’ æ¶ˆæ¯æœåŠ¡ â†’ å­˜å‚¨æ¶ˆæ¯(MongoDB)
3. æ¶ˆæ¯æœåŠ¡ â†’ Kafkaæ¶ˆæ¯é˜Ÿåˆ—
4. ä¼šè¯æœåŠ¡æ¶ˆè´¹Kafka â†’ æ¨é€æ¶ˆæ¯ â†’ å®¢æˆ·ç«¯B
5. å®¢æˆ·ç«¯Bç¡®è®¤ â†’ æ›´æ–°æ¶ˆæ¯çŠ¶æ€
```

**ç¦»çº¿æ¶ˆæ¯æµç¨‹**ï¼š
```
1. å®¢æˆ·ç«¯Bç¦»çº¿æ—¶ï¼Œæ¶ˆæ¯å­˜å…¥ç¦»çº¿æ¶ˆæ¯è¡¨
2. å®¢æˆ·ç«¯Bä¸Šçº¿ â†’ æ‹‰å–ç¦»çº¿æ¶ˆæ¯
3. æ‰¹é‡æ¨é€ç¦»çº¿æ¶ˆæ¯ â†’ æ›´æ–°å·²è¯»çŠ¶æ€
```

---

## ä¸‰ã€è¯¦ç»†è®¾è®¡

### 3.1 æ•°æ®æ¨¡å‹

**MySQLæ ¸å¿ƒè¡¨**ï¼š
```sql
-- ç”¨æˆ·è¡¨
CREATE TABLE users (
    user_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) UNIQUE NOT NULL,
    avatar_url VARCHAR(255),
    status TINYINT DEFAULT 0 COMMENT '0-ç¦»çº¿,1-åœ¨çº¿,2-å¿™ç¢Œ',
    last_active_time DATETIME,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- å¥½å‹è¡¨
CREATE TABLE friends (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    friend_id BIGINT NOT NULL,
    status TINYINT DEFAULT 1 COMMENT '1-æ­£å¸¸,0-æ‹‰é»‘',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY uk_user_friend (user_id, friend_id)
);

-- ç¾¤ç»„è¡¨
CREATE TABLE groups (
    group_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    group_name VARCHAR(100) NOT NULL,
    avatar_url VARCHAR(255),
    owner_id BIGINT NOT NULL,
    max_members INT DEFAULT 500,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç¾¤æˆå‘˜è¡¨
CREATE TABLE group_members (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    group_id BIGINT NOT NULL,
    user_id BIGINT NOT NULL,
    role TINYINT DEFAULT 0 COMMENT '0-æˆå‘˜,1-ç®¡ç†å‘˜,2-ç¾¤ä¸»',
    joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY uk_group_user (group_id, user_id)
);
```

**MongoDBé›†åˆ**ï¼š
```javascript
// æ¶ˆæ¯é›†åˆ
{
  _id: ObjectId("..."),        // æ¶ˆæ¯ID
  from_user_id: 123,            // å‘é€è€…ID
  to_user_id: 456,              // æ¥æ”¶è€…ID(å•èŠ)
  group_id: null,               // ç¾¤ç»„ID(ç¾¤èŠ)
  content: "Hello",             // æ¶ˆæ¯å†…å®¹
  msg_type: 1,                  // 1-æ–‡æœ¬,2-å›¾ç‰‡,3-è¯­éŸ³
  status: 2,                    // 1-å‘é€ä¸­,2-å·²é€è¾¾,3-å·²è¯»
  sequence: 1001,               // æ¶ˆæ¯åºåˆ—å·
  created_at: ISODate("..."),   // åˆ›å»ºæ—¶é—´
  updated_at: ISODate("...")    // æ›´æ–°æ—¶é—´
}

// ç¦»çº¿æ¶ˆæ¯é›†åˆ
{
  _id: ObjectId("..."),
  user_id: 456,                 // æ¥æ”¶è€…ID
  messages: [ObjectId("...")],  // æ¶ˆæ¯IDåˆ—è¡¨
  unread_count: 5               // æœªè¯»æ•°é‡
}
```

**Redisæ•°æ®ç»“æ„**ï¼š
```
// ç”¨æˆ·åœ¨çº¿çŠ¶æ€
hash: user_status:{user_id} â†’ {status:1, device_id:"xxx"}

// æœªè¯»æ¶ˆæ¯è®¡æ•°
hash: unread:{user_id} â†’ {friend_id:count, group_id:count}

// ä¼šè¯åˆ—è¡¨
sorted set: conversation:{user_id} â†’ {friend_id/group_id, timestamp}

// WebSocketè¿æ¥æ˜ å°„
hash: connection:{user_id} â†’ {session_id:node_id}
```

### 3.2 åè®®è®¾è®¡

**WebSocketåè®®æ ¼å¼**ï¼š
```json
{
  "cmd": 1001,               // å‘½ä»¤ç±»å‹(1001-å‘é€æ¶ˆæ¯,1002-å¿ƒè·³)
  "seq": 12345,              // åºåˆ—å·
  "data": {                  // ä¸šåŠ¡æ•°æ®
    "msg_id": "m123",       // æ¶ˆæ¯ID
    "from": 123,             // å‘é€è€…
    "to": 456,               // æ¥æ”¶è€…
    "content": "Hello",     // å†…å®¹
    "type": 1,               // æ¶ˆæ¯ç±»å‹
    "timestamp": 1620000000  // æ—¶é—´æˆ³
  }
}
```

**æ¶ˆæ¯çŠ¶æ€ç **ï¼š
| çŠ¶æ€ç  | å«ä¹‰       | è¯´æ˜                     |
|--------|------------|--------------------------|
| 1      | å‘é€ä¸­     | å®¢æˆ·ç«¯å·²å‘é€ï¼ŒæœåŠ¡ç«¯æœªæ”¶ |
| 2      | å·²é€è¾¾     | æœåŠ¡ç«¯å·²æ¨é€ï¼Œå®¢æˆ·ç«¯æœªè¯» |
| 3      | å·²è¯»       | å®¢æˆ·ç«¯å·²é˜…è¯»             |
| -1     | å‘é€å¤±è´¥   | ç½‘ç»œé”™è¯¯æˆ–æœåŠ¡å¼‚å¸¸       |

### 3.3 æ ¸å¿ƒä»£ç å®ç°

**WebSocketä¼šè¯ç®¡ç†**ï¼š
```java
@ServerEndpoint("/ws/im/{userId}")
public class IMWebSocketServer {
    // ç”¨æˆ·è¿æ¥æ˜ å°„
    private static ConcurrentHashMap<Long, Session> userSessions = new ConcurrentHashMap<>();
    
    @OnOpen
    public void onOpen(Session session, @PathParam("userId") Long userId) {
        userSessions.put(userId, session);
        // æ›´æ–°åœ¨çº¿çŠ¶æ€
        redisTemplate.opsForHash().put("user_status:" + userId, "status", 1);
        log.info("ç”¨æˆ·{}ä¸Šçº¿ï¼Œå½“å‰åœ¨çº¿äººæ•°:{}", userId, userSessions.size());
    }
    
    @OnMessage
    public void onMessage(String message, Session session) {
        // è§£ææ¶ˆæ¯
        WebSocketMessage msg = JSON.parseObject(message, WebSocketMessage.class);
        if (msg.getCmd() == 1001) {
            // å¤„ç†å‘é€æ¶ˆæ¯
            messageService.handleSendMessage(msg);
        } else if (msg.getCmd() == 1002) {
            // å¿ƒè·³å“åº”
            sendMessage(session, buildHeartbeatResponse(msg.getSeq()));
        }
    }
    
    @OnClose
    public void onClose(Session session, @PathParam("userId") Long userId) {
        userSessions.remove(userId);
        // æ›´æ–°ç¦»çº¿çŠ¶æ€
        redisTemplate.opsForHash().put("user_status:" + userId, "status", 0);
        log.info("ç”¨æˆ·{}ä¸‹çº¿", userId);
    }
    
    // æ¨é€æ¶ˆæ¯ç»™ç”¨æˆ·
    public static boolean pushMessage(Long userId, String message) {
        Session session = userSessions.get(userId);
        if (session != null && session.isOpen()) {
            try {
                session.getBasicRemote().sendText(message);
                return true;
            } catch (IOException e) {
                log.error("æ¨é€å¤±è´¥ userId:{}", userId, e);
            }
        }
        return false;
    }
}
```

**æ¶ˆæ¯å¤„ç†æœåŠ¡**ï¼š
```java
@Service
public class MessageService {
    @Autowired private MongoTemplate mongoTemplate;
    @Autowired private KafkaTemplate<String, String> kafkaTemplate;
    @Autowired private RedisTemplate<String, String> redisTemplate;
    
    // å¤„ç†å‘é€æ¶ˆæ¯
    public void handleSendMessage(WebSocketMessage msg) {
        // 1. ç”Ÿæˆæ¶ˆæ¯ID
        String msgId = "m" + System.currentTimeMillis() + RandomUtils.nextInt(1000);
        
        // 2. æ„å»ºæ¶ˆæ¯å¯¹è±¡
        Message message = new Message();
        message.setMsgId(msgId);
        message.setFromUserId(msg.getData().get("from"));
        message.setToUserId(msg.getData().get("to"));
        message.setContent(msg.getData().get("content"));
        message.setType(Integer.parseInt(msg.getData().get("type")));
        message.setStatus(2); // å·²é€è¾¾
        message.setCreatedAt(new Date());
        
        // 3. ä¿å­˜æ¶ˆæ¯
        mongoTemplate.save(message, "messages");
        
        // 4. å‘é€åˆ°Kafka
        kafkaTemplate.send("im_message_topic", msgId, JSON.toJSONString(message));
        
        // 5. æ›´æ–°æœªè¯»è®¡æ•°
        String unreadKey = "unread:" + message.getToUserId();
        redisTemplate.opsForHash().increment(unreadKey, message.getFromUserId().toString(), 1);
    }
    
    // æ¶ˆè´¹Kafkaæ¶ˆæ¯å¹¶æ¨é€
    @KafkaListener(topics = "im_message_topic")
    public void consumeMessage(ConsumerRecord<String, String> record) {
        String msg = record.value();
        Message message = JSON.parseObject(msg, Message.class);
        Long toUserId = message.getToUserId();
        
        // æ¨é€æ¶ˆæ¯ç»™æ¥æ”¶è€…
        boolean success = IMWebSocketServer.pushMessage(toUserId, msg);
        if (!success) {
            // æ¨é€å¤±è´¥ï¼Œå­˜å…¥ç¦»çº¿æ¶ˆæ¯
            saveOfflineMessage(toUserId, message);
        }
    }
}
```

---

## å››ã€å…³é”®æŠ€æœ¯æŒ‘æˆ˜

### 4.1 æ¶ˆæ¯å¯é æ€§ä¿è¯

**é‡è¯•æœºåˆ¶**ï¼š
```java
// Kafkaæ¶ˆæ¯é‡è¯•é…ç½®
@Bean
public ProducerFactory<String, String> producerFactory() {
    Map<String, Object> config = new HashMap<>();
    config.put(ProducerConfig.RETRIES_CONFIG, 3); // é‡è¯•3æ¬¡
    config.put(ProducerConfig.RETRY_BACKOFF_MS_CONFIG, 1000); // é‡è¯•é—´éš”
    config.put(ProducerConfig.ACKS_CONFIG, "all"); // æ‰€æœ‰å‰¯æœ¬ç¡®è®¤
    return new DefaultKafkaProducerFactory<>(config);
}
```

**æ¶ˆæ¯å¹‚ç­‰æ€§**ï¼š
```java
// æ¶ˆæ¯å»é‡å¤„ç†
public void processMessage(Message message) {
    String msgId = message.getMsgId();
    // åˆ¤æ–­æ¶ˆæ¯æ˜¯å¦å·²å¤„ç†
    Boolean isProcessed = redisTemplate.opsForValue().setIfAbsent("msg_processed:" + msgId, "1", 24, TimeUnit.HOURS);
    if (Boolean.TRUE.equals(isProcessed)) {
        // é¦–æ¬¡å¤„ç†
        doProcess(message);
    } else {
        // é‡å¤æ¶ˆæ¯ï¼Œç›´æ¥è¿”å›æˆåŠŸ
        log.warn("é‡å¤æ¶ˆæ¯ msgId:{}", msgId);
    }
}
```

### 4.2 é«˜å¹¶å‘è¿æ¥å¤„ç†

**WebSocketé›†ç¾¤æ–¹æ¡ˆ**ï¼š
```
1. ä½¿ç”¨Nginxåå‘ä»£ç†WebSocket
2. ä¼šè¯å…±äº«ï¼šRediså­˜å‚¨ç”¨æˆ·-èŠ‚ç‚¹æ˜ å°„
3. è·¨èŠ‚ç‚¹æ¨é€ï¼šé€šè¿‡Kafkaå¹¿æ’­æ¶ˆæ¯
```

**Nginxé…ç½®**ï¼š
```nginx
location /ws/im/ {
    proxy_pass http://im_server_cluster;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_read_timeout 3600s; # é•¿è¿æ¥è¶…æ—¶
}
```

---

## äº”ã€å®¹é‡è§„åˆ’

### 5.1 ç”¨æˆ·è§„æ¨¡ä¼°ç®—

```
å‡è®¾æ¡ä»¶ï¼š
- ç›®æ ‡ç”¨æˆ·ï¼š1000ä¸‡æ³¨å†Œç”¨æˆ·
- æ—¥æ´»ç”¨æˆ·ï¼š300ä¸‡ï¼ˆ30%ï¼‰
- åŒæ—¶åœ¨çº¿ç”¨æˆ·å³°å€¼ï¼š50ä¸‡
- äººå‡æ¶ˆæ¯é‡ï¼š20æ¡/å¤©
- æ¶ˆæ¯ç•™å­˜ï¼š30å¤©
```

### 5.2 å­˜å‚¨è®¡ç®—

| æ•°æ®ç±»å‹ | å•æ¡å¤§å° | æ—¥äº§ç”Ÿé‡ | æœˆå­˜å‚¨é‡ | å­˜å‚¨ä»‹è´¨ |
|---------|---------|---------|---------|---------|
| æ–‡æœ¬æ¶ˆæ¯ | 500B | 6000ä¸‡æ¡ | 90GB | MongoDB |
| å›¾ç‰‡æ¶ˆæ¯ | 200KB | 300ä¸‡æ¡ | 1800GB | å¯¹è±¡å­˜å‚¨ |
| ç”¨æˆ·æ•°æ® | 1KB | 1000ä¸‡ç”¨æˆ· | 10GB | MySQL |
| ä¼šè¯æ•°æ® | 200B | 5000ä¸‡ä¼šè¯ | 30GB | Redis+MySQL |

### 5.3 æ€§èƒ½æŒ‡æ ‡

```
- æ¶ˆæ¯ååé‡ï¼šå³°å€¼5000æ¡/ç§’
- WebSocketè¿æ¥ï¼š50ä¸‡å¹¶å‘
- æ¶ˆæ¯å»¶è¿Ÿï¼šP99 < 500ms
- å­˜å‚¨IOPSï¼šè¯»10000/ç§’ï¼Œå†™5000/ç§’
```

### 5.2 å­˜å‚¨æ‰©å±•
- MongoDBåˆ†ç‰‡é›†ç¾¤å­˜å‚¨æ¶ˆæ¯å†å²
- Redisé›†ç¾¤åˆ†ç‰‡å­˜å‚¨åœ¨çº¿çŠ¶æ€å’Œç¼“å­˜
- MySQLè¯»å†™åˆ†ç¦»ï¼Œä¸»ä»å¤åˆ¶

### 5.3 å¤šç»ˆç«¯åŒæ­¥
- åŸºäºè®¾å¤‡IDçš„å¤šç«¯ç™»å½•
- æ¶ˆæ¯å¤šç«¯åŒæ­¥æœºåˆ¶
- å·²è¯»çŠ¶æ€è·¨è®¾å¤‡åŒæ­¥

---

## å…­ã€ç›‘æ§ä¸è¿ç»´

### 6.1 æ ¸å¿ƒç›‘æ§æŒ‡æ ‡

| æŒ‡æ ‡ç±»åˆ« | å…·ä½“æŒ‡æ ‡ | é˜ˆå€¼ | ç›‘æ§é¢‘ç‡ |
|---------|---------|------|---------|
| è¿æ¥æŒ‡æ ‡ | WebSocketè¿æ¥æ•° | <80%å®¹é‡ | 5ç§’ |
| è¿æ¥æŒ‡æ ‡ | è¿æ¥å¤±è´¥ç‡ | <0.1% | 5ç§’ |
| æ¶ˆæ¯æŒ‡æ ‡ | æ¶ˆæ¯ååé‡ | - | 1ç§’ |
| æ¶ˆæ¯æŒ‡æ ‡ | æ¶ˆæ¯å»¶è¿ŸP99 | <500ms | 1ç§’ |
| æ¶ˆæ¯æŒ‡æ ‡ | æ¶ˆæ¯ä¸¢å¤±ç‡ | <0.01% | 1åˆ†é’Ÿ |
| ç³»ç»ŸæŒ‡æ ‡ | CPUä½¿ç”¨ç‡ | <80% | 5ç§’ |
| ç³»ç»ŸæŒ‡æ ‡ | å†…å­˜ä½¿ç”¨ç‡ | <85% | 5ç§’ |
| ç³»ç»ŸæŒ‡æ ‡ | ç½‘ç»œå¸¦å®½ | <90% | 5ç§’ |
| æ•°æ®åº“æŒ‡æ ‡ | æŸ¥è¯¢å»¶è¿Ÿ | <200ms | 10ç§’ |
| ç¼“å­˜æŒ‡æ ‡ | Rediså‘½ä¸­ç‡ | >95% | 10ç§’ |

### 6.2 å‘Šè­¦æœºåˆ¶

**ä¸‰çº§å‘Šè­¦ä½“ç³»**:
1. **P0çº§ï¼ˆç´§æ€¥ï¼‰**: ç”µè¯+çŸ­ä¿¡+é‚®ä»¶ï¼Œ5åˆ†é’Ÿå†…å“åº”
   - WebSocketè¿æ¥å¤±è´¥ç‡>1%
   - æ¶ˆæ¯å»¶è¿ŸP99>1000ms
   - æœåŠ¡èŠ‚ç‚¹å®•æœº

2. **P1çº§ï¼ˆé‡è¦ï¼‰**: çŸ­ä¿¡+é‚®ä»¶ï¼Œ30åˆ†é’Ÿå†…å“åº”
   - æ¶ˆæ¯ä¸¢å¤±ç‡>0.1%
   - CPUä½¿ç”¨ç‡>90%æŒç»­5åˆ†é’Ÿ
   - MongoDBå†™å…¥å¤±è´¥

3. **P2çº§ï¼ˆä¸€èˆ¬ï¼‰**: é‚®ä»¶ï¼Œ2å°æ—¶å†…å“åº”
   - è¿æ¥æ•°æ¥è¿‘é˜ˆå€¼
   - ç£ç›˜ç©ºé—´>85%
   - ç¼“å­˜å‘½ä¸­ç‡<90%

---

## ğŸ“š æ‰©å±•é˜…è¯»

1. [XMPPåè®®è§„èŒƒ](https://xmpp.org/rfcs/)
2. [MQTTåè®®è¯¦è§£](https://mqtt.org/)
3. [å¾®ä¿¡åå°æ¶æ„è®¾è®¡](https://www.infoq.cn/article/wechat-architecture)
4. [Kafkaæ¶ˆæ¯å¯é æ€§ä¿è¯](https://kafka.apache.org/documentation/#semantics)
5. [MongoDBåˆ†ç‰‡é›†ç¾¤éƒ¨ç½²](https://docs.mongodb.com/manual/core/sharded-cluster/)
6. [å³æ—¶é€šè®¯ç³»ç»Ÿçš„æ¶ˆæ¯å¯é æ€§è®¾è®¡](https://tech.youzan.com/im-message-reliability/)
7. [WebSocketæ€§èƒ½ä¼˜åŒ–å®è·µ](https://developer.mozilla.org/zh-CN/docs/Web/API/WebSocket)
8. [å¤§è§„æ¨¡IMç³»ç»Ÿçš„æ¶æ„æ¼”è¿›](https://cloud.tencent.com/developer/article/1651264)