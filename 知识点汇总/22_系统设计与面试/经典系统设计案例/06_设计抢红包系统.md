# è®¾è®¡æŠ¢çº¢åŒ…ç³»ç»Ÿ

> é«˜é¢‘é¢è¯•é¢˜ï¼šè®¾è®¡ä¸€ä¸ªç±»ä¼¼å¾®ä¿¡çš„æŠ¢çº¢åŒ…ç³»ç»Ÿ

## ğŸ“‹ é¢è¯•é¢˜ç›®

```
è®¾è®¡ä¸€ä¸ªæŠ¢çº¢åŒ…ç³»ç»Ÿï¼Œæ”¯æŒä»¥ä¸‹åŠŸèƒ½ï¼š
1. å‘çº¢åŒ…ï¼šæŒ‡å®šé‡‘é¢å’Œä¸ªæ•°
2. æŠ¢çº¢åŒ…ï¼šéšæœºé‡‘é¢åˆ†é…
3. é«˜å¹¶å‘ï¼šæ”¯æŒç™¾ä¸‡çº§å¹¶å‘æŠ¢çº¢åŒ…
4. æ•°æ®ä¸€è‡´æ€§ï¼šä¸è¶…å‘ã€ä¸å°‘å‘
```

---

## ä¸€ã€éœ€æ±‚æ¾„æ¸…

### åŠŸèƒ½éœ€æ±‚

- [x] å‘çº¢åŒ…ï¼šè®¾ç½®æ€»é‡‘é¢ã€çº¢åŒ…ä¸ªæ•°
- [x] æŠ¢çº¢åŒ…ï¼šéšæœºåˆ†é…é‡‘é¢
- [x] çº¢åŒ…è®°å½•ï¼šå‘é€è®°å½•ã€é¢†å–è®°å½•
- [x] çº¢åŒ…è¿‡æœŸï¼š24å°æ—¶æœªé¢†å–é€€å›
- [x] çº¢åŒ…è¯¦æƒ…ï¼šæŸ¥çœ‹é¢†å–æƒ…å†µ

### éåŠŸèƒ½éœ€æ±‚

- **æ€§èƒ½**ï¼šæ”¯æŒ10ä¸‡QPSæŠ¢çº¢åŒ…
- **ä¸€è‡´æ€§**ï¼šé‡‘é¢ç²¾ç¡®ï¼Œä¸è¶…å‘
- **å¯ç”¨æ€§**ï¼š99.99%
- **å»¶è¿Ÿ**ï¼šæŠ¢çº¢åŒ…P99 < 100ms

---

## äºŒã€æ ¸å¿ƒç®—æ³•

### 2.1 äºŒå€å‡å€¼æ³•

```java
/**
 * äºŒå€å‡å€¼æ³•ï¼šä¿è¯æ¯ä¸ªçº¢åŒ…é‡‘é¢ç›¸å¯¹å‡åŒ€
 * æ¯æ¬¡éšæœºèŒƒå›´ï¼š[1, å‰©ä½™é‡‘é¢/å‰©ä½™äººæ•°*2]
 */
public class DoubleAverageAlgorithm {
    
    public List<Integer> divide(int totalAmount, int totalCount) {
        List<Integer> result = new ArrayList<>();
        int restAmount = totalAmount;
        int restCount = totalCount;
        
        Random random = new Random();
        
        for (int i = 0; i < totalCount - 1; i++) {
            // éšæœºèŒƒå›´ï¼š[1, å‰©ä½™å‡å€¼*2]
            int avg = restAmount / restCount;
            int max = Math.max(1, avg * 2 - 1);
            int amount = random.nextInt(max) + 1;
            
            result.add(amount);
            restAmount -= amount;
            restCount--;
        }
        
        // æœ€åä¸€ä¸ªçº¢åŒ…
        result.add(restAmount);
        
        return result;
    }
}
```

### 2.2 é¢„åˆ†é…æ–¹æ¡ˆ

```java
/**
 * çº¢åŒ…é¢„åˆ†é…ï¼šå‘çº¢åŒ…æ—¶é¢„å…ˆè®¡ç®—æ¯ä¸ªçº¢åŒ…é‡‘é¢
 */
@Service
public class RedPacketService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    /**
     * å‘çº¢åŒ…
     */
    @Transactional
    public String sendRedPacket(Long userId, int totalAmount, int totalCount) {
        // 1. ç”Ÿæˆçº¢åŒ…ID
        String packetId = "rp_" + System.currentTimeMillis() + "_" + userId;
        
        // 2. é¢„åˆ†é…çº¢åŒ…é‡‘é¢
        List<Integer> amounts = divideRedPacket(totalAmount, totalCount);
        
        // 3. å­˜å…¥Redisé˜Ÿåˆ—
        String key = "red_packet:" + packetId;
        for (Integer amount : amounts) {
            redisTemplate.opsForList().rightPush(key, amount);
        }
        
        // 4. è®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆ24å°æ—¶ï¼‰
        redisTemplate.expire(key, 24, TimeUnit.HOURS);
        
        // 5. ä¿å­˜çº¢åŒ…ä¿¡æ¯
        RedPacket packet = new RedPacket();
        packet.setPacketId(packetId);
        packet.setUserId(userId);
        packet.setTotalAmount(totalAmount);
        packet.setTotalCount(totalCount);
        packet.setRemainAmount(totalAmount);
        packet.setRemainCount(totalCount);
        packet.setStatus(1);
        redPacketMapper.insert(packet);
        
        return packetId;
    }
    
    /**
     * æŠ¢çº¢åŒ…
     */
    public GrabResult grabRedPacket(String packetId, Long userId) {
        String key = "red_packet:" + packetId;
        String grabKey = "red_packet_grab:" + packetId;
        
        // 1. æ£€æŸ¥æ˜¯å¦å·²æŠ¢è¿‡
        if (redisTemplate.opsForSet().isMember(grabKey, userId)) {
            return GrabResult.fail("å·²ç»æŠ¢è¿‡äº†");
        }
        
        // 2. ä»é˜Ÿåˆ—å¼¹å‡ºä¸€ä¸ªçº¢åŒ…
        Object amount = redisTemplate.opsForList().leftPop(key);
        if (amount == null) {
            return GrabResult.fail("çº¢åŒ…å·²æŠ¢å®Œ");
        }
        
        // 3. è®°å½•å·²æŠ¢ç”¨æˆ·
        redisTemplate.opsForSet().add(grabKey, userId);
        
        // 4. å¼‚æ­¥æ›´æ–°æ•°æ®åº“
        asyncUpdateGrabRecord(packetId, userId, (Integer) amount);
        
        return GrabResult.success((Integer) amount);
    }
    
    /**
     * åˆ†é…çº¢åŒ…é‡‘é¢ï¼ˆäºŒå€å‡å€¼æ³•ï¼‰
     */
    private List<Integer> divideRedPacket(int totalAmount, int totalCount) {
        List<Integer> amounts = new ArrayList<>();
        int restAmount = totalAmount;
        int restCount = totalCount;
        Random random = new Random();
        
        for (int i = 0; i < totalCount - 1; i++) {
            int avg = restAmount / restCount;
            int max = Math.max(1, avg * 2 - 1);
            int amount = random.nextInt(max) + 1;
            amounts.add(amount);
            restAmount -= amount;
            restCount--;
        }
        amounts.add(restAmount);
        
        // æ‰“ä¹±é¡ºåº
        Collections.shuffle(amounts);
        return amounts;
    }
}
```

---

## ä¸‰ã€æ¶æ„è®¾è®¡

### 3.1 æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       å®¢æˆ·ç«¯                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    API Gateway                               â”‚
â”‚  - é™æµ  - é‰´æƒ  - è·¯ç”±                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    çº¢åŒ…æœåŠ¡é›†ç¾¤                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ å‘çº¢åŒ…   â”‚  â”‚ æŠ¢çº¢åŒ…   â”‚  â”‚ æŸ¥è¯¢æœåŠ¡ â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       æ•°æ®å±‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚  Redis   â”‚  â”‚  MySQL   â”‚  â”‚  Kafka   â”‚                  â”‚
â”‚  â”‚çº¢åŒ…é˜Ÿåˆ—  â”‚  â”‚çº¢åŒ…è®°å½•  â”‚  â”‚å¼‚æ­¥å¤„ç†  â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æ•°æ®æ¨¡å‹

```sql
-- çº¢åŒ…è¡¨
CREATE TABLE red_packet (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    packet_id VARCHAR(64) UNIQUE NOT NULL,
    user_id BIGINT NOT NULL COMMENT 'å‘é€è€…',
    total_amount INT NOT NULL COMMENT 'æ€»é‡‘é¢(åˆ†)',
    total_count INT NOT NULL COMMENT 'æ€»ä¸ªæ•°',
    remain_amount INT NOT NULL COMMENT 'å‰©ä½™é‡‘é¢',
    remain_count INT NOT NULL COMMENT 'å‰©ä½™ä¸ªæ•°',
    status TINYINT DEFAULT 1 COMMENT '1-è¿›è¡Œä¸­,2-å·²æŠ¢å®Œ,3-å·²è¿‡æœŸ',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    expired_at TIMESTAMP,
    INDEX idx_user_time (user_id, created_at)
);

-- æŠ¢çº¢åŒ…è®°å½•è¡¨
CREATE TABLE red_packet_record (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    packet_id VARCHAR(64) NOT NULL,
    user_id BIGINT NOT NULL COMMENT 'é¢†å–è€…',
    amount INT NOT NULL COMMENT 'é¢†å–é‡‘é¢(åˆ†)',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY uk_packet_user (packet_id, user_id),
    INDEX idx_user_time (user_id, created_at)
);
```

---

## å››ã€é«˜å¹¶å‘å¤„ç†

### 4.1 Redis Luaè„šæœ¬ä¿è¯åŸå­æ€§

```lua
-- æŠ¢çº¢åŒ…Luaè„šæœ¬
local packetKey = KEYS[1]
local grabKey = KEYS[2]
local userId = ARGV[1]

-- æ£€æŸ¥æ˜¯å¦å·²æŠ¢è¿‡
if redis.call('sismember', grabKey, userId) == 1 then
    return -1  -- å·²æŠ¢è¿‡
end

-- å¼¹å‡ºçº¢åŒ…
local amount = redis.call('lpop', packetKey)
if not amount then
    return -2  -- çº¢åŒ…å·²æŠ¢å®Œ
end

-- è®°å½•å·²æŠ¢ç”¨æˆ·
redis.call('sadd', grabKey, userId)

return amount
```

```java
/**
 * ä½¿ç”¨Luaè„šæœ¬æŠ¢çº¢åŒ…
 */
public GrabResult grabWithLua(String packetId, Long userId) {
    String script = "local packetKey = KEYS[1]\n" +
            "local grabKey = KEYS[2]\n" +
            "local userId = ARGV[1]\n" +
            "if redis.call('sismember', grabKey, userId) == 1 then\n" +
            "    return -1\n" +
            "end\n" +
            "local amount = redis.call('lpop', packetKey)\n" +
            "if not amount then\n" +
            "    return -2\n" +
            "end\n" +
            "redis.call('sadd', grabKey, userId)\n" +
            "return amount";
    
    List<String> keys = Arrays.asList(
        "red_packet:" + packetId,
        "red_packet_grab:" + packetId
    );
    
    Long result = redisTemplate.execute(
        new DefaultRedisScript<>(script, Long.class),
        keys,
        userId.toString()
    );
    
    if (result == -1) {
        return GrabResult.fail("å·²ç»æŠ¢è¿‡äº†");
    }
    if (result == -2) {
        return GrabResult.fail("çº¢åŒ…å·²æŠ¢å®Œ");
    }
    
    // å¼‚æ­¥æ›´æ–°æ•°æ®åº“
    asyncUpdateGrabRecord(packetId, userId, result.intValue());
    
    return GrabResult.success(result.intValue());
}
```

### 4.2 å¼‚æ­¥å¤„ç†

```java
/**
 * å¼‚æ­¥æ›´æ–°æŠ¢çº¢åŒ…è®°å½•
 */
@Async
public void asyncUpdateGrabRecord(String packetId, Long userId, int amount) {
    // å‘é€åˆ°Kafka
    GrabMessage message = new GrabMessage(packetId, userId, amount);
    kafkaTemplate.send("red_packet_grab_topic", JSON.toJSONString(message));
}

/**
 * æ¶ˆè´¹æŠ¢çº¢åŒ…æ¶ˆæ¯
 */
@KafkaListener(topics = "red_packet_grab_topic")
public void consumeGrabMessage(String message) {
    GrabMessage grabMessage = JSON.parseObject(message, GrabMessage.class);
    
    // 1. æ’å…¥é¢†å–è®°å½•
    RedPacketRecord record = new RedPacketRecord();
    record.setPacketId(grabMessage.getPacketId());
    record.setUserId(grabMessage.getUserId());
    record.setAmount(grabMessage.getAmount());
    recordMapper.insert(record);
    
    // 2. æ›´æ–°çº¢åŒ…å‰©ä½™
    redPacketMapper.decreaseRemain(grabMessage.getPacketId(), grabMessage.getAmount());
}
```

---

## äº”ã€é¢è¯•è¦ç‚¹

### å¸¸è§é—®é¢˜

**Q1: å¦‚ä½•ä¿è¯çº¢åŒ…ä¸è¶…å‘ï¼Ÿ**
```
1. é¢„åˆ†é…ï¼šå‘çº¢åŒ…æ—¶é¢„å…ˆè®¡ç®—æ¯ä¸ªé‡‘é¢
2. RedisåŸå­æ“ä½œï¼šä½¿ç”¨Luaè„šæœ¬ä¿è¯åŸå­æ€§
3. ä¹è§‚é”ï¼šæ•°æ®åº“æ›´æ–°æ—¶æ£€æŸ¥ç‰ˆæœ¬å·
```

**Q2: å¦‚ä½•å¤„ç†é«˜å¹¶å‘ï¼Ÿ**
```
1. Redisç¼“å­˜ï¼šçº¢åŒ…æ•°æ®å­˜Redis
2. é¢„åˆ†é…ï¼šé¿å…å®æ—¶è®¡ç®—
3. å¼‚æ­¥å¤„ç†ï¼šæŠ¢çº¢åŒ…åå¼‚æ­¥æ›´æ–°æ•°æ®åº“
4. é™æµï¼šAPIå±‚é™æµä¿æŠ¤
```

**Q3: çº¢åŒ…é‡‘é¢åˆ†é…ç®—æ³•ï¼Ÿ**
```
äºŒå€å‡å€¼æ³•ï¼š
- æ¯æ¬¡éšæœºèŒƒå›´ï¼š[1, å‰©ä½™é‡‘é¢/å‰©ä½™äººæ•°*2]
- ä¿è¯æ¯ä¸ªçº¢åŒ…é‡‘é¢ç›¸å¯¹å‡åŒ€
- æœ€åä¸€ä¸ªçº¢åŒ…ä¸ºå‰©ä½™é‡‘é¢
```

---

## ğŸ“š æ‰©å±•é˜…è¯»

1. [å¾®ä¿¡çº¢åŒ…ç³»ç»Ÿè®¾è®¡](https://www.infoq.cn/article/2017-hongbao-system-design)
2. [é«˜å¹¶å‘çº¢åŒ…ç³»ç»Ÿå®è·µ](https://tech.meituan.com/2016/11/04/mt-hongbao.html)
