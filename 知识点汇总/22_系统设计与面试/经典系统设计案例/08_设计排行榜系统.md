# è®¾è®¡æ’è¡Œæ¦œç³»ç»Ÿ

> é«˜é¢‘é¢è¯•é¢˜ï¼šè®¾è®¡ä¸€ä¸ªå®æ—¶æ’è¡Œæ¦œç³»ç»Ÿ

## ğŸ“‹ é¢è¯•é¢˜ç›®

```
è®¾è®¡ä¸€ä¸ªæ’è¡Œæ¦œç³»ç»Ÿï¼Œæ”¯æŒä»¥ä¸‹åŠŸèƒ½ï¼š
1. å®æ—¶æ›´æ–°ç”¨æˆ·åˆ†æ•°
2. æŸ¥è¯¢Top Næ’å
3. æŸ¥è¯¢ç”¨æˆ·æ’å
4. æ”¯æŒå¤šç»´åº¦æ’è¡Œï¼ˆæ—¥æ¦œã€å‘¨æ¦œã€æ€»æ¦œï¼‰
```

---

## ä¸€ã€éœ€æ±‚æ¾„æ¸…

### åŠŸèƒ½éœ€æ±‚

- [x] åˆ†æ•°æ›´æ–°ï¼šå®æ—¶æ›´æ–°ç”¨æˆ·åˆ†æ•°
- [x] Top NæŸ¥è¯¢ï¼šè·å–å‰Nåç”¨æˆ·
- [x] æ’åæŸ¥è¯¢ï¼šæŸ¥è¯¢æŒ‡å®šç”¨æˆ·æ’å
- [x] å‘¨å›´æ’åï¼šæŸ¥è¯¢ç”¨æˆ·å‰åNå
- [x] å¤šç»´åº¦ï¼šæ—¥æ¦œã€å‘¨æ¦œã€æœˆæ¦œã€æ€»æ¦œ

### éåŠŸèƒ½éœ€æ±‚

- **å®æ—¶æ€§**ï¼šåˆ†æ•°æ›´æ–°åç«‹å³ç”Ÿæ•ˆ
- **æ€§èƒ½**ï¼šæŸ¥è¯¢å»¶è¿Ÿ<10ms
- **è§„æ¨¡**ï¼šæ”¯æŒåƒä¸‡çº§ç”¨æˆ·

---

## äºŒã€æ ¸å¿ƒè®¾è®¡

### 2.1 Redis ZSetæ–¹æ¡ˆ

```java
/**
 * åŸºäºRedis ZSetçš„æ’è¡Œæ¦œ
 */
@Service
public class LeaderboardService {
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    /**
     * æ›´æ–°åˆ†æ•°
     */
    public void updateScore(String boardKey, Long userId, double score) {
        redisTemplate.opsForZSet().add(boardKey, userId.toString(), score);
    }
    
    /**
     * å¢åŠ åˆ†æ•°
     */
    public Double incrementScore(String boardKey, Long userId, double delta) {
        return redisTemplate.opsForZSet().incrementScore(boardKey, userId.toString(), delta);
    }
    
    /**
     * è·å–Top N
     */
    public List<RankInfo> getTopN(String boardKey, int n) {
        Set<ZSetOperations.TypedTuple<String>> tuples = redisTemplate.opsForZSet()
            .reverseRangeWithScores(boardKey, 0, n - 1);
        
        List<RankInfo> result = new ArrayList<>();
        int rank = 1;
        for (ZSetOperations.TypedTuple<String> tuple : tuples) {
            RankInfo info = new RankInfo();
            info.setUserId(Long.parseLong(tuple.getValue()));
            info.setScore(tuple.getScore());
            info.setRank(rank++);
            result.add(info);
        }
        return result;
    }
    
    /**
     * è·å–ç”¨æˆ·æ’åï¼ˆä»0å¼€å§‹ï¼‰
     */
    public Long getUserRank(String boardKey, Long userId) {
        Long rank = redisTemplate.opsForZSet().reverseRank(boardKey, userId.toString());
        return rank != null ? rank + 1 : null;
    }
    
    /**
     * è·å–ç”¨æˆ·åˆ†æ•°
     */
    public Double getUserScore(String boardKey, Long userId) {
        return redisTemplate.opsForZSet().score(boardKey, userId.toString());
    }
    
    /**
     * è·å–ç”¨æˆ·å‘¨å›´æ’å
     */
    public List<RankInfo> getAroundRank(String boardKey, Long userId, int range) {
        Long rank = redisTemplate.opsForZSet().reverseRank(boardKey, userId.toString());
        if (rank == null) {
            return Collections.emptyList();
        }
        
        long start = Math.max(0, rank - range);
        long end = rank + range;
        
        Set<ZSetOperations.TypedTuple<String>> tuples = redisTemplate.opsForZSet()
            .reverseRangeWithScores(boardKey, start, end);
        
        List<RankInfo> result = new ArrayList<>();
        int currentRank = (int) start + 1;
        for (ZSetOperations.TypedTuple<String> tuple : tuples) {
            RankInfo info = new RankInfo();
            info.setUserId(Long.parseLong(tuple.getValue()));
            info.setScore(tuple.getScore());
            info.setRank(currentRank++);
            result.add(info);
        }
        return result;
    }
}
```

### 2.2 å¤šç»´åº¦æ’è¡Œæ¦œ

```java
/**
 * å¤šç»´åº¦æ’è¡Œæ¦œç®¡ç†
 */
@Service
public class MultiDimensionLeaderboard {
    
    @Autowired
    private LeaderboardService leaderboardService;
    
    /**
     * æ›´æ–°åˆ†æ•°ï¼ˆåŒæ—¶æ›´æ–°å¤šä¸ªæ¦œå•ï¼‰
     */
    public void updateScore(Long userId, double score) {
        String today = LocalDate.now().format(DateTimeFormatter.BASIC_ISO_DATE);
        String week = getWeekKey();
        String month = LocalDate.now().format(DateTimeFormatter.ofPattern("yyyyMM"));
        
        // æ›´æ–°æ—¥æ¦œ
        leaderboardService.updateScore("leaderboard:day:" + today, userId, score);
        // æ›´æ–°å‘¨æ¦œ
        leaderboardService.updateScore("leaderboard:week:" + week, userId, score);
        // æ›´æ–°æœˆæ¦œ
        leaderboardService.updateScore("leaderboard:month:" + month, userId, score);
        // æ›´æ–°æ€»æ¦œ
        leaderboardService.updateScore("leaderboard:total", userId, score);
    }
    
    /**
     * å¢åŠ åˆ†æ•°
     */
    public void incrementScore(Long userId, double delta) {
        String today = LocalDate.now().format(DateTimeFormatter.BASIC_ISO_DATE);
        String week = getWeekKey();
        String month = LocalDate.now().format(DateTimeFormatter.ofPattern("yyyyMM"));
        
        leaderboardService.incrementScore("leaderboard:day:" + today, userId, delta);
        leaderboardService.incrementScore("leaderboard:week:" + week, userId, delta);
        leaderboardService.incrementScore("leaderboard:month:" + month, userId, delta);
        leaderboardService.incrementScore("leaderboard:total", userId, delta);
    }
    
    /**
     * è·å–æ—¥æ¦œTop N
     */
    public List<RankInfo> getDailyTopN(int n) {
        String today = LocalDate.now().format(DateTimeFormatter.BASIC_ISO_DATE);
        return leaderboardService.getTopN("leaderboard:day:" + today, n);
    }
    
    /**
     * å®šæ—¶æ¸…ç†è¿‡æœŸæ¦œå•
     */
    @Scheduled(cron = "0 0 0 * * ?")
    public void cleanExpiredBoards() {
        // æ¸…ç†7å¤©å‰çš„æ—¥æ¦œ
        String expiredDay = LocalDate.now().minusDays(7)
            .format(DateTimeFormatter.BASIC_ISO_DATE);
        redisTemplate.delete("leaderboard:day:" + expiredDay);
    }
    
    private String getWeekKey() {
        LocalDate now = LocalDate.now();
        int week = now.get(WeekFields.ISO.weekOfWeekBasedYear());
        return now.getYear() + "W" + String.format("%02d", week);
    }
}
```

---

## ä¸‰ã€å¤§è§„æ¨¡ä¼˜åŒ–

### 3.1 åˆ†ç‰‡æ–¹æ¡ˆ

```java
/**
 * åˆ†ç‰‡æ’è¡Œæ¦œï¼ˆæ”¯æŒäº¿çº§ç”¨æˆ·ï¼‰
 */
@Service
public class ShardedLeaderboard {
    
    private static final int SHARD_COUNT = 100;
    
    /**
     * æ›´æ–°åˆ†æ•°
     */
    public void updateScore(Long userId, double score) {
        int shard = (int) (userId % SHARD_COUNT);
        String shardKey = "leaderboard:shard:" + shard;
        redisTemplate.opsForZSet().add(shardKey, userId.toString(), score);
    }
    
    /**
     * è·å–å…¨å±€Top Nï¼ˆåˆå¹¶å„åˆ†ç‰‡ï¼‰
     */
    public List<RankInfo> getGlobalTopN(int n) {
        // ä½¿ç”¨ä¼˜å…ˆé˜Ÿåˆ—åˆå¹¶
        PriorityQueue<RankInfo> heap = new PriorityQueue<>(
            Comparator.comparingDouble(RankInfo::getScore)
        );
        
        for (int i = 0; i < SHARD_COUNT; i++) {
            String shardKey = "leaderboard:shard:" + i;
            Set<ZSetOperations.TypedTuple<String>> tuples = redisTemplate.opsForZSet()
                .reverseRangeWithScores(shardKey, 0, n - 1);
            
            for (ZSetOperations.TypedTuple<String> tuple : tuples) {
                RankInfo info = new RankInfo();
                info.setUserId(Long.parseLong(tuple.getValue()));
                info.setScore(tuple.getScore());
                
                if (heap.size() < n) {
                    heap.offer(info);
                } else if (info.getScore() > heap.peek().getScore()) {
                    heap.poll();
                    heap.offer(info);
                }
            }
        }
        
        // è½¬æ¢ä¸ºåˆ—è¡¨å¹¶æ’åº
        List<RankInfo> result = new ArrayList<>(heap);
        result.sort((a, b) -> Double.compare(b.getScore(), a.getScore()));
        
        // è®¾ç½®æ’å
        for (int i = 0; i < result.size(); i++) {
            result.get(i).setRank(i + 1);
        }
        
        return result;
    }
}
```

---

## å››ã€é¢è¯•è¦ç‚¹

### å¸¸è§é—®é¢˜

**Q1: ä¸ºä»€ä¹ˆç”¨Redis ZSetï¼Ÿ**
```
1. O(logN)çš„æ’å…¥å’ŒæŸ¥è¯¢å¤æ‚åº¦
2. è‡ªåŠ¨æŒ‰åˆ†æ•°æ’åº
3. æ”¯æŒèŒƒå›´æŸ¥è¯¢
4. å†…å­˜æ•ˆç‡é«˜
```

**Q2: å¦‚ä½•å¤„ç†åˆ†æ•°ç›¸åŒçš„æƒ…å†µï¼Ÿ**
```
1. ä½¿ç”¨å¤åˆåˆ†æ•°ï¼šscore = ä¸»åˆ†æ•° * 10^10 + (MAX_TIME - æ—¶é—´æˆ³)
2. åˆ†æ•°ç›¸åŒæ—¶ï¼Œå…ˆè¾¾åˆ°çš„æ’åé å‰
```

**Q3: å¦‚ä½•æ”¯æŒäº¿çº§ç”¨æˆ·ï¼Ÿ**
```
1. åˆ†ç‰‡å­˜å‚¨ï¼šæŒ‰ç”¨æˆ·IDåˆ†ç‰‡
2. å®šæœŸèšåˆï¼šå¼‚æ­¥è®¡ç®—å…¨å±€æ’å
3. è¿‘ä¼¼æ’åï¼šåªä¿è¯Top Nç²¾ç¡®
```

---

## ğŸ“š æ‰©å±•é˜…è¯»

1. [Redisæ’è¡Œæ¦œæœ€ä½³å®è·µ](https://redis.io/docs/manual/patterns/leaderboard/)
2. [æ¸¸æˆæ’è¡Œæ¦œè®¾è®¡](https://www.infoq.cn/article/game-leaderboard-design)
