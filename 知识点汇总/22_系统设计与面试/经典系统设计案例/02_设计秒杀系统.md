# è®¾è®¡ç§’æ€ç³»ç»Ÿ

> é«˜é¢‘é¢è¯•é¢˜ï¼šå¦‚ä½•è®¾è®¡ä¸€ä¸ªæ”¯æŒåƒä¸‡çº§å¹¶å‘çš„ç§’æ€ç³»ç»Ÿ

## ğŸ“‹ é¢è¯•é¢˜ç›®

```
è®¾è®¡ä¸€ä¸ªç”µå•†ç§’æ€ç³»ç»Ÿï¼Œåœ¨æŒ‡å®šæ—¶é—´å¼€æŠ¢ï¼Œåº“å­˜æœ‰é™ï¼ˆå¦‚100ä¸ªå•†å“ï¼‰ï¼Œ
å¯èƒ½æœ‰100ä¸‡ç”¨æˆ·åŒæ—¶æŠ¢è´­ã€‚

è¦æ±‚ï¼š
1. é«˜å¹¶å‘ï¼šæ”¯æŒç™¾ä¸‡çº§QPS
2. é˜²è¶…å–ï¼šåº“å­˜æ‰£å‡å‡†ç¡®
3. é˜²ä½œå¼Šï¼šé˜²åˆ·å•ã€é˜²é»„ç‰›
4. ç”¨æˆ·ä½“éªŒï¼šå¿«é€Ÿå“åº”
5. é«˜å¯ç”¨ï¼šä¸èƒ½å®•æœº
```

---

## ä¸€ã€éœ€æ±‚æ¾„æ¸…

### æ ¸å¿ƒæŒ‘æˆ˜

**ç§’æ€ç‰¹ç‚¹**ï¼š
```
1. ç¬æ—¶é«˜å¹¶å‘ï¼š
   - æ­£å¸¸ï¼š1000 QPS
   - ç§’æ€ï¼š100,000 QPSï¼ˆ100å€ï¼‰
   - æŒç»­æ—¶é—´ï¼šå‡ ç§’åˆ°å‡ åˆ†é’Ÿ

2. è¯»å¤šå†™å°‘ï¼š
   - è¯»ï¼ˆæŸ¥è¯¢åº“å­˜ï¼‰ï¼š99%
   - å†™ï¼ˆä¸‹å•ï¼‰ï¼š1%
   - åªæœ‰æå°‘æ•°äººèƒ½æŠ¢åˆ°

3. åº“å­˜æœ‰é™ï¼š
   - å•†å“ï¼š100ä¸ª
   - ç”¨æˆ·ï¼š100ä¸‡äºº
   - æˆåŠŸç‡ï¼š0.01%
```

### åŠŸèƒ½éœ€æ±‚

- [x] ç§’æ€å•†å“å±•ç¤º
- [x] ç§’æ€å€’è®¡æ—¶
- [x] ç§’æ€ä¸‹å•
- [x] åº“å­˜æ‰£å‡ï¼ˆé˜²è¶…å–ï¼‰
- [x] è®¢å•åˆ›å»º
- [x] æ”¯ä»˜æµç¨‹
- [x] é˜²åˆ·æœºåˆ¶

### éåŠŸèƒ½éœ€æ±‚

- QPSï¼šå³°å€¼10ä¸‡+
- RTï¼šP99 < 200ms
- å¯ç”¨æ€§ï¼š99.99%
- å‡†ç¡®æ€§ï¼šä¸è¶…å–ã€ä¸å°‘å–

---

## äºŒã€æ¶æ„è®¾è®¡

### 2.1 æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ç”¨æˆ·å±‚ï¼ˆå‰ç«¯ï¼‰                â”‚
â”‚  - é¡µé¢é™æ€åŒ–                           â”‚
â”‚  - ç­”é¢˜éªŒè¯ç                            â”‚
â”‚  - æŒ‰é’®å€’è®¡æ—¶                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           CDNå±‚                         â”‚
â”‚  - é™æ€èµ„æºç¼“å­˜                         â”‚
â”‚  - å°±è¿‘è®¿é—®                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           æ¥å…¥å±‚                        â”‚
â”‚  - Nginxé™æµ                            â”‚
â”‚  - IPé»‘åå•                             â”‚
â”‚  - æŒ‰ç”¨æˆ·é™æµ                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           åº”ç”¨å±‚                        â”‚
â”‚  - ç§’æ€æœåŠ¡é›†ç¾¤ï¼ˆæ— çŠ¶æ€ï¼‰               â”‚
â”‚  - Redisé¢„å‡åº“å­˜                        â”‚
â”‚  - æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥ä¸‹å•                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           æ•°æ®å±‚                        â”‚
â”‚  - Redisï¼ˆåº“å­˜ï¼‰                        â”‚
â”‚  - MySQLï¼ˆè®¢å•ï¼‰                        â”‚
â”‚  - Kafkaï¼ˆæ¶ˆæ¯é˜Ÿåˆ—ï¼‰                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ ¸å¿ƒæµç¨‹

```
ç§’æ€å¼€å§‹å‰ï¼ˆé¢„çƒ­ï¼‰ï¼š
  1. å°†åº“å­˜åŠ è½½åˆ°Redis
  2. CDNé¢„çƒ­é™æ€èµ„æº
  3. æ•°æ®åº“é¢„çƒ­ï¼ˆé¢„åŠ è½½ï¼‰

ç§’æ€è¿›è¡Œä¸­ï¼š
  1. ç”¨æˆ·ç‚¹å‡»"ç«‹å³æŠ¢è´­"
  2. å‰ç«¯éªŒè¯ç éªŒè¯
  3. Nginxé™æµï¼ˆIP + ç”¨æˆ·ï¼‰
  4. åº”ç”¨å±‚Redisé¢„å‡åº“å­˜
  5. é€šè¿‡ â†’ å‘é€MQæ¶ˆæ¯
  6. æ¶ˆè´¹è€…å¼‚æ­¥åˆ›å»ºè®¢å•
  7. æ•°æ®åº“æ‰£å‡åº“å­˜ï¼ˆä¹è§‚é”ï¼‰
  8. è¿”å›æŠ¢è´­ç»“æœ

ç§’æ€ç»“æŸåï¼š
  1. æ¸…ç†Redisæ•°æ®
  2. ç»Ÿè®¡åˆ†æ
  3. å¤„ç†æœªæ”¯ä»˜è®¢å•
```

---

## ä¸‰ã€è¯¦ç»†è®¾è®¡

### 3.1 å‰ç«¯ä¼˜åŒ–

**é¡µé¢é™æ€åŒ–**ï¼š
```html
<!-- âŒ åŠ¨æ€é¡µé¢ï¼šæ¯æ¬¡è¯·æ±‚éƒ½è¦æŸ¥æ•°æ®åº“ -->
<div>å‰©ä½™åº“å­˜ï¼š${stock}</div>
<div>å½“å‰ä»·æ ¼ï¼š${price}</div>

<!-- âœ… é™æ€é¡µé¢ï¼šåªåœ¨ç§’æ€å¼€å§‹æ—¶ajaxè·å– -->
<!DOCTYPE html>
<html>
<head><title>iPhone 15 Proç§’æ€</title></head>
<body>
  <h1>iPhone 15 Proç§’æ€</h1>
  <img src="/static/iphone15.jpg">  <!-- CDNç¼“å­˜ -->
  <p>ä»·æ ¼ï¼š<span>Â¥7999</span></p>
  <p>å‰©ä½™ï¼š<span id="stock">--</span></p>
  <button id="buyBtn" disabled>è·ç¦»å¼€å§‹ï¼š<span id="countdown"></span></button>
  
  <script>
    // å€’è®¡æ—¶
    let endTime = new Date('2025-10-29 20:00:00').getTime();
    setInterval(() => {
      let now = new Date().getTime();
      let diff = endTime - now;
      if (diff <= 0) {
        document.getElementById('buyBtn').disabled = false;
        document.getElementById('buyBtn').innerText = 'ç«‹å³æŠ¢è´­';
      } else {
        let sec = Math.floor(diff / 1000);
        document.getElementById('countdown').innerText = sec + 'ç§’';
      }
    }, 1000);
  </script>
</body>
</html>
```

**ç­”é¢˜éªŒè¯ç ï¼ˆé˜²æœºå™¨äººï¼‰**ï¼š
```javascript
// ç§’æ€å¼€å§‹å‰å¼¹å‡ºéªŒè¯ç 
function showCaptcha() {
  // 1. æ•°å­¦é¢˜éªŒè¯ç 
  let a = Math.floor(Math.random() * 10);
  let b = Math.floor(Math.random() * 10);
  let answer = prompt(`è¯·è®¡ç®—ï¼š${a} + ${b} = ?`);
  if (parseInt(answer) !== a + b) {
    alert('éªŒè¯å¤±è´¥');
    return false;
  }
  
  // 2. è·å–éªŒè¯token
  return fetch('/api/captcha/verify', {
    method: 'POST',
    body: JSON.stringify({ answer: answer })
  }).then(res => res.json())
    .then(data => data.token);
}

document.getElementById('buyBtn').onclick = async () => {
  // å…ˆéªŒè¯ç ï¼Œå†è¯·æ±‚ç§’æ€æ¥å£
  let token = await showCaptcha();
  if (!token) return;
  
  fetch('/api/seckill/buy', {
    method: 'POST',
    headers: { 'X-Captcha-Token': token },
    body: JSON.stringify({ product_id: 123 })
  });
};
```

**é˜²é‡å¤æäº¤**ï¼š
```javascript
let clicking = false;

document.getElementById('buyBtn').onclick = () => {
  if (clicking) {
    alert('è¯·å‹¿é‡å¤ç‚¹å‡»');
    return;
  }
  
  clicking = true;
  document.getElementById('buyBtn').disabled = true;
  
  fetch('/api/seckill/buy', { method: 'POST' })
    .then(res => {
      clicking = false;
      document.getElementById('buyBtn').disabled = false;
    });
};
```

### 3.2 æ¥å…¥å±‚é™æµ

**Nginxé™æµé…ç½®**ï¼š
```nginx
http {
    # 1. IPé™æµï¼šå•IPæ¯ç§’10æ¬¡è¯·æ±‚
    limit_req_zone $binary_remote_addr zone=ip_limit:10m rate=10r/s;
    
    # 2. ç”¨æˆ·é™æµï¼šå•ç”¨æˆ·æ¯ç§’5æ¬¡è¯·æ±‚
    limit_req_zone $cookie_user_id zone=user_limit:10m rate=5r/s;
    
    server {
        listen 80;
        
        location /api/seckill/ {
            # åº”ç”¨é™æµè§„åˆ™
            limit_req zone=ip_limit burst=20 nodelay;
            limit_req zone=user_limit burst=10 nodelay;
            
            # é™æµåè¿”å›503
            limit_req_status 503;
            
            proxy_pass http://backend;
        }
    }
}
```

**OpenRestyåŠ¨æ€é™æµï¼ˆæ›´çµæ´»ï¼‰**ï¼š
```lua
-- openresty/lua/rate_limit.lua
local redis = require "resty.redis"
local red = redis:new()
red:connect("127.0.0.1", 6379)

-- è·å–ç”¨æˆ·ID
local user_id = ngx.var.cookie_user_id or ngx.var.remote_addr

-- é™æµkey
local key = "rate_limit:" .. user_id
local limit = 10  -- æ¯ç§’10æ¬¡

-- Luaè„šæœ¬åŸå­æ“ä½œ
local count = red:incr(key)
if count == 1 then
    red:expire(key, 1)  -- 1ç§’è¿‡æœŸ
end

if count > limit then
    ngx.status = 429  -- Too Many Requests
    ngx.say('{"code": 429, "message": "è¯·æ±‚è¿‡äºé¢‘ç¹"}')
    ngx.exit(429)
end
```

### 3.3 Redisé¢„å‡åº“å­˜

**æ ¸å¿ƒæ€æƒ³**ï¼š
```
ä¸ºä»€ä¹ˆç”¨Redisé¢„å‡åº“å­˜ï¼Ÿ

é—®é¢˜ï¼š100ä¸ªå•†å“ï¼Œ100ä¸‡äººæŠ¢
  - å¦‚æœéƒ½è¿›æ•°æ®åº“ â†’ æ•°æ®åº“æ‰¿å—ä¸ä½
  - å¤§é‡è¯·æ±‚éƒ½ä¼šå¤±è´¥ï¼ˆåªæœ‰100ä¸ªæˆåŠŸï¼‰

æ–¹æ¡ˆï¼šRedisé¢„å‡åº“å­˜
  - 100ä¸‡è¯·æ±‚ â†’ Rediså¿«é€Ÿæ‹’ç»99.99ä¸‡
  - åªæœ‰100ä¸ªè¯·æ±‚è¿›å…¥ä¸‹å•æµç¨‹
  - æ•°æ®åº“å‹åŠ›é™ä½99.99% âœ…
```

**Redisåº“å­˜ç»“æ„**ï¼š
```
key: seckill:stock:123  (å•†å“ID)
value: 100              (å‰©ä½™åº“å­˜)

æ“ä½œï¼š
  DECR seckill:stock:123  # åŸå­é€’å‡
  å¦‚æœè¿”å›å€¼ >= 0 â†’ æœ‰åº“å­˜ï¼Œå¯ä»¥ä¸‹å•
  å¦‚æœè¿”å›å€¼ < 0  â†’ æ²¡åº“å­˜ï¼Œæ‹’ç»
```

**Javaä»£ç å®ç°**ï¼š
```java
@Service
public class SeckillService {
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    @Autowired
    private KafkaTemplate<String, String> kafkaTemplate;
    
    /**
     * ç§’æ€æ¥å£
     */
    public SeckillResult seckill(Long productId, Long userId) {
        // 1. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç»æŠ¢è¿‡ï¼ˆé˜²é‡å¤ï¼‰
        String userKey = "seckill:user:" + productId + ":" + userId;
        Boolean hasOrdered = redisTemplate.hasKey(userKey);
        if (Boolean.TRUE.equals(hasOrdered)) {
            return SeckillResult.fail("æ‚¨å·²ç»æŠ¢è¿‡äº†");
        }
        
        // 2. Redisé¢„å‡åº“å­˜ï¼ˆæ ¸å¿ƒï¼‰
        String stockKey = "seckill:stock:" + productId;
        Long stock = redisTemplate.opsForValue().decrement(stockKey);
        
        if (stock == null || stock < 0) {
            // æ²¡åº“å­˜äº†ï¼Œæ¢å¤åº“å­˜è®¡æ•°
            if (stock != null && stock < 0) {
                redisTemplate.opsForValue().increment(stockKey);
            }
            return SeckillResult.fail("å•†å“å·²æŠ¢å…‰");
        }
        
        // 3. åº“å­˜è¶³å¤Ÿï¼Œæ ‡è®°ç”¨æˆ·å·²æŠ¢è´­
        redisTemplate.opsForValue().set(userKey, "1", 10, TimeUnit.MINUTES);
        
        // 4. å‘é€æ¶ˆæ¯åˆ°MQï¼Œå¼‚æ­¥åˆ›å»ºè®¢å•
        SeckillMessage msg = new SeckillMessage(productId, userId);
        kafkaTemplate.send("seckill_order", JSON.toJSONString(msg));
        
        // 5. ç«‹å³è¿”å›ï¼ˆç”¨æˆ·ä½“éªŒå¥½ï¼‰
        return SeckillResult.success("æŠ¢è´­æˆåŠŸï¼Œæ­£åœ¨ç”Ÿæˆè®¢å•...");
    }
}
```

**Luaè„šæœ¬ä¼˜åŒ–ï¼ˆåŸå­æ€§æ›´å¥½ï¼‰**ï¼š
```java
/**
 * ä½¿ç”¨Luaè„šæœ¬ä¿è¯åŸå­æ€§
 */
public SeckillResult seckillWithLua(Long productId, Long userId) {
    String luaScript = 
        "local stock_key = KEYS[1] " +
        "local user_key = KEYS[2] " +
        "if redis.call('exists', user_key) == 1 then " +
        "    return -2  -- å·²ç»æŠ¢è¿‡ " +
        "end " +
        "local stock = tonumber(redis.call('get', stock_key) or '0') " +
        "if stock <= 0 then " +
        "    return -1  -- æ²¡åº“å­˜ " +
        "end " +
        "redis.call('decr', stock_key) " +
        "redis.call('setex', user_key, 600, '1') " +
        "return stock - 1  -- è¿”å›å‰©ä½™åº“å­˜ ";
    
    String stockKey = "seckill:stock:" + productId;
    String userKey = "seckill:user:" + productId + ":" + userId;
    
    DefaultRedisScript<Long> script = new DefaultRedisScript<>();
    script.setScriptText(luaScript);
    script.setResultType(Long.class);
    
    Long result = redisTemplate.execute(
        script, 
        Arrays.asList(stockKey, userKey)
    );
    
    if (result == null) {
        return SeckillResult.fail("ç³»ç»Ÿç¹å¿™");
    } else if (result == -2) {
        return SeckillResult.fail("æ‚¨å·²ç»æŠ¢è¿‡äº†");
    } else if (result == -1) {
        return SeckillResult.fail("å•†å“å·²æŠ¢å…‰");
    }
    
    // å‘é€MQæ¶ˆæ¯
    SeckillMessage msg = new SeckillMessage(productId, userId);
    kafkaTemplate.send("seckill_order", JSON.toJSONString(msg));
    
    return SeckillResult.success("æŠ¢è´­æˆåŠŸ");
}
```

### 3.4 å¼‚æ­¥ä¸‹å•ï¼ˆæ¶ˆæ¯é˜Ÿåˆ—ï¼‰

**ä¸ºä»€ä¹ˆå¼‚æ­¥**ï¼š
```
åŒæ­¥ä¸‹å•é—®é¢˜ï¼š
  æŠ¢è´­è¯·æ±‚ â†’ åº“å­˜æ‰£å‡ â†’ åˆ›å»ºè®¢å• â†’ è¿”å›ç»“æœ
            â†“ 50ms     â†“ 100ms
  æ€»è€—æ—¶ï¼š150msï¼Œç”¨æˆ·ç­‰å¾…æ—¶é—´é•¿

å¼‚æ­¥ä¸‹å•ä¼˜åŠ¿ï¼š
  æŠ¢è´­è¯·æ±‚ â†’ åº“å­˜æ‰£å‡ â†’ è¿”å›"æŠ¢è´­æˆåŠŸ" (50ms)
            â†“
            MQ â†’ å¼‚æ­¥åˆ›å»ºè®¢å•
            
  ç”¨æˆ·ä½“éªŒï¼š50msè¿”å› âœ…
  ç³»ç»Ÿå‹åŠ›ï¼šMQå‰Šå³° âœ…
```

**Kafkaæ¶ˆè´¹è€…**ï¼š
```java
@Component
public class SeckillOrderConsumer {
    @Autowired
    private OrderService orderService;
    
    @Autowired
    private ProductService productService;
    
    @KafkaListener(topics = "seckill_order", concurrency = "10")
    public void handleSeckillOrder(String message) {
        try {
            SeckillMessage msg = JSON.parseObject(message, SeckillMessage.class);
            
            // 1. å†æ¬¡æ ¡éªŒåº“å­˜ï¼ˆé˜²æ­¢Rediså’ŒDBä¸ä¸€è‡´ï¼‰
            Product product = productService.getById(msg.getProductId());
            if (product.getStock() <= 0) {
                log.warn("åº“å­˜ä¸è¶³ï¼Œè®¢å•åˆ›å»ºå¤±è´¥");
                return;
            }
            
            // 2. åˆ›å»ºè®¢å•
            Order order = new Order();
            order.setProductId(msg.getProductId());
            order.setUserId(msg.getUserId());
            order.setPrice(product.getSeckillPrice());
            order.setStatus(OrderStatus.UNPAID);
            order.setCreateTime(LocalDateTime.now());
            
            // 3. æ‰£å‡æ•°æ®åº“åº“å­˜ï¼ˆä¹è§‚é”ï¼‰
            boolean success = productService.decrementStock(
                msg.getProductId(), 
                product.getStock()
            );
            
            if (!success) {
                log.warn("åº“å­˜æ‰£å‡å¤±è´¥ï¼ˆä¹è§‚é”å†²çªï¼‰");
                return;
            }
            
            // 4. ä¿å­˜è®¢å•
            orderService.save(order);
            
            // 5. å‘é€æ”¯ä»˜é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
            sendPaymentNotification(order);
            
        } catch (Exception e) {
            log.error("å¤„ç†ç§’æ€è®¢å•å¤±è´¥", e);
            // é‡è¯•æœºåˆ¶ç”±Kafkaä¿è¯
        }
    }
}
```

### 3.5 æ•°æ®åº“é˜²è¶…å–

**ä¹è§‚é”æ–¹æ¡ˆï¼ˆæ¨èï¼‰**ï¼š
```sql
-- å•†å“è¡¨
CREATE TABLE product (
    id BIGINT PRIMARY KEY,
    name VARCHAR(100),
    stock INT NOT NULL,          -- åº“å­˜
    version INT NOT NULL,         -- ç‰ˆæœ¬å·ï¼ˆä¹è§‚é”ï¼‰
    seckill_price DECIMAL(10,2),
    INDEX idx_id_version (id, version)
);

-- æ‰£å‡åº“å­˜SQLï¼ˆå¸¦ç‰ˆæœ¬å·ï¼‰
UPDATE product 
SET stock = stock - 1, 
    version = version + 1 
WHERE id = #{productId} 
  AND version = #{version}  -- ä¹è§‚é”ï¼šç‰ˆæœ¬å·å¿…é¡»åŒ¹é…
  AND stock > 0;

-- å¦‚æœæ›´æ–°è¡Œæ•° = 0ï¼Œè¯´æ˜å†²çªï¼Œé‡è¯•
```

**Javaå®ç°**ï¼š
```java
@Service
public class ProductService {
    @Autowired
    private ProductMapper productMapper;
    
    /**
     * æ‰£å‡åº“å­˜ï¼ˆä¹è§‚é”ï¼Œå¸¦é‡è¯•ï¼‰
     */
    public boolean decrementStock(Long productId, int currentVersion) {
        int retryCount = 0;
        int maxRetry = 3;
        
        while (retryCount < maxRetry) {
            // å°è¯•æ›´æ–°
            int affected = productMapper.decrementStockWithVersion(
                productId, 
                currentVersion
            );
            
            if (affected > 0) {
                return true;  // æˆåŠŸ
            }
            
            // å¤±è´¥ï¼Œå¯èƒ½æ˜¯ç‰ˆæœ¬å†²çªï¼Œé‡æ–°æŸ¥è¯¢ç‰ˆæœ¬å·
            Product product = productMapper.selectById(productId);
            if (product == null || product.getStock() <= 0) {
                return false;  // çœŸçš„æ²¡åº“å­˜äº†
            }
            
            currentVersion = product.getVersion();
            retryCount++;
        }
        
        return false;  // é‡è¯•å¤šæ¬¡å¤±è´¥
    }
}
```

**æ‚²è§‚é”æ–¹æ¡ˆï¼ˆä¸æ¨èï¼‰**ï¼š
```sql
-- ä½¿ç”¨FOR UPDATEè¡Œé”
BEGIN;
SELECT stock FROM product WHERE id = 123 FOR UPDATE;  -- é”ä½è¿™ä¸€è¡Œ
UPDATE product SET stock = stock - 1 WHERE id = 123 AND stock > 0;
COMMIT;

-- ç¼ºç‚¹ï¼šå¹¶å‘æ€§èƒ½å·®ï¼Œå®¹æ˜“æ­»é”
```

### 3.6 é˜²åˆ·æœºåˆ¶

**1. æ¥å£ç­¾å**ï¼š
```java
/**
 * ç”Ÿæˆæ¥å£ç­¾åï¼ˆé˜²ç¯¡æ”¹ï¼‰
 */
public String generateSign(Long userId, Long productId, long timestamp) {
    String data = userId + "_" + productId + "_" + timestamp;
    String secret = "my_secret_key";
    return DigestUtils.md5Hex(data + secret);
}

/**
 * éªŒè¯ç­¾å
 */
public boolean verifySign(SeckillRequest req) {
    String expectedSign = generateSign(
        req.getUserId(), 
        req.getProductId(), 
        req.getTimestamp()
    );
    
    // ç­¾åä¸åŒ¹é…
    if (!expectedSign.equals(req.getSign())) {
        return false;
    }
    
    // æ—¶é—´æˆ³è¿‡æœŸï¼ˆ5åˆ†é’Ÿï¼‰
    long now = System.currentTimeMillis();
    if (now - req.getTimestamp() > 5 * 60 * 1000) {
        return false;
    }
    
    return true;
}
```

**2. IPé»‘åå•**ï¼š
```java
@Component
public class IPBlacklistFilter implements Filter {
    @Autowired
    private RedisTemplate redisTemplate;
    
    @Override
    public void doFilter(ServletRequest request, ServletResponse response, 
                         FilterChain chain) {
        String ip = getClientIP(request);
        
        // æ£€æŸ¥é»‘åå•
        Boolean isBlocked = redisTemplate.opsForSet()
            .isMember("ip_blacklist", ip);
        
        if (Boolean.TRUE.equals(isBlocked)) {
            response.getWriter().write("æ‚¨çš„IPå·²è¢«å°ç¦");
            return;
        }
        
        // æ£€æŸ¥é¢‘ç‡ï¼ˆ1ç§’å†…è¶…è¿‡100æ¬¡ â†’ æ‹‰é»‘ï¼‰
        String key = "ip_count:" + ip;
        Long count = redisTemplate.opsForValue().increment(key);
        if (count == 1) {
            redisTemplate.expire(key, 1, TimeUnit.SECONDS);
        }
        
        if (count > 100) {
            redisTemplate.opsForSet().add("ip_blacklist", ip);
            response.getWriter().write("è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œå·²å°ç¦");
            return;
        }
        
        chain.doFilter(request, response);
    }
}
```

**3. ç”¨æˆ·è¡Œä¸ºåˆ†æ**ï¼š
```java
/**
 * æ£€æµ‹å¼‚å¸¸è¡Œä¸º
 */
public boolean isAbnormalBehavior(Long userId) {
    String key = "user_behavior:" + userId;
    
    // è®°å½•ç”¨æˆ·è¡Œä¸º
    redisTemplate.opsForList().rightPush(key, 
        System.currentTimeMillis() + "");
    redisTemplate.expire(key, 60, TimeUnit.SECONDS);
    
    // 1åˆ†é’Ÿå†…è¯·æ±‚è¶…è¿‡50æ¬¡ â†’ å¼‚å¸¸
    Long size = redisTemplate.opsForList().size(key);
    return size != null && size > 50;
}
```

---

## å››ã€å®¹é‡è§„åˆ’

### 4.1 QPSä¼°ç®—

```
å‡è®¾åœºæ™¯ï¼š
  - ç§’æ€å•†å“ï¼š100ä¸ª
  - å‚ä¸ç”¨æˆ·ï¼š100ä¸‡äºº
  - ç§’æ€æ—¶é•¿ï¼š10ç§’

å³°å€¼QPS = 100ä¸‡ / 10ç§’ = 10ä¸‡ QPS

è€ƒè™‘é‡è¯•å’ŒæŸ¥è¯¢ï¼š
  å®é™…å³°å€¼QPS â‰ˆ 20ä¸‡ QPS
```

### 4.2 æœåŠ¡å™¨é…ç½®

```
åº”ç”¨æœåŠ¡å™¨ï¼š
  - è§„æ ¼ï¼š8æ ¸16G
  - å•æœºQPSï¼š5000
  - éœ€è¦æ•°é‡ï¼š20ä¸‡ / 5000 = 40å°
  - å†—ä½™1.5å€ï¼š60å°

RedisæœåŠ¡å™¨ï¼š
  - è§„æ ¼ï¼š16æ ¸32G
  - å•æœºQPSï¼š10ä¸‡
  - éœ€è¦æ•°é‡ï¼š20ä¸‡ / 10ä¸‡ = 2å°
  - ä¸»ä»æ¶æ„ï¼š2ä¸» + 4ä»

æ•°æ®åº“ï¼š
  - ä¸»åº“ï¼š16æ ¸64G SSD
  - ä»åº“ï¼š3å°ï¼ˆè¯»å†™åˆ†ç¦»ï¼‰
```

---

## äº”ã€å¸¸è§è¿½é—®

### Q1: Redisåº“å­˜å’ŒDBåº“å­˜ä¸ä¸€è‡´æ€ä¹ˆåŠï¼Ÿ

**å›ç­”**ï¼š
```
åŸå› ï¼š
  - Redisæ‰£å‡æˆåŠŸï¼Œä½†MQæ¶ˆæ¯ä¸¢å¤±
  - Redisæ‰£å‡æˆåŠŸï¼Œä½†è®¢å•åˆ›å»ºå¤±è´¥

è§£å†³æ–¹æ¡ˆï¼š

1. æœ€ç»ˆä¸€è‡´æ€§ï¼š
   - å®šæ—¶ä»»åŠ¡å¯¹è´¦ï¼ˆæ¯å°æ—¶ï¼‰
   - Redisåº“å­˜ vs DBåº“å­˜
   - å‘ç°å·®å¼‚ â†’ å‘Šè­¦ â†’ äººå·¥å¤„ç†

2. è¡¥å¿æœºåˆ¶ï¼š
   - è®¢å•åˆ›å»ºå¤±è´¥ â†’ å›æ»šRedisåº“å­˜
   - ä½¿ç”¨TCCäº‹åŠ¡æ¨¡å¼

3. é¢„ç•™åº“å­˜ï¼š
   - Redisåˆå§‹åº“å­˜ = DBåº“å­˜ - 10ï¼ˆé¢„ç•™ï¼‰
   - é˜²æ­¢è¶…å–

æ¨èï¼šæœ€ç»ˆä¸€è‡´æ€§ + å®šæ—¶å¯¹è´¦ âœ…
```

### Q2: å¦‚æœRedisæŒ‚äº†æ€ä¹ˆåŠï¼Ÿ

**å›ç­”**ï¼š
```
æ–¹æ¡ˆï¼š

1. Redisé«˜å¯ç”¨ï¼š
   - ä¸»ä» + å“¨å…µ
   - Redis Cluster
   - è‡ªåŠ¨æ•…éšœè½¬ç§»

2. é™çº§æ–¹æ¡ˆï¼š
   - RedisæŒ‚äº† â†’ ç›´æ¥è®¿é—®æ•°æ®åº“
   - æ•°æ®åº“é™æµï¼ˆä¿æŠ¤ï¼‰
   - è¿”å›"ç³»ç»Ÿç¹å¿™"

3. å¤šçº§ç¼“å­˜ï¼š
   - L1: æœ¬åœ°ç¼“å­˜
   - L2: Redis
   - L3: æ•°æ®åº“
```

### Q3: å¦‚ä½•ä¿è¯å…¬å¹³æ€§ï¼Ÿ

**å›ç­”**ï¼š
```
é—®é¢˜ï¼šå…ˆæŠ¢å…ˆå¾—æ˜¯å¦å…¬å¹³ï¼Ÿ
  - ç½‘é€Ÿå¿«çš„ç”¨æˆ·æœ‰ä¼˜åŠ¿
  - é è¿‘æœºæˆ¿çš„ç”¨æˆ·æœ‰ä¼˜åŠ¿

ä¼˜åŒ–æ–¹æ¡ˆï¼š

1. éšæœºå»¶è¿Ÿï¼š
   - æ¯ä¸ªè¯·æ±‚éšæœºå»¶è¿Ÿ0-100ms
   - å‡å°‘ç½‘ç»œä¼˜åŠ¿

2. æŠ½å¥–æ¨¡å¼ï¼š
   - ç§’æ€æ—¶é—´ç»“æŸå
   - ä»æ‰€æœ‰å‚ä¸ç”¨æˆ·ä¸­æŠ½å¥–
   - ç»å¯¹å…¬å¹³

3. é˜Ÿåˆ—æ¨¡å¼ï¼š
   - æ‰€æœ‰è¯·æ±‚è¿›é˜Ÿåˆ—
   - FIFOå¤„ç†
   - å…¬å¹³ä½†å®æ—¶æ€§å·®

æ¨èï¼šå…ˆåˆ°å…ˆå¾—ï¼ˆä½“éªŒå¥½ï¼‰ + éšæœºå»¶è¿Ÿï¼ˆç›¸å¯¹å…¬å¹³ï¼‰ âœ…
```

### Q4: å¦‚ä½•é˜²æ­¢é»„ç‰›åˆ·å•ï¼Ÿ

**å›ç­”**ï¼š
```
ç»¼åˆé˜²æŠ¤ï¼š

1. å®åè®¤è¯ï¼š
   - æ‰‹æœºå·éªŒè¯
   - èº«ä»½è¯éªŒè¯
   - äººè„¸è¯†åˆ«

2. é™è´­ç­–ç•¥ï¼š
   - æ¯äººé™è´­1ä»¶
   - åŒä¸€åœ°å€é™è´­1ä»¶
   - åŒä¸€é“¶è¡Œå¡é™è´­1ä»¶

3. é£æ§ç³»ç»Ÿï¼š
   - ç”¨æˆ·è¡Œä¸ºåˆ†æ
   - è®¾å¤‡æŒ‡çº¹è¯†åˆ«
   - å¼‚å¸¸è´¦å·æ‹¦æˆª

4. éªŒè¯ç ï¼š
   - æ»‘åŠ¨éªŒè¯ç 
   - å›¾å½¢éªŒè¯ç 
   - çŸ­ä¿¡éªŒè¯ç 

5. ä»·æ ¼ç­–ç•¥ï¼š
   - ç§’æ€ä»·ä¸è¦å¤ªä½
   - å‡å°‘é»„ç‰›åˆ©æ¶¦ç©ºé—´
```

---

## å…­ã€æ€»ç»“

### æ ¸å¿ƒè®¾è®¡è¦ç‚¹

```
1. å‰ç«¯ä¼˜åŒ–ï¼š
   âœ… é¡µé¢é™æ€åŒ– + CDN
   âœ… ç­”é¢˜éªŒè¯ç 
   âœ… é˜²é‡å¤æäº¤

2. æ¥å…¥å±‚ï¼š
   âœ… Nginxé™æµ
   âœ… IPé»‘åå•
   âœ… ç”¨æˆ·é™æµ

3. ä¸šåŠ¡å±‚ï¼š
   âœ… Redisé¢„å‡åº“å­˜ï¼ˆæ ¸å¿ƒï¼‰
   âœ… å¼‚æ­¥ä¸‹å•ï¼ˆMQï¼‰
   âœ… é™æµé™çº§

4. æ•°æ®å±‚ï¼š
   âœ… æ•°æ®åº“ä¹è§‚é”
   âœ… è¯»å†™åˆ†ç¦»
   âœ… ä¸»ä»å¤åˆ¶

5. å®‰å…¨é˜²æŠ¤ï¼š
   âœ… æ¥å£ç­¾å
   âœ… é¢‘ç‡é™åˆ¶
   âœ… è¡Œä¸ºåˆ†æ
```

### æ€§èƒ½ä¼˜åŒ–

```
ä¼˜åŒ–å‰ï¼š
  - QPSï¼š1000
  - RTï¼š500ms
  - æˆåŠŸç‡ï¼š10%

ä¼˜åŒ–åï¼š
  - QPSï¼š100,000 âœ… (100å€æå‡)
  - RTï¼š50ms âœ… (10å€æå‡)
  - æˆåŠŸç‡ï¼š99.9% âœ…
```

### é¢è¯•è¦ç‚¹

```
1. ç†è§£ç§’æ€ç‰¹ç‚¹ï¼š
   - ç¬æ—¶é«˜å¹¶å‘
   - è¯»å¤šå†™å°‘
   - åº“å­˜æœ‰é™

2. æŒæ¡æ ¸å¿ƒæ–¹æ¡ˆï¼š
   - Redisé¢„å‡åº“å­˜ï¼ˆå¿…ç­”ï¼‰
   - æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥
   - æ•°æ®åº“ä¹è§‚é”

3. è¯´æ˜æƒè¡¡ï¼š
   - ä¸ºä»€ä¹ˆç”¨Redisï¼Ÿï¼ˆå¿«ï¼‰
   - ä¸ºä»€ä¹ˆå¼‚æ­¥ï¼Ÿï¼ˆå‰Šå³°ï¼‰
   - ä¸ºä»€ä¹ˆä¹è§‚é”ï¼Ÿï¼ˆæ€§èƒ½ï¼‰

4. é˜²æŠ¤æªæ–½ï¼š
   - é™æµã€é™çº§ã€ç†”æ–­
   - é˜²åˆ·ã€é˜²è¶…å–
```

---

## ğŸ“– ç›¸å…³æ–‡æ¡£

- [é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡](../é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡.md)
- [01_è®¾è®¡çŸ­é“¾æ¥ç³»ç»Ÿ](./01_è®¾è®¡çŸ­é“¾æ¥ç³»ç»Ÿ.md)
- [09_è®¾è®¡é™æµå™¨](./09_è®¾è®¡é™æµå™¨.md)

---

**æœ€åæ›´æ–°**: 2025-10-29  
**éš¾åº¦ç­‰çº§**: â­â­â­â­â­ (å›°éš¾)  
**é¢è¯•é¢‘ç‡**: â­â­â­â­â­ (æé«˜)

ğŸ’¡ **æ€»ç»“**: ç§’æ€ç³»ç»Ÿæ˜¯æœ€ç»å…¸çš„é«˜å¹¶å‘åœºæ™¯ï¼Œç»¼åˆè€ƒå¯Ÿç¼“å­˜ã€æ¶ˆæ¯é˜Ÿåˆ—ã€é™æµã€é˜²è¶…å–ç­‰æ ¸å¿ƒæŠ€æœ¯ï¼

## ä¸ƒã€å…³é”®æŠ€æœ¯æŒ‘æˆ˜

### 7.1 é«˜å¹¶å‘åº“å­˜æ§åˆ¶

**1. åº“å­˜è¶…å–é—®é¢˜**
```java
/**
 * åº“å­˜åŒæ£€æœºåˆ¶å®ç°
 */
public boolean checkAndDecrementStock(Long productId) {
    // 1. Redisé¢„å‡åº“å­˜
    Long remainStock = redisTemplate.opsForValue().decrement("stock:" + productId);
    if (remainStock != null && remainStock < 0) {
        // åº“å­˜ä¸è¶³ï¼Œå›æ»šRedis
        redisTemplate.opsForValue().increment("stock:" + productId);
        return false;
    }

    // 2. å‘é€MQæ¶ˆæ¯å¼‚æ­¥æ›´æ–°DB
    try {
        mqProducer.send("stock_topic", new StockMessage(productId));
        return true;
    } catch (Exception e) {
        // MQå‘é€å¤±è´¥ï¼Œå›æ»šRedis
        redisTemplate.opsForValue().increment("stock:" + productId);
        return false;
    }
}
```

**2. åˆ†å¸ƒå¼é”ä¼˜åŒ–**
```java
/**
 * åŸºäºRedisçš„åˆ†å¸ƒå¼é”æ”¹è¿›ç‰ˆ
 */
public class RedisDistributedLock {
    private static final String LOCK_KEY_PREFIX = "lock:seckill:";
    private static final int LOCK_EXPIRE = 30000; // 30ç§’
    private static final int RETRY_TIMES = 3;     // é‡è¯•3æ¬¡
    private static final int RETRY_DELAY = 50;    // é‡è¯•é—´éš”50ms

    public <T> T tryLock(String productId, Supplier<T> supplier) {
        String lockKey = LOCK_KEY_PREFIX + productId;
        String requestId = UUID.randomUUID().toString();

        // é‡è¯•æœºåˆ¶
        for (int i = 0; i < RETRY_TIMES; i++) {
            Boolean locked = redisTemplate.opsForValue().setIfAbsent(
                lockKey, requestId, LOCK_EXPIRE, TimeUnit.MILLISECONDS);

            if (Boolean.TRUE.equals(locked)) {
                try {
                    return supplier.get();
                } finally {
                    // ç¡®ä¿åªæœ‰æŒæœ‰è€…æ‰èƒ½é‡Šæ”¾é”
                    String script = "if redis.call('get', KEYS[1]) == ARGV[1] then return redis.call('del', KEYS[1]) else return 0 end";
                    redisTemplate.execute(new DefaultRedisScript<>(script, Integer.class),
                        Collections.singletonList(lockKey), requestId);
                }
            }

            // é‡è¯•å»¶è¿Ÿ
            if (i < RETRY_TIMES - 1) {
                try { Thread.sleep(RETRY_DELAY); } catch (InterruptedException e) {}
            }
        }

        throw new RuntimeException("è·å–åˆ†å¸ƒå¼é”å¤±è´¥");
    }
}
```

### 7.2 ç³»ç»Ÿå¯ç”¨æ€§ä¿éšœ

**1. å¤šçº§ç¼“å­˜æ¶æ„**
```
å®¢æˆ·ç«¯ç¼“å­˜ â†’ CDN â†’ æ¥å…¥å±‚Nginx â†’ åº”ç”¨æœ¬åœ°ç¼“å­˜ â†’ Redisé›†ç¾¤ â†’ æ•°æ®åº“
```

**2. ç†”æ–­é™çº§ç­–ç•¥**
```java
/**
 * ç§’æ€æœåŠ¡ç†”æ–­é™çº§å®ç°
 */
@HystrixCommand(fallbackMethod = "seckillFallback",
    commandProperties = {
        @HystrixProperty(name = "circuitBreaker.requestVolumeThreshold", value = "20"),
        @HystrixProperty(name = "circuitBreaker.errorThresholdPercentage", value = "50"),
        @HystrixProperty(name = "circuitBreaker.sleepWindowInMilliseconds", value = "5000")
    }
)
public SeckillResult seckill(Long userId, Long productId) {
    // æ­£å¸¸ç§’æ€é€»è¾‘
    return seckillService.process(userId, productId);
}

public SeckillResult seckillFallback(Long userId, Long productId, Throwable e) {
    log.error("ç§’æ€æœåŠ¡é™çº§: userId={}, productId={}", userId, productId, e);
    return SeckillResult.fail("ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åå†è¯•");
}
```

## å…«ã€ç›‘æ§ä¸è¿ç»´

### 8.1 æ ¸å¿ƒç›‘æ§æŒ‡æ ‡

| æŒ‡æ ‡ç±»åˆ« | å…·ä½“æŒ‡æ ‡ | é˜ˆå€¼ | ç›‘æ§é¢‘ç‡ |
|---------|---------|------|---------|
| ç³»ç»ŸæŒ‡æ ‡ | CPUä½¿ç”¨ç‡ | <80% | 5ç§’ |
| ç³»ç»ŸæŒ‡æ ‡ | å†…å­˜ä½¿ç”¨ç‡ | <85% | 5ç§’ |
| ç³»ç»ŸæŒ‡æ ‡ | ç£ç›˜IO | <90% | 10ç§’ |
| åº”ç”¨æŒ‡æ ‡ | æ¥å£å“åº”æ—¶é—´ | P99<200ms | 1ç§’ |
| åº”ç”¨æŒ‡æ ‡ | æ¥å£é”™è¯¯ç‡ | <0.1% | 1ç§’ |
| åº”ç”¨æŒ‡æ ‡ | JVM GCæ¬¡æ•° | <5æ¬¡/åˆ†é’Ÿ | 1åˆ†é’Ÿ |
| ä¸šåŠ¡æŒ‡æ ‡ | ç§’æ€æˆåŠŸç‡ | >99% | 1ç§’ |
| ä¸šåŠ¡æŒ‡æ ‡ | è®¢å•åˆ›å»ºæ•° | - | 1ç§’ |
| ä¸šåŠ¡æŒ‡æ ‡ | æ”¯ä»˜è½¬åŒ–ç‡ | - | 5åˆ†é’Ÿ |
| ç¼“å­˜æŒ‡æ ‡ | Rediså‘½ä¸­ç‡ | >99% | 10ç§’ |
| ç¼“å­˜æŒ‡æ ‡ | Rediså†…å­˜ä½¿ç”¨ç‡ | <80% | 10ç§’ |
| æ•°æ®åº“æŒ‡æ ‡ | æ…¢æŸ¥è¯¢æ•° | <5ä¸ª/åˆ†é’Ÿ | 1åˆ†é’Ÿ |
| æ•°æ®åº“æŒ‡æ ‡ | è¿æ¥æ± ä½¿ç”¨ç‡ | <80% | 10ç§’ |

### 8.2 å‘Šè­¦æœºåˆ¶

**ä¸‰çº§å‘Šè­¦ä½“ç³»**:
1. **P0çº§ï¼ˆç´§æ€¥ï¼‰**: ç”µè¯+çŸ­ä¿¡+é‚®ä»¶ï¼Œ5åˆ†é’Ÿå†…å“åº”
   - ç§’æ€æœåŠ¡ä¸å¯ç”¨
   - æ”¯ä»˜ç³»ç»Ÿå¼‚å¸¸
   - æ•°æ®åº“å®•æœº

2. **P1çº§ï¼ˆé‡è¦ï¼‰**: çŸ­ä¿¡+é‚®ä»¶ï¼Œ30åˆ†é’Ÿå†…å“åº”
   - æ¥å£é”™è¯¯ç‡>1%
   - å“åº”æ—¶é—´P99>500ms
   - Rediså‘½ä¸­ç‡<95%

3. **P2çº§ï¼ˆä¸€èˆ¬ï¼‰**: é‚®ä»¶ï¼Œ2å°æ—¶å†…å“åº”
   - ç³»ç»Ÿèµ„æºä½¿ç”¨ç‡è¶…é˜ˆå€¼
   - è®¢å•è½¬åŒ–ç‡å¼‚å¸¸
   - ç¼“å­˜é¢„çƒ­å¤±è´¥

### 8.3 è¿ç»´å·¥å…·

**1. ä¸€é”®éƒ¨ç½²è„šæœ¬**:
```bash
#!/bin/bash
# ç§’æ€ç³»ç»Ÿéƒ¨ç½²è„šæœ¬

# 1. æ‰“åŒ…
mvn clean package -Dmaven.test.skip=true

# 2. åœæ­¢æ—§æœåŠ¡
sh stop.sh

# 3. éƒ¨ç½²æ–°æœåŠ¡
cp target/seckill-service.jar /opt/services/

# 4. å¯åŠ¨æœåŠ¡
sh start.sh

# 5. å¥åº·æ£€æŸ¥
curl http://localhost:8080/actuator/health
```

**2. æµé‡å›æ”¾å·¥å…·**:
```java
/**
 * ç§’æ€æµé‡å›æ”¾å·¥å…·
 */
public class TrafficReplayer {
    private final HttpClient httpClient;
    private final String targetUrl;
    private final List<String> userIds;
    private final List<String> productIds;

    public void replay(int concurrency, int totalRequests) {
        ExecutorService executor = Executors.newFixedThreadPool(concurrency);
        CountDownLatch latch = new CountDownLatch(totalRequests);
        StopWatch stopWatch = StopWatch.createStarted();

        for (int i = 0; i < totalRequests; i++) {
            executor.submit(() -> {
                try {
                    String userId = userIds.get(new Random().nextInt(userIds.size()));
                    String productId = productIds.get(new Random().nextInt(productIds.size()));
                    sendSeckillRequest(userId, productId);
                } finally {
                    latch.countDown();
                }
            });
        }

        try { latch.await(); }
        catch (InterruptedException e) { Thread.currentThread().interrupt(); }

        stopWatch.stop();
        System.out.printf("å®Œæˆ%dæ¬¡è¯·æ±‚ï¼Œè€—æ—¶%dms\n", totalRequests, stopWatch.getTime());
        executor.shutdown();
    }

    private void sendSeckillRequest(String userId, String productId) {
        // å‘é€ç§’æ€è¯·æ±‚å®ç°
    }
}
```

---

## ğŸ“– æ‰©å±•é˜…è¯»

1. [Rediså®˜æ–¹æ–‡æ¡£ - åˆ†å¸ƒå¼é”å®ç°](https://redis.io/docs/manual/patterns/distributed-locks/)
2. [Spring Cloud Alibaba - Sentinelé™æµ](https://sentinelguard.io/zh-cn/docs/flow-control.html)
3. [MySQLé«˜æ€§èƒ½ - ä¹è§‚é”ä¸æ‚²è§‚é”åº”ç”¨](https://dev.mysql.com/doc/refman/8.0/en/innodb-locking.html)
4. [Kafkaæ¶ˆæ¯å¯é æ€§ä¿è¯](https://kafka.apache.org/documentation/#semantics)
5. [Hystrixç†”æ–­é™çº§è®¾è®¡](https://github.com/Netflix/Hystrix/wiki)
6. [Elasticsearchåœ¨ç›‘æ§ç³»ç»Ÿä¸­çš„åº”ç”¨](https://www.elastic.co/guide/en/elasticsearch/reference/current/elasticsearch-intro.html)
7. [ç§’æ€ç³»ç»Ÿæ¶æ„è®¾è®¡å®è·µ](https://tech.meituan.com/2016/09/29/seckill.html)
8. [å¤§è§„æ¨¡åˆ†å¸ƒå¼ç³»ç»Ÿçš„å®¹é‡è§„åˆ’æ–¹æ³•è®º](https://www.oreilly.com/library/view/scalability-engineering-for/9781492082984/)