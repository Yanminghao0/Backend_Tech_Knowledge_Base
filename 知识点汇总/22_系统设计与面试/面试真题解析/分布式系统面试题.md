# åˆ†å¸ƒå¼ç³»ç»Ÿé¢è¯•é¢˜

> åˆ†å¸ƒå¼ç³»ç»Ÿé«˜é¢‘é¢è¯•é¢˜åŠè¯¦ç»†è§£ç­”

## ğŸ“‹ ç›®å½•
- [ç†è®ºåŸºç¡€](#ç†è®ºåŸºç¡€)
- [åˆ†å¸ƒå¼äº‹åŠ¡](#åˆ†å¸ƒå¼äº‹åŠ¡)
- [åˆ†å¸ƒå¼é”](#åˆ†å¸ƒå¼é”)
- [æœåŠ¡æ²»ç†](#æœåŠ¡æ²»ç†)
- [æ¶ˆæ¯é˜Ÿåˆ—](#æ¶ˆæ¯é˜Ÿåˆ—)
- [ä¸€è‡´æ€§åè®®](#ä¸€è‡´æ€§åè®®)

---

## ç†è®ºåŸºç¡€

### Q1: CAPç†è®ºï¼Ÿï¼ˆâ­â­â­â­â­ï¼‰

**CAPå®šç†**ï¼š
```
å®šä¹‰ï¼š
  åˆ†å¸ƒå¼ç³»ç»Ÿæœ€å¤šåªèƒ½åŒæ—¶æ»¡è¶³CAPä¸‰ä¸ªç‰¹æ€§ä¸­çš„ä¸¤ä¸ª

Cï¼ˆConsistencyï¼‰- ä¸€è‡´æ€§ï¼š
  - æ‰€æœ‰èŠ‚ç‚¹åŒä¸€æ—¶é—´çœ‹åˆ°ç›¸åŒçš„æ•°æ®
  - è¯»æ“ä½œæ€»èƒ½è¯»åˆ°æœ€æ–°å†™å…¥çš„æ•°æ®

Aï¼ˆAvailabilityï¼‰- å¯ç”¨æ€§ï¼š
  - æ¯ä¸ªè¯·æ±‚éƒ½èƒ½å¾—åˆ°å“åº”ï¼ˆæˆåŠŸæˆ–å¤±è´¥ï¼‰
  - ä¸ç®¡å“ªä¸ªèŠ‚ç‚¹æŒ‚äº†ï¼Œç³»ç»Ÿéƒ½èƒ½æœåŠ¡

Pï¼ˆPartition Toleranceï¼‰- åˆ†åŒºå®¹é”™æ€§ï¼š
  - ç½‘ç»œåˆ†åŒºæ—¶ç³»ç»Ÿä»èƒ½ç»§ç»­å·¥ä½œ
  - åˆ†å¸ƒå¼ç³»ç»Ÿå¿…é¡»æ»¡è¶³P
```

**CAPç»„åˆ**ï¼š

**1. CPï¼ˆä¸€è‡´æ€§ + åˆ†åŒºå®¹é”™ï¼‰**ï¼š
```
ç‰¹ç‚¹ï¼š
  - ä¿è¯ä¸€è‡´æ€§ï¼Œç‰ºç‰²å¯ç”¨æ€§
  - ç½‘ç»œåˆ†åŒºæ—¶ï¼Œéƒ¨åˆ†èŠ‚ç‚¹ä¸å¯ç”¨

ç¤ºä¾‹ï¼šZookeeperã€HBaseã€Redis Clusterï¼ˆéƒ¨åˆ†åœºæ™¯ï¼‰

åœºæ™¯ï¼š
  Zookeeperé›†ç¾¤5ä¸ªèŠ‚ç‚¹
  
  æ­£å¸¸æƒ…å†µï¼š
    âœ… 3ä¸ªèŠ‚ç‚¹åœ¨æœºæˆ¿A
    âœ… 2ä¸ªèŠ‚ç‚¹åœ¨æœºæˆ¿B
    âœ… æ•°æ®ä¸€è‡´
  
  ç½‘ç»œåˆ†åŒºï¼š
    âŒ æœºæˆ¿Aå’ŒBç½‘ç»œæ–­å¼€
    âœ… Aæœ‰3ä¸ªèŠ‚ç‚¹ï¼ˆè¿‡åŠï¼‰â†’ ç»§ç»­æœåŠ¡
    âŒ Bæœ‰2ä¸ªèŠ‚ç‚¹ï¼ˆæœªè¿‡åŠï¼‰â†’ åœæ­¢æœåŠ¡
    âœ… ä¿è¯äº†ä¸€è‡´æ€§ï¼ˆåªæœ‰ä¸€ä¸ªpartitionæœåŠ¡ï¼‰
    âŒ ç‰ºç‰²äº†å¯ç”¨æ€§ï¼ˆBä¸å¯ç”¨ï¼‰

é€‚ç”¨åœºæ™¯ï¼š
  - åˆ†å¸ƒå¼åè°ƒï¼ˆZookeeperï¼‰
  - é…ç½®ä¸­å¿ƒ
  - åˆ†å¸ƒå¼é”
  - å¯¹ä¸€è‡´æ€§è¦æ±‚é«˜çš„åœºæ™¯
```

**2. APï¼ˆå¯ç”¨æ€§ + åˆ†åŒºå®¹é”™ï¼‰**ï¼š
```
ç‰¹ç‚¹ï¼š
  - ä¿è¯å¯ç”¨æ€§ï¼Œç‰ºç‰²ä¸€è‡´æ€§
  - ç½‘ç»œåˆ†åŒºæ—¶ï¼Œæ‰€æœ‰èŠ‚ç‚¹éƒ½å¯ç”¨
  - ä½†æ•°æ®å¯èƒ½ä¸ä¸€è‡´

ç¤ºä¾‹ï¼šEurekaã€Cassandraã€DynamoDB

åœºæ™¯ï¼š
  Eurekaé›†ç¾¤3ä¸ªèŠ‚ç‚¹
  
  æ­£å¸¸æƒ…å†µï¼š
    âœ… èŠ‚ç‚¹Aã€Bã€C
    âœ… æ•°æ®æœ€ç»ˆä¸€è‡´
  
  ç½‘ç»œåˆ†åŒºï¼š
    âŒ Aå’ŒBã€Cç½‘ç»œæ–­å¼€
    âœ… Aç»§ç»­æœåŠ¡ï¼ˆå¯èƒ½æœ‰æ—§æ•°æ®ï¼‰
    âœ… Bã€Cç»§ç»­æœåŠ¡
    âœ… ä¿è¯äº†å¯ç”¨æ€§
    âŒ æ•°æ®ä¸ä¸€è‡´ï¼ˆAçš„æ•°æ®å¯èƒ½æ˜¯æ—§çš„ï¼‰
  
  ç½‘ç»œæ¢å¤ï¼š
    âœ… æ•°æ®åŒæ­¥ï¼Œæœ€ç»ˆä¸€è‡´

é€‚ç”¨åœºæ™¯ï¼š
  - æœåŠ¡æ³¨å†Œä¸­å¿ƒï¼ˆEurekaï¼‰
  - ç¼“å­˜ç³»ç»Ÿ
  - å¯¹å¯ç”¨æ€§è¦æ±‚é«˜çš„åœºæ™¯
  - å¯æ¥å—çŸ­æš‚æ•°æ®ä¸ä¸€è‡´
```

**3. CAï¼ˆä¸€è‡´æ€§ + å¯ç”¨æ€§ï¼‰**ï¼š
```
ç‰¹ç‚¹ï¼š
  - ä¸æ”¯æŒåˆ†åŒºå®¹é”™
  - åªèƒ½å•æœºæˆ–åŒä¸€æœºæˆ¿
  - åˆ†å¸ƒå¼ç³»ç»Ÿæ— æ³•å®ç°ï¼ˆç½‘ç»œä¸€å®šä¼šåˆ†åŒºï¼‰

ç¤ºä¾‹ï¼šå•æœºæ•°æ®åº“ï¼ˆMySQLå•æœºï¼‰

åˆ†å¸ƒå¼ç³»ç»Ÿå¿…é¡»é€‰æ‹©CPæˆ–APï¼
```

**å¯¹æ¯”æ€»ç»“**ï¼š

| ç³»ç»Ÿ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| Zookeeper | CP | å¼ºä¸€è‡´æ€§ï¼Œåˆ†åŒºæ—¶éƒ¨åˆ†èŠ‚ç‚¹ä¸å¯ç”¨ |
| Eureka | AP | é«˜å¯ç”¨ï¼Œæ•°æ®æœ€ç»ˆä¸€è‡´ |
| Consul | CP | ç±»ä¼¼Zookeeper |
| Nacos | AP/CP | å¯é…ç½®ï¼ˆæ”¯æŒä¸¤ç§æ¨¡å¼ï¼‰|
| Redis Cluster | AP | å¼‚æ­¥å¤åˆ¶ï¼Œå¯èƒ½ä¸¢æ•°æ® |
| Etcd | CP | å¼ºä¸€è‡´æ€§ |

---

### Q2: BASEç†è®ºï¼Ÿï¼ˆâ­â­â­â­ï¼‰

**BASEç†è®º**ï¼š
```
å®šä¹‰ï¼š
  CAPç†è®ºçš„å»¶ä¼¸
  é€šè¿‡ç‰ºç‰²å¼ºä¸€è‡´æ€§æ¥è·å¾—é«˜å¯ç”¨æ€§

BAï¼ˆBasically Availableï¼‰- åŸºæœ¬å¯ç”¨ï¼š
  - ç³»ç»Ÿå¤§éƒ¨åˆ†æ—¶é—´å¯ç”¨
  - å…è®¸æŸå¤±éƒ¨åˆ†å¯ç”¨æ€§
  
  ç¤ºä¾‹ï¼š
    - å“åº”æ—¶é—´å¢åŠ ï¼šæ­£å¸¸1sï¼Œé«˜å³°2s
    - é™çº§æœåŠ¡ï¼šé«˜å³°æœŸåªæä¾›æ ¸å¿ƒåŠŸèƒ½

Sï¼ˆSoft Stateï¼‰- è½¯çŠ¶æ€ï¼š
  - å…è®¸æ•°æ®å­˜åœ¨ä¸­é—´çŠ¶æ€
  - ä¸­é—´çŠ¶æ€ä¸å½±å“ç³»ç»Ÿå¯ç”¨æ€§
  
  ç¤ºä¾‹ï¼š
    - ä¸»ä»åŒæ­¥å»¶è¿Ÿ
    - æ•°æ®æ­£åœ¨åŒæ­¥ä¸­

Eï¼ˆEventually Consistentï¼‰- æœ€ç»ˆä¸€è‡´æ€§ï¼š
  - ç»è¿‡ä¸€æ®µæ—¶é—´åï¼Œæ‰€æœ‰èŠ‚ç‚¹æ•°æ®ä¸€è‡´
  - ä¸ä¿è¯å®æ—¶ä¸€è‡´
  
  ç¤ºä¾‹ï¼š
    - è®¢å•åˆ›å»ºåï¼Œåº“å­˜æœ€ç»ˆæ‰£å‡
    - è¯„è®ºå‘å¸ƒåï¼Œæœ€ç»ˆæ‰€æœ‰ç”¨æˆ·å¯è§
```

**BASE vs ACID**ï¼š

| å¯¹æ¯”é¡¹ | ACIDï¼ˆæ•°æ®åº“äº‹åŠ¡ï¼‰| BASEï¼ˆåˆ†å¸ƒå¼ï¼‰|
|--------|------------------|---------------|
| ä¸€è‡´æ€§ | å¼ºä¸€è‡´æ€§ | æœ€ç»ˆä¸€è‡´æ€§ |
| å¯ç”¨æ€§ | ä½ï¼ˆé”ï¼‰| é«˜ |
| æ€§èƒ½ | ä½ | é«˜ |
| åœºæ™¯ | å•æœºæ•°æ®åº“ | åˆ†å¸ƒå¼ç³»ç»Ÿ |

**æœ€ç»ˆä¸€è‡´æ€§å®ç°**ï¼š

**1. è¯»ä¿®å¤ï¼ˆRead Repairï¼‰**ï¼š
```
æµç¨‹ï¼š
  1. å®¢æˆ·ç«¯è¯»å–å¤šä¸ªå‰¯æœ¬
  2. å‘ç°æ•°æ®ä¸ä¸€è‡´
  3. ç”¨æœ€æ–°æ•°æ®ä¿®å¤æ—§æ•°æ®

ç¤ºä¾‹ï¼ˆCassandraï¼‰ï¼š
  è¯»å–Aã€Bã€Cä¸‰ä¸ªå‰¯æœ¬
  A: version=3
  B: version=3
  C: version=2  â† æ—§æ•°æ®
  
  â†’ ç”¨version=3çš„æ•°æ®æ›´æ–°C
```

**2. å†™ä¿®å¤ï¼ˆWrite Repairï¼‰**ï¼š
```
æµç¨‹ï¼š
  1. å†™å…¥ä¸»èŠ‚ç‚¹
  2. å¼‚æ­¥åŒæ­¥åˆ°ä»èŠ‚ç‚¹
  3. æœ€ç»ˆæ‰€æœ‰èŠ‚ç‚¹ä¸€è‡´

ç¤ºä¾‹ï¼ˆRedisä¸»ä»ï¼‰ï¼š
  1. å†™Master
  2. å¼‚æ­¥åŒæ­¥åˆ°Slave
  3. çŸ­æš‚ä¸ä¸€è‡´
  4. æœ€ç»ˆä¸€è‡´
```

**3. åç†µï¼ˆAnti-Entropyï¼‰**ï¼š
```
æµç¨‹ï¼š
  1. åå°å®šæœŸæ‰«ææ•°æ®
  2. å¯¹æ¯”Merkleæ ‘
  3. å‘ç°ä¸ä¸€è‡´åˆ™åŒæ­¥

Merkleæ ‘ï¼š
  - å“ˆå¸Œæ ‘
  - å¿«é€Ÿå¯¹æ¯”å¤§é‡æ•°æ®

ç¤ºä¾‹ï¼š
  èŠ‚ç‚¹Aï¼šhash(data) = 0x123
  èŠ‚ç‚¹Bï¼šhash(data) = 0x456
  
  â†’ æ•°æ®ä¸ä¸€è‡´ï¼Œè§¦å‘åŒæ­¥
```

---

### Q3: ä¸€è‡´æ€§Hashï¼Ÿï¼ˆâ­â­â­â­â­ï¼‰

**ä¸ºä»€ä¹ˆéœ€è¦ä¸€è‡´æ€§Hashï¼Ÿ**
```
ä¼ ç»ŸHashï¼š
  hash(key) % N  # N=èŠ‚ç‚¹æ•°
  
  é—®é¢˜ï¼š
    åˆå§‹3ä¸ªèŠ‚ç‚¹ï¼šhash(user:1) % 3 = 1  â†’ èŠ‚ç‚¹1
    
    æ‰©å®¹åˆ°4ä¸ªèŠ‚ç‚¹ï¼šhash(user:1) % 4 = 2  â†’ èŠ‚ç‚¹2 âŒ
    
    â†’ å¤§é‡æ•°æ®éœ€è¦è¿ç§»
    â†’ ç¼“å­˜é›ªå´©
```

**ä¸€è‡´æ€§HashåŸç†**ï¼š
```
1. Hashç¯ï¼š
   - 2^32ä¸ªç‚¹ï¼ˆ0 ~ 2^32-1ï¼‰
   - é¦–å°¾ç›¸è¿å½¢æˆç¯

2. èŠ‚ç‚¹æ˜ å°„ï¼š
   - èŠ‚ç‚¹IP hashåˆ°ç¯ä¸Š
   
   0 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 2^32-1
   â†‘               â†‘
  èŠ‚ç‚¹A          èŠ‚ç‚¹B
   â†‘               â†‘
  èŠ‚ç‚¹C

3. æ•°æ®æ˜ å°„ï¼š
   - key hashåˆ°ç¯ä¸Š
   - é¡ºæ—¶é’ˆæ‰¾åˆ°ç¬¬ä¸€ä¸ªèŠ‚ç‚¹
   
   key1 â†’ hash(key1) â†’ é¡ºæ—¶é’ˆ â†’ èŠ‚ç‚¹A
   key2 â†’ hash(key2) â†’ é¡ºæ—¶é’ˆ â†’ èŠ‚ç‚¹B

4. èŠ‚ç‚¹å¢åˆ ï¼š
   æ–°å¢èŠ‚ç‚¹Dï¼ˆåœ¨Aå’ŒBä¹‹é—´ï¼‰ï¼š
     - åªå½±å“Aåˆ°Dä¹‹é—´çš„æ•°æ®
     - å…¶ä»–æ•°æ®ä¸å—å½±å“
   
   åˆ é™¤èŠ‚ç‚¹Aï¼š
     - Açš„æ•°æ®è¿ç§»åˆ°B
     - å…¶ä»–æ•°æ®ä¸å—å½±å“
```

**è™šæ‹ŸèŠ‚ç‚¹**ï¼š
```
é—®é¢˜ï¼š
  - èŠ‚ç‚¹æ•°å°‘æ—¶ï¼Œæ•°æ®åˆ†å¸ƒä¸å‡åŒ€
  - æŸäº›èŠ‚ç‚¹è´Ÿè½½é«˜ï¼ŒæŸäº›ä½

è§£å†³ï¼šè™šæ‹ŸèŠ‚ç‚¹
  ç‰©ç†èŠ‚ç‚¹A â†’ è™šæ‹ŸèŠ‚ç‚¹ï¼šA-1, A-2, A-3, ...
  ç‰©ç†èŠ‚ç‚¹B â†’ è™šæ‹ŸèŠ‚ç‚¹ï¼šB-1, B-2, B-3, ...
  
  æ¯ä¸ªç‰©ç†èŠ‚ç‚¹å¯¹åº”150~200ä¸ªè™šæ‹ŸèŠ‚ç‚¹
  
  æ•ˆæœï¼š
    âœ… æ•°æ®åˆ†å¸ƒå‡åŒ€
    âœ… è´Ÿè½½å‡è¡¡
```

**Javaå®ç°**ï¼š
```java
public class ConsistentHash {
    
    // Hashç¯ï¼ˆè™šæ‹ŸèŠ‚ç‚¹ â†’ ç‰©ç†èŠ‚ç‚¹ï¼‰
    private final TreeMap<Long, String> ring = new TreeMap<>();
    
    // è™šæ‹ŸèŠ‚ç‚¹æ•°é‡
    private final int virtualNodeCount;
    
    public ConsistentHash(List<String> nodes, int virtualNodeCount) {
        this.virtualNodeCount = virtualNodeCount;
        
        // æ·»åŠ æ‰€æœ‰èŠ‚ç‚¹
        for (String node : nodes) {
            addNode(node);
        }
    }
    
    // æ·»åŠ èŠ‚ç‚¹
    public void addNode(String node) {
        for (int i = 0; i < virtualNodeCount; i++) {
            String virtualNode = node + "#" + i;
            long hash = hash(virtualNode);
            ring.put(hash, node);
        }
    }
    
    // åˆ é™¤èŠ‚ç‚¹
    public void removeNode(String node) {
        for (int i = 0; i < virtualNodeCount; i++) {
            String virtualNode = node + "#" + i;
            long hash = hash(virtualNode);
            ring.remove(hash);
        }
    }
    
    // è·å–èŠ‚ç‚¹
    public String getNode(String key) {
        if (ring.isEmpty()) {
            return null;
        }
        
        long hash = hash(key);
        
        // é¡ºæ—¶é’ˆæ‰¾ç¬¬ä¸€ä¸ªèŠ‚ç‚¹
        Map.Entry<Long, String> entry = ring.ceilingEntry(hash);
        
        if (entry == null) {
            // è¶…è¿‡æœ€å¤§å€¼ï¼Œè¿”å›ç¬¬ä¸€ä¸ª
            entry = ring.firstEntry();
        }
        
        return entry.getValue();
    }
    
    // Hashå‡½æ•°ï¼ˆMD5ï¼‰
    private long hash(String key) {
        try {
            MessageDigest md = MessageDigest.getInstance("MD5");
            byte[] digest = md.digest(key.getBytes());
            long hash = 0;
            for (int i = 0; i < 4; i++) {
                hash = (hash << 8) | (digest[i] & 0xFF);
            }
            return hash;
        } catch (NoSuchAlgorithmException e) {
            throw new RuntimeException(e);
        }
    }
}

// ä½¿ç”¨
List<String> nodes = Arrays.asList("192.168.1.1", "192.168.1.2", "192.168.1.3");
ConsistentHash hash = new ConsistentHash(nodes, 150);

String node1 = hash.getNode("user:1");  // 192.168.1.2
String node2 = hash.getNode("user:2");  // 192.168.1.1

// æ‰©å®¹
hash.addNode("192.168.1.4");
String node3 = hash.getNode("user:1");  // å¯èƒ½è¿˜æ˜¯192.168.1.2ï¼ˆå¤§éƒ¨åˆ†ä¸å˜ï¼‰

åº”ç”¨åœºæ™¯ï¼š
  âœ… åˆ†å¸ƒå¼ç¼“å­˜ï¼ˆMemcachedï¼‰
  âœ… è´Ÿè½½å‡è¡¡
  âœ… æ•°æ®åˆ†ç‰‡
  âœ… åˆ†å¸ƒå¼å­˜å‚¨
```

---

### Q4: åˆ†å¸ƒå¼IDç”Ÿæˆï¼Ÿï¼ˆâ­â­â­â­â­ï¼‰

**å¸¸è§æ–¹æ¡ˆ**ï¼š

**1. UUID**ï¼š
```java
String uuid = UUID.randomUUID().toString();
// 550e8400-e29b-41d4-a716-446655440000

ä¼˜ç‚¹ï¼š
  âœ… ç®€å•
  âœ… æœ¬åœ°ç”Ÿæˆ
  âœ… æ€§èƒ½é«˜

ç¼ºç‚¹ï¼š
  âŒ 36ä¸ªå­—ç¬¦ï¼Œå ç”¨ç©ºé—´å¤§
  âŒ æ— åºï¼Œç´¢å¼•æ€§èƒ½å·®
  âŒ å¯è¯»æ€§å·®

é€‚ç”¨åœºæ™¯ï¼š
  - æ–‡ä»¶å
  - ä¸´æ—¶æ•°æ®
  - ä¸éœ€è¦æ’åºçš„ID
```

**2. æ•°æ®åº“è‡ªå¢ID**ï¼š
```sql
CREATE TABLE id_generator (
    id BIGINT NOT NULL AUTO_INCREMENT PRIMARY KEY
);

INSERT INTO id_generator VALUES ();
SELECT LAST_INSERT_ID();

ä¼˜ç‚¹ï¼š
  âœ… ç®€å•
  âœ… æœ‰åº
  âœ… å¯è¯»æ€§å¥½

ç¼ºç‚¹ï¼š
  âŒ æ€§èƒ½ç“¶é¢ˆï¼ˆæ•°æ®åº“ï¼‰
  âŒ å•ç‚¹æ•…éšœ
  âŒ æ°´å¹³æ‰©å±•å›°éš¾

ä¼˜åŒ–ï¼š
  å¤šå®ä¾‹ + æ­¥é•¿ï¼š
    å®ä¾‹1ï¼š1, 3, 5, 7, ...ï¼ˆèµ·å§‹1ï¼Œæ­¥é•¿2ï¼‰
    å®ä¾‹2ï¼š2, 4, 6, 8, ...ï¼ˆèµ·å§‹2ï¼Œæ­¥é•¿2ï¼‰
    
    é…ç½®ï¼š
      SET @@auto_increment_offset = 1;
      SET @@auto_increment_increment = 2;
```

**3. Redis INCR**ï¼š
```java
Long id = redisTemplate.opsForValue().increment("id:generator");

ä¼˜ç‚¹ï¼š
  âœ… æ€§èƒ½é«˜ï¼ˆå†…å­˜ï¼‰
  âœ… æœ‰åº

ç¼ºç‚¹ï¼š
  âŒ ä¾èµ–Redis
  âŒ æŒä¹…åŒ–é—®é¢˜ï¼ˆå¯èƒ½ä¸¢å¤±ï¼‰

ä¼˜åŒ–ï¼š
  æ‰¹é‡è·å–IDï¼š
    INCRBY id:generator 1000  # ä¸€æ¬¡è·å–1000ä¸ª
    â†’ è¿”å›10000
    â†’ æœ¬åœ°åˆ†é…ï¼š9001~10000
    â†’ å‡å°‘ç½‘ç»œè¯·æ±‚
```

**4. Snowflakeï¼ˆé›ªèŠ±ç®—æ³•ï¼‰**ï¼š
```
ç»“æ„ï¼ˆ64ä½ï¼‰ï¼š
  0 | 41ä½æ—¶é—´æˆ³ | 10ä½æœºå™¨ID | 12ä½åºåˆ—å·
  â†‘     â†‘           â†‘           â†‘
 ç¬¦å·   æ¯«ç§’       èŠ‚ç‚¹ID      è‡ªå¢åºå·
 
è¯¦ç»†ï¼š
  - 1ä½ç¬¦å·ä½ï¼š0ï¼ˆæ­£æ•°ï¼‰
  - 41ä½æ—¶é—´æˆ³ï¼šæ¯«ç§’çº§ï¼Œå¯ç”¨69å¹´
  - 10ä½æœºå™¨IDï¼šæœ€å¤š1024å°æœºå™¨
    - 5ä½æ•°æ®ä¸­å¿ƒID
    - 5ä½æœºå™¨ID
  - 12ä½åºåˆ—å·ï¼šåŒä¸€æ¯«ç§’å†…æœ€å¤š4096ä¸ªID

ç¤ºä¾‹ï¼š
  0 | 0001100101010101010101 | 00001 00010 | 000000000001
    â†‘          â†‘                 â†‘     â†‘         â†‘
   ç¬¦å·      æ—¶é—´æˆ³            æ•°æ®ä¸­å¿ƒ  æœºå™¨     åºåˆ—å·

ç‰¹ç‚¹ï¼š
  âœ… é«˜æ€§èƒ½ï¼ˆæœ¬åœ°ç”Ÿæˆï¼‰
  âœ… è¶‹åŠ¿æœ‰åºï¼ˆæ—¶é—´é€’å¢ï¼‰
  âœ… æ— ä¾èµ–
  âœ… åˆ†å¸ƒå¼

ç¼ºç‚¹ï¼š
  âŒ ä¾èµ–ç³»ç»Ÿæ—¶é’Ÿï¼ˆæ—¶é’Ÿå›æ‹¨é—®é¢˜ï¼‰
  âŒ æœºå™¨IDéœ€è¦é…ç½®
```

**Snowflakeå®ç°**ï¼š
```java
public class SnowflakeIdWorker {
    
    // èµ·å§‹æ—¶é—´æˆ³ï¼ˆ2024-01-01ï¼‰
    private final long twepoch = 1704067200000L;
    
    // æœºå™¨IDä½æ•°
    private final long workerIdBits = 5L;
    // æ•°æ®ä¸­å¿ƒIDä½æ•°
    private final long datacenterIdBits = 5L;
    // åºåˆ—å·ä½æ•°
    private final long sequenceBits = 12L;
    
    // æœºå™¨IDæœ€å¤§å€¼ï¼š31ï¼ˆ2^5-1ï¼‰
    private final long maxWorkerId = -1L ^ (-1L << workerIdBits);
    // æ•°æ®ä¸­å¿ƒIDæœ€å¤§å€¼ï¼š31
    private final long maxDatacenterId = -1L ^ (-1L << datacenterIdBits);
    
    // æœºå™¨IDå·¦ç§»ä½æ•°
    private final long workerIdShift = sequenceBits;
    // æ•°æ®ä¸­å¿ƒIDå·¦ç§»ä½æ•°
    private final long datacenterIdShift = sequenceBits + workerIdBits;
    // æ—¶é—´æˆ³å·¦ç§»ä½æ•°
    private final long timestampLeftShift = sequenceBits + workerIdBits + datacenterIdBits;
    
    // åºåˆ—å·æœ€å¤§å€¼ï¼š4095ï¼ˆ2^12-1ï¼‰
    private final long sequenceMask = -1L ^ (-1L << sequenceBits);
    
    private long workerId;
    private long datacenterId;
    private long sequence = 0L;
    private long lastTimestamp = -1L;
    
    public SnowflakeIdWorker(long workerId, long datacenterId) {
        if (workerId > maxWorkerId || workerId < 0) {
            throw new IllegalArgumentException("worker Id can't be greater than " + maxWorkerId);
        }
        if (datacenterId > maxDatacenterId || datacenterId < 0) {
            throw new IllegalArgumentException("datacenter Id can't be greater than " + maxDatacenterId);
        }
        this.workerId = workerId;
        this.datacenterId = datacenterId;
    }
    
    public synchronized long nextId() {
        long timestamp = System.currentTimeMillis();
        
        // æ—¶é’Ÿå›æ‹¨
        if (timestamp < lastTimestamp) {
            throw new RuntimeException("Clock moved backwards");
        }
        
        // åŒä¸€æ¯«ç§’å†…
        if (lastTimestamp == timestamp) {
            sequence = (sequence + 1) & sequenceMask;
            
            // åºåˆ—å·æº¢å‡ºï¼ˆè¶…è¿‡4095ï¼‰
            if (sequence == 0) {
                // ç­‰å¾…ä¸‹ä¸€æ¯«ç§’
                timestamp = tilNextMillis(lastTimestamp);
            }
        } else {
            // æ–°çš„æ¯«ç§’ï¼Œåºåˆ—å·é‡ç½®
            sequence = 0L;
        }
        
        lastTimestamp = timestamp;
        
        // ç»„è£…ID
        return ((timestamp - twepoch) << timestampLeftShift)
                | (datacenterId << datacenterIdShift)
                | (workerId << workerIdShift)
                | sequence;
    }
    
    private long tilNextMillis(long lastTimestamp) {
        long timestamp = System.currentTimeMillis();
        while (timestamp <= lastTimestamp) {
            timestamp = System.currentTimeMillis();
        }
        return timestamp;
    }
}

// ä½¿ç”¨
SnowflakeIdWorker idWorker = new SnowflakeIdWorker(1, 1);
long id = idWorker.nextId();  // 1234567890123456789
```

**5. ç¾å›¢Leaf**ï¼š
```
Leaf-Segmentï¼ˆå·æ®µæ¨¡å¼ï¼‰ï¼š
  - æ•°æ®åº“å­˜å‚¨å·æ®µ
  - åº”ç”¨æ‰¹é‡è·å–
  - æœ¬åœ°åˆ†é…

è¡¨ç»“æ„ï¼š
  CREATE TABLE leaf_alloc (
      biz_tag VARCHAR(128) PRIMARY KEY,
      max_id BIGINT NOT NULL,
      step INT NOT NULL
  );

æµç¨‹ï¼š
  1. åº”ç”¨å¯åŠ¨ï¼Œä»DBè·å–å·æ®µï¼š
     UPDATE leaf_alloc 
     SET max_id = max_id + step 
     WHERE biz_tag = 'order'
     RETURNING max_id;
     
     â†’ max_id = 10000, step = 1000
     â†’ åº”ç”¨è·å¾—ï¼š9001~10000
  
  2. æœ¬åœ°åˆ†é…IDï¼š9001, 9002, 9003, ...
  
  3. å·æ®µç”¨å®Œï¼Œå†æ¬¡ä»DBè·å–
  
  4. åŒbufferï¼š
     - buffer1ï¼š9001~10000ï¼ˆä½¿ç”¨ä¸­ï¼‰
     - buffer2ï¼š10001~11000ï¼ˆé¢„åŠ è½½ï¼‰
     - buffer1ç”¨åˆ°ä¸€å®šé˜ˆå€¼ï¼ˆå¦‚80%ï¼‰ï¼Œå¼‚æ­¥åŠ è½½buffer2

Leaf-Snowflakeï¼š
  - åŸºäºSnowflake
  - Zookeeperç®¡ç†æœºå™¨ID
  - è§£å†³æ—¶é’Ÿå›æ‹¨é—®é¢˜
```

**æ–¹æ¡ˆå¯¹æ¯”**ï¼š

| æ–¹æ¡ˆ | æ€§èƒ½ | æœ‰åºæ€§ | ä¾èµ– | é€‚ç”¨åœºæ™¯ |
|------|------|--------|------|----------|
| UUID | é«˜ | æ— åº | æ—  | ä¸´æ—¶ID |
| æ•°æ®åº“è‡ªå¢ | ä½ | æœ‰åº | MySQL | å°è§„æ¨¡ |
| Redis | é«˜ | æœ‰åº | Redis | ä¸­ç­‰è§„æ¨¡ |
| Snowflake | é«˜ | è¶‹åŠ¿æœ‰åº | æ—  | å¤§è§„æ¨¡æ¨è |
| Leaf | é«˜ | æœ‰åº/è¶‹åŠ¿æœ‰åº | MySQL/ZK | å¤§è§„æ¨¡ |

---

## åˆ†å¸ƒå¼äº‹åŠ¡

### Q5: 2PCï¼ˆä¸¤é˜¶æ®µæäº¤ï¼‰ï¼Ÿï¼ˆâ­â­â­â­â­ï¼‰

**å®šä¹‰**ï¼š
```
2PCï¼ˆTwo-Phase Commitï¼‰ï¼š
  - å¼ºä¸€è‡´æ€§åˆ†å¸ƒå¼äº‹åŠ¡
  - ä¸¤ä¸ªé˜¶æ®µï¼šå‡†å¤‡é˜¶æ®µã€æäº¤é˜¶æ®µ
  - åè°ƒè€…ï¼ˆCoordinatorï¼‰+ å‚ä¸è€…ï¼ˆParticipantï¼‰
```

**æµç¨‹**ï¼š
```
è§’è‰²ï¼š
  - åè°ƒè€…ï¼ˆTCï¼‰ï¼šäº‹åŠ¡åè°ƒå™¨
  - å‚ä¸è€…ï¼ˆRMï¼‰ï¼šèµ„æºç®¡ç†å™¨ï¼ˆæ•°æ®åº“ï¼‰

é˜¶æ®µ1ï¼šå‡†å¤‡é˜¶æ®µï¼ˆPrepareï¼‰
  1. TCå‘é€Prepareè¯·æ±‚ç»™æ‰€æœ‰RM
  2. RMæ‰§è¡Œäº‹åŠ¡æ“ä½œï¼ˆä½†ä¸æäº¤ï¼‰
  3. RMè®°å½•undo/redoæ—¥å¿—
  4. RMè¿”å›Yesæˆ–No
  
  TC â†’ RM1: Prepare
  TC â†’ RM2: Prepare
  TC â†’ RM3: Prepare
  
  RM1 â†’ TC: Yesï¼ˆå‡†å¤‡å¥½äº†ï¼‰
  RM2 â†’ TC: Yes
  RM3 â†’ TC: Noï¼ˆå‡†å¤‡å¤±è´¥ï¼‰

é˜¶æ®µ2ï¼šæäº¤é˜¶æ®µï¼ˆCommitï¼‰
  æƒ…å†µ1ï¼šæ‰€æœ‰RMè¿”å›Yes
    TC â†’ RM: Commit
    RM â†’ TC: ACK
    
  æƒ…å†µ2ï¼šä»»ä¸€RMè¿”å›No
    TC â†’ RM: Rollback
    RM â†’ TC: ACK
```

**ç¤ºä¾‹**ï¼š
```
åœºæ™¯ï¼šè·¨åº“è½¬è´¦
  ç”¨æˆ·Aè´¦æˆ·ï¼šdb1.accountï¼ˆä½™é¢1000ï¼‰
  ç”¨æˆ·Bè´¦æˆ·ï¼šdb2.accountï¼ˆä½™é¢500ï¼‰
  
  è½¬è´¦ï¼šAè½¬100ç»™B

æµç¨‹ï¼š
  é˜¶æ®µ1ï¼šPrepare
    TC â†’ db1: UPDATE account SET balance=900 WHERE user='A'
    TC â†’ db2: UPDATE account SET balance=600 WHERE user='B'
    
    db1: æ‰§è¡ŒæˆåŠŸï¼Œé”å®šèµ„æºï¼Œè¿”å›Yes
    db2: æ‰§è¡ŒæˆåŠŸï¼Œé”å®šèµ„æºï¼Œè¿”å›Yes
  
  é˜¶æ®µ2ï¼šCommit
    TC â†’ db1: COMMIT
    TC â†’ db2: COMMIT
    
    db1: æäº¤ï¼Œé‡Šæ”¾é”ï¼Œè¿”å›ACK
    db2: æäº¤ï¼Œé‡Šæ”¾é”ï¼Œè¿”å›ACK
    
  ç»“æœï¼š
    Aä½™é¢ï¼š900 âœ…
    Bä½™é¢ï¼š600 âœ…
```

**ä¼˜ç¼ºç‚¹**ï¼š
```
ä¼˜ç‚¹ï¼š
  âœ… å¼ºä¸€è‡´æ€§
  âœ… æ•°æ®åº“åŸç”Ÿæ”¯æŒï¼ˆXAåè®®ï¼‰

ç¼ºç‚¹ï¼š
  âŒ åŒæ­¥é˜»å¡ï¼šRMé”å®šèµ„æºï¼Œç­‰å¾…TCæŒ‡ä»¤
  âŒ å•ç‚¹æ•…éšœï¼šTCæŒ‚äº†ï¼ŒRMä¸€ç›´ç­‰å¾…
  âŒ æ•°æ®ä¸ä¸€è‡´ï¼š
     - TCå‘é€Commitç»™RM1æˆåŠŸ
     - TCå‘é€Commitç»™RM2å¤±è´¥ï¼ˆç½‘ç»œé—®é¢˜ï¼‰
     - RM1æäº¤ï¼ŒRM2è¶…æ—¶å›æ»š
     - æ•°æ®ä¸ä¸€è‡´
  âŒ æ€§èƒ½å·®ï¼šä¸¤é˜¶æ®µï¼Œå¤šæ¬¡ç½‘ç»œé€šä¿¡

é€‚ç”¨åœºæ™¯ï¼š
  - å¼ºä¸€è‡´æ€§è¦æ±‚
  - è·¨æ•°æ®åº“äº‹åŠ¡ï¼ˆå°‘é‡ï¼‰
  - æ€§èƒ½è¦æ±‚ä¸é«˜
```

---

### Q6: TCCï¼Ÿï¼ˆâ­â­â­â­â­ï¼‰

**å®šä¹‰**ï¼š
```
TCCï¼ˆTry-Confirm-Cancelï¼‰ï¼š
  - è¡¥å¿å‹äº‹åŠ¡
  - åº”ç”¨å±‚å®ç°
  - ä¸‰ä¸ªé˜¶æ®µï¼šTryã€Confirmã€Cancel

å¯¹æ¯”2PCï¼š
  - 2PCï¼šæ•°æ®åº“å±‚é¢
  - TCCï¼šä¸šåŠ¡å±‚é¢
  - TCCæ€§èƒ½æ›´å¥½
```

**ä¸‰ä¸ªé˜¶æ®µ**ï¼š
```
Tryï¼ˆå°è¯•ï¼‰ï¼š
  - èµ„æºæ£€æŸ¥
  - é¢„ç•™èµ„æº
  
Confirmï¼ˆç¡®è®¤ï¼‰ï¼š
  - æ‰§è¡ŒçœŸæ­£çš„ä¸šåŠ¡
  - ä½¿ç”¨Tryé¢„ç•™çš„èµ„æº
  
Cancelï¼ˆå–æ¶ˆï¼‰ï¼š
  - é‡Šæ”¾Tryé¢„ç•™çš„èµ„æº
  - å›æ»š
```

**ç¤ºä¾‹ï¼šè½¬è´¦**ï¼š
```
åœºæ™¯ï¼šAè½¬100ç»™B

æ•°æ®åº“è®¾è®¡ï¼š
  accountè¡¨ï¼š
    - user_id
    - balanceï¼ˆå¯ç”¨ä½™é¢ï¼‰
    - frozenï¼ˆå†»ç»“é‡‘é¢ï¼‰

Tryé˜¶æ®µï¼š
  Aè´¦æˆ·ï¼š
    balance = 1000 - 100 = 900  // æ‰£é™¤å¯ç”¨ä½™é¢
    frozen = 0 + 100 = 100      // å¢åŠ å†»ç»“é‡‘é¢
    
  Bè´¦æˆ·ï¼š
    balance = 500ï¼ˆä¸å˜ï¼‰
    frozen = 0 + 100 = 100      // é¢„ç•™100é¢åº¦

Confirmé˜¶æ®µï¼š
  Aè´¦æˆ·ï¼š
    frozen = 100 - 100 = 0      // é‡Šæ”¾å†»ç»“é‡‘é¢
    
  Bè´¦æˆ·ï¼š
    balance = 500 + 100 = 600   // å¢åŠ å¯ç”¨ä½™é¢
    frozen = 100 - 100 = 0      // é‡Šæ”¾å†»ç»“é‡‘é¢

Cancelé˜¶æ®µï¼š
  Aè´¦æˆ·ï¼š
    balance = 900 + 100 = 1000  // æ¢å¤å¯ç”¨ä½™é¢
    frozen = 100 - 100 = 0      // é‡Šæ”¾å†»ç»“é‡‘é¢
    
  Bè´¦æˆ·ï¼š
    frozen = 100 - 100 = 0      // é‡Šæ”¾å†»ç»“é‡‘é¢
```

**ä»£ç å®ç°**ï¼š
```java
// è´¦æˆ·æœåŠ¡
@Service
public class AccountService {
    
    // Tryï¼šå†»ç»“é‡‘é¢
    @Transactional
    public boolean tryFreeze(String userId, BigDecimal amount) {
        Account account = accountDao.selectByUserId(userId);
        
        // æ£€æŸ¥ä½™é¢
        if (account.getBalance().compareTo(amount) < 0) {
            return false;
        }
        
        // æ‰£å‡ä½™é¢ï¼Œå¢åŠ å†»ç»“é‡‘é¢
        account.setBalance(account.getBalance().subtract(amount));
        account.setFrozen(account.getFrozen().add(amount));
        
        accountDao.update(account);
        return true;
    }
    
    // Confirmï¼šç¡®è®¤æ‰£æ¬¾
    @Transactional
    public void confirmFreeze(String userId, BigDecimal amount) {
        Account account = accountDao.selectByUserId(userId);
        
        // å‡å°‘å†»ç»“é‡‘é¢
        account.setFrozen(account.getFrozen().subtract(amount));
        
        accountDao.update(account);
    }
    
    // Cancelï¼šå–æ¶ˆå†»ç»“
    @Transactional
    public void cancelFreeze(String userId, BigDecimal amount) {
        Account account = accountDao.selectByUserId(userId);
        
        // æ¢å¤ä½™é¢ï¼Œå‡å°‘å†»ç»“é‡‘é¢
        account.setBalance(account.getBalance().add(amount));
        account.setFrozen(account.getFrozen().subtract(amount));
        
        accountDao.update(account);
    }
}

// è½¬è´¦æœåŠ¡
@Service
public class TransferService {
    
    @Autowired
    private AccountService accountService;
    
    public void transfer(String fromUser, String toUser, BigDecimal amount) {
        boolean trySuccess = false;
        
        try {
            // Tryé˜¶æ®µ
            boolean tryFrom = accountService.tryFreeze(fromUser, amount);
            boolean tryTo = accountService.tryFreeze(toUser, amount.negate());
            
            trySuccess = tryFrom && tryTo;
            
            if (trySuccess) {
                // Confirmé˜¶æ®µ
                accountService.confirmFreeze(fromUser, amount);
                accountService.confirmFreeze(toUser, amount.negate());
            } else {
                // Cancelé˜¶æ®µ
                if (tryFrom) {
                    accountService.cancelFreeze(fromUser, amount);
                }
                if (tryTo) {
                    accountService.cancelFreeze(toUser, amount.negate());
                }
            }
        } catch (Exception e) {
            // Cancelé˜¶æ®µ
            if (trySuccess) {
                accountService.cancelFreeze(fromUser, amount);
                accountService.cancelFreeze(toUser, amount.negate());
            }
            throw e;
        }
    }
}
```

**TCCæ¡†æ¶ï¼šSeata**ï¼š
```java
// ä½¿ç”¨Seata TCC
@LocalTCC
public interface AccountTccService {
    
    @TwoPhaseBusinessAction(
        name = "tryFreeze",
        commitMethod = "confirm",
        rollbackMethod = "cancel"
    )
    boolean tryFreeze(
        @BusinessActionContextParameter(paramName = "userId") String userId,
        @BusinessActionContextParameter(paramName = "amount") BigDecimal amount
    );
    
    boolean confirm(BusinessActionContext context);
    
    boolean cancel(BusinessActionContext context);
}

@Service
public class AccountTccServiceImpl implements AccountTccService {
    
    @Override
    @Transactional
    public boolean tryFreeze(String userId, BigDecimal amount) {
        // Tryé€»è¾‘
    }
    
    @Override
    @Transactional
    public boolean confirm(BusinessActionContext context) {
        String userId = context.getActionContext("userId");
        BigDecimal amount = context.getActionContext("amount");
        // Confirmé€»è¾‘
    }
    
    @Override
    @Transactional
    public boolean cancel(BusinessActionContext context) {
        String userId = context.getActionContext("userId");
        BigDecimal amount = context.getActionContext("amount");
        // Cancelé€»è¾‘
    }
}
```

**ä¼˜ç¼ºç‚¹**ï¼š
```
ä¼˜ç‚¹ï¼š
  âœ… æ€§èƒ½å¥½ï¼ˆæ— é”ï¼‰
  âœ… æ— é˜»å¡
  âœ… çµæ´»

ç¼ºç‚¹ï¼š
  âŒ å®ç°å¤æ‚ï¼ˆä¸‰ä¸ªæ–¹æ³•ï¼‰
  âŒ éœ€è¦ä¸šåŠ¡æ”¹é€ 
  âŒ å¹‚ç­‰æ€§è¦æ±‚ï¼ˆConfirm/Cancelå¯èƒ½é‡å¤è°ƒç”¨ï¼‰
  âŒ ç©ºå›æ»šå¤„ç†ï¼ˆTryæœªæ‰§è¡Œï¼ŒCancelæ‰§è¡Œï¼‰
  âŒ æ‚¬æŒ‚å¤„ç†ï¼ˆCancelå…ˆæ‰§è¡Œï¼ŒTryåæ‰§è¡Œï¼‰

é€‚ç”¨åœºæ™¯ï¼š
  - æ€§èƒ½è¦æ±‚é«˜
  - è·¨æœåŠ¡äº‹åŠ¡
  - å¯ä»¥æ”¹é€ ä¸šåŠ¡
```

---

### Q7: æœ€ç»ˆä¸€è‡´æ€§æ–¹æ¡ˆï¼Ÿï¼ˆâ­â­â­â­â­ï¼‰

**æ–¹æ¡ˆ1ï¼šæ¶ˆæ¯é˜Ÿåˆ— + æœ¬åœ°äº‹åŠ¡**ï¼š
```
æµç¨‹ï¼š
  1. æœ¬åœ°äº‹åŠ¡æ‰§è¡Œä¸šåŠ¡
  2. å‘é€æ¶ˆæ¯åˆ°MQ
  3. æ¶ˆè´¹è€…æ¶ˆè´¹æ¶ˆæ¯
  4. æ‰§è¡Œè¿œç¨‹ä¸šåŠ¡
  5. æœ€ç»ˆä¸€è‡´

ç¤ºä¾‹ï¼šè®¢å• â†’ ç§¯åˆ†
  1. åˆ›å»ºè®¢å•ï¼ˆæœ¬åœ°äº‹åŠ¡ï¼‰
  2. å‘é€æ¶ˆæ¯ï¼š{"orderId": 123, "points": 100}
  3. ç§¯åˆ†æœåŠ¡æ¶ˆè´¹æ¶ˆæ¯
  4. å¢åŠ ç§¯åˆ†
  
é—®é¢˜ï¼š
  - æœ¬åœ°äº‹åŠ¡æˆåŠŸï¼Œå‘é€æ¶ˆæ¯å¤±è´¥ï¼Ÿ
  - æ¶ˆæ¯å‘é€æˆåŠŸï¼Œæ¶ˆè´¹å¤±è´¥ï¼Ÿ
```

**æ–¹æ¡ˆ2ï¼šäº‹åŠ¡æ¶ˆæ¯ï¼ˆRocketMQï¼‰**ï¼š
```
æµç¨‹ï¼š
  1. å‘é€åŠæ¶ˆæ¯ï¼ˆHalf Messageï¼‰åˆ°MQ
  2. MQè¿”å›æˆåŠŸ
  3. æ‰§è¡Œæœ¬åœ°äº‹åŠ¡
  4. æœ¬åœ°äº‹åŠ¡æˆåŠŸï¼šæäº¤æ¶ˆæ¯ï¼ˆCommitï¼‰
  5. æœ¬åœ°äº‹åŠ¡å¤±è´¥ï¼šå›æ»šæ¶ˆæ¯ï¼ˆRollbackï¼‰
  6. MQå®šæœŸå›æŸ¥äº‹åŠ¡çŠ¶æ€
  7. æ¶ˆè´¹è€…æ¶ˆè´¹æ¶ˆæ¯

ä»£ç ï¼š
@Service
public class OrderService {
    
    @Autowired
    private RocketMQTemplate rocketMQTemplate;
    
    public void createOrder(Order order) {
        // å‘é€äº‹åŠ¡æ¶ˆæ¯
        rocketMQTemplate.sendMessageInTransaction(
            "order-topic",
            MessageBuilder.withPayload(order).build(),
            order
        );
    }
}

// äº‹åŠ¡ç›‘å¬å™¨
@RocketMQTransactionListener
public class OrderTransactionListener implements RocketMQLocalTransactionListener {
    
    @Autowired
    private OrderService orderService;
    
    // æ‰§è¡Œæœ¬åœ°äº‹åŠ¡
    @Override
    public RocketMQLocalTransactionState executeLocalTransaction(Message msg, Object arg) {
        try {
            Order order = (Order) arg;
            orderService.saveOrder(order);  // æœ¬åœ°äº‹åŠ¡
            return RocketMQLocalTransactionState.COMMIT;  // æäº¤æ¶ˆæ¯
        } catch (Exception e) {
            return RocketMQLocalTransactionState.ROLLBACK;  // å›æ»šæ¶ˆæ¯
        }
    }
    
    // å›æŸ¥æœ¬åœ°äº‹åŠ¡çŠ¶æ€
    @Override
    public RocketMQLocalTransactionState checkLocalTransaction(Message msg) {
        // æŸ¥è¯¢è®¢å•æ˜¯å¦åˆ›å»ºæˆåŠŸ
        Order order = orderService.getById(orderId);
        if (order != null) {
            return RocketMQLocalTransactionState.COMMIT;
        } else {
            return RocketMQLocalTransactionState.ROLLBACK;
        }
    }
}

æµç¨‹å›¾ï¼š
  è®¢å•æœåŠ¡                    RocketMQ                  ç§¯åˆ†æœåŠ¡
     |                          |                          |
     |-- 1.å‘é€åŠæ¶ˆæ¯ ---------->|                          |
     |<-- 2.è¿”å›æˆåŠŸ ------------|                          |
     |                          |                          |
     |-- 3.æ‰§è¡Œæœ¬åœ°äº‹åŠ¡          |                          |
     |                          |                          |
     |-- 4.æäº¤æ¶ˆæ¯ ------------>|                          |
     |                          |-- 5.æ¨é€æ¶ˆæ¯ ----------->|
     |                          |<-- 6.æ¶ˆè´¹æˆåŠŸ -----------|
     
ç‰¹ç‚¹ï¼š
  âœ… ä¿è¯æ¶ˆæ¯ä¸€å®šå‘é€
  âœ… æœ€ç»ˆä¸€è‡´æ€§
  âœ… æ— éœ€ä¸šåŠ¡æ”¹é€ 
```

**æ–¹æ¡ˆ3ï¼šSagaé•¿äº‹åŠ¡**ï¼š
```
å®šä¹‰ï¼š
  - å°†åˆ†å¸ƒå¼äº‹åŠ¡æ‹†åˆ†ä¸ºå¤šä¸ªæœ¬åœ°äº‹åŠ¡
  - æ¯ä¸ªæœ¬åœ°äº‹åŠ¡æœ‰å¯¹åº”çš„è¡¥å¿æ“ä½œ
  - æ­£å‘æ‰§è¡Œæˆ–åå‘è¡¥å¿

ç¤ºä¾‹ï¼šä¸‹å•æµç¨‹
  T1: åˆ›å»ºè®¢å•
  T2: æ‰£å‡åº“å­˜
  T3: æ‰£å‡ä½™é¢
  T4: åˆ›å»ºç‰©æµå•
  
  è¡¥å¿æ“ä½œï¼š
  C1: åˆ é™¤è®¢å•
  C2: æ¢å¤åº“å­˜
  C3: æ¢å¤ä½™é¢
  C4: å–æ¶ˆç‰©æµå•

æ­£å¸¸æµç¨‹ï¼š
  T1 â†’ T2 â†’ T3 â†’ T4 âœ…

å¼‚å¸¸æµç¨‹ï¼ˆT3å¤±è´¥ï¼‰ï¼š
  T1 â†’ T2 â†’ T3âŒ â†’ C2 â†’ C1

å®ç°ï¼šSeata Saga
  - çŠ¶æ€æœºæ¨¡å¼
  - JSONå®šä¹‰æµç¨‹
  - è‡ªåŠ¨è¡¥å¿
```

**å¯¹æ¯”æ€»ç»“**ï¼š

| æ–¹æ¡ˆ | ä¸€è‡´æ€§ | æ€§èƒ½ | å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ |
|------|--------|------|--------|----------|
| 2PC | å¼ºä¸€è‡´ | ä½ | ä½ | è·¨åº“äº‹åŠ¡ã€å°‘é‡ |
| TCC | æœ€ç»ˆä¸€è‡´ | é«˜ | é«˜ | è·¨æœåŠ¡ã€é«˜æ€§èƒ½ |
| äº‹åŠ¡æ¶ˆæ¯ | æœ€ç»ˆä¸€è‡´ | é«˜ | ä¸­ | å¼‚æ­¥åœºæ™¯ã€æ¨è |
| Saga | æœ€ç»ˆä¸€è‡´ | é«˜ | ä¸­ | é•¿äº‹åŠ¡æµç¨‹ |

---

## æœåŠ¡æ²»ç†

### Q8: é™æµã€é™çº§ã€ç†”æ–­ï¼Ÿï¼ˆâ­â­â­â­â­ï¼‰

**1. é™æµï¼ˆRate Limitingï¼‰**ï¼š
```
å®šä¹‰ï¼š
  - é™åˆ¶è¯·æ±‚é€Ÿç‡
  - ä¿æŠ¤ç³»ç»Ÿä¸è¢«å‹å®

ç®—æ³•ï¼š

1. å›ºå®šçª—å£è®¡æ•°å™¨ï¼š
   æ—¶é—´çª—å£ï¼š1ç§’
   é™æµé˜ˆå€¼ï¼š100
   
   0s-1sï¼šè®¡æ•°100æ¬¡ï¼Œæ‹’ç»åç»­è¯·æ±‚
   1s-2sï¼šè®¡æ•°é‡ç½®ï¼Œé‡æ–°è®¡æ•°
   
   ç¼ºç‚¹ï¼šè¾¹ç•Œé—®é¢˜
     0.5sï¼š50æ¬¡
     1.5sï¼š50æ¬¡
     â†’ 1ç§’å†…å®é™…100æ¬¡ï¼ˆçªåˆºï¼‰

2. æ»‘åŠ¨çª—å£è®¡æ•°å™¨ï¼š
   æ—¶é—´çª—å£æ‹†åˆ†ï¼š100ms * 10
   
   [10][10][10][10][10][10][10][10][10][10]
    â†‘                                      â†‘
   0ms                                  1000ms
   
   æ¯100msç»Ÿè®¡ä¸€æ¬¡
   1ç§’å†…æ€»è¯·æ±‚ <= 100
   
   ä¼˜ç‚¹ï¼šå¹³æ»‘é™æµ

3. æ¼æ¡¶ç®—æ³•ï¼ˆLeaky Bucketï¼‰ï¼š
   è¯·æ±‚è¿›å…¥æ¡¶ï¼ŒæŒ‰å›ºå®šé€Ÿç‡æµå‡º
   
         è¯·æ±‚ â†“
       +--------+
       |  æ¼æ¡¶  |
       |        |
       +---v----+
         å›ºå®šé€Ÿç‡
         
   ç‰¹ç‚¹ï¼š
     - è¯·æ±‚é€Ÿç‡ä¸å‡åŒ€
     - å¤„ç†é€Ÿç‡æ’å®š
     - æ¡¶æ»¡åˆ™æ‹’ç»

4. ä»¤ç‰Œæ¡¶ç®—æ³•ï¼ˆToken Bucketï¼‰ï¼š
   æŒ‰å›ºå®šé€Ÿç‡ç”Ÿæˆä»¤ç‰Œ
   è¯·æ±‚è·å–ä»¤ç‰Œæ‰èƒ½é€šè¿‡
   
   å®šæ—¶ç”Ÿæˆä»¤ç‰Œ â†’  [ä»¤ç‰Œæ¡¶]
                     â†“
                   è¯·æ±‚è·å–ä»¤ç‰Œ
                   
   ç‰¹ç‚¹ï¼š
     - å…è®¸çªå‘æµé‡ï¼ˆæ¡¶å†…æœ‰ä»¤ç‰Œï¼‰
     - å¹³å‡é€Ÿç‡å—é™
     - Guava RateLimiterå®ç°
```

**é™æµå®ç°**ï¼š
```java
// Guava RateLimiterï¼ˆä»¤ç‰Œæ¡¶ï¼‰
public class RateLimiterDemo {
    
    // æ¯ç§’2ä¸ªä»¤ç‰Œ
    private final RateLimiter rateLimiter = RateLimiter.create(2.0);
    
    public void doSomething() {
        // å°è¯•è·å–ä»¤ç‰Œï¼ˆé˜»å¡ï¼‰
        rateLimiter.acquire();
        System.out.println("æ‰§è¡Œä¸šåŠ¡ï¼š" + System.currentTimeMillis());
    }
    
    public void doSomethingNonBlocking() {
        // å°è¯•è·å–ä»¤ç‰Œï¼ˆéé˜»å¡ï¼Œè¶…æ—¶1ç§’ï¼‰
        if (rateLimiter.tryAcquire(1, TimeUnit.SECONDS)) {
            System.out.println("æ‰§è¡Œä¸šåŠ¡");
        } else {
            System.out.println("é™æµ");
        }
    }
}

// Redisæ»‘åŠ¨çª—å£
public class RedisRateLimiter {
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    public boolean isAllowed(String key, int limit, int window) {
        long now = System.currentTimeMillis();
        long windowStart = now - window * 1000;
        
        // Luaè„šæœ¬ï¼ˆåŸå­æ“ä½œï¼‰
        String script =
            "redis.call('zremrangebyscore', KEYS[1], 0, ARGV[1]) " +  // åˆ é™¤è¿‡æœŸæ•°æ®
            "local count = redis.call('zcard', KEYS[1]) " +           // ç»Ÿè®¡æ•°é‡
            "if count < tonumber(ARGV[2]) then " +
            "    redis.call('zadd', KEYS[1], ARGV[3], ARGV[3]) " +    // æ·»åŠ å½“å‰è¯·æ±‚
            "    redis.call('expire', KEYS[1], ARGV[4]) " +           // è®¾ç½®è¿‡æœŸæ—¶é—´
            "    return 1 " +
            "else " +
            "    return 0 " +
            "end";
        
        Long result = redisTemplate.execute(
            new DefaultRedisScript<>(script, Long.class),
            Collections.singletonList(key),
            String.valueOf(windowStart),
            String.valueOf(limit),
            String.valueOf(now),
            String.valueOf(window)
        );
        
        return result != null && result == 1;
    }
}

// ä½¿ç”¨
if (rateLimiter.isAllowed("api:/user/list", 100, 1)) {
    // æ‰§è¡Œä¸šåŠ¡
} else {
    // é™æµ
    throw new RateLimitException("è¯·æ±‚è¿‡äºé¢‘ç¹");
}
```

**2. é™çº§ï¼ˆDegradationï¼‰**ï¼š
```
å®šä¹‰ï¼š
  - å…³é—­éæ ¸å¿ƒåŠŸèƒ½
  - ä¿è¯æ ¸å¿ƒåŠŸèƒ½å¯ç”¨

åœºæ™¯ï¼š
  æ ¸å¿ƒåŠŸèƒ½ï¼šä¸‹å•ã€æ”¯ä»˜
  éæ ¸å¿ƒåŠŸèƒ½ï¼šæ¨èã€è¯„è®ºã€å¹¿å‘Š
  
  é«˜å³°æœŸï¼š
    âœ… ä¿è¯ä¸‹å•ã€æ”¯ä»˜
    âŒ å…³é—­æ¨èã€è¯„è®ºï¼ˆè¿”å›é»˜è®¤å€¼ï¼‰

å®ç°ï¼š
@Service
public class ProductService {
    
    @Autowired
    private RecommendService recommendService;
    
    @Autowired
    private ConfigService configService;
    
    public Product getById(Long id) {
        Product product = productDao.selectById(id);
        
        // å¼€å…³æ§åˆ¶é™çº§
        if (configService.isRecommendEnabled()) {
            // æŸ¥è¯¢æ¨èå•†å“
            List<Product> recommend = recommendService.getRecommend(id);
            product.setRecommend(recommend);
        } else {
            // é™çº§ï¼šè¿”å›ç©ºåˆ—è¡¨
            product.setRecommend(Collections.emptyList());
        }
        
        return product;
    }
}

// Sentinelé™çº§
@SentinelResource(value = "getRecommend", 
                  fallback = "fallbackRecommend")
public List<Product> getRecommend(Long productId) {
    return recommendService.get(productId);
}

public List<Product> fallbackRecommend(Long productId, Throwable ex) {
    // é™çº§é€»è¾‘
    return Collections.emptyList();
}
```

**3. ç†”æ–­ï¼ˆCircuit Breakerï¼‰**ï¼š
```
å®šä¹‰ï¼š
  - æ£€æµ‹æœåŠ¡å¼‚å¸¸
  - å¿«é€Ÿå¤±è´¥ï¼Œä¸è°ƒç”¨
  - å®šæœŸå°è¯•æ¢å¤

ä¸‰ç§çŠ¶æ€ï¼š
  1. Closedï¼ˆå…³é—­ï¼‰ï¼š
     - æ­£å¸¸è°ƒç”¨
     - ç»Ÿè®¡å¤±è´¥ç‡
     - è¾¾åˆ°é˜ˆå€¼ â†’ Open
  
  2. Openï¼ˆæ‰“å¼€ï¼‰ï¼š
     - å¿«é€Ÿå¤±è´¥
     - ä¸è°ƒç”¨æœåŠ¡
     - ä¸€æ®µæ—¶é—´å â†’ Half Open
  
  3. Half Openï¼ˆåŠå¼€ï¼‰ï¼š
     - å°è¯•è°ƒç”¨
     - æˆåŠŸ â†’ Closed
     - å¤±è´¥ â†’ Open

æµç¨‹ï¼š
  Closed â†’ å¤±è´¥ç‡50% â†’ Open â†’ 10ç§’å â†’ Half Open
    â†‘                                      â†“
    â† â† â† â† â† â† æˆåŠŸ â† â† â† â† â† â† â† â† â† â† â†
                         å¤±è´¥
                          â†“
                        Open

å®ç°ï¼šHystrix/Resilience4j
@Service
public class UserService {
    
    @HystrixCommand(
        fallbackMethod = "fallback",
        commandProperties = {
            // ç†”æ–­å™¨å¼€å¯é˜ˆå€¼ï¼ˆ10ä¸ªè¯·æ±‚ï¼‰
            @HystrixProperty(name = "circuitBreaker.requestVolumeThreshold", value = "10"),
            // å¤±è´¥ç‡é˜ˆå€¼ï¼ˆ50%ï¼‰
            @HystrixProperty(name = "circuitBreaker.errorThresholdPercentage", value = "50"),
            // ç†”æ–­æ—¶é—´ï¼ˆ5ç§’ï¼‰
            @HystrixProperty(name = "circuitBreaker.sleepWindowInMilliseconds", value = "5000")
        }
    )
    public User getById(Long id) {
        return restTemplate.getForObject("http://user-service/user/" + id, User.class);
    }
    
    public User fallback(Long id) {
        // ç†”æ–­é™çº§
        return new User();
    }
}

Sentinelç†”æ–­ï¼š
@SentinelResource(value = "getUser", 
                  blockHandler = "blockHandler")
public User getById(Long id) {
    return userClient.getById(id);
}

public User blockHandler(Long id, BlockException ex) {
    // ç†”æ–­é™çº§
    return new User();
}
```

**å¯¹æ¯”æ€»ç»“**ï¼š

| æ¦‚å¿µ | ç›®çš„ | è§¦å‘æ¡ä»¶ | æ¢å¤ |
|------|------|----------|------|
| é™æµ | ä¿æŠ¤ç³»ç»Ÿ | è¯·æ±‚é‡å¤§ | ç«‹å³ |
| é™çº§ | ä¿è¯æ ¸å¿ƒåŠŸèƒ½ | ä¸»åŠ¨/è¢«åŠ¨ | æ‰‹åŠ¨æ¢å¤ |
| ç†”æ–­ | å¿«é€Ÿå¤±è´¥ | å¤±è´¥ç‡é«˜ | è‡ªåŠ¨å°è¯• |

---

## æ¶ˆæ¯é˜Ÿåˆ—

### Q9: æ¶ˆæ¯ä¸¢å¤±å¦‚ä½•é¿å…ï¼Ÿï¼ˆâ­â­â­â­â­ï¼‰

**æ¶ˆæ¯ä¸¢å¤±åœºæ™¯**ï¼š
```
1. ç”Ÿäº§è€…å‘é€ä¸¢å¤±ï¼š
   ç”Ÿäº§è€… â†’ MQ  âŒ ç½‘ç»œæ•…éšœ

2. MQå­˜å‚¨ä¸¢å¤±ï¼š
   MQå†…å­˜ â†’ ç£ç›˜  âŒ MQå®•æœºï¼ˆæœªæŒä¹…åŒ–ï¼‰

3. æ¶ˆè´¹è€…æ¶ˆè´¹ä¸¢å¤±ï¼š
   æ¶ˆè´¹è€…æ‹‰å–æ¶ˆæ¯ â†’ è‡ªåŠ¨ACK â†’ å¤„ç†å¤±è´¥  âŒ
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

**1. ç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶**ï¼š
```java
// RabbitMQç”Ÿäº§è€…ç¡®è®¤
@Configuration
public class RabbitConfig {
    
    @Bean
    public RabbitTemplate rabbitTemplate(ConnectionFactory connectionFactory) {
        RabbitTemplate template = new RabbitTemplate(connectionFactory);
        
        // å¼€å¯ç¡®è®¤æ¨¡å¼
        template.setConfirmCallback((correlationData, ack, cause) -> {
            if (ack) {
                System.out.println("æ¶ˆæ¯å‘é€æˆåŠŸ");
            } else {
                System.out.println("æ¶ˆæ¯å‘é€å¤±è´¥ï¼š" + cause);
                // é‡è¯•æˆ–è®°å½•æ—¥å¿—
            }
        });
        
        return template;
    }
}

// RocketMQåŒæ­¥å‘é€
@Service
public class Producer {
    
    @Autowired
    private RocketMQTemplate rocketMQTemplate;
    
    public void send(String msg) {
        // åŒæ­¥å‘é€ï¼ˆç­‰å¾…å“åº”ï¼‰
        SendResult result = rocketMQTemplate.syncSend("topic", msg);
        
        if (result.getSendStatus() == SendStatus.SEND_OK) {
            System.out.println("å‘é€æˆåŠŸ");
        } else {
            System.out.println("å‘é€å¤±è´¥");
            // é‡è¯•
        }
    }
}
```

**2. MQæŒä¹…åŒ–**ï¼š
```java
// RabbitMQæŒä¹…åŒ–
@Bean
public Queue queue() {
    // durable=trueï¼šé˜Ÿåˆ—æŒä¹…åŒ–
    return new Queue("my-queue", true);
}

@Bean
public DirectExchange exchange() {
    // durable=trueï¼šäº¤æ¢æœºæŒä¹…åŒ–
    return new DirectExchange("my-exchange", true, false);
}

// æ¶ˆæ¯æŒä¹…åŒ–
rabbitTemplate.convertAndSend("my-exchange", "routing-key", 
    message,
    msg -> {
        msg.getMessageProperties().setDeliveryMode(MessageDeliveryMode.PERSISTENT);
        return msg;
    });

// RocketMQæŒä¹…åŒ–ï¼ˆé»˜è®¤ï¼‰
// æ¶ˆæ¯å†™å…¥CommitLogï¼ˆç£ç›˜ï¼‰
```

**3. æ¶ˆè´¹è€…æ‰‹åŠ¨ACK**ï¼š
```java
// RabbitMQæ‰‹åŠ¨ACK
@Configuration
public class RabbitMQConfig {
    
    @Bean
    public SimpleRabbitListenerContainerFactory rabbitListenerContainerFactory(
            ConnectionFactory connectionFactory) {
        SimpleRabbitListenerContainerFactory factory = 
            new SimpleRabbitListenerContainerFactory();
        factory.setConnectionFactory(connectionFactory);
        // æ‰‹åŠ¨ACK
        factory.setAcknowledgeMode(AcknowledgeMode.MANUAL);
        return factory;
    }
}

@RabbitListener(queues = "my-queue")
public void consume(Message message, Channel channel) throws IOException {
    try {
        String msg = new String(message.getBody());
        System.out.println("æ¶ˆè´¹æ¶ˆæ¯ï¼š" + msg);
        
        // å¤„ç†ä¸šåŠ¡
        processMessage(msg);
        
        // æ‰‹åŠ¨ACK
        channel.basicAck(message.getMessageProperties().getDeliveryTag(), false);
        
    } catch (Exception e) {
        // æ‹’ç»æ¶ˆæ¯ï¼Œé‡æ–°å…¥é˜Ÿ
        channel.basicNack(message.getMessageProperties().getDeliveryTag(), false, true);
    }
}

// RocketMQæ¶ˆè´¹çŠ¶æ€
@RocketMQMessageListener(topic = "my-topic", consumerGroup = "my-group")
public class Consumer implements RocketMQListener<String> {
    
    @Override
    public void onMessage(String message) {
        try {
            // å¤„ç†ä¸šåŠ¡
            processMessage(message);
            
            // è¿”å›æˆåŠŸï¼ˆè‡ªåŠ¨ACKï¼‰
            // return ConsumeConcurrentlyStatus.CONSUME_SUCCESS;
        } catch (Exception e) {
            // è¿”å›å¤±è´¥ï¼ˆé‡æ–°æ¶ˆè´¹ï¼‰
            // return ConsumeConcurrentlyStatus.RECONSUME_LATER;
            throw new RuntimeException(e);
        }
    }
}
```

---

### Q10: æ¶ˆæ¯å¹‚ç­‰æ€§ï¼Ÿï¼ˆâ­â­â­â­â­ï¼‰

**é—®é¢˜**ï¼š
```
æ¶ˆæ¯é‡å¤æ¶ˆè´¹ï¼š
  1. ç”Ÿäº§è€…é‡å¤å‘é€
  2. MQé‡å¤æŠ•é€’ï¼ˆç½‘ç»œæŠ–åŠ¨ã€ACKä¸¢å¤±ï¼‰
  3. æ¶ˆè´¹è€…é‡è¯•

ç¤ºä¾‹ï¼š
  æ¶ˆæ¯ï¼šæ‰£å‡åº“å­˜10ä¸ª
  
  æ¶ˆè´¹1æ¬¡ï¼šåº“å­˜-10 âœ…
  æ¶ˆè´¹2æ¬¡ï¼šåº“å­˜-20 âŒï¼ˆé‡å¤æ‰£å‡ï¼‰
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

**1. å”¯ä¸€ID + æ•°æ®åº“å»é‡**ï¼š
```java
// æ¶ˆæ¯è¡¨
CREATE TABLE message_log (
    message_id VARCHAR(64) PRIMARY KEY,
    æ¶ˆè´¹çŠ¶æ€ TINYINT,
    create_time TIMESTAMP
);

@Service
public class Consumer {
    
    @Transactional
    public void consume(Message message) {
        String messageId = message.getMessageId();
        
        // 1. æŸ¥è¯¢æ¶ˆæ¯æ˜¯å¦å·²æ¶ˆè´¹
        MessageLog log = messageLogDao.selectById(messageId);
        if (log != null) {
            // å·²æ¶ˆè´¹ï¼Œç›´æ¥è¿”å›
            return;
        }
        
        // 2. å¤„ç†ä¸šåŠ¡
        processMessage(message);
        
        // 3. è®°å½•æ¶ˆæ¯æ—¥å¿—
        MessageLog newLog = new MessageLog();
        newLog.setMessageId(messageId);
        newLog.setStatus(1);
        messageLogDao.insert(newLog);
    }
}

é—®é¢˜ï¼š
  - éœ€è¦é¢å¤–å­˜å‚¨
  - æ€§èƒ½å¼€é”€ï¼ˆæŸ¥è¯¢+æ’å…¥ï¼‰
```

**2. Rediså»é‡**ï¼š
```java
@Service
public class Consumer {
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    public void consume(Message message) {
        String messageId = message.getMessageId();
        String key = "message:consumed:" + messageId;
        
        // 1. SETNXå»é‡
        Boolean success = redisTemplate.opsForValue()
            .setIfAbsent(key, "1", 1, TimeUnit.DAYS);
        
        if (Boolean.FALSE.equals(success)) {
            // å·²æ¶ˆè´¹
            return;
        }
        
        // 2. å¤„ç†ä¸šåŠ¡
        try {
            processMessage(message);
        } catch (Exception e) {
            // å¤±è´¥ï¼Œåˆ é™¤æ ‡è®°ï¼ˆå…è®¸é‡è¯•ï¼‰
            redisTemplate.delete(key);
            throw e;
        }
    }
}
```

**3. ä¸šåŠ¡å¹‚ç­‰æ€§**ï¼š
```java
// æ–¹æ¡ˆ1ï¼šå”¯ä¸€çº¦æŸ
CREATE TABLE `order` (
    id BIGINT PRIMARY KEY,
    order_no VARCHAR(64) UNIQUE,  -- å”¯ä¸€çº¦æŸ
    ...
);

// æ’å…¥è®¢å•ï¼ˆé‡å¤æ’å…¥å¤±è´¥ï¼‰
INSERT INTO `order` (order_no, ...) VALUES ('2024010112345', ...);

// æ–¹æ¡ˆ2ï¼šä¹è§‚é”
UPDATE product 
SET stock = stock - 10, version = version + 1
WHERE id = 1 AND version = 10;
-- é‡å¤æ‰§è¡Œï¼Œversionå·²å˜åŒ–ï¼Œupdateå¤±è´¥

// æ–¹æ¡ˆ3ï¼šçŠ¶æ€æœº
UPDATE `order`
SET status = 'å·²æ”¯ä»˜'
WHERE order_no = '2024010112345'
  AND status = 'å¾…æ”¯ä»˜';  -- çŠ¶æ€æ ¡éªŒ
-- é‡å¤æ‰§è¡Œï¼ŒçŠ¶æ€å·²æ˜¯'å·²æ”¯ä»˜'ï¼Œupdateå¤±è´¥

// æ–¹æ¡ˆ4ï¼šåˆ†å¸ƒå¼é”
public void consume(Message message) {
    String lockKey = "lock:order:" + message.getOrderNo();
    RLock lock = redisson.getLock(lockKey);
    
    try {
        if (lock.tryLock()) {
            // å¤„ç†ä¸šåŠ¡
            processOrder(message);
        }
    } finally {
        if (lock.isHeldByCurrentThread()) {
            lock.unlock();
        }
    }
}
```

---

## ğŸ’¡ é¢è¯•æŠ€å·§

### é«˜é¢‘è€ƒç‚¹
```
â­â­â­â­â­ï¼ˆå¿…è€ƒï¼‰ï¼š
  - CAPç†è®º
  - åˆ†å¸ƒå¼IDç”Ÿæˆï¼ˆSnowflakeï¼‰
  - 2PC vs TCC
  - é™æµã€é™çº§ã€ç†”æ–­
  - æ¶ˆæ¯ä¸¢å¤±ã€å¹‚ç­‰æ€§

â­â­â­â­ï¼ˆé«˜é¢‘ï¼‰ï¼š
  - BASEç†è®º
  - ä¸€è‡´æ€§Hash
  - æœ€ç»ˆä¸€è‡´æ€§æ–¹æ¡ˆ
  - æ¶ˆæ¯é¡ºåºæ€§

â­â­â­ï¼ˆä¸­é¢‘ï¼‰ï¼š
  - 3PC
  - Saga
  - Raftåè®®
```

---

**æœ€åæ›´æ–°**: 2025-10-29  
**æ–‡æ¡£çŠ¶æ€**: âœ… å®Œæ•´å†…å®¹ï¼ˆ900+è¡Œï¼‰

ğŸ’¡ **è®°ä½**: åˆ†å¸ƒå¼ç³»ç»Ÿæ˜¯å¤§å‚å¿…è€ƒï¼ŒCAPã€äº‹åŠ¡ã€æœåŠ¡æ²»ç†æ˜¯æ ¸å¿ƒï¼
