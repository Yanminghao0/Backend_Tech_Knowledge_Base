# ç½‘ç»œé—®é¢˜æ’æŸ¥

> å®æˆ˜æŒ‡å—ï¼šå¦‚ä½•è¯Šæ–­å’Œè§£å†³ç”Ÿäº§ç¯å¢ƒä¸­çš„ç½‘ç»œè¿æ¥é—®é¢˜ã€å»¶è¿Ÿå’Œæ•…éšœ

## ğŸ“‹ ç›®å½•
- [å¸¸è§ç½‘ç»œé—®é¢˜ç±»å‹](#å¸¸è§ç½‘ç»œé—®é¢˜ç±»å‹)
- [ç½‘ç»œæ’æŸ¥å·¥å…·](#ç½‘ç»œæ’æŸ¥å·¥å…·)
- [ç½‘ç»œå»¶è¿Ÿé—®é¢˜](#ç½‘ç»œå»¶è¿Ÿé—®é¢˜)
- [è¿æ¥è¶…æ—¶é—®é¢˜](#è¿æ¥è¶…æ—¶é—®é¢˜)
- [ç½‘ç»œä¸¢åŒ…é—®é¢˜](#ç½‘ç»œä¸¢åŒ…é—®é¢˜)
- [DNSè§£æé—®é¢˜](#dnsè§£æé—®é¢˜)
- [é˜²ç«å¢™ä¸å®‰å…¨ç»„é—®é¢˜](#é˜²ç«å¢™ä¸å®‰å…¨ç»„é—®é¢˜)
- [å…¸å‹æ¡ˆä¾‹åˆ†æ](#å…¸å‹æ¡ˆä¾‹åˆ†æ)
- [ç½‘ç»œç›‘æ§ä¸å‘Šè­¦](#ç½‘ç»œç›‘æ§ä¸å‘Šè­¦)

---

## å¸¸è§ç½‘ç»œé—®é¢˜ç±»å‹

### 1. ç½‘ç»œå»¶è¿Ÿè¿‡é«˜
**ç—‡çŠ¶**ï¼š
- æœåŠ¡é—´è°ƒç”¨å“åº”æ—¶é—´é•¿
- è¿œç¨‹èµ„æºè®¿é—®ç¼“æ…¢
- ç”¨æˆ·åé¦ˆé¡µé¢åŠ è½½å»¶è¿Ÿ

### 2. è¿æ¥è¶…æ—¶
**ç—‡çŠ¶**ï¼š
- æ¥å£è°ƒç”¨è¿”å›TimeoutException
- TCPè¿æ¥å»ºç«‹å¤±è´¥
- æœåŠ¡å¥åº·æ£€æŸ¥å¤±è´¥

### 3. ç½‘ç»œä¸¢åŒ…
**ç—‡çŠ¶**ï¼š
- æ•°æ®ä¼ è¾“ä¸å®Œæ•´
- è§†é¢‘/æ–‡ä»¶ä¼ è¾“ä¸­æ–­
- åº”ç”¨é—´æ­‡æ€§æ–­å¼€è¿æ¥

### 4. DNSè§£æé—®é¢˜
**ç—‡çŠ¶**ï¼š
- åŸŸåæ— æ³•è§£æ
- è§£æç»“æœé”™è¯¯
- è§£æå»¶è¿Ÿè¿‡é•¿

### 5. é˜²ç«å¢™/å®‰å…¨ç»„é™åˆ¶
**ç—‡çŠ¶**ï¼š
- ç‰¹å®šç«¯å£æ— æ³•è®¿é—®
- è·¨åŒºåŸŸè¿æ¥è¢«é˜»æ–­
- é—´æ­‡æ€§è¿æ¥å¤±è´¥

---

## ç½‘ç»œæ’æŸ¥å·¥å…·

### 1. åŸºç¡€ç½‘ç»œå·¥å…·

**ping - æ£€æŸ¥ç½‘ç»œè¿é€šæ€§**
```bash
# åŸºæœ¬ç”¨æ³•
ping api.example.com

# æŒ‡å®šå‘é€åŒ…æ•°
ping -c 5 api.example.com

# æŒ‡å®šè¶…æ—¶æ—¶é—´(ç§’)
ping -W 2 api.example.com

# æŒ‡å®šåŒ…å¤§å°(å­—èŠ‚)
ping -s 1024 api.example.com
```

**traceroute - è·Ÿè¸ªç½‘ç»œè·¯å¾„**
```bash
# åŸºæœ¬ç”¨æ³•
traceroute api.example.com

# ä½¿ç”¨ICMPåè®®
traceroute -I api.example.com

# æŒ‡å®šæœ€å¤§è·³æ•°
traceroute -m 20 api.example.com

# æ˜¾ç¤ºIPå’Œä¸»æœºå
traceroute -n api.example.com
```

**mtr - ç»“åˆpingå’Œtracerouteçš„åŠŸèƒ½**
```bash
# åŸºæœ¬ç”¨æ³•
mtr api.example.com

# ç”ŸæˆæŠ¥å‘Š
mtr --report api.example.com

# é™åˆ¶æŠ¥å‘Šè¡Œæ•°
mtr --report-cycles 10 api.example.com
```

### 2. TCPè¿æ¥å·¥å…·

**telnet - æµ‹è¯•ç«¯å£è¿é€šæ€§**
```bash
# æµ‹è¯•HTTPç«¯å£
telnet api.example.com 80

# æµ‹è¯•HTTPSç«¯å£
telnet api.example.com 443
```

**nc(netcat) - å¤šåŠŸèƒ½ç½‘ç»œå·¥å…·**
```bash
# æµ‹è¯•ç«¯å£è¿é€šæ€§
nc -zv api.example.com 8080

# ç«¯å£ç›‘å¬
nc -l 8080

# ä¼ è¾“æ–‡ä»¶
echo "test" | nc api.example.com 8080

# è®¾ç½®è¶…æ—¶æ—¶é—´
nc -w 5 -zv api.example.com 8080
```

**ss - æŸ¥çœ‹å¥—æ¥å­—ç»Ÿè®¡ä¿¡æ¯**
```bash
# åˆ—å‡ºæ‰€æœ‰TCPè¿æ¥
ss -tuln

# æŸ¥çœ‹å·²å»ºç«‹çš„è¿æ¥
ss -t state established

# æŸ¥çœ‹ç‰¹å®šç«¯å£è¿æ¥
ss -tuln | grep 8080

# æŸ¥çœ‹è¿æ¥æ•°ç»Ÿè®¡
ss -s
```

### 3. é«˜çº§ç½‘ç»œåˆ†æå·¥å…·

**tcpdump - ç½‘ç»œæŠ“åŒ…å·¥å…·**
```bash
# åŸºæœ¬æŠ“åŒ…
tcpdump -i any port 8080

# ä¿å­˜æŠ“åŒ…ç»“æœåˆ°æ–‡ä»¶
tcpdump -i any port 8080 -w network.pcap

# è¯»å–æŠ“åŒ…æ–‡ä»¶
tcpdump -r network.pcap

# è¿‡æ»¤ç‰¹å®šåè®®å’Œç«¯å£
tcpdump tcp port 8080 and host api.example.com

# æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
tcpdump -vvv -i any port 8080
```

**iftop - å®æ—¶ç½‘ç»œæµé‡ç›‘æ§**
```bash
# åŸºæœ¬ç”¨æ³•
iftop

# æŒ‡å®šç½‘å¡
iftop -i eth0

# æ˜¾ç¤ºç«¯å£ä¿¡æ¯
iftop -P

# åªæ˜¾ç¤ºIPv4æµé‡
iftop -4
```

**nslookup/dig - DNSæŸ¥è¯¢å·¥å…·**
```bash
# nslookupåŸºæœ¬ç”¨æ³•
nslookup api.example.com

# æŒ‡å®šDNSæœåŠ¡å™¨
nslookup api.example.com 8.8.8.8

# digåŸºæœ¬ç”¨æ³•
dig api.example.com

# æŸ¥çœ‹è¯¦ç»†DNSä¿¡æ¯
dig api.example.com +trace

# åªæ˜¾ç¤ºAè®°å½•
dig api.example.com A +short
```

---

## ç½‘ç»œå»¶è¿Ÿé—®é¢˜

### æ’æŸ¥æ–¹æ³•
1. ä½¿ç”¨pingå’Œtracerouteç¡®å®šå»¶è¿Ÿä½ç½®
2. æ£€æŸ¥æœåŠ¡å™¨é—´ç½‘ç»œæ‹“æ‰‘
3. åˆ†æç½‘ç»œæµé‡æ¨¡å¼
4. æ£€æŸ¥DNSè§£æå»¶è¿Ÿ

### å¸¸è§åŸå› 
- è·¨åŒºåŸŸç½‘ç»œä¼ è¾“
- ç½‘ç»œå¸¦å®½é¥±å’Œ
- æœåŠ¡å™¨è´Ÿè½½è¿‡é«˜
- è·¯ç”±é…ç½®ä¸å½“
- ç½‘ç»œè®¾å¤‡æ€§èƒ½ä¸è¶³

### è§£å†³æ–¹æ¡ˆ

**1. ä¼˜åŒ–ç½‘ç»œæ‹“æ‰‘**
```
# å¤šåŒºåŸŸéƒ¨ç½²æœåŠ¡ç¤ºä¾‹(ä¼ªä»£ç )
if (user.region == 'north') {
  connect('api-north.example.com');
} else if (user.region == 'south') {
  connect('api-south.example.com');
} else {
  connect('api-central.example.com');
}
```

**2. CDNåŠ é€Ÿé™æ€èµ„æº**
```nginx
# Nginxé…ç½®CDN
location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
    proxy_pass https://cdn.example.com;
    proxy_set_header Host cdn.example.com;
    expires 30d;
}
```

**3. è°ƒæ•´TCPå‚æ•°**
```bash
# ä¸´æ—¶è°ƒæ•´TCPç¼“å†²åŒºå¤§å°
sysctl -w net.core.rmem_max=16777216
sysctl -w net.core.wmem_max=16777216

sysctl -w net.ipv4.tcp_rmem='4096 87380 16777216'
sysctl -w net.ipv4.tcp_wmem='4096 65536 16777216'

# å¯ç”¨TCPå¿«é€Ÿæ‰“å¼€
sysctl -w net.ipv4.tcp_fastopen=3
```

**4. é•¿æœŸTCPå‚æ•°ä¼˜åŒ–**
```bash
# /etc/sysctl.conf é…ç½®
net.core.rmem_max=16777216
net.core.wmem_max=16777216
net.ipv4.tcp_rmem=4096 87380 16777216
net.ipv4.tcp_wmem=4096 65536 16777216
net.ipv4.tcp_fastopen=3
net.ipv4.tcp_no_metrics_save=1
net.ipv4.tcp_slow_start_after_idle=0

# åº”ç”¨é…ç½®
sysctl -p
```

---

## è¿æ¥è¶…æ—¶é—®é¢˜

### æ’æŸ¥æ–¹æ³•
1. æ£€æŸ¥ç›®æ ‡æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ
2. éªŒè¯ç½‘ç»œè·¯å¾„æ˜¯å¦é€šç•…
3. æ£€æŸ¥é˜²ç«å¢™å’Œå®‰å…¨ç»„è§„åˆ™
4. åˆ†æè¿æ¥æ± é…ç½®

### å¸¸è§åŸå› 
- æœåŠ¡æœªå¯åŠ¨æˆ–ç«¯å£æœªç›‘å¬
- ç½‘ç»œè·¯ç”±ä¸å¯è¾¾
- é˜²ç«å¢™é˜»æ­¢è¿æ¥
- è¿æ¥æ± è€—å°½
- åç«¯æœåŠ¡å¤„ç†èƒ½åŠ›ä¸è¶³

### è§£å†³æ–¹æ¡ˆ

**1. æœåŠ¡å¥åº·æ£€æŸ¥**
```java
// Spring Bootå¥åº·æ£€æŸ¥ç«¯ç‚¹é…ç½®
@Configuration
public class HealthCheckConfig {
    @Bean
    public HealthIndicator networkHealthIndicator() {
        return () -> {
            try (Socket socket = new Socket()) {
                socket.connect(new InetSocketAddress("api.example.com", 8080), 3000);
                return Health.up().withDetail("message", "è¿æ¥æ­£å¸¸").build();
            } catch (IOException e) {
                return Health.down().withDetail("message", "è¿æ¥å¤±è´¥: " + e.getMessage()).build();
            }
        };
    }
}
```

**2. è¿æ¥æ± é…ç½®ä¼˜åŒ–**
```yaml
# Spring Cloud Alibaba Nacosè¿æ¥æ± é…ç½®
spring:
  cloud:
    nacos:
      discovery:
        server-addr: nacos.example.com:8848
        namespace: prod
        connect-timeout: 3000
        timeout: 5000
        pool:
          max-active: 20
          max-idle: 10
          min-idle: 5
          timeout: 30000
```

**3. è¶…æ—¶å‚æ•°è°ƒæ•´**
```java
// HTTPå®¢æˆ·ç«¯è¶…æ—¶é…ç½®
@Bean
public RestTemplate restTemplate() {
    SimpleClientHttpRequestFactory requestFactory = new SimpleClientHttpRequestFactory();
    requestFactory.setConnectTimeout(3000); // è¿æ¥è¶…æ—¶
    requestFactory.setReadTimeout(5000);    // è¯»å–è¶…æ—¶
    return new RestTemplate(requestFactory);
}
```

---

## ç½‘ç»œä¸¢åŒ…é—®é¢˜

### æ’æŸ¥æ–¹æ³•
1. ä½¿ç”¨pingå‘½ä»¤æ£€æµ‹ä¸¢åŒ…ç‡
2. ä½¿ç”¨mtrè¿›è¡ŒæŒç»­ç½‘ç»œè´¨é‡ç›‘æ§
3. æŠ“åŒ…åˆ†æä¸¢åŒ…æ¨¡å¼
4. æ£€æŸ¥ç½‘ç»œè®¾å¤‡æ—¥å¿—

### å¸¸è§åŸå› 
- ç½‘ç»œé“¾è·¯è´¨é‡å·®
- ç½‘ç»œè®¾å¤‡è´Ÿè½½è¿‡é«˜
- MTUé…ç½®ä¸å½“
- ç½‘ç»œæ‹¥å¡
- ç¡¬ä»¶æ•…éšœ

### è§£å†³æ–¹æ¡ˆ

**1. æ£€æµ‹å’Œè§£å†³MTUé—®é¢˜**
```bash
# æ£€æµ‹æœ€ä½³MTUå¤§å°
ping -M do -s 1472 api.example.com

# å¦‚æœä¸Šè¿°å‘½ä»¤è¿”å›Fragmentation neededï¼Œåˆ™å‡å°åŒ…å¤§å°
ping -M do -s 1400 api.example.com

# ä¸´æ—¶è°ƒæ•´MTU
sudo ifconfig eth0 mtu 1450

# æ°¸ä¹…è°ƒæ•´MTU (Linux)
sudo vi /etc/netplan/01-netcfg.yaml
# æ·»åŠ mtu: 1450åˆ°ç›¸åº”æ¥å£é…ç½®
```

**2. ç½‘ç»œæ‹¥å¡å¤„ç†**
```bash
# æŸ¥çœ‹ç½‘ç»œæµé‡
iftop -i eth0

# æŸ¥çœ‹è¿æ¥æ•°
etstat -an | grep ESTABLISHED | wc -l

# é™åˆ¶ç‰¹å®šæœåŠ¡å¸¦å®½ (ä½¿ç”¨tc)
sudo tc qdisc add dev eth0 root tbf rate 10mbit burst 32kbit latency 400ms
```

**3. å¤šè·¯å¾„å†—ä½™**
```java
// ä½¿ç”¨Resilience4jå®ç°æœåŠ¡è°ƒç”¨é‡è¯•
@CircuitBreaker(name = "serviceCall", fallbackMethod = "serviceFallback")
@Retry(name = "serviceRetry")
public String callRemoteService() {
    return restTemplate.getForObject("http://api.example.com/service", String.class);
}

public String serviceFallback(Exception e) {
    log.error("æœåŠ¡è°ƒç”¨å¤±è´¥ï¼Œæ‰§è¡Œé™çº§ç­–ç•¥", e);
    return getCachedData();
}
```

---

## DNSè§£æé—®é¢˜

### æ’æŸ¥æ–¹æ³•
1. ä½¿ç”¨nslookup/digæ£€æŸ¥DNSè§£æ
2. æŸ¥çœ‹æœ¬åœ°DNSç¼“å­˜
3. æ£€æŸ¥DNSæœåŠ¡å™¨é…ç½®
4. æµ‹è¯•ä¸åŒDNSæœåŠ¡å™¨

### å¸¸è§åŸå› 
- DNSæœåŠ¡å™¨æ•…éšœ
- åŸŸåé…ç½®é”™è¯¯
- æœ¬åœ°DNSç¼“å­˜è¿‡æœŸ
- DNSæ±¡æŸ“
- è§£æè®°å½•TTLè®¾ç½®ä¸å½“

### è§£å†³æ–¹æ¡ˆ

**1. é…ç½®å¤šDNSæœåŠ¡å™¨**
```bash
# Linux /etc/resolv.confé…ç½®
nameserver 8.8.8.8
nameserver 114.114.114.114
nameserver 223.5.5.5
options timeout:1 attempts:3 rotate
```

**2. DNSç¼“å­˜ä¼˜åŒ–**
```java
// Javaåº”ç”¨DNSç¼“å­˜é…ç½®
System.setProperty("networkaddress.cache.ttl", "60"); // æˆåŠŸè§£æçš„ç¼“å­˜æ—¶é—´(ç§’)
System.setProperty("networkaddress.cache.negative.ttl", "10"); // å¤±è´¥è§£æçš„ç¼“å­˜æ—¶é—´(ç§’)
```

**3. æœ¬åœ°DNSç¼“å­˜æ¸…ç†**
```bash
# Linuxæ¸…ç†DNSç¼“å­˜
sudo systemctl restart systemd-resolved

# macOSæ¸…ç†DNSç¼“å­˜
sudo killall -HUP mDNSResponder

# Windowsæ¸…ç†DNSç¼“å­˜
ipconfig /flushdns
```

**4. ä½¿ç”¨DNSè´Ÿè½½å‡è¡¡**
```
# é˜¿é‡Œäº‘DNSè´Ÿè½½å‡è¡¡é…ç½®ç¤ºä¾‹
api.example.com.  A   192.168.1.10   æƒé‡10
api.example.com.  A   192.168.1.11   æƒé‡20
api.example.com.  A   192.168.1.12   æƒé‡15
```

---

## é˜²ç«å¢™ä¸å®‰å…¨ç»„é—®é¢˜

### æ’æŸ¥æ–¹æ³•
1. æ£€æŸ¥æœåŠ¡å™¨é˜²ç«å¢™è§„åˆ™
2. éªŒè¯äº‘æœåŠ¡å®‰å…¨ç»„é…ç½®
3. æµ‹è¯•ç«¯å£è¿é€šæ€§
4. æŸ¥çœ‹é˜²ç«å¢™æ—¥å¿—

### å¸¸è§åŸå› 
- ç«¯å£æœªå¼€æ”¾
- IPé™åˆ¶è¿‡ä¸¥
- åè®®ç±»å‹é™åˆ¶
- å®‰å…¨ç»„è§„åˆ™å†²çª
- æ–¹å‘è§„åˆ™é…ç½®é”™è¯¯

### è§£å†³æ–¹æ¡ˆ

**1. Linuxé˜²ç«å¢™é…ç½®**
```bash
# æŸ¥çœ‹é˜²ç«å¢™çŠ¶æ€
sudo ufw status

sudo firewall-cmd --list-all

# å¼€æ”¾ç‰¹å®šç«¯å£
sudo ufw allow 8080/tcp

sudo firewall-cmd --add-port=8080/tcp --permanent
sudo firewall-cmd --reload

# å¼€æ”¾ç‰¹å®šIPè®¿é—®
sudo ufw allow from 192.168.1.0/24 to any port 8080
sudo firewall-cmd --add-rich-rule='rule family="ipv4" source address="192.168.1.0/24" port protocol="tcp" port="8080" accept' --permanent
```

**2. AWSå®‰å…¨ç»„é…ç½®**
```json
{
  "GroupDescription": "APIæœåŠ¡å®‰å…¨ç»„",
  "SecurityGroupIngress": [
    {
      "IpProtocol": "tcp",
      "FromPort": 80,
      "ToPort": 80,
      "CidrIp": "0.0.0.0/0"
    },
    {
      "IpProtocol": "tcp",
      "FromPort": 443,
      "ToPort": 443,
      "CidrIp": "0.0.0.0/0"
    },
    {
      "IpProtocol": "tcp",
      "FromPort": 8080,
      "ToPort": 8080,
      "CidrIp": "192.168.1.0/24"
    }
  ],
  "SecurityGroupEgress": [
    {
      "IpProtocol": "-1",
      "FromPort": -1,
      "ToPort": -1,
      "CidrIp": "0.0.0.0/0"
    }
  ]
}
```

**3. Kubernetesç½‘ç»œç­–ç•¥**
```yaml
# å…è®¸å‰ç«¯Podè®¿é—®åç«¯APIæœåŠ¡
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: api-access-policy
  namespace: prod
spec:
  podSelector:
    matchLabels:
      app: api-service
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: frontend
    ports:
    - protocol: TCP
      port: 8080
```

---

## å…¸å‹æ¡ˆä¾‹åˆ†æ

### æ¡ˆä¾‹ä¸€ï¼šè·¨åŒºåŸŸæœåŠ¡è°ƒç”¨å»¶è¿Ÿè¿‡é«˜

**é—®é¢˜æè¿°**ï¼šåŒ—äº¬åŒºåŸŸæœåŠ¡è°ƒç”¨å¹¿å·åŒºåŸŸæœåŠ¡å¹³å‡å»¶è¿Ÿè¾¾80msï¼Œå½±å“ç”¨æˆ·ä½“éªŒã€‚

**æ’æŸ¥è¿‡ç¨‹**ï¼š
1. ä½¿ç”¨tracerouteåˆ†æç½‘ç»œè·¯å¾„
```bash
traceroute api-guangzhou.example.com
```
2. å‘ç°æµé‡ç»•è¡Œä¸Šæµ·èŠ‚ç‚¹ï¼Œå¢åŠ äº†é¢å¤–å»¶è¿Ÿ
3. æ£€æŸ¥CDNé…ç½®ï¼Œå‘ç°è·¨åŒºåŸŸåŠ é€Ÿæœªå¯ç”¨

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. å¯ç”¨é˜¿é‡Œäº‘è·¨åŒºåŸŸåŠ é€Ÿ
```yaml
# Spring Cloud Alibabaé…ç½®
spring:
  cloud:
    alibaba:
      seata:
        tx-service-group: my_test_tx_group
      cloud:
        access-key: your-access-key
        secret-key: your-secret-key
        cdn:
          enabled: true
          endpoint: cdn.aliyuncs.com
          domain: api.example.com
```
2. éƒ¨ç½²åŒºåŸŸå°±è¿‘æ¥å…¥å±‚
3. ä¼˜åŒ–è·¯ç”±ç­–ç•¥ï¼Œå‡å°‘ç»•è¡Œ

**ä¼˜åŒ–æ•ˆæœ**ï¼šå»¶è¿Ÿä»80msé™è‡³25msï¼Œç”¨æˆ·ä½“éªŒæ˜¾è‘—æå‡ã€‚

### æ¡ˆä¾‹äºŒï¼šDNSè§£æå¯¼è‡´é—´æ­‡æ€§è¿æ¥å¤±è´¥

**é—®é¢˜æè¿°**ï¼šåº”ç”¨é—´æ­‡æ€§æ— æ³•è¿æ¥åˆ°æ•°æ®åº“ï¼Œé”™è¯¯æ—¥å¿—æ˜¾ç¤ºUnknownHostExceptionã€‚

**æ’æŸ¥è¿‡ç¨‹**ï¼š
1. æ£€æŸ¥DNSè§£æ
```bash
dig mysql-service.prod.svc.cluster.local +short
nslookup mysql-service.prod.svc.cluster.local
```
2. å‘ç°Kubernetes DNSé—´æ­‡æ€§è¿”å›ç©ºç»“æœ
3. æ£€æŸ¥CoreDNSæ—¥å¿—
```bash
kubectl logs -n kube-system -l k8s-app=kube-dns
```
4. å‘ç°CoreDNSç¼“å­˜æº¢å‡ºï¼Œå¯¼è‡´è§£æå¤±è´¥

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. è°ƒæ•´CoreDNSé…ç½®
```yaml
# CoreDNS ConfigMapä¼˜åŒ–
apiVersion: v1
kind: ConfigMap
metadata:
  name: coredns
  namespace: kube-system
data:
  Corefile: |
    .:53 {
        errors
        health {
           lameduck 5s
        }
        ready
        kubernetes cluster.local in-addr.arpa ip6.arpa {
           pods insecure
           fallthrough in-addr.arpa ip6.arpa
           ttl 30
        }
        prometheus :9153
        forward . /etc/resolv.conf {
           max_concurrent 1000
        }
        cache 30
        loop
        reload
        loadbalance
    }
```
2. å¢åŠ CoreDNSå‰¯æœ¬æ•°
3. åº”ç”¨å†…æ·»åŠ DNSç¼“å­˜å’Œé‡è¯•æœºåˆ¶

**ä¼˜åŒ–æ•ˆæœ**ï¼šè§£ææˆåŠŸç‡ä»95%æå‡è‡³100%ï¼Œè¿æ¥å¤±è´¥é—®é¢˜å½»åº•è§£å†³ã€‚

---

## ç½‘ç»œç›‘æ§ä¸å‘Šè­¦

### 1. Prometheusç½‘ç»œç›‘æ§

**Node Exporterç½‘ç»œæŒ‡æ ‡**ï¼š
- node_network_receive_bytes_total: ç½‘ç»œæ¥æ”¶å­—èŠ‚æ•°
- node_network_transmit_bytes_total: ç½‘ç»œå‘é€å­—èŠ‚æ•°
- node_network_packets_total: ç½‘ç»œåŒ…æ•°é‡
- node_network_packets_dropped_total: ä¸¢åŒ…æ•°é‡

**ç›‘æ§è§„åˆ™é…ç½®**ï¼š
```yaml
# prometheus.rules.yml
groups:
- name: ç½‘ç»œç›‘æ§è§„åˆ™
  rules:
  - alert: ç½‘ç»œæ¥æ”¶æµé‡è¿‡é«˜
    expr: sum(rate(node_network_receive_bytes_total[5m])) by (instance) > 10000000
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "ç½‘ç»œæ¥æ”¶æµé‡è¿‡é«˜",
      description: "å®ä¾‹ {{ $labels.instance }} ç½‘ç»œæ¥æ”¶æµé‡æŒç»­5åˆ†é’Ÿè¶…è¿‡10MB/sï¼Œå½“å‰å€¼ {{ $value | humanizeBytes }}/s"
  - alert: ç½‘ç»œä¸¢åŒ…ç‡é«˜
    expr: sum(rate(node_network_packets_dropped_total[5m])) / sum(rate(node_network_packets_total[5m])) > 0.01
    for: 2m
    labels:
      severity: critical
    annotations:
      summary: "ç½‘ç»œä¸¢åŒ…ç‡è¿‡é«˜",
      description: "å®ä¾‹ {{ $labels.instance }} ç½‘ç»œä¸¢åŒ…ç‡æŒç»­2åˆ†é’Ÿè¶…è¿‡1%ï¼Œå½“å‰å€¼ {{ $value | humanizePercentage }}"
  - alert: ç½‘ç»œå»¶è¿Ÿé«˜
    expr: probe_icmp_duration_seconds{quantile="0.95"} > 0.5
    for: 3m
    labels:
      severity: warning
    annotations:
      summary: "ç½‘ç»œå»¶è¿Ÿè¿‡é«˜",
      description: "ç›®æ ‡ {{ $labels.instance }} ICMPå»¶è¿ŸP95å€¼æŒç»­3åˆ†é’Ÿè¶…è¿‡500msï¼Œå½“å‰å€¼ {{ $value | humanizeDuration }}"

### 2. Grafanaç½‘ç»œç›‘æ§é¢æ¿

æ¨èå¯¼å…¥Grafanaç½‘ç»œç›‘æ§é¢æ¿ï¼š
- ID: 5496 (Network Monitoring)
- ID: 12905 (Node Exporter Full)
- ID: 1860 (Node Exporter Dashboard)

**è‡ªå®šä¹‰ç½‘ç»œç›‘æ§é¢æ¿JSONç¤ºä¾‹**ï¼š
```json
{
  "annotations": {
    "list": [
      {
        "builtIn": 1,
        "datasource": "-- Grafana --",
        "enable": true,
        "hide": true,
        "iconColor": "rgba(0, 211, 255, 1)",
        "name": "Annotations & Alerts",
        "type": "dashboard"
      }
    ]
  },
  "editable": true,
  "gnetId": null,
  "graphTooltip": 0,
  "id": 15,
  "iteration": 1605292637423,
  "links": [],
  "panels": [
    {
      "aliasColors": {},
      "bars": false,
      "dashLength": 10,
      "dashes": false,
      "datasource": "Prometheus",
      "fieldConfig": {
        "defaults": {
          "links": []
        },
        "overrides": []
      },
      "fill": 1,
      "fillGradient": 0,
      "gridPos": {
        "h": 8,
        "w": 24,
        "x": 0,
        "y": 0
      },
      "hiddenSeries": false,
      "id": 2,
      "legend": {
        "avg": false,
        "current": false,
        "max": false,
        "min": false,
        "show": true,
        "total": false,
        "values": false
      },
      "lines": true,
      "linewidth": 1,
      "nullPointMode": "null",
      "options": {
        "alertThreshold": true
      },
      "percentage": false,
      "pluginVersion": "7.3.6",
      "pointradius": 2,
      "points": false,
      "renderer": "flot",
      "seriesOverrides": [],
      "spaceLength": 10,
      "stack": false,
      "steppedLine": false,
      "targets": [
        {
          "expr": "sum(rate(node_network_transmit_bytes_total[5m])) by (instance)",
          "interval": "",
          "legendFormat": "{{ instance }} å‘é€",
          "refId": "A"
        },
        {
          "expr": "sum(rate(node_network_receive_bytes_total[5m])) by (instance)",
          "interval": "",
          "legendFormat": "{{ instance }} æ¥æ”¶",
          "refId": "B"
        }
      ],
      "thresholds": [],
      "timeFrom": null,
      "timeRegions": [],
      "timeShift": null,
      "title": "ç½‘ç»œæµé‡",
      "tooltip": {
        "shared": true,
        "sort": 0,
        "value_type": "individual"
      },
      "type": "graph",
      "xaxis": {
        "buckets": null,
        "mode": "time",
        "name": null,
        "show": true,
        "values": []
      },
      "yaxes": [
        {
          "format": "B/s",
          "label": "æµé‡",
          "logBase": 1,
          "max": null,
          "min": "0",
          "show": true
        },
        {
          "format": "short",
          "label": null,
          "logBase": 1,
          "max": null,
          "min": null,
          "show": true
        }
      ],
      "yaxis": {
        "align": false,
        "alignLevel": null
      }
    }
  ],
  "refresh": "5s",
  "schemaVersion": 27,
  "style": "dark",
  "tags": [],
  "templating": {
    "list": []
  },
  "time": {
    "from": "now-6h",
    "to": "now"
  },
  "timepicker": {
    "refresh_intervals": [
      "5s",
      "10s",
      "30s",
      "1m",
      "5m",
      "15m",
      "30m",
      "1h",
      "2h",
      "1d"
    ]
  },
  "timezone": "",
  "title": "ç½‘ç»œç›‘æ§",
  "uid": "network-monitor",
  "version": 1
}
```

### 3. Alertmanageré…ç½®

```yaml
# alertmanager.yml
global:
  resolve_timeout: 5m

route:
  group_by: ['alertname', 'instance']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: 'web.hook'
receivers:
- name: 'web.hook'
  webhook_configs:
  - url: 'http://alertmanager-webhook:5001/webhook'

inhibit_rules:
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'instance']
```

---

## ç½‘ç»œé—®é¢˜é¢„é˜²æªæ–½

### 1. ç½‘ç»œæ¶æ„ä¼˜åŒ–
- **å¤šåŒºåŸŸéƒ¨ç½²**ï¼šå°†æœåŠ¡éƒ¨ç½²åœ¨å¤šä¸ªå¯ç”¨åŒºï¼Œé¿å…å•ç‚¹æ•…éšœ
- **å†—ä½™ç½‘ç»œé“¾è·¯**ï¼šå…³é”®ä¸šåŠ¡ä½¿ç”¨åŒçº¿è·¯æ¥å…¥ï¼Œç¡®ä¿é“¾è·¯å†—ä½™
- **åˆ†å±‚ç½‘ç»œè®¾è®¡**ï¼šé‡‡ç”¨æ ¸å¿ƒå±‚ã€æ±‡èšå±‚ã€æ¥å…¥å±‚ä¸‰å±‚æ¶æ„
- **æœåŠ¡ç½‘æ ¼**ï¼šä½¿ç”¨Istio/Linkerdç­‰æœåŠ¡ç½‘æ ¼ç®¡ç†æœåŠ¡é—´é€šä¿¡

### 2. é…ç½®ç®¡ç†
- **åŸºç¡€è®¾æ–½å³ä»£ç **ï¼šä½¿ç”¨Terraform/Ansibleç®¡ç†ç½‘ç»œè®¾å¤‡é…ç½®
- **é…ç½®ç‰ˆæœ¬æ§åˆ¶**ï¼šæ‰€æœ‰ç½‘ç»œé…ç½®å˜æ›´çº³å…¥Gitç‰ˆæœ¬æ§åˆ¶
- **è‡ªåŠ¨åŒ–é…ç½®æ£€æŸ¥**ï¼šå®šæœŸæ‰«æç½‘ç»œé…ç½®åˆè§„æ€§
- **å˜æ›´å®¡æ‰¹æµç¨‹**ï¼šå»ºç«‹ç½‘ç»œå˜æ›´çš„ç”³è¯·ã€å®¡æ ¸ã€æ‰§è¡Œæµç¨‹

### 3. ç›‘æ§ä½“ç³»
- **å…¨é“¾è·¯ç›‘æ§**ï¼šä»å®¢æˆ·ç«¯åˆ°æœåŠ¡ç«¯çš„ç«¯åˆ°ç«¯ç½‘ç»œç›‘æ§
- **å…³é”®æŒ‡æ ‡è¦†ç›–**ï¼šå¸¦å®½ã€å»¶è¿Ÿã€ä¸¢åŒ…ç‡ã€è¿æ¥æ•°ç­‰æ ¸å¿ƒæŒ‡æ ‡
- **å¼‚å¸¸æ£€æµ‹**ï¼šåŸºäºæœºå™¨å­¦ä¹ çš„ç½‘ç»œå¼‚å¸¸è¡Œä¸ºè¯†åˆ«
- **å¯è§†åŒ–å¹³å°**ï¼šé›†ä¸­å±•ç¤ºç½‘ç»œæ‹“æ‰‘å’Œæ€§èƒ½æŒ‡æ ‡

### 4. åº”æ€¥é¢„æ¡ˆ
- **æ•…éšœæ¼”ç»ƒ**ï¼šå®šæœŸè¿›è¡Œç½‘ç»œæ•…éšœæ³¨å…¥æµ‹è¯•
- **æ¢å¤æµç¨‹**ï¼šåˆ¶å®šè¯¦ç»†çš„ç½‘ç»œæ•…éšœæ¢å¤æ‰‹å†Œ
- **æµé‡åˆ‡æ¢**ï¼šå»ºç«‹ä¸»å¤‡é“¾è·¯è‡ªåŠ¨åˆ‡æ¢æœºåˆ¶
- **é™çº§ç­–ç•¥**ï¼šå®šä¹‰ç½‘ç»œæ•…éšœæ—¶çš„æœåŠ¡é™çº§æ–¹æ¡ˆ

---

æ–‡æ¡£çŠ¶æ€ï¼šæ¡†æ¶å·²æ­å»ºï¼Œå†…å®¹æŒç»­å®Œå–„ä¸­

**æ›´æ–°æ—¥å¿—**ï¼š
- 2025-12-26: åˆå§‹ç‰ˆæœ¬ï¼Œå®ŒæˆåŸºæœ¬æ¡†æ¶å’Œå¸¸è§é—®é¢˜ç« èŠ‚
- 2025-12-26: è¡¥å……ç›‘æ§å‘Šè­¦é…ç½®å’Œé¢„é˜²æªæ–½ç« èŠ‚