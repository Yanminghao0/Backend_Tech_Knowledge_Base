# ç½‘ç»œé—®é¢˜æ’æŸ¥

> å®æˆ˜æŒ‡å—ï¼šå¦‚ä½•æ’æŸ¥è¿æ¥è¶…æ—¶ã€ç½‘ç»œå»¶è¿Ÿã€ä¸¢åŒ…ç­‰ç½‘ç»œé—®é¢˜

## ğŸ“‹ ç›®å½•
- [å¸¸è§é—®é¢˜ç±»å‹](#å¸¸è§é—®é¢˜ç±»å‹)
- [è¿æ¥è¶…æ—¶](#è¿æ¥è¶…æ—¶)
- [ç½‘ç»œå»¶è¿Ÿ](#ç½‘ç»œå»¶è¿Ÿ)
- [ç½‘ç»œä¸¢åŒ…](#ç½‘ç»œä¸¢åŒ…)
- [æ’æŸ¥å·¥å…·](#æ’æŸ¥å·¥å…·)

---

## å¸¸è§é—®é¢˜ç±»å‹

### 1. è¿æ¥è¶…æ—¶

**ç—‡çŠ¶**ï¼š
```
âœ… è¿æ¥å»ºç«‹å¤±è´¥
âœ… è¿æ¥è¶…æ—¶å¼‚å¸¸
âœ… æœåŠ¡ä¸å¯è®¿é—®
```

### 2. ç½‘ç»œå»¶è¿Ÿ

**ç—‡çŠ¶**ï¼š
```
âœ… è¯·æ±‚å“åº”å˜æ…¢
âœ… ç½‘ç»œå»¶è¿Ÿå¢åŠ 
âœ… è·¨æœåŠ¡è°ƒç”¨å˜æ…¢
```

### 3. ç½‘ç»œä¸¢åŒ…

**ç—‡çŠ¶**ï¼š
```
âœ… æ•°æ®åŒ…ä¸¢å¤±
âœ… è¿æ¥ä¸ç¨³å®š
âœ… é‡ä¼ æ¬¡æ•°å¢åŠ 
```

---

## è¿æ¥è¶…æ—¶

### æ’æŸ¥æ–¹æ³•

**1. æµ‹è¯•è¿æ¥**

```bash
# æµ‹è¯•TCPè¿æ¥
telnet <host> <port>
nc -zv <host> <port>

# æµ‹è¯•HTTPè¿æ¥
curl -v http://<host>:<port>
wget http://<host>:<port>
```

**2. æŸ¥çœ‹ç½‘ç»œè¿æ¥**

```bash
# æŸ¥çœ‹ç½‘ç»œè¿æ¥çŠ¶æ€
netstat -ant | grep <port>
ss -ant | grep <port>

# æŸ¥çœ‹è¿æ¥æ•°
netstat -ant | grep ESTABLISHED | wc -l
ss -ant | grep ESTABLISHED | wc -l
```

### å¸¸è§åŸå› 

**1. ç«¯å£æœªç›‘å¬**

```bash
# æ£€æŸ¥ç«¯å£æ˜¯å¦ç›‘å¬
netstat -tlnp | grep <port>
ss -tlnp | grep <port>
lsof -i :<port>
```

**2. é˜²ç«å¢™é˜»æ­¢**

```bash
# æ£€æŸ¥é˜²ç«å¢™è§„åˆ™
iptables -L
firewall-cmd --list-all
```

**3. è¿æ¥æ•°è¾¾åˆ°ä¸Šé™**

```bash
# æŸ¥çœ‹è¿æ¥æ•°é™åˆ¶
ulimit -n
cat /proc/sys/net/core/somaxconn
```

### è§£å†³æ–¹æ¡ˆ

**1. æ£€æŸ¥ç«¯å£ç›‘å¬**

```bash
# ç¡®ä¿ç«¯å£æ­£åœ¨ç›‘å¬
netstat -tlnp | grep <port>
```

**2. æ£€æŸ¥é˜²ç«å¢™**

```bash
# å¼€æ”¾ç«¯å£
firewall-cmd --add-port=<port>/tcp --permanent
firewall-cmd --reload
```

**3. å¢åŠ è¿æ¥æ•°é™åˆ¶**

```bash
# å¢åŠ æ–‡ä»¶æè¿°ç¬¦é™åˆ¶
ulimit -n 65535

# æ°¸ä¹…ç”Ÿæ•ˆï¼ˆä¿®æ”¹é…ç½®æ–‡ä»¶ï¼‰
echo "* soft nofile 65535" >> /etc/security/limits.conf
echo "* hard nofile 65535" >> /etc/security/limits.conf
```

---

## ç½‘ç»œå»¶è¿Ÿ

### æ’æŸ¥æ–¹æ³•

**1. æµ‹è¯•ç½‘ç»œå»¶è¿Ÿ**

```bash
# æµ‹è¯•å»¶è¿Ÿ
ping <host>
ping -c 10 <host>

# æµ‹è¯•è·¯ç”±
traceroute <host>
mtr <host>
```

**2. æŸ¥çœ‹ç½‘ç»œç»Ÿè®¡**

```bash
# æŸ¥çœ‹ç½‘ç»œç»Ÿè®¡
netstat -i
ifconfig
ip -s link
```

### å¸¸è§åŸå› 

**1. ç½‘ç»œå¸¦å®½ä¸è¶³**

```bash
# æŸ¥çœ‹ç½‘ç»œå¸¦å®½ä½¿ç”¨
iftop
nethogs
```

**2. ç½‘ç»œæ‹¥å¡**

```bash
# æŸ¥çœ‹ç½‘ç»œæ‹¥å¡
netstat -s | grep -i "retransmit"
```

**3. è·¨åœ°åŸŸå»¶è¿Ÿ**

```bash
# æµ‹è¯•è·¨åœ°åŸŸå»¶è¿Ÿ
ping <remote_host>
```

### è§£å†³æ–¹æ¡ˆ

**1. ä¼˜åŒ–ç½‘ç»œé…ç½®**

```bash
# TCPä¼˜åŒ–
echo "net.core.somaxconn = 65535" >> /etc/sysctl.conf
echo "net.ipv4.tcp_tw_reuse = 1" >> /etc/sysctl.conf
sysctl -p
```

**2. ä½¿ç”¨CDN**

```
- ä½¿ç”¨CDNåŠ é€Ÿ
- å°±è¿‘è®¿é—®
- å‡å°‘ç½‘ç»œå»¶è¿Ÿ
```

**3. ä¼˜åŒ–éƒ¨ç½²**

```
- åŒæœºæˆ¿éƒ¨ç½²
- å‡å°‘è·¨ç½‘ç»œè°ƒç”¨
- ä½¿ç”¨å†…ç½‘é€šä¿¡
```

---

## ç½‘ç»œä¸¢åŒ…

### æ’æŸ¥æ–¹æ³•

**1. æµ‹è¯•ä¸¢åŒ…ç‡**

```bash
# æµ‹è¯•ä¸¢åŒ…ç‡
ping -c 100 <host>
# æŸ¥çœ‹ä¸¢åŒ…ç‡ç»Ÿè®¡

# ä½¿ç”¨mtræµ‹è¯•
mtr --report --report-cycles 100 <host>
```

**2. æŸ¥çœ‹ç½‘ç»œç»Ÿè®¡**

```bash
# æŸ¥çœ‹ç½‘ç»œç»Ÿè®¡
netstat -s | grep -i "packet"
netstat -s | grep -i "error"
```

### å¸¸è§åŸå› 

**1. ç½‘ç»œè´¨é‡å·®**

```bash
# æµ‹è¯•ç½‘ç»œè´¨é‡
ping -c 100 <host>
# æŸ¥çœ‹ä¸¢åŒ…ç‡
```

**2. ç½‘ç»œæ‹¥å¡**

```bash
# æŸ¥çœ‹ç½‘ç»œæ‹¥å¡
netstat -s | grep -i "retransmit"
```

**3. ç½‘ç»œè®¾å¤‡æ•…éšœ**

```bash
# æ£€æŸ¥ç½‘ç»œè®¾å¤‡
ping <gateway>
ping <dns>
```

### è§£å†³æ–¹æ¡ˆ

**1. ç½‘ç»œä¼˜åŒ–**

```bash
# TCPä¼˜åŒ–
echo "net.ipv4.tcp_syncookies = 1" >> /etc/sysctl.conf
echo "net.ipv4.tcp_max_syn_backlog = 8192" >> /etc/sysctl.conf
sysctl -p
```

**2. é‡è¯•æœºåˆ¶**

```java
// ç½‘ç»œè¯·æ±‚é‡è¯•
@Retryable(maxAttempts = 3, backoff = @Backoff(delay = 1000))
public void networkRequest() {
    // ç½‘ç»œè¯·æ±‚
}
```

**3. ç›‘æ§å‘Šè­¦**

```
âœ… ç½‘ç»œå»¶è¿Ÿç›‘æ§
âœ… ä¸¢åŒ…ç‡ç›‘æ§
âœ… ç½‘ç»œè´¨é‡ç›‘æ§
```

---

## æ’æŸ¥å·¥å…·

### 1. ç½‘ç»œè¯Šæ–­å·¥å…·

```bash
# ping - æµ‹è¯•è¿é€šæ€§
ping <host>

# traceroute - è·¯ç”±è¿½è¸ª
traceroute <host>

# mtr - ç½‘ç»œè¯Šæ–­
mtr <host>

# telnet - æµ‹è¯•ç«¯å£
telnet <host> <port>

# nc - ç½‘ç»œè¿æ¥æµ‹è¯•
nc -zv <host> <port>
```

### 2. ç½‘ç»œç›‘æ§å·¥å…·

```bash
# iftop - ç½‘ç»œæµé‡ç›‘æ§
iftop -i eth0

# nethogs - è¿›ç¨‹ç½‘ç»œç›‘æ§
nethogs

# netstat - ç½‘ç»œè¿æ¥ç»Ÿè®¡
netstat -antp

# ss - Socketç»Ÿè®¡
ss -antp
```

### 3. æŠ“åŒ…å·¥å…·

```bash
# tcpdump - ç½‘ç»œæŠ“åŒ…
tcpdump -i eth0 -w capture.pcap

# wireshark - ç½‘ç»œåˆ†æ
wireshark capture.pcap
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æ€§èƒ½é—®é¢˜æ’æŸ¥](./01_æ€§èƒ½é—®é¢˜æ’æŸ¥.md)
- [ç³»ç»Ÿæ•…éšœæ’æŸ¥](./03_ç³»ç»Ÿæ•…éšœæ’æŸ¥.md)

---

**æœ€åæ›´æ–°**: 2025-10-29  
**æ–‡æ¡£çŠ¶æ€**: âœ… æ¡†æ¶å·²æ­å»ºï¼Œå†…å®¹æŒç»­å®Œå–„ä¸­


### é«˜çº§ç½‘ç»œæ’éšœæŠ€æœ¯

**1. ä½¿ç”¨tcæ¨¡æ‹Ÿç½‘ç»œé—®é¢˜**

```bash
# æ¨¡æ‹Ÿå»¶è¿Ÿ
sudo tc qdisc add dev eth0 root netem delay 100ms

# æ¨¡æ‹Ÿä¸¢åŒ…
sudo tc qdisc add dev eth0 root netem loss 10%

# æ¨¡æ‹ŸåŒ…ä¹±åº
sudo tc qdisc add dev eth0 root netem delay 10ms reorder 25% gap 3

# æ¸…é™¤è§„åˆ™
sudo tc qdisc del dev eth0 root
```

**2. Wiresharké«˜çº§è¿‡æ»¤æŠ€å·§**

```
# è¿‡æ»¤ç‰¹å®šIPå’Œç«¯å£çš„TCPæµé‡
ip.addr == 192.168.1.100 and tcp.port == 8080 and tcp.flags.syn == 1

# è¿‡æ»¤HTTPè¯·æ±‚å’Œå“åº”
http.request or http.response

# è¿‡æ»¤SSLæ¡æ‰‹å¤±è´¥
ssl.handshake.failure

# æ˜¾ç¤ºTCPé‡ä¼ 
tcp.analysis.retransmission
```

**3. ç½‘ç»œæ€§èƒ½åŸºå‡†æµ‹è¯•**

```bash
# ä½¿ç”¨iperfæµ‹è¯•å¸¦å®½
iperf -s # æœåŠ¡ç«¯
iperf -c 192.168.1.100 -t 60 -i 1 # å®¢æˆ·ç«¯

# ä½¿ç”¨netperfæµ‹è¯•TCPæ€§èƒ½
netperf -H 192.168.1.100 -t TCP_STREAM -l 60

# ä½¿ç”¨tcptraceåˆ†æTCPè¿æ¥
tcptrace -r capture.pcap
```

---

### å®¹å™¨ç½‘ç»œé—®é¢˜æ’æŸ¥

**1. Dockerç½‘ç»œé—®é¢˜**

```bash
# æŸ¥çœ‹Dockerç½‘ç»œæ¨¡å¼
docker network ls
docker network inspect bridge

# æ£€æŸ¥å®¹å™¨ç½‘ç»œé…ç½®
docker inspect -f '{{ .NetworkSettings.IPAddress }}' container_id

docker inspect -f '{{ .NetworkSettings.Ports }}' container_id

# è¿›å…¥å®¹å™¨ç½‘ç»œå‘½åç©ºé—´
docker exec -it container_id nsenter --net=/proc/1/ns/net ip addr
```

**2. Kubernetesç½‘ç»œé—®é¢˜**

```bash
# æ£€æŸ¥Podç½‘ç»œçŠ¶æ€
kubectl get pods -o wide
kubectl describe pod pod_name

# æµ‹è¯•Podé—´è¿é€šæ€§
kubectl run test-pod --image=busybox --rm -it -- sh

# æ£€æŸ¥Serviceå’ŒEndpoint
kubectl get svc
kubectl describe svc service_name
kubectl get endpoints service_name

# æŸ¥çœ‹ç½‘ç»œç­–ç•¥
kubectl get networkpolicy

# ä½¿ç”¨kube-ps1æŸ¥çœ‹å½“å‰å‘½åç©ºé—´
PS1='\[\033[01;34m\]$(kubens_prompt_info)\[\033[00m\] \[\033[01;33m\]\w\[\033[00m\] \$ '
```

**3. CNIæ’ä»¶é—®é¢˜æ’æŸ¥**

```bash
# æŸ¥çœ‹CalicoçŠ¶æ€
calicoctl node status
calicoctl get workloadendpoints -o wide

# æŸ¥çœ‹Flannelæ—¥å¿—
journalctl -u flanneld -f

# æ£€æŸ¥CNIé…ç½®
cat /etc/cni/net.d/10-calico.conflist
```

---

### ç½‘ç»œé—®é¢˜æ¡ˆä¾‹åˆ†æ

**æ¡ˆä¾‹1ï¼šé—´æ­‡æ€§DNSè§£æå¤±è´¥**

**ç—‡çŠ¶**ï¼šåº”ç”¨é—´æ­‡æ€§æ— æ³•è§£æåŸŸåï¼Œé”™è¯¯æ—¥å¿—æ˜¾ç¤º`UnknownHostException`

**æ’æŸ¥è¿‡ç¨‹**ï¼š
```bash
# 1. æ£€æŸ¥DNSé…ç½®
cat /etc/resolv.conf

# 2. æµ‹è¯•DNSè§£æ
nslookup www.example.com 8.8.8.8
nslookup www.example.com 114.114.114.114

# 3. æŸ¥çœ‹DNSç¼“å­˜
systemd-resolve --statistics

# 4. æŠ“åŒ…åˆ†æDNSè¯·æ±‚
tcpdump -i eth0 udp port 53 -w dns.pcap
```

**åŸå› **ï¼šDNSæœåŠ¡å™¨è¿”å›TTLä¸º0çš„è®°å½•ï¼Œå¯¼è‡´é¢‘ç¹é‡æ–°è§£æï¼›éƒ¨åˆ†DNSæœåŠ¡å™¨å“åº”ç¼“æ…¢

**è§£å†³æ–¹æ¡ˆ**ï¼š
```java
// 1. é…ç½®JVM DNSç¼“å­˜
System.setProperty("networkaddress.cache.ttl", "300");
System.setProperty("networkaddress.cache.negative.ttl", "10");

// 2. å®ç°æœ¬åœ°DNSç¼“å­˜
@Bean
public Cache<String, InetAddress> dnsCache() {
    return Caffeine.newBuilder()
        .expireAfterWrite(5, TimeUnit.MINUTES)
        .maximumSize(1000)
        .build();
}
```

**æ¡ˆä¾‹2ï¼šTCPè¿æ¥å»ºç«‹ç¼“æ…¢**

**ç—‡çŠ¶**ï¼šåº”ç”¨ä¸æœåŠ¡ç«¯å»ºç«‹è¿æ¥è€—æ—¶è¶…è¿‡3ç§’

**æ’æŸ¥è¿‡ç¨‹**ï¼š
```bash
# 1. æ£€æŸ¥TCPä¸‰æ¬¡æ¡æ‰‹æ—¶é—´
tcpdump -i eth0 port 8080 -w tcp_handshake.pcap

# 2. åˆ†æTCPæ¡æ‰‹è¿‡ç¨‹
wireshark tcp_handshake.pcap

# 3. æ£€æŸ¥æœåŠ¡å™¨SYNé˜Ÿåˆ—
ss -s
netstat -s | grep SYN
```

**åŸå› **ï¼šæœåŠ¡å™¨SYNé˜Ÿåˆ—æº¢å‡ºï¼Œå¯¼è‡´ä¸¢åŒ…é‡ä¼ 

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# è°ƒæ•´TCPå‚æ•°
echo "net.ipv4.tcp_max_syn_backlog = 16384" >> /etc/sysctl.conf
echo "net.ipv4.tcp_syncookies = 1" >> /etc/sysctl.conf
echo "net.ipv4.tcp_synack_retries = 2" >> /etc/sysctl.conf
sysctl -p
```

**æ¡ˆä¾‹3ï¼šKubernetesæœåŠ¡è®¿é—®è¶…æ—¶**

**ç—‡çŠ¶**ï¼šPodæ— æ³•è®¿é—®Serviceï¼ŒæŠ¥è¶…æ—¶é”™è¯¯

**æ’æŸ¥è¿‡ç¨‹**ï¼š
```bash
# 1. æ£€æŸ¥Podç½‘ç»œ
kubectl exec -it pod_name -- ip addr
kubectl exec -it pod_name -- ping service_ip

# 2. æ£€æŸ¥Serviceå’ŒEndpoint
kubectl get svc service_name -o yaml
kubectl get endpoints service_name

# 3. æ£€æŸ¥ç½‘ç»œç­–ç•¥
kubectl get networkpolicy

# 4. æŸ¥çœ‹kube-proxyæ—¥å¿—
journalctl -u kube-proxy -f
```

**åŸå› **ï¼šç½‘ç»œç­–ç•¥é˜»æ­¢äº†Podåˆ°Serviceçš„æµé‡

**è§£å†³æ–¹æ¡ˆ**ï¼š
```yaml
# ä¿®æ”¹ç½‘ç»œç­–ç•¥å…è®¸æµé‡
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-service-access
spec:
  podSelector:
    matchLabels:
      app: my-app
  policyTypes:
  - Ingress
  - Egress
  egress:
  - to:
    - service:
        name: target-service
```

---

### ç½‘ç»œç›‘æ§æœ€ä½³å®è·µ

**1. Prometheusç½‘ç»œç›‘æ§**

```yaml
# prometheus.ymlé…ç½®
scrape_configs:
  - job_name: 'node_network'
    static_configs:
      - targets: ['node-exporter:9100']

  - job_name: 'blackbox'
    metrics_path: /probe
    params:
      module: [http_2xx]
    static_configs:
      - targets:
        - https://example.com
        - http://localhost:8080
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox-exporter:9115
```

**2. Grafanaç½‘ç»œç›‘æ§é¢æ¿**

æ¨èå¯¼å…¥çš„Dashboardï¼š
- Node Exporter Full (ID: 1860)
- Blackbox Exporter (ID: 9965)
- Kubernetes Network Monitoring (ID: 7249)

**3. ç½‘ç»œå‘Šè­¦è§„åˆ™**

```yaml
# Prometheuså‘Šè­¦è§„åˆ™
groups:
- name: network_alerts
  rules:
  - alert: HighPacketLoss
    expr: sum(rate(node_network_transmit_drop_total[5m])) / sum(rate(node_network_transmit_bytes_total[5m])) > 0.01
    for: 5m
    labels:
      severity: critical
    annotations:
      summary: "é«˜ä¸¢åŒ…ç‡"
      description: "ä¸¢åŒ…ç‡è¶…è¿‡1%æŒç»­5åˆ†é’Ÿ"

  - alert: HighLatency
    expr: probe_http_duration_seconds{phase="connect"} > 0.5
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "è¿æ¥å»¶è¿Ÿé«˜"
      description: "è¿æ¥å»¶è¿Ÿè¶…è¿‡500ms"
```

---