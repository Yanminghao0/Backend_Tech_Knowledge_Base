# ç¼“å­˜é—®é¢˜æ’æŸ¥

> å®æˆ˜æŒ‡å—ï¼šå¦‚ä½•æ’æŸ¥Redisè¿æ¥ã€ç¼“å­˜ç©¿é€ã€å‡»ç©¿ã€é›ªå´©ç­‰ç¼“å­˜é—®é¢˜

## ğŸ“‹ ç›®å½•
- [å¸¸è§é—®é¢˜ç±»å‹](#å¸¸è§é—®é¢˜ç±»å‹)
- [Redisè¿æ¥é—®é¢˜](#redisè¿æ¥é—®é¢˜)
- [ç¼“å­˜ç©¿é€](#ç¼“å­˜ç©¿é€)
- [ç¼“å­˜å‡»ç©¿](#ç¼“å­˜å‡»ç©¿)
- [ç¼“å­˜é›ªå´©](#ç¼“å­˜é›ªå´©)
- [å¤§keyå’Œçƒ­key](#å¤§keyå’Œçƒ­key)

---

## å¸¸è§é—®é¢˜ç±»å‹

### 1. Redisè¿æ¥é—®é¢˜

**ç—‡çŠ¶**ï¼š
```
âœ… è¿æ¥è¶…æ—¶
âœ… è¿æ¥æ•°è¾¾åˆ°ä¸Šé™
âœ… è¿æ¥æ± æ»¡
âœ… è¿æ¥å¼‚å¸¸
```

### 2. ç¼“å­˜ç©¿é€

**ç—‡çŠ¶**ï¼š
```
âœ… å¤§é‡è¯·æ±‚æ‰“åˆ°æ•°æ®åº“
âœ… ç¼“å­˜å‘½ä¸­ç‡ä½
âœ… æ•°æ®åº“å‹åŠ›å¤§
```

### 3. ç¼“å­˜å‡»ç©¿

**ç—‡çŠ¶**ï¼š
```
âœ… çƒ­ç‚¹keyè¿‡æœŸ
âœ… å¤§é‡è¯·æ±‚æ‰“åˆ°æ•°æ®åº“
âœ… æ•°æ®åº“å‹åŠ›çªå¢
```

### 4. ç¼“å­˜é›ªå´©

**ç—‡çŠ¶**ï¼š
```
âœ… å¤§é‡keyåŒæ—¶è¿‡æœŸ
âœ… æ•°æ®åº“å‹åŠ›çªå¢
âœ… ç³»ç»Ÿæ€§èƒ½ä¸‹é™
```

---

## Redisè¿æ¥é—®é¢˜

### æ’æŸ¥æ–¹æ³•

**1. æµ‹è¯•Redisè¿æ¥**

```bash
# æµ‹è¯•è¿æ¥
redis-cli -h <host> -p <port> PING

# æŸ¥çœ‹è¿æ¥ä¿¡æ¯
redis-cli INFO server
```

**2. æŸ¥çœ‹è¿æ¥æ•°**

```bash
# æŸ¥çœ‹å½“å‰è¿æ¥æ•°
redis-cli CLIENT LIST | wc -l

# æŸ¥çœ‹è¿æ¥è¯¦æƒ…
redis-cli CLIENT LIST

# æŸ¥çœ‹æœ€å¤§è¿æ¥æ•°
redis-cli CONFIG GET maxclients
```

**3. æŸ¥çœ‹è¿æ¥æ± çŠ¶æ€**

```java
// Jedisè¿æ¥æ± ç›‘æ§
JedisPool pool = jedisPool;
JedisPoolConfig config = pool.getPoolConfig();
System.out.println("Active: " + pool.getNumActive());
System.out.println("Idle: " + pool.getNumIdle());
System.out.println("Waiters: " + pool.getNumWaiters());
```

### å¸¸è§åŸå› 

**1. è¿æ¥æ•°è¾¾åˆ°ä¸Šé™**

```bash
# æŸ¥çœ‹æœ€å¤§è¿æ¥æ•°
redis-cli CONFIG GET maxclients

# å¢åŠ æœ€å¤§è¿æ¥æ•°
redis-cli CONFIG SET maxclients 10000
```

**2. è¿æ¥æ³„æ¼**

```java
// âŒ è¿æ¥æœªå…³é—­
Jedis jedis = jedisPool.getResource();
jedis.set("key", "value");
// å¿˜è®°å…³é—­è¿æ¥

// âœ… ä½¿ç”¨try-with-resources
try (Jedis jedis = jedisPool.getResource()) {
    jedis.set("key", "value");
}
```

**3. è¿æ¥æ± é…ç½®è¿‡å°**

```yaml
# application.yml
spring:
  redis:
    lettuce:
      pool:
        max-active: 10  # å¤ªå°
        max-idle: 5
        min-idle: 2
```

### è§£å†³æ–¹æ¡ˆ

**1. å¢åŠ è¿æ¥æ•°é™åˆ¶**

```bash
# ä¸´æ—¶å¢åŠ 
redis-cli CONFIG SET maxclients 10000

# æ°¸ä¹…ç”Ÿæ•ˆï¼ˆä¿®æ”¹é…ç½®æ–‡ä»¶ï¼‰
maxclients 10000
```

**2. æ£€æŸ¥è¿æ¥æ³„æ¼**

```java
// å¯ç”¨è¿æ¥æ³„æ¼æ£€æµ‹
// ç›‘æ§è¿æ¥æ± çŠ¶æ€
// åŠæ—¶å…³é—­è¿æ¥
```

**3. ä¼˜åŒ–è¿æ¥æ± é…ç½®**

```yaml
spring:
  redis:
    lettuce:
      pool:
        max-active: 20
        max-idle: 10
        min-idle: 5
        max-wait: 1000
```

---

## ç¼“å­˜ç©¿é€

### é—®é¢˜æè¿°

**ç¼“å­˜ç©¿é€**ï¼šæŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ®ï¼Œç¼“å­˜æœªå‘½ä¸­ï¼Œè¯·æ±‚ç›´æ¥æ‰“åˆ°æ•°æ®åº“

**å½±å“**ï¼š
```
- å¤§é‡è¯·æ±‚æ‰“åˆ°æ•°æ®åº“
- æ•°æ®åº“å‹åŠ›å¤§
- å¯èƒ½å½±å“æ­£å¸¸ä¸šåŠ¡
```

### æ’æŸ¥æ–¹æ³•

**1. æŸ¥çœ‹ç¼“å­˜å‘½ä¸­ç‡**

```bash
# æŸ¥çœ‹å‘½ä¸­ç‡
redis-cli INFO stats | grep keyspace_hits
redis-cli INFO stats | grep keyspace_misses

# è®¡ç®—å‘½ä¸­ç‡
å‘½ä¸­ç‡ = keyspace_hits / (keyspace_hits + keyspace_misses)
```

**2. åˆ†æè¯·æ±‚æ—¥å¿—**

```bash
# æŸ¥çœ‹è¯·æ±‚æ—¥å¿—
grep "cache miss" application.log
grep "database query" application.log
```

### è§£å†³æ–¹æ¡ˆ

**1. å¸ƒéš†è¿‡æ»¤å™¨**

```java
// ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨å¿«é€Ÿåˆ¤æ–­
if (!bloomFilter.exists(key)) {
    return null;  // ä¸å­˜åœ¨ï¼Œç›´æ¥è¿”å›
}

// æŸ¥è¯¢ç¼“å­˜
String value = redis.get(key);
if (value != null) {
    return value;
}

// æŸ¥è¯¢æ•°æ®åº“
value = db.query(key);
if (value != null) {
    redis.set(key, value);
} else {
    // ç¼“å­˜ç©ºå€¼ï¼ˆçŸ­æœŸï¼‰
    redis.setex(key, 300, "");  // 5åˆ†é’Ÿ
}
```

**2. ç¼“å­˜ç©ºå€¼**

```java
// æŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ®ï¼Œç¼“å­˜ç©ºå€¼
String value = redis.get(key);
if (value != null) {
    if (value.isEmpty()) {
        return null;  // ç©ºå€¼ï¼Œç›´æ¥è¿”å›
    }
    return value;
}

value = db.query(key);
if (value != null) {
    redis.set(key, value);
} else {
    // ç¼“å­˜ç©ºå€¼ï¼ˆçŸ­æœŸï¼Œé¿å…ç©¿é€ï¼‰
    redis.setex(key, 300, "");  // 5åˆ†é’Ÿ
}
```

**3. å‚æ•°æ ¡éªŒ**

```java
// å‚æ•°æ ¡éªŒï¼Œè¿‡æ»¤æ— æ•ˆè¯·æ±‚
if (id == null || id <= 0) {
    return null;
}
```

---

## ç¼“å­˜å‡»ç©¿

### é—®é¢˜æè¿°

**ç¼“å­˜å‡»ç©¿**ï¼šçƒ­ç‚¹keyè¿‡æœŸï¼Œå¤§é‡è¯·æ±‚åŒæ—¶æ‰“åˆ°æ•°æ®åº“

**å½±å“**ï¼š
```
- æ•°æ®åº“å‹åŠ›çªå¢
- å¯èƒ½å½±å“ç³»ç»Ÿæ€§èƒ½
```

### æ’æŸ¥æ–¹æ³•

**1. æŸ¥çœ‹çƒ­ç‚¹key**

```bash
# æŸ¥çœ‹çƒ­key
redis-cli --hotkeys

# åˆ†ækeyè®¿é—®é¢‘ç‡
redis-cli MONITOR | grep "GET"
```

**2. åˆ†æè¯·æ±‚æ¨¡å¼**

```bash
# æŸ¥çœ‹è¯·æ±‚æ—¥å¿—
grep "cache miss" application.log
grep "database query" application.log
```

### è§£å†³æ–¹æ¡ˆ

**1. çƒ­ç‚¹keyæ°¸ä¸è¿‡æœŸ**

```java
// çƒ­ç‚¹keyè®¾ç½®ä¸ºæ°¸ä¸è¿‡æœŸ
redis.set("hot:key", value);
redis.persist("hot:key");  // å–æ¶ˆè¿‡æœŸæ—¶é—´
```

**2. äº’æ–¥é”æ›´æ–°ç¼“å­˜**

```java
// ä½¿ç”¨åˆ†å¸ƒå¼é”ï¼Œåªå…è®¸ä¸€ä¸ªçº¿ç¨‹æ›´æ–°ç¼“å­˜
String lockKey = "lock:" + key;
if (redis.setnx(lockKey, "1", 60)) {  // è·å–é”
    try {
        // æŸ¥è¯¢æ•°æ®åº“
        String value = db.query(key);
        if (value != null) {
            redis.set(key, value);
        }
    } finally {
        redis.del(lockKey);  // é‡Šæ”¾é”
    }
} else {
    // æœªè·å–åˆ°é”ï¼Œç­‰å¾…ä¸€æ®µæ—¶é—´åé‡è¯•
    Thread.sleep(100);
    return redis.get(key);
}
```

**3. é€»è¾‘è¿‡æœŸï¼ˆå¼‚æ­¥æ›´æ–°ï¼‰**

```java
// é€»è¾‘è¿‡æœŸï¼škeyæ°¸ä¸è¿‡æœŸï¼Œä½†å­˜å‚¨è¿‡æœŸæ—¶é—´
String value = redis.get(key);
if (value != null) {
    long expireTime = getExpireTime(key);
    if (expireTime > System.currentTimeMillis()) {
        return value;  // æœªè¿‡æœŸ
    }
    // è¿‡æœŸï¼Œå¼‚æ­¥æ›´æ–°
    asyncUpdateCache(key);
    return value;  // è¿”å›æ—§å€¼
}
```

---

## ç¼“å­˜é›ªå´©

### é—®é¢˜æè¿°

**ç¼“å­˜é›ªå´©**ï¼šå¤§é‡keyåŒæ—¶è¿‡æœŸï¼Œå¤§é‡è¯·æ±‚åŒæ—¶æ‰“åˆ°æ•°æ®åº“

**å½±å“**ï¼š
```
- æ•°æ®åº“å‹åŠ›çªå¢
- ç³»ç»Ÿæ€§èƒ½ä¸‹é™
- å¯èƒ½å½±å“ç³»ç»Ÿç¨³å®šæ€§
```

### æ’æŸ¥æ–¹æ³•

**1. æŸ¥çœ‹keyè¿‡æœŸæƒ…å†µ**

```bash
# æŸ¥çœ‹keyè¿‡æœŸæ—¶é—´
redis-cli TTL key

# åˆ†æè¿‡æœŸæ—¶é—´åˆ†å¸ƒ
redis-cli --scan | while read key; do
    echo "$key: $(redis-cli TTL $key)"
done
```

**2. åˆ†æè¯·æ±‚æ¨¡å¼**

```bash
# æŸ¥çœ‹è¯·æ±‚æ—¥å¿—
grep "cache miss" application.log | tail -100
```

### è§£å†³æ–¹æ¡ˆ

**1. è¿‡æœŸæ—¶é—´åŠ éšæœºå€¼**

```java
// è¿‡æœŸæ—¶é—´åŠ éšæœºå€¼ï¼Œé¿å…åŒæ—¶è¿‡æœŸ
int expireTime = 3600 + (int)(Math.random() * 600);  // 3600-4200ç§’
redis.setex(key, expireTime, value);
```

**2. å¤šçº§ç¼“å­˜**

```java
// å¤šçº§ç¼“å­˜ï¼šæœ¬åœ°ç¼“å­˜ + Redis
// æœ¬åœ°ç¼“å­˜ï¼šCaffeineï¼ˆæ›´çŸ­è¿‡æœŸæ—¶é—´ï¼‰
// Redisç¼“å­˜ï¼šè¾ƒé•¿è¿‡æœŸæ—¶é—´
```

**3. é™æµé™çº§**

```java
// é™æµä¿æŠ¤ï¼šé™åˆ¶æ•°æ®åº“è¯·æ±‚æ•°
if (rateLimiter.tryAcquire()) {
    // æŸ¥è¯¢æ•°æ®åº“
} else {
    // è¿”å›é»˜è®¤å€¼æˆ–é™çº§
    return getDefaultValue();
}
```

**4. ç¼“å­˜é¢„çƒ­**

```java
// ç³»ç»Ÿå¯åŠ¨æ—¶ï¼Œé¢„çƒ­çƒ­ç‚¹æ•°æ®
@PostConstruct
public void warmUpCache() {
    List<String> hotKeys = getHotKeys();
    for (String key : hotKeys) {
        String value = db.query(key);
        redis.set(key, value);
    }
}
```

---

## å¤§keyå’Œçƒ­key

### å¤§keyé—®é¢˜

**ç—‡çŠ¶**ï¼š
```
âœ… Rediså†…å­˜å ç”¨é«˜
âœ… æ“ä½œæ…¢ï¼ˆGET/SETï¼‰
âœ… ç½‘ç»œä¼ è¾“æ…¢
âœ… å¯èƒ½é˜»å¡å…¶ä»–æ“ä½œ
```

**æ’æŸ¥æ–¹æ³•**ï¼š

```bash
# æŸ¥æ‰¾å¤§key
redis-cli --bigkeys

# åˆ†ækeyå¤§å°
redis-cli MEMORY USAGE key
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```java
// 1. æ‹†åˆ†å¤§key
// âŒ å¤§key
redis.set("user:10001:orders", largeJson);

// âœ… æ‹†åˆ†
redis.set("user:10001:orders:count", count);
redis.lpush("user:10001:orders", order1, order2, ...);

// 2. å‹ç¼©æ•°æ®
String compressed = compress(largeJson);
redis.set("key", compressed);

// 3. ä½¿ç”¨Hashåˆ†ç‰‡
for (int i = 0; i < 100; i++) {
    redis.hset("key:hash", "field" + i, value);
}
```

### çƒ­keyé—®é¢˜

**ç—‡çŠ¶**ï¼š
```
âœ… å•ä¸ªkeyè®¿é—®é¢‘ç‡é«˜
âœ… Redis CPUä½¿ç”¨ç‡é«˜
âœ… å¯èƒ½æˆä¸ºç“¶é¢ˆ
```

**æ’æŸ¥æ–¹æ³•**ï¼š

```bash
# æŸ¥æ‰¾çƒ­key
redis-cli --hotkeys

# ç›‘æ§keyè®¿é—®
redis-cli MONITOR | grep "GET"
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```java
// 1. æœ¬åœ°ç¼“å­˜
// ä½¿ç”¨Caffeineæœ¬åœ°ç¼“å­˜çƒ­ç‚¹æ•°æ®
Cache<String, String> localCache = Caffeine.newBuilder()
    .maximumSize(1000)
    .expireAfterWrite(5, TimeUnit.MINUTES)
    .build();

String value = localCache.get(key, k -> redis.get(k));

// 2. ä¸»ä»è¯»å†™åˆ†ç¦»
// è¯»è¯·æ±‚è·¯ç”±åˆ°ä»åº“
Jedis jedis = slaveJedisPool.getResource();
String value = jedis.get(key);

// 3. keyåˆ†ç‰‡
// å°†çƒ­ç‚¹keyåˆ†ç‰‡åˆ°å¤šä¸ªkey
String shardKey = "key:" + (hash(key) % 10);
String value = redis.get(shardKey);
```

---

## ç¼“å­˜ä¼˜åŒ–å»ºè®®

### 1. ç¼“å­˜ç­–ç•¥

```
âœ… Cache Asideï¼ˆæ—è·¯ç¼“å­˜ï¼‰
âœ… Read Throughï¼ˆè¯»ç©¿é€ï¼‰
âœ… Write Throughï¼ˆå†™ç©¿é€ï¼‰
âœ… Write Behindï¼ˆå†™å›ï¼‰
```

### 2. ç¼“å­˜è®¾è®¡

```
âœ… åˆç†è®¾ç½®è¿‡æœŸæ—¶é—´
âœ… é¿å…ç¼“å­˜ç©¿é€/å‡»ç©¿/é›ªå´©
âœ… å¤„ç†å¤§keyå’Œçƒ­key
âœ… ç›‘æ§ç¼“å­˜å‘½ä¸­ç‡
```

### 3. ç¼“å­˜ç›‘æ§

```
âœ… ç¼“å­˜å‘½ä¸­ç‡
âœ… ç¼“å­˜å¤§å°
âœ… è¿æ¥æ•°
âœ… æ…¢æŸ¥è¯¢
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æ€§èƒ½é—®é¢˜æ’æŸ¥](./01_æ€§èƒ½é—®é¢˜æ’æŸ¥.md)
- [Redisæ ¸å¿ƒæœºåˆ¶è¯¦è§£](../../04_ç¼“å­˜/Redisæ ¸å¿ƒæœºåˆ¶è¯¦è§£.md)
- [ç¼“å­˜æ¶æ„è®¾è®¡ä¸å®æˆ˜](../../04_ç¼“å­˜/ç¼“å­˜æ¶æ„è®¾è®¡ä¸å®æˆ˜.md)

---

**æœ€åæ›´æ–°**: 2025-10-29  
**æ–‡æ¡£çŠ¶æ€**: âœ… æ¡†æ¶å·²æ­å»ºï¼Œå†…å®¹æŒç»­å®Œå–„ä¸­


### å¸ƒéš†è¿‡æ»¤å™¨å®ç°ç¼“å­˜ç©¿é€é˜²æŠ¤

**1. å¼•å…¥Guavaå¸ƒéš†è¿‡æ»¤å™¨**

```xml
<!-- Mavenä¾èµ– -->
<dependency>
    <groupId>com.google.guava</groupId>
    <artifactId>guava</artifactId>
    <version>31.1-jre</version>
</dependency>
```

**2. åˆå§‹åŒ–å¸ƒéš†è¿‡æ»¤å™¨**

```java
@Configuration
public class BloomFilterConfig {
    
    @Bean
    public BloomFilter<Long> idBloomFilter() {
        // é¢„è®¡æ•°æ®é‡100ä¸‡ï¼Œè¯¯åˆ¤ç‡0.01
        int expectedInsertions = 1000000;
        double fpp = 0.01;
        
        return BloomFilter.create(
            Funnels.longFunnel(),
            expectedInsertions,
            fpp
        );
    }
}
```

**3. é¢„çƒ­å¸ƒéš†è¿‡æ»¤å™¨**

```java
@Component
public class BloomFilterInitializer implements CommandLineRunner {
    
    @Autowired
    private BloomFilter<Long> idBloomFilter;
    
    @Autowired
    private ProductMapper productMapper;
    
    @Override
    public void run(String... args) throws Exception {
        // ä»æ•°æ®åº“åŠ è½½æ‰€æœ‰æœ‰æ•ˆIDåˆ°å¸ƒéš†è¿‡æ»¤å™¨
        List<Long> allIds = productMapper.selectAllIds();
        for (Long id : allIds) {
            idBloomFilter.put(id);
        }
    }
}
```

**4. æ¥å£å±‚é˜²æŠ¤å®ç°**

```java
@Service
public class ProductService {
    
    @Autowired
    private BloomFilter<Long> idBloomFilter;
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @Autowired
    private ProductMapper productMapper;
    
    public Product getProductById(Long id) {
        // 1. å‚æ•°æ ¡éªŒ
        if (id == null || id <= 0) {
            return null;
        }
        
        // 2. å¸ƒéš†è¿‡æ»¤å™¨è¿‡æ»¤æ— æ•ˆID
        if (!idBloomFilter.mightContain(id)) {
            log.warn("æ— æ•ˆIDè¯·æ±‚: {}", id);
            return null;
        }
        
        // 3. æŸ¥è¯¢ç¼“å­˜
        String key = "product:" + id;
        Product product = (Product) redisTemplate.opsForValue().get(key);
        if (product != null) {
            return product;
        }
        
        // 4. æŸ¥è¯¢æ•°æ®åº“
        product = productMapper.selectById(id);
        if (product != null) {
            // 5. å†™å…¥ç¼“å­˜
            redisTemplate.opsForValue().set(key, product, 30, TimeUnit.MINUTES);
        } else {
            // 6. ç¼“å­˜ç©ºå€¼
            redisTemplate.opsForValue().set(key, NULL_VALUE, 5, TimeUnit.MINUTES);
        }
        
        return product;
    }
}
```

**5. Rediså¸ƒéš†è¿‡æ»¤å™¨å®ç°ï¼ˆé€‚ç”¨äºåˆ†å¸ƒå¼ç³»ç»Ÿï¼‰**

```java
@Component
public class RedisBloomFilter {
    
    @Autowired
    private StringRedisTemplate redisTemplate;
    
    // æ·»åŠ å…ƒç´ åˆ°å¸ƒéš†è¿‡æ»¤å™¨
    public <T> void add(String filterName, Funnel<T> funnel, T value) {
        int numBits = 1 << 29; // 536870912 bits
        int numHashFunctions = 7;
        
        long[] indices = Hashing.murmur3_128().hashObjectHash(value, funnel);
        for (int i = 0; i < numHashFunctions; i++) {
            long index = indices[i] % numBits;
            redisTemplate.opsForValue().setBit(filterName, index, true);
        }
    }
    
    // åˆ¤æ–­å…ƒç´ æ˜¯å¦åœ¨å¸ƒéš†è¿‡æ»¤å™¨ä¸­
    public <T> boolean contains(String filterName, Funnel<T> funnel, T value) {
        int numBits = 1 << 29;
        int numHashFunctions = 7;
        
        long[] indices = Hashing.murmur3_128().hashObject(value, funnel).asLongs();
        for (int i = 0; i < numHashFunctions; i++) {
            long index = indices[i] % numBits;
            if (!redisTemplate.opsForValue().getBit(filterName, index)) {
                return false;
            }
        }
        return true;
    }
}
```

---

### å¤šçº§ç¼“å­˜æ¶æ„å®ç°

**1. å¤šçº§ç¼“å­˜è®¾è®¡**

```
æœ¬åœ°ç¼“å­˜ (Caffeine) â†’ Redis åˆ†å¸ƒå¼ç¼“å­˜ â†’ æ•°æ®åº“
```

**2. Caffeineæœ¬åœ°ç¼“å­˜é…ç½®**

```java
@Configuration
public class CaffeineConfig {
    
    @Bean
    public Cache<String, Object> localCache() {
        return Caffeine.newBuilder()
            .maximumSize(10_000)  // æœ€å¤§ç¼“å­˜æ•°é‡
            .expireAfterWrite(5, TimeUnit.MINUTES)  // å†™å…¥åè¿‡æœŸæ—¶é—´
            .recordStats()  // å¼€å¯ç»Ÿè®¡
            .build();
    }
}
```

**3. å¤šçº§ç¼“å­˜å®ç°**

```java
@Service
public class ProductService {
    
    @Autowired
    private Cache<String, Object> localCache;
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @Autowired
    private ProductMapper productMapper;
    
    public Product getProductById(Long id) {
        // 1. æ£€æŸ¥æœ¬åœ°ç¼“å­˜
        String key = "product:" + id;
        Product product = (Product) localCache.getIfPresent(key);
        if (product != null) {
            return product;
        }
        
        // 2. æ£€æŸ¥Redisç¼“å­˜
        product = (Product) redisTemplate.opsForValue().get(key);
        if (product != null) {
            // 3. å†™å…¥æœ¬åœ°ç¼“å­˜
            localCache.put(key, product);
            return product;
        }
        
        // 4. æŸ¥è¯¢æ•°æ®åº“
        product = productMapper.selectById(id);
        if (product != null) {
            // 5. å†™å…¥Redis
            redisTemplate.opsForValue().set(key, product, 30, TimeUnit.MINUTES);
            // 6. å†™å…¥æœ¬åœ°ç¼“å­˜
            localCache.put(key, product);
        }
        
        return product;
    }
}
```

**4. ç¼“å­˜ä¸€è‡´æ€§ç»´æŠ¤**

```java
// æ›´æ–°æ•°æ®æ—¶åŒæ­¥æ›´æ–°å„çº§ç¼“å­˜
@Transactional
public void updateProduct(Product product) {
    // 1. æ›´æ–°æ•°æ®åº“
    productMapper.updateById(product);
    
    String key = "product:" + product.getId();
    
    // 2. åˆ é™¤æœ¬åœ°ç¼“å­˜
    localCache.invalidate(key);
    
    // 3. åˆ é™¤Redisç¼“å­˜
    redisTemplate.delete(key);
    
    // 4. å¯é€‰ï¼šä¸»åŠ¨æ›´æ–°ç¼“å­˜
    // redisTemplate.opsForValue().set(key, product, 30, TimeUnit.MINUTES);
    // localCache.put(key, product);
}
```

**5. çƒ­ç‚¹æ•°æ®è‡ªåŠ¨é¢„çƒ­**

```java
@Component
public class HotDataPreloader {
    
    @Autowired
    private ProductMapper productMapper;
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @Autowired
    private Cache<String, Object> localCache;
    
    @Scheduled(cron = "0 0 1 * * ?")  // æ¯å¤©å‡Œæ™¨1ç‚¹æ‰§è¡Œ
    public void preloadHotData() {
        // 1. æŸ¥è¯¢çƒ­ç‚¹æ•°æ®
        List<Product> hotProducts = productMapper.selectHotProducts(100);
        
        // 2. é¢„çƒ­Redisç¼“å­˜
        for (Product product : hotProducts) {
            String key = "product:" + product.getId();
            redisTemplate.opsForValue().set(key, product, 1, TimeUnit.DAYS);
            
            // 3. é¢„çƒ­æœ¬åœ°ç¼“å­˜
            localCache.put(key, product);
        }
    }
}
```

---