# åˆ†å¸ƒå¼ç³»ç»Ÿé—®é¢˜æ’æŸ¥

> å®æˆ˜æŒ‡å—ï¼šå¦‚ä½•æ’æŸ¥æœåŠ¡è°ƒç”¨å¤±è´¥ã€åˆ†å¸ƒå¼äº‹åŠ¡ã€é…ç½®ä¸­å¿ƒç­‰åˆ†å¸ƒå¼ç³»ç»Ÿé—®é¢˜

## ğŸ“‹ ç›®å½•
- [å¸¸è§é—®é¢˜ç±»å‹](#å¸¸è§é—®é¢˜ç±»å‹)
- [æœåŠ¡è°ƒç”¨å¤±è´¥](#æœåŠ¡è°ƒç”¨å¤±è´¥)
- [åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜](#åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜)
- [é…ç½®ä¸­å¿ƒé—®é¢˜](#é…ç½®ä¸­å¿ƒé—®é¢˜)
- [æœåŠ¡æ³¨å†Œå‘ç°](#æœåŠ¡æ³¨å†Œå‘ç°)

---

## å¸¸è§é—®é¢˜ç±»å‹

### 1. æœåŠ¡è°ƒç”¨å¤±è´¥

**ç—‡çŠ¶**ï¼š
```
âœ… RPCè°ƒç”¨å¤±è´¥
âœ… HTTPè°ƒç”¨è¶…æ—¶
âœ… æœåŠ¡ä¸å¯è®¿é—®
```

### 2. åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜

**ç—‡çŠ¶**ï¼š
```
âœ… äº‹åŠ¡ä¸ä¸€è‡´
âœ… äº‹åŠ¡å›æ»šå¤±è´¥
âœ… æ•°æ®ä¸ä¸€è‡´
```

### 3. é…ç½®ä¸­å¿ƒé—®é¢˜

**ç—‡çŠ¶**ï¼š
```
âœ… é…ç½®æœªç”Ÿæ•ˆ
âœ… é…ç½®ä¸¢å¤±
âœ… é…ç½®ä¸­å¿ƒä¸å¯ç”¨
```

### 4. æœåŠ¡æ³¨å†Œå‘ç°

**ç—‡çŠ¶**ï¼š
```
âœ… æœåŠ¡æœªæ³¨å†Œ
âœ… æœåŠ¡å‘ç°å¤±è´¥
âœ… æœåŠ¡ä¸å¯ç”¨
```

---

## æœåŠ¡è°ƒç”¨å¤±è´¥

### æ’æŸ¥æ–¹æ³•

**1. æŸ¥çœ‹è°ƒç”¨æ—¥å¿—**

```bash
# æŸ¥çœ‹è°ƒç”¨æ—¥å¿—
grep "RPCè°ƒç”¨å¤±è´¥" application.log
grep "Connection refused" application.log
grep "Timeout" application.log
```

**2. æµ‹è¯•æœåŠ¡è¿é€šæ€§**

```bash
# æµ‹è¯•æœåŠ¡è¿é€šæ€§
curl http://<host>:<port>/health
telnet <host> <port>
```

**3. æŸ¥çœ‹æœåŠ¡æ³¨å†Œ**

```bash
# æŸ¥çœ‹æœåŠ¡æ³¨å†Œæƒ…å†µ
# Nacos
curl http://<nacos_host>:8848/nacos/v1/ns/instance/list?serviceName=<service_name>

# Eureka
curl http://<eureka_host>:8761/eureka/apps/<service_name>
```

### å¸¸è§åŸå› 

**1. æœåŠ¡ä¸å¯ç”¨**

```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
curl http://<host>:<port>/health
```

**2. ç½‘ç»œé—®é¢˜**

```bash
# æµ‹è¯•ç½‘ç»œè¿é€šæ€§
ping <host>
telnet <host> <port>
```

**3. è´Ÿè½½å‡è¡¡é—®é¢˜**

```bash
# æ£€æŸ¥è´Ÿè½½å‡è¡¡é…ç½®
# æ£€æŸ¥æœåŠ¡å®ä¾‹çŠ¶æ€
```

### è§£å†³æ–¹æ¡ˆ

**1. æ£€æŸ¥æœåŠ¡çŠ¶æ€**

```bash
# æ£€æŸ¥æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ
# æ£€æŸ¥å¥åº·æ£€æŸ¥æ˜¯å¦é€šè¿‡
```

**2. æ£€æŸ¥ç½‘ç»œ**

```bash
# æ£€æŸ¥ç½‘ç»œè¿é€šæ€§
# æ£€æŸ¥é˜²ç«å¢™è§„åˆ™
```

**3. æ£€æŸ¥è´Ÿè½½å‡è¡¡**

```bash
# æ£€æŸ¥è´Ÿè½½å‡è¡¡é…ç½®
# æ£€æŸ¥æœåŠ¡å®ä¾‹çŠ¶æ€
```

---

## åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜

### æ’æŸ¥æ–¹æ³•

**1. æŸ¥çœ‹äº‹åŠ¡æ—¥å¿—**

```bash
# æŸ¥çœ‹äº‹åŠ¡æ—¥å¿—
grep "äº‹åŠ¡å›æ»š" application.log
grep "äº‹åŠ¡æäº¤å¤±è´¥" application.log
```

**2. æŸ¥çœ‹äº‹åŠ¡çŠ¶æ€**

```bash
# æŸ¥çœ‹äº‹åŠ¡çŠ¶æ€
# Seata
curl http://<seata_host>:7091/api/v1/transaction/status

# æŸ¥çœ‹äº‹åŠ¡æ—¥å¿—
```

### å¸¸è§åŸå› 

**1. äº‹åŠ¡è¶…æ—¶**

```java
// äº‹åŠ¡è¶…æ—¶
@Transactional(timeout = 10)
public void longTransaction() {
    // äº‹åŠ¡æ‰§è¡Œæ—¶é—´è¿‡é•¿
}
```

**2. ç½‘ç»œé—®é¢˜**

```bash
# ç½‘ç»œé—®é¢˜å¯¼è‡´äº‹åŠ¡å¤±è´¥
# æ£€æŸ¥ç½‘ç»œè¿é€šæ€§
```

**3. æœåŠ¡ä¸å¯ç”¨**

```bash
# å‚ä¸äº‹åŠ¡çš„æœåŠ¡ä¸å¯ç”¨
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
```

### è§£å†³æ–¹æ¡ˆ

**1. ä¼˜åŒ–äº‹åŠ¡èŒƒå›´**

```java
// å‡å°‘äº‹åŠ¡èŒƒå›´
@Transactional
public void shortTransaction() {
    // å¿«é€Ÿæ‰§è¡Œ
}
```

**2. å¢åŠ é‡è¯•æœºåˆ¶**

```java
// å¢åŠ é‡è¯•æœºåˆ¶
@Retryable(maxAttempts = 3, backoff = @Backoff(delay = 1000))
public void distributedTransaction() {
    // åˆ†å¸ƒå¼äº‹åŠ¡
}
```

**3. ä½¿ç”¨æœ€ç»ˆä¸€è‡´æ€§**

```java
// ä½¿ç”¨æœ€ç»ˆä¸€è‡´æ€§
// æ¶ˆæ¯é˜Ÿåˆ— + è¡¥å¿æœºåˆ¶
```

---

## é…ç½®ä¸­å¿ƒé—®é¢˜

### æ’æŸ¥æ–¹æ³•

**1. æŸ¥çœ‹é…ç½®**

```bash
# NacosæŸ¥çœ‹é…ç½®
curl http://<nacos_host>:8848/nacos/v1/cs/configs?dataId=<dataId>&group=<group>

# ApolloæŸ¥çœ‹é…ç½®
curl http://<apollo_host>:8080/configs/<appId>/<cluster>/<namespace>
```

**2. æŸ¥çœ‹é…ç½®å˜æ›´æ—¥å¿—**

```bash
# æŸ¥çœ‹é…ç½®å˜æ›´æ—¥å¿—
grep "é…ç½®å˜æ›´" application.log
```

### å¸¸è§åŸå› 

**1. é…ç½®æœªç”Ÿæ•ˆ**

```bash
# é…ç½®æœªç”Ÿæ•ˆ
# æ£€æŸ¥é…ç½®ä¸­å¿ƒè¿æ¥
# æ£€æŸ¥é…ç½®åˆ·æ–°æœºåˆ¶
```

**2. é…ç½®ä¸¢å¤±**

```bash
# é…ç½®ä¸¢å¤±
# æ£€æŸ¥é…ç½®ä¸­å¿ƒå¤‡ä»½
# æ£€æŸ¥é…ç½®åŒæ­¥
```

**3. é…ç½®ä¸­å¿ƒä¸å¯ç”¨**

```bash
# é…ç½®ä¸­å¿ƒä¸å¯ç”¨
# æ£€æŸ¥é…ç½®ä¸­å¿ƒæœåŠ¡çŠ¶æ€
```

### è§£å†³æ–¹æ¡ˆ

**1. æ£€æŸ¥é…ç½®ä¸­å¿ƒè¿æ¥**

```bash
# æ£€æŸ¥é…ç½®ä¸­å¿ƒæœåŠ¡çŠ¶æ€
# æ£€æŸ¥ç½‘ç»œè¿é€šæ€§
```

**2. é…ç½®æœ¬åœ°ç¼“å­˜**

```java
// é…ç½®æœ¬åœ°ç¼“å­˜
// é…ç½®ä¸­å¿ƒä¸å¯ç”¨æ—¶ä½¿ç”¨æœ¬åœ°é…ç½®
```

**3. é…ç½®å¤‡ä»½**

```bash
# é…ç½®å¤‡ä»½
# å®šæœŸå¤‡ä»½é…ç½®
```

---

## æœåŠ¡æ³¨å†Œå‘ç°

### æ’æŸ¥æ–¹æ³•

**1. æŸ¥çœ‹æœåŠ¡æ³¨å†Œ**

```bash
# NacosæŸ¥çœ‹æœåŠ¡æ³¨å†Œ
curl http://<nacos_host>:8848/nacos/v1/ns/instance/list?serviceName=<service_name>

# EurekaæŸ¥çœ‹æœåŠ¡æ³¨å†Œ
curl http://<eureka_host>:8761/eureka/apps
```

**2. æŸ¥çœ‹æœåŠ¡å‘ç°**

```bash
# æŸ¥çœ‹æœåŠ¡å‘ç°æ—¥å¿—
grep "æœåŠ¡å‘ç°" application.log
grep "æœåŠ¡ä¸å¯ç”¨" application.log
```

### å¸¸è§åŸå› 

**1. æœåŠ¡æœªæ³¨å†Œ**

```bash
# æœåŠ¡æœªæ³¨å†Œ
# æ£€æŸ¥æœåŠ¡æ³¨å†Œé…ç½®
# æ£€æŸ¥æœåŠ¡æ³¨å†Œä¸­å¿ƒè¿æ¥
```

**2. æœåŠ¡å‘ç°å¤±è´¥**

```bash
# æœåŠ¡å‘ç°å¤±è´¥
# æ£€æŸ¥æœåŠ¡å‘ç°é…ç½®
# æ£€æŸ¥æœåŠ¡æ³¨å†Œä¸­å¿ƒè¿æ¥
```

**3. æœåŠ¡å¥åº·æ£€æŸ¥å¤±è´¥**

```bash
# æœåŠ¡å¥åº·æ£€æŸ¥å¤±è´¥
# æ£€æŸ¥å¥åº·æ£€æŸ¥æ¥å£
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
```

### è§£å†³æ–¹æ¡ˆ

**1. æ£€æŸ¥æœåŠ¡æ³¨å†Œé…ç½®**

```yaml
# æ£€æŸ¥æœåŠ¡æ³¨å†Œé…ç½®
spring:
  cloud:
    nacos:
      discovery:
        server-addr: <nacos_host>:8848
        service-name: <service_name>
```

**2. æ£€æŸ¥æœåŠ¡å‘ç°é…ç½®**

```yaml
# æ£€æŸ¥æœåŠ¡å‘ç°é…ç½®
spring:
  cloud:
    nacos:
      discovery:
        server-addr: <nacos_host>:8848
```

**3. æ£€æŸ¥å¥åº·æ£€æŸ¥**

```java
// æ£€æŸ¥å¥åº·æ£€æŸ¥æ¥å£
@GetMapping("/health")
public String health() {
    return "UP";
}
```

---

## åˆ†å¸ƒå¼é”é—®é¢˜

### æ’æŸ¥æ–¹æ³•

**1. æŸ¥çœ‹é”æŒæœ‰æƒ…å†µ**

```bash
# Redisåˆ†å¸ƒå¼é”æŸ¥çœ‹
redis-cli KEYS "lock:*"
redis-cli GET "lock:order:123"

# ZooKeeperåˆ†å¸ƒå¼é”æŸ¥çœ‹
zkCli.sh get /locks/order/lock-0000000001
```

**2. æ£€æŸ¥é”è¶…æ—¶è®¾ç½®**

```java
// æ£€æŸ¥Redisé”è¶…æ—¶è®¾ç½®
String lockKey = "lock:order:" + orderId;
boolean locked = redisTemplate.opsForValue().setIfAbsent(lockKey, "1", 30, TimeUnit.SECONDS);
```

### å¸¸è§åŸå› 

**1. æ­»é”**

```java
// é”™è¯¯ç¤ºä¾‹ï¼šæœªè®¾ç½®è¶…æ—¶æ—¶é—´
boolean locked = redisTemplate.opsForValue().setIfAbsent(lockKey, "1");
// æ­£ç¡®ç¤ºä¾‹ï¼šè®¾ç½®è¶…æ—¶æ—¶é—´
boolean locked = redisTemplate.opsForValue().setIfAbsent(lockKey, "1", 30, TimeUnit.SECONDS);
```

**2. é”é‡Šæ”¾é—®é¢˜**

```java
// é”™è¯¯ç¤ºä¾‹ï¼šæœªåœ¨finallyä¸­é‡Šæ”¾é”
if (locked) {
    try {
        // ä¸šåŠ¡é€»è¾‘
    } catch (Exception e) {
        // å¼‚å¸¸å¤„ç†
    }
    redisTemplate.delete(lockKey);
}

// æ­£ç¡®ç¤ºä¾‹ï¼šåœ¨finallyä¸­é‡Šæ”¾é”
if (locked) {
    try {
        // ä¸šåŠ¡é€»è¾‘
    } catch (Exception e) {
        // å¼‚å¸¸å¤„ç†
    } finally {
        redisTemplate.delete(lockKey);
    }
}
```

### è§£å†³æ–¹æ¡ˆ

**1. åˆ†å¸ƒå¼é”æœ€ä½³å®è·µ**

```java
// Redisåˆ†å¸ƒå¼é”æœ€ä½³å®è·µ
String lockKey = "lock:order:" + orderId;
String requestId = UUID.randomUUID().toString();
try {
    boolean locked = redisTemplate.opsForValue().setIfAbsent(lockKey, requestId, 30, TimeUnit.SECONDS);
    if (locked) {
        // ä¸šåŠ¡é€»è¾‘
    } else {
        // è·å–é”å¤±è´¥
        throw new RuntimeException("è·å–åˆ†å¸ƒå¼é”å¤±è´¥");
    }
} finally {
    // åªèƒ½é‡Šæ”¾è‡ªå·±çš„é”
    String value = redisTemplate.opsForValue().get(lockKey);
    if (requestId.equals(value)) {
        redisTemplate.delete(lockKey);
    }
}
```

**2. ä½¿ç”¨æˆç†Ÿçš„åˆ†å¸ƒå¼é”æ¡†æ¶**

```xml
<!-- Redissonä¾èµ– -->
<dependency>
    <groupId>org.redisson</groupId>
    <artifactId>redisson</artifactId>
    <version>3.16.1</version>
</dependency>
```

```java
// Redissonåˆ†å¸ƒå¼é”ä½¿ç”¨
RLock lock = redissonClient.getLock(lockKey);
try {
    boolean locked = lock.tryLock(10, 30, TimeUnit.SECONDS);
    if (locked) {
        // ä¸šåŠ¡é€»è¾‘
    }
} finally {
    if (lock.isHeldByCurrentThread()) {
        lock.unlock();
    }
}
```

### æ¡ˆä¾‹ä¸€ï¼šåˆ†å¸ƒå¼é”æ­»é”å¯¼è‡´è®¢å•å¤„ç†é˜»å¡

**é—®é¢˜æè¿°**ï¼šç”µå•†å¹³å°è®¢å•æ”¯ä»˜åçŠ¶æ€æ›´æ–°ç¼“æ…¢ï¼Œå‡ºç°å¤§é‡è®¢å•å¤„ç†è¶…æ—¶ï¼Œæ•°æ®åº“ä¸­å‡ºç°å¤§é‡æœªå®Œæˆè®¢å•ã€‚

**æ’æŸ¥è¿‡ç¨‹**ï¼š
1. æŸ¥çœ‹åº”ç”¨æ—¥å¿—å‘ç°è·å–åˆ†å¸ƒå¼é”å¤±è´¥çš„é”™è¯¯
```bash
 grep "è·å–åˆ†å¸ƒå¼é”å¤±è´¥" application.log
```
2. æ£€æŸ¥Redisä¸­çš„é”çŠ¶æ€
```bash
 redis-cli KEYS "lock:order:*"
 # å‘ç°å¤§é‡é•¿æ—¶é—´æœªé‡Šæ”¾çš„é”
 redis-cli TTL lock:order:12345
 # è¿”å›å€¼ä¸º-1ï¼Œè¡¨ç¤ºé”æœªè®¾ç½®è¿‡æœŸæ—¶é—´
```
3. åˆ†æä»£ç å‘ç°æœªæ­£ç¡®è®¾ç½®é”è¶…æ—¶æ—¶é—´
```java
// é—®é¢˜ä»£ç 
String lockKey = "lock:order:" + orderId;
boolean locked = redisTemplate.opsForValue().setIfAbsent(lockKey, "1");
// æœªè®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œå‘ç”Ÿå¼‚å¸¸æ—¶é”æ— æ³•è‡ªåŠ¨é‡Šæ”¾
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ä¿®å¤åˆ†å¸ƒå¼é”å®ç°ï¼Œæ·»åŠ è¶…æ—¶æ—¶é—´
```java
String lockKey = "lock:order:" + orderId;
String requestId = UUID.randomUUID().toString();
// è®¾ç½®30ç§’è¶…æ—¶æ—¶é—´
boolean locked = redisTemplate.opsForValue().setIfAbsent(lockKey, requestId, 30, TimeUnit.SECONDS);
if (locked) {
    try {
        // è®¢å•å¤„ç†é€»è¾‘
        processOrder(orderId);
    } finally {
        // é‡Šæ”¾é”
        String value = redisTemplate.opsForValue().get(lockKey);
        if (requestId.equals(value)) {
            redisTemplate.delete(lockKey);
        }
    }
}
```
2. éƒ¨ç½²Redissonåˆ†å¸ƒå¼é”æ¡†æ¶
```xml
<dependency>
    <groupId>org.redisson</groupId>
    <artifactId>redisson-spring-boot-starter</artifactId>
    <version>3.16.1</version>
</dependency>
```
3. æ¸…ç†æ®‹ç•™çš„æ­»é”
```bash
# ç¼–å†™è„šæœ¬æ¸…ç†è¿‡æœŸé”
redis-cli KEYS "lock:order:*" | while read key; do
    if [ $(redis-cli TTL $key) -eq -1 ]; then
        redis-cli DEL $key
        echo "Deleted expired lock: $key"
    fi
 done
```

**ä¼˜åŒ–æ•ˆæœ**ï¼šè®¢å•å¤„ç†æˆåŠŸç‡ä»75%æå‡è‡³99.9%ï¼Œå¹³å‡å¤„ç†æ—¶é—´ä»15ç§’é™è‡³2ç§’ã€‚

### æ¡ˆä¾‹äºŒï¼šRafté›†ç¾¤è„‘è£‚å¯¼è‡´æ•°æ®ä¸ä¸€è‡´

**é—®é¢˜æè¿°**ï¼šåŸºäºEtcdçš„é…ç½®ä¸­å¿ƒå‡ºç°é…ç½®æ•°æ®ä¸ä¸€è‡´ï¼Œéƒ¨åˆ†æœåŠ¡åŠ è½½äº†æ—§é…ç½®ï¼Œå¯¼è‡´æœåŠ¡è¡Œä¸ºå¼‚å¸¸ã€‚

**æ’æŸ¥è¿‡ç¨‹**ï¼š
1. æ£€æŸ¥Etcdé›†ç¾¤çŠ¶æ€
```bash
etcdctl endpoint status --write-out=table
```
2. å‘ç°é›†ç¾¤å‡ºç°ä¸¤ä¸ªLeaderèŠ‚ç‚¹
```
+----------------+------------------+---------+---------+-----------+------------+
|    ENDPOINT    |        ID        | VERSION | DB SIZE | IS LEADER | RAFT TERM |
+----------------+------------------+---------+---------+-----------+------------+
| 10.0.1.10:2379 | 6e3bd2f48db52441 |   3.5.0 |   45 MB |      true |         15 |
| 10.0.1.11:2379 | 924e2e83e93f256a |   3.5.0 |   45 MB |      true |         16 |
| 10.0.1.12:2379 | c8a7c74f2e6a5f1d |   3.5.0 |   45 MB |     false |         15 |
+----------------+------------------+---------+---------+-----------+------------+
```
3. æ£€æŸ¥ç½‘ç»œå‘ç°èŠ‚ç‚¹é—´ç½‘ç»œåˆ†åŒº

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ä¸´æ—¶å¤„ç†ï¼šç§»é™¤å¼‚å¸¸èŠ‚ç‚¹
```bash
etcdctl member remove 924e2e83e93f256a
```
2. è°ƒæ•´Raftå‚æ•°
```yaml
# etcdé…ç½®
etcd:
  name: etcd-1
  data-dir: /var/lib/etcd
  initial-cluster: etcd-1=https://10.0.1.10:2380,etcd-2=https://10.0.1.11:2380,etcd-3=https://10.0.1.12:2380
  initial-cluster-state: existing
  heartbeat-interval: 100
  election-timeout: 1000
  auto-compaction-mode: periodic
  auto-compaction-retention: "1h"
```
3. é…ç½®ç›‘æ§å‘Šè­¦
```yaml
# Prometheuså‘Šè­¦è§„åˆ™
groups:
- name: etcd_alert
  rules:
  - alert: EtcdClusterUnhealthy
    expr: sum(etcd_server_is_leader) > 1
    for: 30s
    labels:
      severity: critical
    annotations:
      summary: "Etcdé›†ç¾¤è„‘è£‚"
      description: "Etcdé›†ç¾¤å­˜åœ¨{{ $value }}ä¸ªleaderèŠ‚ç‚¹ï¼Œæ­£å¸¸åº”ä¸º1ä¸ª"
```

**ä¼˜åŒ–æ•ˆæœ**ï¼šé›†ç¾¤æ¢å¤ç¨³å®šï¼Œé…ç½®åŒæ­¥å»¶è¿Ÿä»30ç§’é™è‡³2ç§’ï¼Œæœªå†å‘ç”Ÿæ•°æ®ä¸ä¸€è‡´é—®é¢˜ã€‚

---

## åˆ†å¸ƒå¼ç³»ç»Ÿç›‘æ§ä¸å‘Šè­¦

### 1. Prometheusç›‘æ§è§„åˆ™

```yaml
# prometheus.rules.yml
groups:
- name: distributed_system_alerts
  rules:
  - alert: ServiceCallFailureRateHigh
    expr: sum(rate(http_requests_total{status=~"5.."}[5m])) / sum(rate(http_requests_total[5m])) > 0.05
    for: 2m
    labels:
      severity: critical
    annotations:
      summary: "æœåŠ¡è°ƒç”¨å¤±è´¥ç‡é«˜"
      description: "æœåŠ¡è°ƒç”¨å¤±è´¥ç‡æŒç»­2åˆ†é’Ÿè¶…è¿‡5%ï¼Œå½“å‰å€¼{{ $value | humanizePercentage }}"

  - alert: DistributedLockTimeout
    expr: histogram_quantile(0.95, sum(rate(redisson_lock_acquire_seconds_bucket[5m])) by (le)) > 1
    for: 1m
    labels:
      severity: warning
    annotations:
      summary: "åˆ†å¸ƒå¼é”è·å–è¶…æ—¶"
      description: "åˆ†å¸ƒå¼é”è·å–P95å»¶è¿Ÿè¶…è¿‡1ç§’ï¼Œå½“å‰å€¼{{ $value | humanizeDuration }}"

  - alert: TransactionRollbackRateHigh
    expr: sum(rate(seata_transaction_rollback_total[5m])) / sum(rate(seata_transaction_total[5m])) > 0.03
    for: 3m
    labels:
      severity: warning
    annotations:
      summary: "åˆ†å¸ƒå¼äº‹åŠ¡å›æ»šç‡é«˜"
      description: "åˆ†å¸ƒå¼äº‹åŠ¡å›æ»šç‡æŒç»­3åˆ†é’Ÿè¶…è¿‡3%ï¼Œå½“å‰å€¼{{ $value | humanizePercentage }}"

  - alert: EtcdClusterUnhealthy
    expr: etcd_cluster_health{health="false"} == 1
    for: 30s
    labels:
      severity: critical
    annotations:
      summary: "Etcdé›†ç¾¤ä¸å¥åº·"
      description: "Etcdé›†ç¾¤å¥åº·æ£€æŸ¥å¤±è´¥"
```

### 2. Grafanaç›‘æ§é¢æ¿

æ¨èå¯¼å…¥Grafanaé¢æ¿ï¼š
- ID: 13978 (Redisson Monitoring)
- ID: 12856 (Seata Distributed Transaction)
- ID: 9659 (ETCD Cluster)

**è‡ªå®šä¹‰åˆ†å¸ƒå¼ç³»ç»Ÿç›‘æ§é¢æ¿JSONç¤ºä¾‹**ï¼š
```json
{
  "annotations": {
    "list": [
      {
        "builtIn": 1,
        "datasource": "-- Grafana --",
        "enable": true,
        "hide": true,
        "iconColor": "rgba(0, 211, 255, 1)",
        "name": "Annotations & Alerts",
        "type": "dashboard"
      }
    ]
  },
  "editable": true,
  "gnetId": null,
  "graphTooltip": 0,
  "id": 16,
  "iteration": 1605300123456,
  "links": [],
  "panels": [
    {
      "aliasColors": {},
      "bars": false,
      "dashLength": 10,
      "dashes": false,
      "datasource": "Prometheus",
      "fieldConfig": {
        "defaults": {
          "links": []
        },
        "overrides": []
      },
      "fill": 1,
      "fillGradient": 0,
      "gridPos": {
        "h": 8,
        "w": 24,
        "x": 0,
        "y": 0
      },
      "hiddenSeries": false,
      "id": 2,
      "legend": {
        "avg": false,
        "current": false,
        "max": false,
        "min": false,
        "show": true,
        "total": false,
        "values": false
      },
      "lines": true,
      "linewidth": 1,
      "nullPointMode": "null",
      "options": {
        "alertThreshold": true
      },
      "percentage": false,
      "pluginVersion": "7.3.6",
      "pointradius": 2,
      "points": false,
      "renderer": "flot",
      "seriesOverrides": [],
      "spaceLength": 10,
      "stack": false,
      "steppedLine": false,
      "targets": [
        {
          "expr": "sum(rate(http_requests_total{status=~\"2..\"}[5m])) by (service)",
          "interval": "",
          "legendFormat": "{{ service }} æˆåŠŸ",
          "refId": "A"
        },
        {
          "expr": "sum(rate(http_requests_total{status=~\"5..\"}[5m])) by (service)",
          "interval": "",
          "legendFormat": "{{ service }} å¤±è´¥",
          "refId": "B"
        }
      ],
      "thresholds": [],
      "timeFrom": null,
      "timeRegions": [],
      "timeShift": null,
      "title": "æœåŠ¡è°ƒç”¨è¯·æ±‚æ•°",
      "tooltip": {
        "shared": true,
        "sort": 0,
        "value_type": "individual"
      },
      "type": "graph",
      "xaxis": {
        "buckets": null,
        "mode": "time",
        "name": null,
        "show": true,
        "values": []
      },
      "yaxes": [
        {
          "format": "req/s",
          "label": "è¯·æ±‚æ•°",
          "logBase": 1,
          "max": null,
          "min": "0",
          "show": true
        },
        {
          "format": "short",
          "label": null,
          "logBase": 1,
          "max": null,
          "min": null,
          "show": true
        }
      ],
      "yaxis": {
        "align": false,
        "alignLevel": null
      }
    }
  ],
  "refresh": "5s",
  "schemaVersion": 27,
  "style": "dark",
  "tags": ["distributed"],
  "templating": {
    "list": []
  },
  "time": {
    "from": "now-6h",
    "to": "now"
  },
  "timepicker": {
    "refresh_intervals": [
      "5s",
      "10s",
      "30s",
      "1m",
      "5m",
      "15m",
      "30m",
      "1h",
      "2h",
      "1d"
    ]
  },
  "timezone": "",
  "title": "åˆ†å¸ƒå¼ç³»ç»Ÿç›‘æ§",
  "uid": "distributed-system-monitor",
  "version": 1
}
```

---

## åˆ†å¸ƒå¼è¿½è¸ª

### æ’æŸ¥æ–¹æ³•

**1. æŸ¥çœ‹è¿½è¸ªæ—¥å¿—**
```bash
# æŸ¥çœ‹SkyWalkingè¿½è¸ª
curl http://<skywalking_host>:12800/graphql -X POST -H "Content-Type: application/json" -d '{"query":"query {trace(traceId:\"<trace_id>\") {spans {operationName startTime endTime logs {time content}}}}"}'

# æŸ¥çœ‹Jaegerè¿½è¸ª
curl http://<jaeger_host>:16686/api/traces/<trace_id>
```

**2. æ£€æŸ¥è¿½è¸ªé…ç½®**
```yaml
# SkyWalkingé…ç½®
skywalking:
  agent:
    service_name: your-service-name
    collector_backend_service: skywalking-collector:11800
```

### å¸¸è§åŸå› 

**1. è¿½è¸ªä¿¡æ¯ä¸¢å¤±**
```yaml
# å¯èƒ½çš„åŸå› ï¼šé‡‡æ ·ç‡è®¾ç½®è¿‡ä½
skywalking:
  agent:
    sampling_rate: 1.0  # è®¾ç½®ä¸º100%é‡‡æ ·
```

**2. ä¸Šä¸‹æ–‡ä¼ é€’å¤±è´¥**
```java
// é”™è¯¯ç¤ºä¾‹ï¼šæœªä½¿ç”¨åˆ†å¸ƒå¼è¿½è¸ªä¸Šä¸‹æ–‡
HttpClient client = HttpClient.newHttpClient();
HttpRequest request = HttpRequest.newBuilder()
    .uri(URI.create("http://service-b/api"))
    .build();
client.send(request, HttpResponse.BodyHandlers.ofString());

// æ­£ç¡®ç¤ºä¾‹ï¼šä¼ é€’è¿½è¸ªä¸Šä¸‹æ–‡
HttpRequest request = HttpRequest.newBuilder()
    .uri(URI.create("http://service-b/api"))
    .header("SW8", "1-xxx-xxx-xxx")  // æ·»åŠ SkyWalkingè¿½è¸ªå¤´
    .build();
```

### è§£å†³æ–¹æ¡ˆ

**1. å®Œå–„åˆ†å¸ƒå¼è¿½è¸ªé…ç½®**
```yaml
# å¾®æœåŠ¡è¿½è¸ªé…ç½®
spring:
  sleuth:
    sampler:
      probability: 1.0  # å¼€å‘ç¯å¢ƒå…¨é‡é‡‡æ ·
  zipkin:
    base-url: http://zipkin:9411  # ZipkinæœåŠ¡å™¨åœ°å€
```

**2. ä½¿ç”¨é“¾è·¯è¿½è¸ªåˆ†æå·¥å…·**
```bash
# SkyWalkingæŸ¥è¯¢æ…¢é“¾è·¯
curl http://<skywalking_host>:12800/graphql -X POST -H "Content-Type: application/json" -d '{"query":"query {topNSlowTraces(duration: 3600, topN: 10) {traceId duration endpointName}}"}'
```

---

## ä¸€è‡´æ€§ç®—æ³•é—®é¢˜

### æ’æŸ¥æ–¹æ³•

**1. æŸ¥çœ‹Rafté›†ç¾¤çŠ¶æ€**
```bash
# Etcdé›†ç¾¤çŠ¶æ€
etcdctl endpoint status --write-out=table

# Consulé›†ç¾¤çŠ¶æ€
consul operator raft list-peers
```

**2. æŸ¥çœ‹æ—¥å¿—å¤åˆ¶æƒ…å†µ**
```bash
# Etcdæ—¥å¿—å¤åˆ¶çŠ¶æ€
etcdctl -w table endpoint status
```

### å¸¸è§åŸå› 

**1. é›†ç¾¤è„‘è£‚**
```bash
# æ£€æŸ¥é›†ç¾¤æˆå‘˜
etcdctl member list

# æ£€æŸ¥leaderçŠ¶æ€
etcdctl endpoint status --write-out=json | jq '.leaderInfo'
```

**2. æ—¥å¿—å¤åˆ¶å»¶è¿Ÿ**
```bash
# æŸ¥çœ‹ follower ä¸ leader çš„å·®è·
etcdctl -w json endpoint status | jq '.raftAppliedIndex - .raftIndex'
```

### è§£å†³æ–¹æ¡ˆ

**1. è°ƒæ•´Raftå‚æ•°**
```yaml
# Etcdé…ç½®è°ƒæ•´
etcd:
  raft:
    election-timeout: 5000ms
    heartbeat-interval: 500ms
```

**2. ä¿®å¤é›†ç¾¤è„‘è£‚**
```bash
# å¼ºåˆ¶é‡æ–°é€‰ä¸¾leader
etcdctl elect -w table /leader/lock my-node
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æ€§èƒ½é—®é¢˜æ’æŸ¥](./01_æ€§èƒ½é—®é¢˜æ’æŸ¥.md)
- [ç³»ç»Ÿæ•…éšœæ’æŸ¥](./03_ç³»ç»Ÿæ•…éšœæ’æŸ¥.md)
- [Spring Cloud Alibabaå…¨å®¶æ¡¶](../../06_å¾®æœåŠ¡/Spring Cloud Alibabaå…¨å®¶æ¡¶.md)

---

**æœ€åæ›´æ–°**: 2025-10-29  
**æ–‡æ¡£çŠ¶æ€**: âœ… æ¡†æ¶å·²æ­å»ºï¼Œå†…å®¹æŒç»­å®Œå–„ä¸­