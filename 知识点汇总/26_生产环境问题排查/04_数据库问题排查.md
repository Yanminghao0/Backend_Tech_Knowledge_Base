# æ•°æ®åº“é—®é¢˜æ’æŸ¥

> å®æˆ˜æŒ‡å—ï¼šå¦‚ä½•æ’æŸ¥æ…¢SQLã€è¿æ¥æ± ã€æ­»é”ã€ä¸»ä»å»¶è¿Ÿç­‰æ•°æ®åº“é—®é¢˜

## ğŸ“‹ ç›®å½•
- [å¸¸è§é—®é¢˜ç±»å‹](#å¸¸è§é—®é¢˜ç±»å‹)
- [æ…¢SQLæ’æŸ¥](#æ…¢sqlæ’æŸ¥)
- [è¿æ¥æ± é—®é¢˜](#è¿æ¥æ± é—®é¢˜)
- [æ­»é”é—®é¢˜](#æ­»é”é—®é¢˜)
- [ä¸»ä»å»¶è¿Ÿ](#ä¸»ä»å»¶è¿Ÿ)

---

## å¸¸è§é—®é¢˜ç±»å‹

### 1. æ…¢SQL

**ç—‡çŠ¶**ï¼š
```
âœ… æ¥å£å“åº”å˜æ…¢
âœ… æ•°æ®åº“CPUä½¿ç”¨ç‡ä¸Šå‡
âœ… æ…¢æŸ¥è¯¢æ—¥å¿—å¢åŠ 
âœ… è¿æ¥æ•°å¢åŠ 
```

### 2. è¿æ¥æ± æ»¡

**ç—‡çŠ¶**ï¼š
```
âœ… è¿æ¥è·å–è¶…æ—¶
âœ… è¿æ¥æ± ä½¿ç”¨ç‡100%
âœ… å‡ºç°è¿æ¥å¼‚å¸¸
```

### 3. æ­»é”

**ç—‡çŠ¶**ï¼š
```
âœ… äº‹åŠ¡ç­‰å¾…è¶…æ—¶
âœ… å‡ºç°æ­»é”é”™è¯¯
âœ… æ•°æ®åº“æ€§èƒ½ä¸‹é™
```

### 4. ä¸»ä»å»¶è¿Ÿ

**ç—‡çŠ¶**ï¼š
```
âœ… ä»åº“æ•°æ®ä¸ä¸€è‡´
âœ… è¯»æ“ä½œè¿”å›æ—§æ•°æ®
âœ… ä¸»ä»å»¶è¿Ÿå¢åŠ 
```

---

## æ…¢SQLæ’æŸ¥

### æ’æŸ¥æ–¹æ³•

**1. æŸ¥çœ‹æ…¢æŸ¥è¯¢æ—¥å¿—**

```sql
-- æŸ¥çœ‹æ…¢æŸ¥è¯¢é…ç½®
SHOW VARIABLES LIKE 'slow_query%';
SHOW VARIABLES LIKE 'long_query_time';

-- å¼€å¯æ…¢æŸ¥è¯¢
SET GLOBAL slow_query_log = 'ON';
SET GLOBAL long_query_time = 1;  -- 1ç§’

-- æŸ¥çœ‹æ…¢æŸ¥è¯¢
SELECT * FROM mysql.slow_log 
ORDER BY start_time DESC 
LIMIT 10;
```

**2. ä½¿ç”¨EXPLAINåˆ†æ**

```sql
-- åˆ†æSQLæ‰§è¡Œè®¡åˆ’
EXPLAIN SELECT * FROM orders 
WHERE user_id = 123 AND status = 1;

-- é‡ç‚¹å…³æ³¨ï¼š
-- type: è®¿é—®ç±»å‹ï¼ˆALLæœ€å·®ï¼Œconstæœ€å¥½ï¼‰
-- key: ä½¿ç”¨çš„ç´¢å¼•
-- rows: æ‰«æè¡Œæ•°
-- Extra: é¢å¤–ä¿¡æ¯
```

**3. æŸ¥çœ‹å½“å‰æ‰§è¡ŒSQL**

```sql
-- æŸ¥çœ‹å½“å‰è¿æ¥å’ŒSQL
SHOW PROCESSLIST;

-- æŸ¥çœ‹è¯¦ç»†æ‰§è¡Œä¿¡æ¯
SELECT * FROM information_schema.processlist 
WHERE command != 'Sleep' 
ORDER BY time DESC;
```

### å¸¸è§åŸå› 

**1. ç¼ºå°‘ç´¢å¼•**

```sql
-- âŒ å…¨è¡¨æ‰«æ
SELECT * FROM orders WHERE user_id = 123;

-- âœ… æ·»åŠ ç´¢å¼•
CREATE INDEX idx_user_id ON orders(user_id);
```

**2. SQLè¯­å¥é—®é¢˜**

```sql
-- âŒ ä½¿ç”¨å‡½æ•°ç ´åç´¢å¼•
SELECT * FROM orders WHERE DATE(create_time) = '2025-10-29';

-- âœ… æ”¹å†™SQL
SELECT * FROM orders 
WHERE create_time >= '2025-10-29 00:00:00' 
AND create_time < '2025-10-30 00:00:00';
```

**3. ç´¢å¼•é€‰æ‹©ä¸å½“**

```sql
-- åˆ†æç´¢å¼•ä½¿ç”¨æƒ…å†µ
EXPLAIN SELECT * FROM orders 
WHERE user_id = 123 AND status = 1;

-- å¦‚æœæœªä½¿ç”¨ç´¢å¼•ï¼Œæ£€æŸ¥ï¼š
-- 1. ç´¢å¼•æ˜¯å¦å­˜åœ¨
-- 2. ç´¢å¼•æ˜¯å¦æœ‰æ•ˆ
-- 3. æ˜¯å¦éœ€è¦è”åˆç´¢å¼•
```

### ä¼˜åŒ–æ–¹æ¡ˆ

**1. æ·»åŠ ç´¢å¼•**

```sql
-- å•åˆ—ç´¢å¼•
CREATE INDEX idx_user_id ON orders(user_id);

-- è”åˆç´¢å¼•ï¼ˆæ³¨æ„é¡ºåºï¼‰
CREATE INDEX idx_user_status ON orders(user_id, status);

-- è¦†ç›–ç´¢å¼•
CREATE INDEX idx_user_status_time ON orders(user_id, status, create_time);
```

**2. ä¼˜åŒ–SQL**

```sql
-- é¿å…SELECT *
SELECT user_id, order_id, status FROM orders WHERE user_id = 123;

-- é¿å…å‡½æ•°è®¡ç®—
-- âŒ WHERE DATE(create_time) = '2025-10-29'
-- âœ… WHERE create_time >= '2025-10-29 00:00:00' AND create_time < '2025-10-30 00:00:00'

-- ä½¿ç”¨LIMIT
SELECT * FROM orders WHERE user_id = 123 LIMIT 10;
```

**3. åˆ†é¡µä¼˜åŒ–**

```sql
-- âŒ æ·±åˆ†é¡µï¼ˆæ…¢ï¼‰
SELECT * FROM orders LIMIT 100000, 10;

-- âœ… ä½¿ç”¨ç´¢å¼•ä¼˜åŒ–
SELECT * FROM orders 
WHERE id > 100000 
ORDER BY id 
LIMIT 10;
```

---

## è¿æ¥æ± é—®é¢˜

### æ’æŸ¥æ–¹æ³•

**1. æŸ¥çœ‹è¿æ¥æ± çŠ¶æ€**

```java
// HikariCPè¿æ¥æ± ç›‘æ§
HikariPool pool = (HikariPool) dataSource.getHikariPoolMXBean();
System.out.println("Active: " + pool.getActiveConnections());
System.out.println("Idle: " + pool.getIdleConnections());
System.out.println("Total: " + pool.getTotalConnections());
```

**2. æŸ¥çœ‹æ•°æ®åº“è¿æ¥æ•°**

```sql
-- æŸ¥çœ‹å½“å‰è¿æ¥æ•°
SHOW PROCESSLIST;
SHOW STATUS LIKE 'Threads_connected';

-- æŸ¥çœ‹æœ€å¤§è¿æ¥æ•°
SHOW VARIABLES LIKE 'max_connections';

-- æŸ¥çœ‹è¿æ¥æ•°ä½¿ç”¨ç‡
SELECT 
    VARIABLE_VALUE AS max_connections,
    (SELECT VARIABLE_VALUE 
     FROM information_schema.GLOBAL_STATUS 
     WHERE VARIABLE_NAME = 'Threads_connected') AS current_connections,
    ROUND((SELECT VARIABLE_VALUE 
           FROM information_schema.GLOBAL_STATUS 
           WHERE VARIABLE_NAME = 'Threads_connected') / 
          VARIABLE_VALUE * 100, 2) AS usage_percent
FROM information_schema.GLOBAL_VARIABLES
WHERE VARIABLE_NAME = 'max_connections';
```

### å¸¸è§åŸå› 

**1. è¿æ¥æ± é…ç½®è¿‡å°**

```yaml
# application.yml
spring:
  datasource:
    hikari:
      maximum-pool-size: 10  # å¤ªå°
      minimum-idle: 5
```

**2. è¿æ¥æ³„æ¼**

```java
// âŒ è¿æ¥æœªå…³é—­
Connection conn = dataSource.getConnection();
PreparedStatement ps = conn.prepareStatement(sql);
// å¿˜è®°å…³é—­è¿æ¥

// âœ… ä½¿ç”¨try-with-resources
try (Connection conn = dataSource.getConnection();
     PreparedStatement ps = conn.prepareStatement(sql)) {
    // æ‰§è¡ŒæŸ¥è¯¢
}
```

**3. è¿æ¥æŒæœ‰æ—¶é—´è¿‡é•¿**

```java
// âŒ é•¿æ—¶é—´æŒæœ‰è¿æ¥
Connection conn = dataSource.getConnection();
// ... å¤§é‡ä¸šåŠ¡é€»è¾‘ ...
conn.close();

// âœ… åŠæ—¶é‡Šæ”¾è¿æ¥
try (Connection conn = dataSource.getConnection()) {
    // å¿«é€Ÿæ‰§è¡ŒSQL
}
```

### è§£å†³æ–¹æ¡ˆ

**1. è°ƒæ•´è¿æ¥æ± é…ç½®**

```yaml
spring:
  datasource:
    hikari:
      maximum-pool-size: 20
      minimum-idle: 10
      connection-timeout: 30000
      max-lifetime: 1800000
      idle-timeout: 600000
```

**2. æ£€æŸ¥è¿æ¥æ³„æ¼**

```java
// å¯ç”¨è¿æ¥æ³„æ¼æ£€æµ‹
spring:
  datasource:
    hikari:
      leak-detection-threshold: 60000  # 60ç§’
```

**3. å¢åŠ æ•°æ®åº“è¿æ¥æ•°**

```sql
-- å¢åŠ æœ€å¤§è¿æ¥æ•°
SET GLOBAL max_connections = 200;

-- æ°¸ä¹…ç”Ÿæ•ˆï¼ˆä¿®æ”¹é…ç½®æ–‡ä»¶ï¼‰
[mysqld]
max_connections = 200
```

---

## æ­»é”é—®é¢˜

### æ’æŸ¥æ–¹æ³•

**1. æŸ¥çœ‹æ­»é”æ—¥å¿—**

```sql
-- æŸ¥çœ‹æœ€è¿‘æ­»é”
SHOW ENGINE INNODB STATUS;

-- æŸ¥çœ‹æ­»é”ä¿¡æ¯
SELECT * FROM information_schema.innodb_locks;
SELECT * FROM information_schema.innodb_lock_waits;
```

**2. æŸ¥çœ‹é”ç­‰å¾…**

```sql
-- æŸ¥çœ‹é”ç­‰å¾…æƒ…å†µ
SELECT 
    r.trx_id waiting_trx_id,
    r.trx_mysql_thread_id waiting_thread,
    r.trx_query waiting_query,
    b.trx_id blocking_trx_id,
    b.trx_mysql_thread_id blocking_thread,
    b.trx_query blocking_query
FROM information_schema.innodb_lock_waits w
INNER JOIN information_schema.innodb_trx b ON b.trx_id = w.blocking_trx_id
INNER JOIN information_schema.innodb_trx r ON r.trx_id = w.requesting_trx_id;
```

### å¸¸è§åŸå› 

**1. äº‹åŠ¡é¡ºåºä¸ä¸€è‡´**

```java
// âŒ äº‹åŠ¡é¡ºåºä¸ä¸€è‡´ï¼Œå®¹æ˜“æ­»é”
// äº‹åŠ¡1ï¼šå…ˆé”Aï¼Œå†é”B
// äº‹åŠ¡2ï¼šå…ˆé”Bï¼Œå†é”A

// âœ… ç»Ÿä¸€äº‹åŠ¡é¡ºåº
// æ‰€æœ‰äº‹åŠ¡ï¼šå…ˆé”Aï¼Œå†é”B
```

**2. é•¿äº‹åŠ¡**

```java
// âŒ é•¿äº‹åŠ¡æŒæœ‰é”æ—¶é—´è¿‡é•¿
@Transactional
public void longTransaction() {
    // å¤§é‡ä¸šåŠ¡é€»è¾‘
    // æŒæœ‰é”æ—¶é—´è¿‡é•¿
}

// âœ… å‡å°‘äº‹åŠ¡èŒƒå›´
public void shortTransaction() {
    // åªåŒ…å«å¿…è¦çš„æ•°æ®åº“æ“ä½œ
}
```

**3. ç´¢å¼•ç¼ºå¤±**

```sql
-- ç¼ºå°‘ç´¢å¼•å¯¼è‡´é”èŒƒå›´æ‰©å¤§
-- å…¨è¡¨æ‰«æä¼šé”æ›´å¤šè¡Œ
CREATE INDEX idx_user_id ON orders(user_id);
```

### è§£å†³æ–¹æ¡ˆ

**1. ç»Ÿä¸€äº‹åŠ¡é¡ºåº**

```java
// æ‰€æœ‰äº‹åŠ¡æŒ‰ç›¸åŒé¡ºåºåŠ é”
// ä¾‹å¦‚ï¼šå…ˆé”ç”¨æˆ·è¡¨ï¼Œå†é”è®¢å•è¡¨
```

**2. å‡å°‘äº‹åŠ¡èŒƒå›´**

```java
// åªåŒ…å«å¿…è¦çš„æ•°æ®åº“æ“ä½œ
@Transactional
public void quickTransaction() {
    // å¿«é€Ÿæ‰§è¡ŒSQL
}
```

**3. ä½¿ç”¨ä¹è§‚é”**

```java
// ä½¿ç”¨ç‰ˆæœ¬å·é¿å…é”ç­‰å¾…
UPDATE orders 
SET status = 1, version = version + 1 
WHERE id = 123 AND version = 1;
```

**4. è®¾ç½®é”è¶…æ—¶**

```sql
-- è®¾ç½®é”ç­‰å¾…è¶…æ—¶
SET innodb_lock_wait_timeout = 10;  -- 10ç§’
```

---

## ä¸»ä»å»¶è¿Ÿ

### æ’æŸ¥æ–¹æ³•

**1. æŸ¥çœ‹ä¸»ä»å»¶è¿Ÿ**

```sql
-- ä»åº“æ‰§è¡Œ
SHOW SLAVE STATUS\G

-- æŸ¥çœ‹å»¶è¿Ÿæ—¶é—´
-- Seconds_Behind_Master: å»¶è¿Ÿç§’æ•°
```

**2. æŸ¥çœ‹binlogä½ç½®**

```sql
-- ä¸»åº“æ‰§è¡Œ
SHOW MASTER STATUS;

-- ä»åº“æ‰§è¡Œ
SHOW SLAVE STATUS;
-- Master_Log_File: ä¸»åº“binlogæ–‡ä»¶
-- Read_Master_Log_Pos: å·²è¯»å–ä½ç½®
```

### å¸¸è§åŸå› 

**1. ä»åº“æ€§èƒ½ä¸è¶³**

```bash
# æ£€æŸ¥ä»åº“èµ„æº
top
iostat -x 1
```

**2. ç½‘ç»œå»¶è¿Ÿ**

```bash
# æµ‹è¯•ç½‘ç»œå»¶è¿Ÿ
ping master_host
traceroute master_host
```

**3. ä¸»åº“å†™å…¥é‡å¤§**

```sql
-- æŸ¥çœ‹ä¸»åº“å†™å…¥é‡
SHOW STATUS LIKE 'Com_insert';
SHOW STATUS LIKE 'Com_update';
SHOW STATUS LIKE 'Com_delete';
```

**4. å¤§äº‹åŠ¡**

```sql
-- å¤§äº‹åŠ¡å¯¼è‡´å»¶è¿Ÿ
-- è§£å†³æ–¹æ¡ˆï¼šæ‹†åˆ†å¤§äº‹åŠ¡
```

### è§£å†³æ–¹æ¡ˆ

**1. æé«˜ä»åº“æ€§èƒ½**

```
- å¢åŠ ä»åº“èµ„æºï¼ˆCPUã€å†…å­˜ï¼‰
- ä¼˜åŒ–ä»åº“é…ç½®
- ä½¿ç”¨SSDç£ç›˜
```

**2. ä¼˜åŒ–ç½‘ç»œ**

```
- ä¼˜åŒ–ç½‘ç»œé…ç½®
- ä½¿ç”¨å†…ç½‘é€šä¿¡
- å‡å°‘ç½‘ç»œå»¶è¿Ÿ
```

**3. è¯»å†™åˆ†ç¦»ç­–ç•¥**

```java
// å¼ºä¸€è‡´æ€§è¦æ±‚ â†’ ä¸»åº“è¯»
// æœ€ç»ˆä¸€è‡´æ€§ â†’ ä»åº“è¯»
// å»¶è¿Ÿè¡¥å¿ â†’ å…ˆæŸ¥ç¼“å­˜
```

**4. ç›‘æ§å‘Šè­¦**

```
âœ… ä¸»ä»å»¶è¿Ÿç›‘æ§
âœ… å»¶è¿Ÿå‘Šè­¦
âœ… è‡ªåŠ¨åˆ‡æ¢ä»åº“
```

---

## æ•°æ®åº“ä¼˜åŒ–å»ºè®®

### 1. ç´¢å¼•ä¼˜åŒ–

```
âœ… ä¸ºé«˜é¢‘æŸ¥è¯¢å­—æ®µæ·»åŠ ç´¢å¼•
âœ… ä½¿ç”¨è”åˆç´¢å¼•ï¼ˆæ³¨æ„é¡ºåºï¼‰
âœ… é¿å…è¿‡å¤šç´¢å¼•ï¼ˆå½±å“å†™å…¥æ€§èƒ½ï¼‰
âœ… å®šæœŸåˆ†ææ…¢æŸ¥è¯¢
```

### 2. SQLä¼˜åŒ–

```
âœ… é¿å…SELECT *
âœ… é¿å…å‡½æ•°è®¡ç®—
âœ… ä½¿ç”¨LIMITåˆ†é¡µ
âœ… ä¼˜åŒ–JOINæŸ¥è¯¢
```

### 3. è¿æ¥æ± ä¼˜åŒ–

```
âœ… åˆç†è®¾ç½®è¿æ¥æ± å¤§å°
âœ… ç›‘æ§è¿æ¥æ± çŠ¶æ€
âœ… é¿å…è¿æ¥æ³„æ¼
âœ… åŠæ—¶é‡Šæ”¾è¿æ¥
```

### 4. äº‹åŠ¡ä¼˜åŒ–

```
âœ… å‡å°‘äº‹åŠ¡èŒƒå›´
âœ… ç»Ÿä¸€äº‹åŠ¡é¡ºåº
âœ… ä½¿ç”¨ä¹è§‚é”
âœ… é¿å…é•¿äº‹åŠ¡
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æ€§èƒ½é—®é¢˜æ’æŸ¥](./01_æ€§èƒ½é—®é¢˜æ’æŸ¥.md)
- [ç³»ç»Ÿæ•…éšœæ’æŸ¥](./03_ç³»ç»Ÿæ•…éšœæ’æŸ¥.md)
- [MySQLæŸ¥è¯¢æ ¸å¿ƒæœºåˆ¶è¯¦è§£](../../03_æ•°æ®åº“/MySQLæŸ¥è¯¢æ ¸å¿ƒæœºåˆ¶è¯¦è§£.md)

---

**æœ€åæ›´æ–°**: 2025-10-29  
**æ–‡æ¡£çŠ¶æ€**: âœ… æ¡†æ¶å·²æ­å»ºï¼Œå†…å®¹æŒç»­å®Œå–„ä¸­


### åˆ†åº“åˆ†è¡¨é—®é¢˜æ’æŸ¥

### å¸¸è§é—®é¢˜ç±»å‹

**1. æ•°æ®åˆ†å¸ƒä¸å‡**

**ç—‡çŠ¶**ï¼š
```
âœ… éƒ¨åˆ†åˆ†è¡¨æ•°æ®é‡è¿‡å¤§
âœ… éƒ¨åˆ†åˆ†è¡¨æŸ¥è¯¢ç¼“æ…¢
âœ… åˆ†è¡¨è´Ÿè½½ä¸å‡è¡¡
```

**æ’æŸ¥æ–¹æ³•**ï¼š
```sql
-- æŸ¥çœ‹å„åˆ†è¡¨æ•°æ®é‡åˆ†å¸ƒ
SELECT table_name, table_rows FROM information_schema.tables WHERE table_schema = 'db_name' AND table_name LIKE 'order_%';
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```java
// Sharding-JDBC è‡ªåŠ¨åˆ†ç‰‡ç­–ç•¥é…ç½®
@Configuration
public class ShardingConfig {
    @Bean
    public ShardingRuleConfiguration shardingRuleConfig() {
        // ä½¿ç”¨ä¸€è‡´æ€§å“ˆå¸Œåˆ†ç‰‡ç®—æ³•
        TableRuleConfiguration orderTableRule = new TableRuleConfiguration("t_order", "ds_${0..1}.t_order_${0..31}");
        orderTableRule.setDatabaseShardingStrategyConfig(
            new StandardShardingStrategyConfiguration("user_id", new ModuloDatabaseShardingAlgorithm()));
        orderTableRule.setTableShardingStrategyConfig(
            new StandardShardingStrategyConfiguration("order_id", new ConsistentHashTableShardingAlgorithm()));
        
        ShardingRuleConfiguration shardingRuleConfig = new ShardingRuleConfiguration();
        shardingRuleConfig.getTableRuleConfigs().add(orderTableRule);
        return shardingRuleConfig;
    }
}
```

**2. åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜**

**ç—‡çŠ¶**ï¼š
```
âœ… è·¨åº“äº‹åŠ¡ä¸ä¸€è‡´
âœ… æ•°æ®æäº¤å¤±è´¥
âœ… åˆ†å¸ƒå¼é”å†²çª
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

**Seata ATæ¨¡å¼é…ç½®**ï¼š
```yaml
# application.yml
seata:
  enabled: true
  application-id: order-service
  tx-service-group: my_test_tx_group
  service:
    vgroup-mapping:
      my_test_tx_group: default
    grouplist:
      default: 127.0.0.1:8091
  registry:
    type: nacos
    nacos:
      server-addr: 127.0.0.1:8848
```

**åˆ†å¸ƒå¼äº‹åŠ¡ä»£ç ç¤ºä¾‹**ï¼š
```java
@GlobalTransactional
public void createOrder(OrderDTO orderDTO) {
    // è®¢å•æœåŠ¡æœ¬åœ°äº‹åŠ¡
    orderMapper.insert(orderDTO);
    
    // åº“å­˜æœåŠ¡è¿œç¨‹è°ƒç”¨
    inventoryFeignClient.deduct(orderDTO.getProductId(), orderDTO.getQuantity());
    
    // æ”¯ä»˜æœåŠ¡è¿œç¨‹è°ƒç”¨
    paymentFeignClient.createPayment(orderDTO);
}
```

**3. è·¨åº“è”åˆæŸ¥è¯¢é—®é¢˜**

**ç—‡çŠ¶**ï¼š
```
âœ… è·¨åº“JOINæŸ¥è¯¢å¤±è´¥
âœ… åˆ†é¡µæŸ¥è¯¢å¼‚å¸¸
âœ… å…¨å±€è¡¨æ•°æ®ä¸ä¸€è‡´
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```java
// ä½¿ç”¨Sharding-JDBCçš„ç»‘å®šè¡¨å’Œå¹¿æ’­è¡¨
@Bean
public ShardingRuleConfiguration shardingRuleConfig() {
    // ç»‘å®šè¡¨é…ç½®
    TableRuleConfiguration orderTableRule = new TableRuleConfiguration("t_order", "ds_${0..1}.t_order_${0..31}");
    TableRuleConfiguration orderItemTableRule = new TableRuleConfiguration("t_order_item", "ds_${0..1}.t_order_item_${0..31}");
    
    ShardingRuleConfiguration shardingRuleConfig = new ShardingRuleConfiguration();
    shardingRuleConfig.getTableRuleConfigs().add(orderTableRule);
    shardingRuleConfig.getTableRuleConfigs().add(orderItemTableRule);
    shardingRuleConfig.getBindingTableGroups().add("t_order,t_order_item");
    
    // å¹¿æ’­è¡¨é…ç½®
    TableRuleConfiguration dictTableRule = new TableRuleConfiguration("t_dict", "ds_${0..1}.t_dict");
    dictTableRule.setDatabaseShardingStrategyConfig(new NoneShardingStrategyConfiguration());
    dictTableRule.setTableShardingStrategyConfig(new NoneShardingStrategyConfiguration());
    shardingRuleConfig.getTableRuleConfigs().add(dictTableRule);
    
    return shardingRuleConfig;
}
```

## æ•°æ®åº“ç›‘æ§ä¸æ€§èƒ½æµ‹è¯•

### 1. é«˜çº§ç›‘æ§é…ç½®

**Prometheus + Grafanaç›‘æ§**ï¼š

**MySQL Exporteré…ç½®**ï¼š
```yaml
# mysql_exporteré…ç½®
mysql_global_configs:
  - from: global
    to: global

mysql_databases:
  - alias: primary
    data_source_name: "exporter:password@(mysql-primary:3306)/"
  - alias: replica
    data_source_name: "exporter:password@(mysql-replica:3306)/"
```

**Prometheusç›‘æ§è§„åˆ™**ï¼š
```yaml
# prometheus.yml
scrape_configs:
  - job_name: 'mysql'
    static_configs:
      - targets: ['mysql-exporter:9104']

rule_files:
  - 'mysql-alert.rules.yml'
```

**MySQLå‘Šè­¦è§„åˆ™**ï¼š
```yaml
# mysql-alert.rules.yml
groups:
- name: mysql_alerts
  rules:
  - alert: MySQLDown
    expr: mysql_up == 0
    for: 30s
    labels:
      severity: critical
    annotations:
      summary: "MySQL instance down"
      description: "MySQL instance {{ $labels.instance }} has been down for 30 seconds"

  - alert: MySQLHighConnections
    expr: mysql_global_status_threads_connected / mysql_global_variables_max_connections > 0.8
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High MySQL connections on {{ $labels.instance }}"
      description: "Connections are {{ $value | humanizePercentage }} of max connections"

  - alert: MySQLSlowQueries
    expr: increase(mysql_global_status_slow_queries[5m]) > 5
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High number of slow queries on {{ $labels.instance }}"
      description: "{{ $value }} slow queries detected in the last 5 minutes"

  - alert: MySQLReplicationLag
    expr: mysql_slave_status_seconds_behind_master > 30
    for: 2m
    labels:
      severity: warning
    annotations:
      summary: "MySQL replication lag on {{ $labels.instance }}"
      description: "Replication is lagging by {{ $value }} seconds"
```

**Grafanaæ¨èé¢æ¿**ï¼š
1. MySQL Overview (ID: 7362)
2. Percona Monitoring (ID: 11323)
3. MySQL Performance (ID: 249)

### 2. æ…¢æŸ¥è¯¢åˆ†æå·¥å…·

**pt-query-digestä½¿ç”¨**ï¼š
```bash
# åˆ†ææ…¢æŸ¥è¯¢æ—¥å¿—
pt-query-digest /var/log/mysql/slow.log > slow_query_report.txt

# åˆ†æå®æ—¶æ…¢æŸ¥è¯¢
pt-query-digest --processlist h=localhost,u=root,p=password --interval=5

# åˆ†æç‰¹å®šæ—¶é—´æ®µçš„æ…¢æŸ¥è¯¢
pt-query-digest --since '2025-10-29 00:00:00' --until '2025-10-29 12:00:00' /var/log/mysql/slow.log
```

**æ…¢æŸ¥è¯¢æŠ¥å‘Šè§£è¯»**ï¼š
```
# æŠ¥å‘Šä¸»è¦éƒ¨åˆ†
1. æ€»ä½“ç»Ÿè®¡ä¿¡æ¯
2. æ…¢æŸ¥è¯¢æ—¶é—´åˆ†å¸ƒ
3. æœ€å¤šçš„æŸ¥è¯¢ç±»å‹
4. æœ€æ¶ˆè€—èµ„æºçš„SQL
5. SQLè¯¦ç»†ä¿¡æ¯ï¼ˆæ‰§è¡Œæ¬¡æ•°ã€é”ç­‰å¾…æ—¶é—´ã€è¡Œæ‰«æ/å‘é€æ•°ï¼‰
```

### 3. æ€§èƒ½åŸºå‡†æµ‹è¯•

**sysbenchæµ‹è¯•**ï¼š
```bash
# å®‰è£…sysbench
yum install sysbench -y

# å‡†å¤‡æµ‹è¯•æ•°æ®
sysbench --db-driver=mysql --mysql-host=localhost --mysql-user=root --mysql-password=password --mysql-db=test --table_size=100000 --tables=10 oltp_read_write prepare

# è¿è¡Œæµ‹è¯•
sysbench --db-driver=mysql --mysql-host=localhost --mysql-user=root --mysql-password=password --mysql-db=test --table_size=100000 --tables=10 --threads=8 --time=60 oltp_read_write run

# æ¸…ç†æµ‹è¯•æ•°æ®
sysbench --db-driver=mysql --mysql-host=localhost --mysql-user=root --mysql-password=password --mysql-db=test --table_size=100000 --tables=10 oltp_read_write cleanup
```

**æµ‹è¯•æŒ‡æ ‡å…³æ³¨**ï¼š
```
- æ¯ç§’äº‹åŠ¡æ•° (transactions per second, TPS)
- æ¯ç§’æŸ¥è¯¢æ•° (queries per second, QPS)
- å¹³å‡å“åº”æ—¶é—´ (avg latency)
- 95%å“åº”æ—¶é—´ (95th percentile latency)
- CPUä½¿ç”¨ç‡
- IOPS
```