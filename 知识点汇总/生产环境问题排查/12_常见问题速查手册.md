# å¸¸è§é—®é¢˜é€ŸæŸ¥æ‰‹å†Œ

> å¿«é€Ÿå®šä½é—®é¢˜çš„å‘½ä»¤å’Œè„šæœ¬é›†åˆ

## ğŸ“‹ ç›®å½•
- [å¿«é€Ÿå‘½ä»¤é€ŸæŸ¥](#å¿«é€Ÿå‘½ä»¤é€ŸæŸ¥)
- [é—®é¢˜å®šä½è„šæœ¬](#é—®é¢˜å®šä½è„šæœ¬)
- [ç›‘æ§å‘½ä»¤](#ç›‘æ§å‘½ä»¤)
- [æ—¥å¿—åˆ†æè„šæœ¬](#æ—¥å¿—åˆ†æè„šæœ¬)

---

## å¿«é€Ÿå‘½ä»¤é€ŸæŸ¥

### æŸ¥çœ‹è¿›ç¨‹å’Œç«¯å£

```bash
# æ ¹æ®ç«¯å£æŸ¥è¿›ç¨‹
lsof -i :8080
netstat -tlnp | grep 8080
ss -tlnp | grep 8080

# æ ¹æ®è¿›ç¨‹åæŸ¥ç«¯å£
ps aux | grep java
jps -lvm
pgrep -f "java.*application"

# æŸ¥çœ‹è¿›ç¨‹è¯¦æƒ…
ps aux | grep <pid>
ps -ef | grep <pid>
```

### æŸ¥çœ‹ç³»ç»Ÿèµ„æº

```bash
# CPUä½¿ç”¨ç‡
top
htop
vmstat 1
sar -u 1

# å†…å­˜ä½¿ç”¨
free -h
cat /proc/meminfo
sar -r 1

# ç£ç›˜ä½¿ç”¨
df -h
du -sh *
du -h --max-depth=1 /
iostat -x 1

# ç½‘ç»œè¿æ¥
netstat -antp | grep <port>
ss -antp | grep <port>
netstat -i
iftop
```

### æŸ¥çœ‹Javaåº”ç”¨

```bash
# æŸ¥çœ‹Javaè¿›ç¨‹
jps -lvm

# æŸ¥çœ‹çº¿ç¨‹å †æ ˆ
jstack <pid>
jstack <pid> | grep -A 20 "çº¿ç¨‹å"

# æŸ¥çœ‹å †å†…å­˜
jmap -heap <pid>
jmap -histo <pid>

# æŸ¥çœ‹GCæƒ…å†µ
jstat -gc <pid> 1000 10
jstat -gccapacity <pid>

# ç”Ÿæˆå †è½¬å‚¨
jmap -dump:format=b,file=heap.hprof <pid>

# æŸ¥çœ‹çº¿ç¨‹æ•°
jstack <pid> | grep "java.lang.Thread.State" | wc -l
```

### æŸ¥çœ‹æ—¥å¿—

```bash
# å®æ—¶æŸ¥çœ‹æ—¥å¿—
tail -f application.log
tail -f -n 1000 application.log | grep ERROR

# æŸ¥çœ‹æœ€è¿‘100è¡Œ
tail -n 100 application.log

# æœç´¢å…³é”®å­—
grep "ERROR" application.log
grep -A 10 -B 10 "Exception" application.log
grep -r "Exception" logs/

# ç»Ÿè®¡é”™è¯¯æ•°é‡
grep "ERROR" application.log | wc -l
grep "ERROR" application.log | grep -o "Exception.*" | sort | uniq -c

# æŒ‰æ—¶é—´ç»Ÿè®¡
awk '/ERROR/ {print $1}' application.log | sort | uniq -c
```

### æ•°æ®åº“æ’æŸ¥

```sql
-- æŸ¥çœ‹å½“å‰è¿æ¥
SHOW PROCESSLIST;
SELECT * FROM information_schema.processlist;

-- æŸ¥çœ‹æ…¢æŸ¥è¯¢
SHOW VARIABLES LIKE 'slow_query%';
SELECT * FROM mysql.slow_log ORDER BY start_time DESC LIMIT 10;

-- æŸ¥çœ‹é”ç­‰å¾…
SELECT * FROM information_schema.innodb_locks;
SELECT * FROM information_schema.innodb_lock_waits;

-- æŸ¥çœ‹è¡¨çŠ¶æ€
SHOW TABLE STATUS LIKE 'table_name';
SHOW INDEX FROM table_name;

-- åˆ†æSQL
EXPLAIN SELECT * FROM orders WHERE user_id = 123;
```

### Redisæ’æŸ¥

```bash
# è¿æ¥Redis
redis-cli -h <host> -p <port>

# æŸ¥çœ‹è¿æ¥æ•°
redis-cli CLIENT LIST | wc -l
redis-cli CLIENT LIST

# æŸ¥çœ‹å†…å­˜ä½¿ç”¨
redis-cli INFO memory

# æŸ¥çœ‹æ…¢æŸ¥è¯¢
redis-cli SLOWLOG GET 10

# æŸ¥çœ‹å¤§key
redis-cli --bigkeys

# æŸ¥çœ‹çƒ­key
redis-cli --hotkeys

# æŸ¥çœ‹å‘½ä¸­ç‡
redis-cli INFO stats | grep keyspace_hits
redis-cli INFO stats | grep keyspace_misses
```

---

## é—®é¢˜å®šä½è„šæœ¬

### 1. æŸ¥æ‰¾Javaè¿›ç¨‹CPUé«˜

```bash
#!/bin/bash
# find_high_cpu_java.sh

echo "æŸ¥æ‰¾CPUä½¿ç”¨ç‡é«˜çš„Javaè¿›ç¨‹..."

# æŸ¥æ‰¾CPUä½¿ç”¨ç‡>80%çš„Javaè¿›ç¨‹
ps aux | grep java | awk '$3 > 80 {print $2, $3, $11}' | while read pid cpu cmd; do
    echo "PID: $pid, CPU: $cpu%, å‘½ä»¤: $cmd"
    
    # æŸ¥çœ‹çº¿ç¨‹å †æ ˆ
    echo "çº¿ç¨‹å †æ ˆ:"
    jstack $pid | head -50
done
```

### 2. æŸ¥æ‰¾å†…å­˜æ³„æ¼

```bash
#!/bin/bash
# find_memory_leak.sh

PID=$1
if [ -z "$PID" ]; then
    echo "ç”¨æ³•: $0 <pid>"
    exit 1
fi

echo "ç›‘æ§å†…å­˜ä½¿ç”¨æƒ…å†µ..."
echo "PID: $PID"

# æ¯5ç§’ç›‘æ§ä¸€æ¬¡å†…å­˜
for i in {1..12}; do
    echo "--- ç¬¬ $i æ¬¡ç›‘æ§ ---"
    jmap -histo $PID | head -20
    sleep 5
done

# ç”Ÿæˆå †è½¬å‚¨
echo "ç”Ÿæˆå †è½¬å‚¨æ–‡ä»¶..."
jmap -dump:format=b,file=heap_${PID}_$(date +%Y%m%d_%H%M%S).hprof $PID
echo "å †è½¬å‚¨æ–‡ä»¶å·²ç”Ÿæˆ: heap_${PID}_*.hprof"
```

### 3. æŸ¥æ‰¾æ…¢SQL

```bash
#!/bin/bash
# find_slow_sql.sh

echo "æŸ¥æ‰¾æ…¢SQL..."

# æŸ¥çœ‹æ…¢æŸ¥è¯¢æ—¥å¿—
if [ -f /var/log/mysql/slow.log ]; then
    echo "æ…¢æŸ¥è¯¢æ—¥å¿—:"
    tail -100 /var/log/mysql/slow.log | grep -A 5 "SELECT\|INSERT\|UPDATE\|DELETE"
fi

# æŸ¥çœ‹å½“å‰æ‰§è¡Œçš„SQL
echo "å½“å‰æ‰§è¡Œçš„SQL:"
mysql -u root -p -e "
SELECT 
    id,
    user,
    host,
    db,
    command,
    time,
    state,
    LEFT(info, 100) AS sql
FROM information_schema.processlist
WHERE command != 'Sleep'
ORDER BY time DESC
LIMIT 10;
"
```

### 4. æŸ¥æ‰¾å¤§æ–‡ä»¶

```bash
#!/bin/bash
# find_large_files.sh

DIR=${1:-/}
SIZE=${2:-100M}

echo "æŸ¥æ‰¾å¤§äº $SIZE çš„æ–‡ä»¶..."
find $DIR -type f -size +$SIZE -exec ls -lh {} \; | awk '{print $5, $9}' | sort -hr | head -20
```

### 5. æŸ¥æ‰¾é”™è¯¯æ—¥å¿—

```bash
#!/bin/bash
# find_errors.sh

LOG_FILE=${1:-application.log}
HOURS=${2:-1}

echo "æŸ¥æ‰¾æœ€è¿‘ $HOURS å°æ—¶çš„é”™è¯¯æ—¥å¿—..."

# è®¡ç®—æ—¶é—´èŒƒå›´
START_TIME=$(date -d "$HOURS hours ago" +"%Y-%m-%d %H:%M:%S")
END_TIME=$(date +"%Y-%m-%d %H:%M:%S")

echo "æ—¶é—´èŒƒå›´: $START_TIME åˆ° $END_TIME"

# æœç´¢ERRORæ—¥å¿—
grep -E "ERROR|Exception|FATAL" $LOG_FILE | \
    awk -v start="$START_TIME" -v end="$END_TIME" \
    '$1" "$2 >= start && $1" "$2 <= end' | \
    head -100

# ç»Ÿè®¡é”™è¯¯ç±»å‹
echo ""
echo "é”™è¯¯ç±»å‹ç»Ÿè®¡:"
grep -E "ERROR|Exception|FATAL" $LOG_FILE | \
    awk -v start="$START_TIME" -v end="$END_TIME" \
    '$1" "$2 >= start && $1" "$2 <= end' | \
    grep -o "Exception.*" | cut -d: -f1 | sort | uniq -c | sort -rn | head -10
```

---

## ç›‘æ§å‘½ä»¤

### 1. ç³»ç»Ÿç›‘æ§è„šæœ¬

```bash
#!/bin/bash
# monitor_system.sh

echo "=== ç³»ç»Ÿç›‘æ§ ==="
echo "æ—¶é—´: $(date)"
echo ""

echo "=== CPUä½¿ç”¨ç‡ ==="
top -bn1 | grep "Cpu(s)" | awk '{print $2}'
echo ""

echo "=== å†…å­˜ä½¿ç”¨ ==="
free -h
echo ""

echo "=== ç£ç›˜ä½¿ç”¨ ==="
df -h
echo ""

echo "=== ç½‘ç»œè¿æ¥æ•° ==="
netstat -ant | wc -l
echo ""

echo "=== è´Ÿè½½å‡è¡¡ ==="
uptime
echo ""

echo "=== Javaè¿›ç¨‹ ==="
jps -lvm
echo ""

echo "=== ç«¯å£ç›‘å¬ ==="
netstat -tlnp | grep LISTEN
```

### 2. åº”ç”¨ç›‘æ§è„šæœ¬

```bash
#!/bin/bash
# monitor_app.sh

PID=$1
if [ -z "$PID" ]; then
    echo "ç”¨æ³•: $0 <pid>"
    exit 1
fi

echo "=== åº”ç”¨ç›‘æ§ ==="
echo "PID: $PID"
echo "æ—¶é—´: $(date)"
echo ""

echo "=== çº¿ç¨‹æ•° ==="
jstack $PID | grep "java.lang.Thread.State" | wc -l
echo ""

echo "=== GCæƒ…å†µ ==="
jstat -gc $PID | tail -1
echo ""

echo "=== å †å†…å­˜ä½¿ç”¨ ==="
jmap -heap $PID | grep -E "Heap|Used|Total" | head -10
echo ""

echo "=== çº¿ç¨‹å †æ ˆï¼ˆå‰10ä¸ªçº¿ç¨‹ï¼‰==="
jstack $PID | head -100
```

### 3. æ•°æ®åº“ç›‘æ§è„šæœ¬

```bash
#!/bin/bash
# monitor_db.sh

echo "=== æ•°æ®åº“ç›‘æ§ ==="
echo "æ—¶é—´: $(date)"
echo ""

echo "=== è¿æ¥æ•° ==="
mysql -u root -p -e "SHOW STATUS LIKE 'Threads_connected';"
echo ""

echo "=== æ…¢æŸ¥è¯¢ ==="
mysql -u root -p -e "SHOW VARIABLES LIKE 'slow_query%';"
echo ""

echo "=== å½“å‰æ‰§è¡Œçš„SQL ==="
mysql -u root -p -e "
SELECT 
    id,
    user,
    host,
    db,
    command,
    time,
    state,
    LEFT(info, 100) AS sql
FROM information_schema.processlist
WHERE command != 'Sleep'
ORDER BY time DESC
LIMIT 10;
"
```

---

## æ—¥å¿—åˆ†æè„šæœ¬

### 1. åˆ†æé”™è¯¯æ—¥å¿—

```bash
#!/bin/bash
# analyze_errors.sh

LOG_FILE=${1:-application.log}

echo "=== é”™è¯¯æ—¥å¿—åˆ†æ ==="
echo "æ—¥å¿—æ–‡ä»¶: $LOG_FILE"
echo ""

echo "=== é”™è¯¯æ€»æ•° ==="
grep -c "ERROR" $LOG_FILE
echo ""

echo "=== é”™è¯¯ç±»å‹ç»Ÿè®¡ ==="
grep "ERROR" $LOG_FILE | grep -o "Exception.*" | cut -d: -f1 | sort | uniq -c | sort -rn | head -10
echo ""

echo "=== æœ€è¿‘10ä¸ªé”™è¯¯ ==="
grep "ERROR" $LOG_FILE | tail -10
echo ""

echo "=== é”™è¯¯è¶‹åŠ¿ï¼ˆæ¯å°æ—¶ï¼‰==="
grep "ERROR" $LOG_FILE | awk '{print $1}' | cut -d: -f1 | sort | uniq -c
```

### 2. åˆ†ææ…¢è¯·æ±‚

```bash
#!/bin/bash
# analyze_slow_requests.sh

LOG_FILE=${1:-application.log}
THRESHOLD=${2:-1000}  # 1000ms

echo "=== æ…¢è¯·æ±‚åˆ†æ ==="
echo "æ—¥å¿—æ–‡ä»¶: $LOG_FILE"
echo "é˜ˆå€¼: ${THRESHOLD}ms"
echo ""

echo "=== æ…¢è¯·æ±‚ç»Ÿè®¡ ==="
grep "duration" $LOG_FILE | awk -v threshold=$THRESHOLD '$NF > threshold' | wc -l
echo ""

echo "=== æœ€æ…¢çš„10ä¸ªè¯·æ±‚ ==="
grep "duration" $LOG_FILE | awk '{print $NF, $0}' | sort -rn | head -10 | awk '{print $2}'
echo ""

echo "=== æ…¢è¯·æ±‚æ¥å£ç»Ÿè®¡ ==="
grep "duration" $LOG_FILE | awk -v threshold=$THRESHOLD '$NF > threshold' | \
    awk '{print $7}' | sort | uniq -c | sort -rn | head -10
```

### 3. åˆ†æè®¿é—®æ—¥å¿—

```bash
#!/bin/bash
# analyze_access_log.sh

LOG_FILE=${1:-access.log}

echo "=== è®¿é—®æ—¥å¿—åˆ†æ ==="
echo "æ—¥å¿—æ–‡ä»¶: $LOG_FILE"
echo ""

echo "=== æ€»è¯·æ±‚æ•° ==="
wc -l $LOG_FILE
echo ""

echo "=== çŠ¶æ€ç ç»Ÿè®¡ ==="
awk '{print $9}' $LOG_FILE | sort | uniq -c | sort -rn
echo ""

echo "=== æœ€é¢‘ç¹çš„IP ==="
awk '{print $1}' $LOG_FILE | sort | uniq -c | sort -rn | head -10
echo ""

echo "=== æœ€é¢‘ç¹çš„URL ==="
awk '{print $7}' $LOG_FILE | sort | uniq -c | sort -rn | head -10
echo ""

echo "=== å¹³å‡å“åº”æ—¶é—´ ==="
awk '{sum+=$10; count++} END {print "å¹³å‡å“åº”æ—¶é—´:", sum/count, "ms"}' $LOG_FILE
```

---

## å¸¸ç”¨è„šæœ¬é›†åˆ

### ä¸€é”®è¯Šæ–­è„šæœ¬

```bash
#!/bin/bash
# diagnose.sh

echo "=== ç³»ç»Ÿè¯Šæ–­ ==="
echo "æ—¶é—´: $(date)"
echo ""

# ç³»ç»Ÿèµ„æº
echo "=== ç³»ç»Ÿèµ„æº ==="
free -h
df -h
uptime
echo ""

# Javaè¿›ç¨‹
echo "=== Javaè¿›ç¨‹ ==="
jps -lvm
echo ""

# ç«¯å£ç›‘å¬
echo "=== ç«¯å£ç›‘å¬ ==="
netstat -tlnp | grep LISTEN | head -10
echo ""

# é”™è¯¯æ—¥å¿—
echo "=== æœ€è¿‘é”™è¯¯æ—¥å¿— ==="
if [ -f application.log ]; then
    grep "ERROR" application.log | tail -5
fi
echo ""

# æ…¢SQL
echo "=== æ…¢SQL ==="
mysql -u root -p -e "
SELECT 
    id,
    user,
    time,
    LEFT(info, 100) AS sql
FROM information_schema.processlist
WHERE command != 'Sleep' AND time > 5
ORDER BY time DESC
LIMIT 5;
" 2>/dev/null

echo ""
echo "è¯Šæ–­å®Œæˆï¼"
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [README](./README.md)
- [æ€§èƒ½é—®é¢˜æ’æŸ¥](./01_æ€§èƒ½é—®é¢˜æ’æŸ¥.md)
- [ç³»ç»Ÿæ•…éšœæ’æŸ¥](./03_ç³»ç»Ÿæ•…éšœæ’æŸ¥.md)

---

**æœ€åæ›´æ–°**: 2025-10-29  
**æ–‡æ¡£çŠ¶æ€**: âœ… æ¡†æ¶å·²æ­å»ºï¼Œå†…å®¹æŒç»­å®Œå–„ä¸­

