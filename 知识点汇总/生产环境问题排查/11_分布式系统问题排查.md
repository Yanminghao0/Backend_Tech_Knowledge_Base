# 分布式系统问题排查

> 实战指南：如何排查服务调用失败、分布式事务、配置中心等分布式系统问题

## 📋 目录
- [常见问题类型](#常见问题类型)
- [服务调用失败](#服务调用失败)
- [分布式事务问题](#分布式事务问题)
- [配置中心问题](#配置中心问题)
- [服务注册发现](#服务注册发现)

---

## 常见问题类型

### 1. 服务调用失败

**症状**：
```
✅ RPC调用失败
✅ HTTP调用超时
✅ 服务不可访问
```

### 2. 分布式事务问题

**症状**：
```
✅ 事务不一致
✅ 事务回滚失败
✅ 数据不一致
```

### 3. 配置中心问题

**症状**：
```
✅ 配置未生效
✅ 配置丢失
✅ 配置中心不可用
```

### 4. 服务注册发现

**症状**：
```
✅ 服务未注册
✅ 服务发现失败
✅ 服务不可用
```

---

## 服务调用失败

### 排查方法

**1. 查看调用日志**

```bash
# 查看调用日志
grep "RPC调用失败" application.log
grep "Connection refused" application.log
grep "Timeout" application.log
```

**2. 测试服务连通性**

```bash
# 测试服务连通性
curl http://<host>:<port>/health
telnet <host> <port>
```

**3. 查看服务注册**

```bash
# 查看服务注册情况
# Nacos
curl http://<nacos_host>:8848/nacos/v1/ns/instance/list?serviceName=<service_name>

# Eureka
curl http://<eureka_host>:8761/eureka/apps/<service_name>
```

### 常见原因

**1. 服务不可用**

```bash
# 检查服务状态
curl http://<host>:<port>/health
```

**2. 网络问题**

```bash
# 测试网络连通性
ping <host>
telnet <host> <port>
```

**3. 负载均衡问题**

```bash
# 检查负载均衡配置
# 检查服务实例状态
```

### 解决方案

**1. 检查服务状态**

```bash
# 检查服务是否正常运行
# 检查健康检查是否通过
```

**2. 检查网络**

```bash
# 检查网络连通性
# 检查防火墙规则
```

**3. 检查负载均衡**

```bash
# 检查负载均衡配置
# 检查服务实例状态
```

---

## 分布式事务问题

### 排查方法

**1. 查看事务日志**

```bash
# 查看事务日志
grep "事务回滚" application.log
grep "事务提交失败" application.log
```

**2. 查看事务状态**

```bash
# 查看事务状态
# Seata
curl http://<seata_host>:7091/api/v1/transaction/status

# 查看事务日志
```

### 常见原因

**1. 事务超时**

```java
// 事务超时
@Transactional(timeout = 10)
public void longTransaction() {
    // 事务执行时间过长
}
```

**2. 网络问题**

```bash
# 网络问题导致事务失败
# 检查网络连通性
```

**3. 服务不可用**

```bash
# 参与事务的服务不可用
# 检查服务状态
```

### 解决方案

**1. 优化事务范围**

```java
// 减少事务范围
@Transactional
public void shortTransaction() {
    // 快速执行
}
```

**2. 增加重试机制**

```java
// 增加重试机制
@Retryable(maxAttempts = 3, backoff = @Backoff(delay = 1000))
public void distributedTransaction() {
    // 分布式事务
}
```

**3. 使用最终一致性**

```java
// 使用最终一致性
// 消息队列 + 补偿机制
```

---

## 配置中心问题

### 排查方法

**1. 查看配置**

```bash
# Nacos查看配置
curl http://<nacos_host>:8848/nacos/v1/cs/configs?dataId=<dataId>&group=<group>

# Apollo查看配置
curl http://<apollo_host>:8080/configs/<appId>/<cluster>/<namespace>
```

**2. 查看配置变更日志**

```bash
# 查看配置变更日志
grep "配置变更" application.log
```

### 常见原因

**1. 配置未生效**

```bash
# 配置未生效
# 检查配置中心连接
# 检查配置刷新机制
```

**2. 配置丢失**

```bash
# 配置丢失
# 检查配置中心备份
# 检查配置同步
```

**3. 配置中心不可用**

```bash
# 配置中心不可用
# 检查配置中心服务状态
```

### 解决方案

**1. 检查配置中心连接**

```bash
# 检查配置中心服务状态
# 检查网络连通性
```

**2. 配置本地缓存**

```java
// 配置本地缓存
// 配置中心不可用时使用本地配置
```

**3. 配置备份**

```bash
# 配置备份
# 定期备份配置
```

---

## 服务注册发现

### 排查方法

**1. 查看服务注册**

```bash
# Nacos查看服务注册
curl http://<nacos_host>:8848/nacos/v1/ns/instance/list?serviceName=<service_name>

# Eureka查看服务注册
curl http://<eureka_host>:8761/eureka/apps
```

**2. 查看服务发现**

```bash
# 查看服务发现日志
grep "服务发现" application.log
grep "服务不可用" application.log
```

### 常见原因

**1. 服务未注册**

```bash
# 服务未注册
# 检查服务注册配置
# 检查服务注册中心连接
```

**2. 服务发现失败**

```bash
# 服务发现失败
# 检查服务发现配置
# 检查服务注册中心连接
```

**3. 服务健康检查失败**

```bash
# 服务健康检查失败
# 检查健康检查接口
# 检查服务状态
```

### 解决方案

**1. 检查服务注册配置**

```yaml
# 检查服务注册配置
spring:
  cloud:
    nacos:
      discovery:
        server-addr: <nacos_host>:8848
        service-name: <service_name>
```

**2. 检查服务发现配置**

```yaml
# 检查服务发现配置
spring:
  cloud:
    nacos:
      discovery:
        server-addr: <nacos_host>:8848
```

**3. 检查健康检查**

```java
// 检查健康检查接口
@GetMapping("/health")
public String health() {
    return "UP";
}
```

---

## 📚 相关文档

- [性能问题排查](./01_性能问题排查.md)
- [系统故障排查](./03_系统故障排查.md)
- [Spring Cloud Alibaba全家桶](../../06_微服务/Spring Cloud Alibaba全家桶.md)

---

**最后更新**: 2025-10-29  
**文档状态**: ✅ 框架已搭建，内容持续完善中

