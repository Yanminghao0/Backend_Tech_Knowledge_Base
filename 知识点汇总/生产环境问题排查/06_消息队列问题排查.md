# æ¶ˆæ¯é˜Ÿåˆ—é—®é¢˜æ’æŸ¥

> å®æˆ˜æŒ‡å—ï¼šå¦‚ä½•æ’æŸ¥æ¶ˆæ¯ç§¯å‹ã€æ¶ˆè´¹å»¶è¿Ÿã€é‡å¤æ¶ˆè´¹ç­‰æ¶ˆæ¯é˜Ÿåˆ—é—®é¢˜

## ğŸ“‹ ç›®å½•
- [å¸¸è§é—®é¢˜ç±»å‹](#å¸¸è§é—®é¢˜ç±»å‹)
- [æ¶ˆæ¯ç§¯å‹](#æ¶ˆæ¯ç§¯å‹)
- [æ¶ˆè´¹å»¶è¿Ÿ](#æ¶ˆè´¹å»¶è¿Ÿ)
- [é‡å¤æ¶ˆè´¹](#é‡å¤æ¶ˆè´¹)
- [æ¶ˆæ¯ä¸¢å¤±](#æ¶ˆæ¯ä¸¢å¤±)

---

## å¸¸è§é—®é¢˜ç±»å‹

### 1. æ¶ˆæ¯ç§¯å‹

**ç—‡çŠ¶**ï¼š
```
âœ… é˜Ÿåˆ—é•¿åº¦æŒç»­å¢é•¿
âœ… æ¶ˆè´¹é€Ÿåº¦è·Ÿä¸ä¸Šç”Ÿäº§é€Ÿåº¦
âœ… æ¶ˆæ¯å»¶è¿Ÿå¢åŠ 
```

### 2. æ¶ˆè´¹å»¶è¿Ÿ

**ç—‡çŠ¶**ï¼š
```
âœ… æ¶ˆæ¯å¤„ç†å»¶è¿Ÿ
âœ… æ¶ˆè´¹é€Ÿåº¦æ…¢
âœ… æ¶ˆè´¹è€…æ€§èƒ½ä¸‹é™
```

### 3. é‡å¤æ¶ˆè´¹

**ç—‡çŠ¶**ï¼š
```
âœ… åŒä¸€æ¡æ¶ˆæ¯è¢«æ¶ˆè´¹å¤šæ¬¡
âœ… ä¸šåŠ¡æ•°æ®é‡å¤
âœ… å¹‚ç­‰æ€§é—®é¢˜
```

### 4. æ¶ˆæ¯ä¸¢å¤±

**ç—‡çŠ¶**ï¼š
```
âœ… æ¶ˆæ¯æœªæ¶ˆè´¹å°±æ¶ˆå¤±
âœ… ä¸šåŠ¡æ•°æ®ä¸¢å¤±
âœ… æ¶ˆæ¯æœªæŒä¹…åŒ–
```

---

## æ¶ˆæ¯ç§¯å‹

### æ’æŸ¥æ–¹æ³•

**1. æŸ¥çœ‹é˜Ÿåˆ—é•¿åº¦**

```bash
# KafkaæŸ¥çœ‹é˜Ÿåˆ—é•¿åº¦
kafka-run-class kafka.tools.ConsumerGroupCommand \
  --bootstrap-server localhost:9092 \
  --group my-group \
  --describe

# RocketMQæŸ¥çœ‹é˜Ÿåˆ—é•¿åº¦
mqadmin consumerProgress \
  -n localhost:9876 \
  -g my-group
```

**2. æŸ¥çœ‹æ¶ˆè´¹é€Ÿåº¦**

```bash
# KafkaæŸ¥çœ‹æ¶ˆè´¹é€Ÿåº¦
kafka-consumer-groups.sh \
  --bootstrap-server localhost:9092 \
  --group my-group \
  --describe

# å…³æ³¨ï¼š
# LAG: æ¶ˆæ¯ç§¯å‹æ•°é‡
# Current Offset: å½“å‰æ¶ˆè´¹ä½ç½®
# Log End Offset: æ¶ˆæ¯é˜Ÿåˆ—æœ«å°¾ä½ç½®
```

### å¸¸è§åŸå› 

**1. æ¶ˆè´¹é€Ÿåº¦æ…¢**

```
- æ¶ˆè´¹è€…æ€§èƒ½ä¸è¶³
- ä¸šåŠ¡é€»è¾‘å¤æ‚
- æ•°æ®åº“æ“ä½œæ…¢
- ç½‘ç»œå»¶è¿Ÿ
```

**2. æ¶ˆè´¹è€…æ•…éšœ**

```
- æ¶ˆè´¹è€…å®•æœº
- æ¶ˆè´¹è€…é‡å¯
- æ¶ˆè´¹è€…å¼‚å¸¸é€€å‡º
```

**3. ç”Ÿäº§é€Ÿåº¦è¿‡å¿«**

```
- çªå‘æµé‡
- æ‰¹é‡ç”Ÿäº§
- ç”Ÿäº§é€Ÿåº¦è¶…è¿‡æ¶ˆè´¹é€Ÿåº¦
```

### è§£å†³æ–¹æ¡ˆ

**1. å¢åŠ æ¶ˆè´¹è€…**

```java
// å¢åŠ æ¶ˆè´¹è€…å®ä¾‹
// Kafka: å¢åŠ partitionæ•°é‡æˆ–æ¶ˆè´¹è€…æ•°é‡
// RocketMQ: å¢åŠ æ¶ˆè´¹è€…æ•°é‡
```

**2. ä¼˜åŒ–æ¶ˆè´¹é€»è¾‘**

```java
// âŒ ä¸²è¡Œå¤„ç†
for (Message message : messages) {
    processMessage(message);  // æ…¢
}

// âœ… å¹¶è¡Œå¤„ç†
messages.parallelStream().forEach(this::processMessage);
```

**3. æ‰¹é‡æ¶ˆè´¹**

```java
// æ‰¹é‡æ¶ˆè´¹ï¼Œæé«˜ååé‡
@KafkaListener(topics = "topic", concurrency = "10")
public void consume(List<ConsumerRecord<String, String>> records) {
    // æ‰¹é‡å¤„ç†
    processBatch(records);
}
```

**4. é™æµä¿æŠ¤**

```java
// é™æµä¿æŠ¤ï¼Œé¿å…æ¶ˆè´¹è¿‡å¿«å¯¼è‡´ä¸‹æ¸¸å‹åŠ›
RateLimiter limiter = RateLimiter.create(100);  // 100 QPS
for (Message message : messages) {
    limiter.acquire();
    processMessage(message);
}
```

---

## æ¶ˆè´¹å»¶è¿Ÿ

### æ’æŸ¥æ–¹æ³•

**1. æŸ¥çœ‹æ¶ˆè´¹å»¶è¿Ÿ**

```bash
# KafkaæŸ¥çœ‹æ¶ˆè´¹å»¶è¿Ÿ
kafka-consumer-groups.sh \
  --bootstrap-server localhost:9092 \
  --group my-group \
  --describe

# å…³æ³¨LAGï¼ˆç§¯å‹æ•°é‡ï¼‰
```

**2. ç›‘æ§æ¶ˆè´¹æ€§èƒ½**

```java
// ç›‘æ§æ¶ˆè´¹è€—æ—¶
long startTime = System.currentTimeMillis();
processMessage(message);
long duration = System.currentTimeMillis() - startTime;
log.info("æ¶ˆè´¹è€—æ—¶: {}ms", duration);
```

### å¸¸è§åŸå› 

**1. æ¶ˆè´¹é€»è¾‘å¤æ‚**

```java
// âŒ æ¶ˆè´¹é€»è¾‘å¤æ‚ï¼Œè€—æ—¶è¾ƒé•¿
public void consume(Message message) {
    // å¤æ‚ä¸šåŠ¡é€»è¾‘
    // æ•°æ®åº“æ“ä½œ
    // å¤–éƒ¨æœåŠ¡è°ƒç”¨
}

// âœ… ä¼˜åŒ–æ¶ˆè´¹é€»è¾‘
public void consume(Message message) {
    // å¿«é€Ÿå¤„ç†
    // å¼‚æ­¥å¤„ç†å¤æ‚é€»è¾‘
    asyncProcess(message);
}
```

**2. æ•°æ®åº“æ“ä½œæ…¢**

```java
// âŒ åŒæ­¥æ•°æ®åº“æ“ä½œ
public void consume(Message message) {
    db.insert(message);  // æ…¢
}

// âœ… æ‰¹é‡æ’å…¥
public void consume(List<Message> messages) {
    db.batchInsert(messages);  // å¿«
}
```

**3. æ¶ˆè´¹è€…èµ„æºä¸è¶³**

```bash
# æ£€æŸ¥æ¶ˆè´¹è€…èµ„æº
top
iostat -x 1
```

### è§£å†³æ–¹æ¡ˆ

**1. ä¼˜åŒ–æ¶ˆè´¹é€»è¾‘**

```java
// å‡å°‘åŒæ­¥æ“ä½œ
// ä½¿ç”¨å¼‚æ­¥å¤„ç†
// æ‰¹é‡å¤„ç†
```

**2. å¢åŠ æ¶ˆè´¹è€…èµ„æº**

```
- å¢åŠ CPUæ ¸å¿ƒæ•°
- å¢åŠ å†…å­˜
- ä¼˜åŒ–ç½‘ç»œ
```

**3. ä½¿ç”¨å¼‚æ­¥å¤„ç†**

```java
// å¼‚æ­¥å¤„ç†å¤æ‚é€»è¾‘
@KafkaListener(topics = "topic")
public void consume(Message message) {
    // å¿«é€Ÿè¿”å›
    asyncService.process(message);
}
```

---

## é‡å¤æ¶ˆè´¹

### æ’æŸ¥æ–¹æ³•

**1. æŸ¥çœ‹æ¶ˆæ¯ID**

```java
// è®°å½•æ¶ˆæ¯IDï¼Œæ£€æŸ¥æ˜¯å¦é‡å¤
String messageId = message.getMessageId();
if (processedIds.contains(messageId)) {
    log.warn("é‡å¤æ¶ˆè´¹: {}", messageId);
    return;  // è·³è¿‡
}
processedIds.add(messageId);
```

**2. æŸ¥çœ‹æ¶ˆè´¹æ—¥å¿—**

```bash
# æŸ¥çœ‹æ¶ˆè´¹æ—¥å¿—
grep "é‡å¤æ¶ˆè´¹" application.log
grep "messageId" application.log | sort | uniq -d
```

### å¸¸è§åŸå› 

**1. æ¶ˆè´¹å¤±è´¥é‡è¯•**

```
- æ¶ˆè´¹å¤±è´¥åé‡è¯•
- æ¶ˆæ¯è¢«é‡å¤æŠ•é€’
- æ¶ˆè´¹è€…é‡å¯åé‡å¤æ¶ˆè´¹
```

**2. æ¶ˆæ¯é˜Ÿåˆ—æœºåˆ¶**

```
- Kafka: æ¶ˆè´¹è€…åç§»é‡æœªæäº¤
- RocketMQ: æ¶ˆæ¯é‡è¯•æœºåˆ¶
```

### è§£å†³æ–¹æ¡ˆ

**1. å¹‚ç­‰æ€§è®¾è®¡**

```java
// ä½¿ç”¨å”¯ä¸€æ ‡è¯†ä¿è¯å¹‚ç­‰æ€§
String messageId = message.getMessageId();
String key = "processed:" + messageId;

// ä½¿ç”¨Redisæ£€æŸ¥æ˜¯å¦å·²å¤„ç†
if (redis.exists(key)) {
    return;  // å·²å¤„ç†ï¼Œè·³è¿‡
}

// å¤„ç†æ¶ˆæ¯
processMessage(message);

// æ ‡è®°å·²å¤„ç†
redis.setex(key, 3600, "1");  // 1å°æ—¶è¿‡æœŸ
```

**2. æ•°æ®åº“å”¯ä¸€çº¦æŸ**

```sql
-- ä½¿ç”¨å”¯ä¸€çº¦æŸé˜²æ­¢é‡å¤
CREATE TABLE message_processed (
    message_id VARCHAR(64) PRIMARY KEY,
    processed_time TIMESTAMP
);
```

**3. åˆ†å¸ƒå¼é”**

```java
// ä½¿ç”¨åˆ†å¸ƒå¼é”ä¿è¯å¹‚ç­‰æ€§
String lockKey = "lock:" + messageId;
if (redis.setnx(lockKey, "1", 60)) {  // è·å–é”
    try {
        processMessage(message);
    } finally {
        redis.del(lockKey);  // é‡Šæ”¾é”
    }
} else {
    log.warn("æ¶ˆæ¯æ­£åœ¨å¤„ç†ä¸­: {}", messageId);
}
```

---

## æ¶ˆæ¯ä¸¢å¤±

### æ’æŸ¥æ–¹æ³•

**1. æŸ¥çœ‹æ¶ˆæ¯ç¡®è®¤**

```java
// Kafka: æ‰‹åŠ¨æäº¤åç§»é‡
@KafkaListener(topics = "topic")
public void consume(ConsumerRecord<String, String> record) {
    try {
        processMessage(record);
        // å¤„ç†æˆåŠŸåæ‰æäº¤åç§»é‡
        // æ³¨æ„ï¼šå¦‚æœè¿™é‡ŒæŠ›å‡ºå¼‚å¸¸ï¼Œæ¶ˆæ¯ä¼šä¸¢å¤±
    } catch (Exception e) {
        log.error("å¤„ç†å¤±è´¥", e);
        // å¤„ç†å¤±è´¥ï¼Œä¸æäº¤åç§»é‡ï¼Œæ¶ˆæ¯ä¼šé‡æ–°æ¶ˆè´¹
    }
}
```

**2. æŸ¥çœ‹æ¶ˆæ¯æŒä¹…åŒ–**

```bash
# KafkaæŸ¥çœ‹æ¶ˆæ¯æŒä¹…åŒ–
kafka-run-class kafka.tools.DumpLogSegments \
  --files /tmp/kafka-logs/topic-0/00000000000000000000.log \
  --print-data-log
```

### å¸¸è§åŸå› 

**1. æ¶ˆæ¯æœªæŒä¹…åŒ–**

```
- æ¶ˆæ¯é˜Ÿåˆ—å®•æœº
- æ¶ˆæ¯æœªè½ç›˜
- æ¶ˆæ¯åœ¨å†…å­˜ä¸­ä¸¢å¤±
```

**2. æ¶ˆè´¹å¤±è´¥æœªå¤„ç†**

```
- æ¶ˆè´¹å¤±è´¥åæœªé‡è¯•
- å¼‚å¸¸è¢«åæ‰
- æ¶ˆæ¯è¢«ä¸¢å¼ƒ
```

**3. åç§»é‡æäº¤é”™è¯¯**

```java
// âŒ å¤„ç†å¤±è´¥ä½†æäº¤äº†åç§»é‡
try {
    processMessage(message);
} catch (Exception e) {
    // å¼‚å¸¸è¢«åæ‰
}
// åç§»é‡è¢«æäº¤ï¼Œæ¶ˆæ¯ä¸¢å¤±

// âœ… å¤„ç†å¤±è´¥ä¸æäº¤åç§»é‡
try {
    processMessage(message);
} catch (Exception e) {
    log.error("å¤„ç†å¤±è´¥", e);
    throw e;  // æŠ›å‡ºå¼‚å¸¸ï¼Œä¸æäº¤åç§»é‡
}
```

### è§£å†³æ–¹æ¡ˆ

**1. æ¶ˆæ¯æŒä¹…åŒ–**

```java
// Kafka: è®¾ç½®acks=allï¼Œä¿è¯æ¶ˆæ¯æŒä¹…åŒ–
properties.put("acks", "all");
properties.put("retries", 3);
properties.put("max.in.flight.requests.per.connection", 1);
```

**2. æ‰‹åŠ¨æäº¤åç§»é‡**

```java
// æ‰‹åŠ¨æäº¤åç§»é‡ï¼Œä¿è¯æ¶ˆæ¯å¤„ç†æˆåŠŸ
@KafkaListener(topics = "topic", 
               containerFactory = "kafkaListenerContainerFactory")
public void consume(ConsumerRecord<String, String> record,
                    Acknowledgment ack) {
    try {
        processMessage(record);
        ack.acknowledge();  // å¤„ç†æˆåŠŸåæäº¤
    } catch (Exception e) {
        log.error("å¤„ç†å¤±è´¥", e);
        // ä¸æäº¤åç§»é‡ï¼Œæ¶ˆæ¯ä¼šé‡æ–°æ¶ˆè´¹
    }
}
```

**3. æ­»ä¿¡é˜Ÿåˆ—**

```java
// å¤„ç†å¤±è´¥çš„æ¶ˆæ¯å‘é€åˆ°æ­»ä¿¡é˜Ÿåˆ—
try {
    processMessage(message);
} catch (Exception e) {
    log.error("å¤„ç†å¤±è´¥", e);
    // å‘é€åˆ°æ­»ä¿¡é˜Ÿåˆ—
    deadLetterQueue.send(message);
}
```

---

## æ¶ˆæ¯é˜Ÿåˆ—ä¼˜åŒ–å»ºè®®

### 1. æ¶ˆè´¹ä¼˜åŒ–

```
âœ… æ‰¹é‡æ¶ˆè´¹
âœ… å¹¶è¡Œå¤„ç†
âœ… å¼‚æ­¥å¤„ç†
âœ… ä¼˜åŒ–æ¶ˆè´¹é€»è¾‘
```

### 2. ç›‘æ§å‘Šè­¦

```
âœ… é˜Ÿåˆ—é•¿åº¦ç›‘æ§
âœ… æ¶ˆè´¹å»¶è¿Ÿç›‘æ§
âœ… æ¶ˆè´¹é€Ÿåº¦ç›‘æ§
âœ… é”™è¯¯ç‡ç›‘æ§
```

### 3. å®¹é”™è®¾è®¡

```
âœ… å¹‚ç­‰æ€§è®¾è®¡
âœ… é‡è¯•æœºåˆ¶
âœ… æ­»ä¿¡é˜Ÿåˆ—
âœ… æ¶ˆæ¯æŒä¹…åŒ–
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æ€§èƒ½é—®é¢˜æ’æŸ¥](./01_æ€§èƒ½é—®é¢˜æ’æŸ¥.md)
- [Kafkaæ ¸å¿ƒæœºåˆ¶è¯¦è§£](../../05_æ¶ˆæ¯é˜Ÿåˆ—/Kafkaæ ¸å¿ƒæœºåˆ¶è¯¦è§£.md)
- [RocketMQæ ¸å¿ƒæœºåˆ¶è¯¦è§£](../../05_æ¶ˆæ¯é˜Ÿåˆ—/RocketMQæ ¸å¿ƒæœºåˆ¶è¯¦è§£.md)

---

**æœ€åæ›´æ–°**: 2025-10-29  
**æ–‡æ¡£çŠ¶æ€**: âœ… æ¡†æ¶å·²æ­å»ºï¼Œå†…å®¹æŒç»­å®Œå–„ä¸­

