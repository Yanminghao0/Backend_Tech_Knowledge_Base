# 系统故障排查

> 实战指南：如何排查服务不可用、宕机、重启等系统故障

## 📋 目录
- [故障类型分类](#故障类型分类)
- [故障排查流程](#故障排查流程)
- [常见故障场景](#常见故障场景)
- [快速恢复方案](#快速恢复方案)

---

## 故障类型分类

### 1. 服务完全不可用

**症状**：
```
✅ 服务无响应
✅ 健康检查失败
✅ 所有接口返回错误
✅ 监控显示服务下线
```

**可能原因**：
```
- 服务进程崩溃
- 服务启动失败
- 端口被占用
- 资源耗尽（内存、磁盘）
```

### 2. 服务部分不可用

**症状**：
```
✅ 部分接口正常
✅ 部分接口异常
✅ 部分功能异常
✅ 部分用户受影响
```

**可能原因**：
```
- 依赖服务异常
- 数据库连接问题
- 缓存连接问题
- 配置错误
```

### 3. 服务性能下降

**症状**：
```
✅ 接口响应变慢
✅ QPS下降
✅ 错误率上升
✅ 资源使用率上升
```

**可能原因**：
```
- 慢查询
- 资源瓶颈
- 线程池满
- 连接池满
```

---

## 故障排查流程

### 第一步：确认故障现象（2分钟）

```
1. 查看监控告警
   - 服务是否在线？
   - 健康检查是否通过？
   - 错误率是否上升？

2. 验证服务状态
   - 访问健康检查接口
   - 查看服务日志
   - 查看系统资源

3. 确认影响范围
   - 单个服务还是多个服务？
   - 部分用户还是全部用户？
   - 部分功能还是全部功能？
```

### 第二步：快速定位（5分钟）

```
1. 检查服务进程
   - 进程是否存在？
   - 进程状态是否正常？

2. 检查服务端口
   - 端口是否监听？
   - 端口是否被占用？

3. 检查系统资源
   - CPU使用率
   - 内存使用率
   - 磁盘空间
   - 网络连接

4. 查看错误日志
   - 应用日志
   - 系统日志
   - 中间件日志
```

### 第三步：深入分析（10分钟）

```
1. 分析错误日志
   - 查看异常堆栈
   - 分析错误原因

2. 分析系统资源
   - 查看资源使用情况
   - 查看资源瓶颈

3. 分析依赖服务
   - 数据库是否正常？
   - 缓存是否正常？
   - 其他服务是否正常？
```

### 第四步：恢复服务（5分钟）

```
1. 快速恢复（临时方案）
   - 重启服务
   - 扩容
   - 降级
   - 限流

2. 根本解决（永久方案）
   - 修复代码bug
   - 优化配置
   - 架构优化
```

---

## 常见故障场景

### 场景1：服务进程崩溃

**症状**：
```
- 服务突然停止
- 进程不存在
- 健康检查失败
```

**排查方法**：
```bash
# 查看进程
ps aux | grep java
jps -lvm

# 查看系统日志
dmesg | tail -100
journalctl -u service-name -n 100

# 查看应用日志
tail -n 1000 application.log | grep -i error
```

**常见原因**：
```
- OOM（内存溢出）
- 段错误（Segmentation Fault）
- 系统资源耗尽
- 代码bug导致崩溃
```

**解决方案**：
```
1. 查看崩溃日志（hs_err_pid*.log）
2. 分析OOM原因
3. 增加内存或优化代码
4. 重启服务
```

### 场景2：服务启动失败

**症状**：
```
- 服务无法启动
- 启动后立即退出
- 端口未监听
```

**排查方法**：
```bash
# 查看启动日志
tail -f application.log
journalctl -u service-name -f

# 查看端口占用
lsof -i :8080
netstat -tlnp | grep 8080

# 检查配置文件
cat application.yml
```

**常见原因**：
```
- 端口被占用
- 配置文件错误
- 依赖服务不可用
- 数据库连接失败
- 资源不足
```

**解决方案**：
```
1. 检查端口占用，释放端口
2. 修复配置文件
3. 检查依赖服务
4. 检查资源（内存、磁盘）
```

### 场景3：服务无响应

**症状**：
```
- 接口无响应
- 请求超时
- 健康检查失败
```

**排查方法**：
```bash
# 查看进程状态
ps aux | grep java
top -H -p <pid>

# 查看线程堆栈
jstack <pid>

# 查看网络连接
netstat -antp | grep <pid>
ss -antp | grep <pid>

# 查看系统资源
free -h
df -h
iostat -x 1
```

**常见原因**：
```
- 线程死锁
- 死循环
- 资源耗尽
- 网络问题
```

**解决方案**：
```
1. 查看线程堆栈，定位问题
2. 重启服务（临时方案）
3. 修复代码bug（根本方案）
```

### 场景4：数据库连接失败

**症状**：
```
- 数据库操作失败
- 连接超时
- 连接池满
```

**排查方法**：
```sql
-- 查看数据库连接数
SHOW PROCESSLIST;
SHOW VARIABLES LIKE 'max_connections';
SHOW STATUS LIKE 'Threads_connected';

-- 查看数据库状态
SHOW STATUS;
```

```bash
# 测试数据库连接
mysql -h <host> -u <user> -p

# 查看数据库日志
tail -f /var/log/mysql/error.log
```

**常见原因**：
```
- 数据库服务不可用
- 连接数达到上限
- 网络问题
- 连接池配置错误
```

**解决方案**：
```
1. 检查数据库服务状态
2. 增加连接数限制
3. 检查网络连接
4. 优化连接池配置
```

### 场景5：缓存连接失败

**症状**：
```
- Redis操作失败
- 缓存连接超时
- 缓存不可用
```

**排查方法**：
```bash
# 测试Redis连接
redis-cli -h <host> -p <port> PING

# 查看Redis状态
redis-cli INFO server
redis-cli INFO stats

# 查看Redis日志
tail -f /var/log/redis/redis-server.log
```

**常见原因**：
```
- Redis服务不可用
- 网络问题
- 连接数达到上限
- 密码错误
```

**解决方案**：
```
1. 检查Redis服务状态
2. 检查网络连接
3. 增加连接数限制
4. 检查密码配置
```

---

## 快速恢复方案

### 1. 重启服务

**适用场景**：
```
- 服务无响应
- 服务异常但未崩溃
- 临时解决问题
```

**操作步骤**：
```bash
# 优雅重启
systemctl restart service-name

# 或使用脚本
./restart.sh

# 注意：确保优雅关闭
# 1. 停止接收新请求
# 2. 处理完现有请求
# 3. 关闭连接
# 4. 退出进程
```

**注意事项**：
```
⚠️ 重启会中断正在处理的请求
⚠️ 重启可能导致数据丢失
⚠️ 重启前先尝试其他方案
```

### 2. 扩容

**适用场景**：
```
- 服务负载过高
- 资源不足
- 需要提高处理能力
```

**操作步骤**：
```
1. 增加实例数
2. 更新负载均衡配置
3. 验证服务正常
```

### 3. 降级

**适用场景**：
```
- 部分功能异常
- 依赖服务异常
- 需要保证核心功能
```

**降级策略**：
```
1. 关闭非核心功能
2. 返回默认值
3. 使用缓存数据
4. 简化业务流程
```

### 4. 限流

**适用场景**：
```
- 流量突增
- 服务过载
- 需要保护系统
```

**限流方案**：
```
1. 接口限流
2. 用户限流
3. IP限流
4. 全局限流
```

### 5. 回滚

**适用场景**：
```
- 新版本发布后出现问题
- 配置修改导致问题
- 需要快速恢复
```

**回滚步骤**：
```
1. 停止新版本
2. 部署旧版本
3. 验证服务正常
4. 分析问题原因
```

---

## 故障预防措施

### 1. 监控告警

```
✅ 服务健康检查
✅ 资源使用监控
✅ 错误率监控
✅ 依赖服务监控
```

### 2. 容错设计

```
✅ 服务熔断
✅ 服务降级
✅ 重试机制
✅ 超时控制
```

### 3. 高可用设计

```
✅ 多实例部署
✅ 负载均衡
✅ 自动故障转移
✅ 数据备份
```

### 4. 定期演练

```
✅ 故障演练
✅ 压力测试
✅ 灾难恢复演练
```

---

## 📚 相关文档

- [性能问题排查](./01_性能问题排查.md)
- [错误日志分析](./02_错误日志分析.md)
- [数据库问题排查](./04_数据库问题排查.md)

---

**最后更新**: 2025-10-29  
**文档状态**: ✅ 框架已搭建，内容持续完善中

