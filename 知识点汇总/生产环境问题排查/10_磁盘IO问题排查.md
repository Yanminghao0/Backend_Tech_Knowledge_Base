# 磁盘IO问题排查

> 实战指南：如何排查磁盘满、IO等待、文件句柄泄露等磁盘问题

## 📋 目录
- [常见问题类型](#常见问题类型)
- [磁盘空间问题](#磁盘空间问题)
- [IO等待问题](#io等待问题)
- [文件句柄泄露](#文件句柄泄露)
- [排查工具](#排查工具)

---

## 常见问题类型

### 1. 磁盘空间不足

**症状**：
```
✅ 磁盘使用率>90%
✅ 无法写入文件
✅ 应用异常
```

### 2. IO等待高

**症状**：
```
✅ IO等待时间长
✅ 应用响应变慢
✅ 系统负载高
```

### 3. 文件句柄泄露

**症状**：
```
✅ 文件句柄数持续增长
✅ 无法打开新文件
✅ 应用异常
```

---

## 磁盘空间问题

### 排查方法

**1. 查看磁盘使用情况**

```bash
# 查看磁盘使用情况
df -h
df -i  # 查看inode使用情况

# 查看目录大小
du -sh /*
du -h --max-depth=1 /

# 查找大文件
find / -type f -size +100M -exec ls -lh {} \; | sort -k5 -hr | head -20
```

**2. 查找大文件**

```bash
# 查找大于100M的文件
find / -type f -size +100M -exec ls -lh {} \;

# 查找最近修改的大文件
find / -type f -size +100M -mtime -7 -exec ls -lh {} \;
```

### 常见原因

**1. 日志文件过大**

```bash
# 查找日志文件
find /var/log -type f -size +100M

# 清理日志文件
# 1. 删除旧日志
# 2. 压缩日志
# 3. 配置日志轮转
```

**2. 临时文件未清理**

```bash
# 查找临时文件
find /tmp -type f -mtime +7

# 清理临时文件
find /tmp -type f -mtime +7 -delete
```

**3. 堆转储文件**

```bash
# 查找堆转储文件
find / -name "*.hprof" -type f

# 清理堆转储文件
find / -name "*.hprof" -type f -mtime +7 -delete
```

### 解决方案

**1. 清理大文件**

```bash
# 删除旧日志
find /var/log -type f -mtime +30 -delete

# 压缩日志
find /var/log -type f -name "*.log" -mtime +7 -exec gzip {} \;

# 清理临时文件
find /tmp -type f -mtime +7 -delete
```

**2. 配置日志轮转**

```bash
# 配置logrotate
cat /etc/logrotate.d/application
/var/log/application.log {
    daily
    rotate 7
    compress
    missingok
    notifempty
}
```

**3. 监控磁盘使用率**

```bash
# 设置告警
# 磁盘使用率>80%时告警
```

---

## IO等待问题

### 排查方法

**1. 查看IO统计**

```bash
# 查看IO统计
iostat -x 1

# 查看IO等待
top
vmstat 1

# 查看磁盘IO
iotop
```

**2. 查看IO等待进程**

```bash
# 查看IO等待的进程
iotop -o

# 查看进程IO统计
pidstat -d 1
```

### 常见原因

**1. 频繁IO操作**

```java
// ❌ 频繁IO操作
for (int i = 0; i < 1000; i++) {
    File file = new File("file" + i);
    file.createNewFile();  // 频繁IO
}

// ✅ 批量操作
// 1. 批量处理
// 2. 使用缓冲
// 3. 异步IO
```

**2. 大文件操作**

```java
// ❌ 大文件操作
byte[] data = Files.readAllBytes(Paths.get("large_file.txt"));  // 大文件

// ✅ 流式处理
try (BufferedReader reader = Files.newBufferedReader(Paths.get("large_file.txt"))) {
    String line;
    while ((line = reader.readLine()) != null) {
        // 处理行
    }
}
```

**3. 数据库慢查询**

```sql
-- 慢查询导致IO等待
-- 优化SQL，减少IO
```

### 解决方案

**1. 优化IO操作**

```java
// 1. 使用缓冲
// 2. 批量处理
// 3. 异步IO
// 4. 流式处理
```

**2. 优化数据库**

```sql
-- 1. 优化SQL
-- 2. 添加索引
-- 3. 分库分表
```

**3. 使用SSD**

```
- 使用SSD磁盘
- 提高IO性能
```

---

## 文件句柄泄露

### 排查方法

**1. 查看文件句柄数**

```bash
# 查看文件句柄数
lsof | wc -l
lsof -p <pid> | wc -l

# 查看文件句柄限制
ulimit -n
cat /proc/sys/fs/file-max
```

**2. 查看进程文件句柄**

```bash
# 查看进程文件句柄
lsof -p <pid>
ls -l /proc/<pid>/fd | wc -l
```

### 常见原因

**1. 文件未关闭**

```java
// ❌ 文件未关闭
FileInputStream fis = new FileInputStream("file.txt");
// 忘记关闭

// ✅ 使用try-with-resources
try (FileInputStream fis = new FileInputStream("file.txt")) {
    // 使用文件
}  // 自动关闭
```

**2. 连接未关闭**

```java
// ❌ 连接未关闭
Connection conn = dataSource.getConnection();
// 忘记关闭

// ✅ 使用try-with-resources
try (Connection conn = dataSource.getConnection()) {
    // 使用连接
}  // 自动关闭
```

**3. Socket未关闭**

```java
// ❌ Socket未关闭
Socket socket = new Socket("host", 8080);
// 忘记关闭

// ✅ 使用try-with-resources
try (Socket socket = new Socket("host", 8080)) {
    // 使用Socket
}  // 自动关闭
```

### 解决方案

**1. 修复资源泄漏**

```java
// 使用try-with-resources自动关闭资源
try (Resource resource = getResource()) {
    // 使用资源
}  // 自动关闭
```

**2. 增加文件句柄限制**

```bash
# 增加文件句柄限制
ulimit -n 65535

# 永久生效（修改配置文件）
echo "* soft nofile 65535" >> /etc/security/limits.conf
echo "* hard nofile 65535" >> /etc/security/limits.conf
```

**3. 监控文件句柄**

```bash
# 监控文件句柄数
# 设置告警
```

---

## 排查工具

### 1. 磁盘工具

```bash
# df - 查看磁盘使用情况
df -h
df -i

# du - 查看目录大小
du -sh *
du -h --max-depth=1 /

# find - 查找大文件
find / -type f -size +100M
```

### 2. IO工具

```bash
# iostat - IO统计
iostat -x 1

# iotop - IO监控
iotop

# pidstat - 进程IO统计
pidstat -d 1
```

### 3. 文件句柄工具

```bash
# lsof - 查看文件句柄
lsof
lsof -p <pid>

# 查看文件句柄数
lsof | wc -l
ls -l /proc/<pid>/fd | wc -l
```

---

## 📚 相关文档

- [性能问题排查](./01_性能问题排查.md)
- [系统故障排查](./03_系统故障排查.md)

---

**最后更新**: 2025-10-29  
**文档状态**: ✅ 框架已搭建，内容持续完善中

