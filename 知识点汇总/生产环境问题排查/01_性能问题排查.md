# 性能问题排查

> 实战指南：如何排查接口慢、响应时间长、QPS低等性能问题

## 📋 目录
- [问题现象识别](#问题现象识别)
- [排查思路](#排查思路)
- [常见原因分析](#常见原因分析)
- [排查工具与方法](#排查工具与方法)
- [典型案例](#典型案例)

---

## 问题现象识别

### 典型症状

```
✅ 接口响应时间（RT）明显增加
   - P50 RT：正常 < 50ms，异常 > 200ms
   - P99 RT：正常 < 200ms，异常 > 1000ms

✅ QPS（每秒请求数）下降
   - 正常：10000 QPS
   - 异常：5000 QPS（下降50%）

✅ 吞吐量下降
   - TPS（每秒事务数）下降
   - 并发处理能力下降

✅ 用户反馈
   - 页面加载慢
   - 接口超时
   - 操作卡顿
```

### 监控指标

```
1. 应用层指标：
   - RT（响应时间）：P50、P90、P99
   - QPS（每秒请求数）
   - 错误率
   - 成功率

2. 系统层指标：
   - CPU使用率
   - 内存使用率
   - 线程数
   - 连接数

3. 中间件指标：
   - 数据库慢查询
   - Redis响应时间
   - 消息队列积压
```

---

## 排查思路

### 排查流程

```
1. 确认问题现象
   ↓
2. 查看监控大盘（QPS、RT、错误率）
   ↓
3. 定位问题接口（哪个接口慢？）
   ↓
4. 分析调用链（慢在哪里？）
   ↓
5. 深入排查（数据库、缓存、网络）
   ↓
6. 优化解决
```

### 排查步骤

**第一步：确认问题范围**
```
- 是单个接口慢，还是所有接口都慢？
- 是特定用户慢，还是所有用户都慢？
- 是特定时间段慢，还是持续慢？
```

**第二步：查看监控数据**
```
- APM监控（SkyWalking、Pinpoint）
- 应用监控（Prometheus、Grafana）
- 系统监控（CPU、内存、IO）
```

**第三步：分析调用链**
```
- 接口总耗时
- 各组件耗时（数据库、缓存、RPC）
- 慢调用详情
```

**第四步：深入排查**
```
- 数据库慢SQL
- 缓存命中率
- 网络延迟
- 线程池状态
```

---

## 常见原因分析

### 1. 数据库慢查询

**症状**：
```
- 接口RT突然增加
- 数据库CPU使用率上升
- 慢查询日志增加
```

**排查方法**：
```sql
-- 查看慢查询
SHOW VARIABLES LIKE 'slow_query%';
SELECT * FROM mysql.slow_log ORDER BY start_time DESC LIMIT 10;

-- 查看当前执行中的SQL
SHOW PROCESSLIST;

-- 分析慢SQL
EXPLAIN SELECT ...;

-- 查看锁等待
SELECT * FROM information_schema.innodb_lock_waits;
```

**解决方案**：
```
1. 添加索引
2. 优化SQL（避免SELECT *、避免函数计算）
3. 分库分表
4. 读写分离
```

### 2. 缓存命中率低

**症状**：
```
- Redis命中率 < 80%
- 大量请求打到数据库
- 数据库压力增大
```

**排查方法**：
```bash
# Redis命中率
redis-cli INFO stats | grep keyspace_hits
redis-cli INFO stats | grep keyspace_misses

# 命中率计算
命中率 = keyspace_hits / (keyspace_hits + keyspace_misses)
```

**解决方案**：
```
1. 增加缓存预热
2. 调整缓存过期时间
3. 优化缓存key设计
4. 增加多级缓存
```

### 3. 线程池满

**症状**：
```
- 接口响应变慢
- 线程池队列积压
- 出现线程池拒绝异常
```

**排查方法**：
```java
// 使用Arthas查看线程池状态
threadpool

// 查看线程数
jstack <pid> | grep "pool-"
```

**解决方案**：
```
1. 增加线程池大小
2. 优化业务逻辑（减少线程占用时间）
3. 使用异步处理
4. 增加实例数
```

### 4. 连接池满

**症状**：
```
- 数据库连接池满
- Redis连接池满
- 出现连接超时异常
```

**排查方法**：
```java
// 查看数据库连接池状态
HikariCP: active connections, idle connections

// 查看Redis连接数
redis-cli CLIENT LIST | wc -l
```

**解决方案**：
```
1. 增加连接池大小
2. 检查连接泄漏（连接未关闭）
3. 优化连接使用（减少连接持有时间）
4. 使用连接池监控
```

### 5. 网络延迟

**症状**：
```
- 跨服务调用变慢
- 网络延迟增加
- 出现超时异常
```

**排查方法**：
```bash
# 测试网络延迟
ping <host>
traceroute <host>

# 查看网络连接
netstat -antp | grep <port>
ss -antp | grep <port>
```

**解决方案**：
```
1. 检查网络设备
2. 优化服务部署（同机房）
3. 使用CDN加速
4. 优化网络配置
```

---

## 排查工具与方法

### 1. APM监控工具

**SkyWalking**：
```
- 查看调用链
- 分析慢接口
- 查看各组件耗时
```

**Pinpoint**：
```
- 实时监控
- 调用链分析
- 性能分析
```

### 2. Java应用排查

**Arthas**：
```bash
# 安装Arthas
curl -O https://arthas.aliyun.com/arthas-boot.jar

# 启动
java -jar arthas-boot.jar

# 查看接口耗时
trace com.example.service.UserService getUserById

# 查看方法调用统计
monitor com.example.service.UserService getUserById

# 查看线程堆栈
thread

# 查看线程池状态
threadpool
```

**JProfiler**：
```
- CPU性能分析
- 内存分析
- 线程分析
```

### 3. 数据库排查

**慢查询日志**：
```sql
-- 开启慢查询
SET GLOBAL slow_query_log = 'ON';
SET GLOBAL long_query_time = 1;  -- 1秒

-- 查看慢查询
SELECT * FROM mysql.slow_log ORDER BY start_time DESC LIMIT 10;
```

**EXPLAIN分析**：
```sql
EXPLAIN SELECT * FROM orders WHERE user_id = 123;

-- 重点关注：
-- type: 访问类型（ALL最差，const最好）
-- key: 使用的索引
-- rows: 扫描行数
-- Extra: 额外信息
```

### 4. 缓存排查

**Redis性能分析**：
```bash
# 查看慢查询
redis-cli SLOWLOG GET 10

# 查看大key
redis-cli --bigkeys

# 查看热key
redis-cli --hotkeys

# 查看内存使用
redis-cli INFO memory
```

---

## 典型案例

### 案例1：接口突然变慢

**现象**：
```
- 订单查询接口RT从50ms增加到2000ms
- QPS从10000下降到5000
- 用户反馈页面加载慢
```

**排查过程**：
```
1. 查看APM监控 → 订单查询接口RT异常
2. 分析调用链 → 数据库查询耗时1800ms
3. 查看慢查询日志 → 发现全表扫描
4. 分析SQL → 缺少索引
```

**解决方案**：
```sql
-- 添加索引
CREATE INDEX idx_user_id_status ON orders(user_id, status);
```

### 案例2：高峰期QPS下降

**现象**：
```
- 高峰期QPS从20000下降到10000
- 接口RT增加到500ms
- 线程池队列积压
```

**排查过程**：
```
1. 查看监控 → 线程池使用率100%
2. 查看线程堆栈 → 大量线程等待数据库连接
3. 查看连接池 → 数据库连接池满
4. 检查代码 → 发现连接泄漏
```

**解决方案**：
```
1. 修复连接泄漏
2. 增加连接池大小
3. 优化业务逻辑（减少连接持有时间）
```

### 案例3：缓存命中率低

**现象**：
```
- Redis命中率从90%下降到50%
- 数据库压力增大
- 接口RT增加
```

**排查过程**：
```
1. 查看缓存监控 → 命中率下降
2. 分析缓存key → 发现大量key过期
3. 查看代码 → 缓存过期时间设置不合理
```

**解决方案**：
```
1. 调整缓存过期时间
2. 增加缓存预热
3. 优化缓存key设计
```

---

## 性能优化建议

### 1. 应用层优化

```
✅ 使用连接池
✅ 使用线程池
✅ 异步处理
✅ 批量操作
✅ 减少不必要的计算
```

### 2. 数据库优化

```
✅ 添加索引
✅ 优化SQL
✅ 读写分离
✅ 分库分表
✅ 使用缓存
```

### 3. 缓存优化

```
✅ 多级缓存
✅ 缓存预热
✅ 合理设置过期时间
✅ 避免缓存穿透/击穿/雪崩
```

### 4. 架构优化

```
✅ 水平扩展
✅ 负载均衡
✅ CDN加速
✅ 消息队列削峰
```

---

## 📚 相关文档

- [数据库问题排查](./04_数据库问题排查.md)
- [缓存问题排查](./05_缓存问题排查.md)
- [系统设计方法论](../系统设计方法论.md)

---

**最后更新**: 2025-10-29  
**文档状态**: ✅ 框架已搭建，内容持续完善中

