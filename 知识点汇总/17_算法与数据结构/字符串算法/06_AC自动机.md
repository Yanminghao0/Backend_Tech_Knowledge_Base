# ACè‡ªåŠ¨æœº

> ACè‡ªåŠ¨æœºï¼ˆAho-Corasick Automatonï¼‰æ˜¯ä¸€ç§å¤šæ¨¡å¼å­—ç¬¦ä¸²åŒ¹é…ç®—æ³•ï¼Œç”±Alfred V. Ahoå’ŒMargaret J. Corasickäº1975å¹´æå‡ºã€‚å®ƒç»“åˆäº†Trieæ ‘çš„å‰ç¼€åŒ¹é…ç‰¹æ€§å’ŒKMPç®—æ³•çš„å¤±é…å‡½æ•°æ€æƒ³ï¼Œèƒ½å¤Ÿåœ¨O(n + m + z)æ—¶é—´å¤æ‚åº¦å†…åŒæ—¶åŒ¹é…å¤šä¸ªæ¨¡å¼ä¸²ï¼Œå…¶ä¸­næ˜¯æ–‡æœ¬é•¿åº¦ï¼Œmæ˜¯æ‰€æœ‰æ¨¡å¼ä¸²æ€»é•¿åº¦ï¼Œzæ˜¯åŒ¹é…æ¬¡æ•°ã€‚

---

## ğŸ“‹ åŸºæœ¬ä¿¡æ¯

### å®šä¹‰
ACè‡ªåŠ¨æœºæ˜¯ä¸€ç§åŸºäºTrieæ ‘çš„æ”¹è¿›ç®—æ³•ï¼Œé€šè¿‡æ„å»ºå¤±æ•ˆé“¾æ¥ï¼ˆFailure Linkï¼‰å®ç°å¤šæ¨¡å¼ä¸²çš„é«˜æ•ˆåŒ¹é…ã€‚å®ƒä¸»è¦ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼šTrieæ ‘ç»“æ„ã€å¤±æ•ˆé“¾æ¥è¡¨å’Œè¾“å‡ºé“¾æ¥è¡¨ã€‚ACè‡ªåŠ¨æœºç‰¹åˆ«é€‚åˆåœ¨ä¸€ç¯‡æ–‡æœ¬ä¸­åŒæ—¶æŸ¥æ‰¾å¤šä¸ªæ¨¡å¼ä¸²çš„åœºæ™¯ï¼Œå¦‚æ•æ„Ÿè¯è¿‡æ»¤ã€æ—¥å¿—åˆ†æå’ŒåŸºå› åºåˆ—åŒ¹é…ç­‰ã€‚

### æ ¸å¿ƒæ€æƒ³
1. **Trieæ ‘æ„å»º**ï¼šå°†æ‰€æœ‰æ¨¡å¼ä¸²æ„å»ºæˆä¸€æ£µTrieæ ‘ï¼Œæ¯ä¸ªèŠ‚ç‚¹ä»£è¡¨ä¸€ä¸ªå­—ç¬¦
2. **å¤±æ•ˆé“¾æ¥**ï¼šä¸ºæ¯ä¸ªèŠ‚ç‚¹æ·»åŠ æŒ‡å‘æœ€é•¿åç¼€åŒ¹é…èŠ‚ç‚¹çš„é“¾æ¥ï¼Œç±»ä¼¼äºKMPç®—æ³•çš„éƒ¨åˆ†åŒ¹é…è¡¨
3. **è¾“å‡ºé“¾æ¥**ï¼šæŒ‡å‘åŒ…å«å½“å‰èŠ‚ç‚¹æ‰€ä»£è¡¨æ¨¡å¼ä¸²çš„å…¶ä»–èŠ‚ç‚¹ï¼Œç”¨äºæ”¶é›†æ‰€æœ‰åŒ¹é…ç»“æœ
4. **å¤šæ¨¡å¼åŒ¹é…**ï¼šæ–‡æœ¬åªéœ€æ‰«æä¸€æ¬¡ï¼Œå³å¯æ‰¾å‡ºæ‰€æœ‰å‡ºç°çš„æ¨¡å¼ä¸²

### ä¸å…¶ä»–ç®—æ³•å¯¹æ¯”
| ç®—æ³• | æ—¶é—´å¤æ‚åº¦ | ç©ºé—´å¤æ‚åº¦ | ç‰¹ç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------------|------------|------|----------|
| ACè‡ªåŠ¨æœº | O(n + m + z) | O(m) | ä¸€æ¬¡æ‰«æåŒ¹é…å¤šä¸ªæ¨¡å¼ä¸² | å¤šæ¨¡å¼åŒ¹é…ã€æ•æ„Ÿè¯è¿‡æ»¤ |
| KMPç®—æ³• | O(n + m) | O(m) | å•æ¨¡å¼ä¸²æœ€ä¼˜ç®—æ³• | å•æ¨¡å¼åŒ¹é…ã€æ–‡æœ¬ç¼–è¾‘å™¨ |
| Trieæ ‘ | O(n + m) | O(m) | å‰ç¼€åŒ¹é…æ•ˆç‡é«˜ | å­—å…¸æŸ¥è¯¢ã€è‡ªåŠ¨è¡¥å…¨ |
| æš´åŠ›åŒ¹é… | O(n*m) | O(1) | å®ç°ç®€å•ï¼Œæ•ˆç‡ä½ | å°è§„æ¨¡æ–‡æœ¬åŒ¹é… |
| Rabin-Karp | O(n + m) | O(m) | å“ˆå¸ŒåŒ¹é…ï¼Œæ˜“å†²çª | å¤šæ¨¡å¼åŒ¹é…ã€ plagiarismæ£€æµ‹ |
| Boyer-Moore | O(n/m) | O(m) | å®é™…åº”ç”¨ä¸­æœ€å¿« | å•æ¨¡å¼åŒ¹é…ã€æ–‡æœ¬æœç´¢ |

> æ³¨ï¼šnä¸ºæ–‡æœ¬é•¿åº¦ï¼Œmä¸ºæ‰€æœ‰æ¨¡å¼ä¸²æ€»é•¿åº¦ï¼Œzä¸ºåŒ¹é…æ¬¡æ•°

---

## ğŸ¯ ç®—æ³•åŸç†

### åŸºæœ¬ç»“æ„
ACè‡ªåŠ¨æœºçš„æ ¸å¿ƒç»“æ„åŒ…æ‹¬ï¼š
- **Trieæ ‘èŠ‚ç‚¹**ï¼šæ¯ä¸ªèŠ‚ç‚¹åŒ…å«å­—ç¬¦ã€å­èŠ‚ç‚¹æŒ‡é’ˆã€å¤±æ•ˆé“¾æ¥ã€è¾“å‡ºé“¾æ¥å’Œæ¨¡å¼ä¸²æ ‡è®°
- **æ ¹èŠ‚ç‚¹**ï¼šTrieæ ‘çš„èµ·å§‹èŠ‚ç‚¹ï¼Œä¸åŒ…å«å­—ç¬¦
- **å¤±æ•ˆé“¾æ¥**ï¼šå½“å½“å‰è·¯å¾„åŒ¹é…å¤±è´¥æ—¶ï¼Œè·³è½¬åˆ°å…·æœ‰æœ€é•¿å…¬å…±åç¼€çš„å…¶ä»–è·¯å¾„
- **è¾“å‡ºé“¾æ¥**ï¼šå½“åˆ°è¾¾æŸä¸ªèŠ‚ç‚¹æ—¶ï¼Œé€šè¿‡è¾“å‡ºé“¾æ¥å¯ä»¥è·å–æ‰€æœ‰ä»¥è¯¥èŠ‚ç‚¹ä¸ºç»“å°¾çš„æ¨¡å¼ä¸²

### æ„å»ºæ­¥éª¤
1. **Trieæ ‘æ„å»º**ï¼š
   - å°†æ‰€æœ‰æ¨¡å¼ä¸²æ’å…¥Trieæ ‘
   - æ¯ä¸ªèŠ‚ç‚¹è®°å½•ä»æ ¹åˆ°è¯¥èŠ‚ç‚¹çš„è·¯å¾„æ‰€ä»£è¡¨çš„å‰ç¼€
   - æ ‡è®°æ¨¡å¼ä¸²çš„ç»“æŸèŠ‚ç‚¹

2. **å¤±æ•ˆé“¾æ¥æ„å»ºï¼ˆBFSéå†ï¼‰**ï¼š
   - æ ¹èŠ‚ç‚¹çš„å¤±æ•ˆé“¾æ¥ä¸ºNone
   - æ ¹èŠ‚ç‚¹çš„ç›´æ¥å­èŠ‚ç‚¹çš„å¤±æ•ˆé“¾æ¥æŒ‡å‘æ ¹èŠ‚ç‚¹
   - å¯¹å…¶ä»–èŠ‚ç‚¹ï¼Œè®¾å½“å‰èŠ‚ç‚¹ä¸ºcurrï¼Œå…¶çˆ¶èŠ‚ç‚¹ä¸ºparentï¼Œå­—ç¬¦ä¸ºcï¼š
     a. æ²¿ç€parentçš„å¤±æ•ˆé“¾æ¥æŸ¥æ‰¾æ˜¯å¦æœ‰å­èŠ‚ç‚¹åŒ…å«å­—ç¬¦c
     b. å¦‚æœ‰ï¼Œåˆ™currçš„å¤±æ•ˆé“¾æ¥æŒ‡å‘è¯¥å­èŠ‚ç‚¹
     c. å¦‚æ— ï¼Œç»§ç»­æ²¿å¤±æ•ˆé“¾æ¥å‘ä¸ŠæŸ¥æ‰¾ï¼Œç›´åˆ°æ ¹èŠ‚ç‚¹
     d. å¦‚æœ€ç»ˆæœªæ‰¾åˆ°ï¼Œåˆ™currçš„å¤±æ•ˆé“¾æ¥æŒ‡å‘æ ¹èŠ‚ç‚¹

3. **è¾“å‡ºé“¾æ¥æ„å»º**ï¼š
   - è¾“å‡ºé“¾æ¥æŒ‡å‘å…·æœ‰æ›´é•¿æˆ–å…¶ä»–æ¨¡å¼ä¸²çš„èŠ‚ç‚¹
   - å¯¹äºæ¯ä¸ªèŠ‚ç‚¹ï¼Œå…¶è¾“å‡ºé“¾æ¥æŒ‡å‘å…¶å¤±æ•ˆé“¾æ¥èŠ‚ç‚¹çš„è¾“å‡ºé“¾æ¥ï¼Œå½¢æˆè¾“å‡ºé“¾
   - å½“åˆ°è¾¾ä¸€ä¸ªèŠ‚ç‚¹æ—¶ï¼Œéœ€éå†å…¶è¾“å‡ºé“¾ä»¥è·å–æ‰€æœ‰åŒ¹é…çš„æ¨¡å¼ä¸²

### åŒ¹é…è¿‡ç¨‹
1. ä»æ ¹èŠ‚ç‚¹å¼€å§‹ï¼Œå½“å‰èŠ‚ç‚¹åˆå§‹åŒ–ä¸ºæ ¹èŠ‚ç‚¹
2. é€ä¸ªå­—ç¬¦æ‰«ææ–‡æœ¬ï¼š
   a. å¦‚æœå½“å‰èŠ‚ç‚¹æœ‰å¯¹åº”å­—ç¬¦çš„å­èŠ‚ç‚¹ï¼Œåˆ™ç§»åŠ¨åˆ°è¯¥å­èŠ‚ç‚¹
   b. å¦‚æœæ²¡æœ‰ï¼Œåˆ™æ²¿ç€å¤±æ•ˆé“¾æ¥è·³è½¬ï¼Œç›´åˆ°æ‰¾åˆ°å¯¹åº”å­èŠ‚ç‚¹æˆ–åˆ°è¾¾æ ¹èŠ‚ç‚¹
   c. å¦‚æœåˆ°è¾¾æ ¹èŠ‚ç‚¹ä»æ— å¯¹åº”å­èŠ‚ç‚¹ï¼Œåˆ™ç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ªå­—ç¬¦
3. åœ¨æ¯ä¸ªèŠ‚ç‚¹ï¼Œéå†å…¶è¾“å‡ºé“¾ï¼Œæ”¶é›†æ‰€æœ‰åŒ¹é…çš„æ¨¡å¼ä¸²
4. ç»§ç»­å¤„ç†æ–‡æœ¬ç›´åˆ°ç»“æŸ

### å›¾è§£è¯´æ˜
```
æ¨¡å¼ä¸²é›†åˆï¼š["abc", "abd", "bcd", "xyz"]

Trieæ ‘ç»“æ„ï¼š
æ ¹
â”œâ”€ a
â”‚  â””â”€ b
â”‚     â”œâ”€ c (æ¨¡å¼ä¸²ç»“æŸ)
â”‚     â””â”€ d (æ¨¡å¼ä¸²ç»“æŸ)
â””â”€ b
   â””â”€ c
      â””â”€ d (æ¨¡å¼ä¸²ç»“æŸ)

å¤±æ•ˆé“¾æ¥æ„å»ºï¼š
- aèŠ‚ç‚¹çš„å¤±æ•ˆé“¾æ¥ â†’ æ ¹
- bèŠ‚ç‚¹(æ ¹çš„å­èŠ‚ç‚¹)çš„å¤±æ•ˆé“¾æ¥ â†’ æ ¹
- abèŠ‚ç‚¹çš„å¤±æ•ˆé“¾æ¥ â†’ æ ¹ï¼ˆå› ä¸ºaçš„å¤±æ•ˆé“¾æ¥æ˜¯æ ¹ï¼Œæ ¹æ²¡æœ‰bå­èŠ‚ç‚¹ï¼‰
- abcèŠ‚ç‚¹çš„å¤±æ•ˆé“¾æ¥ï¼š
  parent(ab)çš„å¤±æ•ˆé“¾æ¥æ˜¯æ ¹ï¼Œæ ¹æ²¡æœ‰cå­èŠ‚ç‚¹ â†’ abcçš„å¤±æ•ˆé“¾æ¥æŒ‡å‘æ ¹
- abdèŠ‚ç‚¹çš„å¤±æ•ˆé“¾æ¥ï¼š
  parent(ab)çš„å¤±æ•ˆé“¾æ¥æ˜¯æ ¹ï¼Œæ ¹æ²¡æœ‰då­èŠ‚ç‚¹ â†’ abdçš„å¤±æ•ˆé“¾æ¥æŒ‡å‘æ ¹
- bcèŠ‚ç‚¹çš„å¤±æ•ˆé“¾æ¥ï¼š
  parent(b)çš„å¤±æ•ˆé“¾æ¥æ˜¯æ ¹ï¼Œæ ¹æœ‰cå­èŠ‚ç‚¹å—ï¼Ÿæ²¡æœ‰ â†’ bcçš„å¤±æ•ˆé“¾æ¥æŒ‡å‘æ ¹
- bcdèŠ‚ç‚¹çš„å¤±æ•ˆé“¾æ¥ï¼š
  parent(bc)çš„å¤±æ•ˆé“¾æ¥æ˜¯æ ¹ï¼Œæ ¹æ²¡æœ‰då­èŠ‚ç‚¹ â†’ bcdçš„å¤±æ•ˆé“¾æ¥æŒ‡å‘æ ¹

æ–‡æœ¬åŒ¹é…ç¤ºä¾‹ï¼š"abcxyz"
- a â†’ ab â†’ abcï¼šåŒ¹é…"abc"
- ç»§ç»­æ‰«æxï¼šå½“å‰èŠ‚ç‚¹abcæ²¡æœ‰xå­èŠ‚ç‚¹ï¼Œæ²¿å¤±æ•ˆé“¾æ¥åˆ°æ ¹
- æ ¹æœ‰xå­èŠ‚ç‚¹å—ï¼Ÿæœ‰ â†’ ç§»åŠ¨åˆ°xèŠ‚ç‚¹
- x â†’ xy â†’ xyzï¼šåŒ¹é…"xyz"

æœ€ç»ˆåŒ¹é…ç»“æœï¼š["abc", "xyz"]
```

---

## ğŸ’» ä»£ç å®ç°

### åŸºæœ¬å®ç°ï¼ˆACè‡ªåŠ¨æœºæ ¸å¿ƒï¼‰
```python
class ACNode:
    def __init__(self, char):
        self.char = char  # å½“å‰èŠ‚ç‚¹å­˜å‚¨çš„å­—ç¬¦
        self.children = {}  # å­èŠ‚ç‚¹å­—å…¸ï¼Œé”®ä¸ºå­—ç¬¦ï¼Œå€¼ä¸ºèŠ‚ç‚¹
        self.fail = None  # å¤±æ•ˆé“¾æ¥
        self.output = []  # è¾“å‡ºé“¾æ¥ï¼Œå­˜å‚¨åŒ¹é…çš„æ¨¡å¼ä¸²
        self.is_end = False  # æ˜¯å¦ä¸ºæ¨¡å¼ä¸²çš„ç»“æŸèŠ‚ç‚¹
        self.pattern = None  # å­˜å‚¨å®Œæ•´æ¨¡å¼ä¸²ï¼ˆä»…åœ¨is_endä¸ºTrueæ—¶æœ‰æ•ˆï¼‰


class AhoCorasick:
    def __init__(self):
        self.root = ACNode(None)
        self.root.fail = None
        self.queue = []  # BFSé˜Ÿåˆ—ï¼Œç”¨äºæ„å»ºå¤±æ•ˆé“¾æ¥

    def add_pattern(self, pattern):
        """æ·»åŠ æ¨¡å¼ä¸²åˆ°Trieæ ‘"""
        node = self.root
        for char in pattern:
            if char not in node.children:
                node.children[char] = ACNode(char)
            node = node.children[char]
        node.is_end = True
        node.pattern = pattern
        node.output.append(pattern)  # å°†æ¨¡å¼ä¸²æ·»åŠ åˆ°è¾“å‡ºåˆ—è¡¨

    def build_automaton(self):
        """æ„å»ºACè‡ªåŠ¨æœºçš„å¤±æ•ˆé“¾æ¥å’Œè¾“å‡ºé“¾æ¥"""
        # æ ¹èŠ‚ç‚¹çš„å¤±æ•ˆé“¾æ¥ä¸ºNone
        self.root.fail = None
        # å°†æ ¹èŠ‚ç‚¹çš„æ‰€æœ‰å­èŠ‚ç‚¹åŠ å…¥é˜Ÿåˆ—
        for child in self.root.children.values():
            child.fail = self.root
            self.queue.append(child)

        # BFSæ„å»ºå¤±æ•ˆé“¾æ¥
        while self.queue:
            current_node = self.queue.pop(0)  # å‡ºé˜Ÿ

            # å¤„ç†å½“å‰èŠ‚ç‚¹çš„æ¯ä¸ªå­èŠ‚ç‚¹
            for char, child in current_node.children.items():
                # æ‰¾åˆ°å¤±æ•ˆé“¾æ¥çš„èµ·å§‹èŠ‚ç‚¹
                fail_node = current_node.fail

                # æ²¿ç€å¤±æ•ˆé“¾æ¥æŸ¥æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°æœ‰è¯¥å­—ç¬¦å­èŠ‚ç‚¹çš„èŠ‚ç‚¹æˆ–åˆ°è¾¾æ ¹èŠ‚ç‚¹
                while fail_node is not None and char not in fail_node.children:
                    fail_node = fail_node.fail

                # è®¾ç½®å­èŠ‚ç‚¹çš„å¤±æ•ˆé“¾æ¥
                child.fail = fail_node.children[char] if (fail_node and char in fail_node.children) else self.root

                # åˆå¹¶è¾“å‡ºé“¾æ¥
                child.output += child.fail.output

                # å°†å­èŠ‚ç‚¹åŠ å…¥é˜Ÿåˆ—
                self.queue.append(child)

    def search(self, text):
        """åœ¨æ–‡æœ¬ä¸­æœç´¢æ‰€æœ‰æ¨¡å¼ä¸²ï¼Œè¿”å›åŒ¹é…ç»“æœåˆ—è¡¨"""
        result = []
        current = self.root

        for i, char in enumerate(text):
            # æ²¿ç€å¤±æ•ˆé“¾æ¥æŸ¥æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°åŒ…å«å½“å‰å­—ç¬¦çš„å­èŠ‚ç‚¹æˆ–åˆ°è¾¾æ ¹èŠ‚ç‚¹
            while current is not None and char not in current.children:
                current = current.fail

            # å¦‚æœåˆ°è¾¾æ ¹èŠ‚ç‚¹ä¸”æ²¡æœ‰å¯¹åº”å­èŠ‚ç‚¹ï¼Œåˆ™ç»§ç»­
            if current is None:
                current = self.root

            # å¦‚æœæ‰¾åˆ°å¯¹åº”å­èŠ‚ç‚¹ï¼Œåˆ™ç§»åŠ¨åˆ°è¯¥å­èŠ‚ç‚¹
            if char in current.children:
                current = current.children[char]
            else:
                # æ ¹èŠ‚ç‚¹ä¹Ÿæ²¡æœ‰å¯¹åº”å­èŠ‚ç‚¹ï¼Œç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ªå­—ç¬¦
                continue

            # æ”¶é›†æ‰€æœ‰åŒ¹é…çš„æ¨¡å¼ä¸²
            if current.output:
                for pattern in current.output:
                    start = i - len(pattern) + 1
                    result.append({
                        'pattern': pattern,
                        'start': start,
                        'end': i
                    })

        return result


# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    # åˆ›å»ºACè‡ªåŠ¨æœºå®ä¾‹
    ac = AhoCorasick()

    # æ·»åŠ æ¨¡å¼ä¸²
    patterns = ["abc", "abd", "bcd", "xyz"]
    for pattern in patterns:
        ac.add_pattern(pattern)

    # æ„å»ºè‡ªåŠ¨æœº
    ac.build_automaton()

    # æœç´¢æ–‡æœ¬
    text = "abcxyzabd"
    matches = ac.search(text)

    # è¾“å‡ºç»“æœ
    print(f"æ–‡æœ¬: {text}")
    print("åŒ¹é…ç»“æœ:")
    for match in matches:
        print(f"- æ¨¡å¼ä¸²: '{match['pattern']}', ä½ç½®: {match['start']}-{match['end']}")
```

### ä¼˜åŒ–å®ç°ï¼ˆå†…å­˜ä¸æ€§èƒ½ä¼˜åŒ–ï¼‰
```python
class OptimizedACNode:
    __slots__ = ['char', 'children', 'fail', 'output', 'is_end', 'pattern']
    def __init__(self, char):
        self.char = char
        self.children = {}  # ä½¿ç”¨å­—å…¸å­˜å‚¨å­èŠ‚ç‚¹ï¼Œç©ºé—´æ•ˆç‡æ›´é«˜
        self.fail = None
        self.output = []
        self.is_end = False
        self.pattern = None


class OptimizedAhoCorasick:
    def __init__(self, case_sensitive=True):
        self.root = OptimizedACNode(None)
        self.queue = []
        self.case_sensitive = case_sensitive
        self.pattern_count = 0
        self.nodes_count = 1  # æ ¹èŠ‚ç‚¹ç®—ä¸€ä¸ª

    def add_pattern(self, pattern):
        if not pattern:
            return
        if not self.case_sensitive:
            pattern = pattern.lower()
        node = self.root
        for char in pattern:
            if char not in node.children:
                node.children[char] = OptimizedACNode(char)
                self.nodes_count += 1
            node = node.children[char]
        if not node.is_end:
            node.is_end = True
            node.pattern = pattern
            node.output.append(pattern)
            self.pattern_count += 1

    def build_automaton(self):
        # ä½¿ç”¨dequeä¼˜åŒ–BFSæ€§èƒ½
        from collections import deque
        self.queue = deque()

        self.root.fail = None
        for child in self.root.children.values():
            child.fail = self.root
            self.queue.append(child)

        while self.queue:
            current_node = self.queue.popleft()

            # å¯¹å­èŠ‚ç‚¹è¿›è¡Œæ‰¹é‡å¤„ç†
            for char, child in current_node.children.items():
                fail_node = current_node.fail

                # ä¼˜åŒ–å¤±æ•ˆé“¾æ¥æŸ¥æ‰¾
                while fail_node and char not in fail_node.children:
                    fail_node = fail_node.fail

                child.fail = fail_node.children[char] if (fail_node and char in fail_node.children) else self.root

                # ä¼˜åŒ–è¾“å‡ºé“¾æ¥åˆå¹¶
                if child.fail.output:
                    child.output.extend(child.fail.output)

                self.queue.append(child)

    def search(self, text, return_overlaps=True):
        result = []
        current = self.root
        if not self.case_sensitive:
            text = text.lower()

        for i, char in enumerate(text):
            # ä¼˜åŒ–å¤±æ•ˆé“¾æ¥è·³è½¬
            while current and char not in current.children:
                current = current.fail

            if not current:
                current = self.root

            if char in current.children:
                current = current.children[char]
            else:
                continue

            # æ”¶é›†åŒ¹é…ç»“æœ
            if current.output:
                for pattern in current.output:
                    start = i - len(pattern) + 1
                    # å¤„ç†éé‡å åŒ¹é…
                    if not return_overlaps and result:
                        last_end = result[-1]['end']
                        if start <= last_end:
                            continue
                    result.append({
                        'pattern': pattern,
                        'start': start,
                        'end': i,
                        'text': text[start:i+1]
                    })

        return result

    def stats(self):
        """è¿”å›ACè‡ªåŠ¨æœºçš„ç»Ÿè®¡ä¿¡æ¯"""
        return {
            'pattern_count': self.pattern_count,
            'node_count': self.nodes_count,
            'memory_usage': self.nodes_count * (32 + 24 + 8 + 16)  # ä¼°ç®—å†…å­˜ä½¿ç”¨
        }
```

### åº”ç”¨å®ç°ï¼ˆæ•æ„Ÿè¯è¿‡æ»¤ç³»ç»Ÿï¼‰
```python
class SensitiveWordFilter:
    def __init__(self, case_sensitive=False, replace_char='*'):
        self.ac = OptimizedAhoCorasick(case_sensitive=case_sensitive)
        self.replace_char = replace_char
        self.sensitive_words = set()

    def load_words(self, words):
        """åŠ è½½æ•æ„Ÿè¯åˆ—è¡¨"""
        for word in words:
            if word and word not in self.sensitive_words:
                self.ac.add_pattern(word)
                self.sensitive_words.add(word)
        self.ac.build_automaton()

    def load_from_file(self, file_path):
        """ä»æ–‡ä»¶åŠ è½½æ•æ„Ÿè¯"""
        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                words = [line.strip() for line in f if line.strip()]
                self.load_words(words)
            return True
        except Exception as e:
            print(f"åŠ è½½æ•æ„Ÿè¯æ–‡ä»¶å¤±è´¥: {e}")
            return False

    def filter(self, text, replace_char=None):
        """è¿‡æ»¤æ–‡æœ¬ä¸­çš„æ•æ„Ÿè¯ï¼Œæ›¿æ¢ä¸ºæŒ‡å®šå­—ç¬¦"""
        if not text:
            return text

        replace_char = replace_char or self.replace_char
        matches = self.ac.search(text, return_overlaps=False)

        # å°†æ–‡æœ¬è½¬æ¢ä¸ºåˆ—è¡¨ï¼Œä¾¿äºä¿®æ”¹
        text_list = list(text)

        # æ›¿æ¢æ•æ„Ÿè¯
        for match in matches:
            start = match['start']
            end = match['end']
            for i in range(start, end + 1):
                text_list[i] = replace_char

        return ''.join(text_list)

    def detect(self, text):
        """æ£€æµ‹æ–‡æœ¬ä¸­çš„æ•æ„Ÿè¯ï¼Œè¿”å›æ£€æµ‹ç»“æœ"""
        if not text:
            return []
        return self.ac.search(text)

    def count(self, text):
        """ç»Ÿè®¡æ–‡æœ¬ä¸­æ•æ„Ÿè¯å‡ºç°æ¬¡æ•°"""
        matches = self.ac.search(text)
        from collections import defaultdict
        counter = defaultdict(int)
        for match in matches:
            counter[match['pattern']] += 1
        return dict(counter)


# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    # åˆ›å»ºæ•æ„Ÿè¯è¿‡æ»¤å™¨
    filter = SensitiveWordFilter()

    # åŠ è½½æ•æ„Ÿè¯
    sensitive_words = ["æš´åŠ›", "ææ€–", "è‰²æƒ…", "èµŒåš", "æ¯’å“"]
    filter.load_words(sensitive_words)

    # æµ‹è¯•æ–‡æœ¬è¿‡æ»¤
    test_text = "è¿™æ˜¯ä¸€æ®µåŒ…å«æš´åŠ›å’Œè‰²æƒ…å†…å®¹çš„æ–‡æœ¬ï¼Œè¿˜æœ‰èµŒåšç›¸å…³ä¿¡æ¯"
    filtered_text = filter.filter(test_text)
    print(f"åŸå§‹æ–‡æœ¬: {test_text}")
    print(f"è¿‡æ»¤å: {filtered_text}")

    # æµ‹è¯•æ•æ„Ÿè¯æ£€æµ‹
    detection_result = filter.detect(test_text)
    print("æ£€æµ‹ç»“æœ:")
    for item in detection_result:
        print(f"- æ•æ„Ÿè¯: '{item['pattern']}', ä½ç½®: {item['start']}-{item['end']}")

    # æµ‹è¯•æ•æ„Ÿè¯è®¡æ•°
    count_result = filter.count(test_text)
    print("æ•æ„Ÿè¯è®¡æ•°:", count_result)
```

---

## ğŸ“Š å¤æ‚åº¦åˆ†æ

### æ—¶é—´å¤æ‚åº¦
| æ“ä½œ | æ—¶é—´å¤æ‚åº¦ | è¯´æ˜ |
|------|------------|------|
| æ¨¡å¼ä¸²æ’å…¥ | O(m) | mä¸ºæ‰€æœ‰æ¨¡å¼ä¸²æ€»é•¿åº¦ |
| è‡ªåŠ¨æœºæ„å»º | O(m) | ä¸æ¨¡å¼ä¸²æ€»é•¿åº¦çº¿æ€§ç›¸å…³ |
| æ–‡æœ¬åŒ¹é… | O(n + z) | nä¸ºæ–‡æœ¬é•¿åº¦ï¼Œzä¸ºåŒ¹é…æ¬¡æ•° |
| å•æ¬¡æŸ¥è¯¢ | O(L) | Lä¸ºæŸ¥è¯¢æ–‡æœ¬é•¿åº¦ |
| æ•´ä½“å¤æ‚åº¦ | O(n + m + z) | æœ€ä¼˜å¤šæ¨¡å¼åŒ¹é…ç®—æ³•ä¹‹ä¸€ |

### ç©ºé—´å¤æ‚åº¦
- **ç©ºé—´å¤æ‚åº¦**: O(mÃ—k)ï¼Œå…¶ä¸­mä¸ºæ¨¡å¼ä¸²æ€»é•¿åº¦ï¼Œkä¸ºå­—ç¬¦é›†å¤§å°
- **æœ€åæƒ…å†µ**: O(mÂ²)ï¼Œå½“æ¨¡å¼ä¸²å…·æœ‰å¾ˆå°‘çš„å…¬å…±å‰ç¼€æ—¶
- **ä¼˜åŒ–ç­–ç•¥**: ä½¿ç”¨å‹ç¼©å­—å…¸æ ‘å¯å°†ç©ºé—´å¤æ‚åº¦é™è‡³O(m log k)
- **å†…å­˜å ç”¨**: æ¯ä¸ªèŠ‚ç‚¹çº¦å ç”¨40-60å­—èŠ‚å†…å­˜ï¼ˆå–å†³äºå®ç°ï¼‰

### æ€§èƒ½å¯¹æ¯”
| æŒ‡æ ‡ | ACè‡ªåŠ¨æœº | Trieæ ‘ | KMPç®—æ³• | æš´åŠ›åŒ¹é… |
|------|----------|--------|---------|----------|
| é¢„å¤„ç†æ—¶é—´ | O(m) | O(m) | O(m) | O(1) |
| åŒ¹é…æ—¶é—´(æœ€ä½³) | O(n) | O(n) | O(n) | O(n) |
| åŒ¹é…æ—¶é—´(æœ€å·®) | O(n) | O(n) | O(n) | O(nÃ—m) |
| å†…å­˜ä½¿ç”¨ | ä¸­ | é«˜ | ä½ | æä½ |
| å¤šæ¨¡å¼æ”¯æŒ | ä¼˜ | ä¸­ | å·® | å·® |
| å®ç°å¤æ‚åº¦ | é«˜ | ä¸­ | ä¸­ | ä½ |

> æ³¨ï¼šæµ‹è¯•ç¯å¢ƒä¸ºPython 3.9ï¼Œæ–‡æœ¬é•¿åº¦10000å­—ç¬¦ï¼Œæ¨¡å¼ä¸²100ä¸ª

---

## ğŸ” åº”ç”¨åœºæ™¯

1. **æ•æ„Ÿè¯è¿‡æ»¤ç³»ç»Ÿ**ï¼šç¤¾äº¤å¹³å°ã€å†…å®¹å®¡æ ¸å’Œè¯„è®ºè¿‡æ»¤ï¼Œå¦‚å¾®åšã€æŠ–éŸ³çš„å†…å®¹å®‰å…¨æœºåˆ¶
2. **æ—¥å¿—åˆ†æå·¥å…·**ï¼šåœ¨å¤§é‡æ—¥å¿—ä¸­å¿«é€Ÿå®šä½é”™è¯¯ç ã€IPåœ°å€å’Œå…³é”®è¯
3. **æœç´¢å¼•æ“**ï¼šå…³é”®è¯åŒ¹é…å’Œç›¸å…³æ¨èåŠŸèƒ½çš„åº•å±‚å®ç°
4. **åç—…æ¯’è½¯ä»¶**ï¼šç—…æ¯’ç‰¹å¾ç åŒ¹é…å’Œæ¶æ„ä»£ç æ£€æµ‹
5. **è‡ªç„¶è¯­è¨€å¤„ç†**ï¼šåˆ†è¯ã€å‘½åå®ä½“è¯†åˆ«å’Œå…³é”®è¯æå–
6. **ç”Ÿç‰©ä¿¡æ¯å­¦**ï¼šDNAåºåˆ—åˆ†æï¼ŒåŒæ—¶æŸ¥æ‰¾å¤šä¸ªåŸºå› åºåˆ—ç‰‡æ®µ
7. **ç½‘ç»œå®‰å…¨**ï¼šå…¥ä¾µæ£€æµ‹ç³»ç»Ÿï¼Œå®æ—¶ç›‘æ§ç½‘ç»œæµé‡ä¸­çš„æ”»å‡»ç‰¹å¾
8. **ä»£ç é™æ€åˆ†æ**ï¼šæ£€æµ‹ä»£ç ä¸­çš„å®‰å…¨æ¼æ´å’Œæ•æ„Ÿå‡½æ•°è°ƒç”¨
9. **æ–‡æœ¬ç¼–è¾‘å™¨**ï¼šå¤šå…³é”®è¯é«˜äº®å’Œæ‰¹é‡æ›¿æ¢åŠŸèƒ½
10. **æ™ºèƒ½è¾“å…¥æ³•**ï¼šè”æƒ³è¯æ¨èå’Œé”™è¯¯æ‹¼å†™çº æ­£

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å­—ç¬¦é›†å¤„ç†**ï¼š
   - å¯¹äºä¸­æ–‡ç­‰å®½å­—ç¬¦é›†ï¼Œéœ€ç‰¹åˆ«å¤„ç†ç¼–ç é—®é¢˜
   - Unicodeå­—ç¬¦å¯èƒ½å¢åŠ å†…å­˜å ç”¨ï¼Œå¯è€ƒè™‘ä½¿ç”¨å­—ç¬¦æ˜ å°„
   - å¤§å°å†™æ•æ„Ÿè®¾ç½®éœ€æ ¹æ®åº”ç”¨åœºæ™¯ç¡®å®š

2. **æ¨¡å¼ä¸²é€‰æ‹©**ï¼š
   - é¿å…æ·»åŠ è¿‡çŸ­çš„æ¨¡å¼ä¸²ï¼ˆå¦‚å•å­—ç¬¦ï¼‰ï¼Œä¼šæ˜¾è‘—é™ä½æ€§èƒ½
   - ç§»é™¤åŒ…å«å…³ç³»çš„æ¨¡å¼ä¸²ï¼ˆå¦‚å·²æ·»åŠ "ä¸­å›½"åˆ™æ— éœ€æ·»åŠ "ä¸­å›½äººæ°‘"ï¼‰
   - æ¨¡å¼ä¸²é›†åˆè¿‡å¤§æ—¶ï¼ˆ>10ä¸‡ï¼‰éœ€è€ƒè™‘åˆ†å—å¤„ç†

3. **æ€§èƒ½ä¼˜åŒ–**ï¼š
   - å¤§é‡æ¨¡å¼ä¸²æ—¶ï¼Œå†…å­˜å ç”¨å¯èƒ½è¿‡é«˜ï¼Œéœ€ä½¿ç”¨å‹ç¼©æŠ€æœ¯
   - å¯¹äºè¶…é•¿æ–‡æœ¬ï¼Œè€ƒè™‘æµå¼å¤„ç†è€Œéä¸€æ¬¡æ€§åŠ è½½
   - éé‡å åŒ¹é…å¯æ˜¾è‘—æé«˜å¤„ç†é€Ÿåº¦

4. **å®ç°ç»†èŠ‚**ï¼š
   - å¤±æ•ˆé“¾æ¥æ„å»ºå¿…é¡»ä½¿ç”¨BFSï¼Œé¿å…é€’å½’æ·±åº¦é—®é¢˜
   - æ ¹èŠ‚ç‚¹çš„å¤±æ•ˆé“¾æ¥å¿…é¡»è®¾ä¸ºNoneæˆ–è‡ªèº«
   - è¾“å‡ºé“¾æ¥éœ€æ­£ç¡®åˆå¹¶ï¼Œé¿å…é—æ¼åŒ¹é…ç»“æœ

5. **é”™è¯¯å¤„ç†**ï¼š
   - ç©ºæ¨¡å¼ä¸²ä¼šå¯¼è‡´åŒ¹é…é”™è¯¯ï¼Œéœ€è¿‡æ»¤ç©ºå­—ç¬¦ä¸²
   - å¾ªç¯å¤±æ•ˆé“¾æ¥å¯èƒ½å¯¼è‡´æ­»å¾ªç¯ï¼Œéœ€ç¡®ä¿é“¾æ¥æ­£ç¡®
   - æ–‡æœ¬ä¸ºç©ºæ—¶åº”ç›´æ¥è¿”å›ç©ºç»“æœ

---

## ğŸ“ æœ€ä½³å®è·µ

1. **å®ç°ä¼˜åŒ–**ï¼š
   - ä½¿ç”¨æ•°ç»„è€Œéå­—å…¸å­˜å‚¨å­èŠ‚ç‚¹ï¼Œæé«˜è®¿é—®é€Ÿåº¦
   - å¯¹å­—ç¬¦è¿›è¡Œæ˜ å°„ï¼Œå‡å°‘å­˜å‚¨ç©ºé—´
   - ä½¿ç”¨BFSè€Œéé€’å½’æ„å»ºTrieæ ‘ï¼Œé¿å…æ ˆæº¢å‡º
   - åˆå¹¶ç›¸åŒå‰ç¼€çš„æ¨¡å¼ä¸²ï¼Œå‡å°‘èŠ‚ç‚¹æ•°é‡

2. **å†…å­˜ç®¡ç†**ï¼š
   - å¯¹å¤§è§„æ¨¡æ¨¡å¼ä¸²é›†åˆä½¿ç”¨ç£ç›˜å­˜å‚¨å’Œåˆ†é¡µåŠ è½½
   - å®ç°èŠ‚ç‚¹æ± æœºåˆ¶ï¼Œå‡å°‘å†…å­˜ç¢ç‰‡
   - ä½¿ç”¨ä½è¿ç®—ä¼˜åŒ–æ ‡å¿—ä½å­˜å‚¨

3. **æ€§èƒ½è°ƒä¼˜**ï¼š
   - å¯¹å¸¸ç”¨æ¨¡å¼ä¸²è®¾ç½®ä¼˜å…ˆçº§ï¼Œä¼˜å…ˆåŒ¹é…
   - å®ç°å¹¶è¡Œæ„å»ºå’ŒåŒ¹é…ï¼Œåˆ©ç”¨å¤šæ ¸ä¼˜åŠ¿
   - å¯¹åŒ¹é…ç»“æœè¿›è¡Œç¼“å­˜ï¼Œé¿å…é‡å¤è®¡ç®—

4. **åº”ç”¨ç­–ç•¥**ï¼š
   - æ•æ„Ÿè¯è¿‡æ»¤ï¼šä½¿ç”¨éé‡å åŒ¹é…æé«˜æ•ˆç‡
   - æ—¥å¿—åˆ†æï¼šç»“åˆæ­£åˆ™è¡¨è¾¾å¼ä½¿ç”¨
   - å®æ—¶ç³»ç»Ÿï¼šé‡‡ç”¨å¢é‡æ›´æ–°æœºåˆ¶ï¼Œé¿å…é‡å»ºè‡ªåŠ¨æœº

5. **æµ‹è¯•éªŒè¯**ï¼š
   - ä½¿ç”¨åŒ…å«å„ç§è¾¹ç•Œæƒ…å†µçš„æµ‹è¯•é›†
   - æµ‹è¯•æç«¯æƒ…å†µï¼šè¶…é•¿æ–‡æœ¬ã€å¤§é‡æ¨¡å¼ä¸²ã€ç‰¹æ®Šå­—ç¬¦
   - è¿›è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•ï¼Œç›‘æ§å†…å­˜å’ŒCPUä½¿ç”¨

---

## ğŸ“š æ‰©å±•é˜…è¯»
- [Aho-Corasickç®—æ³•åŸå§‹è®ºæ–‡](https://dl.acm.org/doi/pdf/10.1145/360825.360855)
- ã€Šç®—æ³•å¯¼è®ºã€‹ç¬¬32ç« ï¼šå­—ç¬¦ä¸²åŒ¹é…
- ã€Šç¼–è¯‘åŸç†ã€‹ï¼šè¯æ³•åˆ†æç« èŠ‚
- [ACè‡ªåŠ¨æœºè¯¦è§£](https://www.geeksforgeeks.org/aho-corasick-algorithm-pattern-searching/)
- [ACè‡ªåŠ¨æœºå®ç°æŒ‡å—](https://cp-algorithms.com/string/aho_corasick.html)
- [å¤šæ¨¡å¼åŒ¹é…ç®—æ³•ç»¼è¿°](https://arxiv.org/pdf/1408.5146.pdf)
- [ACè‡ªåŠ¨æœºåœ¨æ•æ„Ÿè¯è¿‡æ»¤ä¸­çš„åº”ç”¨](https://www.jianshu.com/p/5995d9224e0f)