# å¸ƒéš†è¿‡æ»¤å™¨

> å¸ƒéš†è¿‡æ»¤å™¨ï¼ˆBloom Filterï¼‰æ˜¯ä¸€ç§ç©ºé—´é«˜æ•ˆçš„æ¦‚ç‡å‹æ•°æ®ç»“æ„ï¼Œç”±Burton Howard Bloomäº1970å¹´æå‡ºï¼Œç”¨äºå¿«é€Ÿåˆ¤æ–­ä¸€ä¸ªå…ƒç´ æ˜¯å¦å±äºæŸä¸ªé›†åˆã€‚å®ƒé€šè¿‡å¤šä¸ªå“ˆå¸Œå‡½æ•°å°†å…ƒç´ æ˜ å°„åˆ°ä½æ•°ç»„ä¸­ï¼Œå®ç°é«˜æ•ˆçš„æ’å…¥å’ŒæŸ¥è¯¢æ“ä½œã€‚è™½ç„¶å­˜åœ¨ä¸€å®šçš„è¯¯åˆ¤ç‡ï¼ˆFalse Positiveï¼‰ï¼Œä½†ç»ä¸ä¼šå‡ºç°æ¼åˆ¤ï¼ˆFalse Negativeï¼‰ï¼Œç‰¹åˆ«é€‚ç”¨äºéœ€è¦å¿«é€Ÿå»é‡å’Œå­˜åœ¨æ€§åˆ¤æ–­çš„åœºæ™¯ã€‚

---

## ğŸ“‹ åŸºæœ¬ä¿¡æ¯

| å±æ€§ | è¯´æ˜ |
|------|------|
| æ•°æ®ç»“æ„ç±»å‹ | æ¦‚ç‡å‹æ•°æ®ç»“æ„ |
| å­˜å‚¨ç»“æ„ | ä½æ•°ç»„ + å¤šä¸ªå“ˆå¸Œå‡½æ•° |
| æ ¸å¿ƒæ“ä½œ | æ·»åŠ å…ƒç´ ã€æŸ¥è¯¢å…ƒç´  |
| æ—¶é—´å¤æ‚åº¦ | æ·»åŠ : O(k), æŸ¥è¯¢: O(k) | kä¸ºå“ˆå¸Œå‡½æ•°æ•°é‡
| ç©ºé—´å¤æ‚åº¦ | O(m) | mä¸ºä½æ•°ç»„å¤§å°
| ç‰¹ç‚¹ | ç©ºé—´æ•ˆç‡é«˜ã€æŸ¥è¯¢é€Ÿåº¦å¿«ã€æœ‰ä¸€å®šè¯¯åˆ¤ç‡ã€ä¸æ”¯æŒåˆ é™¤ï¼ˆæ ‡å‡†å®ç°ï¼‰ |

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

1. **ç©ºé—´é«˜æ•ˆ**ï¼šä½¿ç”¨ä½æ•°ç»„å­˜å‚¨ï¼Œç©ºé—´åˆ©ç”¨ç‡æé«˜
2. **æŸ¥è¯¢å¿«é€Ÿ**ï¼šæŸ¥è¯¢æ—¶é—´ä¸å…ƒç´ æ•°é‡æ— å…³ï¼Œä»…ä¸å“ˆå¸Œå‡½æ•°æ•°é‡æœ‰å…³
3. **æ¦‚ç‡åˆ¤æ–­**ï¼šå¯èƒ½å­˜åœ¨è¯¯åˆ¤ï¼ˆå…ƒç´ ä¸å­˜åœ¨å´åˆ¤æ–­ä¸ºå­˜åœ¨ï¼‰ï¼Œä½†ç»ä¸ä¼šæ¼åˆ¤
4. **ä¸æ”¯æŒåˆ é™¤**ï¼šæ ‡å‡†å®ç°ä¸æ”¯æŒå…ƒç´ åˆ é™¤æ“ä½œï¼Œåˆ é™¤ä¼šå½±å“å…¶ä»–å…ƒç´ 
5. **å“ˆå¸Œä¾èµ–**ï¼šæ€§èƒ½é«˜åº¦ä¾èµ–å“ˆå¸Œå‡½æ•°çš„é€‰æ‹©å’Œæ•°é‡
6. **å‚æ•°å¯è°ƒ**ï¼šé€šè¿‡è°ƒæ•´ä½æ•°ç»„å¤§å°å’Œå“ˆå¸Œå‡½æ•°æ•°é‡æ§åˆ¶è¯¯åˆ¤ç‡
7. **æ’å…¥æœ‰åº**ï¼šå…ƒç´ æ’å…¥é¡ºåºä¸å½±å“æŸ¥è¯¢ç»“æœ
8. **æ‰©å±•æ€§å¼º**ï¼šå¯æ‰©å±•ä¸ºè®¡æ•°å¸ƒéš†è¿‡æ»¤å™¨æ”¯æŒåˆ é™¤æ“ä½œ

## ğŸ’» ä»£ç å®ç°

### æ ‡å‡†å¸ƒéš†è¿‡æ»¤å™¨
```java
import java.util.BitSet;
import java.util.HashSet;
import java.util.Random;
import java.util.Set;

public class BloomFilter<T> {
    private final BitSet bitset;        // ä½æ•°ç»„
    private final int bitSetSize;       // ä½æ•°ç»„å¤§å°
    private final int numHashFunctions; // å“ˆå¸Œå‡½æ•°æ•°é‡
    private final Random random;        // éšæœºæ•°ç”Ÿæˆå™¨
    private final int[] hashSeeds;      // å“ˆå¸Œå‡½æ•°ç§å­
    private int count = 0;              // æ·»åŠ çš„å…ƒç´ æ•°é‡

    /**
     * æ„é€ å¸ƒéš†è¿‡æ»¤å™¨
     * @param expectedElements é¢„æœŸå…ƒç´ æ•°é‡
     * @param falsePositiveRate æœŸæœ›è¯¯åˆ¤ç‡
     */
    public BloomFilter(int expectedElements, double falsePositiveRate) {
        // æ ¹æ®é¢„æœŸå…ƒç´ æ•°é‡å’Œè¯¯åˆ¤ç‡è®¡ç®—æœ€ä¼˜å‚æ•°
        bitSetSize = calculateBitSetSize(expectedElements, falsePositiveRate);
        numHashFunctions = calculateOptimalNumHashFunctions(expectedElements, bitSetSize);
        bitset = new BitSet(bitSetSize);
        random = new Random();
        hashSeeds = new int[numHashFunctions];

        // ç”Ÿæˆä¸åŒçš„å“ˆå¸Œç§å­
        Set<Integer> seeds = new HashSet<>();
        while (seeds.size() < numHashFunctions) {
            seeds.add(random.nextInt(Integer.MAX_VALUE));
        }
        seeds.toArray(hashSeeds);
    }

    /**
     * è®¡ç®—æœ€ä¼˜ä½æ•°ç»„å¤§å°
     * m = -n * ln(p) / (ln(2)^2)
     * m: ä½æ•°ç»„å¤§å°, n: é¢„æœŸå…ƒç´ æ•°é‡, p: è¯¯åˆ¤ç‡
     */
    private int calculateBitSetSize(int n, double p) {
        if (p <= 0 || p >= 1) {
            throw new IllegalArgumentException("è¯¯åˆ¤ç‡å¿…é¡»åœ¨(0, 1)èŒƒå›´å†…");
        }
        return (int) (-n * Math.log(p) / (Math.log(2) * Math.log(2)));
    }

    /**
     * è®¡ç®—æœ€ä¼˜å“ˆå¸Œå‡½æ•°æ•°é‡
     * k = m/n * ln(2)
     * k: å“ˆå¸Œå‡½æ•°æ•°é‡, m: ä½æ•°ç»„å¤§å°, n: é¢„æœŸå…ƒç´ æ•°é‡
     */
    private int calculateOptimalNumHashFunctions(int n, int m) {
        return Math.max(1, (int) Math.round((double) m / n * Math.log(2)));
    }

    /**
     * æ·»åŠ å…ƒç´ åˆ°å¸ƒéš†è¿‡æ»¤å™¨
     */
    public void add(T element) {
        if (element == null) {
            throw new NullPointerException("å…ƒç´ ä¸èƒ½ä¸ºnull");
        }

        for (int seed : hashSeeds) {
            int hash = Math.abs(element.hashCode() ^ seed);
            int index = hash % bitSetSize;
            bitset.set(index, true);
        }
        count++;
    }

    /**
     * åˆ¤æ–­å…ƒç´ æ˜¯å¦å¯èƒ½å­˜åœ¨äºå¸ƒéš†è¿‡æ»¤å™¨ä¸­
     * @return true: å¯èƒ½å­˜åœ¨, false: ä¸€å®šä¸å­˜åœ¨
     */
    public boolean mightContain(T element) {
        if (element == null) {
            return false;
        }

        for (int seed : hashSeeds) {
            int hash = Math.abs(element.hashCode() ^ seed);
            int index = hash % bitSetSize;
            if (!bitset.get(index)) {
                return false;
            }
        }
        return true;
    }

    /**
     * ä¼°è®¡å½“å‰è¯¯åˆ¤ç‡
     */
    public double estimateFalsePositiveRate() {
        // (1 - e^(-kn/m))^k
        return Math.pow(1 - Math.exp(-numHashFunctions * (double) count / bitSetSize), numHashFunctions);
    }

    /**
     * è·å–æ·»åŠ çš„å…ƒç´ æ•°é‡
     */
    public int size() {
        return count;
    }

    /**
     * æ¸…ç©ºå¸ƒéš†è¿‡æ»¤å™¨
     */
    public void clear() {
        bitset.clear();
        count = 0;
    }
}
```

### è®¡æ•°å¸ƒéš†è¿‡æ»¤å™¨ï¼ˆæ”¯æŒåˆ é™¤æ“ä½œï¼‰
```java
import java.util.Random;
import java.util.Set;
import java.util.HashSet;

public class CountingBloomFilter<T> {
    private final int[] countArray;     // è®¡æ•°æ•°ç»„
    private final int arraySize;        // æ•°ç»„å¤§å°
    private final int numHashFunctions; // å“ˆå¸Œå‡½æ•°æ•°é‡
    private final int[] hashSeeds;      // å“ˆå¸Œå‡½æ•°ç§å­
    private int count = 0;              // æ·»åŠ çš„å…ƒç´ æ•°é‡
    private final int maxCount;         // æœ€å¤§è®¡æ•°å€¼ï¼ˆé˜²æ­¢æº¢å‡ºï¼‰

    /**
     * æ„é€ è®¡æ•°å¸ƒéš†è¿‡æ»¤å™¨
     * @param expectedElements é¢„æœŸå…ƒç´ æ•°é‡
     * @param falsePositiveRate æœŸæœ›è¯¯åˆ¤ç‡
     * @param maxCount æœ€å¤§è®¡æ•°å€¼
     */
    public CountingBloomFilter(int expectedElements, double falsePositiveRate, int maxCount) {
        if (maxCount <= 0 || maxCount > Integer.MAX_VALUE) {
            throw new IllegalArgumentException("æœ€å¤§è®¡æ•°å€¼å¿…é¡»ä¸ºæ­£æ•°");
        }

        // è®¡ç®—æœ€ä¼˜å‚æ•°
        int bitSetSize = (int) (-expectedElements * Math.log(falsePositiveRate) / (Math.log(2) * Math.log(2)));
        arraySize = bitSetSize;
        numHashFunctions = Math.max(1, (int) Math.round((double) arraySize / expectedElements * Math.log(2)));
        this.maxCount = maxCount;

        // åˆå§‹åŒ–è®¡æ•°æ•°ç»„
        countArray = new int[arraySize];

        // ç”Ÿæˆä¸åŒçš„å“ˆå¸Œç§å­
        Random random = new Random();
        Set<Integer> seeds = new HashSet<>();
        while (seeds.size() < numHashFunctions) {
            seeds.add(random.nextInt(Integer.MAX_VALUE));
        }
        hashSeeds = seeds.toArray(new int[0]);
    }

    /**
     * æ·»åŠ å…ƒç´ åˆ°å¸ƒéš†è¿‡æ»¤å™¨
     */
    public void add(T element) {
        if (element == null) {
            throw new NullPointerException("å…ƒç´ ä¸èƒ½ä¸ºnull");
        }

        for (int seed : hashSeeds) {
            int hash = Math.abs(element.hashCode() ^ seed);
            int index = hash % arraySize;
            if (countArray[index] < maxCount) {
                countArray[index]++;
            }
        }
        count++;
    }

    /**
     * ä»å¸ƒéš†è¿‡æ»¤å™¨ä¸­åˆ é™¤å…ƒç´ 
     */
    public void remove(T element) {
        if (element == null) {
            throw new NullPointerException("å…ƒç´ ä¸èƒ½ä¸ºnull");
        }
        if (!mightContain(element)) {
            throw new IllegalArgumentException("å…ƒç´ ä¸å­˜åœ¨äºè¿‡æ»¤å™¨ä¸­");
        }

        for (int seed : hashSeeds) {
            int hash = Math.abs(element.hashCode() ^ seed);
            int index = hash % arraySize;
            if (countArray[index] > 0) {
                countArray[index]--;
            }
        }
        count--;
    }

    /**
     * åˆ¤æ–­å…ƒç´ æ˜¯å¦å¯èƒ½å­˜åœ¨äºå¸ƒéš†è¿‡æ»¤å™¨ä¸­
     */
    public boolean mightContain(T element) {
        if (element == null) {
            return false;
        }

        for (int seed : hashSeeds) {
            int hash = Math.abs(element.hashCode() ^ seed);
            int index = hash % arraySize;
            if (countArray[index] == 0) {
                return false;
            }
        }
        return true;
    }

    /**
     * è·å–æ·»åŠ çš„å…ƒç´ æ•°é‡
     */
    public int size() {
        return count;
    }

    /**
     * æ¸…ç©ºå¸ƒéš†è¿‡æ»¤å™¨
     */
    public void clear() {
        for (int i = 0; i < arraySize; i++) {
            countArray[i] = 0;
        }
        count = 0;
    }
}
```

## ğŸ“Š å¤æ‚åº¦åˆ†æ

| æ“ä½œ | æ—¶é—´å¤æ‚åº¦ | ç©ºé—´å¤æ‚åº¦ | è¯´æ˜ |
|------|------------|------------|------|
| åˆå§‹åŒ– | O(m + k) | O(m) | m:ä½æ•°ç»„å¤§å°, k:å“ˆå¸Œå‡½æ•°æ•°é‡ |
| æ·»åŠ å…ƒç´  | O(k) | O(1) | éœ€æ›´æ–°kä¸ªå“ˆå¸Œä½ç½® |
| æŸ¥è¯¢å…ƒç´  | O(k) | O(1) | éœ€æ£€æŸ¥kä¸ªå“ˆå¸Œä½ç½® |
| åˆ é™¤å…ƒç´  | O(k) | O(1) | ä»…è®¡æ•°å¸ƒéš†è¿‡æ»¤å™¨æ”¯æŒ |
| æ¸…ç©ºè¿‡æ»¤å™¨ | O(m) | O(1) | éœ€è¦é‡ç½®æ•´ä¸ªä½æ•°ç»„ |
| è¯¯åˆ¤ç‡è®¡ç®— | O(1) | O(1) | åŸºäºç†è®ºå…¬å¼ä¼°ç®— |

> **è¯¯åˆ¤ç‡å…¬å¼**ï¼š(1 - e^(-kn/m))^kï¼Œå…¶ä¸­kä¸ºå“ˆå¸Œå‡½æ•°æ•°é‡ï¼Œnä¸ºå…ƒç´ æ•°é‡ï¼Œmä¸ºä½æ•°ç»„å¤§å°

## ğŸ” åº”ç”¨åœºæ™¯

1. **ç¼“å­˜ç©¿é€é˜²æŠ¤**ï¼šæ•°æ®åº“æŸ¥è¯¢å‰è¿‡æ»¤ä¸å­˜åœ¨çš„keyï¼Œå‡è½»æ•°æ®åº“å‹åŠ›
2. **åˆ†å¸ƒå¼ç³»ç»Ÿå»é‡**ï¼šå¦‚åˆ†å¸ƒå¼çˆ¬è™«URLå»é‡ã€åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦å»é‡
3. **åƒåœ¾é‚®ä»¶è¿‡æ»¤**ï¼šåˆ¤æ–­é‚®ä»¶åœ°å€æ˜¯å¦åœ¨åƒåœ¾é‚®ä»¶å‘é€è€…åˆ—è¡¨ä¸­
4. **ç½‘ç»œçˆ¬è™«URLå»é‡**ï¼šé¿å…é‡å¤æŠ“å–åŒä¸€ç½‘é¡µ
5. **é›†åˆæˆå‘˜åˆ¤æ–­**ï¼šå¿«é€Ÿåˆ¤æ–­å…ƒç´ æ˜¯å¦åœ¨å¤§è§„æ¨¡é›†åˆä¸­
6. **é»‘åå•è¿‡æ»¤**ï¼šå¦‚IPé»‘åå•ã€æ‰‹æœºå·é»‘åå•è¿‡æ»¤
7. **æ¨èç³»ç»Ÿ**ï¼šè¿‡æ»¤ç”¨æˆ·å·²æ¨èæˆ–å·²æµè§ˆçš„å†…å®¹
8. **æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–**ï¼šåŠ é€ŸæŸ¥è¯¢ä¸å­˜åœ¨çš„è®°å½•
9. **æ‹¼å†™æ£€æŸ¥**ï¼šåˆ¤æ–­å•è¯æ˜¯å¦åœ¨è¯å…¸ä¸­
10. **P2Pç½‘ç»œ**ï¼šèŠ‚ç‚¹èµ„æºå­˜åœ¨æ€§åˆ¤æ–­

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **è¯¯åˆ¤ç‡æ§åˆ¶**ï¼šéœ€æ ¹æ®å®é™…éœ€æ±‚åˆç†è®¾ç½®ä½æ•°ç»„å¤§å°å’Œå“ˆå¸Œå‡½æ•°æ•°é‡
2. **å‚æ•°é€‰æ‹©**ï¼šè¯¯åˆ¤ç‡ã€ç©ºé—´å ç”¨å’ŒæŸ¥è¯¢æ—¶é—´éœ€æƒè¡¡é€‰æ‹©
3. **å“ˆå¸Œå‡½æ•°**ï¼šé€‰æ‹©ç›¸äº’ç‹¬ç«‹çš„å“ˆå¸Œå‡½æ•°ï¼Œé¿å…ç›¸å…³æ€§
4. **ä¸æ”¯æŒåˆ é™¤**ï¼šæ ‡å‡†å¸ƒéš†è¿‡æ»¤å™¨ä¸æ”¯æŒå…ƒç´ åˆ é™¤ï¼Œåˆ é™¤ä¼šå½±å“å…¶ä»–å…ƒç´ åˆ¤æ–­
5. **æ•°æ®å€¾æ–œ**ï¼šé¿å…å“ˆå¸Œç¢°æ’å¯¼è‡´çš„ä½æ•°ç»„æŸäº›ä½ç½®è¢«é¢‘ç¹å‘½ä¸­
6. **æº¢å‡ºé£é™©**ï¼šè®¡æ•°å¸ƒéš†è¿‡æ»¤å™¨å­˜åœ¨è®¡æ•°æº¢å‡ºé£é™©ï¼Œéœ€è®¾ç½®åˆç†çš„æœ€å¤§è®¡æ•°å€¼
7. **åˆå§‹åŒ–å‚æ•°**ï¼šé¢„æœŸå…ƒç´ æ•°é‡å’Œè¯¯åˆ¤ç‡éœ€æå‰ä¼°ç®—ï¼ŒåæœŸæ— æ³•è°ƒæ•´
8. **nullå€¼å¤„ç†**ï¼šéœ€æ˜ç¡®å¤„ç†nullå…ƒç´ ï¼Œé¿å…ç©ºæŒ‡é’ˆå¼‚å¸¸
9. **åºåˆ—åŒ–**ï¼šæŒä¹…åŒ–æ—¶éœ€æ³¨æ„ä½æ•°ç»„çš„åºåˆ—åŒ–æ–¹å¼
10. **é€‚ç”¨åœºæ™¯**ï¼šä¸é€‚åˆå¯¹è¯¯åˆ¤é›¶å®¹å¿çš„åœºæ™¯

## ğŸ“ æœ€ä½³å®è·µ

1. **å‚æ•°è°ƒä¼˜**ï¼šæ ¹æ®å…¬å¼m = -nln(p)/(ln2)^2å’Œk = (m/n)ln2è®¡ç®—æœ€ä¼˜å‚æ•°
2. **å“ˆå¸Œå‡½æ•°é€‰æ‹©**ï¼šä½¿ç”¨å¤šä¸ªä¸åŒç§å­çš„å“ˆå¸Œå‡½æ•°ï¼Œæé«˜åˆ†å¸ƒå‡åŒ€æ€§
3. **ç»„åˆä½¿ç”¨**ï¼šä¸å…¶ä»–æ•°æ®ç»“æ„ç»„åˆä½¿ç”¨ï¼Œå¦‚å¸ƒéš†è¿‡æ»¤å™¨+å“ˆå¸Œè¡¨å¤„ç†è¯¯åˆ¤
4. **åŠ¨æ€æ‰©å±•**ï¼šå®ç°åŠ¨æ€å¸ƒéš†è¿‡æ»¤å™¨æ”¯æŒå®¹é‡æ‰©å±•
5. **å®šæœŸé‡å»º**ï¼šå¯¹äºè®¡æ•°å¸ƒéš†è¿‡æ»¤å™¨ï¼Œå®šæœŸé‡å»ºé¿å…è®¡æ•°å€¼æº¢å‡º
6. **é¢„è®¡ç®—å“ˆå¸Œ**ï¼šå¯¹é¢‘ç¹æŸ¥è¯¢çš„å…ƒç´ é¢„è®¡ç®—å“ˆå¸Œå€¼ï¼Œæé«˜æŸ¥è¯¢é€Ÿåº¦
7. **æ‰¹é‡æ“ä½œ**ï¼šå®ç°æ‰¹é‡æ·»åŠ å’Œæ‰¹é‡æŸ¥è¯¢æ¥å£ï¼Œæé«˜å¤„ç†æ•ˆç‡
8. **å†…å­˜ä¼˜åŒ–**ï¼šå¯¹äºå¤§è§„æ¨¡æ•°æ®ï¼Œè€ƒè™‘ä½¿ç”¨å†…å­˜æ˜ å°„æ–‡ä»¶å­˜å‚¨ä½æ•°ç»„
9. **è¯¯åˆ¤ç‡ç›‘æ§**ï¼šå®šæœŸç›‘æ§å®é™…è¯¯åˆ¤ç‡ï¼Œä¸ç†è®ºå€¼å¯¹æ¯”
10. **å¸ƒéš†è¿‡æ»¤å™¨é›†ç¾¤**ï¼šå¤§è§„æ¨¡åœºæ™¯å¯ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨é›†ç¾¤åˆ†æ‹…å‹åŠ›

---

> **å·²å®Œæˆ**ï¼šæœ¬æ–‡æ¡£å·²å®Œå–„ï¼ŒåŒ…å«å¸ƒéš†è¿‡æ»¤å™¨çš„æ ¸å¿ƒæ¦‚å¿µã€Javaå®ç°ä»£ç ï¼ˆæ ‡å‡†å¸ƒéš†è¿‡æ»¤å™¨å’Œè®¡æ•°å¸ƒéš†è¿‡æ»¤å™¨ï¼‰ã€å¤æ‚åº¦åˆ†æã€åº”ç”¨åœºæ™¯å’Œæœ€ä½³å®è·µï¼Œå¯ä½œä¸ºå¸ƒéš†è¿‡æ»¤å™¨å­¦ä¹ çš„å®Œæ•´å‚è€ƒèµ„æ–™