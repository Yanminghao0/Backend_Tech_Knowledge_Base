# ç¼“å­˜æ¶æ„è®¾è®¡ä¸å®æˆ˜

> ä»é›¶å¼€å§‹ï¼ŒæŒæ¡ç¼“å­˜æ¶æ„è®¾è®¡çš„æ ¸å¿ƒæ–¹æ³•è®º

---

## ğŸ“‹ ç›®å½•

- [1. ä»€ä¹ˆæ—¶å€™éœ€è¦ç¼“å­˜](#1-ä»€ä¹ˆæ—¶å€™éœ€è¦ç¼“å­˜)
- [2. ç¼“å­˜é€‰å‹å†³ç­–](#2-ç¼“å­˜é€‰å‹å†³ç­–)
- [3. æœ¬åœ°ç¼“å­˜å®æˆ˜](#3-æœ¬åœ°ç¼“å­˜å®æˆ˜)
- [4. Redisåˆ†å¸ƒå¼ç¼“å­˜](#4-redisåˆ†å¸ƒå¼ç¼“å­˜)
- [5. å¤šçº§ç¼“å­˜æ¶æ„](#5-å¤šçº§ç¼“å­˜æ¶æ„)
- [6. ç¼“å­˜è®¾è®¡æ¨¡å¼](#6-ç¼“å­˜è®¾è®¡æ¨¡å¼)
- [7. ç¼“å­˜å¸¸è§é—®é¢˜](#7-ç¼“å­˜å¸¸è§é—®é¢˜)
- [8. ç¼“å­˜ä¸€è‡´æ€§](#8-ç¼“å­˜ä¸€è‡´æ€§)
- [9. æ€§èƒ½ä¼˜åŒ–](#9-æ€§èƒ½ä¼˜åŒ–)
- [10. å®æˆ˜æ¡ˆä¾‹](#10-å®æˆ˜æ¡ˆä¾‹)

---

## ğŸ¯ å­¦ä¹ ç›®æ ‡

é€šè¿‡æœ¬æ–‡æ¡£ï¼Œä½ å°†æŒæ¡ï¼š
- âœ… ç¼“å­˜ä½¿ç”¨æ—¶æœºåˆ¤æ–­ï¼ˆæ•°æ®é‡ã€QPSã€ä¸šåŠ¡åœºæ™¯ï¼‰
- âœ… ç¼“å­˜é€‰å‹å†³ç­–ï¼ˆæœ¬åœ°ç¼“å­˜ vs Redis vs å¤šçº§ç¼“å­˜ï¼‰
- âœ… æœ¬åœ°ç¼“å­˜å®æˆ˜ï¼ˆCaffeineã€Guava Cacheã€ConcurrentHashMapï¼‰
- âœ… Redisç¼“å­˜å®æˆ˜ï¼ˆStringã€Hashã€Listã€Setã€ZSetï¼‰
- âœ… å¤šçº§ç¼“å­˜æ¶æ„è®¾è®¡ï¼ˆL1æœ¬åœ° + L2åˆ†å¸ƒå¼ + L3æ•°æ®åº“ï¼‰
- âœ… ç¼“å­˜è®¾è®¡æ¨¡å¼ï¼ˆCache-Asideã€Read-Throughã€Write-Throughï¼‰
- âœ… ç¼“å­˜é—®é¢˜è§£å†³ï¼ˆç©¿é€ã€å‡»ç©¿ã€é›ªå´©ã€ä¸€è‡´æ€§ï¼‰
- âœ… æ€§èƒ½ä¼˜åŒ–ï¼ˆæ‰¹é‡æ“ä½œã€åºåˆ—åŒ–ã€è¿‡æœŸç­–ç•¥ï¼‰
- âœ… ä»ç™¾ä¸‡çº§åˆ°äº¿çº§æ•°æ®çš„ç¼“å­˜æ¶æ„æ¼”è¿›

---

## 1. ä»€ä¹ˆæ—¶å€™éœ€è¦ç¼“å­˜

### 1.1 ç¼“å­˜ä½¿ç”¨æ—¶æœº

**æ˜ç¡®æŒ‡æ ‡ï¼šä½•æ—¶å¿…é¡»ä½¿ç”¨ç¼“å­˜**

| ç»´åº¦ | é˜ˆå€¼ | å»ºè®® |
|------|------|------|
| **QPS** | > 1000 | å»ºè®®ç¼“å­˜çƒ­ç‚¹æ•°æ® |
| **QPS** | > 5000 | å¿…é¡»ä½¿ç”¨ç¼“å­˜ |
| **æ•°æ®é‡** | > 100ä¸‡ | è€ƒè™‘ç¼“å­˜ |
| **æ•°æ®é‡** | > 1000ä¸‡ | å¼ºçƒˆå»ºè®®ç¼“å­˜ |
| **æŸ¥è¯¢è€—æ—¶** | > 100ms | å»ºè®®ç¼“å­˜ |
| **æŸ¥è¯¢è€—æ—¶** | > 500ms | å¿…é¡»ç¼“å­˜ |
| **è¯»å†™æ¯”** | è¯»:å†™ > 10:1 | é€‚åˆç¼“å­˜ |
| **çƒ­ç‚¹æ•°æ®** | 20%æ•°æ®å 80%æµé‡ | å¼ºçƒˆå»ºè®®ç¼“å­˜ |

### 1.2 å…¸å‹åœºæ™¯åˆ†æ

#### åœºæ™¯1ï¼šç”µå•†å•†å“è¯¦æƒ…é¡µ

**æ•°æ®ç‰¹å¾**ï¼š
```
å•†å“æ€»æ•°ï¼š1000ä¸‡
çƒ­é—¨å•†å“ï¼š1ä¸‡ä¸ªï¼ˆå æ€»æµé‡çš„80%ï¼‰
å•†å“è¯¦æƒ…QPSï¼š5ä¸‡
æ•°æ®åº“QPSä¸Šé™ï¼š5000
```

**åˆ†æ**ï¼š
```
âœ… å¿…é¡»ä½¿ç”¨ç¼“å­˜ï¼

ç†ç”±ï¼š
1. QPS: 5ä¸‡ >> 5000ï¼ˆæ•°æ®åº“æ‰›ä¸ä½ï¼‰
2. çƒ­ç‚¹æ•°æ®ï¼š1ä¸‡ä¸ªçƒ­é—¨å•†å“
3. è¯»å¤šå†™å°‘ï¼šå•†å“ä¿¡æ¯å˜æ›´é¢‘ç‡ä½

ç¼“å­˜ç­–ç•¥ï¼š
- æœ¬åœ°ç¼“å­˜ï¼šç¼“å­˜Top 1000çƒ­é—¨å•†å“ï¼ˆå‡å°‘Rediså‹åŠ›ï¼‰
- Redisç¼“å­˜ï¼šç¼“å­˜Top 10ä¸‡å•†å“
- æ•°æ®åº“ï¼šå…œåº•æŸ¥è¯¢
```

#### åœºæ™¯2ï¼šç”¨æˆ·ç™»å½•ä¿¡æ¯

**æ•°æ®ç‰¹å¾**ï¼š
```
ç”¨æˆ·æ€»æ•°ï¼š1äº¿
æ—¥æ´»ç”¨æˆ·ï¼š1000ä¸‡
ç™»å½•æ ¡éªŒQPSï¼š10ä¸‡
Sessionæœ‰æ•ˆæœŸï¼š30åˆ†é’Ÿ
```

**åˆ†æ**ï¼š
```
âœ… å¿…é¡»ä½¿ç”¨ç¼“å­˜ï¼

ç†ç”±ï¼š
1. QPS: 10ä¸‡ï¼ˆæé«˜ï¼‰
2. é¢‘ç¹è®¿é—®ï¼šæ¯ä¸ªè¯·æ±‚éƒ½è¦æ ¡éªŒç™»å½•
3. æ•°æ®é‡å¤§ï¼š1äº¿ç”¨æˆ·

ç¼“å­˜ç­–ç•¥ï¼š
- Redisç¼“å­˜ï¼šSessionä¿¡æ¯ï¼ˆæ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²ï¼‰
- è¿‡æœŸæ—¶é—´ï¼š30åˆ†é’Ÿï¼ˆè‡ªåŠ¨æ¸…ç†ï¼‰
```

#### åœºæ™¯3ï¼šæ–‡ç« è¯¦æƒ…é¡µ

**æ•°æ®ç‰¹å¾**ï¼š
```
æ–‡ç« æ€»æ•°ï¼š100ä¸‡
çƒ­é—¨æ–‡ç« ï¼š1000ç¯‡ï¼ˆå æ€»æµé‡çš„50%ï¼‰
æ–‡ç« è¯¦æƒ…QPSï¼š1000
æ•°æ®åº“æŸ¥è¯¢è€—æ—¶ï¼š50ms
```

**åˆ†æ**ï¼š
```
ğŸ¤” å¯ä»¥ä½¿ç”¨ç¼“å­˜ï¼ˆéå¿…é¡»ï¼‰

ç†ç”±ï¼š
1. QPS: 1000ï¼ˆæ•°æ®åº“å¯ä»¥æ‰¿å—ï¼‰
2. æŸ¥è¯¢è€—æ—¶ï¼š50msï¼ˆå¯æ¥å—ï¼‰
3. æœ‰çƒ­ç‚¹æ•°æ®ï¼š1000ç¯‡çƒ­é—¨æ–‡ç« 

ç¼“å­˜ç­–ç•¥ï¼š
- Redisç¼“å­˜ï¼šçƒ­é—¨1000ç¯‡æ–‡ç« 
- æ•°æ®åº“ï¼šç›´æ¥æŸ¥è¯¢ï¼ˆæŸ¥è¯¢è€—æ—¶å¯æ¥å—ï¼‰
- ä¼˜åŒ–æ–¹å‘ï¼šç´¢å¼•ä¼˜åŒ–ã€æŸ¥è¯¢ä¼˜åŒ–
```

#### åœºæ™¯4ï¼šåå°ç®¡ç†ç³»ç»Ÿ

**æ•°æ®ç‰¹å¾**ï¼š
```
ç”¨æˆ·æ•°ï¼š100äºº
æ“ä½œQPSï¼š10
æ•°æ®é‡ï¼š10ä¸‡æ¡
```

**åˆ†æ**ï¼š
```
âŒ ä¸éœ€è¦ç¼“å­˜

ç†ç”±ï¼š
1. QPSä½ï¼š10ï¼ˆæ•°æ®åº“è½»æ¾åº”å¯¹ï¼‰
2. æ•°æ®é‡å°ï¼š10ä¸‡æ¡
3. å®æ—¶æ€§è¦æ±‚é«˜ï¼šåå°æ•°æ®éœ€è¦å®æ—¶

å»ºè®®ï¼š
- ä¼˜åŒ–SQLæŸ¥è¯¢
- æ·»åŠ ç´¢å¼•
- ä¸å¼•å…¥ç¼“å­˜å¤æ‚åº¦
```

### 1.3 å†³ç­–æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ˜¯å¦éœ€è¦ç¼“å­˜ï¼Ÿ      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ QPS > 5000ï¼Ÿ â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
      æ˜¯ â”Œâ”€â”´â”€â” å¦
         â”‚   â”‚
         â–¼   â–¼
      â”Œâ”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚å¿…é¡»â”‚ â”‚ æŸ¥è¯¢è€—æ—¶ > 500msï¼Ÿâ”‚
      â”‚ç¼“å­˜â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â””â”€â”€â”€â”€â”˜          â”‚
                 æ˜¯ â”Œâ”€â”´â”€â” å¦
                    â”‚   â”‚
                    â–¼   â–¼
                 â”Œâ”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚å¿…é¡»â”‚ â”‚ æœ‰çƒ­ç‚¹æ•°æ®ï¼Ÿ  â”‚
                 â”‚ç¼“å­˜â”‚ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                 â””â”€â”€â”€â”€â”˜        â”‚
                          æ˜¯ â”Œâ”€â”´â”€â” å¦
                             â”‚   â”‚
                             â–¼   â–¼
                          â”Œâ”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”
                          â”‚å»ºè®®â”‚ â”‚ä¸éœ€â”‚
                          â”‚ç¼“å­˜â”‚ â”‚è¦  â”‚
                          â””â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”˜
```

---

## 2. ç¼“å­˜é€‰å‹å†³ç­–

### 2.1 æœ¬åœ°ç¼“å­˜ vs Redis

| ç»´åº¦ | æœ¬åœ°ç¼“å­˜ | Redis |
|------|---------|-------|
| **æ€§èƒ½** | â­â­â­â­â­ æå¿«ï¼ˆçº³ç§’çº§ï¼‰ | â­â­â­â­ å¿«ï¼ˆæ¯«ç§’çº§ï¼‰ |
| **å®¹é‡** | â­â­ å—JVMå†…å­˜é™åˆ¶ï¼ˆGBçº§ï¼‰ | â­â­â­â­â­ å¤§ï¼ˆTBçº§ï¼‰ |
| **åˆ†å¸ƒå¼** | âŒ ä¸æ”¯æŒ | âœ… æ”¯æŒ |
| **æ•°æ®å…±äº«** | âŒ å•æœºç‹¬äº« | âœ… å¤šæœºå…±äº« |
| **æŒä¹…åŒ–** | âŒ ä¸æ”¯æŒ | âœ… æ”¯æŒï¼ˆRDB/AOFï¼‰ |
| **å¤æ‚åº¦** | â­ ç®€å• | â­â­â­ ä¸­ç­‰ |
| **æˆæœ¬** | â­ ä½ï¼ˆæ— é¢å¤–æˆæœ¬ï¼‰ | â­â­â­ ä¸­ï¼ˆéœ€è¦RedisæœåŠ¡å™¨ï¼‰ |

### 2.2 é€‰å‹å†³ç­–æ ‘

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é€‰æ‹©å“ªç§ç¼“å­˜ï¼Ÿ      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ åˆ†å¸ƒå¼éƒ¨ç½²ï¼Ÿ â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
      æ˜¯ â”Œâ”€â”´â”€â” å¦
         â”‚   â”‚
         â–¼   â–¼
      â”Œâ”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚å¿…é¡»â”‚ â”‚ æ•°æ®é‡ > 1GBï¼Ÿâ”‚
      â”‚Redisâ”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
      â””â”€â”€â”€â”€â”˜          â”‚
                 æ˜¯ â”Œâ”€â”´â”€â” å¦
                    â”‚   â”‚
                    â–¼   â–¼
                 â”Œâ”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚Redisâ”‚ â”‚ QPS > 10ä¸‡ï¼Ÿ â”‚
                 â””â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                           æ˜¯ â”Œâ”€â”´â”€â” å¦
                              â”‚   â”‚
                              â–¼   â–¼
                           â”Œâ”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”
                           â”‚å¤šçº§â”‚ â”‚æœ¬åœ°â”‚
                           â”‚ç¼“å­˜â”‚ â”‚ç¼“å­˜â”‚
                           â””â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”˜
```

### 2.3 å…¸å‹åœºæ™¯æ¨è

#### æ¨èæœ¬åœ°ç¼“å­˜

**åœºæ™¯1ï¼šé…ç½®ä¿¡æ¯**
```java
// ç³»ç»Ÿé…ç½®ï¼ˆå¾ˆå°‘å˜åŒ–ï¼‰
Caffeine<String, Config> configCache = Caffeine.newBuilder()
    .maximumSize(100)
    .build();

// å˜æ›´é¢‘ç‡ï¼š1å¤©1æ¬¡
// æ•°æ®é‡ï¼š100æ¡
// QPSï¼š1ä¸‡
// ç»“è®ºï¼šæœ¬åœ°ç¼“å­˜å®Œç¾
```

**åœºæ™¯2ï¼šå­—å…¸æ•°æ®**
```java
// åœ°åŒºå­—å…¸ã€è¡Œä¸šå­—å…¸
Map<String, List<Dict>> dictCache = new ConcurrentHashMap<>();

// å˜æ›´é¢‘ç‡ï¼š1å‘¨1æ¬¡
// æ•°æ®é‡ï¼š1000æ¡
// QPSï¼š5000
// ç»“è®ºï¼šæœ¬åœ°ç¼“å­˜è¶³å¤Ÿ
```

**åœºæ™¯3ï¼šçƒ­ç‚¹å•†å“ï¼ˆå•æœºï¼‰**
```java
// Top 100çƒ­é—¨å•†å“
Caffeine<Long, Product> hotProductCache = Caffeine.newBuilder()
    .maximumSize(100)
    .expireAfterWrite(5, TimeUnit.MINUTES)
    .build();

// å˜æ›´é¢‘ç‡ï¼š5åˆ†é’Ÿåˆ·æ–°
// æ•°æ®é‡ï¼š100æ¡
// QPSï¼š10ä¸‡ï¼ˆå•æœºï¼‰
// ç»“è®ºï¼šæœ¬åœ°ç¼“å­˜ + å®šæ—¶åˆ·æ–°
```

#### æ¨èRedis

**åœºæ™¯1ï¼šç”¨æˆ·Session**
```java
// åˆ†å¸ƒå¼éƒ¨ç½²ï¼ŒSessionå…±äº«
redisTemplate.opsForValue().set("session:" + token, userInfo, 30, TimeUnit.MINUTES);

// å˜æ›´é¢‘ç‡ï¼š30åˆ†é’Ÿè¿‡æœŸ
// æ•°æ®é‡ï¼š1000ä¸‡åœ¨çº¿ç”¨æˆ·
// QPSï¼š10ä¸‡
// åˆ†å¸ƒå¼ï¼šâœ…
// ç»“è®ºï¼šå¿…é¡»Redis
```

**åœºæ™¯2ï¼šå•†å“è¯¦æƒ…**
```java
// å•†å“è¯¦æƒ…ï¼ˆåˆ†å¸ƒå¼éƒ¨ç½²ï¼‰
redisTemplate.opsForValue().set("product:" + id, productJson, 1, TimeUnit.HOURS);

// å˜æ›´é¢‘ç‡ï¼š1å°æ—¶åˆ·æ–°
// æ•°æ®é‡ï¼š1000ä¸‡å•†å“
// QPSï¼š5ä¸‡
// åˆ†å¸ƒå¼ï¼šâœ…
// ç»“è®ºï¼šå¿…é¡»Redis
```

**åœºæ™¯3ï¼šåˆ†å¸ƒå¼é”**
```java
// ç§’æ€åœºæ™¯ï¼Œé˜²æ­¢è¶…å–
Boolean locked = redisTemplate.opsForValue().setIfAbsent(
    "lock:seckill:" + productId, 
    "locked", 
    10, TimeUnit.SECONDS
);

// åˆ†å¸ƒå¼ï¼šâœ…
// ç»“è®ºï¼šå¿…é¡»Redis
```

#### æ¨èå¤šçº§ç¼“å­˜

**åœºæ™¯ï¼šç”µå•†é¦–é¡µå•†å“æ¨è**
```java
// L1ï¼šæœ¬åœ°ç¼“å­˜ï¼ˆTop 100çƒ­é—¨å•†å“ï¼Œ1åˆ†é’Ÿè¿‡æœŸï¼‰
Caffeine<Long, Product> l1Cache = Caffeine.newBuilder()
    .maximumSize(100)
    .expireAfterWrite(1, TimeUnit.MINUTES)
    .build();

// L2ï¼šRedisï¼ˆTop 10000å•†å“ï¼Œ10åˆ†é’Ÿè¿‡æœŸï¼‰
redisTemplate.opsForValue().set("product:" + id, json, 10, TimeUnit.MINUTES);

// L3ï¼šMySQLï¼ˆå…œåº•ï¼‰
productMapper.selectById(id);

// æ•°æ®é‡ï¼š1000ä¸‡å•†å“
// çƒ­ç‚¹æ•°æ®ï¼š100ä¸ªè¶…çº§çƒ­é—¨
// QPSï¼š20ä¸‡
// åˆ†å¸ƒå¼ï¼šâœ…
// ç»“è®ºï¼šå¤šçº§ç¼“å­˜
```

---

## 3. æœ¬åœ°ç¼“å­˜å®æˆ˜

### 3.1 Caffeineï¼ˆæ¨èï¼‰

**ç®€ä»‹**ï¼šSpring Bootå®˜æ–¹æ¨èï¼Œæ€§èƒ½æœ€å¼ºçš„æœ¬åœ°ç¼“å­˜

**æ€§èƒ½å¯¹æ¯”**ï¼š
```
Caffeine > Guava Cache > ConcurrentHashMap + æ‰‹åŠ¨è¿‡æœŸ
```

**åŸºæœ¬ä½¿ç”¨**ï¼š

```java
@Configuration
public class CacheConfig {
    
    @Bean
    public Caffeine<Object, Object> caffeineConfig() {
        return Caffeine.newBuilder()
            .maximumSize(10000)  // æœ€å¤§ç¼“å­˜æ•°é‡
            .expireAfterWrite(5, TimeUnit.MINUTES)  // å†™å…¥å5åˆ†é’Ÿè¿‡æœŸ
            .recordStats();  // å¼€å¯ç»Ÿè®¡
    }
    
    @Bean
    public CacheManager cacheManager(Caffeine caffeine) {
        CaffeineCacheManager manager = new CaffeineCacheManager();
        manager.setCaffeine(caffeine);
        return manager;
    }
}
```

**æ³¨è§£ä½¿ç”¨**ï¼š

```java
@Service
public class ProductService {
    
    // æŸ¥è¯¢æ—¶è‡ªåŠ¨ç¼“å­˜
    @Cacheable(value = "product", key = "#id")
    public Product getById(Long id) {
        System.out.println("æŸ¥è¯¢æ•°æ®åº“: " + id);
        return productMapper.selectById(id);
    }
    
    // æ›´æ–°æ—¶åˆ é™¤ç¼“å­˜
    @CacheEvict(value = "product", key = "#product.id")
    public void update(Product product) {
        productMapper.updateById(product);
    }
    
    // æ›´æ–°æ—¶åˆ·æ–°ç¼“å­˜
    @CachePut(value = "product", key = "#result.id")
    public Product save(Product product) {
        productMapper.insert(product);
        return product;
    }
}
```

**æ‰‹åŠ¨ä½¿ç”¨**ï¼š

```java
@Service
public class ProductService {
    
    private final Cache<Long, Product> productCache;
    
    public ProductService() {
        this.productCache = Caffeine.newBuilder()
            .maximumSize(10000)
            .expireAfterWrite(5, TimeUnit.MINUTES)
            .build();
    }
    
    public Product getById(Long id) {
        // 1. å…ˆæŸ¥ç¼“å­˜
        Product product = productCache.getIfPresent(id);
        if (product != null) {
            return product;
        }
        
        // 2. æŸ¥æ•°æ®åº“
        product = productMapper.selectById(id);
        
        // 3. å†™å…¥ç¼“å­˜
        if (product != null) {
            productCache.put(id, product);
        }
        
        return product;
    }
    
    // æˆ–è€…ä½¿ç”¨ get + loader
    public Product getByIdV2(Long id) {
        return productCache.get(id, key -> {
            // ç¼“å­˜æœªå‘½ä¸­æ—¶è‡ªåŠ¨åŠ è½½
            return productMapper.selectById(key);
        });
    }
}
```

### 3.2 è¿‡æœŸç­–ç•¥

**1. åŸºäºæ—¶é—´è¿‡æœŸ**

```java
// å†™å…¥åè¿‡æœŸ
Caffeine.newBuilder()
    .expireAfterWrite(10, TimeUnit.MINUTES)
    .build();

// è®¿é—®åè¿‡æœŸ
Caffeine.newBuilder()
    .expireAfterAccess(10, TimeUnit.MINUTES)
    .build();

// è‡ªå®šä¹‰è¿‡æœŸç­–ç•¥
Caffeine.newBuilder()
    .expireAfter(new Expiry<Long, Product>() {
        @Override
        public long expireAfterCreate(Long key, Product value, long currentTime) {
            // çƒ­é—¨å•†å“ï¼š10åˆ†é’Ÿè¿‡æœŸ
            if (value.isHot()) {
                return TimeUnit.MINUTES.toNanos(10);
            }
            // æ™®é€šå•†å“ï¼š5åˆ†é’Ÿè¿‡æœŸ
            return TimeUnit.MINUTES.toNanos(5);
        }
        
        @Override
        public long expireAfterUpdate(Long key, Product value, 
                                      long currentTime, long currentDuration) {
            return currentDuration;
        }
        
        @Override
        public long expireAfterRead(Long key, Product value, 
                                    long currentTime, long currentDuration) {
            return currentDuration;
        }
    })
    .build();
```

**2. åŸºäºå¤§å°æ·˜æ±°**

```java
// æœ€å¤§æ•°é‡
Caffeine.newBuilder()
    .maximumSize(10000)
    .build();

// æœ€å¤§æƒé‡
Caffeine.newBuilder()
    .maximumWeight(1000000)  // 1MB
    .weigher((Long key, Product value) -> {
        // è®¡ç®—å¯¹è±¡å¤§å°
        return value.getSize();
    })
    .build();
```

**3. æ·˜æ±°ç®—æ³•**

Caffeineä½¿ç”¨ **W-TinyLFU** ç®—æ³•ï¼ˆæ€§èƒ½ä¼˜äºLRUï¼‰ï¼š

```
W-TinyLFU = Window + TinyLFU

Windowï¼ˆ1%ï¼‰ï¼šæ–°æ•°æ®å…ˆè¿›å…¥Windowï¼ˆé˜²æ­¢LFUè¯¯æ·˜æ±°ï¼‰
TinyLFUï¼ˆ99%ï¼‰ï¼šé«˜é¢‘æ•°æ®è¿›å…¥ä¸»ç¼“å­˜

ä¼˜ç‚¹ï¼š
âœ… å‘½ä¸­ç‡é«˜äºLRU
âœ… é€‚åº”çªå‘æµé‡
âœ… é˜²æ­¢ç¼“å­˜æ±¡æŸ“
```

### 3.3 ç›‘å¬å™¨

```java
Cache<Long, Product> cache = Caffeine.newBuilder()
    .maximumSize(10000)
    .removalListener((Long key, Product value, RemovalCause cause) -> {
        System.out.println("ç¼“å­˜ç§»é™¤: key=" + key + ", cause=" + cause);
        
        // è®°å½•æ—¥å¿—
        if (cause == RemovalCause.EXPIRED) {
            log.info("ç¼“å­˜è¿‡æœŸ: {}", key);
        } else if (cause == RemovalCause.SIZE) {
            log.warn("ç¼“å­˜æ»¡ï¼Œæ·˜æ±°: {}", key);
        }
    })
    .build();
```

### 3.4 ç»Ÿè®¡ä¿¡æ¯

```java
Cache<Long, Product> cache = Caffeine.newBuilder()
    .maximumSize(10000)
    .recordStats()  // å¼€å¯ç»Ÿè®¡
    .build();

// è·å–ç»Ÿè®¡ä¿¡æ¯
CacheStats stats = cache.stats();
System.out.println("å‘½ä¸­ç‡: " + stats.hitRate());
System.out.println("å‘½ä¸­æ¬¡æ•°: " + stats.hitCount());
System.out.println("æœªå‘½ä¸­æ¬¡æ•°: " + stats.missCount());
System.out.println("åŠ è½½æˆåŠŸæ¬¡æ•°: " + stats.loadSuccessCount());
System.out.println("åŠ è½½å¤±è´¥æ¬¡æ•°: " + stats.loadFailureCount());
System.out.println("å¹³å‡åŠ è½½æ—¶é—´: " + stats.averageLoadPenalty() + "ns");
```

### 3.5 åˆ·æ–°æœºåˆ¶

```java
LoadingCache<Long, Product> cache = Caffeine.newBuilder()
    .maximumSize(10000)
    .refreshAfterWrite(1, TimeUnit.MINUTES)  // å†™å…¥å1åˆ†é’Ÿå¼‚æ­¥åˆ·æ–°
    .build(key -> {
        // åŠ è½½æ•°æ®
        return productMapper.selectById(key);
    });

// æŸ¥è¯¢æ—¶è‡ªåŠ¨åˆ·æ–°ï¼ˆå¼‚æ­¥ï¼‰
Product product = cache.get(1L);
```

**åˆ·æ–° vs è¿‡æœŸ**ï¼š

| ç‰¹æ€§ | åˆ·æ–°ï¼ˆRefreshï¼‰ | è¿‡æœŸï¼ˆExpireï¼‰ |
|------|----------------|---------------|
| **è§¦å‘æ—¶æœº** | å®šæ—¶è§¦å‘ | è®¿é—®æ—¶è§¦å‘ |
| **æ˜¯å¦é˜»å¡** | å¼‚æ­¥åˆ·æ–°ï¼ˆä¸é˜»å¡ï¼‰ | åŒæ­¥åŠ è½½ï¼ˆé˜»å¡ï¼‰ |
| **æ—§å€¼å¯ç”¨** | âœ… åˆ·æ–°æœŸé—´è¿”å›æ—§å€¼ | âŒ è¿‡æœŸåå¿…é¡»é‡æ–°åŠ è½½ |
| **é€‚ç”¨åœºæ™¯** | çƒ­ç‚¹æ•°æ®ï¼ˆä¿è¯å¯ç”¨æ€§ï¼‰ | æ™®é€šæ•°æ® |

---

## 4. Redisåˆ†å¸ƒå¼ç¼“å­˜

### 4.1 æ•°æ®ç±»å‹é€‰æ‹©

**åœºæ™¯1ï¼šç®€å•å¯¹è±¡ï¼ˆStringï¼‰**

```java
// ç”¨æˆ·ä¿¡æ¯
@Service
public class UserService {
    
    @Autowired
    private StringRedisTemplate redisTemplate;
    
    public User getById(Long id) {
        String key = "user:" + id;
        
        // 1. æŸ¥ç¼“å­˜
        String json = redisTemplate.opsForValue().get(key);
        if (json != null) {
            return JSON.parseObject(json, User.class);
        }
        
        // 2. æŸ¥æ•°æ®åº“
        User user = userMapper.selectById(id);
        
        // 3. å†™ç¼“å­˜
        if (user != null) {
            redisTemplate.opsForValue().set(
                key, 
                JSON.toJSONString(user), 
                30, TimeUnit.MINUTES
            );
        }
        
        return user;
    }
}
```

**åœºæ™¯2ï¼šå¯¹è±¡å±æ€§ï¼ˆHashï¼‰**

```java
// å•†å“ä¿¡æ¯ï¼ˆå±æ€§è¾ƒå¤šï¼Œéƒ¨åˆ†æ›´æ–°ï¼‰
@Service
public class ProductService {
    
    public Product getById(Long id) {
        String key = "product:" + id;
        
        // 1. æŸ¥ç¼“å­˜
        Map<Object, Object> map = redisTemplate.opsForHash().entries(key);
        if (!map.isEmpty()) {
            return convertToProduct(map);
        }
        
        // 2. æŸ¥æ•°æ®åº“
        Product product = productMapper.selectById(id);
        
        // 3. å†™ç¼“å­˜
        if (product != null) {
            Map<String, String> hash = new HashMap<>();
            hash.put("id", product.getId().toString());
            hash.put("name", product.getName());
            hash.put("price", product.getPrice().toString());
            hash.put("stock", product.getStock().toString());
            
            redisTemplate.opsForHash().putAll(key, hash);
            redisTemplate.expire(key, 1, TimeUnit.HOURS);
        }
        
        return product;
    }
    
    // æ›´æ–°å•ä¸ªå­—æ®µï¼ˆä¸å½±å“å…¶ä»–å­—æ®µï¼‰
    public void updatePrice(Long id, BigDecimal price) {
        productMapper.updatePrice(id, price);
        
        // æ›´æ–°ç¼“å­˜ä¸­çš„priceå­—æ®µ
        String key = "product:" + id;
        redisTemplate.opsForHash().put(key, "price", price.toString());
    }
}
```

**åœºæ™¯3ï¼šåˆ—è¡¨æ•°æ®ï¼ˆListï¼‰**

```java
// ç”¨æˆ·æœ€è¿‘æµè§ˆè®°å½•
@Service
public class BrowseHistoryService {
    
    public void addHistory(Long userId, Long productId) {
        String key = "history:" + userId;
        
        // æ·»åŠ åˆ°åˆ—è¡¨å¤´éƒ¨
        redisTemplate.opsForList().leftPush(key, productId.toString());
        
        // ä¿ç•™æœ€è¿‘100æ¡
        redisTemplate.opsForList().trim(key, 0, 99);
        
        // è®¾ç½®è¿‡æœŸæ—¶é—´
        redisTemplate.expire(key, 7, TimeUnit.DAYS);
    }
    
    public List<Long> getHistory(Long userId, int limit) {
        String key = "history:" + userId;
        
        List<String> list = redisTemplate.opsForList().range(key, 0, limit - 1);
        return list.stream()
            .map(Long::parseLong)
            .collect(Collectors.toList());
    }
}
```

**åœºæ™¯4ï¼šå»é‡ï¼ˆSetï¼‰**

```java
// æ–‡ç« ç‚¹èµç”¨æˆ·
@Service
public class LikeService {
    
    public boolean like(Long articleId, Long userId) {
        String key = "like:article:" + articleId;
        
        // æ·»åŠ åˆ°Setï¼ˆè‡ªåŠ¨å»é‡ï¼‰
        Long result = redisTemplate.opsForSet().add(key, userId.toString());
        
        return result != null && result > 0;
    }
    
    public boolean unlike(Long articleId, Long userId) {
        String key = "like:article:" + articleId;
        
        Long result = redisTemplate.opsForSet().remove(key, userId.toString());
        
        return result != null && result > 0;
    }
    
    public long getLikeCount(Long articleId) {
        String key = "like:article:" + articleId;
        
        return redisTemplate.opsForSet().size(key);
    }
    
    public boolean isLiked(Long articleId, Long userId) {
        String key = "like:article:" + articleId;
        
        return redisTemplate.opsForSet().isMember(key, userId.toString());
    }
}
```

**åœºæ™¯5ï¼šæ’è¡Œæ¦œï¼ˆSorted Setï¼‰**

```java
// æ¸¸æˆç§¯åˆ†æ’è¡Œæ¦œ
@Service
public class RankService {
    
    public void updateScore(Long userId, double score) {
        String key = "rank:score";
        
        // æ›´æ–°åˆ†æ•°
        redisTemplate.opsForZSet().add(key, userId.toString(), score);
    }
    
    public List<UserScore> getTopN(int n) {
        String key = "rank:score";
        
        // è·å–Top Nï¼ˆåˆ†æ•°ä»é«˜åˆ°ä½ï¼‰
        Set<ZSetOperations.TypedTuple<String>> set = 
            redisTemplate.opsForZSet().reverseRangeWithScores(key, 0, n - 1);
        
        return set.stream()
            .map(tuple -> new UserScore(
                Long.parseLong(tuple.getValue()),
                tuple.getScore()
            ))
            .collect(Collectors.toList());
    }
    
    public Long getRank(Long userId) {
        String key = "rank:score";
        
        // è·å–æ’åï¼ˆä»0å¼€å§‹ï¼‰
        Long rank = redisTemplate.opsForZSet().reverseRank(key, userId.toString());
        
        return rank != null ? rank + 1 : null;
    }
}
```

### 4.2 è¿‡æœŸç­–ç•¥

**1. è®¾ç½®è¿‡æœŸæ—¶é—´**

```java
// æ–¹å¼1ï¼šè®¾ç½®valueæ—¶æŒ‡å®š
redisTemplate.opsForValue().set(key, value, 30, TimeUnit.MINUTES);

// æ–¹å¼2ï¼šå•ç‹¬è®¾ç½®
redisTemplate.expire(key, 30, TimeUnit.MINUTES);

// æ–¹å¼3ï¼šè®¾ç½®åˆ°æœŸæ—¶é—´ç‚¹
redisTemplate.expireAt(key, new Date(System.currentTimeMillis() + 30 * 60 * 1000));
```

**2. è¿‡æœŸæ—¶é—´é€‰æ‹©**

| æ•°æ®ç±»å‹ | æ¨èè¿‡æœŸæ—¶é—´ | ç†ç”± |
|---------|------------|------|
| **ç”¨æˆ·Session** | 30åˆ†é’Ÿ | ç™»å½•æœ‰æ•ˆæœŸ |
| **å•†å“è¯¦æƒ…** | 1-24å°æ—¶ | å˜æ›´é¢‘ç‡ä½ |
| **åº“å­˜æ•°é‡** | 5-10ç§’ | å®æ—¶æ€§è¦æ±‚é«˜ |
| **çƒ­ç‚¹æ•°æ®** | 5-10åˆ†é’Ÿ | é¿å…ç¼“å­˜é›ªå´© |
| **é…ç½®ä¿¡æ¯** | æ°¸ä¹… | æ‰‹åŠ¨æ›´æ–° |
| **éªŒè¯ç ** | 5åˆ†é’Ÿ | å®‰å…¨è¦æ±‚ |

**3. é¿å…ç¼“å­˜é›ªå´©ï¼ˆè¿‡æœŸæ—¶é—´åŠ éšæœºå€¼ï¼‰**

```java
// âŒ é”™è¯¯ï¼šæ‰€æœ‰ç¼“å­˜åŒæ—¶è¿‡æœŸ
int ttl = 3600;  // 1å°æ—¶

// âœ… æ­£ç¡®ï¼šè¿‡æœŸæ—¶é—´åŠ éšæœºå€¼
int ttl = 3600 + ThreadLocalRandom.current().nextInt(600);  // 1å°æ—¶ Â± 10åˆ†é’Ÿ
redisTemplate.opsForValue().set(key, value, ttl, TimeUnit.SECONDS);
```

### 4.3 åºåˆ—åŒ–æ–¹å¼

**æ€§èƒ½å¯¹æ¯”**ï¼š

| åºåˆ—åŒ–æ–¹å¼ | æ€§èƒ½ | å¯è¯»æ€§ | å¤§å° |
|-----------|------|--------|------|
| **JDK** | â­â­ | âŒ | å¤§ |
| **JSON** | â­â­â­ | âœ… | ä¸­ |
| **Protobuf** | â­â­â­â­â­ | âŒ | å° |
| **Kryo** | â­â­â­â­â­ | âŒ | å° |

**æ¨èé…ç½®**ï¼š

```java
@Configuration
public class RedisConfig {
    
    @Bean
    public RedisTemplate<String, Object> redisTemplate(RedisConnectionFactory factory) {
        RedisTemplate<String, Object> template = new RedisTemplate<>();
        template.setConnectionFactory(factory);
        
        // Keyåºåˆ—åŒ–ï¼šString
        StringRedisSerializer stringSerializer = new StringRedisSerializer();
        template.setKeySerializer(stringSerializer);
        template.setHashKeySerializer(stringSerializer);
        
        // Valueåºåˆ—åŒ–ï¼šJSON
        Jackson2JsonRedisSerializer<Object> jsonSerializer = 
            new Jackson2JsonRedisSerializer<>(Object.class);
        
        ObjectMapper om = new ObjectMapper();
        om.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);
        om.activateDefaultTyping(
            LaissezFaireSubTypeValidator.instance,
            ObjectMapper.DefaultTyping.NON_FINAL
        );
        jsonSerializer.setObjectMapper(om);
        
        template.setValueSerializer(jsonSerializer);
        template.setHashValueSerializer(jsonSerializer);
        
        return template;
    }
}
```

### 4.4 æ‰¹é‡æ“ä½œ

**Pipelineï¼ˆç®¡é“ï¼‰**ï¼š

```java
// âŒ é”™è¯¯ï¼šå¾ªç¯æ“ä½œï¼ˆ1000æ¬¡ç½‘ç»œå¾€è¿”ï¼‰
for (int i = 0; i < 1000; i++) {
    redisTemplate.opsForValue().set("key:" + i, "value:" + i);
}

// âœ… æ­£ç¡®ï¼šPipelineï¼ˆ1æ¬¡ç½‘ç»œå¾€è¿”ï¼‰
redisTemplate.executePipelined(new RedisCallback<Object>() {
    @Override
    public Object doInRedis(RedisConnection connection) {
        for (int i = 0; i < 1000; i++) {
            connection.set(
                ("key:" + i).getBytes(),
                ("value:" + i).getBytes()
            );
        }
        return null;
    }
});
```

**æ€§èƒ½å¯¹æ¯”**ï¼š

```
æ™®é€šæ“ä½œï¼š1000æ¬¡ â†’ è€—æ—¶500msï¼ˆ0.5ms/æ¬¡ç½‘ç»œå¾€è¿”ï¼‰
Pipelineï¼š1000æ¬¡ â†’ è€—æ—¶5msï¼ˆæ‰¹é‡å‘é€ï¼‰

æå‡ï¼š100å€ï¼
```

---

## 5. å¤šçº§ç¼“å­˜æ¶æ„

### 5.1 æ¶æ„è®¾è®¡

**ä¸‰çº§ç¼“å­˜æ¶æ„**ï¼š

```
è¯·æ±‚
  â”‚
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ L1ï¼šæœ¬åœ°ç¼“å­˜ï¼ˆCaffeineï¼‰     â”‚  â† æå¿«ï¼ˆçº³ç§’çº§ï¼‰
â”‚ - Top 100çƒ­ç‚¹æ•°æ®            â”‚
â”‚ - è¿‡æœŸæ—¶é—´ï¼š1åˆ†é’Ÿ            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ æœªå‘½ä¸­
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ L2ï¼šåˆ†å¸ƒå¼ç¼“å­˜ï¼ˆRedisï¼‰      â”‚  â† å¿«ï¼ˆæ¯«ç§’çº§ï¼‰
â”‚ - Top 10000æ•°æ®             â”‚
â”‚ - è¿‡æœŸæ—¶é—´ï¼š10åˆ†é’Ÿ           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ æœªå‘½ä¸­
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ L3ï¼šæ•°æ®åº“ï¼ˆMySQLï¼‰          â”‚  â† æ…¢ï¼ˆç™¾æ¯«ç§’çº§ï¼‰
â”‚ - å…¨é‡æ•°æ®                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 å®ç°æ–¹æ¡ˆ

**æ–¹æ¡ˆ1ï¼šæ‰‹åŠ¨å®ç°**

```java
@Service
public class ProductService {
    
    // L1ï¼šæœ¬åœ°ç¼“å­˜
    private final Cache<Long, Product> localCache;
    
    // L2ï¼šRedis
    @Autowired
    private StringRedisTemplate redisTemplate;
    
    // L3ï¼šæ•°æ®åº“
    @Autowired
    private ProductMapper productMapper;
    
    public ProductService() {
        this.localCache = Caffeine.newBuilder()
            .maximumSize(100)  // Top 100
            .expireAfterWrite(1, TimeUnit.MINUTES)  // 1åˆ†é’Ÿè¿‡æœŸ
            .build();
    }
    
    public Product getById(Long id) {
        // 1. æŸ¥L1æœ¬åœ°ç¼“å­˜
        Product product = localCache.getIfPresent(id);
        if (product != null) {
            log.info("L1å‘½ä¸­: {}", id);
            return product;
        }
        
        // 2. æŸ¥L2 Redisç¼“å­˜
        String redisKey = "product:" + id;
        String json = redisTemplate.opsForValue().get(redisKey);
        if (json != null) {
            log.info("L2å‘½ä¸­: {}", id);
            product = JSON.parseObject(json, Product.class);
            
            // å†™å…¥L1
            localCache.put(id, product);
            
            return product;
        }
        
        // 3. æŸ¥L3æ•°æ®åº“
        log.info("L3æŸ¥è¯¢æ•°æ®åº“: {}", id);
        product = productMapper.selectById(id);
        
        if (product != null) {
            // å†™å…¥L2
            redisTemplate.opsForValue().set(
                redisKey,
                JSON.toJSONString(product),
                10, TimeUnit.MINUTES
            );
            
            // å†™å…¥L1
            localCache.put(id, product);
        }
        
        return product;
    }
}
```

**æ–¹æ¡ˆ2ï¼šä½¿ç”¨Spring Cache**

```java
@Configuration
@EnableCaching
public class CacheConfig {
    
    @Bean
    public CacheManager cacheManager() {
        // ç»„åˆå¤šä¸ªCacheManager
        SimpleCacheManager cacheManager = new SimpleCacheManager();
        
        // L1ï¼šCaffeine
        CaffeineCacheManager caffeineCacheManager = new CaffeineCacheManager();
        caffeineCacheManager.setCaffeine(Caffeine.newBuilder()
            .maximumSize(100)
            .expireAfterWrite(1, TimeUnit.MINUTES)
        );
        
        // L2ï¼šRedis
        RedisCacheConfiguration redisCacheConfiguration = RedisCacheConfiguration.defaultCacheConfig()
            .entryTtl(Duration.ofMinutes(10));
        
        RedisCacheManager redisCacheManager = RedisCacheManager.builder(redisConnectionFactory)
            .cacheDefaults(redisCacheConfiguration)
            .build();
        
        // ç»„åˆ
        CompositeCacheManager compositeCacheManager = new CompositeCacheManager(
            caffeineCacheManager,
            redisCacheManager
        );
        
        return compositeCacheManager;
    }
}
```

**æ–¹æ¡ˆ3ï¼šä½¿ç”¨å¼€æºæ¡†æ¶ï¼ˆLayering-Cacheï¼‰**

```xml
<dependency>
    <groupId>com.github.xiaolyuh</groupId>
    <artifactId>layering-cache-starter</artifactId>
    <version>1.2.0</version>
</dependency>
```

```java
@Cached(
    name = "product",
    key = "#id",
    firstCache = @FirstCache(expireTime = 60, timeUnit = TimeUnit.SECONDS),  // L1ï¼š1åˆ†é’Ÿ
    secondCache = @SecondCache(expireTime = 10, timeUnit = TimeUnit.MINUTES)  // L2ï¼š10åˆ†é’Ÿ
)
public Product getById(Long id) {
    return productMapper.selectById(id);
}
```

### 5.3 ä¸€è‡´æ€§ä¿è¯

**é—®é¢˜**ï¼šæ›´æ–°æ•°æ®åº“åï¼Œå¦‚ä½•ä¿è¯L1å’ŒL2ç¼“å­˜ä¸€è‡´ï¼Ÿ

**æ–¹æ¡ˆ1ï¼šä¸»åŠ¨åˆ é™¤ï¼ˆæ¨èï¼‰**

```java
@Service
public class ProductService {
    
    public void update(Product product) {
        // 1. æ›´æ–°æ•°æ®åº“
        productMapper.updateById(product);
        
        // 2. åˆ é™¤L2ï¼ˆRedisï¼‰
        String redisKey = "product:" + product.getId();
        redisTemplate.delete(redisKey);
        
        // 3. åˆ é™¤L1ï¼ˆæœ¬åœ°ç¼“å­˜ï¼‰
        localCache.invalidate(product.getId());
        
        // 4. å¦‚æœæ˜¯é›†ç¾¤ï¼Œéœ€è¦é€šçŸ¥å…¶ä»–èŠ‚ç‚¹åˆ é™¤L1
        notifyOtherNodes(product.getId());
    }
    
    // é€šè¿‡Redis Pub/Subé€šçŸ¥å…¶ä»–èŠ‚ç‚¹
    private void notifyOtherNodes(Long productId) {
        redisTemplate.convertAndSend("cache:evict:product", productId);
    }
    
    // ç›‘å¬æ¶ˆæ¯ï¼Œåˆ é™¤æœ¬åœ°ç¼“å­˜
    @RedisListener(topics = "cache:evict:product")
    public void handleCacheEvict(Long productId) {
        localCache.invalidate(productId);
    }
}
```

**æ–¹æ¡ˆ2ï¼šè®¾ç½®çŸ­è¿‡æœŸæ—¶é—´**

```java
// L1ï¼š1åˆ†é’Ÿè¿‡æœŸï¼ˆå®¹å¿1åˆ†é’Ÿçš„ä¸ä¸€è‡´ï¼‰
localCache = Caffeine.newBuilder()
    .expireAfterWrite(1, TimeUnit.MINUTES)
    .build();

// L2ï¼š10åˆ†é’Ÿè¿‡æœŸï¼ˆå®¹å¿10åˆ†é’Ÿçš„ä¸ä¸€è‡´ï¼‰
redisTemplate.opsForValue().set(key, value, 10, TimeUnit.MINUTES);
```

### 5.4 æ€§èƒ½å¯¹æ¯”

**å•çº§ç¼“å­˜ï¼ˆä»…Redisï¼‰**ï¼š
```
QPSï¼š5ä¸‡
å¹³å‡å»¶è¿Ÿï¼š2ms
P99å»¶è¿Ÿï¼š5ms
```

**å¤šçº§ç¼“å­˜ï¼ˆæœ¬åœ°+Redisï¼‰**ï¼š
```
QPSï¼š20ä¸‡
å¹³å‡å»¶è¿Ÿï¼š0.5ms
P99å»¶è¿Ÿï¼š2ms

æå‡ï¼š4å€QPSï¼Œå»¶è¿Ÿé™ä½75%
```

---

## 6. ç¼“å­˜è®¾è®¡æ¨¡å¼

### 6.1 Cache-Asideï¼ˆæ—è·¯ç¼“å­˜ï¼‰â˜…â˜…â˜…â˜…â˜…

**æœ€å¸¸ç”¨çš„æ¨¡å¼**

**è¯»æµç¨‹**ï¼š
```
1. æŸ¥ç¼“å­˜
2. ç¼“å­˜å‘½ä¸­ â†’ è¿”å›
3. ç¼“å­˜æœªå‘½ä¸­ â†’ æŸ¥æ•°æ®åº“
4. å†™å…¥ç¼“å­˜
5. è¿”å›
```

**å†™æµç¨‹**ï¼š
```
1. æ›´æ–°æ•°æ®åº“
2. åˆ é™¤ç¼“å­˜
```

**ä»£ç ç¤ºä¾‹**ï¼š
```java
// è¯»
public Product getById(Long id) {
    // 1. æŸ¥ç¼“å­˜
    String json = redisTemplate.opsForValue().get("product:" + id);
    if (json != null) {
        return JSON.parseObject(json, Product.class);
    }
    
    // 2. æŸ¥æ•°æ®åº“
    Product product = productMapper.selectById(id);
    
    // 3. å†™ç¼“å­˜
    if (product != null) {
        redisTemplate.opsForValue().set(
            "product:" + id,
            JSON.toJSONString(product),
            1, TimeUnit.HOURS
        );
    }
    
    return product;
}

// å†™
public void update(Product product) {
    // 1. æ›´æ–°æ•°æ®åº“
    productMapper.updateById(product);
    
    // 2. åˆ é™¤ç¼“å­˜
    redisTemplate.delete("product:" + product.getId());
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… ç®€å•æ˜“ç”¨
- âœ… åº”ç”¨å±‚æ§åˆ¶çµæ´»

**ç¼ºç‚¹**ï¼š
- âŒ éœ€è¦åº”ç”¨å±‚ç®¡ç†ç¼“å­˜
- âŒ å¯èƒ½å‡ºç°çŸ­æš‚ä¸ä¸€è‡´

### 6.2 Read-Throughï¼ˆè¯»ç©¿é€ï¼‰

**ç”±ç¼“å­˜å±‚è‡ªåŠ¨åŠ è½½æ•°æ®**

**æµç¨‹**ï¼š
```
åº”ç”¨ â†’ ç¼“å­˜å±‚ â†’ æ•°æ®åº“
       â†‘
   ç¼“å­˜å±‚è‡ªåŠ¨åŠ è½½
```

**ä»£ç ç¤ºä¾‹**ï¼ˆGuava Cacheï¼‰ï¼š
```java
LoadingCache<Long, Product> cache = CacheBuilder.newBuilder()
    .maximumSize(10000)
    .expireAfterWrite(10, TimeUnit.MINUTES)
    .build(new CacheLoader<Long, Product>() {
        @Override
        public Product load(Long id) {
            // ç¼“å­˜å±‚è‡ªåŠ¨åŠ è½½æ•°æ®
            return productMapper.selectById(id);
        }
    });

// åº”ç”¨å±‚åªéœ€è¦è°ƒç”¨get
Product product = cache.get(id);  // ç¼“å­˜æœªå‘½ä¸­æ—¶è‡ªåŠ¨åŠ è½½
```

**ä¼˜ç‚¹**ï¼š
- âœ… åº”ç”¨å±‚ç®€å•
- âœ… ç¼“å­˜åŠ è½½é€»è¾‘ç»Ÿä¸€

**ç¼ºç‚¹**ï¼š
- âŒ ç¼“å­˜å±‚é€»è¾‘å¤æ‚
- âŒ ä¸é€‚åˆRedisï¼ˆRedisä¸æ”¯æŒè‡ªåŠ¨åŠ è½½ï¼‰

### 6.3 Write-Throughï¼ˆå†™ç©¿é€ï¼‰

**ç”±ç¼“å­˜å±‚åŒæ­¥å†™æ•°æ®åº“**

**æµç¨‹**ï¼š
```
åº”ç”¨ â†’ ç¼“å­˜å±‚ â†’ æ•°æ®åº“
       â†“
   ç¼“å­˜å±‚åŒæ­¥å†™å…¥
```

**ä»£ç ç¤ºä¾‹**ï¼š
```java
public void update(Product product) {
    // åº”ç”¨å±‚åªå†™ç¼“å­˜
    cache.put(product.getId(), product);
    
    // ç¼“å­˜å±‚è‡ªåŠ¨åŒæ­¥åˆ°æ•°æ®åº“
}

// ç¼“å­˜å±‚å®ç°
class WriteThroç»§ç»­ughCache {
    public void put(Long id, Product product) {
        // 1. å†™æ•°æ®åº“
        productMapper.updateById(product);
        
        // 2. å†™ç¼“å­˜
        redisTemplate.opsForValue().set(
            "product:" + id,
            JSON.toJSONString(product),
            1, TimeUnit.HOURS
        );
    }
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… ç¼“å­˜å’Œæ•°æ®åº“å¼ºä¸€è‡´

**ç¼ºç‚¹**ï¼š
- âŒ å†™å…¥æ€§èƒ½å·®ï¼ˆåŒæ­¥ï¼‰
- âŒ ä¸é€‚åˆé«˜å¹¶å‘å†™å…¥

### 6.4 Write-Behindï¼ˆå¼‚æ­¥å†™å›ï¼‰

**ç¼“å­˜å±‚å¼‚æ­¥æ‰¹é‡å†™æ•°æ®åº“**

**æµç¨‹**ï¼š
```
åº”ç”¨ â†’ ç¼“å­˜ï¼ˆç«‹å³è¿”å›ï¼‰
       â†“
   å¼‚æ­¥æ‰¹é‡å†™æ•°æ®åº“
```

**ä»£ç ç¤ºä¾‹**ï¼š
```java
@Service
public class ProductService {
    
    private final BlockingQueue<Product> writeQueue = new LinkedBlockingQueue<>(10000);
    
    @PostConstruct
    public void startAsyncWriter() {
        // å¼‚æ­¥æ‰¹é‡å†™å…¥
        ScheduledExecutorService executor = Executors.newScheduledThreadPool(1);
        executor.scheduleAtFixedRate(() -> {
            List<Product> batch = new ArrayList<>();
            writeQueue.drainTo(batch, 100);  // æœ€å¤šå–100ä¸ª
            
            if (!batch.isEmpty()) {
                // æ‰¹é‡å†™æ•°æ®åº“
                productMapper.batchUpdate(batch);
            }
        }, 0, 1, TimeUnit.SECONDS);
    }
    
    public void update(Product product) {
        // 1. å†™ç¼“å­˜
        redisTemplate.opsForValue().set(
            "product:" + product.getId(),
            JSON.toJSONString(product),
            1, TimeUnit.HOURS
        );
        
        // 2. åŠ å…¥å¼‚æ­¥å†™é˜Ÿåˆ—
        writeQueue.offer(product);
    }
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… å†™å…¥æ€§èƒ½æé«˜
- âœ… æ‰¹é‡å†™æ•°æ®åº“

**ç¼ºç‚¹**ï¼š
- âŒ å¯èƒ½ä¸¢å¤±æ•°æ®ï¼ˆå®•æœºï¼‰
- âŒ å®ç°å¤æ‚

### 6.5 æ¨¡å¼é€‰æ‹©

| æ¨¡å¼ | æ€§èƒ½ | ä¸€è‡´æ€§ | å¤æ‚åº¦ | æ¨èåœºæ™¯ |
|------|------|--------|--------|---------|
| **Cache-Aside** | â­â­â­â­ | â­â­â­ | â­ | **é€šç”¨åœºæ™¯ï¼ˆæ¨èï¼‰** |
| **Read-Through** | â­â­â­ | â­â­â­ | â­â­ | æœ¬åœ°ç¼“å­˜ |
| **Write-Through** | â­â­ | â­â­â­â­â­ | â­â­ | å¼ºä¸€è‡´æ€§åœºæ™¯ |
| **Write-Behind** | â­â­â­â­â­ | â­â­ | â­â­â­â­ | é«˜å¹¶å‘å†™å…¥ |

---

## 7. ç¼“å­˜å¸¸è§é—®é¢˜

### 7.1 ç¼“å­˜ç©¿é€

**é—®é¢˜**ï¼šæŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ®ï¼Œç¼“å­˜å’Œæ•°æ®åº“éƒ½æ²¡æœ‰ï¼Œæ¯æ¬¡éƒ½æ‰“åˆ°æ•°æ®åº“

**åœºæ™¯**ï¼š
```
æ¶æ„æ”»å‡»ï¼šæŸ¥è¯¢id=-1çš„ç”¨æˆ·ï¼ˆä¸å­˜åœ¨ï¼‰
â†’ ç¼“å­˜æ²¡æœ‰ â†’ æ•°æ®åº“æ²¡æœ‰ â†’ ç¼“å­˜è¿˜æ˜¯æ²¡æœ‰
â†’ æ¯æ¬¡è¯·æ±‚éƒ½æ‰“åˆ°æ•°æ®åº“
```

**è§£å†³æ–¹æ¡ˆ1ï¼šå¸ƒéš†è¿‡æ»¤å™¨ï¼ˆæ¨èï¼‰**

```java
@Service
public class UserService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    // å¸ƒéš†è¿‡æ»¤å™¨
    private BloomFilter<Long> bloomFilter;
    
    @PostConstruct
    public void init() {
        // åˆå§‹åŒ–å¸ƒéš†è¿‡æ»¤å™¨
        bloomFilter = BloomFilter.create(
            Funnels.longFunnel(),
            10000000,  // é¢„è®¡å…ƒç´ æ•°é‡ï¼š1000ä¸‡
            0.01  // è¯¯åˆ¤ç‡ï¼š1%
        );
        
        // åŠ è½½æ‰€æœ‰ç”¨æˆ·ID
        List<Long> userIds = userMapper.selectAllIds();
        userIds.forEach(bloomFilter::put);
    }
    
    public User getById(Long id) {
        // 1. å¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­
        if (!bloomFilter.mightContain(id)) {
            return null;  // ä¸€å®šä¸å­˜åœ¨
        }
        
        // 2. æŸ¥ç¼“å­˜
        String json = (String) redisTemplate.opsForValue().get("user:" + id);
        if (json != null) {
            return JSON.parseObject(json, User.class);
        }
        
        // 3. æŸ¥æ•°æ®åº“
        User user = userMapper.selectById(id);
        
        // 4. å†™ç¼“å­˜
        if (user != null) {
            redisTemplate.opsForValue().set(
                "user:" + id,
                JSON.toJSONString(user),
                30, TimeUnit.MINUTES
            );
        }
        
        return user;
    }
}
```

**è§£å†³æ–¹æ¡ˆ2ï¼šç¼“å­˜ç©ºå€¼**

```java
public User getById(Long id) {
    // 1. æŸ¥ç¼“å­˜
    String json = (String) redisTemplate.opsForValue().get("user:" + id);
    if (json != null) {
        if ("null".equals(json)) {
            return null;  // ç¼“å­˜çš„ç©ºå€¼
        }
        return JSON.parseObject(json, User.class);
    }
    
    // 2. æŸ¥æ•°æ®åº“
    User user = userMapper.selectById(id);
    
    // 3. å†™ç¼“å­˜ï¼ˆåŒ…æ‹¬ç©ºå€¼ï¼‰
    if (user != null) {
        redisTemplate.opsForValue().set(
            "user:" + id,
            JSON.toJSONString(user),
            30, TimeUnit.MINUTES
        );
    } else {
        // ç¼“å­˜ç©ºå€¼ï¼ˆçŸ­è¿‡æœŸæ—¶é—´ï¼‰
        redisTemplate.opsForValue().set(
            "user:" + id,
            "null",
            5, TimeUnit.MINUTES  // 5åˆ†é’Ÿè¿‡æœŸ
        );
    }
    
    return user;
}
```

### 7.2 ç¼“å­˜å‡»ç©¿

**é—®é¢˜**ï¼šçƒ­ç‚¹æ•°æ®è¿‡æœŸï¼Œå¤§é‡è¯·æ±‚åŒæ—¶æ‰“åˆ°æ•°æ®åº“

**åœºæ™¯**ï¼š
```
çƒ­é—¨å•†å“ç¼“å­˜è¿‡æœŸ
â†’ 10000ä¸ªè¯·æ±‚åŒæ—¶åˆ°è¾¾
â†’ ç¼“å­˜éƒ½æœªå‘½ä¸­
â†’ 10000ä¸ªè¯·æ±‚åŒæ—¶æŸ¥æ•°æ®åº“
â†’ æ•°æ®åº“å´©æºƒ
```

**è§£å†³æ–¹æ¡ˆ1ï¼šäº’æ–¥é”**

```java
public Product getById(Long id) {
    String key = "product:" + id;
    
    // 1. æŸ¥ç¼“å­˜
    String json = redisTemplate.opsForValue().get(key);
    if (json != null) {
        return JSON.parseObject(json, Product.class);
    }
    
    // 2. ç¼“å­˜æœªå‘½ä¸­ï¼Œå°è¯•è·å–é”
    String lockKey = "lock:product:" + id;
    Boolean locked = redisTemplate.opsForValue().setIfAbsent(
        lockKey, 
        "locked", 
        10, TimeUnit.SECONDS
    );
    
    try {
        if (locked) {
            // è·å–é”æˆåŠŸï¼ŒæŸ¥æ•°æ®åº“
            Product product = productMapper.selectById(id);
            
            // å†™ç¼“å­˜
            if (product != null) {
                redisTemplate.opsForValue().set(
                    key,
                    JSON.toJSONString(product),
                    1, TimeUnit.HOURS
                );
            }
            
            return product;
        } else {
            // è·å–é”å¤±è´¥ï¼Œç­‰å¾…åé‡è¯•
            Thread.sleep(50);
            return getById(id);  // é€’å½’é‡è¯•
        }
    } catch (InterruptedException e) {
        throw new RuntimeException(e);
    } finally {
        // é‡Šæ”¾é”
        if (locked) {
            redisTemplate.delete(lockKey);
        }
    }
}
```

**è§£å†³æ–¹æ¡ˆ2ï¼šçƒ­ç‚¹æ•°æ®æ°¸ä¸è¿‡æœŸ**

```java
// ç¼“å­˜ä¸è®¾ç½®è¿‡æœŸæ—¶é—´
redisTemplate.opsForValue().set(key, json);  // æ°¸ä¸è¿‡æœŸ

// å¼‚æ­¥åˆ·æ–°
@Scheduled(fixedRate = 5 * 60 * 1000)  // æ¯5åˆ†é’Ÿåˆ·æ–°
public void refreshHotData() {
    List<Long> hotProductIds = getHotProductIds();  // è·å–çƒ­é—¨å•†å“ID
    
    for (Long id : hotProductIds) {
        Product product = productMapper.selectById(id);
        redisTemplate.opsForValue().set(
            "product:" + id,
            JSON.toJSONString(product)
        );
    }
}
```

### 7.3 ç¼“å­˜é›ªå´©

**é—®é¢˜**ï¼šå¤§é‡ç¼“å­˜åŒæ—¶è¿‡æœŸï¼Œæ•°æ®åº“æ‰¿å—ä¸ä½å‹åŠ›

**åœºæ™¯**ï¼š
```
å‡Œæ™¨2ç‚¹æ‰¹é‡å¯¼å…¥å•†å“ï¼Œç¼“å­˜è¿‡æœŸæ—¶é—´éƒ½æ˜¯1å°æ—¶
â†’ å‡Œæ™¨3ç‚¹ï¼Œæ‰€æœ‰ç¼“å­˜åŒæ—¶è¿‡æœŸ
â†’ æ•°æ®åº“å‹åŠ›æ¿€å¢
â†’ æ•°æ®åº“å´©æºƒ
```

**è§£å†³æ–¹æ¡ˆ1ï¼šè¿‡æœŸæ—¶é—´åŠ éšæœºå€¼**

```java
// âŒ é”™è¯¯
int ttl = 3600;  // æ‰€æœ‰ç¼“å­˜éƒ½æ˜¯1å°æ—¶è¿‡æœŸ

// âœ… æ­£ç¡®
int ttl = 3600 + ThreadLocalRandom.current().nextInt(600);  // 1å°æ—¶ Â± 10åˆ†é’Ÿ
redisTemplate.opsForValue().set(key, value, ttl, TimeUnit.SECONDS);
```

**è§£å†³æ–¹æ¡ˆ2ï¼šå¤šçº§ç¼“å­˜**

```java
// L1æœ¬åœ°ç¼“å­˜å…œåº•
Product product = localCache.getIfPresent(id);
if (product != null) {
    return product;  // RedisæŒ‚äº†ï¼Œæœ¬åœ°ç¼“å­˜ä¹Ÿèƒ½æ‰›ä¸€é˜µ
}

// L2 Redis
String json = redisTemplate.opsForValue().get("product:" + id);
if (json != null) {
    localCache.put(id, JSON.parseObject(json, Product.class));
    return JSON.parseObject(json, Product.class);
}

// L3æ•°æ®åº“
product = productMapper.selectById(id);
```

**è§£å†³æ–¹æ¡ˆ3ï¼šé™æµé™çº§**

```java
@Service
public class ProductService {
    
    @SentinelResource(value = "getProduct", blockHandler = "handleBlock")
    public Product getById(Long id) {
        return productMapper.selectById(id);
    }
    
    // é™æµåçš„é™çº§æ–¹æ³•
    public Product handleBlock(Long id, BlockException ex) {
        // è¿”å›é»˜è®¤å€¼æˆ–ç¼“å­˜çš„æ—§æ•°æ®
        return Product.DEFAULT_PRODUCT;
    }
}
```

---

## 8. ç¼“å­˜ä¸€è‡´æ€§

### 8.1 é—®é¢˜åˆ†æ

**ç¼“å­˜å’Œæ•°æ®åº“ä¸ä¸€è‡´çš„4ç§æƒ…å†µ**ï¼š

| æƒ…å†µ | æ“ä½œé¡ºåº | ç»“æœ |
|------|---------|------|
| 1 | å…ˆåˆ ç¼“å­˜ â†’ æ›´æ–°DB | âœ… æœ€ç»ˆä¸€è‡´ |
| 2 | å…ˆæ›´æ–°DB â†’ åˆ ç¼“å­˜ | âœ… æœ€ç»ˆä¸€è‡´ï¼ˆæ¨èï¼‰ |
| 3 | å…ˆåˆ ç¼“å­˜ â†’ æ›´æ–°DBå¤±è´¥ | âŒ ä¸ä¸€è‡´ |
| 4 | å…ˆæ›´æ–°DB â†’ åˆ ç¼“å­˜å¤±è´¥ | âŒ ä¸ä¸€è‡´ |

### 8.2 ç­–ç•¥1ï¼šå…ˆæ›´æ–°DBï¼Œå†åˆ ç¼“å­˜ï¼ˆæ¨èï¼‰

```java
public void update(Product product) {
    // 1. æ›´æ–°æ•°æ®åº“
    productMapper.updateById(product);
    
    // 2. åˆ é™¤ç¼“å­˜
    String key = "product:" + product.getId();
    redisTemplate.delete(key);
}
```

**ä¸ºä»€ä¹ˆæ˜¯"åˆ é™¤"è€Œä¸æ˜¯"æ›´æ–°"ç¼“å­˜ï¼Ÿ**

```
åˆ é™¤ç¼“å­˜ï¼š
- ç®€å•
- ä¸‹æ¬¡æŸ¥è¯¢æ—¶è‡ªåŠ¨åŠ è½½æœ€æ–°æ•°æ®
- é¿å…ç¼“å­˜æ›´æ–°å¤±è´¥

æ›´æ–°ç¼“å­˜ï¼š
- å¤æ‚ï¼ˆéœ€è¦é‡æ–°æŸ¥è¯¢æˆ–è®¡ç®—ï¼‰
- å¯èƒ½æ›´æ–°å¤±è´¥å¯¼è‡´ä¸ä¸€è‡´
- æµªè´¹ï¼ˆç¼“å­˜å¯èƒ½ä¸ä¼šè¢«è®¿é—®ï¼‰
```

### 8.3 ç­–ç•¥2ï¼šå»¶è¿ŸåŒåˆ 

**è§£å†³å¹¶å‘é—®é¢˜**ï¼š

```
æ—¶é—´çº¿ï¼š
T1: çº¿ç¨‹Aæ›´æ–°DBï¼ˆprice=100ï¼‰
T2: çº¿ç¨‹BæŸ¥è¯¢ï¼Œç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥DBï¼ˆprice=90ï¼Œæ—§æ•°æ®ï¼‰
T3: çº¿ç¨‹Aåˆ é™¤ç¼“å­˜
T4: çº¿ç¨‹Bå†™å…¥ç¼“å­˜ï¼ˆprice=90ï¼Œæ—§æ•°æ®ï¼‰

ç»“æœï¼šç¼“å­˜æ˜¯æ—§æ•°æ®ï¼
```

**è§£å†³æ–¹æ¡ˆï¼šå»¶è¿ŸåŒåˆ **

```java
public void update(Product product) {
    String key = "product:" + product.getId();
    
    // 1. åˆ é™¤ç¼“å­˜
    redisTemplate.delete(key);
    
    // 2. æ›´æ–°æ•°æ®åº“
    productMapper.updateById(product);
    
    // 3. å»¶è¿Ÿåå†æ¬¡åˆ é™¤ç¼“å­˜
    CompletableFuture.runAsync(() -> {
        try {
            Thread.sleep(500);  // å»¶è¿Ÿ500ms
            redisTemplate.delete(key);
        } catch (InterruptedException e) {
            log.error("å»¶è¿Ÿåˆ é™¤ç¼“å­˜å¤±è´¥", e);
        }
    });
}
```

### 8.4 ç­–ç•¥3ï¼šè®¢é˜…Binlogï¼ˆç»ˆææ–¹æ¡ˆï¼‰

**ä½¿ç”¨Canalç›‘å¬MySQL Binlogï¼Œå¼‚æ­¥æ›´æ–°ç¼“å­˜**

```
MySQL Binlog â†’ Canal â†’ MQ â†’ ç¼“å­˜æ›´æ–°æœåŠ¡ â†’ Redis

ä¼˜ç‚¹ï¼š
âœ… è§£è€¦ï¼ˆä¸å½±å“ä¸»æµç¨‹ï¼‰
âœ… å¼‚æ­¥ï¼ˆæ€§èƒ½é«˜ï¼‰
âœ… å¯é ï¼ˆMQä¿è¯ï¼‰

ç¼ºç‚¹ï¼š
âŒ å¤æ‚åº¦é«˜
âŒ æœ‰å»¶è¿Ÿ
```

**ä»£ç ç¤ºä¾‹**ï¼ˆCanalï¼‰ï¼š

```java
@Component
public class CanalClient {
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    @PostConstruct
    public void start() {
        CanalConnector connector = CanalConnectors.newSingleConnector(
            new InetSocketAddress("127.0.0.1", 11111),
            "example",
            "",
            ""
        );
        
        connector.connect();
        connector.subscribe("product");  // è®¢é˜…productè¡¨
        connector.rollback();
        
        while (true) {
            Message message = connector.getWithoutAck(100);
            
            for (CanalEntry.Entry entry : message.getEntries()) {
                if (entry.getEntryType() == CanalEntry.EntryType.ROWDATA) {
                    CanalEntry.RowChange rowChange = CanalEntry.RowChange.parseFrom(entry.getStoreValue());
                    
                    for (CanalEntry.RowData rowData : rowChange.getRowDatasList()) {
                        if (rowChange.getEventType() == CanalEntry.EventType.UPDATE) {
                            // è·å–æ›´æ–°åçš„æ•°æ®
                            Long productId = getProductId(rowData.getAfterColumnsList());
                            
                            // åˆ é™¤ç¼“å­˜
                            redisTemplate.delete("product:" + productId);
                        }
                    }
                }
            }
            
            connector.ack(message.getId());
        }
    }
}
```

---

## 9. æ€§èƒ½ä¼˜åŒ–

### 9.1 æ‰¹é‡æ“ä½œ

**Pipelineï¼ˆç®¡é“ï¼‰**ï¼š

```java
// âŒ é”™è¯¯ï¼š1000æ¬¡ç½‘ç»œå¾€è¿”
for (int i = 0; i < 1000; i++) {
    redisTemplate.opsForValue().set("key:" + i, "value:" + i);
}
// è€—æ—¶ï¼š500ms

// âœ… æ­£ç¡®ï¼šPipelineæ‰¹é‡æ“ä½œ
redisTemplate.executePipelined((RedisCallback<Object>) connection -> {
    for (int i = 0; i < 1000; i++) {
        connection.set(
            ("key:" + i).getBytes(),
            ("value:" + i).getBytes()
        );
    }
    return null;
});
// è€—æ—¶ï¼š5msï¼ˆæå‡100å€ï¼‰
```

**Luaè„šæœ¬**ï¼š

```java
// åŸå­æ€§æ‰¹é‡æ“ä½œ
String luaScript = 
    "for i, key in ipairs(KEYS) do " +
    "    redis.call('set', key, ARGV[i]) " +
    "end " +
    "return 'OK'";

List<String> keys = Arrays.asList("key1", "key2", "key3");
List<String> values = Arrays.asList("value1", "value2", "value3");

redisTemplate.execute(
    new DefaultRedisScript<>(luaScript, String.class),
    keys,
    values.toArray()
);
```

### 9.2 åºåˆ—åŒ–ä¼˜åŒ–

**é€‰æ‹©é«˜æ•ˆçš„åºåˆ—åŒ–æ–¹å¼**ï¼š

```java
// æ€§èƒ½å¯¹æ¯”
JDKåºåˆ—åŒ–ï¼š100ä¸‡æ¬¡ â†’ 5000ms
JSONåºåˆ—åŒ–ï¼š100ä¸‡æ¬¡ â†’ 3000ms
Protobufåºåˆ—åŒ–ï¼š100ä¸‡æ¬¡ â†’ 500ms

// æ¨èï¼šJSONï¼ˆå…¼é¡¾æ€§èƒ½å’Œå¯è¯»æ€§ï¼‰
@Bean
public RedisTemplate<String, Object> redisTemplate() {
    Jackson2JsonRedisSerializer<Object> jsonSerializer = 
        new Jackson2JsonRedisSerializer<>(Object.class);
    
    template.setValueSerializer(jsonSerializer);
    return template;
}
```

### 9.3 å‹ç¼©

**å¤§å¯¹è±¡å‹ç¼©**ï¼š

```java
public void setCompressed(String key, Object value) {
    String json = JSON.toJSONString(value);
    
    // å‹ç¼©
    byte[] compressed = compress(json.getBytes());
    
    // å­˜å‚¨
    redisTemplate.opsForValue().set(key.getBytes(), compressed);
}

public Object getCompressed(String key) {
    byte[] compressed = (byte[]) redisTemplate.opsForValue().get(key.getBytes());
    
    // è§£å‹
    byte[] decompressed = decompress(compressed);
    
    return JSON.parseObject(new String(decompressed), Object.class);
}

private byte[] compress(byte[] data) {
    try (ByteArrayOutputStream bos = new ByteArrayOutputStream();
         GZIPOutputStream gzip = new GZIPOutputStream(bos)) {
        gzip.write(data);
        gzip.finish();
        return bos.toByteArray();
    } catch (IOException e) {
        throw new RuntimeException(e);
    }
}
```

---

## 10. å®æˆ˜æ¡ˆä¾‹

### 10.1 ç”µå•†å•†å“è¯¦æƒ…é¡µç¼“å­˜

**åœºæ™¯**ï¼š
```
å•†å“æ€»æ•°ï¼š1000ä¸‡
çƒ­é—¨å•†å“ï¼š1ä¸‡ä¸ª
å•†å“è¯¦æƒ…QPSï¼š10ä¸‡
è¦æ±‚ï¼šP99å»¶è¿Ÿ < 50ms
```

**æ¶æ„è®¾è®¡**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  L1ï¼šæœ¬åœ°ç¼“å­˜ï¼ˆCaffeineï¼‰        â”‚
â”‚  - ç¼“å­˜Top 100è¶…çº§çƒ­é—¨å•†å“        â”‚
â”‚  - è¿‡æœŸæ—¶é—´ï¼š1åˆ†é’Ÿ               â”‚
â”‚  - å‘½ä¸­ç‡ï¼š20%                   â”‚
â”‚  - å»¶è¿Ÿï¼š<1ms                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ æœªå‘½ä¸­
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  L2ï¼šRedisé›†ç¾¤                   â”‚
â”‚  - ç¼“å­˜Top 10000çƒ­é—¨å•†å“         â”‚
â”‚  - è¿‡æœŸæ—¶é—´ï¼š10åˆ†é’Ÿ + éšæœºå€¼      â”‚
â”‚  - å‘½ä¸­ç‡ï¼š60%                   â”‚
â”‚  - å»¶è¿Ÿï¼š2ms                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ æœªå‘½ä¸­
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  L3ï¼šMySQLè¯»å†™åˆ†ç¦»               â”‚
â”‚  - å…¨é‡æ•°æ®                      â”‚
â”‚  - å‘½ä¸­ç‡ï¼š20%                   â”‚
â”‚  - å»¶è¿Ÿï¼š50ms                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä»£ç å®ç°**ï¼š

```java
@Service
public class ProductService {
    
    // L1ï¼šæœ¬åœ°ç¼“å­˜
    private final Cache<Long, Product> localCache;
    
    // L2ï¼šRedis
    @Autowired
    private StringRedisTemplate redisTemplate;
    
    // L3ï¼šæ•°æ®åº“
    @Autowired
    private ProductMapper productMapper;
    
    public ProductService() {
        this.localCache = Caffeine.newBuilder()
            .maximumSize(100)
            .expireAfterWrite(1, TimeUnit.MINUTES)
            .recordStats()
            .build();
    }
    
    public Product getById(Long id) {
        // 1. L1æœ¬åœ°ç¼“å­˜
        Product product = localCache.getIfPresent(id);
        if (product != null) {
            return product;
        }
        
        // 2. L2 Redis
        String redisKey = "product:" + id;
        String json = redisTemplate.opsForValue().get(redisKey);
        if (json != null) {
            product = JSON.parseObject(json, Product.class);
            localCache.put(id, product);
            return product;
        }
        
        // 3. L3æ•°æ®åº“ï¼ˆäº’æ–¥é”é˜²å‡»ç©¿ï¼‰
        String lockKey = "lock:product:" + id;
        Boolean locked = redisTemplate.opsForValue().setIfAbsent(
            lockKey, "locked", 10, TimeUnit.SECONDS
        );
        
        try {
            if (locked) {
                // è·å–é”æˆåŠŸï¼ŒæŸ¥æ•°æ®åº“
                product = productMapper.selectById(id);
                
                if (product != null) {
                    // å†™Redisï¼ˆè¿‡æœŸæ—¶é—´åŠ éšæœºå€¼ï¼‰
                    int ttl = 600 + ThreadLocalRandom.current().nextInt(120);
                    redisTemplate.opsForValue().set(
                        redisKey,
                        JSON.toJSONString(product),
                        ttl, TimeUnit.SECONDS
                    );
                    
                    // å†™æœ¬åœ°ç¼“å­˜
                    localCache.put(id, product);
                }
                
                return product;
            } else {
                // è·å–é”å¤±è´¥ï¼Œç­‰å¾…åé‡è¯•
                Thread.sleep(50);
                return getById(id);
            }
        } catch (InterruptedException e) {
            throw new RuntimeException(e);
        } finally {
            if (locked) {
                redisTemplate.delete(lockKey);
            }
        }
    }
    
    @Scheduled(fixedRate = 60000)  // æ¯åˆ†é’Ÿç»Ÿè®¡
    public void printStats() {
        CacheStats stats = localCache.stats();
        log.info("æœ¬åœ°ç¼“å­˜å‘½ä¸­ç‡: {}", stats.hitRate());
    }
}
```

**æ€§èƒ½æŒ‡æ ‡**ï¼š
```
QPSï¼š10ä¸‡
å¹³å‡å»¶è¿Ÿï¼š2ms
P99å»¶è¿Ÿï¼š10ms
L1å‘½ä¸­ç‡ï¼š20%
L2å‘½ä¸­ç‡ï¼š60%
L3å‘½ä¸­ç‡ï¼š20%
```

---

## ğŸ¯ æ€»ç»“

### ç¼“å­˜ä½¿ç”¨å†³ç­–

**ä½•æ—¶ä½¿ç”¨ç¼“å­˜**ï¼š
- âœ… QPS > 5000ï¼ˆå¿…é¡»ï¼‰
- âœ… æŸ¥è¯¢è€—æ—¶ > 500msï¼ˆå¿…é¡»ï¼‰
- âœ… æ•°æ®é‡ > 1000ä¸‡ï¼ˆå¼ºçƒˆå»ºè®®ï¼‰
- âœ… è¯»å†™æ¯” > 10:1ï¼ˆé€‚åˆï¼‰

**ç¼“å­˜é€‰å‹**ï¼š
- æœ¬åœ°ç¼“å­˜ï¼šå•æœºã€æ•°æ®é‡å°ï¼ˆ< 1GBï¼‰ã€QPS < 10ä¸‡
- Redisï¼šåˆ†å¸ƒå¼ã€æ•°æ®é‡å¤§ã€QPS > 5ä¸‡
- å¤šçº§ç¼“å­˜ï¼šè¶…é«˜QPSï¼ˆ> 10ä¸‡ï¼‰ã€P99å»¶è¿Ÿè¦æ±‚é«˜ï¼ˆ< 10msï¼‰

**æœ€ä½³å®è·µ**ï¼š
1. è¿‡æœŸæ—¶é—´åŠ éšæœºå€¼ï¼ˆé˜²é›ªå´©ï¼‰
2. çƒ­ç‚¹æ•°æ®äº’æ–¥é”ï¼ˆé˜²å‡»ç©¿ï¼‰
3. å¸ƒéš†è¿‡æ»¤å™¨ï¼ˆé˜²ç©¿é€ï¼‰
4. å…ˆæ›´æ–°DBå†åˆ ç¼“å­˜ï¼ˆä¿è¯ä¸€è‡´æ€§ï¼‰
5. Pipelineæ‰¹é‡æ“ä½œï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
6. JSONåºåˆ—åŒ–ï¼ˆå…¼é¡¾æ€§èƒ½å’Œå¯è¯»æ€§ï¼‰
7. å¤šçº§ç¼“å­˜ï¼ˆæè‡´æ€§èƒ½ï¼‰

### 10.2 ç§’æ€ç³»ç»Ÿç¼“å­˜è®¾è®¡

**åœºæ™¯**ï¼š
```
å•†å“æ•°ï¼š100ä¸ª
å¹¶å‘ï¼š100ä¸‡ç”¨æˆ·åŒæ—¶æŠ¢è´­
åº“å­˜ï¼šæ¯ä¸ªå•†å“1000ä»¶
è¦æ±‚ï¼šä¸è¶…å–ã€é«˜æ€§èƒ½
```

**æ¶æ„è®¾è®¡**ï¼š

```java
@Service
public class SeckillService {
    
    @Autowired
    private StringRedisTemplate redisTemplate;
    
    /**
     * åˆå§‹åŒ–åº“å­˜åˆ°Redis
     */
    public void initStock(Long productId, Integer stock) {
        String key = "seckill:stock:" + productId;
        redisTemplate.opsForValue().set(key, stock.toString());
    }
    
    /**
     * ç§’æ€ï¼ˆåŸºäºRedisåŸå­é€’å‡ï¼‰
     */
    public boolean seckill(Long userId, Long productId) {
        String stockKey = "seckill:stock:" + productId;
        String userKey = "seckill:user:" + productId + ":" + userId;
        
        // 1. åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å·²ç»æŠ¢è´­è¿‡ï¼ˆé˜²æ­¢é‡å¤è´­ä¹°ï¼‰
        Boolean exists = redisTemplate.hasKey(userKey);
        if (Boolean.TRUE.equals(exists)) {
            throw new BusinessException("æ‚¨å·²ç»æŠ¢è´­è¿‡äº†");
        }
        
        // 2. ä½¿ç”¨Luaè„šæœ¬ä¿è¯åŸå­æ€§
        String luaScript = 
            "local stock = redis.call('get', KEYS[1]) " +
            "if tonumber(stock) <= 0 then " +
            "    return 0 " +
            "end " +
            "redis.call('decr', KEYS[1]) " +
            "redis.call('setex', KEYS[2], 86400, '1') " +
            "return 1";
        
        Long result = redisTemplate.execute(
            new DefaultRedisScript<>(luaScript, Long.class),
            Arrays.asList(stockKey, userKey)
        );
        
        if (result != null && result == 1) {
            // 3. æŠ¢è´­æˆåŠŸï¼Œå¼‚æ­¥åˆ›å»ºè®¢å•
            CompletableFuture.runAsync(() -> {
                createOrderAsync(userId, productId);
            });
            
            return true;
        }
        
        return false;
    }
    
    /**
     * å¼‚æ­¥åˆ›å»ºè®¢å•
     */
    private void createOrderAsync(Long userId, Long productId) {
        // å‘é€åˆ°MQï¼Œå¼‚æ­¥å¤„ç†
        rabbitTemplate.convertAndSend("seckill.order", 
            new SeckillOrder(userId, productId));
    }
}
```

**æ€§èƒ½æŒ‡æ ‡**ï¼š
```
QPSï¼š100ä¸‡
å“åº”æ—¶é—´ï¼š<5ms
åº“å­˜å‡†ç¡®æ€§ï¼š100%ï¼ˆRedisåŸå­æ“ä½œä¿è¯ï¼‰
```

### 10.3 æ’è¡Œæ¦œç¼“å­˜è®¾è®¡

**åœºæ™¯**ï¼š
```
æ¸¸æˆç§¯åˆ†æ’è¡Œæ¦œ
ç”¨æˆ·æ•°ï¼š1000ä¸‡
æ›´æ–°é¢‘ç‡ï¼šå®æ—¶
æŸ¥è¯¢é¢‘ç‡ï¼šæ¯ç§’10ä¸‡æ¬¡
```

**å®ç°æ–¹æ¡ˆï¼ˆRedis Sorted Setï¼‰**ï¼š

```java
@Service
public class RankService {
    
    @Autowired
    private StringRedisTemplate redisTemplate;
    
    /**
     * æ›´æ–°åˆ†æ•°
     */
    public void updateScore(Long userId, double score) {
        String key = "rank:score";
        redisTemplate.opsForZSet().add(key, userId.toString(), score);
    }
    
    /**
     * æ‰¹é‡æ›´æ–°åˆ†æ•°ï¼ˆPipelineä¼˜åŒ–ï¼‰
     */
    public void batchUpdateScore(Map<Long, Double> scoreMap) {
        String key = "rank:score";
        
        redisTemplate.executePipelined((RedisCallback<Object>) connection -> {
            scoreMap.forEach((userId, score) -> {
                connection.zAdd(
                    key.getBytes(),
                    score,
                    userId.toString().getBytes()
                );
            });
            return null;
        });
    }
    
    /**
     * è·å–Top N
     */
    public List<UserScore> getTopN(int n) {
        String key = "rank:score";
        
        // æŸ¥è¯¢Top Nï¼ˆåˆ†æ•°ä»é«˜åˆ°ä½ï¼‰
        Set<ZSetOperations.TypedTuple<String>> set = 
            redisTemplate.opsForZSet().reverseRangeWithScores(key, 0, n - 1);
        
        if (set == null) {
            return Collections.emptyList();
        }
        
        return set.stream()
            .map(tuple -> new UserScore(
                Long.parseLong(tuple.getValue()),
                tuple.getScore()
            ))
            .collect(Collectors.toList());
    }
    
    /**
     * è·å–ç”¨æˆ·æ’å
     */
    public Long getUserRank(Long userId) {
        String key = "rank:score";
        
        Long rank = redisTemplate.opsForZSet().reverseRank(key, userId.toString());
        
        return rank != null ? rank + 1 : null;
    }
    
    /**
     * è·å–ç”¨æˆ·å‘¨è¾¹æ’åï¼ˆå‰åå„5åï¼‰
     */
    public List<UserScore> getNearbyRank(Long userId) {
        String key = "rank:score";
        
        Long rank = redisTemplate.opsForZSet().reverseRank(key, userId.toString());
        if (rank == null) {
            return Collections.emptyList();
        }
        
        // è·å–å‰åå„5å
        long start = Math.max(0, rank - 5);
        long end = rank + 5;
        
        Set<ZSetOperations.TypedTuple<String>> set = 
            redisTemplate.opsForZSet().reverseRangeWithScores(key, start, end);
        
        return set.stream()
            .map(tuple -> new UserScore(
                Long.parseLong(tuple.getValue()),
                tuple.getScore()
            ))
            .collect(Collectors.toList());
    }
}
```

### 10.4 Sessionå…±äº«ï¼ˆåˆ†å¸ƒå¼éƒ¨ç½²ï¼‰

**åœºæ™¯**ï¼š
```
ç”¨æˆ·ç™»å½•ä¿¡æ¯
åœ¨çº¿ç”¨æˆ·ï¼š1000ä¸‡
æœåŠ¡å™¨ï¼š100å°
è¦æ±‚ï¼šåˆ†å¸ƒå¼éƒ¨ç½²ï¼ŒSessionå…±äº«
```

**å®ç°æ–¹æ¡ˆï¼ˆRedis + Spring Sessionï¼‰**ï¼š

**ä¾èµ–**ï¼š
```xml
<dependency>
    <groupId>org.springframework.session</groupId>
    <artifactId>spring-session-data-redis</artifactId>
</dependency>
```

**é…ç½®**ï¼š
```yaml
spring:
  session:
    store-type: redis
    timeout: 30m  # Sessionè¿‡æœŸæ—¶é—´
  redis:
    host: localhost
    port: 6379
```

**ä½¿ç”¨**ï¼š
```java
@RestController
public class UserController {
    
    @PostMapping("/login")
    public Result login(@RequestBody LoginRequest request, HttpSession session) {
        // éªŒè¯ç”¨æˆ·åå¯†ç 
        User user = userService.login(request.getUsername(), request.getPassword());
        
        if (user != null) {
            // å­˜å‚¨åˆ°Sessionï¼ˆè‡ªåŠ¨åŒæ­¥åˆ°Redisï¼‰
            session.setAttribute("user", user);
            return Result.success("ç™»å½•æˆåŠŸ");
        }
        
        return Result.fail("ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯");
    }
    
    @GetMapping("/userInfo")
    public Result getUserInfo(HttpSession session) {
        // ä»Sessionè·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆè‡ªåŠ¨ä»Redisè¯»å–ï¼‰
        User user = (User) session.getAttribute("user");
        
        if (user != null) {
            return Result.success(user);
        }
        
        return Result.fail("æœªç™»å½•");
    }
    
    @PostMapping("/logout")
    public Result logout(HttpSession session) {
        // æ¸…é™¤Sessionï¼ˆè‡ªåŠ¨ä»Redisåˆ é™¤ï¼‰
        session.invalidate();
        return Result.success("é€€å‡ºæˆåŠŸ");
    }
}
```

**Rediså­˜å‚¨ç»“æ„**ï¼š
```
spring:session:sessions:xxxxx-xxxxx-xxxxx  # Sessionæ•°æ®
spring:session:sessions:expires:xxxxx      # è¿‡æœŸæ—¶é—´
spring:session:expirations:1234567890      # è¿‡æœŸç´¢å¼•
```

### 10.5 åˆ†å¸ƒå¼é”ç¼“å­˜å®ç°

**åœºæ™¯**ï¼š
```
ç§’æ€åœºæ™¯ï¼Œé˜²æ­¢è¶…å–
åˆ†å¸ƒå¼éƒ¨ç½²
è¦æ±‚ï¼šåŸå­æ€§ã€é«˜æ€§èƒ½
```

**å®ç°æ–¹æ¡ˆï¼ˆRedissonï¼‰**ï¼š

**ä¾èµ–**ï¼š
```xml
<dependency>
    <groupId>org.redisson</groupId>
    <artifactId>redisson-spring-boot-starter</artifactId>
    <version>3.20.0</version>
</dependency>
```

**é…ç½®**ï¼š
```yaml
spring:
  redis:
    host: localhost
    port: 6379
```

**ä½¿ç”¨**ï¼š
```java
@Service
public class OrderService {
    
    @Autowired
    private RedissonClient redissonClient;
    
    public void createOrder(Long productId, Integer quantity) {
        // è·å–åˆ†å¸ƒå¼é”
        RLock lock = redissonClient.getLock("lock:product:" + productId);
        
        try {
            // å°è¯•åŠ é”ï¼ˆæœ€å¤šç­‰å¾…10ç§’ï¼Œé”å®š30ç§’åè‡ªåŠ¨é‡Šæ”¾ï¼‰
            boolean locked = lock.tryLock(10, 30, TimeUnit.SECONDS);
            
            if (locked) {
                // 1. æŸ¥è¯¢åº“å­˜
                Integer stock = productMapper.getStock(productId);
                
                // 2. åˆ¤æ–­åº“å­˜
                if (stock < quantity) {
                    throw new BusinessException("åº“å­˜ä¸è¶³");
                }
                
                // 3. æ‰£å‡åº“å­˜
                productMapper.deductStock(productId, quantity);
                
                // 4. åˆ›å»ºè®¢å•
                orderMapper.insert(new Order(productId, quantity));
            } else {
                throw new BusinessException("ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•");
            }
        } catch (InterruptedException e) {
            throw new RuntimeException(e);
        } finally {
            // é‡Šæ”¾é”
            lock.unlock();
        }
    }
}
```

---

## ğŸ“Š ç¼“å­˜æ¶æ„æ¼”è¿›è·¯çº¿

### é˜¶æ®µ1ï¼šæ— ç¼“å­˜ï¼ˆQPS < 1000ï¼‰

```
åº”ç”¨ â†’ MySQL

é—®é¢˜ï¼šQPSè¾¾åˆ°1000æ—¶ï¼Œæ•°æ®åº“å‹åŠ›å¤§
```

### é˜¶æ®µ2ï¼šå¼•å…¥Redisï¼ˆQPS 1000 ~ 5ä¸‡ï¼‰

```
åº”ç”¨ â†’ Redis â†’ MySQL

æ”¹è¿›ï¼š
âœ… QPSä»1000æå‡åˆ°5ä¸‡
âœ… å“åº”æ—¶é—´ä»100msé™ä½åˆ°5ms
```

### é˜¶æ®µ3ï¼šå¤šçº§ç¼“å­˜ï¼ˆQPS 5ä¸‡ ~ 20ä¸‡ï¼‰

```
åº”ç”¨ â†’ æœ¬åœ°ç¼“å­˜ â†’ Redis â†’ MySQL

æ”¹è¿›ï¼š
âœ… QPSä»5ä¸‡æå‡åˆ°20ä¸‡
âœ… å“åº”æ—¶é—´ä»5msé™ä½åˆ°1ms
âœ… Rediså‹åŠ›é™ä½80%
```

### é˜¶æ®µ4ï¼šè¯»å†™åˆ†ç¦» + å¤šçº§ç¼“å­˜ï¼ˆQPS 20ä¸‡ ~ 50ä¸‡ï¼‰

```
åº”ç”¨ â†’ æœ¬åœ°ç¼“å­˜ â†’ Redisé›†ç¾¤ â†’ MySQLä¸»ä»

æ”¹è¿›ï¼š
âœ… QPSä»20ä¸‡æå‡åˆ°50ä¸‡
âœ… Redisé›†ç¾¤åˆ†æ•£å‹åŠ›
âœ… MySQLè¯»å†™åˆ†ç¦»
```

### é˜¶æ®µ5ï¼šåˆ†åº“åˆ†è¡¨ + å¤šçº§ç¼“å­˜ï¼ˆQPS > 100ä¸‡ï¼‰

```
åº”ç”¨ â†’ æœ¬åœ°ç¼“å­˜ â†’ Redisé›†ç¾¤ â†’ MySQLåˆ†åº“åˆ†è¡¨

æ”¹è¿›ï¼š
âœ… QPSçªç ´100ä¸‡
âœ… æ•°æ®åº“æ°´å¹³æ‰©å±•
âœ… ç¼“å­˜å’Œæ•°æ®åº“éƒ½èƒ½çº¿æ€§æ‰©å±•
```

---

## ğŸ” ç¼“å­˜ç›‘æ§ä¸è¿ç»´

### ç›‘æ§æŒ‡æ ‡

**Redisç›‘æ§**ï¼š
```
1. å†…å­˜ä½¿ç”¨ç‡ï¼ˆ< 80%ï¼‰
2. QPSï¼ˆå®æ—¶ç›‘æ§ï¼‰
3. å‘½ä¸­ç‡ï¼ˆ> 90%ï¼‰
4. æ…¢æŸ¥è¯¢ï¼ˆ> 10msï¼‰
5. è¿æ¥æ•°ï¼ˆ< 80%ï¼‰
6. ç½‘ç»œæµé‡
7. ä¸»ä»å»¶è¿Ÿ
```

**åº”ç”¨å±‚ç›‘æ§**ï¼š
```
1. ç¼“å­˜å‘½ä¸­ç‡ï¼ˆL1ã€L2åˆ†åˆ«ç»Ÿè®¡ï¼‰
2. å¹³å‡å“åº”æ—¶é—´
3. P99å“åº”æ—¶é—´
4. ç¼“å­˜ç©¿é€æ¬¡æ•°
5. ç¼“å­˜å‡»ç©¿æ¬¡æ•°
```

**ç›‘æ§å®ç°ï¼ˆMicrometer + Prometheusï¼‰**ï¼š

```java
@Service
public class ProductService {
    
    private final MeterRegistry meterRegistry;
    private final Counter cacheHitCounter;
    private final Counter cacheMissCounter;
    
    public ProductService(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        
        // ç¼“å­˜å‘½ä¸­è®¡æ•°å™¨
        this.cacheHitCounter = Counter.builder("cache.hit")
            .tag("level", "L1")
            .register(meterRegistry);
        
        // ç¼“å­˜æœªå‘½ä¸­è®¡æ•°å™¨
        this.cacheMissCounter = Counter.builder("cache.miss")
            .tag("level", "L1")
            .register(meterRegistry);
    }
    
    public Product getById(Long id) {
        Product product = localCache.getIfPresent(id);
        
        if (product != null) {
            cacheHitCounter.increment();  // å‘½ä¸­+1
            return product;
        }
        
        cacheMissCounter.increment();  // æœªå‘½ä¸­+1
        
        // æŸ¥è¯¢Redis...
    }
}
```

**Grafana Dashboard**ï¼š
```
é¢æ¿1ï¼šç¼“å­˜å‘½ä¸­ç‡
- L1å‘½ä¸­ç‡
- L2å‘½ä¸­ç‡
- æ€»å‘½ä¸­ç‡

é¢æ¿2ï¼šQPSç›‘æ§
- æ€»QPS
- ç¼“å­˜QPS
- æ•°æ®åº“QPS

é¢æ¿3ï¼šå»¶è¿Ÿç›‘æ§
- å¹³å‡å»¶è¿Ÿ
- P99å»¶è¿Ÿ
- P999å»¶è¿Ÿ

é¢æ¿4ï¼šé”™è¯¯ç›‘æ§
- ç¼“å­˜ç©¿é€æ¬¡æ•°
- ç¼“å­˜å‡»ç©¿æ¬¡æ•°
- ç¼“å­˜é›ªå´©æ¬¡æ•°
```

---

## âš ï¸ å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜1ï¼šç¼“å­˜å‘½ä¸­ç‡ä½

**ç—‡çŠ¶**ï¼š
```
ç¼“å­˜å‘½ä¸­ç‡ï¼š30%ï¼ˆæ­£å¸¸åº”è¯¥ > 80%ï¼‰
æ•°æ®åº“QPSï¼š10000ï¼ˆå¾ˆé«˜ï¼‰
```

**æ’æŸ¥æ­¥éª¤**ï¼š
```
1. æ£€æŸ¥ç¼“å­˜è¿‡æœŸæ—¶é—´æ˜¯å¦å¤ªçŸ­
2. æ£€æŸ¥ç¼“å­˜å®¹é‡æ˜¯å¦å¤ªå°ï¼ˆé¢‘ç¹æ·˜æ±°ï¼‰
3. æ£€æŸ¥æ˜¯å¦æœ‰å¤§é‡å†·æ•°æ®æŸ¥è¯¢
4. æ£€æŸ¥ç¼“å­˜Keyæ˜¯å¦è®¾è®¡åˆç†
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```
1. å»¶é•¿ç¼“å­˜è¿‡æœŸæ—¶é—´
2. å¢åŠ ç¼“å­˜å®¹é‡
3. é¢„çƒ­çƒ­ç‚¹æ•°æ®
4. ä¼˜åŒ–ç¼“å­˜Keyè®¾è®¡
```

### é—®é¢˜2ï¼šç¼“å­˜é›ªå´©

**ç—‡çŠ¶**ï¼š
```
å‡Œæ™¨3ç‚¹ï¼Œæ•°æ®åº“QPSçªç„¶é£™å‡åˆ°10ä¸‡
æ•°æ®åº“å“åº”æ—¶é—´ä»10msæš´å¢åˆ°5ç§’
éƒ¨åˆ†è¯·æ±‚è¶…æ—¶
```

**æ’æŸ¥æ­¥éª¤**ï¼š
```
1. æ£€æŸ¥Redisç›‘æ§ï¼Œæ˜¯å¦å¤§é‡KeyåŒæ—¶è¿‡æœŸ
2. æ£€æŸ¥Redisæ˜¯å¦å®•æœº
3. æ£€æŸ¥ç¼“å­˜è¿‡æœŸæ—¶é—´è®¾ç½®
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```
1. è¿‡æœŸæ—¶é—´åŠ éšæœºå€¼
2. å¤šçº§ç¼“å­˜å…œåº•
3. é™æµé™çº§
4. Redisé›†ç¾¤é«˜å¯ç”¨
```

### é—®é¢˜3ï¼šç¼“å­˜ç©¿é€

**ç—‡çŠ¶**ï¼š
```
è¯·æ±‚ID=-1çš„æ•°æ®ï¼ˆä¸å­˜åœ¨ï¼‰
æ¯æ¬¡éƒ½æ‰“åˆ°æ•°æ®åº“
æ•°æ®åº“æ…¢æŸ¥è¯¢å¢åŠ 
```

**æ’æŸ¥æ­¥éª¤**ï¼š
```
1. æŸ¥çœ‹æ…¢æŸ¥è¯¢æ—¥å¿—ï¼Œå‘ç°å¤§é‡æŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ®
2. æŸ¥çœ‹åº”ç”¨æ—¥å¿—ï¼Œå‘ç°å¼‚å¸¸å‚æ•°
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```
1. å¸ƒéš†è¿‡æ»¤å™¨
2. ç¼“å­˜ç©ºå€¼
3. å‚æ•°æ ¡éªŒ
```

### é—®é¢˜4ï¼šå†…å­˜æº¢å‡º

**ç—‡çŠ¶**ï¼š
```
Rediså†…å­˜ä½¿ç”¨ç‡ï¼š95%
éƒ¨åˆ†Keyè¢«æ·˜æ±°
ç¼“å­˜å‘½ä¸­ç‡ä¸‹é™
```

**æ’æŸ¥æ­¥éª¤**ï¼š
```
1. redis-cli INFO memory  # æŸ¥çœ‹å†…å­˜ä½¿ç”¨
2. redis-cli --bigkeys     # æŸ¥æ‰¾å¤§Key
3. åˆ†æKeyè¿‡æœŸç­–ç•¥
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```
1. å¢åŠ Rediså†…å­˜
2. åˆ é™¤æ— ç”¨Key
3. è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´
4. ä¼˜åŒ–æ•°æ®ç»“æ„ï¼ˆHashä»£æ›¿Stringï¼‰
```

---

## ğŸ“š æ¨èå­¦ä¹ èµ„æº

**ä¹¦ç±**ï¼š
- ã€ŠRedisè®¾è®¡ä¸å®ç°ã€‹- é»„å¥å®
- ã€ŠRediså¼€å‘ä¸è¿ç»´ã€‹- ä»˜ç£Šã€å¼ ç›Šå†›
- ã€Šäº¿çº§æµé‡ç½‘ç«™æ¶æ„æ ¸å¿ƒæŠ€æœ¯ã€‹- å¼ å¼€æ¶›

**å®˜æ–¹æ–‡æ¡£**ï¼š
- [Rediså®˜æ–¹æ–‡æ¡£](https://redis.io/documentation)
- [Caffeine GitHub](https://github.com/ben-manes/caffeine)
- [Redissonå®˜æ–¹æ–‡æ¡£](https://redisson.org/)

**åœ¨çº¿è¯¾ç¨‹**ï¼š
- æå®¢æ—¶é—´ã€ŠRedisæ ¸å¿ƒæŠ€æœ¯ä¸å®æˆ˜ã€‹
- æ…•è¯¾ç½‘ã€ŠRedisä»å…¥é—¨åˆ°é«˜å¯ç”¨ã€‹

---

*æœ€åæ›´æ–°ï¼š2025-10-27*  
*æ–‡æ¡£çŠ¶æ€ï¼šv1.0 å®Œæˆ*  
*ä½œè€…ï¼šæŠ€æœ¯çŸ¥è¯†åº“å›¢é˜Ÿ*

