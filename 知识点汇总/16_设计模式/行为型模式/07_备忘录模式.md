## å¤‡å¿˜å½•æ¨¡å¼ (Memento Pattern)

### æ¦‚è¿°
å¤‡å¿˜å½•æ¨¡å¼ï¼ˆMemento Patternï¼‰åœ¨ä¸ç ´åå°è£…çš„å‰æä¸‹ï¼Œæ•è·ä¸€ä¸ªå¯¹è±¡çš„å†…éƒ¨çŠ¶æ€ï¼Œå¹¶åœ¨è¯¥å¯¹è±¡ä¹‹å¤–ä¿å­˜è¿™ä¸ªçŠ¶æ€ï¼Œä»¥ä¾¿åœ¨éœ€è¦æ—¶èƒ½å°†è¯¥å¯¹è±¡æ¢å¤åˆ°åŸå…ˆä¿å­˜çš„çŠ¶æ€ã€‚å®ƒå±äºè¡Œä¸ºå‹æ¨¡å¼ï¼Œä¹Ÿè¢«ç§°ä¸ºå¿«ç…§æ¨¡å¼ï¼ˆSnapshot Patternï¼‰æˆ–ä»¤ç‰Œæ¨¡å¼ï¼ˆToken Patternï¼‰ã€‚

## ğŸ¯ æ¨¡å¼æ„å›¾

**æ ¸å¿ƒæ€æƒ³**ï¼šåœ¨ä¸æš´éœ²å¯¹è±¡å®ç°ç»†èŠ‚çš„æƒ…å†µä¸‹ï¼Œæ•è·å¹¶ä¿å­˜å¯¹è±¡çš„å†…éƒ¨çŠ¶æ€ï¼Œä»¥ä¾¿åç»­å¯ä»¥å°†å¯¹è±¡æ¢å¤åˆ°å…ˆå‰çŠ¶æ€ã€‚

**è§£å†³çš„é—®é¢˜**ï¼š
- å¦‚ä½•åœ¨ä¸ç ´åå°è£…çš„å‰æä¸‹ä¿å­˜å’Œæ¢å¤å¯¹è±¡çŠ¶æ€
- å¦‚ä½•å®ç°æ’¤é”€/é‡åšåŠŸèƒ½
- å¦‚ä½•é¿å…å¯¹è±¡çŠ¶æ€çš„å¤–éƒ¨æš´éœ²
- å¦‚ä½•ç®€åŒ–å¯¹è±¡çŠ¶æ€ç®¡ç†

**é€‚ç”¨åœºæ™¯**ï¼š
- ğŸ”„ **æ’¤é”€/é‡åšåŠŸèƒ½**ï¼šæ–‡æœ¬ç¼–è¾‘å™¨ã€å›¾å½¢è®¾è®¡è½¯ä»¶ã€IDEç­‰
- ğŸ’¾ **çŠ¶æ€ä¿å­˜ä¸æ¢å¤**ï¼šæ¸¸æˆå­˜æ¡£ã€åº”ç”¨é…ç½®å¤‡ä»½
- ğŸ“‹ **äº‹åŠ¡ç®¡ç†**ï¼šæ•°æ®åº“äº‹åŠ¡å›æ»šæœºåˆ¶
- ğŸ“Š **å¿«ç…§ç³»ç»Ÿ**ï¼šç³»ç»ŸçŠ¶æ€ç›‘æ§ä¸æ¢å¤
- ğŸ“ **è¡¨å•å¡«å†™**ï¼šåˆ†æ­¥è¡¨å•çš„çŠ¶æ€ä¿å­˜
- ğŸ® **æ¸¸æˆå¼€å‘**ï¼šè§’è‰²çŠ¶æ€ä¿å­˜
- ğŸ“± **ç§»åŠ¨åº”ç”¨**ï¼šåº”ç”¨çŠ¶æ€ä¿å­˜ï¼ˆå¦‚æ—‹è½¬å±å¹•æ—¶ï¼‰
- ğŸ”’ **æƒé™ç®¡ç†**ï¼šä¸´æ—¶æƒé™åˆ‡æ¢
- ğŸ“„ **æ–‡æ¡£ç¼–è¾‘**ï¼šç‰ˆæœ¬æ§åˆ¶
- ğŸ§ª **æµ‹è¯•æ¡†æ¶**ï¼šæµ‹è¯•ç”¨ä¾‹çŠ¶æ€ç®¡ç†
- âš™ï¸ **é…ç½®ç®¡ç†**ï¼šç³»ç»Ÿé…ç½®å˜æ›´å›æ»š
- ğŸŒ **æµè§ˆå™¨å†å²**ï¼šç½‘é¡µæµè§ˆå†å²è®°å½•

## ğŸ—ï¸ UMLç±»å›¾

```mermaid
classDiagram
    class Originator {
        -state: String
        +setState(state: String): void
        +getState(): String
        +createMemento(): Memento
        +restoreMemento(memento: Memento): void
    }
    class Memento {
        -state: String
        +Memento(state: String)
        +getState(): String
    }
    class Caretaker {
        -memento: Memento
        -mementoStack: Stack~Memento~
        +saveState(originator: Originator): void
        +restoreState(originator: Originator): void
        +undo(originator: Originator): void
        +redo(originator: Originator): void
    }
    class Client {
    }

    Originator --> Memento: creates
    Caretaker --> Memento: stores
    Client --> Originator
    Client --> Caretaker
```

**æ ¸å¿ƒè§’è‰²**ï¼š
- **Originatorï¼ˆå‘èµ·äººï¼‰**ï¼šåˆ›å»ºä¸€ä¸ªå¤‡å¿˜å½•ï¼Œç”¨ä»¥è®°å½•å½“å‰å¯¹è±¡çš„å†…éƒ¨çŠ¶æ€ï¼Œå¹¶å¯ä½¿ç”¨å¤‡å¿˜å½•æ¢å¤å†…éƒ¨çŠ¶æ€
- **Mementoï¼ˆå¤‡å¿˜å½•ï¼‰**ï¼šå­˜å‚¨Originatorå¯¹è±¡çš„å†…éƒ¨çŠ¶æ€ï¼Œé˜²æ­¢Originatorä»¥å¤–çš„å¯¹è±¡è®¿é—®å¤‡å¿˜å½•
- **Caretakerï¼ˆç®¡ç†è€…ï¼‰**ï¼šè´Ÿè´£ä¿å­˜å¥½å¤‡å¿˜å½•ï¼Œä¸èƒ½å¯¹å¤‡å¿˜å½•çš„å†…å®¹è¿›è¡Œæ“ä½œæˆ–æ£€æŸ¥
- **Clientï¼ˆå®¢æˆ·ç«¯ï¼‰**ï¼šä½¿ç”¨Originatorã€Caretakerè¿›è¡ŒçŠ¶æ€ç®¡ç†

**å¤‡å¿˜å½•æ¨¡å¼å˜ä½“**ï¼š
1. **ç™½ç®±å¤‡å¿˜å½•**ï¼šå¤‡å¿˜å½•å¯¹æ‰€æœ‰å¯¹è±¡å¯è§
2. **é»‘ç®±å¤‡å¿˜å½•**ï¼šå¤‡å¿˜å½•åªå¯¹å‘èµ·äººå¯è§
3. **å¤šçŠ¶æ€å¤‡å¿˜å½•**ï¼šå­˜å‚¨å¯¹è±¡çš„å¤šä¸ªçŠ¶æ€
4. **å¢é‡å¼å¤‡å¿˜å½•**ï¼šåªå­˜å‚¨å¯¹è±¡çŠ¶æ€çš„å˜åŒ–éƒ¨åˆ†
5. **ç‰ˆæœ¬åŒ–å¤‡å¿˜å½•**ï¼šæ”¯æŒå¤šä¸ªç‰ˆæœ¬çš„çŠ¶æ€ç®¡ç†
6. **å¤åˆå¤‡å¿˜å½•**ï¼šå­˜å‚¨å¤æ‚å¯¹è±¡çš„çŠ¶æ€
7. **åŠ å¯†å¤‡å¿˜å½•**ï¼šå¯¹å­˜å‚¨çš„çŠ¶æ€è¿›è¡ŒåŠ å¯†ä¿æŠ¤

## ğŸ’» ä»£ç å®ç°

### 1. åŸºç¡€å®ç°ï¼ˆæ–‡æœ¬ç¼–è¾‘å™¨æ’¤é”€åŠŸèƒ½ï¼‰

```java
// å¤‡å¿˜å½•ç±»
public class Memento {
    private String text;
    private int cursorPosition;
    private long timestamp;

    public Memento(String text, int cursorPosition) {
        this.text = text;
        this.cursorPosition = cursorPosition;
        this.timestamp = System.currentTimeMillis();
    }

    // åªæœ‰Originatorå¯ä»¥è®¿é—®è¿™äº›æ–¹æ³•
    String getText() { return text; }
    int getCursorPosition() { return cursorPosition; }
    long getTimestamp() { return timestamp; }
}

// å‘èµ·äºº - æ–‡æœ¬ç¼–è¾‘å™¨
public class TextEditorOriginator {
    private String text = "";
    private int cursorPosition = 0;

    public void type(String words) {
        text = text.substring(0, cursorPosition) + words + text.substring(cursorPosition);
        cursorPosition += words.length();
    }

    public void moveCursor(int position) {
        cursorPosition = Math.max(0, Math.min(position, text.length()));
    }

    public Memento createMemento() {
        return new Memento(text, cursorPosition);
    }

    public void restoreMemento(Memento memento) {
        this.text = memento.getText();
        this.cursorPosition = memento.getCursorPosition();
    }

    @Override
    public String toString() {
        return String.format("æ–‡æœ¬: '%s', å…‰æ ‡ä½ç½®: %d", text, cursorPosition);
    }
}

// ç®¡ç†è€… - å†å²è®°å½•
public class HistoryCaretaker {
    private Stack<Memento> undoStack = new Stack<>();
    private Stack<Memento> redoStack = new Stack<>();
    private static final int MAX_HISTORY_SIZE = 100;

    public void saveState(TextEditorOriginator editor) {
        // ä¿å­˜å½“å‰çŠ¶æ€åˆ°æ’¤é”€æ ˆ
        undoStack.push(editor.createMemento());
        // é™åˆ¶å†å²è®°å½•å¤§å°
        if (undoStack.size() > MAX_HISTORY_SIZE) {
            undoStack.remove(0);
        }
        // æ¸…ç©ºé‡åšæ ˆ
        redoStack.clear();
    }

    public void undo(TextEditorOriginator editor) {
        if (!undoStack.isEmpty()) {
            // å°†å½“å‰çŠ¶æ€ä¿å­˜åˆ°é‡åšæ ˆ
            redoStack.push(editor.createMemento());
            // ä»æ’¤é”€æ ˆæ¢å¤ä¸Šä¸€ä¸ªçŠ¶æ€
            Memento previousState = undoStack.pop();
            editor.restoreMemento(previousState);
        }
    }

    public void redo(TextEditorOriginator editor) {
        if (!redoStack.isEmpty()) {
            // å°†å½“å‰çŠ¶æ€ä¿å­˜åˆ°æ’¤é”€æ ˆ
            undoStack.push(editor.createMemento());
            // ä»é‡åšæ ˆæ¢å¤ä¸‹ä¸€ä¸ªçŠ¶æ€
            Memento nextState = redoStack.pop();
            editor.restoreMemento(nextState);
        }
    }

    public void clearHistory() {
        undoStack.clear();
        redoStack.clear();
    }

    public int getUndoHistorySize() {
        return undoStack.size();
    }

    public int getRedoHistorySize() {
        return redoStack.size();
    }
}

// å®¢æˆ·ç«¯
public class Client {
    public static void main(String[] args) {
        TextEditorOriginator editor = new TextEditorOriginator();
        HistoryCaretaker caretaker = new HistoryCaretaker();

        System.out.println("åˆå§‹çŠ¶æ€: " + editor);

        // è¾“å…¥æ–‡æœ¬å¹¶ä¿å­˜çŠ¶æ€
        editor.type("Hello ");
        caretaker.saveState(editor);
        System.out.println("è¾“å…¥å: " + editor);

        // ç»§ç»­è¾“å…¥å¹¶ä¿å­˜çŠ¶æ€
        editor.type("World!");
        caretaker.saveState(editor);
        System.out.println("ç»§ç»­è¾“å…¥å: " + editor);

        // æ’¤é”€æ“ä½œ
        caretaker.undo(editor);
        System.out.println("æ’¤é”€å: " + editor);

        // å†æ¬¡æ’¤é”€
        caretaker.undo(editor);
        System.out.println("å†æ¬¡æ’¤é”€å: " + editor);

        // é‡åšæ“ä½œ
        caretaker.redo(editor);
        System.out.println("é‡åšå: " + editor);

        // ç§»åŠ¨å…‰æ ‡å¹¶è¾“å…¥
        editor.moveCursor(5);
        editor.type("beautiful ");
        caretaker.saveState(editor);
        System.out.println("ä¿®æ”¹å: " + editor);
    }
}
```

### 2. é«˜çº§å®ç°ï¼ˆæ¸¸æˆè§’è‰²çŠ¶æ€ä¿å­˜ï¼‰

```java
import java.util.Date;
import java.util.HashMap;
import java.util.Map;
import java.util.Stack;

// è§’è‰²çŠ¶æ€æšä¸¾
enum CharacterState {
    NORMAL, POISONED, BURNING, FROZEN, SLEEPING
}

// è£…å¤‡ç±»
class Equipment {
    private String name;
    private int attackBonus;
    private int defenseBonus;

    public Equipment(String name, int attackBonus, int defenseBonus) {
        this.name = name;
        this.attackBonus = attackBonus;
        this.defenseBonus = defenseBonus;
    }

    // Getters and toString
    public String getName() { return name; }
    public int getAttackBonus() { return attackBonus; }
    public int getDefenseBonus() { return defenseBonus; }

    @Override
    public String toString() {
        return name + "(æ”»å‡»+" + attackBonus + ",é˜²å¾¡+" + defenseBonus + ")";
    }
}

// å¤‡å¿˜å½•æ¥å£
interface Memento {
    long getTimestamp();
    String getSaveName();
}

// è§’è‰²çŠ¶æ€å¤‡å¿˜å½•
class CharacterMemento implements Memento {
    private final String characterName;
    private final int level;
    private final int hp;
    private final int mp;
    private final int experience;
    private final CharacterState state;
    private final Map<String, Equipment> equipment;
    private final long timestamp;
    private final String saveName;

    // ç§æœ‰æ„é€ å™¨ï¼Œç¡®ä¿åªæœ‰Originatorå¯ä»¥åˆ›å»º
    private CharacterMemento(GameCharacter character, String saveName) {
        this.characterName = character.getName();
        this.level = character.getLevel();
        this.hp = character.getHp();
        this.mp = character.getMp();
        this.experience = character.getExperience();
        this.state = character.getState();
        this.equipment = new HashMap<>(character.getEquipment());
        this.timestamp = new Date().getTime();
        this.saveName = saveName;
    }

    // Getters
    public String getCharacterName() { return characterName; }
    public int getLevel() { return level; }
    public int getHp() { return hp; }
    public int getMp() { return mp; }
    public int getExperience() { return experience; }
    public CharacterState getState() { return state; }
    public Map<String, Equipment> getEquipment() { return new HashMap<>(equipment); }
    @Override
    public long getTimestamp() { return timestamp; }
    @Override
    public String getSaveName() { return saveName; }

    // é™æ€å†…éƒ¨ç±»ï¼Œç”¨äºæ„å»ºå¤‡å¿˜å½•
    public static class MementoBuilder {
        private final GameCharacter character;
        private String saveName;

        public MementoBuilder(GameCharacter character) {
            this.character = character;
            this.saveName = "è‡ªåŠ¨ä¿å­˜_" + new Date().getTime();
        }

        public MementoBuilder withSaveName(String saveName) {
            this.saveName = saveName;
            return this;
        }

        public CharacterMemento build() {
            return new CharacterMemento(character, saveName);
        }
    }
}

// æ¸¸æˆè§’è‰²ï¼ˆå‘èµ·äººï¼‰
class GameCharacter {
    private String name;
    private int level;
    private int hp;
    private int mp;
    private int experience;
    private CharacterState state;
    private Map<String, Equipment> equipment;

    public GameCharacter(String name) {
        this.name = name;
        this.level = 1;
        this.hp = 100;
        this.mp = 50;
        this.experience = 0;
        this.state = CharacterState.NORMAL;
        this.equipment = new HashMap<>();
    }

    // æˆ˜æ–—ç›¸å…³æ–¹æ³•
    public void takeDamage(int damage) {
        this.hp = Math.max(0, this.hp - damage);
        if (this.hp == 0) {
            this.state = CharacterState.SLEEPING; // å‡è®¾HPä¸º0è¿›å…¥ç¡çœ çŠ¶æ€
        }
    }

    public void gainExperience(int exp) {
        this.experience += exp;
        // ç®€å•çš„å‡çº§é€»è¾‘
        while (this.experience >= level * 100) {
            levelUp();
        }
    }

    private void levelUp() {
        level++;
        hp = level * 100;
        mp = level * 50;
        experience -= (level - 1) * 100;
        System.out.println(name + "å‡çº§åˆ°" + level + "çº§ï¼");
    }

    public void equip(String slot, Equipment equipment) {
        this.equipment.put(slot, equipment);
    }

    public void changeState(CharacterState newState) {
        this.state = newState;
    }

    // åˆ›å»ºå¤‡å¿˜å½•
    public CharacterMemento createMemento() {
        return new CharacterMemento.MementoBuilder(this).build();
    }

    public CharacterMemento createMemento(String saveName) {
        return new CharacterMemento.MementoBuilder(this)
                .withSaveName(saveName)
                .build();
    }

    // æ¢å¤å¤‡å¿˜å½•
    public void restoreMemento(CharacterMemento memento) {
        this.level = memento.getLevel();
        this.hp = memento.getHp();
        this.mp = memento.getMp();
        this.experience = memento.getExperience();
        this.state = memento.getState();
        this.equipment = new HashMap<>(memento.getEquipment());
        System.out.println(name + "å·²æ¢å¤åˆ°çŠ¶æ€: " + memento.getSaveName());
    }

    // Getters and toString
    public String getName() { return name; }
    public int getLevel() { return level; }
    public int getHp() { return hp; }
    public int getMp() { return mp; }
    public int getExperience() { return experience; }
    public CharacterState getState() { return state; }
    public Map<String, Equipment> getEquipment() { return new HashMap<>(equipment); }

    @Override
    public String toString() {
        StringBuilder sb = new StringBuilder();
        sb.append("è§’è‰²: ").append(name)
          .append(" Lv").append(level)
          .append(" [HP:").append(hp)
          .append(", MP:").append(mp)
          .append(", EXP:").append(experience)
          .append(", çŠ¶æ€:").append(state).append("\n");
        sb.append("è£…å¤‡: ");
        if (equipment.isEmpty()) {
            sb.append("æ— ");
        } else {
            equipment.forEach((slot, eq) -> sb.append(slot).append(":").append(eq).append(" "));
        }
        return sb.toString();
    }
}

// æ¸¸æˆå­˜æ¡£ç®¡ç†å™¨ï¼ˆç®¡ç†è€…ï¼‰
class GameSaveManager {
    private Map<String, Memento> savedGames = new HashMap<>();
    private Stack<Memento> quickSaves = new Stack<>();
    private static final int MAX_QUICK_SAVES = 5;

    public void saveGame(Memento memento) {
        savedGames.put(memento.getSaveName(), memento);
        System.out.println("æ¸¸æˆå·²ä¿å­˜: " + memento.getSaveName());
    }

    public void quickSave(Memento memento) {
        if (quickSaves.size() >= MAX_QUICK_SAVES) {
            quickSaves.remove(0); // ç§»é™¤æœ€æ—©çš„å¿«é€Ÿå­˜æ¡£
        }
        quickSaves.push(memento);
        System.out.println("å¿«é€Ÿå­˜æ¡£å·²åˆ›å»º (" + quickSaves.size() + "/" + MAX_QUICK_SAVES + ")");
    }

    public Memento loadGame(String saveName) {
        return savedGames.get(saveName);
    }

    public Memento loadQuickSave() {
        if (!quickSaves.isEmpty()) {
            return quickSaves.peek();
        }
        return null;
    }

    public Memento undo() {
        if (quickSaves.size() > 1) {
            quickSaves.pop(); // ç§»é™¤å½“å‰çŠ¶æ€
            return quickSaves.peek(); // è¿”å›ä¸Šä¸€ä¸ªçŠ¶æ€
        }
        return null;
    }

    public void listSaves() {
        System.out.println("\nå¯ç”¨å­˜æ¡£:");
        savedGames.keySet().forEach(saveName -> System.out.println("- " + saveName));

        System.out.println("\nå¿«é€Ÿå­˜æ¡£ (" + quickSaves.size() + "):");
        quickSaves.forEach(m -> System.out.println("- å¿«é€Ÿå­˜æ¡£ " + new Date(m.getTimestamp())));
    }
}

// æ¸¸æˆå®¢æˆ·ç«¯
public class GameClient {
    public static void main(String[] args) {
        // åˆ›å»ºæ¸¸æˆè§’è‰²
        GameCharacter hero = new GameCharacter("å‹‡è€…");
        GameSaveManager saveManager = new GameSaveManager();

        System.out.println("=== åˆå§‹çŠ¶æ€ ===");
        System.out.println(hero);

        // è£…å¤‡æ­¦å™¨å’Œ armor
        hero.equip("æ­¦å™¨", new Equipment("é“å‰‘", 10, 0));
        hero.equip(" armor", new Equipment("çš®ç”²", 0, 5));
        saveManager.quickSave(hero.createMemento());

        System.out.println("\n=== è£…å¤‡å ===");
        System.out.println(hero);

        // æˆ˜æ–—è·å¾—ç»éªŒ
        hero.gainExperience(150);
        hero.takeDamage(30);
        saveManager.quickSave(hero.createMemento());

        System.out.println("\n=== æˆ˜æ–—å ===");
        System.out.println(hero);

        // é‡åˆ°å¼ºå¤§æ•Œäºº
        hero.changeState(CharacterState.POISONED);
        hero.takeDamage(80);
        System.out.println("\n=== æˆ˜æ–—é‡é™© ===");
        System.out.println(hero);

        // åŠ è½½å¿«é€Ÿå­˜æ¡£
        Memento lastSave = saveManager.loadQuickSave();
        if (lastSave instanceof CharacterMemento) {
            hero.restoreMemento((CharacterMemento) lastSave);
        }

        System.out.println("\n=== åŠ è½½å­˜æ¡£å ===");
        System.out.println(hero);

        // åˆ›å»ºå‘½åå­˜æ¡£
        saveManager.saveGame(hero.createMemento("å‡†å¤‡æŒ‘æˆ˜BOSS"));

        // ç»§ç»­å†’é™©
        hero.equip("æ­¦å™¨", new Equipment("é’¢å‰‘", 20, 0));
        hero.gainExperience(300);
        saveManager.quickSave(hero.createMemento());

        System.out.println("\n=== ç»§ç»­å†’é™©å ===");
        System.out.println(hero);

        // åˆ—å‡ºæ‰€æœ‰å­˜æ¡£
        saveManager.listSaves();
    }
}
```

## ğŸ” æºç åº”ç”¨

### Javaä¸­çš„å¤‡å¿˜å½•æ¨¡å¼
- **`java.util.Date`**ï¼š`clone()`æ–¹æ³•å®ç°äº†ç®€å•çš„å¤‡å¿˜å½•åŠŸèƒ½
- **`java.io.Serializable`**ï¼šå¯¹è±¡åºåˆ—åŒ–æœ¬è´¨ä¸Šæ˜¯ä¸€ç§å¤‡å¿˜å½•å®ç°
- **`java.util.Stack`**ï¼šæ ˆç»“æ„å¸¸ç”¨äºå®ç°æ’¤é”€åŠŸèƒ½
- **`javax.swing.undo.UndoManager`**ï¼šSwingä¸­çš„æ’¤é”€ç®¡ç†å™¨
- **`java.beans.XMLEncoder`/`XMLDecoder`**ï¼šå¯¹è±¡XMLåºåˆ—åŒ–

```java
// Java Swingä¸­çš„UndoManagerä½¿ç”¨ç¤ºä¾‹
import javax.swing.*;
import javax.swing.undo.UndoManager;
import java.awt.*;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;

public class TextEditorWithUndo extends JFrame {
    private JTextArea textArea;
    private UndoManager undoManager;

    public TextEditorWithUndo() {
        super("å¸¦æ’¤é”€åŠŸèƒ½çš„æ–‡æœ¬ç¼–è¾‘å™¨");
        setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
        setSize(400, 300);

        textArea = new JTextArea();
        undoManager = new UndoManager();
        textArea.getDocument().addUndoableEditListener(undoManager);

        JMenuBar menuBar = new JMenuBar();
        JMenu editMenu = new JMenu("ç¼–è¾‘");

        JMenuItem undoItem = new JMenuItem("æ’¤é”€");
        undoItem.addActionListener(e -> {
            if (undoManager.canUndo()) {
                undoManager.undo();
            }
        });

        JMenuItem redoItem = new JMenuItem("é‡åš");
        redoItem.addActionListener(e -> {
            if (undoManager.canRedo()) {
                undoManager.redo();
            }
        });

        editMenu.add(undoItem);
        editMenu.add(redoItem);
        menuBar.add(editMenu);
        setJMenuBar(menuBar);

        add(new JScrollPane(textArea), BorderLayout.CENTER);
        setVisible(true);
    }

    public static void main(String[] args) {
        new TextEditorWithUndo();
    }
}
```

### Springæ¡†æ¶ä¸­çš„åº”ç”¨
- **`org.springframework.batch.item.ExecutionContext`**ï¼šæ‰¹å¤„ç†æ‰§è¡Œä¸Šä¸‹æ–‡
- **`org.springframework.webflow.execution.RequestContext`**ï¼šWebæµç¨‹çŠ¶æ€ç®¡ç†
- **`org.springframework.statemachine.StateMachine`**ï¼šçŠ¶æ€æœºçŠ¶æ€ç®¡ç†
- **`org.springframework.orm.hibernate5.SpringSessionContext`**ï¼šHibernateä¼šè¯ç®¡ç†
- **`org.springframework.transaction.support.TransactionSynchronizationManager`**ï¼šäº‹åŠ¡åŒæ­¥ç®¡ç†

```java
// Spring Batch ExecutionContextç¤ºä¾‹
public class OrderItemWriter implements ItemWriter<Order> {
    private ExecutionContext executionContext;

    @BeforeStep
    public void beforeStep(StepExecution stepExecution) {
        // è·å–æ‰§è¡Œä¸Šä¸‹æ–‡ï¼ˆå¯ä»¥ç†è§£ä¸ºä¸€ç§å¤‡å¿˜å½•ï¼‰
        this.executionContext = stepExecution.getExecutionContext();
        // ä»ä¸Šä¸‹æ–‡æ¢å¤çŠ¶æ€
        if (executionContext.containsKey("lastProcessedOrderId")) {
            Long lastId = executionContext.getLong("lastProcessedOrderId");
            System.out.println("ä»ä¸Šæ¬¡ä¸­æ–­å¤„æ¢å¤å¤„ç†: " + lastId);
        }
    }

    @Override
    public void write(List<? extends Order> items) throws Exception {
        for (Order order : items) {
            // å¤„ç†è®¢å•
            processOrder(order);
            // ä¿å­˜å½“å‰çŠ¶æ€åˆ°æ‰§è¡Œä¸Šä¸‹æ–‡
            executionContext.putLong("lastProcessedOrderId", order.getId());
        }
    }

    private void processOrder(Order order) {
        // è®¢å•å¤„ç†é€»è¾‘
        System.out.println("å¤„ç†è®¢å•: " + order.getId());
    }
}
```

### å…¶ä»–æ¡†æ¶ä¸­çš„åº”ç”¨
- **Gitç‰ˆæœ¬æ§åˆ¶**ï¼šæäº¤å†å²æœ¬è´¨ä¸Šæ˜¯å¤‡å¿˜å½•çš„é›†åˆ
- **Eclipse IDE**ï¼šå·¥ä½œåŒºçŠ¶æ€ä¿å­˜
- **Android onSaveInstanceState()**ï¼šActivityçŠ¶æ€ä¿å­˜
- **ReactçŠ¶æ€ç®¡ç†**ï¼šReduxçš„æ—¶é—´æ—…è¡Œè°ƒè¯•
- **Vuex**ï¼šVueçŠ¶æ€ç®¡ç†çš„å¿«ç…§åŠŸèƒ½
- **Underscore.js**ï¼š`_.clone()`æ–¹æ³•
- **jQuery**ï¼š`.data()`æ–¹æ³•å­˜å‚¨çŠ¶æ€
- **Word/Excel**ï¼šæ–‡æ¡£å†å²è®°å½•
- **Photoshop**ï¼šå›¾å±‚å†å²è®°å½•
- **IntelliJ IDEA**ï¼šæœ¬åœ°å†å²è®°å½•åŠŸèƒ½

```javascript
// Reduxä¸­çš„æ—¶é—´æ—…è¡Œè°ƒè¯•ï¼ˆå¤‡å¿˜å½•æ¨¡å¼åº”ç”¨ï¼‰
import { createStore } from 'redux';

// å®šä¹‰reducer
function counter(state = { value: 0 }, action) {
  switch (action.type) {
    case 'INCREMENT':
      return { value: state.value + 1 };
    case 'DECREMENT':
      return { value: state.value - 1 };
    default:
      return state;
  }
}

// åˆ›å»ºstore
let store = createStore(counter);

// å¯ä»¥é€šè¿‡store.getState()è·å–å½“å‰çŠ¶æ€
// Redux DevToolsé€šè¿‡ä¿å­˜æ¯æ¬¡çŠ¶æ€å˜åŒ–å®ç°æ—¶é—´æ—…è¡Œè°ƒè¯•
// è¿™æœ¬è´¨ä¸Šå°±æ˜¯å¤‡å¿˜å½•æ¨¡å¼çš„åº”ç”¨
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å†…å­˜æ¶ˆè€—**ï¼šå¦‚æœé¢‘ç¹åˆ›å»ºå¤‡å¿˜å½•æˆ–å¤‡å¿˜å½•è¿‡å¤§ï¼Œå¯èƒ½å¯¼è‡´å†…å­˜é—®é¢˜

2. **å°è£…ç ´åé£é™©**ï¼šå¦‚æœå¤‡å¿˜å½•æš´éœ²äº†å†…éƒ¨çŠ¶æ€ï¼Œä¼šç ´åå°è£…æ€§

3. **æ€§èƒ½å¼€é”€**ï¼šåˆ›å»ºå’Œæ¢å¤å¤§å‹å¯¹è±¡çš„å¤‡å¿˜å½•å¯èƒ½å½±å“æ€§èƒ½

4. **çŠ¶æ€ä¸€è‡´æ€§**ï¼šéœ€è¦ç¡®ä¿å¤‡å¿˜å½•åŒ…å«å¯¹è±¡çš„å®Œæ•´çŠ¶æ€

5. **æ·±æ‹·è´é—®é¢˜**ï¼šå¯¹äºå¤æ‚å¯¹è±¡ï¼Œéœ€è¦æ­£ç¡®å®ç°æ·±æ‹·è´

6. **å®‰å…¨é—®é¢˜**ï¼šæ•æ„ŸçŠ¶æ€å¯èƒ½é€šè¿‡å¤‡å¿˜å½•æ³„éœ²

7. **ç‰ˆæœ¬å…¼å®¹æ€§**ï¼šä¸åŒç‰ˆæœ¬é—´çš„å¤‡å¿˜å½•å¯èƒ½ä¸å…¼å®¹

8. **å­˜å‚¨ç®¡ç†**ï¼šéœ€è¦åˆç†ç®¡ç†å¤‡å¿˜å½•çš„ç”Ÿå‘½å‘¨æœŸ

## ğŸ“ æœ€ä½³å®è·µ

1. **æœ€å°åŒ–å¤‡å¿˜å½•å†…å®¹**ï¼šåªå­˜å‚¨å¿…è¦çš„çŠ¶æ€ä¿¡æ¯

```java
// ä¼˜åŒ–å¤‡å¿˜å½•å¤§å°ç¤ºä¾‹
public Memento createMemento() {
    // åªä¿å­˜å˜åŒ–çš„çŠ¶æ€ï¼Œè€Œä¸æ˜¯å®Œæ•´å¯¹è±¡
    return new Memento(this.id, this.modifiedFields, this.version);
}
```

2. **ä½¿ç”¨æ¥å£éš”ç¦»**ï¼šé™åˆ¶å¯¹å¤‡å¿˜å½•å†…å®¹çš„è®¿é—®

```java
// æ¥å£éš”ç¦»ç¤ºä¾‹
public interface ReadOnlyMemento {
    long getTimestamp();
}

public class ConcreteMemento implements ReadOnlyMemento {
    private String state;
    private long timestamp;

    // åªæœ‰Originatorå¯ä»¥è®¿é—®å®Œæ•´çŠ¶æ€
    public String getState() { return state; }

    // å…¬å¼€æ¥å£åªæä¾›æœ‰é™ä¿¡æ¯
    @Override
    public long getTimestamp() { return timestamp; }
}
```

3. **å®ç°æ·±æ‹·è´**ï¼šç¡®ä¿å¤‡å¿˜å½•çŠ¶æ€çš„ç‹¬ç«‹æ€§

```java
// æ·±æ‹·è´å®ç°ç¤ºä¾‹
public class DeepCopyMemento {
    private ComplexObject state;

    public DeepCopyMemento(ComplexObject state) {
        // å®ç°æ·±æ‹·è´
        this.state = state.deepCopy();
    }
}
```

4. **ä½¿ç”¨åŸå‹æ¨¡å¼**ï¼šç»“åˆåŸå‹æ¨¡å¼å®ç°é«˜æ•ˆçš„å¤‡å¿˜å½•åˆ›å»º

5. **é™åˆ¶å¤‡å¿˜å½•æ•°é‡**ï¼šè®¾ç½®æœ€å¤§å¤‡å¿˜å½•æ•°é‡ï¼Œé¿å…å†…å­˜æº¢å‡º

6. **æä¾›æ¸…ç†æœºåˆ¶**ï¼šåŠæ—¶æ¸…ç†ä¸å†éœ€è¦çš„å¤‡å¿˜å½•

7. **ä½¿ç”¨åºåˆ—åŒ–**ï¼šå¯¹äºå¤æ‚å¯¹è±¡ï¼Œè€ƒè™‘ä½¿ç”¨åºåˆ—åŒ–ä¿å­˜çŠ¶æ€

8. **ç‰ˆæœ¬æ§åˆ¶**ï¼šä¸ºå¤‡å¿˜å½•æ·»åŠ ç‰ˆæœ¬ä¿¡æ¯ï¼Œæ”¯æŒå‘å‰/å‘åå…¼å®¹

9. **åŠ å¯†æ•æ„Ÿä¿¡æ¯**ï¼šå¯¹åŒ…å«æ•æ„Ÿæ•°æ®çš„å¤‡å¿˜å½•è¿›è¡ŒåŠ å¯†

10. **æä¾›å…ƒæ•°æ®**ï¼šä¸ºå¤‡å¿˜å½•æ·»åŠ æ—¶é—´æˆ³ã€ç‰ˆæœ¬å·ç­‰å…ƒæ•°æ®

## ğŸ“š ç›¸å…³æ¨¡å¼

- **çŠ¶æ€æ¨¡å¼**ï¼šéƒ½æ¶‰åŠå¯¹è±¡çŠ¶æ€ç®¡ç†ï¼Œä½†çŠ¶æ€æ¨¡å¼å…³æ³¨çŠ¶æ€å˜åŒ–æ—¶çš„è¡Œä¸ºæ”¹å˜ï¼Œå¤‡å¿˜å½•æ¨¡å¼å…³æ³¨çŠ¶æ€çš„ä¿å­˜ä¸æ¢å¤
- **åŸå‹æ¨¡å¼**ï¼šéƒ½æ¶‰åŠå¯¹è±¡æ‹·è´ï¼ŒåŸå‹æ¨¡å¼å…³æ³¨å¯¹è±¡å¤åˆ¶ï¼Œå¤‡å¿˜å½•æ¨¡å¼å…³æ³¨çŠ¶æ€ä¿å­˜
- **å‘½ä»¤æ¨¡å¼**ï¼šéƒ½å¯ç”¨äºå®ç°æ’¤é”€åŠŸèƒ½ï¼Œå‘½ä»¤æ¨¡å¼è®°å½•æ“ä½œï¼Œå¤‡å¿˜å½•æ¨¡å¼è®°å½•çŠ¶æ€
- **è¿­ä»£å™¨æ¨¡å¼**ï¼šå¯ä»¥ç»“åˆä½¿ç”¨æ¥éå†å¤‡å¿˜å½•å†å²
- **å•ä¾‹æ¨¡å¼**ï¼šç®¡ç†è€…(Caretaker)é€šå¸¸å®ç°ä¸ºå•ä¾‹
- **ç»„åˆæ¨¡å¼**ï¼šç”¨äºå­˜å‚¨å¤æ‚å¯¹è±¡çš„å¤‡å¿˜å½•
- **è£…é¥°å™¨æ¨¡å¼**ï¼šå¯ä»¥ä¸ºå¤‡å¿˜å½•æ·»åŠ é¢å¤–åŠŸèƒ½
- **ä»£ç†æ¨¡å¼**ï¼šæ§åˆ¶å¯¹å¤‡å¿˜å½•çš„è®¿é—®
- **ç­–ç•¥æ¨¡å¼**ï¼šä¸åŒçš„å¤‡å¿˜å½•å­˜å‚¨ç­–ç•¥