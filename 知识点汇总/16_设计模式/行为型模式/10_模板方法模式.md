# æ¨¡æ¿æ–¹æ³•æ¨¡å¼ï¼ˆTemplate Method Patternï¼‰

> å®šä¹‰ç®—æ³•éª¨æ¶ï¼Œå°†æŸäº›æ­¥éª¤å»¶è¿Ÿåˆ°å­ç±»ä¸­å®ç°

---

## ğŸ“‹ åŸºæœ¬ä¿¡æ¯

- **ç±»å‹**: è¡Œä¸ºå‹æ¨¡å¼
- **éš¾åº¦**: â­â­
- **ä½¿ç”¨é¢‘ç‡**: â­â­â­â­â­
- **å…³é”®è¯**: ç®—æ³•æ¡†æ¶ã€Hookæ–¹æ³•ã€ä»£ç å¤ç”¨

---

## ğŸ¯ æ¨¡å¼æ„å›¾

**æ ¸å¿ƒæ€æƒ³**ï¼šå®šä¹‰ä¸€ä¸ªæ“ä½œä¸­çš„ç®—æ³•éª¨æ¶ï¼Œå°†æŸäº›æ­¥éª¤å»¶è¿Ÿåˆ°å­ç±»ä¸­å®ç°ã€‚æ¨¡æ¿æ–¹æ³•ä½¿å¾—å­ç±»å¯ä»¥ä¸æ”¹å˜ç®—æ³•çš„ç»“æ„å³å¯é‡å®šä¹‰è¯¥ç®—æ³•çš„æŸäº›ç‰¹å®šæ­¥éª¤ã€‚

**è§£å†³çš„é—®é¢˜**ï¼š
- å¦‚ä½•åœ¨ä¿æŒç®—æ³•æ•´ä½“ç»“æ„ä¸å˜çš„å‰æä¸‹ï¼Œå…è®¸å­ç±»å®šåˆ¶ç®—æ³•ä¸­çš„ç‰¹å®šæ­¥éª¤
- å¦‚ä½•æå–ç±»åº“ä¸­å…¬å…±çš„è¡Œä¸ºï¼Œé¿å…ä»£ç é‡å¤
- å¦‚ä½•æ§åˆ¶å­ç±»æ‰©å±•ï¼Œåªå…è®¸ç‰¹å®šæ–¹æ³•è¢«é‡å†™
- å¦‚ä½•å®ç°"å¥½è±ååŸåˆ™"ï¼ˆDon't call us, we'll call youï¼‰

**é€‚ç”¨åœºæ™¯**ï¼š
- å½“å¤šä¸ªç±»çš„ç®—æ³•å…·æœ‰ç›¸åŒçš„ç»“æ„ï¼Œä½†æŸäº›å…·ä½“æ­¥éª¤å®ç°ä¸åŒæ—¶
- å½“éœ€è¦æ§åˆ¶å­ç±»æ‰©å±•ï¼Œåªå…è®¸ç‰¹å®šæ–¹æ³•è¢«é‡å†™æ—¶
- å½“éœ€è¦åœ¨ç±»åº“ä¸­æä¾›ä¸€ä¸ªæ ‡å‡†ç®—æ³•æ¡†æ¶ï¼ŒåŒæ—¶å…è®¸ç”¨æˆ·è‡ªå®šä¹‰éƒ¨åˆ†æ­¥éª¤æ—¶
- å½“éœ€è¦å®ç°åå‘æ§åˆ¶ï¼ˆIoCï¼‰ï¼Œç”±çˆ¶ç±»è°ƒç”¨å­ç±»çš„æ“ä½œæ—¶

## ğŸ—ï¸ UMLç±»å›¾

```mermaid
classDiagram
    class AbstractClass {
        +templateMethod()
        #primitiveOperation1()
        #primitiveOperation2()
        #concreteOperation()
        #hookOperation()
    }
    class ConcreteClassA {
        #primitiveOperation1()
        #primitiveOperation2()
    }
    class ConcreteClassB {
        #primitiveOperation1()
        #primitiveOperation2()
        #hookOperation()
    }

    AbstractClass <|-- ConcreteClassA
    AbstractClass <|-- ConcreteClassB
```

**æ ¸å¿ƒè§’è‰²**ï¼š
- **AbstractClassï¼ˆæŠ½è±¡ç±»ï¼‰**ï¼šå®šä¹‰ç®—æ³•éª¨æ¶ï¼ŒåŒ…å«æ¨¡æ¿æ–¹æ³•å’ŒåŸè¯­æ“ä½œ
  - **æ¨¡æ¿æ–¹æ³•ï¼ˆTemplate Methodï¼‰**ï¼šå®šä¹‰ç®—æ³•çš„æ­¥éª¤å’Œé¡ºåº
  - **åŸè¯­æ“ä½œï¼ˆPrimitive Operationsï¼‰**ï¼šæŠ½è±¡æ–¹æ³•ï¼Œç”±å­ç±»å®ç°
  - **å…·ä½“æ“ä½œï¼ˆConcrete Operationsï¼‰**ï¼šçˆ¶ç±»å®ç°çš„å›ºå®šæ­¥éª¤
  - **é’©å­æ“ä½œï¼ˆHook Operationsï¼‰**ï¼šå¯é€‰çš„æ‰©å±•ç‚¹ï¼Œå­ç±»å¯é‡å†™
- **ConcreteClassï¼ˆå…·ä½“å­ç±»ï¼‰**ï¼šå®ç°æŠ½è±¡ç±»ä¸­çš„åŸè¯­æ“ä½œï¼Œå®šåˆ¶ç®—æ³•çš„ç‰¹å®šæ­¥éª¤

## ğŸ’» ä»£ç å®ç°

### 1. åŸºç¡€å®ç°ï¼ˆé¥®æ–™åˆ¶ä½œæµç¨‹ï¼‰

```java
// æŠ½è±¡ç±» - å®šä¹‰æ¨¡æ¿æ–¹æ³•å’ŒåŸºæœ¬æ­¥éª¤
public abstract class BeverageMakingTemplate {
    /**
     * æ¨¡æ¿æ–¹æ³• - å®šä¹‰ç®—æ³•éª¨æ¶
     */
    public final void makeBeverage() {
        boilWater();          // å…¬å…±æ­¥éª¤ï¼šç…®æ°´
        brew();               // æŠ½è±¡æ­¥éª¤ï¼šå†²æ³¡
        pourInCup();          // å…¬å…±æ­¥éª¤ï¼šå€’å…¥æ¯ä¸­
        if (customerWantsCondiments()) { // é’©å­æ–¹æ³•ï¼šåˆ¤æ–­æ˜¯å¦éœ€è¦è°ƒæ–™
            addCondiments();  // æŠ½è±¡æ­¥éª¤ï¼šæ·»åŠ è°ƒæ–™
        }
       	System.out.println("é¥®æ–™åˆ¶ä½œå®Œæˆï¼");
    }

    /**
     * åŸè¯­æ“ä½œ - å†²æ³¡
     */
    protected abstract void brew();

    /**
     * åŸè¯­æ“ä½œ - æ·»åŠ è°ƒæ–™
     */
    protected abstract void addCondiments();

    /**
     * å…·ä½“æ“ä½œ - ç…®æ°´
     */
    private void boilWater() {
        System.out.println("ç…®æ°´è‡³100Â°C");
    }

    /**
     * å…·ä½“æ“ä½œ - å€’å…¥æ¯ä¸­
     */
    private void pourInCup() {
        System.out.println("å°†é¥®æ–™å€’å…¥æ¯ä¸­");
    }

    /**
     * é’©å­æ–¹æ³• - æ˜¯å¦éœ€è¦è°ƒæ–™
     * é»˜è®¤è¿”å›true
     */
    protected boolean customerWantsCondiments() {
        return true;
    }
}

// å…·ä½“å­ç±» - å’–å•¡
public class Coffee extends BeverageMakingTemplate {
    @Override
    protected void brew() {
        System.out.println("ç”¨æ²¸æ°´å†²æ³¡å’–å•¡ç²‰");
    }

    @Override
    protected void addCondiments() {
        System.out.println("æ·»åŠ ç³–å’Œç‰›å¥¶");
    }

    /**
     * é‡å†™é’©å­æ–¹æ³• - è¯¢é—®ç”¨æˆ·æ˜¯å¦éœ€è¦è°ƒæ–™
     */
    @Override
    protected boolean customerWantsCondiments() {
        String answer = getUserInput();
        return answer.toLowerCase().startsWith("y");
    }

    private String getUserInput() {
        System.out.print("è¯·é—®éœ€è¦æ·»åŠ ç³–å’Œç‰›å¥¶å—ï¼Ÿ(y/n): ");
        Scanner scanner = new Scanner(System.in);
        return scanner.nextLine();
    }
}

// å…·ä½“å­ç±» - èŒ¶
public class Tea extends BeverageMakingTemplate {
    @Override
    protected void brew() {
        System.out.println("ç”¨æ²¸æ°´æµ¸æ³¡èŒ¶å¶");
    }

    @Override
    protected void addCondiments() {
        System.out.println("æ·»åŠ æŸ æª¬");
    }

    /**
     * é‡å†™é’©å­æ–¹æ³• - é»˜è®¤ä¸éœ€è¦è°ƒæ–™
     */
    @Override
    protected boolean customerWantsCondiments() {
        return false; // é»˜è®¤ä¸åŠ æŸ æª¬
    }
}

// å®¢æˆ·ç«¯
public class BeverageClient {
    public static void main(String[] args) {
        BeverageMakingTemplate coffee = new Coffee();
        BeverageMakingTemplate tea = new Tea();

        System.out.println("åˆ¶ä½œå’–å•¡:");
        coffee.makeBeverage();

        System.out.println("\nåˆ¶ä½œèŒ¶:");
        tea.makeBeverage();
    }
}
```

### 2. é«˜çº§å®ç°ï¼ˆæ•°æ®å¤„ç†æ¡†æ¶ï¼‰

```java
import java.util.List;
import java.util.function.Predicate;

// æŠ½è±¡æ•°æ®å¤„ç†å™¨
public abstract class DataProcessorTemplate<T> {
    /**
     * æ¨¡æ¿æ–¹æ³• - æ•°æ®å¤„ç†æµç¨‹
     */
    public final void processData() {
        List<T> rawData = readData();
        validateData(rawData);
        List<T> filteredData = filterData(rawData);
        List<T> processedData = transformData(filteredData);
        writeData(processedData);
        postProcessing();
    }

    /**
     * è¯»å–æ•°æ® - æŠ½è±¡æ–¹æ³•
     */
    protected abstract List<T> readData();

    /**
     * è½¬æ¢æ•°æ® - æŠ½è±¡æ–¹æ³•
     */
    protected abstract List<T> transformData(List<T> data);

    /**
     * å†™å…¥æ•°æ® - æŠ½è±¡æ–¹æ³•
     */
    protected abstract void writeData(List<T> data);

    /**
     * éªŒè¯æ•°æ® - å…·ä½“æ–¹æ³•
     */
    private void validateData(List<T> data) {
        if (data == null || data.isEmpty()) {
            throw new IllegalArgumentException("è¾“å…¥æ•°æ®ä¸èƒ½ä¸ºç©º");
        }
        System.out.println("æ•°æ®éªŒè¯é€šè¿‡ï¼Œå…±" + data.size() + "æ¡è®°å½•");
    }

    /**
     * è¿‡æ»¤æ•°æ® - é’©å­æ–¹æ³•
     */
    protected List<T> filterData(List<T> data) {
        // é»˜è®¤ä¸è¿‡æ»¤
        return data;
    }

    /**
     * åå¤„ç† - é’©å­æ–¹æ³•
     */
    protected void postProcessing() {
        // é»˜è®¤æ— æ“ä½œ
    }
}

// å…·ä½“å®ç° - CSVæ•°æ®å¤„ç†å™¨
public class CsvDataProcessor extends DataProcessorTemplate<String> {
    private String filePath;
    private Predicate<String> filter;

    public CsvDataProcessor(String filePath) {
        this.filePath = filePath;
    }

    public void setFilter(Predicate<String> filter) {
        this.filter = filter;
    }

    @Override
    protected List<String> readData() {
        System.out.println("ä»CSVæ–‡ä»¶è¯»å–æ•°æ®: " + filePath);
        // å®é™…å®ç°ä¸­ä¼šè¯»å–æ–‡ä»¶å†…å®¹
        return List.of("è®°å½•1,æ•°æ®1,æœ‰æ•ˆ", "è®°å½•2,æ•°æ®2,æ— æ•ˆ", "è®°å½•3,æ•°æ®3,æœ‰æ•ˆ");
    }

    @Override
    protected List<String> transformData(List<String> data) {
        System.out.println("è½¬æ¢CSVæ•°æ®");
        return data.stream()
            .map(record -> record.toUpperCase())
            .toList();
    }

    @Override
    protected void writeData(List<String> data) {
        System.out.println("å°†å¤„ç†åçš„æ•°æ®å†™å…¥ç›®æ ‡ç³»ç»Ÿ");
        data.forEach(System.out::println);
    }

    /**
     * é‡å†™é’©å­æ–¹æ³• - å®ç°æ•°æ®è¿‡æ»¤
     */
    @Override
    protected List<String> filterData(List<String> data) {
        if (filter != null) {
            return data.stream()
                .filter(filter)
                .toList();
        }
        return super.filterData(data);
    }

    /**
     * é‡å†™é’©å­æ–¹æ³• - å®ç°åå¤„ç†
     */
    @Override
    protected void postProcessing() {
        System.out.println("CSVæ•°æ®å¤„ç†å®Œæˆï¼Œæ¸…ç†ä¸´æ—¶èµ„æº");
    }
}

// å®¢æˆ·ç«¯
public class DataProcessorClient {
    public static void main(String[] args) {
        CsvDataProcessor processor = new CsvDataProcessor("data.csv");
        // è®¾ç½®è¿‡æ»¤å™¨ï¼šåªä¿ç•™åŒ…å«"æœ‰æ•ˆ"çš„è®°å½•
        processor.setFilter(record -> record.contains("æœ‰æ•ˆ"));
        processor.processData();
    }
}
```

## ğŸ” æºç åº”ç”¨

### Javaä¸­çš„æ¨¡æ¿æ–¹æ³•æ¨¡å¼
- **`java.io.InputStream`/`OutputStream`/`Reader`/`Writer`**ï¼š
  è¿™äº›I/Oç±»æä¾›äº†æ¨¡æ¿æ–¹æ³•`read()`/`write()`ï¼Œå…·ä½“å®ç°ç”±å­ç±»å®Œæˆ

- **`java.util.AbstractList`/`AbstractSet`/`AbstractMap`**ï¼š
  é›†åˆæ¡†æ¶ä¸­çš„æŠ½è±¡ç±»æä¾›äº†åŸºç¡€å®ç°ï¼Œå­ç±»åªéœ€å®ç°å…³é”®æ–¹æ³•

```java
// Javaé›†åˆæ¡†æ¶ä¸­çš„æ¨¡æ¿æ–¹æ³•æ¨¡å¼
List<String> list = new AbstractList<>() {
    private String[] elements = {"A", "B", "C"};

    @Override
    public String get(int index) {
        return elements[index];
    }

    @Override
    public int size() {
        return elements.length;
    }
};

// AbstractListæä¾›äº†å¤§éƒ¨åˆ†åˆ—è¡¨æ“ä½œçš„å®ç°
// å¦‚contains(), indexOf(), subList()ç­‰
System.out.println(list.contains("B")); // true
System.out.println(list.indexOf("C")); // 2
```

- **`javax.servlet.http.HttpServlet`**ï¼š
  Servletç”Ÿå‘½å‘¨æœŸæ–¹æ³•æä¾›äº†æ¨¡æ¿ï¼Œ`doGet()`/`doPost()`ç­‰æ–¹æ³•ç”±å­ç±»å®ç°

```java
// HttpServletä¸­çš„æ¨¡æ¿æ–¹æ³•
public class MyServlet extends HttpServlet {
    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) {
        // å®ç°GETè¯·æ±‚å¤„ç†
    }

    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse resp) {
        // å®ç°POSTè¯·æ±‚å¤„ç†
    }
}
// HttpServletçš„service()æ–¹æ³•ä¼šæ ¹æ®è¯·æ±‚ç±»å‹è°ƒç”¨å¯¹åº”çš„doXxx()æ–¹æ³•
```

### Springæ¡†æ¶ä¸­çš„åº”ç”¨
- **`org.springframework.web.servlet.mvc.AbstractController`**ï¼š
  Spring MVCæ§åˆ¶å™¨æŠ½è±¡ç±»ï¼Œå­ç±»å®ç°`handleRequestInternal()`æ–¹æ³•

- **`org.springframework.jdbc.core.JdbcTemplate`**ï¼š
  JDBCæ¨¡æ¿ç±»ï¼Œæä¾›äº†æ•°æ®åº“æ“ä½œçš„æ ‡å‡†æµç¨‹

```java
// Spring JdbcTemplateä½¿ç”¨ç¤ºä¾‹
JdbcTemplate jdbcTemplate = new JdbcTemplate(dataSource);
List<User> users = jdbcTemplate.query(
    "SELECT id, name FROM users",
    (rs, rowNum) -> new User(
        rs.getLong("id"),
        rs.getString("name")
    )
);
// JdbcTemplateå°è£…äº†è·å–è¿æ¥ã€åˆ›å»ºè¯­å¥ã€å¤„ç†å¼‚å¸¸ã€å…³é—­èµ„æºç­‰å›ºå®šæ­¥éª¤
// ç”¨æˆ·åªéœ€æä¾›SQLå’Œç»“æœæ˜ å°„å™¨
```

- **`org.springframework.transaction.support.AbstractPlatformTransactionManager`**ï¼š
  äº‹åŠ¡ç®¡ç†å™¨æŠ½è±¡ç±»ï¼Œå®ç°äº†äº‹åŠ¡ç®¡ç†çš„æ ‡å‡†æµç¨‹

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ¨¡æ¿æ–¹æ³•å£°æ˜ä¸ºfinal**ï¼šç¡®ä¿ç®—æ³•ç»“æ„ä¸è¢«å­ç±»ä¿®æ”¹

```java
// æ­£ç¡®åšæ³•
public final void templateMethod() {
    // ç®—æ³•æ­¥éª¤
}

// é”™è¯¯åšæ³• - å…è®¸å­ç±»ä¿®æ”¹ç®—æ³•ç»“æ„
public void templateMethod() {
    // ç®—æ³•æ­¥éª¤
}
```

2. **åˆç†è§„åˆ’æŠ½è±¡æ–¹æ³•å’Œé’©å­æ–¹æ³•**ï¼š
   - å¿…é¡»å®ç°çš„æ­¥éª¤å£°æ˜ä¸ºæŠ½è±¡æ–¹æ³•
   - å¯é€‰çš„æ‰©å±•ç‚¹ä½¿ç”¨é’©å­æ–¹æ³•
   - å›ºå®šä¸å˜çš„æ­¥éª¤å®ç°ä¸ºç§æœ‰å…·ä½“æ–¹æ³•

3. **é¿å…æ»¥ç”¨é’©å­æ–¹æ³•**ï¼šè¿‡å¤šé’©å­ä¼šå¯¼è‡´ç®—æ³•ç»“æ„æ··ä¹±

4. **æ–‡æ¡£åŒ–æ¨¡æ¿æ–¹æ³•**ï¼šæ¸…æ™°è¯´æ˜ç®—æ³•æ­¥éª¤å’Œé’©å­çš„ä½œç”¨

5. **æ³¨æ„ç»§æ‰¿å±‚æ¬¡**ï¼šé¿å…åˆ›å»ºè¿‡æ·±çš„ç»§æ‰¿æ ‘

6. **è€ƒè™‘å¼€é—­åŸåˆ™**ï¼šé€šè¿‡æ‰©å±•è€Œéä¿®æ”¹æ¥å¢åŠ æ–°è¡Œä¸º

7. **è­¦æƒ•Liskovæ›¿æ¢åŸåˆ™**ï¼šç¡®ä¿å­ç±»æ‰©å±•ä¸æ”¹å˜çˆ¶ç±»ç®—æ³•çš„æ­£ç¡®æ€§

8. **é¿å…åœ¨æ¨¡æ¿æ–¹æ³•ä¸­åŠ å…¥å¤æ‚é€»è¾‘**ï¼šä¿æŒç®—æ³•éª¨æ¶æ¸…æ™°

## ğŸ“ æœ€ä½³å®è·µ

1. **æœ€å°åŒ–æŠ½è±¡æ–¹æ³•**ï¼šä»…å°†å¿…é¡»ç”±å­ç±»å®ç°çš„æ­¥éª¤å£°æ˜ä¸ºæŠ½è±¡æ–¹æ³•

2. **æä¾›é»˜è®¤å®ç°**ï¼šä¸ºé’©å­æ–¹æ³•æä¾›åˆç†çš„é»˜è®¤å®ç°

```java
// è‰¯å¥½çš„é’©å­æ–¹æ³•è®¾è®¡
protected boolean shouldValidate() {
    return true; // é»˜è®¤éªŒè¯
}
```

3. **å‘½åè§„èŒƒ**ï¼šä½¿ç”¨ä¸€è‡´çš„å‘½ååŒºåˆ†ä¸åŒç±»å‹çš„æ–¹æ³•
   - æ¨¡æ¿æ–¹æ³•ï¼š`process()`, `execute()`, `perform()`
   - æŠ½è±¡æ–¹æ³•ï¼š`doXxx()`, `calculateXxx()`, `connectXxx()`
   - é’©å­æ–¹æ³•ï¼š`shouldXxx()`, `onXxx()`, `postXxx()`

4. **å‚æ•°åŒ–è¡Œä¸º**ï¼šç»“åˆç­–ç•¥æ¨¡å¼ï¼Œå…è®¸é€šè¿‡å‚æ•°è°ƒæ•´è¡Œä¸º

5. **ä½¿ç”¨ç»„åˆæ›¿ä»£éƒ¨åˆ†ç»§æ‰¿**ï¼šå¤æ‚åœºæ™¯ä¸‹è€ƒè™‘ç»„åˆæ–¹å¼

6. **æµ‹è¯•ç­–ç•¥**ï¼šæµ‹è¯•æŠ½è±¡ç±»çš„é»˜è®¤è¡Œä¸ºå’Œå­ç±»çš„ç‰¹å®šå®ç°

7. **æ¸è¿›å¼è®¾è®¡**ï¼šå…ˆå®ç°å…·ä½“ç±»ï¼Œå†æå–å…¬å…±éƒ¨åˆ†å½¢æˆæ¨¡æ¿

8. **é™åˆ¶é’©å­æ–¹æ³•å¯è§æ€§**ï¼šé€šå¸¸ä½¿ç”¨protectedä¿®é¥°ç¬¦

## ğŸ“š ç›¸å…³æ¨¡å¼

- **ç­–ç•¥æ¨¡å¼**ï¼šæ¨¡æ¿æ–¹æ³•ä½¿ç”¨ç»§æ‰¿æ”¹å˜ç®—æ³•çš„ç‰¹å®šæ­¥éª¤ï¼Œç­–ç•¥æ¨¡å¼ä½¿ç”¨ç»„åˆæ”¹å˜æ•´ä¸ªç®—æ³•

- **å·¥å‚æ–¹æ³•æ¨¡å¼**ï¼šå·¥å‚æ–¹æ³•æ˜¯æ¨¡æ¿æ–¹æ³•çš„ä¸€ç§ç‰¹æ®Šå½¢å¼ï¼Œç”¨äºå¯¹è±¡åˆ›å»º

- **å»ºé€ è€…æ¨¡å¼**ï¼šéƒ½å…³æ³¨å¯¹è±¡æ„å»ºè¿‡ç¨‹ï¼Œä½†å»ºé€ è€…æ›´æ³¨é‡å¤æ‚å¯¹è±¡çš„åˆ†æ­¥æ„å»º

- **æ¨¡æ¿æ–¹æ³•æ¨¡å¼**ï¼šå®šä¹‰ç®—æ³•éª¨æ¶ï¼Œå­ç±»å®ç°å…·ä½“æ­¥éª¤

- **é’©å­æ–¹æ³•**ï¼šä¸å›è°ƒæœºåˆ¶ç±»ä¼¼ï¼Œå…è®¸å­ç±»åœ¨ç‰¹å®šç‚¹æ’å…¥è‡ªå®šä¹‰é€»è¾‘

- **å¥½è±ååŸåˆ™**ï¼š"ä¸è¦è°ƒç”¨æˆ‘ä»¬ï¼Œæˆ‘ä»¬ä¼šè°ƒç”¨ä½ "ï¼Œæ¨¡æ¿æ–¹æ³•æ¨¡å¼æ˜¯è¿™ä¸€åŸåˆ™çš„å…¸å‹åº”ç”¨

