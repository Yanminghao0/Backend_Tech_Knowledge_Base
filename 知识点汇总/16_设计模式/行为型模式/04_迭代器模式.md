# è¿­ä»£å™¨æ¨¡å¼ï¼ˆIterator Patternï¼‰

> æä¾›ä¸€ç§æ–¹æ³•é¡ºåºè®¿é—®èšåˆå¯¹è±¡ä¸­çš„å„ä¸ªå…ƒç´ ï¼Œè€Œåˆä¸éœ€è¦æš´éœ²è¯¥å¯¹è±¡çš„å†…éƒ¨è¡¨ç¤ºã€‚è¿™ç§æ¨¡å¼å±äºè¡Œä¸ºå‹æ¨¡å¼ï¼Œå®ƒå°†éå†èšåˆå¯¹è±¡çš„è´£ä»»äº¤ç»™è¿­ä»£å™¨ï¼Œä»è€Œç®€åŒ–äº†èšåˆç±»ã€‚

---

## ğŸ“‹ åŸºæœ¬ä¿¡æ¯

- **ç±»å‹**: è¡Œä¸ºå‹æ¨¡å¼
- **éš¾åº¦**: â­â­
- **ä½¿ç”¨é¢‘ç‡**: â­â­â­â­â­
- **å…³é”®è¯**: éå†é›†åˆã€ç»Ÿä¸€æ¥å£ã€éšè—å†…éƒ¨ç»“æ„ã€è¿­ä»£å™¨æ¥å£ã€èšåˆå¯¹è±¡

---

## ğŸ¯ æ¨¡å¼æ„å›¾

**æ ¸å¿ƒæ€æƒ³**ï¼šæä¾›ä¸€ç§æ–¹æ³•æ¥è®¿é—®èšåˆå¯¹è±¡ä¸­çš„å…ƒç´ ï¼Œè€Œä¸æš´éœ²èšåˆå¯¹è±¡çš„å†…éƒ¨ç»“æ„ï¼ŒåŒæ—¶æ”¯æŒå¤šç§ä¸åŒçš„éå†æ–¹å¼ã€‚

**è§£å†³çš„é—®é¢˜**ï¼š
- å¦‚ä½•ä¸æš´éœ²èšåˆå¯¹è±¡çš„å†…éƒ¨ç»“æ„è€Œéå†å…¶å…ƒç´ 
- å¦‚ä½•ä¸ºä¸åŒçš„èšåˆç»“æ„æä¾›ç»Ÿä¸€çš„éå†æ¥å£
- å¦‚ä½•æ”¯æŒå¤šç§éå†æ–¹å¼
- å¦‚ä½•å°†éå†ç®—æ³•ä¸èšåˆå¯¹è±¡åˆ†ç¦»

**é€‚ç”¨åœºæ™¯**ï¼š
- ğŸ“š **é›†åˆæ¡†æ¶**ï¼šå¦‚åˆ—è¡¨ã€é›†åˆã€æ˜ å°„ç­‰å®¹å™¨çš„éå†
- ğŸ“Š **æ•°æ®ç»“æ„**ï¼šæ ‘ã€å›¾ç­‰å¤æ‚æ•°æ®ç»“æ„çš„éå†
- ğŸ”„ **å¤šç§éå†æ–¹å¼**ï¼šéœ€è¦ä¸ºä¸€ä¸ªèšåˆå¯¹è±¡æä¾›å¤šç§éå†æ–¹å¼
- ğŸ§© **éšè—å†…éƒ¨å®ç°**ï¼šä¸å¸Œæœ›æš´éœ²èšåˆå¯¹è±¡çš„å†…éƒ¨ç»“æ„
- ğŸ“± **ç»Ÿä¸€æ¥å£**ï¼šéœ€è¦ä¸ºä¸åŒçš„èšåˆç»“æ„æä¾›ç»Ÿä¸€çš„éå†æ¥å£
- ğŸš€ **éå†ç®—æ³•å¤ç”¨**ï¼šå¸Œæœ›éå†ç®—æ³•å¯ä»¥ç‹¬ç«‹äºèšåˆè€Œå˜åŒ–

## ğŸ—ï¸ UMLç±»å›¾

```mermaid
classDiagram
    class Iterator {
        <<interface>>
        +hasNext(): boolean
        +next(): Object
        +remove(): void
    }
    class ConcreteIterator {
        -aggregate: Aggregate
        -index: int
        +ConcreteIterator(aggregate: Aggregate)
        +hasNext(): boolean
        +next(): Object
        +remove(): void
    }
    class Aggregate {
        <<interface>>
        +createIterator(): Iterator
    }
    class ConcreteAggregate {
        -items: Object[]
        +createIterator(): Iterator
        +getItem(index: int): Object
        +getCount(): int
    }
    class Client {
    }

    Iterator <|-- ConcreteIterator
    Aggregate <|-- ConcreteAggregate
    ConcreteIterator --> ConcreteAggregate : aggregate
    Client --> Aggregate
    Client --> Iterator
```

**æ ¸å¿ƒè§’è‰²**ï¼š
- **Iteratorï¼ˆè¿­ä»£å™¨ï¼‰**ï¼šå®šä¹‰éå†å…ƒç´ çš„æ¥å£ï¼ŒåŒ…æ‹¬hasNext()ã€next()ç­‰æ–¹æ³•
- **ConcreteIteratorï¼ˆå…·ä½“è¿­ä»£å™¨ï¼‰**ï¼šå®ç°è¿­ä»£å™¨æ¥å£ï¼Œè·Ÿè¸ªéå†ä½ç½®
- **Aggregateï¼ˆèšåˆï¼‰**ï¼šå®šä¹‰åˆ›å»ºè¿­ä»£å™¨å¯¹è±¡çš„æ¥å£
- **ConcreteAggregateï¼ˆå…·ä½“èšåˆï¼‰**ï¼šå®ç°åˆ›å»ºè¿­ä»£å™¨çš„æ¥å£ï¼Œè¿”å›å…·ä½“è¿­ä»£å™¨å®ä¾‹
- **Clientï¼ˆå®¢æˆ·ç«¯ï¼‰**ï¼šä½¿ç”¨è¿­ä»£å™¨éå†èšåˆå¯¹è±¡

**è¿­ä»£å™¨æ¨¡å¼å˜ä½“**ï¼š
1. **å†…éƒ¨è¿­ä»£å™¨**ï¼šç”±èšåˆå¯¹è±¡æ§åˆ¶éå†è¿‡ç¨‹
2. **å¤–éƒ¨è¿­ä»£å™¨**ï¼šç”±å®¢æˆ·ç«¯æ§åˆ¶éå†è¿‡ç¨‹
3. **åŒå‘è¿­ä»£å™¨**ï¼šæ”¯æŒå‘å‰å’Œå‘åéå†
4. **è·³è·ƒè¿­ä»£å™¨**ï¼šæ”¯æŒæŒ‰æŒ‡å®šæ­¥é•¿è·³è·ƒéå†
5. **è¿‡æ»¤è¿­ä»£å™¨**ï¼šæ”¯æŒæŒ‰æ¡ä»¶è¿‡æ»¤å…ƒç´ 
6. **æƒ°æ€§è¿­ä»£å™¨**ï¼šæŒ‰éœ€è®¡ç®—å’Œè¿”å›å…ƒç´ 

## ğŸ’» ä»£ç å®ç°

### 1. åŸºç¡€å®ç°

```java
// è¿­ä»£å™¨æ¥å£
public interface Iterator {
    boolean hasNext();
    Object next();
    void remove();
}

// èšåˆæ¥å£
public interface Aggregate {
    Iterator createIterator();
}

// å…·ä½“è¿­ä»£å™¨
public class ConcreteIterator implements Iterator {
    private ConcreteAggregate aggregate;
    private int index;

    public ConcreteIterator(ConcreteAggregate aggregate) {
        this.aggregate = aggregate;
        this.index = 0;
    }

    @Override
    public boolean hasNext() {
        return index < aggregate.getCount();
    }

    @Override
    public Object next() {
        if (this.hasNext()) {
            return aggregate.getItem(index++);
        }
        return null;
    }

    @Override
    public void remove() {
        // å®ç°åˆ é™¤å½“å‰å…ƒç´ çš„é€»è¾‘
        aggregate.removeItem(index - 1);
        index--;
    }
}

// å…·ä½“èšåˆ
public class ConcreteAggregate implements Aggregate {
    private Object[] items;
    private int size = 0;
    private static final int DEFAULT_CAPACITY = 10;

    public ConcreteAggregate() {
        items = new Object[DEFAULT_CAPACITY];
    }

    public void addItem(Object item) {
        if (size >= items.length) {
            // æ‰©å®¹é€»è¾‘
            Object[] newItems = new Object[items.length * 2];
            System.arraycopy(items, 0, newItems, 0, items.length);
            items = newItems;
        }
        items[size++] = item;
    }

    public void removeItem(int index) {
        if (index >= 0 && index < size) {
            System.arraycopy(items, index + 1, items, index, size - index - 1);
            items[--size] = null;
        }
    }

    public Object getItem(int index) {
        return items[index];
    }

    public int getCount() {
        return size;
    }

    @Override
    public Iterator createIterator() {
        return new ConcreteIterator(this);
    }
}

// å®¢æˆ·ç«¯ä»£ç 
public class Client {
    public static void main(String[] args) {
        ConcreteAggregate aggregate = new ConcreteAggregate();
        aggregate.addItem("å…ƒç´ 1");
        aggregate.addItem("å…ƒç´ 2");
        aggregate.addItem("å…ƒç´ 3");
        aggregate.addItem("å…ƒç´ 4");

        Iterator iterator = aggregate.createIterator();
        System.out.println("éå†èšåˆå…ƒç´ :");
        while (iterator.hasNext()) {
            System.out.println(iterator.next());
        }

        // æ¼”ç¤ºåˆ é™¤æ“ä½œ
        iterator = aggregate.createIterator();
        iterator.next(); // ç§»åŠ¨åˆ°ç¬¬ä¸€ä¸ªå…ƒç´ 
        iterator.next(); // ç§»åŠ¨åˆ°ç¬¬äºŒä¸ªå…ƒç´ 
        iterator.remove(); // åˆ é™¤ç¬¬äºŒä¸ªå…ƒç´ 

        System.out.println("åˆ é™¤ç¬¬äºŒä¸ªå…ƒç´ åéå†:");
        iterator = aggregate.createIterator();
        while (iterator.hasNext()) {
            System.out.println(iterator.next());
        }
    }
}
```

### 2. æ³›å‹è¿­ä»£å™¨å®ç°

```java
// æ³›å‹è¿­ä»£å™¨æ¥å£
public interface GenericIterator<T> {
    boolean hasNext();
    T next();
    void remove();
}

// æ³›å‹èšåˆæ¥å£
public interface GenericAggregate<T> {
    GenericIterator<T> createIterator();
}

// æ³›å‹å…·ä½“è¿­ä»£å™¨
public class ConcreteGenericIterator<T> implements GenericIterator<T> {
    private ConcreteGenericAggregate<T> aggregate;
    private int index;

    public ConcreteGenericIterator(ConcreteGenericAggregate<T> aggregate) {
        this.aggregate = aggregate;
        this.index = 0;
    }

    @Override
    public boolean hasNext() {
        return index < aggregate.getCount();
    }

    @Override
    public T next() {
        if (this.hasNext()) {
            return aggregate.getItem(index++);
        }
        return null;
    }

    @Override
    public void remove() {
        aggregate.removeItem(index - 1);
        index--;
    }
}

// æ³›å‹å…·ä½“èšåˆ
public class ConcreteGenericAggregate<T> implements GenericAggregate<T> {
    private T[] items;
    private int size = 0;
    private static final int DEFAULT_CAPACITY = 10;

    @SuppressWarnings("unchecked")
    public ConcreteGenericAggregate() {
        items = (T[]) new Object[DEFAULT_CAPACITY];
    }

    public void addItem(T item) {
        if (size >= items.length) {
            @SuppressWarnings("unchecked")
            T[] newItems = (T[]) new Object[items.length * 2];
            System.arraycopy(items, 0, newItems, 0, items.length);
            items = newItems;
        }
        items[size++] = item;
    }

    public void removeItem(int index) {
        if (index >= 0 && index < size) {
            System.arraycopy(items, index + 1, items, index, size - index - 1);
            items[--size] = null;
        }
    }

    public T getItem(int index) {
        return items[index];
    }

    public int getCount() {
        return size;
    }

    @Override
    public GenericIterator<T> createIterator() {
        return new ConcreteGenericIterator<>(this);
    }
}
```

### 3. Javaé›†åˆæ¡†æ¶ä¸­çš„è¿­ä»£å™¨ä½¿ç”¨

```java
// Javaè¿­ä»£å™¨ä½¿ç”¨ç¤ºä¾‹
public class JavaIteratorExample {
    public static void main(String[] args) {
        // ArrayListè¿­ä»£å™¨
        List<String> list = new ArrayList<>();
        list.add("Apple");
        list.add("Banana");
        list.add("Cherry");

        System.out.println("ArrayListéå†:");
        Iterator<String> listIterator = list.iterator();
        while (listIterator.hasNext()) {
            String fruit = listIterator.next();
            System.out.println(fruit);
            if (fruit.equals("Banana")) {
                listIterator.remove(); // åˆ é™¤å…ƒç´ 
            }
        }

        // LinkedListåŒå‘è¿­ä»£å™¨
        LinkedList<Integer> linkedList = new LinkedList<>();
        linkedList.add(1);
        linkedList.add(2);
        linkedList.add(3);

        System.out.println("LinkedListåŒå‘éå†:");
        ListIterator<Integer> linkedListIterator = linkedList.listIterator();

        System.out.println("å‘å‰éå†:");
        while (linkedListIterator.hasNext()) {
            System.out.println(linkedListIterator.next());
        }

        System.out.println("å‘åéå†:");
        while (linkedListIterator.hasPrevious()) {
            System.out.println(linkedListIterator.previous());
        }
    }
}
```

## ğŸ” æºç åº”ç”¨

### Javaé›†åˆæ¡†æ¶ä¸­çš„è¿­ä»£å™¨
- **`java.util.Iterator`**ï¼šJavaé›†åˆæ¡†æ¶çš„è¿­ä»£å™¨æ¥å£
- **`java.util.ListIterator`**ï¼šåˆ—è¡¨çš„åŒå‘è¿­ä»£å™¨æ¥å£
- **`java.util.Spliterator`**ï¼šæ”¯æŒå¹¶è¡Œéå†çš„è¿­ä»£å™¨
- **`java.util.Collection.iterator()`**ï¼šé›†åˆçš„è¿­ä»£å™¨æ–¹æ³•

```java
// Javaé›†åˆè¿­ä»£å™¨æºç ç‰‡æ®µç¤ºä¾‹
public interface Collection<E> extends Iterable<E> {
    // ...
    Iterator<E> iterator();
    // ...
}

// ArrayListçš„è¿­ä»£å™¨å®ç°
public class ArrayList<E> extends AbstractList<E> {
    // ...
    public Iterator<E> iterator() {
        return new Itr();
    }

    private class Itr implements Iterator<E> {
        int cursor;       // index of next element to return
        int lastRet = -1; // index of last element returned; -1 if no such
        int expectedModCount = modCount;

        public boolean hasNext() {
            return cursor != size;
        }

        @SuppressWarnings("unchecked")
        public E next() {
            checkForComodification();
            int i = cursor;
            if (i >= size)
                throw new NoSuchElementException();
            Object[] elementData = ArrayList.this.elementData;
            if (i >= elementData.length)
                throw new ConcurrentModificationException();
            cursor = i + 1;
            return (E) elementData[lastRet = i];
        }

        public void remove() {
            if (lastRet < 0)
                throw new IllegalStateException();
            checkForComodification();

            try {
                ArrayList.this.remove(lastRet);
                cursor = lastRet;
                lastRet = -1;
                expectedModCount = modCount;
            } catch (IndexOutOfBoundsException ex) {
                throw new ConcurrentModificationException();
            }
        }
        // ...
    }
    // ...
}
```

### Springæ¡†æ¶ä¸­çš„åº”ç”¨
- **`org.springframework.util.MultiValueMap`**ï¼šå¤šå€¼æ˜ å°„çš„è¿­ä»£å™¨
- **`org.springframework.core.io.support.ResourcePatternResolver`**ï¼šèµ„æºè¿­ä»£å™¨
- **`org.springframework.beans.factory.config.BeanDefinitionIterator`**ï¼šBeanå®šä¹‰è¿­ä»£å™¨

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å¹¶å‘ä¿®æ”¹å¼‚å¸¸**ï¼šè¿­ä»£è¿‡ç¨‹ä¸­ä¿®æ”¹èšåˆå¯¹è±¡å¯èƒ½å¯¼è‡´`ConcurrentModificationException`

2. **è¿­ä»£å™¨å¤±æ•ˆ**ï¼šèšåˆç»“æ„å˜åŒ–å¯èƒ½å¯¼è‡´è¿­ä»£å™¨å¤±æ•ˆ

3. **ç©ºæŒ‡é’ˆå¼‚å¸¸**ï¼šè°ƒç”¨`next()`å‰æœªæ£€æŸ¥`hasNext()`

4. **çº¿ç¨‹å®‰å…¨**ï¼šå¤§å¤šæ•°è¿­ä»£å™¨ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„

5. **.remove()æ–¹æ³•é™åˆ¶**ï¼šæ¯æ¬¡è°ƒç”¨`next()`ååªèƒ½è°ƒç”¨ä¸€æ¬¡`remove()`

## ğŸ“ æœ€ä½³å®è·µ

1. **ä½¿ç”¨æ¥å£ç¼–ç¨‹**ï¼šé’ˆå¯¹Iteratoræ¥å£ç¼–ç¨‹ï¼Œè€Œéå…·ä½“å®ç°

2. **ä¼˜å…ˆä½¿ç”¨foreach**ï¼šåœ¨Javaä¸­ä¼˜å…ˆä½¿ç”¨foreachå¾ªç¯ï¼ˆå†…éƒ¨è¿­ä»£å™¨ï¼‰

```java
// æ¨è
for (Element element : collection) {
    // å¤„ç†å…ƒç´ 
}
```

3. **ä½¿ç”¨Java 8+ Stream API**ï¼šå¯¹äºå¤æ‚çš„é›†åˆæ“ä½œï¼Œä½¿ç”¨Stream API

```java
collection.stream()
    .filter(e -> e.isValid())
    .map(Element::transform)
    .forEach(System.out::println);
```

4. **æ”¯æŒforeachå¾ªç¯**ï¼šå®ç°Iterableæ¥å£ï¼Œæ”¯æŒforeachè¯­æ³•

5. **é¿å…æš´éœ²å†…éƒ¨ç»“æ„**ï¼šä¸è¦åœ¨è¿­ä»£å™¨ä¸­æš´éœ²èšåˆå†…éƒ¨æ•°æ®ç»“æ„

## ğŸ“š ç›¸å…³æ¨¡å¼

- **ç»„åˆæ¨¡å¼**ï¼šé€šå¸¸ä¸è¿­ä»£å™¨æ¨¡å¼ä¸€èµ·ä½¿ç”¨ï¼Œéå†ç»„åˆå¯¹è±¡
- **å·¥å‚æ–¹æ³•æ¨¡å¼**ï¼šèšåˆå¯¹è±¡ä½¿ç”¨å·¥å‚æ–¹æ³•åˆ›å»ºè¿­ä»£å™¨
- **è®¿é—®è€…æ¨¡å¼**ï¼šè¿­ä»£å™¨éå†å¯¹è±¡ç»“æ„ï¼Œè®¿é—®è€…æ“ä½œå¯¹è±¡
- **ç­–ç•¥æ¨¡å¼**ï¼šä¸åŒçš„è¿­ä»£ç®—æ³•å¯ä»¥ç”¨ç­–ç•¥æ¨¡å¼å®ç°
- **é€‚é…å™¨æ¨¡å¼**ï¼šå¯ä»¥å°†æšä¸¾æˆ–å…¶ä»–éå†æ¥å£é€‚é…ä¸ºè¿­ä»£å™¨

