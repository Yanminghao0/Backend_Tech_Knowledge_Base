# è®¿é—®è€…æ¨¡å¼ï¼ˆVisitor Patternï¼‰

> è¡¨ç¤ºä½œç”¨äºæŸå¯¹è±¡ç»“æ„ä¸­çš„å„å…ƒç´ çš„æ“ä½œï¼Œåœ¨ä¸æ”¹å˜å…ƒç´ ç±»çš„å‰æä¸‹å®šä¹‰æ–°æ“ä½œ

---

## ğŸ“‹ åŸºæœ¬ä¿¡æ¯

- **ç±»å‹**: è¡Œä¸ºå‹æ¨¡å¼
- **éš¾åº¦**: â­â­â­â­â­
- **ä½¿ç”¨é¢‘ç‡**: â­â­
- **å…³é”®è¯**: åŒé‡åˆ†æ´¾ã€æ•°æ®ä¸æ“ä½œåˆ†ç¦»ã€ASTéå†

---

## ğŸ¯ æ¨¡å¼æ„å›¾

**æ ¸å¿ƒæ€æƒ³**ï¼šè¡¨ç¤ºä¸€ä¸ªä½œç”¨äºæŸå¯¹è±¡ç»“æ„ä¸­çš„å„å…ƒç´ çš„æ“ä½œã€‚å®ƒä½¿ä½ å¯ä»¥åœ¨ä¸æ”¹å˜å„å…ƒç´ çš„ç±»çš„å‰æä¸‹å®šä¹‰ä½œç”¨äºè¿™äº›å…ƒç´ çš„æ–°æ“ä½œã€‚

**è§£å†³çš„é—®é¢˜**ï¼š
- å¦‚ä½•åœ¨ä¸ä¿®æ”¹ç°æœ‰ç±»çš„æƒ…å†µä¸‹ï¼Œä¸ºç°æœ‰ç±»æ·»åŠ æ–°çš„æ“ä½œ
- å¦‚ä½•å°†ç›¸å…³æ“ä½œé›†ä¸­åˆ°ä¸€ä¸ªç±»ä¸­ï¼Œè€Œä¸æ˜¯åˆ†æ•£åˆ°å¤šä¸ªç±»ä¸­
- å¦‚ä½•å¤„ç†å…·æœ‰å›ºå®šç»“æ„ä½†éœ€è¦çµæ´»æ‰©å±•æ“ä½œçš„å¯¹è±¡é›†åˆ
- å¦‚ä½•å®ç°åŒé‡åˆ†æ´¾ï¼ˆdouble dispatchï¼‰ä»¥åŠ¨æ€ç¡®å®šè¦æ‰§è¡Œçš„æ“ä½œ

**é€‚ç”¨åœºæ™¯**ï¼š
- å½“ä¸€ä¸ªå¯¹è±¡ç»“æ„åŒ…å«å¤šä¸ªç±»å‹çš„å¯¹è±¡ï¼Œä¸”éœ€è¦å¯¹è¿™äº›å¯¹è±¡å®æ–½ä¸ç›¸å…³çš„æ“ä½œæ—¶
- å½“éœ€è¦å¯¹ä¸€ä¸ªå¯¹è±¡ç»“æ„ä¸­çš„å¯¹è±¡è¿›è¡Œå¾ˆå¤šä¸åŒä¸”ä¸ç›¸å…³çš„æ“ä½œï¼Œè€Œä½ æƒ³é¿å…è®©è¿™äº›æ“ä½œæ±¡æŸ“è¿™äº›å¯¹è±¡çš„ç±»æ—¶
- å½“å¯¹è±¡ç»“æ„ç›¸å¯¹ç¨³å®šï¼Œä½†ç»å¸¸éœ€è¦åœ¨æ­¤ç»“æ„ä¸Šå®šä¹‰æ–°çš„æ“ä½œæ—¶
- å½“éœ€è¦å¯¹å¤æ‚å¯¹è±¡ç»“æ„ï¼ˆå¦‚ç»„åˆæ¨¡å¼ï¼‰ä¸­çš„æ‰€æœ‰å…ƒç´ æ‰§è¡ŒæŸç§æ“ä½œæ—¶
- åœ¨ç¼–è¯‘å™¨çš„æŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼‰å¤„ç†ã€æ–‡æ¡£è§£æã€é…ç½®æ–‡ä»¶å¤„ç†ç­‰åœºæ™¯

## ğŸ—ï¸ UMLç±»å›¾

```mermaid
classDiagram
    class Visitor {
        <<interface>>
        +visitConcreteElementA(element: ConcreteElementA)
        +visitConcreteElementB(element: ConcreteElementB)
    }
    class ConcreteVisitor1 {
        +visitConcreteElementA(element: ConcreteElementA)
        +visitConcreteElementB(element: ConcreteElementB)
    }
    class ConcreteVisitor2 {
        +visitConcreteElementA(element: ConcreteElementA)
        +visitConcreteElementB(element: ConcreteElementB)
    }
    class Element {
        <<interface>>
        +accept(visitor: Visitor)
    }
    class ConcreteElementA {
        +accept(visitor: Visitor)
        +operationA()
    }
    class ConcreteElementB {
        +accept(visitor: Visitor)
        +operationB()
    }
    class ObjectStructure {
        -elements: list[Element]
        +attach(element: Element)
        +detach(element: Element)
        +accept(visitor: Visitor)
    }

    Visitor <|-- ConcreteVisitor1
    Visitor <|-- ConcreteVisitor2
    Element <|-- ConcreteElementA
    Element <|-- ConcreteElementB
    ObjectStructure --> Element
    ConcreteElementA --> Visitor : accept(visitor)
    ConcreteElementB --> Visitor : accept(visitor)
```

**æ ¸å¿ƒè§’è‰²**ï¼š
- **Visitorï¼ˆè®¿é—®è€…ï¼‰**ï¼šä¸ºå¯¹è±¡ç»“æ„ä¸­çš„æ¯ä¸ªå…·ä½“å…ƒç´ å£°æ˜ä¸€ä¸ªè®¿é—®æ“ä½œ
- **ConcreteVisitorï¼ˆå…·ä½“è®¿é—®è€…ï¼‰**ï¼šå®ç°Visitorå£°æ˜çš„æ“ä½œï¼Œæ¯ä¸ªæ“ä½œå®ç°ç®—æ³•çš„ä¸€éƒ¨åˆ†
- **Elementï¼ˆå…ƒç´ ï¼‰**ï¼šå®šä¹‰ä¸€ä¸ªacceptæ“ä½œï¼Œæ¥æ”¶ä¸€ä¸ªè®¿é—®è€…å¯¹è±¡ä½œä¸ºå‚æ•°
- **ConcreteElementï¼ˆå…·ä½“å…ƒç´ ï¼‰**ï¼šå®ç°acceptæ“ä½œï¼Œè°ƒç”¨è®¿é—®è€…å¯¹åº”çš„è®¿é—®æ–¹æ³•
- **ObjectStructureï¼ˆå¯¹è±¡ç»“æ„ï¼‰**ï¼šèƒ½æšä¸¾å®ƒçš„å…ƒç´ ï¼Œå¯ä»¥æä¾›ä¸€ä¸ªé«˜å±‚æ¥å£ä»¥å…è®¸è®¿é—®è€…è®¿é—®å®ƒçš„å…ƒç´ 

**åŒé‡åˆ†æ´¾æœºåˆ¶**ï¼š
1. å®¢æˆ·ç«¯è°ƒç”¨Elementçš„acceptæ–¹æ³•ï¼Œä¼ å…¥Visitorå¯¹è±¡ï¼ˆç¬¬ä¸€æ¬¡åˆ†æ´¾ï¼‰
2. Elementçš„acceptæ–¹æ³•è°ƒç”¨Visitorçš„visitæ–¹æ³•ï¼Œä¼ å…¥è‡ªèº«ï¼ˆç¬¬äºŒæ¬¡åˆ†æ´¾ï¼‰
3. JVMæ ¹æ®Visitorå’ŒElementçš„å®é™…ç±»å‹ï¼Œè°ƒç”¨å¯¹åº”çš„å…·ä½“æ–¹æ³•

## ğŸ’» ä»£ç å®ç°

### 1. åŸºç¡€å®ç°ï¼ˆæ–‡æ¡£å…ƒç´ å¤„ç†ï¼‰

```java
// è®¿é—®è€…æ¥å£
public interface DocumentVisitor {
    void visit(TextElement text);
    void visit(ImageElement image);
    void visit(TableElement table);
}

// å…·ä½“è®¿é—®è€… - æ¸²æŸ“è®¿é—®è€…
public class RenderVisitor implements DocumentVisitor {
    @Override
    public void visit(TextElement text) {
        System.out.println("æ¸²æŸ“æ–‡æœ¬: " + text.getContent());
    }

    @Override
    public void visit(ImageElement image) {
        System.out.println("æ¸²æŸ“å›¾ç‰‡: [" + image.getUrl() + "] å°ºå¯¸: " + image.getWidth() + "x" + image.getHeight());
    }

    @Override
    public void visit(TableElement table) {
        System.out.println("æ¸²æŸ“è¡¨æ ¼: è¡Œæ•°=" + table.getRows() + ", åˆ—æ•°=" + table.getCols());
        for (int i = 0; i < Math.min(3, table.getRows()); i++) {
            System.out.println("  è¡Œ" + (i+1) + ": " + Arrays.toString(table.getRowData(i)));
        }
        if (table.getRows() > 3) {
            System.out.println("  ... è¿˜æœ‰" + (table.getRows() - 3) + "è¡Œæœªæ˜¾ç¤º");
        }
    }
}

// å…·ä½“è®¿é—®è€… - å¯¼å‡ºè®¿é—®è€…
public class ExportVisitor implements DocumentVisitor {
    private StringBuilder exportContent = new StringBuilder();

    @Override
    public void visit(TextElement text) {
        exportContent.append("[TEXT] ").append(text.getContent()).append("\n");
    }

    @Override
    public void visit(ImageElement image) {
        exportContent.append("[IMAGE] URL=").append(image.getUrl()).append(", SIZE=").append(image.getWidth()).append("x").append(image.getHeight()).append("\n");
    }

    @Override
    public void visit(TableElement table) {
        exportContent.append("[TABLE] ROWS=").append(table.getRows()).append(", COLS=").append(table.getCols()).append("\n");
    }

    public String getExportContent() {
        return exportContent.toString();
    }
}

// å…ƒç´ æ¥å£
public interface DocumentElement {
    void accept(DocumentVisitor visitor);
}

// å…·ä½“å…ƒç´  - æ–‡æœ¬å…ƒç´ 
public class TextElement implements DocumentElement {
    private String content;

    public TextElement(String content) {
        this.content = content;
    }

    public String getContent() {
        return content;
    }

    @Override
    public void accept(DocumentVisitor visitor) {
        visitor.visit(this);
    }
}

// å…·ä½“å…ƒç´  - å›¾ç‰‡å…ƒç´ 
public class ImageElement implements DocumentElement {
    private String url;
    private int width;
    private int height;

    public ImageElement(String url, int width, int height) {
        this.url = url;
        this.width = width;
        this.height = height;
    }

    public String getUrl() { return url; }
    public int getWidth() { return width; }
    public int getHeight() { return height; }

    @Override
    public void accept(DocumentVisitor visitor) {
        visitor.visit(this);
    }
}

// å…·ä½“å…ƒç´  - è¡¨æ ¼å…ƒç´ 
public class TableElement implements DocumentElement {
    private int rows;
    private int cols;
    private String[][] data;

    public TableElement(int rows, int cols) {
        this.rows = rows;
        this.cols = cols;
        this.data = new String[rows][cols];
        // åˆå§‹åŒ–ä¸€äº›ç¤ºä¾‹æ•°æ®
        for (int i = 0; i < rows; i++) {
            for (int j = 0; j < cols; j++) {
                data[i][j] = "å•å…ƒæ ¼(" + (i+1) + "," + (j+1) + ")";
            }
        }
    }

    public int getRows() { return rows; }
    public int getCols() { return cols; }
    public String[] getRowData(int row) { return data[row]; }

    @Override
    public void accept(DocumentVisitor visitor) {
        visitor.visit(this);
    }
}

// å¯¹è±¡ç»“æ„ - æ–‡æ¡£
public class Document implements DocumentElement {
    private List<DocumentElement> elements = new ArrayList<>();

    public void addElement(DocumentElement element) {
        elements.add(element);
    }

    public void removeElement(DocumentElement element) {
        elements.remove(element);
    }

    @Override
    public void accept(DocumentVisitor visitor) {
        for (DocumentElement element : elements) {
            element.accept(visitor);
        }
    }
}

// å®¢æˆ·ç«¯
public class DocumentClient {
    public static void main(String[] args) {
        // åˆ›å»ºæ–‡æ¡£å…ƒç´ 
        DocumentElement title = new TextElement("è®¿é—®è€…æ¨¡å¼ç¤ºä¾‹æ–‡æ¡£");
        DocumentElement paragraph = new TextElement("è¿™æ˜¯ä¸€ä¸ªä½¿ç”¨è®¿é—®è€…æ¨¡å¼å¤„ç†æ–‡æ¡£å…ƒç´ çš„ç¤ºä¾‹ã€‚");
        DocumentElement image = new ImageElement("https://example.com/logo.png", 800, 600);
        DocumentElement table = new TableElement(10, 4);

        // åˆ›å»ºæ–‡æ¡£å¹¶æ·»åŠ å…ƒç´ 
        Document document = new Document();
        document.addElement(title);
        document.addElement(paragraph);
        document.addElement(image);
        document.addElement(table);

        // åˆ›å»ºè®¿é—®è€…
        DocumentVisitor renderVisitor = new RenderVisitor();
        DocumentVisitor exportVisitor = new ExportVisitor();

        System.out.println("=== ä½¿ç”¨æ¸²æŸ“è®¿é—®è€… ===");
        document.accept(renderVisitor);

        System.out.println("\n=== ä½¿ç”¨å¯¼å‡ºè®¿é—®è€… ===");
        document.accept(exportVisitor);
        System.out.println(((ExportVisitor) exportVisitor).getExportContent());
    }
}
```

### 2. é«˜çº§å®ç°ï¼ˆè¡¨è¾¾å¼è§£æå™¨ï¼‰

```java
import java.util.HashMap;
import java.util.Map;

// è®¿é—®è€…æ¥å£
public interface ExpressionVisitor {
    int visit(NumberExpression expr);
    int visit(AddExpression expr);
    int visit(SubtractExpression expr);
    int visit(MultiplyExpression expr);
    int visit(DivideExpression expr);
    int visit(VariableExpression expr);
}

// è¯„ä¼°è®¿é—®è€…
public class EvaluationVisitor implements ExpressionVisitor {
    private Map<String, Integer> variables;

    public EvaluationVisitor(Map<String, Integer> variables) {
        this.variables = new HashMap<>(variables);
    }

    @Override
    public int visit(NumberExpression expr) {
        return expr.getValue();
    }

    @Override
    public int visit(AddExpression expr) {
        return expr.getLeft().accept(this) + expr.getRight().accept(this);
    }

    @Override
    public int visit(SubtractExpression expr) {
        return expr.getLeft().accept(this) - expr.getRight().accept(this);
    }

    @Override
    public int visit(MultiplyExpression expr) {
        return expr.getLeft().accept(this) * expr.getRight().accept(this);
    }

    @Override
    public int visit(DivideExpression expr) {
        int left = expr.getLeft().accept(this);
        int right = expr.getRight().accept(this);
        if (right == 0) {
            throw new ArithmeticException("é™¤é›¶é”™è¯¯");
        }
        return left / right;
    }

    @Override
    public int visit(VariableExpression expr) {
        Integer value = variables.get(expr.getName());
        if (value == null) {
            throw new IllegalArgumentException("æœªå®šä¹‰çš„å˜é‡: " + expr.getName());
        }
        return value;
    }
}

// è¡¨è¾¾å¼æ ¼å¼åŒ–è®¿é—®è€…
public class FormattingVisitor implements ExpressionVisitor {
    @Override
    public int visit(NumberExpression expr) {
        System.out.print(expr.getValue());
        return 0; // å¯¹äºæ ¼å¼åŒ–è®¿é—®è€…ï¼Œè¿”å›å€¼æ— æ„ä¹‰
    }

    @Override
    public int visit(AddExpression expr) {
        System.out.print("(");
        expr.getLeft().accept(this);
        System.out.print(" + ");
        expr.getRight().accept(this);
        System.out.print(")");
        return 0;
    }

    @Override
    public int visit(SubtractExpression expr) {
        System.out.print("(");
        expr.getLeft().accept(this);
        System.out.print(" - ");
        expr.getRight().accept(this);
        System.out.print(")");
        return 0;
    }

    @Override
    public int visit(MultiplyExpression expr) {
        System.out.print("(");
        expr.getLeft().accept(this);
        System.out.print(" * ");
        expr.getRight().accept(this);
        System.out.print(")");
        return 0;
    }

    @Override
    public int visit(DivideExpression expr) {
        System.out.print("(");
        expr.getLeft().accept(this);
        System.out.print(" / ");
        expr.getRight().accept(this);
        System.out.print(")");
        return 0;
    }

    @Override
    public int visit(VariableExpression expr) {
        System.out.print(expr.getName());
        return 0;
    }
}

// è¡¨è¾¾å¼æ¥å£
public interface Expression {
    int accept(ExpressionVisitor visitor);
}

// å…·ä½“è¡¨è¾¾å¼å®ç°
public class NumberExpression implements Expression {
    private int value;

    public NumberExpression(int value) { this.value = value; }
    public int getValue() { return value; }

    @Override
    public int accept(ExpressionVisitor visitor) {
        return visitor.visit(this);
    }
}

public class VariableExpression implements Expression {
    private String name;

    public VariableExpression(String name) { this.name = name; }
    public String getName() { return name; }

    @Override
    public int accept(ExpressionVisitor visitor) {
        return visitor.visit(this);
    }
}

public class AddExpression implements Expression {
    private Expression left;
    private Expression right;

    public AddExpression(Expression left, Expression right) {
        this.left = left;
        this.right = right;
    }

    public Expression getLeft() { return left; }
    public Expression getRight() { return right; }

    @Override
    public int accept(ExpressionVisitor visitor) {
        return visitor.visit(this);
    }
}

// å…¶ä»–è¿ç®—è¡¨è¾¾å¼ç±»(SubtractExpression, MultiplyExpression, DivideExpression)å®ç°ç±»ä¼¼

// å®¢æˆ·ç«¯
public class ExpressionClient {
    public static void main(String[] args) {
        // æ„å»ºè¡¨è¾¾å¼: (a + 5) * (b - 3)
        Expression expr = new MultiplyExpression(
            new AddExpression(
                new VariableExpression("a"),
                new NumberExpression(5)
            ),
            new SubtractExpression(
                new VariableExpression("b"),
                new NumberExpression(3)
            )
        );

        // åˆ›å»ºå˜é‡æ˜ å°„
        Map<String, Integer> variables = new HashMap<>();
        variables.put("a", 10);
        variables.put("b", 8);

        // åˆ›å»ºè®¿é—®è€…
        ExpressionVisitor formatter = new FormattingVisitor();
        ExpressionVisitor evaluator = new EvaluationVisitor(variables);

        System.out.print("è¡¨è¾¾å¼: ");
        expr.accept(formatter);

        int result = expr.accept(evaluator);
        System.out.println(" = " + result);
    }
}
```

## ğŸ” æºç åº”ç”¨

### Javaä¸­çš„è®¿é—®è€…æ¨¡å¼
- **`javax.lang.model.element.ElementVisitor`**ï¼šJavaç¼–è¯‘å™¨APIä¸­çš„å…ƒç´ è®¿é—®è€…

```java
// Javaç¼–è¯‘å™¨APIä¸­çš„è®¿é—®è€…æ¨¡å¼åº”ç”¨
Elements elements = processingEnv.getElementUtils();
elements.getTypeElement("com.example.MyClass").accept(new SimpleElementVisitor8<Void, Void>() {
    @Override
    public Void visitType(TypeElement e, Void p) {
        System.out.println("ç±»å: " + e.getSimpleName());
        return super.visitType(e, p);
    }

    @Override
    public Void visitVariable(VariableElement e, Void p) {
        System.out.println("å˜é‡: " + e.getSimpleName());
        return super.visitVariable(e, p);
    }
}, null);
```

- **`java.nio.file.FileVisitor`**ï¼šæ–‡ä»¶ç³»ç»Ÿéå†è®¿é—®è€…

```java
// æ–‡ä»¶éå†è®¿é—®è€…ç¤ºä¾‹
Files.walkFileTree(Paths.get("/path/to/directory"), new SimpleFileVisitor<Path>() {
    @Override
    public FileVisitResult visitFile(Path file, BasicFileAttributes attrs) {
        if (file.toString().endsWith(".java")) {
            System.out.println("Javaæ–‡ä»¶: " + file);
        }
        return FileVisitResult.CONTINUE;
    }

    @Override
    public FileVisitResult visitFileFailed(Path file, IOException exc) {
        System.err.println("è®¿é—®æ–‡ä»¶å¤±è´¥: " + file);
        return FileVisitResult.CONTINUE;
    }
});
```

- **`javax.xml.stream.XMLStreamReader`**ï¼šXMLè§£æä¸­çš„äº‹ä»¶è®¿é—®

### Springæ¡†æ¶ä¸­çš„åº”ç”¨
- **`org.springframework.asm.ClassVisitor`**ï¼šSpringå†…éƒ¨ä½¿ç”¨ASMåº“è¿›è¡Œç±»å­—èŠ‚ç æ“ä½œ

- **`org.springframework.beans.factory.parsing.BeanDefinitionVisitor`**ï¼šBeanå®šä¹‰è§£æè®¿é—®è€…

```java
// Springä¸­çš„Beanå®šä¹‰è®¿é—®è€…
BeanDefinitionVisitor visitor = new BeanDefinitionVisitor(new StandardBeanExpressionResolver());
visitor.visitBeanDefinition(beanDefinition);
```

- **`org.springframework.web.servlet.handler.HandlerMappingIntrospector`**ï¼šè¯·æ±‚æ˜ å°„å¤„ç†

### å…¶ä»–æ¡†æ¶ä¸­çš„åº”ç”¨
- **Apache Ant**ï¼šæ„å»ºæ–‡ä»¶å¤„ç†ä¸­çš„ä»»åŠ¡è®¿é—®è€…
- **JUnit**ï¼šæµ‹è¯•ç”¨ä¾‹æ‰§è¡Œå™¨ä¸­çš„è®¿é—®è€…æ¨¡å¼
- **Eclipse JDT**ï¼šJavaå¼€å‘å·¥å…·ä¸­çš„ASTè®¿é—®è€…
- **MyBatis**ï¼šSQLèŠ‚ç‚¹è§£æå™¨ä¸­çš„è®¿é—®è€…
- **Jackson**ï¼šJSONåºåˆ—åŒ–/ååºåˆ—åŒ–ä¸­çš„è®¿é—®è€…

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å¼€æ”¾-å°é—­åŸåˆ™çš„æƒè¡¡**ï¼š
   - å¯¹æ–°å¢æ“ä½œå¼€æ”¾ï¼šå¯ä»¥é€šè¿‡æ·»åŠ æ–°çš„è®¿é—®è€…æ¥å®ç°
   - å¯¹æ–°å¢å…ƒç´ å…³é—­ï¼šæ·»åŠ æ–°å…ƒç´ éœ€è¦ä¿®æ”¹æ‰€æœ‰è®¿é—®è€…æ¥å£å’Œå®ç°

2. **å…ƒç´ ç±»çš„ç¨³å®šæ€§è¦æ±‚**ï¼š
   å¦‚æœå…ƒç´ ç±»ç»å¸¸å˜åŒ–ï¼ˆæ·»åŠ æ–°å…ƒç´ ï¼‰ï¼Œè®¿é—®è€…æ¨¡å¼ä¼šå¯¼è‡´å¤§é‡ä¿®æ”¹

3. **å°è£…æ€§é—®é¢˜**ï¼š
   ä¸ºäº†è®©è®¿é—®è€…èƒ½å¤Ÿæ“ä½œå…ƒç´ ï¼Œå…ƒç´ å¯èƒ½éœ€è¦æš´éœ²å†…éƒ¨çŠ¶æ€æˆ–æ“ä½œ

```java
// ä¸è‰¯å®è·µï¼šä¸ºäº†è®¿é—®è€…è€Œæš´éœ²å†…éƒ¨å®ç°
public class BadElement implements Element {
    private int internalState;
    
    // ä¸ºäº†è®©è®¿é—®è€…è®¿é—®è€Œæš´éœ²å†…éƒ¨çŠ¶æ€
    public int getInternalState() { return internalState; }
    
    // ä¸ºäº†è®©è®¿é—®è€…ä¿®æ”¹è€Œæš´éœ²å†…éƒ¨æ–¹æ³•
    public void setInternalState(int state) { this.internalState = state; }
    
    @Override
    public void accept(Visitor visitor) {
        visitor.visit(this);
    }
}
```

4. **å¾ªç¯ä¾èµ–é£é™©**ï¼šè®¿é—®è€…å’Œå…ƒç´ å¯èƒ½å½¢æˆå¾ªç¯ä¾èµ–

5. **å¤æ‚æ€§å¢åŠ **ï¼š
   å¼•å…¥è®¿é—®è€…æ¨¡å¼ä¼šå¢åŠ ç³»ç»Ÿçš„ç±»æ•°é‡å’Œå¤æ‚æ€§ï¼Œç®€å•åœºæ™¯å¯èƒ½ä¸é€‚ç”¨

6. **åŒé‡åˆ†æ´¾ç†è§£éš¾åº¦**ï¼š
   å¼€å‘äººå‘˜éœ€è¦ç†è§£åŒé‡åˆ†æ´¾æœºåˆ¶æ‰èƒ½æ­£ç¡®ä½¿ç”¨è®¿é—®è€…æ¨¡å¼

7. **å¹¶è¡Œå¤„ç†æŒ‘æˆ˜**ï¼š
   åœ¨å¹¶å‘ç¯å¢ƒä¸‹ä½¿ç”¨è®¿é—®è€…æ¨¡å¼éœ€è¦é¢å¤–è€ƒè™‘çº¿ç¨‹å®‰å…¨

## ğŸ“ æœ€ä½³å®è·µ

1. **åˆç†è®¾è®¡è®¿é—®è€…æ¥å£**ï¼š
   æ¥å£ç²’åº¦è¦é€‚ä¸­ï¼Œé¿å…è¿‡å¤šæ–¹æ³•å¯¼è‡´ç»´æŠ¤å›°éš¾

```java
// è‰¯å¥½çš„è®¿é—®è€…æ¥å£è®¾è®¡
public interface DocumentVisitor {
    // åˆ†ç»„ç›¸å…³æ–¹æ³•
    void visitText(TextElement text);
    void visitImage(ImageElement image);
    void visitTable(TableElement table);
    
    // æä¾›é»˜è®¤å®ç°ï¼Œä¾¿äºæ‰©å±•
    default void visitVideo(VideoElement video) {
        // é»˜è®¤å®ç°æˆ–æŠ›å‡ºä¸æ”¯æŒçš„å¼‚å¸¸
    }
}
```

2. **ä½¿ç”¨é»˜è®¤æ–¹æ³•å¢å¼ºæ‰©å±•æ€§**ï¼š
   åœ¨Java 8+ä¸­ï¼Œå¯ä»¥ä¸ºè®¿é—®è€…æ¥å£æ·»åŠ é»˜è®¤æ–¹æ³•ï¼Œå‡å°‘å¯¹ç°æœ‰å®ç°çš„å½±å“

3. **ç»“åˆç»„åˆæ¨¡å¼ä½¿ç”¨**ï¼š
   è®¿é—®è€…æ¨¡å¼å¸¸ä¸ç»„åˆæ¨¡å¼ä¸€èµ·ä½¿ç”¨ï¼Œå¤„ç†æ ‘å½¢ç»“æ„

4. **ä½¿ç”¨è®¿é—®è€…é›†åˆ**ï¼š
   åˆ›å»ºè®¿é—®è€…é›†åˆï¼Œä¸€æ¬¡æ€§åº”ç”¨å¤šä¸ªè®¿é—®è€…

```java
public class VisitorCollection implements DocumentVisitor {
    private List<DocumentVisitor> visitors = new ArrayList<>();
    
    public void addVisitor(DocumentVisitor visitor) {
        visitors.add(visitor);
    }
    
    @Override
    public void visit(TextElement text) {
        for (DocumentVisitor visitor : visitors) {
            visitor.visit(text);
        }
    }
    
    // å…¶ä»–visitæ–¹æ³•...
}
```

5. **ä½¿ç”¨ç©ºè®¿é—®è€…ä½œä¸ºåŸºç¡€**ï¼š
   æä¾›ä¸€ä¸ªç©ºå®ç°çš„è®¿é—®è€…ç±»ï¼Œå‡å°‘å…·ä½“è®¿é—®è€…çš„å®ç°å·¥ä½œé‡

```java
public class AbstractDocumentVisitor implements DocumentVisitor {
    @Override
    public void visit(TextElement text) {}
    
    @Override
    public void visit(ImageElement image) {}
    
    @Override
    public void visit(TableElement table) {}
}

// å…·ä½“è®¿é—®è€…åªéœ€é‡å†™éœ€è¦çš„æ–¹æ³•
public class WordCountVisitor extends AbstractDocumentVisitor {
    private int wordCount = 0;
    
    @Override
    public void visit(TextElement text) {
        wordCount += text.getContent().split("\\s+").length;
    }
    
    public int getWordCount() { return wordCount; }
}
```

6. **é™åˆ¶è®¿é—®è€…æƒé™**ï¼š
   é€šè¿‡æ¥å£æˆ–åŒ…å¯è§æ€§æ§åˆ¶è®¿é—®è€…å¯¹å…ƒç´ çš„è®¿é—®æƒé™

7. **æ–‡æ¡£åŒ–è®¿é—®è€…åè®®**ï¼š
   æ¸…æ™°è¯´æ˜è®¿é—®è€…ä¸å…ƒç´ ä¹‹é—´çš„äº¤äº’åè®®

8. **è€ƒè™‘ä½¿ç”¨å‡½æ•°å¼æ¥å£æ›¿ä»£ç®€å•è®¿é—®è€…**ï¼š
   Java 8+ä¸­ï¼Œå¯ä»¥ä½¿ç”¨å‡½æ•°å¼æ¥å£ç®€åŒ–ç®€å•è®¿é—®è€…çš„å®ç°

## ğŸ“š ç›¸å…³æ¨¡å¼

- **ç»„åˆæ¨¡å¼**ï¼šè®¿é—®è€…å¸¸ä¸ç»„åˆæ¨¡å¼ä¸€èµ·ä½¿ç”¨ï¼Œéå†ç»„åˆç»“æ„
- **è¿­ä»£å™¨æ¨¡å¼**ï¼šéƒ½ç”¨äºéå†å¯¹è±¡é›†åˆï¼Œä½†è¿­ä»£å™¨ä¾§é‡äºéå†ï¼Œè®¿é—®è€…ä¾§é‡äºæ“ä½œ
- **å‘½ä»¤æ¨¡å¼**ï¼šéƒ½å°è£…æ“ä½œï¼Œä½†å‘½ä»¤æ¨¡å¼å…³æ³¨å¯¹è±¡ä¸Šçš„è¯·æ±‚ï¼Œè®¿é—®è€…å…³æ³¨å¯¹è±¡ç»“æ„ä¸Šçš„æ“ä½œ
- **ç­–ç•¥æ¨¡å¼**ï¼šéƒ½å°è£…ç®—æ³•ï¼Œä½†ç­–ç•¥æ¨¡å¼å°è£…çš„æ˜¯å•ä¸€ç®—æ³•ï¼Œè®¿é—®è€…å°è£…çš„æ˜¯å¯¹å¯¹è±¡ç»“æ„çš„å¤šå…ƒç´ æ“ä½œ
- **è§£é‡Šå™¨æ¨¡å¼**ï¼šè®¿é—®è€…å¯ç”¨äºè§£é‡Šå™¨æ¨¡å¼ä¸­çš„æŠ½è±¡è¯­æ³•æ ‘éå†
- **è£…é¥°å™¨æ¨¡å¼**ï¼šéƒ½å¯ä»¥ä¸ºå¯¹è±¡æ·»åŠ æ–°åŠŸèƒ½ï¼Œä½†è£…é¥°å™¨é€šè¿‡åŒ…è£…å¯¹è±¡å®ç°ï¼Œè®¿é—®è€…é€šè¿‡å¤–éƒ¨æ“ä½œå®ç°
- **è§‚å¯Ÿè€…æ¨¡å¼**ï¼šéƒ½æ¶‰åŠå¯¹è±¡é—´çš„é€šçŸ¥æœºåˆ¶ï¼Œä½†è§‚å¯Ÿè€…æ˜¯è¢«åŠ¨é€šçŸ¥ï¼Œè®¿é—®è€…æ˜¯ä¸»åŠ¨è®¿é—®
- **çŠ¶æ€æ¨¡å¼**ï¼šéƒ½å¯ä»¥æ ¹æ®å¯¹è±¡ç±»å‹æ‰§è¡Œä¸åŒæ“ä½œï¼Œä½†çŠ¶æ€æ¨¡å¼å…³æ³¨å¯¹è±¡è‡ªèº«çŠ¶æ€å˜åŒ–

