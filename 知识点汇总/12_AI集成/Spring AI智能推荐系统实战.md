# Spring AIæ™ºèƒ½æ¨èç³»ç»Ÿå®æˆ˜

> Spring AI + Milvuså‘é‡æ•°æ®åº“æ„å»ºç”µå•†æ™ºèƒ½æ¨èç³»ç»Ÿ

---

## ğŸ“‹ æ¦‚è¿°

**Spring AIæ™ºèƒ½æ¨èç³»ç»Ÿ**æ˜¯åŸºäºSpring AIæ¡†æ¶å’ŒMilvuså‘é‡æ•°æ®åº“æ„å»ºçš„ç”µå•†æ™ºèƒ½æ¨èè§£å†³æ–¹æ¡ˆï¼Œå®ç°äº†åŸºäºç”¨æˆ·è¡Œä¸ºçš„ä¸ªæ€§åŒ–å•†å“æ¨èåŠŸèƒ½ã€‚

### æ ¸å¿ƒåŠŸèƒ½
- âœ… ç”¨æˆ·å…´è¶£å»ºæ¨¡
- âœ… å•†å“å‘é‡ç”Ÿæˆ
- âœ… å‘é‡ç›¸ä¼¼åº¦è®¡ç®—
- âœ… å®æ—¶æ¨èæœåŠ¡
- âœ… çƒ­é—¨å•†å“æ¨è

### æŠ€æœ¯æ ˆ
- **Spring AI**: AIåº”ç”¨å¼€å‘æ¡†æ¶
- **Milvus**: å‘é‡æ•°æ®åº“
- **Spring Boot**: åº”ç”¨æ¡†æ¶
- **Redis**: ç¼“å­˜æœåŠ¡
- **MySQL**: å…³ç³»å‹æ•°æ®åº“

---

## ğŸ“ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     åº”ç”¨å±‚                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  å‰ç«¯åº”ç”¨   â”‚  â”‚  ç§»åŠ¨ç«¯APP  â”‚  â”‚  ç®¡ç†åå°   â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚         â”‚                â”‚                â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                â”‚                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     æœåŠ¡å±‚                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                 RecommendationService             â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚  å•†å“å‘é‡åŒ– â”‚  â”‚ ç”¨æˆ·å…´è¶£å»ºæ¨¡â”‚  â”‚  æ¨èç®—æ³•   â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     æ•°æ®å±‚                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚   Milvus    â”‚  â”‚    Redis    â”‚  â”‚   MySQL     â”‚      â”‚
â”‚  â”‚  å‘é‡å­˜å‚¨   â”‚  â”‚  ç¼“å­˜æœåŠ¡   â”‚  â”‚  å…³ç³»æ•°æ®   â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ æ ¸å¿ƒä»£ç å®ç°

### 1. æ¨èæœåŠ¡æ ¸å¿ƒç±»

```java
@Service
public class RecommendationService {
    private static final String BASE62 = "0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";
    private static final int SHORT_URL_LENGTH = 6;
    private final AiClient aiClient;
    private final MilvusClient milvusClient;
    private final ProductRepository productRepository;
    private final UserBehaviorRepository userBehaviorRepository;
    
    @Value("${milvus.collection.name}")
    private String collectionName;
    
    public RecommendationService(AiClient aiClient, MilvusClient milvusClient, 
                               ProductRepository productRepository, UserBehaviorRepository userBehaviorRepository) {
        this.aiClient = aiClient;
        this.milvusClient = milvusClient;
        this.productRepository = productRepository;
        this.userBehaviorRepository = userBehaviorRepository;
    }
    
    // ç”Ÿæˆå•†å“å‘é‡
    public void generateProductEmbeddings() {
        List<Product> products = productRepository.findAll();
        for (Product product : products) {
            String prompt = String.format("ç”Ÿæˆå•†å“å‘é‡: %s, ç±»åˆ«: %s, æè¿°: %s",
                product.getName(), product.getCategory(), product.getDescription());
            String embedding = aiClient.embed(prompt);
            product.setEmbedding(embedding);
            productRepository.save(product);
            // æ’å…¥Milvuså‘é‡åº“
            insertIntoMilvus(product.getId(), embedding);
        }
    }
    
    // è·å–æ¨èå•†å“
    public List<Product> getRecommendations(String userId, int topK) {
        // è·å–ç”¨æˆ·å†å²äº¤äº’å•†å“
        List<String> productIds = userBehaviorRepository.findProductIdsByUserId(userId);
        if (productIds.isEmpty()) {
            return getPopularProducts(topK);
        }
        
        // è®¡ç®—ç”¨æˆ·å…´è¶£å‘é‡
        String userEmbedding = calculateUserEmbedding(productIds);
        
        // Milvuså‘é‡ç›¸ä¼¼åº¦æœç´¢
        SearchParam searchParam = SearchParam.newBuilder()
            .withCollectionName(collectionName)
            .withVectorFieldName("embedding")
            .withVectors(List.of(parseEmbedding(userEmbedding)))
            .withTopK(topK)
            .withMetricType(MetricType.COSINE)
            .build();
        
        SearchResults results = milvusClient.search(searchParam);
        return extractProductIds(results);
    }
    
    // è®¡ç®—ç”¨æˆ·å…´è¶£å‘é‡
    private String calculateUserEmbedding(List<String> productIds) {
        List<Product> products = productRepository.findAllById(productIds);
        List<double[]> embeddings = products.stream()
            .map(product -> parseEmbedding(product.getEmbedding()))
            .collect(Collectors.toList());
        
        // ç®€å•å¹³å‡ç”¨æˆ·æ‰€æœ‰äº¤äº’å•†å“çš„å‘é‡
        double[] userVector = new double[embeddings.get(0).length];
        for (double[] embedding : embeddings) {
            for (int i = 0; i < embedding.length; i++) {
                userVector[i] += embedding[i];
            }
        }
        for (int i = 0; i < userVector.length; i++) {
            userVector[i] /= embeddings.size();
        }
        
        return Arrays.toString(userVector);
    }
    
    // å°†å­—ç¬¦ä¸²æ ¼å¼çš„å‘é‡è§£æä¸ºdoubleæ•°ç»„
    private double[] parseEmbedding(String embeddingStr) {
        return Arrays.stream(embeddingStr.replaceAll("\\[|\\]", "").split(","))
            .mapToDouble(Double::parseDouble)
            .toArray();
    }
    
    // æ’å…¥å‘é‡åˆ°Milvus
    private void insertIntoMilvus(Long productId, String embedding) {
        List<InsertParam.Field> fields = new ArrayList<>();
        fields.add(new InsertParam.Field("product_id", Collections.singletonList(productId)));
        fields.add(new InsertParam.Field("embedding", Collections.singletonList(parseEmbedding(embedding))));
        
        InsertParam insertParam = InsertParam.newBuilder()
            .withCollectionName(collectionName)
            .withFields(fields)
            .build();
        
        milvusClient.insert(insertParam);
    }
    
    // ä»æœç´¢ç»“æœä¸­æå–å•†å“ID
    private List<Product> extractProductIds(SearchResults results) {
        List<String> productIds = new ArrayList<>();
        for (SearchResults.QueryResult queryResult : results.getQueryResults()) {
            for (SearchResults.SearchResult searchResult : queryResult.getSearchResults()) {
                productIds.add(searchResult.getID());
            }
        }
        return productRepository.findAllById(productIds);
    }
    
    // è·å–çƒ­é—¨å•†å“ï¼ˆåŸºäºç‚¹å‡»é‡ï¼‰
    private List<Product> getPopularProducts(int topK) {
        return productRepository.findTopKByViewCount(topK);
    }
}
```

### 2. å®ä½“ç±»å®šä¹‰

```java
@Entity
@Table(name = "products")
public class Product {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    private String name;
    private String category;
    private String description;
    private double price;
    private String embedding; // å•†å“å‘é‡
    private int viewCount; // ç‚¹å‡»é‡
    
    // getter and setter methods
}

@Entity
@Table(name = "user_behavior")
public class UserBehavior {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    private String userId;
    private String productId;
    private String behaviorType; // view, click, purchase, etc.
    private long timestamp;
    
    // getter and setter methods
}
```

### 3. Repositoryå±‚

```java
@Repository
public interface ProductRepository extends JpaRepository<Product, Long> {
    List<Product> findTop10ByOrderByViewCountDesc(); // è·å–çƒ­é—¨å•†å“
}

@Repository
public interface UserBehaviorRepository extends JpaRepository<UserBehavior, Long> {
    List<String> findProductIdsByUserId(String userId); // è·å–ç”¨æˆ·å†å²äº¤äº’å•†å“ID
}
```

---

## ğŸ¯ åº”ç”¨åœºæ™¯

1. **ç”µå•†å¹³å°ä¸ªæ€§åŒ–æ¨è**ï¼šä¸ºç”¨æˆ·æ¨èæ„Ÿå…´è¶£çš„å•†å“
2. **å†…å®¹å¹³å°æ¨è**ï¼šæ¨èæ–‡ç« ã€è§†é¢‘ã€éŸ³ä¹ç­‰å†…å®¹
3. **ç¤¾äº¤å¹³å°æ¨è**ï¼šæ¨èå¥½å‹ã€ç¾¤ç»„ã€åŠ¨æ€ç­‰
4. **ä¼ä¸šå†…éƒ¨çŸ¥è¯†æ¨è**ï¼šæ¨èæ–‡æ¡£ã€ä¸“å®¶ã€åŸ¹è®­è¯¾ç¨‹ç­‰

---

## ğŸ”§ é…ç½®ä¸éƒ¨ç½²

### 1. Milvuså‘é‡æ•°æ®åº“é…ç½®

```yaml
spring:
  milvus:
    host: localhost
    port: 19530
    collection-name: product_embeddings
    vector-field-name: embedding
    vector-dimension: 1536 # æ ¹æ®ä½¿ç”¨çš„æ¨¡å‹è°ƒæ•´
```

### 2. Spring AIé…ç½®

```yaml
spring:
  ai:
    openai:
      api-key: ${OPENAI_API_KEY}
      embedding:
        model: text-embedding-ada-002
```

### 3. éƒ¨ç½²æ–¹å¼

- **Dockeréƒ¨ç½²**ï¼šä½¿ç”¨Docker Composeä¸€é”®éƒ¨ç½²Spring Bootåº”ç”¨ã€Milvuså‘é‡æ•°æ®åº“å’ŒRedis
- **Kuberneteséƒ¨ç½²**ï¼šå°†åº”ç”¨æ‰“åŒ…ä¸ºDockeré•œåƒï¼Œä½¿ç”¨Kubernetesè¿›è¡Œå®¹å™¨åŒ–éƒ¨ç½²

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

1. **å‘é‡ç¼“å­˜**ï¼šå°†çƒ­é—¨å•†å“å‘é‡ç¼“å­˜åˆ°Redisï¼Œå‡å°‘MilvusæŸ¥è¯¢å‹åŠ›
2. **æ‰¹é‡å¤„ç†**ï¼šæ‰¹é‡ç”Ÿæˆå•†å“å‘é‡ï¼Œå‡å°‘APIè°ƒç”¨æ¬¡æ•°
3. **å¼‚æ­¥å¤„ç†**ï¼šä½¿ç”¨Spring Asyncå¼‚æ­¥ç”Ÿæˆå•†å“å‘é‡
4. **ç´¢å¼•ä¼˜åŒ–**ï¼šä¸ºMilvuså‘é‡å­—æ®µåˆ›å»ºåˆé€‚çš„ç´¢å¼•

---

## ğŸ” ç›‘æ§ä¸ç»´æŠ¤

1. **æ—¥å¿—ç›‘æ§**ï¼šä½¿ç”¨ELK Stackæ”¶é›†å’Œåˆ†æåº”ç”¨æ—¥å¿—
2. **æ€§èƒ½ç›‘æ§**ï¼šä½¿ç”¨Prometheuså’ŒGrafanaç›‘æ§ç³»ç»Ÿæ€§èƒ½
3. **å‘é‡æ›´æ–°ç­–ç•¥**ï¼šå®šæœŸæ›´æ–°å•†å“å‘é‡ï¼Œç¡®ä¿æ¨èå‡†ç¡®æ€§
4. **A/Bæµ‹è¯•**ï¼šé€šè¿‡A/Bæµ‹è¯•è¯„ä¼°æ¨èç®—æ³•æ•ˆæœ

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Spring AIè¯¦è§£.md](./Spring AIè¯¦è§£.md)
- [Java AIå¼€å‘å®æˆ˜.md](./Java AIå¼€å‘å®æˆ˜.md)
- [LangChain4jè¯¦è§£.md](./LangChain4jè¯¦è§£.md)

---

> ğŸ‰ **Spring AIæ™ºèƒ½æ¨èç³»ç»Ÿå®æˆ˜** - è®©ä½ çš„åº”ç”¨æ‹¥æœ‰AIå¤§è„‘ï¼