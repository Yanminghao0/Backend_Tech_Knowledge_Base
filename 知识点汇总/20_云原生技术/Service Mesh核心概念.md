# Service Meshæ ¸å¿ƒæ¦‚å¿µä¸å®è·µ

> äº‘åŸç”Ÿæ¶æ„ä¸‹çš„å¾®æœåŠ¡é€šä¿¡ä¸æ²»ç†è§£å†³æ–¹æ¡ˆ

## ğŸ“‹ ç›®å½•

1. [Service Meshæ¦‚è¿°](#1-servicemeshæ¦‚è¿°)
2. [æ¶æ„ç»„æˆ](#2-æ¶æ„ç»„æˆ)
3. [æ ¸å¿ƒåŠŸèƒ½](#3-æ ¸å¿ƒåŠŸèƒ½)
4. [ä¸»æµå®ç°å¯¹æ¯”](#4-ä¸»æµå®ç°å¯¹æ¯”)
5. [Istioå®æˆ˜](#5-istioå®æˆ˜)
6. [æ€§èƒ½ä¼˜åŒ–](#6-æ€§èƒ½ä¼˜åŒ–)
7. [éƒ¨ç½²ç­–ç•¥](#7-éƒ¨ç½²ç­–ç•¥)
8. [æœªæ¥è¶‹åŠ¿](#8-æœªæ¥è¶‹åŠ¿)

---

## 1. Service Meshæ¦‚è¿°

### 1.1 å®šä¹‰ä¸æ¼”è¿›

Service Meshï¼ˆæœåŠ¡ç½‘æ ¼ï¼‰æ˜¯ä¸€ä¸ªä¸“é—¨å¤„ç†æœåŠ¡é—´é€šä¿¡çš„åŸºç¡€è®¾æ–½å±‚ï¼Œè´Ÿè´£åœ¨äº‘åŸç”Ÿåº”ç”¨çš„å¾®æœåŠ¡ä¹‹é—´å¯é åœ°ä¼ é€’è¯·æ±‚ã€‚

**æ¼”è¿›å†ç¨‹**ï¼š
- å•ä½“æ¶æ„ â†’ åˆ†å¸ƒå¼æ¶æ„ â†’ å¾®æœåŠ¡æ¶æ„ â†’ Service Meshæ¶æ„
- ä»ä»£ç ä¾µå…¥å¼æ¡†æ¶ï¼ˆå¦‚Spring Cloudï¼‰åˆ°é€æ˜ä»£ç†å±‚

### 1.2 è§£å†³çš„æ ¸å¿ƒé—®é¢˜

- æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡
- æµé‡ç®¡ç†ä¸æ§åˆ¶
- å®‰å…¨é€šä¿¡ï¼ˆåŠ å¯†ã€è®¤è¯ã€æˆæƒï¼‰
- å¯è§‚æµ‹æ€§ï¼ˆç›‘æ§ã€è¿½è¸ªã€æ—¥å¿—ï¼‰
- æ•…éšœæ¢å¤ä¸å¼¹æ€§èƒ½åŠ›

```mermaid
graph TD
    A[ä¼ ç»Ÿå¾®æœåŠ¡æ¶æ„] -->|é—®é¢˜| B[æœåŠ¡æ²»ç†é€»è¾‘ä¸ä¸šåŠ¡ä»£ç è€¦åˆ]
    A -->|é—®é¢˜| C[å¤šè¯­è¨€æ ˆæ²»ç†ä¸ä¸€è‡´]
    A -->|é—®é¢˜| D[è¿ç»´å¤æ‚åº¦é«˜]
    B --> E[Service Meshæ¶æ„]
    C --> E
    D --> E
    E --> F[æ²»ç†é€»è¾‘ä¸‹æ²‰åˆ°åŸºç¡€è®¾æ–½å±‚]
    E --> G[é€æ˜ä»£ç†é€šä¿¡]
    E --> H[ç»Ÿä¸€æ§åˆ¶é¢æ¿]
```

---

## 2. æ¶æ„ç»„æˆ

### 2.1 åŒå±‚æ¶æ„

| å¹³é¢ | ç»„ä»¶ | åŠŸèƒ½ |
|------|------|------|
| **æ•°æ®å¹³é¢** | ä»£ç†ï¼ˆSidecarï¼‰ | å¤„ç†æœåŠ¡é—´é€šä¿¡ï¼Œæ‰§è¡Œæµé‡ç­–ç•¥ï¼Œæ”¶é›†é¥æµ‹æ•°æ® |
| **æ§åˆ¶å¹³é¢** | ç®¡ç†èŠ‚ç‚¹ | æä¾›é…ç½®ã€ç­–ç•¥å’ŒæœåŠ¡å‘ç°ï¼Œä¸ç›´æ¥å¤„ç†æ•°æ®æµé‡ |

### 2.2 å…¸å‹éƒ¨ç½²æ¨¡å¼

**Sidecaræ¨¡å¼**ï¼š
- æ¯ä¸ªæœåŠ¡å®ä¾‹æ—éƒ¨ç½²ä¸€ä¸ªä»£ç†å®¹å™¨
- æœåŠ¡é—´é€šä¿¡é€šè¿‡Sidecarè½¬å‘
- å¯¹åº”ç”¨å®Œå…¨é€æ˜ï¼Œæ— éœ€ä¿®æ”¹ä»£ç 

```mermaid
graph LR
    subgraph æœåŠ¡ç½‘æ ¼
        subgraph æ§åˆ¶å¹³é¢
            M[Istiod/Control Plane]
        end
        subgraph æ•°æ®å¹³é¢
            A[Sidecar] --> B[Sidecar]
            C[Sidecar] --> D[Sidecar]
        end
    end
    M -->|é…ç½®| A
    M -->|é…ç½®| B
    M -->|é…ç½®| C
    M -->|é…ç½®| D
    A -->|é€šä¿¡| B
    C -->|é€šä¿¡| D
```

---

## 3. æ ¸å¿ƒåŠŸèƒ½

### 3.1 æµé‡ç®¡ç†

- **åŠ¨æ€è·¯ç”±**ï¼šåŸºäºæƒé‡ã€Headerã€è·¯å¾„çš„æµé‡åˆ†é…
- **æµé‡æ§åˆ¶**ï¼šè¶…æ—¶ã€é‡è¯•ã€ç†”æ–­ã€é™æµ
- **ç°åº¦å‘å¸ƒ**ï¼šé‡‘ä¸é›€ã€è“ç»¿éƒ¨ç½²ã€A/Bæµ‹è¯•

```yaml
# Istioè™šæ‹ŸæœåŠ¡ç¤ºä¾‹
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: payment-service
spec:
  hosts:
  - payment-service
  http:
  - route:
    - destination:
        host: payment-service
        subset: v1
      weight: 90
    - destination:
        host: payment-service
        subset: v2
      weight: 10
```

### 3.2 å®‰å…¨é€šä¿¡

- **mTLS**ï¼šæœåŠ¡é—´é€šä¿¡åŠ å¯†
- **èº«ä»½è®¤è¯**ï¼šåŸºäºSPIFFEçš„æœåŠ¡èº«ä»½æ ‡è¯†
- **æˆæƒç­–ç•¥**ï¼šç»†ç²’åº¦è®¿é—®æ§åˆ¶
- **å¯†é’¥ç®¡ç†**ï¼šè‡ªåŠ¨è¯ä¹¦è½®æ¢

### 3.3 å¯è§‚æµ‹æ€§

- **é¥æµ‹æ•°æ®**ï¼šæŒ‡æ ‡ã€æ—¥å¿—ã€è¿½è¸ª
- **åˆ†å¸ƒå¼è¿½è¸ª**ï¼šè¯·æ±‚æµç»æ‰€æœ‰æœåŠ¡çš„å®Œæ•´è·¯å¾„
- **æœåŠ¡ç½‘æ ¼ç›‘æ§**ï¼šæ•°æ®å¹³é¢å’Œæ§åˆ¶å¹³é¢ç›‘æ§

### 3.4 æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡

- ä¸Kubernetesç­‰å®¹å™¨ç¼–æ’å¹³å°é›†æˆ
- é«˜çº§è´Ÿè½½å‡è¡¡ç®—æ³•ï¼ˆè½®è¯¢ã€æœ€å°è¿æ¥ã€ä¸€è‡´æ€§å“ˆå¸Œï¼‰
- å¥åº·æ£€æŸ¥ä¸å®ä¾‹å‰”é™¤

---

## 4. ä¸»æµå®ç°å¯¹æ¯”

| ç‰¹æ€§ | Istio | Linkerd | Consul Connect | Traefik Mesh |
|------|-------|---------|----------------|--------------|
| **æ•°æ®å¹³é¢** | Envoy | Linkerd Proxy | Envoy | Traefik |
| **æ§åˆ¶å¹³é¢** | Istiod | Controller | Consul Server | Traefik Pilot |
| **è¯­è¨€** | Go | Rust/Go | Go | Go |
| **æˆç†Ÿåº¦** | é«˜ | ä¸­ | ä¸­ | ä¸­ |
| **æ€§èƒ½å¼€é”€** | ä¸­é«˜ | ä½ | ä¸­ | ä¸­ |
| **åŠŸèƒ½ä¸°å¯Œåº¦** | ä¸°å¯Œ | ç²¾ç®€ | ä¸­ç­‰ | ä¸­ç­‰ |
| **æ˜“ç”¨æ€§** | ä¸­ç­‰ | é«˜ | é«˜ | é«˜ |
| **ç¤¾åŒºæ´»è·ƒåº¦** | é«˜ | ä¸­ | ä¸­ | ä¸­ |

---

## 5. Istioå®æˆ˜

### 5.1 ç¯å¢ƒéƒ¨ç½²

```bash
# ä½¿ç”¨Istioctlå®‰è£…
istioctl install --set profile=demo -y

# éƒ¨ç½²ç¤ºä¾‹åº”ç”¨ï¼ˆBookinfoï¼‰
kubectl label namespace default istio-injection=enabled
kubectl apply -f samples/bookinfo/platform/kube/bookinfo.yaml

# é…ç½®ç½‘å…³
kubectl apply -f samples/bookinfo/networking/bookinfo-gateway.yaml
```

### 5.2 æµé‡ç®¡ç†ç¤ºä¾‹

**1. æ•…éšœæ³¨å…¥**ï¼š
```yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: ratings
spec:
  hosts:
  - ratings
  http:
  - fault:
      delay:
        percentage:
          value: 50
        fixedDelay: 7s
    route:
    - destination:
        host: ratings
        subset: v1
```

**2. ç†”æ–­é…ç½®**ï¼š
```yaml
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: reviews
spec:
  host: reviews
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 100
      http:
        http1MaxPendingRequests: 100
        maxRequestsPerConnection: 10
    outlierDetection:
      consecutiveErrors: 5
      interval: 30s
      baseEjectionTime: 30s
  subsets:
  - name: v1
    labels:
      version: v1
```

### 5.3 ç›‘æ§é…ç½®

```yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: istio-proxies
  namespace: istio-system
spec:
  selector:
    matchLabels:
      istio.io/rev: default
  endpoints:
  - port: http-monitoring
    interval: 15s
```

---

## 6. æ€§èƒ½ä¼˜åŒ–

### 6.1 å…³é”®ä¼˜åŒ–æ–¹å‘

- **èµ„æºé…ç½®**ï¼šåˆç†è®¾ç½®Sidecar CPU/å†…å­˜é™åˆ¶
- **è¿æ¥å¤ç”¨**ï¼šå¯ç”¨HTTP/2é•¿è¿æ¥
- **åè®®é€‰æ‹©**ï¼šä¼˜å…ˆä½¿ç”¨gRPCè€ŒéREST
- **ç¼“å­˜ç­–ç•¥**ï¼šä¼˜åŒ–æ§åˆ¶å¹³é¢é…ç½®æ¨é€
- **æµé‡é‡‡æ ·**ï¼šåˆç†è®¾ç½®åˆ†å¸ƒå¼è¿½è¸ªé‡‡æ ·ç‡

### 6.2 æ€§èƒ½æµ‹è¯•æŒ‡æ ‡

- å»¶è¿Ÿï¼ˆP50/P90/P99ï¼‰
- ååé‡ï¼ˆæ¯ç§’è¯·æ±‚æ•°ï¼‰
- èµ„æºå ç”¨ï¼ˆCPU/å†…å­˜ï¼‰
- è¿æ¥æ•°

---

## 7. éƒ¨ç½²ç­–ç•¥

### 7.1 æ¸è¿›å¼éƒ¨ç½²

1. **è¯•ç‚¹é˜¶æ®µ**ï¼šé€‰æ‹©éå…³é”®æœåŠ¡éƒ¨ç½²
2. **æ‰©å±•é˜¶æ®µ**ï¼šé€æ­¥æ‰©å±•åˆ°æ ¸å¿ƒæœåŠ¡
3. **å…¨é¢éƒ¨ç½²**ï¼šæ‰€æœ‰æœåŠ¡æ¥å…¥Service Mesh

### 7.2 è¿ç§»ç­–ç•¥

- **å¢é‡è¿ç§»**ï¼šæŒ‰æœåŠ¡é€æ­¥è¿ç§»
- **é‡‘ä¸é›€è¿ç§»**ï¼šæ–°æ—§ç³»ç»Ÿå¹¶è¡Œè¿è¡Œ
- **æµé‡åˆ‡æ¢**ï¼šé€šè¿‡æƒé‡é€æ­¥åˆ‡æ¢æµé‡

---

## 8. æœªæ¥è¶‹åŠ¿

### 8.1 æŠ€æœ¯å‘å±•æ–¹å‘

- **è½»é‡çº§åŒ–**ï¼šé™ä½æ€§èƒ½å¼€é”€
- **eBPFæŠ€æœ¯**ï¼šæ›¿ä»£Sidecaræ¨¡å¼
- **Serverlessé›†æˆ**ï¼šæ— æœåŠ¡å™¨æ¶æ„é€‚é…
- **AIè¾…åŠ©è¿ç»´**ï¼šæ™ºèƒ½æµé‡ç®¡ç†ä¸æ•…éšœé¢„æµ‹

### 8.2 æ ‡å‡†åŒ–è¿›å±•

- Service Mesh Interface (SMI)è§„èŒƒ
- å¤šå¹³å°é€‚é…èƒ½åŠ›å¢å¼º
- ä¸äº‘å‚å•†æœåŠ¡æ·±åº¦é›†æˆ

---

## ğŸ“š å‚è€ƒèµ„æº

- [Istioå®˜æ–¹æ–‡æ¡£](https://istio.io/latest/docs/)
- [Linkerdå®˜æ–¹æ–‡æ¡£](https://linkerd.io/2.12/docs/)
- [Service Mesh Patterns](https://servicemeshpatterns.io/)
- [äº‘åŸç”ŸæœåŠ¡ç½‘æ ¼æŠ€æœ¯ç™½çš®ä¹¦](https://www.cncf.io/reports/service-mesh/)