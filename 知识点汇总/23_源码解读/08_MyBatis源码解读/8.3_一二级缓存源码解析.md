# MyBatisä¸€äºŒçº§ç¼“å­˜æºç è§£æ

> æ·±å…¥åˆ†æMyBatisç¼“å­˜æœºåˆ¶ï¼ŒæŒæ¡ä¸€çº§ç¼“å­˜å’ŒäºŒçº§ç¼“å­˜çš„å®ç°åŸç†

---

## ğŸ“š ç›®å½•

1. [ç¼“å­˜ä½“ç³»æ¦‚è¿°](#1-ç¼“å­˜ä½“ç³»æ¦‚è¿°)
2. [ä¸€çº§ç¼“å­˜æºç ](#2-ä¸€çº§ç¼“å­˜æºç )
3. [äºŒçº§ç¼“å­˜æºç ](#3-äºŒçº§ç¼“å­˜æºç )
4. [ç¼“å­˜è£…é¥°å™¨](#4-ç¼“å­˜è£…é¥°å™¨)
5. [ç¼“å­˜å¤±æ•ˆåœºæ™¯](#5-ç¼“å­˜å¤±æ•ˆåœºæ™¯)
6. [åˆ†å¸ƒå¼ç¯å¢ƒé—®é¢˜](#6-åˆ†å¸ƒå¼ç¯å¢ƒé—®é¢˜)
7. [æµç¨‹å›¾è§£](#7-æµç¨‹å›¾è§£)
8. [é¢è¯•è¦ç‚¹](#8-é¢è¯•è¦ç‚¹)

---

## 1. ç¼“å­˜ä½“ç³»æ¦‚è¿°

### 1.1 ç¼“å­˜å±‚æ¬¡ç»“æ„

```
MyBatisç¼“å­˜ä½“ç³»ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      åº”ç”¨ç¨‹åº                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   äºŒçº§ç¼“å­˜ (Mapperçº§åˆ«)                      â”‚
â”‚                   CachingExecutor                           â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚                   â”‚  TransactionalCache                     â”‚
â”‚                   â”‚  (äº‹åŠ¡ç¼“å­˜ç®¡ç†å™¨)                        â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ä¸€çº§ç¼“å­˜ (SqlSessionçº§åˆ«)                  â”‚
â”‚                   BaseExecutor.localCache                   â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚                   â”‚  PerpetualCache â”‚                       â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ•°æ®åº“                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 ç¼“å­˜æ¥å£å®šä¹‰

```java
/**
 * Cacheï¼šç¼“å­˜æ¥å£
 */
public interface Cache {
    
    /**
     * è·å–ç¼“å­˜ID
     */
    String getId();
    
    /**
     * å­˜å…¥ç¼“å­˜
     */
    void putObject(Object key, Object value);
    
    /**
     * è·å–ç¼“å­˜
     */
    Object getObject(Object key);
    
    /**
     * ç§»é™¤ç¼“å­˜
     */
    Object removeObject(Object key);
    
    /**
     * æ¸…ç©ºç¼“å­˜
     */
    void clear();
    
    /**
     * è·å–ç¼“å­˜å¤§å°
     */
    int getSize();
}
```

### 1.3 ä¸€çº§ç¼“å­˜ vs äºŒçº§ç¼“å­˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ä¸€çº§ç¼“å­˜ vs äºŒçº§ç¼“å­˜ å¯¹æ¯”                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    ç‰¹æ€§      â”‚    ä¸€çº§ç¼“å­˜     â”‚      äºŒçº§ç¼“å­˜             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ä½œç”¨åŸŸ      â”‚  SqlSession     â”‚  Mapper (namespace)       â”‚
â”‚  é»˜è®¤çŠ¶æ€    â”‚  å¼€å¯           â”‚  å…³é—­                     â”‚
â”‚  å­˜å‚¨ä½ç½®    â”‚  BaseExecutor   â”‚  MappedStatement          â”‚
â”‚  ç”Ÿå‘½å‘¨æœŸ    â”‚  SqlSession     â”‚  åº”ç”¨çº§åˆ«                 â”‚
â”‚  æ•°æ®å…±äº«    â”‚  ä¸å…±äº«         â”‚  å¤šSqlSessionå…±äº«         â”‚
â”‚  å®ç°ç±»      â”‚  PerpetualCache â”‚  å¯é…ç½®å¤šç§å®ç°           â”‚
â”‚  äº‹åŠ¡æ„ŸçŸ¥    â”‚  å¦             â”‚  æ˜¯                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


---

## 2. ä¸€çº§ç¼“å­˜æºç 

### 2.1 PerpetualCacheå®ç°

```java
/**
 * PerpetualCacheï¼šæ°¸ä¹…ç¼“å­˜
 * ä¸€çº§ç¼“å­˜çš„é»˜è®¤å®ç°ï¼ŒåŸºäºHashMap
 */
public class PerpetualCache implements Cache {
    
    // ç¼“å­˜ID
    private final String id;
    
    // ç¼“å­˜å­˜å‚¨ï¼ˆHashMapï¼‰
    private final Map<Object, Object> cache = new HashMap<>();
    
    public PerpetualCache(String id) {
        this.id = id;
    }
    
    @Override
    public String getId() {
        return id;
    }
    
    @Override
    public int getSize() {
        return cache.size();
    }
    
    @Override
    public void putObject(Object key, Object value) {
        cache.put(key, value);
    }
    
    @Override
    public Object getObject(Object key) {
        return cache.get(key);
    }
    
    @Override
    public Object removeObject(Object key) {
        return cache.remove(key);
    }
    
    @Override
    public void clear() {
        cache.clear();
    }
    
    @Override
    public boolean equals(Object o) {
        if (getId() == null) {
            throw new CacheException("Cache instances require an ID.");
        }
        if (this == o) {
            return true;
        }
        if (!(o instanceof Cache)) {
            return false;
        }
        Cache otherCache = (Cache) o;
        return getId().equals(otherCache.getId());
    }
    
    @Override
    public int hashCode() {
        if (getId() == null) {
            throw new CacheException("Cache instances require an ID.");
        }
        return getId().hashCode();
    }
}
```

### 2.2 BaseExecutorä¸­çš„ä¸€çº§ç¼“å­˜

```java
/**
 * BaseExecutorï¼šæ‰§è¡Œå™¨åŸºç±»
 * å®ç°ä¸€çº§ç¼“å­˜é€»è¾‘
 */
public abstract class BaseExecutor implements Executor {
    
    // ä¸€çº§ç¼“å­˜
    protected PerpetualCache localCache;
    
    // å­˜å‚¨è¿‡ç¨‹è¾“å‡ºå‚æ•°ç¼“å­˜
    protected PerpetualCache localOutputParameterCache;
    
    protected BaseExecutor(Configuration configuration, Transaction transaction) {
        this.transaction = transaction;
        this.deferredLoads = new ConcurrentLinkedQueue<>();
        this.localCache = new PerpetualCache("LocalCache");
        this.localOutputParameterCache = new PerpetualCache("LocalOutputParameterCache");
        this.closed = false;
        this.configuration = configuration;
        this.wrapper = this;
    }
    
    /**
     * æŸ¥è¯¢æ–¹æ³•ï¼ˆä½¿ç”¨ä¸€çº§ç¼“å­˜ï¼‰
     */
    @Override
    public <E> List<E> query(MappedStatement ms, Object parameter, RowBounds rowBounds,
            ResultHandler resultHandler, CacheKey key, BoundSql boundSql) throws SQLException {
        ErrorContext.instance().resource(ms.getResource())
            .activity("executing a query").object(ms.getId());
        if (closed) {
            throw new ExecutorException("Executor was closed.");
        }
        
        // 1. å¦‚æœéœ€è¦æ¸…ç©ºç¼“å­˜
        if (queryStack == 0 && ms.isFlushCacheRequired()) {
            clearLocalCache();
        }
        
        List<E> list;
        try {
            queryStack++;
            // 2. å…ˆä»ä¸€çº§ç¼“å­˜è·å–
            list = resultHandler == null ? 
                (List<E>) localCache.getObject(key) : null;
            if (list != null) {
                // 3. ç¼“å­˜å‘½ä¸­
                handleLocallyCachedOutputParameters(ms, key, parameter, boundSql);
            } else {
                // 4. ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“
                list = queryFromDatabase(ms, parameter, rowBounds, 
                    resultHandler, key, boundSql);
            }
        } finally {
            queryStack--;
        }
        
        // 5. å¤„ç†å»¶è¿ŸåŠ è½½
        if (queryStack == 0) {
            for (DeferredLoad deferredLoad : deferredLoads) {
                deferredLoad.load();
            }
            deferredLoads.clear();
            // å¦‚æœç¼“å­˜ä½œç”¨åŸŸæ˜¯STATEMENTï¼Œæ¸…ç©ºç¼“å­˜
            if (configuration.getLocalCacheScope() == LocalCacheScope.STATEMENT) {
                clearLocalCache();
            }
        }
        return list;
    }
    
    /**
     * ä»æ•°æ®åº“æŸ¥è¯¢
     */
    private <E> List<E> queryFromDatabase(MappedStatement ms, Object parameter,
            RowBounds rowBounds, ResultHandler resultHandler, CacheKey key,
            BoundSql boundSql) throws SQLException {
        List<E> list;
        // 1. å…ˆæ”¾å…¥å ä½ç¬¦ï¼ˆè§£å†³å¾ªç¯ä¾èµ–ï¼‰
        localCache.putObject(key, EXECUTION_PLACEHOLDER);
        try {
            // 2. æ‰§è¡ŒæŸ¥è¯¢
            list = doQuery(ms, parameter, rowBounds, resultHandler, boundSql);
        } finally {
            // 3. ç§»é™¤å ä½ç¬¦
            localCache.removeObject(key);
        }
        // 4. æ”¾å…¥ç¼“å­˜
        localCache.putObject(key, list);
        return list;
    }
    
    /**
     * æ›´æ–°æ“ä½œï¼ˆæ¸…ç©ºä¸€çº§ç¼“å­˜ï¼‰
     */
    @Override
    public int update(MappedStatement ms, Object parameter) throws SQLException {
        ErrorContext.instance().resource(ms.getResource())
            .activity("executing an update").object(ms.getId());
        if (closed) {
            throw new ExecutorException("Executor was closed.");
        }
        // æ›´æ–°å‰æ¸…ç©ºä¸€çº§ç¼“å­˜
        clearLocalCache();
        return doUpdate(ms, parameter);
    }
    
    /**
     * æ¸…ç©ºä¸€çº§ç¼“å­˜
     */
    @Override
    public void clearLocalCache() {
        if (!closed) {
            localCache.clear();
            localOutputParameterCache.clear();
        }
    }
}
```

### 2.3 CacheKeyç¼“å­˜é”®

```java
/**
 * CacheKeyï¼šç¼“å­˜é”®
 * ç”±å¤šä¸ªå› ç´ ç»„æˆï¼Œç¡®ä¿å”¯ä¸€æ€§
 */
public class CacheKey implements Cloneable, Serializable {
    
    private static final int DEFAULT_MULTIPLIER = 37;
    private static final int DEFAULT_HASHCODE = 17;
    
    private final int multiplier;
    private int hashcode;
    private long checksum;
    private int count;
    private List<Object> updateList;
    
    /**
     * æ›´æ–°CacheKey
     */
    public void update(Object object) {
        int baseHashCode = object == null ? 1 : ArrayUtil.hashCode(object);
        count++;
        checksum += baseHashCode;
        baseHashCode *= count;
        hashcode = multiplier * hashcode + baseHashCode;
        updateList.add(object);
    }
}

// BaseExecutorä¸­åˆ›å»ºCacheKey
@Override
public CacheKey createCacheKey(MappedStatement ms, Object parameterObject,
        RowBounds rowBounds, BoundSql boundSql) {
    CacheKey cacheKey = new CacheKey();
    // 1. MappedStatementçš„ID
    cacheKey.update(ms.getId());
    // 2. åˆ†é¡µå‚æ•°offset
    cacheKey.update(rowBounds.getOffset());
    // 3. åˆ†é¡µå‚æ•°limit
    cacheKey.update(rowBounds.getLimit());
    // 4. SQLè¯­å¥
    cacheKey.update(boundSql.getSql());
    // 5. å‚æ•°å€¼
    List<ParameterMapping> parameterMappings = boundSql.getParameterMappings();
    for (ParameterMapping parameterMapping : parameterMappings) {
        if (parameterMapping.getMode() != ParameterMode.OUT) {
            Object value = /* è·å–å‚æ•°å€¼ */;
            cacheKey.update(value);
        }
    }
    // 6. ç¯å¢ƒID
    if (configuration.getEnvironment() != null) {
        cacheKey.update(configuration.getEnvironment().getId());
    }
    return cacheKey;
}
```

---

## 3. äºŒçº§ç¼“å­˜æºç 

### 3.1 å¼€å¯äºŒçº§ç¼“å­˜

```xml
<!-- mybatis-config.xml -->
<settings>
    <!-- å…¨å±€å¼€å¯äºŒçº§ç¼“å­˜ï¼ˆé»˜è®¤trueï¼‰ -->
    <setting name="cacheEnabled" value="true"/>
</settings>

<!-- Mapper.xml -->
<mapper namespace="com.example.mapper.UserMapper">
    <!-- å¼€å¯å½“å‰Mapperçš„äºŒçº§ç¼“å­˜ -->
    <cache/>
    
    <!-- æˆ–è€…è¯¦ç»†é…ç½® -->
    <cache
        eviction="LRU"
        flushInterval="60000"
        size="512"
        readOnly="true"/>
</mapper>
```

### 3.2 CachingExecutorè£…é¥°å™¨

```java
/**
 * CachingExecutorï¼šç¼“å­˜æ‰§è¡Œå™¨
 * è£…é¥°å™¨æ¨¡å¼ï¼Œä¸ºExecutoræ·»åŠ äºŒçº§ç¼“å­˜åŠŸèƒ½
 */
public class CachingExecutor implements Executor {
    
    // è¢«è£…é¥°çš„æ‰§è¡Œå™¨
    private final Executor delegate;
    
    // äº‹åŠ¡ç¼“å­˜ç®¡ç†å™¨
    private final TransactionalCacheManager tcm = new TransactionalCacheManager();
    
    public CachingExecutor(Executor delegate) {
        this.delegate = delegate;
        delegate.setExecutorWrapper(this);
    }
    
    /**
     * æŸ¥è¯¢ï¼ˆä½¿ç”¨äºŒçº§ç¼“å­˜ï¼‰
     */
    @Override
    public <E> List<E> query(MappedStatement ms, Object parameterObject, RowBounds rowBounds,
            ResultHandler resultHandler, CacheKey key, BoundSql boundSql) throws SQLException {
        // 1. è·å–MappedStatementçš„ç¼“å­˜
        Cache cache = ms.getCache();
        if (cache != null) {
            // 2. å¦‚æœéœ€è¦åˆ·æ–°ç¼“å­˜
            flushCacheIfRequired(ms);
            if (ms.isUseCache() && resultHandler == null) {
                ensureNoOutParams(ms, boundSql);
                // 3. ä»äºŒçº§ç¼“å­˜è·å–
                @SuppressWarnings("unchecked")
                List<E> list = (List<E>) tcm.getObject(cache, key);
                if (list == null) {
                    // 4. äºŒçº§ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢ä¸€çº§ç¼“å­˜æˆ–æ•°æ®åº“
                    list = delegate.query(ms, parameterObject, rowBounds, 
                        resultHandler, key, boundSql);
                    // 5. æ”¾å…¥äºŒçº§ç¼“å­˜ï¼ˆæš‚å­˜åŒºï¼‰
                    tcm.putObject(cache, key, list);
                }
                return list;
            }
        }
        // æ²¡æœ‰é…ç½®ç¼“å­˜ï¼Œç›´æ¥æŸ¥è¯¢
        return delegate.query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);
    }
    
    /**
     * æ›´æ–°æ“ä½œ
     */
    @Override
    public int update(MappedStatement ms, Object parameterObject) throws SQLException {
        // åˆ·æ–°ç¼“å­˜
        flushCacheIfRequired(ms);
        return delegate.update(ms, parameterObject);
    }
    
    /**
     * æäº¤äº‹åŠ¡
     */
    @Override
    public void commit(boolean required) throws SQLException {
        delegate.commit(required);
        // æäº¤æ—¶å°†æš‚å­˜åŒºæ•°æ®å†™å…¥ç¼“å­˜
        tcm.commit();
    }
    
    /**
     * å›æ»šäº‹åŠ¡
     */
    @Override
    public void rollback(boolean required) throws SQLException {
        try {
            delegate.rollback(required);
        } finally {
            if (required) {
                // å›æ»šæ—¶æ¸…ç©ºæš‚å­˜åŒº
                tcm.rollback();
            }
        }
    }
    
    /**
     * åˆ·æ–°ç¼“å­˜
     */
    private void flushCacheIfRequired(MappedStatement ms) {
        Cache cache = ms.getCache();
        if (cache != null && ms.isFlushCacheRequired()) {
            tcm.clear(cache);
        }
    }
}
```

### 3.3 TransactionalCacheManageräº‹åŠ¡ç¼“å­˜ç®¡ç†å™¨

```java
/**
 * TransactionalCacheManagerï¼šäº‹åŠ¡ç¼“å­˜ç®¡ç†å™¨
 * ç®¡ç†å¤šä¸ªTransactionalCache
 */
public class TransactionalCacheManager {
    
    // Cache -> TransactionalCache
    private final Map<Cache, TransactionalCache> transactionalCaches = new HashMap<>();
    
    /**
     * æ¸…ç©ºç¼“å­˜
     */
    public void clear(Cache cache) {
        getTransactionalCache(cache).clear();
    }
    
    /**
     * è·å–ç¼“å­˜
     */
    public Object getObject(Cache cache, CacheKey key) {
        return getTransactionalCache(cache).getObject(key);
    }
    
    /**
     * æ”¾å…¥ç¼“å­˜ï¼ˆæš‚å­˜åŒºï¼‰
     */
    public void putObject(Cache cache, CacheKey key, Object value) {
        getTransactionalCache(cache).putObject(key, value);
    }
    
    /**
     * æäº¤æ‰€æœ‰ç¼“å­˜
     */
    public void commit() {
        for (TransactionalCache txCache : transactionalCaches.values()) {
            txCache.commit();
        }
    }
    
    /**
     * å›æ»šæ‰€æœ‰ç¼“å­˜
     */
    public void rollback() {
        for (TransactionalCache txCache : transactionalCaches.values()) {
            txCache.rollback();
        }
    }
    
    /**
     * è·å–äº‹åŠ¡ç¼“å­˜
     */
    private TransactionalCache getTransactionalCache(Cache cache) {
        return transactionalCaches.computeIfAbsent(cache, TransactionalCache::new);
    }
}
```

### 3.4 TransactionalCacheäº‹åŠ¡ç¼“å­˜

```java
/**
 * TransactionalCacheï¼šäº‹åŠ¡ç¼“å­˜
 * è£…é¥°å™¨ï¼Œä¸ºCacheæ·»åŠ äº‹åŠ¡æ”¯æŒ
 */
public class TransactionalCache implements Cache {
    
    // è¢«è£…é¥°çš„ç¼“å­˜
    private final Cache delegate;
    
    // æäº¤æ—¶æ˜¯å¦æ¸…ç©ºç¼“å­˜
    private boolean clearOnCommit;
    
    // æš‚å­˜åŒºï¼šå¾…æäº¤çš„æ•°æ®
    private final Map<Object, Object> entriesToAddOnCommit;
    
    // æœªå‘½ä¸­çš„keyé›†åˆ
    private final Set<Object> entriesMissedInCache;
    
    public TransactionalCache(Cache delegate) {
        this.delegate = delegate;
        this.clearOnCommit = false;
        this.entriesToAddOnCommit = new HashMap<>();
        this.entriesMissedInCache = new HashSet<>();
    }
    
    @Override
    public Object getObject(Object key) {
        // ä»çœŸæ­£çš„ç¼“å­˜è·å–
        Object object = delegate.getObject(key);
        if (object == null) {
            // è®°å½•æœªå‘½ä¸­
            entriesMissedInCache.add(key);
        }
        // å¦‚æœæ ‡è®°äº†æ¸…ç©ºï¼Œè¿”å›null
        if (clearOnCommit) {
            return null;
        } else {
            return object;
        }
    }
    
    @Override
    public void putObject(Object key, Object object) {
        // æ”¾å…¥æš‚å­˜åŒºï¼Œä¸ç›´æ¥æ”¾å…¥ç¼“å­˜
        entriesToAddOnCommit.put(key, object);
    }
    
    @Override
    public void clear() {
        // æ ‡è®°æäº¤æ—¶æ¸…ç©º
        clearOnCommit = true;
        // æ¸…ç©ºæš‚å­˜åŒº
        entriesToAddOnCommit.clear();
    }
    
    /**
     * æäº¤ï¼šå°†æš‚å­˜åŒºæ•°æ®å†™å…¥ç¼“å­˜
     */
    public void commit() {
        if (clearOnCommit) {
            delegate.clear();
        }
        flushPendingEntries();
        reset();
    }
    
    /**
     * å›æ»šï¼šæ¸…ç©ºæš‚å­˜åŒº
     */
    public void rollback() {
        unlockMissedEntries();
        reset();
    }
    
    /**
     * åˆ·æ–°æš‚å­˜åŒºåˆ°ç¼“å­˜
     */
    private void flushPendingEntries() {
        for (Map.Entry<Object, Object> entry : entriesToAddOnCommit.entrySet()) {
            delegate.putObject(entry.getKey(), entry.getValue());
        }
        for (Object entry : entriesMissedInCache) {
            if (!entriesToAddOnCommit.containsKey(entry)) {
                delegate.putObject(entry, null);
            }
        }
    }
    
    private void reset() {
        clearOnCommit = false;
        entriesToAddOnCommit.clear();
        entriesMissedInCache.clear();
    }
}
```


---

## 4. ç¼“å­˜è£…é¥°å™¨

### 4.1 è£…é¥°å™¨ä½“ç³»

```
Cacheè£…é¥°å™¨é“¾ï¼š

PerpetualCache (åŸºç¡€ç¼“å­˜)
    â”‚
    â–¼
LruCache (LRUæ·˜æ±°)
    â”‚
    â–¼
SerializedCache (åºåˆ—åŒ–)
    â”‚
    â–¼
LoggingCache (æ—¥å¿—)
    â”‚
    â–¼
SynchronizedCache (åŒæ­¥)
    â”‚
    â–¼
BlockingCache (é˜»å¡)
```

### 4.2 å¸¸ç”¨è£…é¥°å™¨å®ç°

```java
/**
 * LruCacheï¼šLRUæ·˜æ±°ç­–ç•¥
 */
public class LruCache implements Cache {
    
    private final Cache delegate;
    private Map<Object, Object> keyMap;
    private Object eldestKey;
    
    public LruCache(Cache delegate) {
        this.delegate = delegate;
        setSize(1024);
    }
    
    public void setSize(final int size) {
        // ä½¿ç”¨LinkedHashMapå®ç°LRU
        keyMap = new LinkedHashMap<Object, Object>(size, .75F, true) {
            @Override
            protected boolean removeEldestEntry(Map.Entry<Object, Object> eldest) {
                boolean tooBig = size() > size;
                if (tooBig) {
                    eldestKey = eldest.getKey();
                }
                return tooBig;
            }
        };
    }
    
    @Override
    public void putObject(Object key, Object value) {
        delegate.putObject(key, value);
        cycleKeyList(key);
    }
    
    @Override
    public Object getObject(Object key) {
        keyMap.get(key);  // æ›´æ–°è®¿é—®é¡ºåº
        return delegate.getObject(key);
    }
    
    private void cycleKeyList(Object key) {
        keyMap.put(key, key);
        if (eldestKey != null) {
            delegate.removeObject(eldestKey);
            eldestKey = null;
        }
    }
}

/**
 * FifoCacheï¼šFIFOæ·˜æ±°ç­–ç•¥
 */
public class FifoCache implements Cache {
    
    private final Cache delegate;
    private final Deque<Object> keyList;
    private int size;
    
    public FifoCache(Cache delegate) {
        this.delegate = delegate;
        this.keyList = new LinkedList<>();
        this.size = 1024;
    }
    
    @Override
    public void putObject(Object key, Object value) {
        cycleKeyList(key);
        delegate.putObject(key, value);
    }
    
    private void cycleKeyList(Object key) {
        keyList.addLast(key);
        if (keyList.size() > size) {
            Object oldestKey = keyList.removeFirst();
            delegate.removeObject(oldestKey);
        }
    }
}

/**
 * SoftCacheï¼šè½¯å¼•ç”¨ç¼“å­˜
 */
public class SoftCache implements Cache {
    
    private final Deque<Object> hardLinksToAvoidGarbageCollection;
    private final ReferenceQueue<Object> queueOfGarbageCollectedEntries;
    private final Cache delegate;
    private int numberOfHardLinks;
    
    public SoftCache(Cache delegate) {
        this.delegate = delegate;
        this.numberOfHardLinks = 256;
        this.hardLinksToAvoidGarbageCollection = new LinkedList<>();
        this.queueOfGarbageCollectedEntries = new ReferenceQueue<>();
    }
    
    @Override
    public void putObject(Object key, Object value) {
        removeGarbageCollectedItems();
        delegate.putObject(key, new SoftEntry(key, value, queueOfGarbageCollectedEntries));
    }
    
    @Override
    public Object getObject(Object key) {
        Object result = null;
        SoftReference<Object> softReference = (SoftReference<Object>) delegate.getObject(key);
        if (softReference != null) {
            result = softReference.get();
            if (result == null) {
                delegate.removeObject(key);
            } else {
                // ä¿æŒå¼ºå¼•ç”¨ï¼Œé¿å…è¢«GC
                synchronized (hardLinksToAvoidGarbageCollection) {
                    hardLinksToAvoidGarbageCollection.addFirst(result);
                    if (hardLinksToAvoidGarbageCollection.size() > numberOfHardLinks) {
                        hardLinksToAvoidGarbageCollection.removeLast();
                    }
                }
            }
        }
        return result;
    }
}

/**
 * BlockingCacheï¼šé˜»å¡ç¼“å­˜
 * é˜²æ­¢ç¼“å­˜å‡»ç©¿
 */
public class BlockingCache implements Cache {
    
    private long timeout;
    private final Cache delegate;
    private final ConcurrentHashMap<Object, ReentrantLock> locks;
    
    public BlockingCache(Cache delegate) {
        this.delegate = delegate;
        this.locks = new ConcurrentHashMap<>();
    }
    
    @Override
    public Object getObject(Object key) {
        acquireLock(key);  // è·å–é”
        Object value = delegate.getObject(key);
        if (value != null) {
            releaseLock(key);  // å‘½ä¸­åˆ™é‡Šæ”¾é”
        }
        return value;
    }
    
    @Override
    public void putObject(Object key, Object value) {
        try {
            delegate.putObject(key, value);
        } finally {
            releaseLock(key);  // æ”¾å…¥åé‡Šæ”¾é”
        }
    }
    
    private void acquireLock(Object key) {
        Lock lock = getLockForKey(key);
        if (timeout > 0) {
            try {
                boolean acquired = lock.tryLock(timeout, TimeUnit.MILLISECONDS);
                if (!acquired) {
                    throw new CacheException("Couldn't get a lock in " + timeout + " ms");
                }
            } catch (InterruptedException e) {
                throw new CacheException("Got interrupted while trying to acquire lock");
            }
        } else {
            lock.lock();
        }
    }
    
    private ReentrantLock getLockForKey(Object key) {
        return locks.computeIfAbsent(key, k -> new ReentrantLock());
    }
}
```

---

## 5. ç¼“å­˜å¤±æ•ˆåœºæ™¯

### 5.1 ä¸€çº§ç¼“å­˜å¤±æ•ˆ

```java
/**
 * ä¸€çº§ç¼“å­˜å¤±æ•ˆåœºæ™¯
 */
public class FirstLevelCacheInvalidation {
    
    // 1. æ‰§è¡Œupdate/insert/deleteæ“ä½œ
    public void updateInvalidation(SqlSession session) {
        User user1 = session.selectOne("selectById", 1);  // æŸ¥è¯¢ï¼Œæ”¾å…¥ç¼“å­˜
        session.update("updateUser", user);                // æ›´æ–°ï¼Œæ¸…ç©ºç¼“å­˜
        User user2 = session.selectOne("selectById", 1);  // é‡æ–°æŸ¥è¯¢æ•°æ®åº“
    }
    
    // 2. è°ƒç”¨clearCache()
    public void clearCacheInvalidation(SqlSession session) {
        User user1 = session.selectOne("selectById", 1);  // æŸ¥è¯¢ï¼Œæ”¾å…¥ç¼“å­˜
        session.clearCache();                              // æ¸…ç©ºç¼“å­˜
        User user2 = session.selectOne("selectById", 1);  // é‡æ–°æŸ¥è¯¢æ•°æ®åº“
    }
    
    // 3. SqlSessionå…³é—­
    public void sessionCloseInvalidation(SqlSessionFactory factory) {
        try (SqlSession session = factory.openSession()) {
            User user = session.selectOne("selectById", 1);
        }  // sessionå…³é—­ï¼Œç¼“å­˜å¤±æ•ˆ
    }
    
    // 4. ä¸åŒçš„SqlSession
    public void differentSessionInvalidation(SqlSessionFactory factory) {
        SqlSession session1 = factory.openSession();
        SqlSession session2 = factory.openSession();
        
        User user1 = session1.selectOne("selectById", 1);  // session1ç¼“å­˜
        User user2 = session2.selectOne("selectById", 1);  // session2é‡æ–°æŸ¥è¯¢
        // ä¸€çº§ç¼“å­˜ä¸å…±äº«
    }
    
    // 5. é…ç½®localCacheScope=STATEMENT
    // æ¯æ¬¡æŸ¥è¯¢åæ¸…ç©ºç¼“å­˜
}
```

### 5.2 äºŒçº§ç¼“å­˜å¤±æ•ˆ

```java
/**
 * äºŒçº§ç¼“å­˜å¤±æ•ˆåœºæ™¯
 */
public class SecondLevelCacheInvalidation {
    
    // 1. æ‰§è¡Œupdate/insert/deleteæ“ä½œ
    // åŒä¸€namespaceä¸‹çš„æ›´æ–°ä¼šæ¸…ç©ºè¯¥namespaceçš„äºŒçº§ç¼“å­˜
    
    // 2. æœªæäº¤äº‹åŠ¡
    public void uncommittedInvalidation(SqlSession session) {
        User user = session.selectOne("selectById", 1);
        // æœªcommitï¼Œæ•°æ®åœ¨æš‚å­˜åŒºï¼Œä¸ä¼šå†™å…¥äºŒçº§ç¼“å­˜
    }
    
    // 3. é…ç½®flushCache=true
    // <select id="selectById" flushCache="true">
    // æ¯æ¬¡æŸ¥è¯¢å‰æ¸…ç©ºç¼“å­˜
    
    // 4. è·¨namespaceæ›´æ–°
    // UserMapperæ›´æ–°ä¸ä¼šæ¸…ç©ºOrderMapperçš„ç¼“å­˜
    // å¯èƒ½å¯¼è‡´è„è¯»
}
```

---

## 6. åˆ†å¸ƒå¼ç¯å¢ƒé—®é¢˜

### 6.1 é—®é¢˜åˆ†æ

```
åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„ç¼“å­˜é—®é¢˜ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åˆ†å¸ƒå¼ç¯å¢ƒ                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   Server A                              Server B
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MyBatis     â”‚                    â”‚  MyBatis     â”‚
â”‚  äºŒçº§ç¼“å­˜    â”‚                    â”‚  äºŒçº§ç¼“å­˜    â”‚
â”‚  User: v1    â”‚                    â”‚  User: v1    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                   â”‚
       â”‚                                   â”‚
       â–¼                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ•°æ®åº“                                  â”‚
â”‚                    User: v2                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é—®é¢˜ï¼š
1. Server Aæ›´æ–°Userä¸ºv2
2. Server Açš„ç¼“å­˜è¢«æ¸…ç©º
3. Server Bçš„ç¼“å­˜ä»ç„¶æ˜¯v1
4. Server Bè¯»å–åˆ°è„æ•°æ®
```

### 6.2 è§£å†³æ–¹æ¡ˆ

```java
/**
 * åˆ†å¸ƒå¼ç¼“å­˜è§£å†³æ–¹æ¡ˆ
 */
public class DistributedCacheSolution {
    
    // æ–¹æ¡ˆ1ï¼šå…³é—­äºŒçº§ç¼“å­˜
    // mybatis-config.xml
    // <setting name="cacheEnabled" value="false"/>
    
    // æ–¹æ¡ˆ2ï¼šä½¿ç”¨åˆ†å¸ƒå¼ç¼“å­˜ï¼ˆå¦‚Redisï¼‰
    // è‡ªå®šä¹‰Cacheå®ç°
    public class RedisCache implements Cache {
        private final String id;
        private RedisTemplate<String, Object> redisTemplate;
        
        @Override
        public void putObject(Object key, Object value) {
            redisTemplate.opsForHash().put(id, key.toString(), value);
        }
        
        @Override
        public Object getObject(Object key) {
            return redisTemplate.opsForHash().get(id, key.toString());
        }
        
        @Override
        public void clear() {
            redisTemplate.delete(id);
        }
    }
    
    // æ–¹æ¡ˆ3ï¼šä½¿ç”¨mybatis-redis
    // <cache type="org.mybatis.caches.redis.RedisCache"/>
    
    // æ–¹æ¡ˆ4ï¼šä½¿ç”¨mybatis-ehcacheï¼ˆé›†ç¾¤æ¨¡å¼ï¼‰
    // <cache type="org.mybatis.caches.ehcache.EhcacheCache"/>
}
```

---

## 7. æµç¨‹å›¾è§£

### 7.1 ç¼“å­˜æŸ¥è¯¢æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  MyBatisç¼“å­˜æŸ¥è¯¢æµç¨‹                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æŸ¥è¯¢è¯·æ±‚
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CachingExecutor.query()                                  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ 1. æ£€æŸ¥æ˜¯å¦é…ç½®äºŒçº§ç¼“å­˜                              â”‚ â”‚
â”‚ â”‚ 2. ä»äºŒçº§ç¼“å­˜è·å–                                    â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”‚ äºŒçº§ç¼“å­˜æœªå‘½ä¸­
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BaseExecutor.query()                                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ 1. åˆ›å»ºCacheKey                                      â”‚ â”‚
â”‚ â”‚ 2. ä»ä¸€çº§ç¼“å­˜è·å–                                    â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”‚ ä¸€çº§ç¼“å­˜æœªå‘½ä¸­
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æŸ¥è¯¢æ•°æ®åº“                                               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ 1. æ‰§è¡ŒSQL                                           â”‚ â”‚
â”‚ â”‚ 2. ç»“æœæ”¾å…¥ä¸€çº§ç¼“å­˜                                  â”‚ â”‚
â”‚ â”‚ 3. ç»“æœæ”¾å…¥äºŒçº§ç¼“å­˜æš‚å­˜åŒº                            â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
è¿”å›ç»“æœ
```

### 7.2 äºŒçº§ç¼“å­˜äº‹åŠ¡æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                äºŒçº§ç¼“å­˜äº‹åŠ¡æµç¨‹                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æŸ¥è¯¢æ“ä½œ
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æŸ¥è¯¢æ•°æ®åº“                                            â”‚
â”‚ 2. ç»“æœæ”¾å…¥TransactionalCacheæš‚å­˜åŒº                      â”‚
â”‚    (entriesToAddOnCommit)                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”‚ äº‹åŠ¡æäº¤
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TransactionalCache.commit()                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ 1. flushPendingEntries()                             â”‚ â”‚
â”‚ â”‚ 2. æš‚å­˜åŒºæ•°æ®å†™å…¥çœŸæ­£çš„ç¼“å­˜                          â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”‚ äº‹åŠ¡å›æ»š
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TransactionalCache.rollback()                            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ 1. æ¸…ç©ºæš‚å­˜åŒº                                        â”‚ â”‚
â”‚ â”‚ 2. æ•°æ®ä¸ä¼šå†™å…¥ç¼“å­˜                                  â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 8. é¢è¯•è¦ç‚¹

### 8.1 é«˜é¢‘é¢è¯•é¢˜

```
Q1: MyBatisä¸€çº§ç¼“å­˜å’ŒäºŒçº§ç¼“å­˜çš„åŒºåˆ«ï¼Ÿ
A: - ä¸€çº§ç¼“å­˜ï¼šSqlSessionçº§åˆ«ï¼Œé»˜è®¤å¼€å¯ï¼Œä¸å¯å…³é—­
   - äºŒçº§ç¼“å­˜ï¼šMapperçº§åˆ«ï¼Œé»˜è®¤å…³é—­ï¼Œéœ€è¦é…ç½®å¼€å¯
   - ä¸€çº§ç¼“å­˜ä¸å…±äº«ï¼ŒäºŒçº§ç¼“å­˜å¤šSqlSessionå…±äº«
   - äºŒçº§ç¼“å­˜éœ€è¦äº‹åŠ¡æäº¤åæ‰ç”Ÿæ•ˆ

Q2: ä¸€çº§ç¼“å­˜ä»€ä¹ˆæ—¶å€™å¤±æ•ˆï¼Ÿ
A: 1. æ‰§è¡Œupdate/insert/deleteæ“ä½œ
   2. è°ƒç”¨clearCache()æ–¹æ³•
   3. SqlSessionå…³é—­
   4. ä¸åŒçš„SqlSession
   5. é…ç½®localCacheScope=STATEMENT

Q3: äºŒçº§ç¼“å­˜çš„å·¥ä½œåŸç†ï¼Ÿ
A: 1. CachingExecutorè£…é¥°BaseExecutor
   2. æŸ¥è¯¢æ—¶å…ˆæŸ¥äºŒçº§ç¼“å­˜ï¼Œå†æŸ¥ä¸€çº§ç¼“å­˜
   3. ä½¿ç”¨TransactionalCacheç®¡ç†äº‹åŠ¡
   4. æ•°æ®å…ˆæ”¾å…¥æš‚å­˜åŒºï¼Œæäº¤åå†™å…¥ç¼“å­˜
   5. å›æ»šæ—¶æ¸…ç©ºæš‚å­˜åŒº

Q4: ä¸ºä»€ä¹ˆäºŒçº§ç¼“å­˜éœ€è¦äº‹åŠ¡æäº¤åæ‰ç”Ÿæ•ˆï¼Ÿ
A: é˜²æ­¢è„è¯»ã€‚å¦‚æœäº‹åŠ¡å›æ»šï¼Œç¼“å­˜ä¸­çš„æ•°æ®å°±æ˜¯è„æ•°æ®ã€‚
   ä½¿ç”¨TransactionalCacheæš‚å­˜åŒºæœºåˆ¶ï¼Œåªæœ‰æäº¤åæ‰å†™å…¥ç¼“å­˜ã€‚

Q5: åˆ†å¸ƒå¼ç¯å¢ƒä¸‹å¦‚ä½•ä½¿ç”¨MyBatisç¼“å­˜ï¼Ÿ
A: 1. å…³é—­äºŒçº§ç¼“å­˜
   2. ä½¿ç”¨åˆ†å¸ƒå¼ç¼“å­˜ï¼ˆRedisã€Ehcacheé›†ç¾¤ï¼‰
   3. è‡ªå®šä¹‰Cacheå®ç°
   4. ä½¿ç”¨mybatis-redisç­‰ç¬¬ä¸‰æ–¹é›†æˆ
```

### 8.2 é…ç½®ç¤ºä¾‹

```xml
<!-- mybatis-config.xml -->
<settings>
    <!-- å…¨å±€å¼€å¯äºŒçº§ç¼“å­˜ -->
    <setting name="cacheEnabled" value="true"/>
    <!-- ä¸€çº§ç¼“å­˜ä½œç”¨åŸŸ -->
    <setting name="localCacheScope" value="SESSION"/>
</settings>

<!-- Mapper.xml -->
<mapper namespace="com.example.mapper.UserMapper">
    <!-- å¼€å¯äºŒçº§ç¼“å­˜ -->
    <cache
        eviction="LRU"
        flushInterval="60000"
        size="512"
        readOnly="false"
        blocking="true"/>
    
    <!-- æŸ¥è¯¢ä½¿ç”¨ç¼“å­˜ -->
    <select id="selectById" useCache="true" flushCache="false">
        SELECT * FROM user WHERE id = #{id}
    </select>
    
    <!-- æ›´æ–°åˆ·æ–°ç¼“å­˜ -->
    <update id="updateUser" flushCache="true">
        UPDATE user SET name = #{name} WHERE id = #{id}
    </update>
</mapper>
```

---

## ğŸ“š æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **ä¸€çº§ç¼“å­˜**ï¼šSqlSessionçº§åˆ«ï¼ŒPerpetualCacheå®ç°
2. **äºŒçº§ç¼“å­˜**ï¼šMapperçº§åˆ«ï¼ŒCachingExecutorè£…é¥°å™¨
3. **äº‹åŠ¡æ”¯æŒ**ï¼šTransactionalCacheæš‚å­˜åŒºæœºåˆ¶
4. **è£…é¥°å™¨æ¨¡å¼**ï¼šLRUã€FIFOã€Softã€Blockingç­‰
5. **åˆ†å¸ƒå¼é—®é¢˜**ï¼šéœ€è¦ä½¿ç”¨åˆ†å¸ƒå¼ç¼“å­˜è§£å†³

### ç¼“å­˜é€‰æ‹©å»ºè®®

| åœºæ™¯ | å»ºè®® |
|------|------|
| å•æœºåº”ç”¨ | å¯ä»¥ä½¿ç”¨äºŒçº§ç¼“å­˜ |
| åˆ†å¸ƒå¼åº”ç”¨ | å…³é—­äºŒçº§ç¼“å­˜æˆ–ä½¿ç”¨Redis |
| æ•°æ®å®æ—¶æ€§è¦æ±‚é«˜ | å…³é—­ç¼“å­˜ |
| è¯»å¤šå†™å°‘ | é€‚åˆä½¿ç”¨ç¼“å­˜ |

---

*æœ€åæ›´æ–°ï¼š2025-12-28*
