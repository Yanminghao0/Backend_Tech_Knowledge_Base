# MyBatisæ’ä»¶æœºåˆ¶æºç è§£æ

> ğŸ’¡ æ·±å…¥ç†è§£MyBatisæ’ä»¶ï¼ˆæ‹¦æˆªå™¨ï¼‰çš„å®ç°åŸç†ï¼ŒæŒæ¡è´£ä»»é“¾æ¨¡å¼åœ¨æ¡†æ¶ä¸­çš„åº”ç”¨

---

## ğŸ“š ç›®å½•

1. [æ’ä»¶æœºåˆ¶æ¦‚è¿°](#1-æ’ä»¶æœºåˆ¶æ¦‚è¿°)
2. [æ ¸å¿ƒæ¥å£è®¾è®¡](#2-æ ¸å¿ƒæ¥å£è®¾è®¡)
3. [æ’ä»¶åŠ è½½æµç¨‹](#3-æ’ä»¶åŠ è½½æµç¨‹)
4. [ä»£ç†ç”ŸæˆåŸç†](#4-ä»£ç†ç”ŸæˆåŸç†)
5. [æ‹¦æˆªå™¨é“¾æ‰§è¡Œ](#5-æ‹¦æˆªå™¨é“¾æ‰§è¡Œ)
6. [åˆ†é¡µæ’ä»¶åŸç†](#6-åˆ†é¡µæ’ä»¶åŸç†)
7. [è‡ªå®šä¹‰æ’ä»¶å¼€å‘](#7-è‡ªå®šä¹‰æ’ä»¶å¼€å‘)
8. [é¢è¯•è¦ç‚¹](#8-é¢è¯•è¦ç‚¹)

---

## 1. æ’ä»¶æœºåˆ¶æ¦‚è¿°

### 1.1 ä»€ä¹ˆæ˜¯MyBatisæ’ä»¶

MyBatisæ’ä»¶æ˜¯ä¸€ç§æ‹¦æˆªå™¨æœºåˆ¶ï¼Œå…è®¸åœ¨SQLæ‰§è¡Œçš„å…³é”®èŠ‚ç‚¹è¿›è¡Œæ‹¦æˆªå’Œå¢å¼ºã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  MyBatisæ’ä»¶ä½“ç³»                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚   Plugin1   â”‚â”€â”€â”€â–¶â”‚   Plugin2   â”‚â”€â”€â”€â–¶ ...       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚         â”‚                  â”‚                        â”‚
â”‚         â–¼                  â–¼                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚           Target Object                  â”‚       â”‚
â”‚  â”‚  (Executor/StatementHandler/...)        â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 å¯æ‹¦æˆªçš„å››å¤§å¯¹è±¡

```java
// 1. Executor - æ‰§è¡Œå™¨
//    æ‹¦æˆªç‚¹ï¼šupdate, query, flushStatements, commit, rollback, getTransaction, close, isClosed

// 2. StatementHandler - SQLè¯­å¥å¤„ç†å™¨
//    æ‹¦æˆªç‚¹ï¼šprepare, parameterize, batch, update, query

// 3. ParameterHandler - å‚æ•°å¤„ç†å™¨
//    æ‹¦æˆªç‚¹ï¼šgetParameterObject, setParameters

// 4. ResultSetHandler - ç»“æœé›†å¤„ç†å™¨
//    æ‹¦æˆªç‚¹ï¼šhandleResultSets, handleOutputParameters
```


### 1.3 æ’ä»¶åº”ç”¨åœºæ™¯

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      åº”ç”¨åœºæ™¯       â”‚           å®ç°æ–¹å¼              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ åˆ†é¡µæŸ¥è¯¢           â”‚ æ‹¦æˆªExecutor.query()           â”‚
â”‚ SQLæ€§èƒ½ç›‘æ§        â”‚ æ‹¦æˆªStatementHandler.prepare() â”‚
â”‚ SQLæ—¥å¿—æ‰“å°        â”‚ æ‹¦æˆªStatementHandler           â”‚
â”‚ æ•°æ®æƒé™æ§åˆ¶       â”‚ æ‹¦æˆªExecutor.query()           â”‚
â”‚ æ•°æ®åŠ è§£å¯†         â”‚ æ‹¦æˆªParameterHandler/ResultSet â”‚
â”‚ ä¹è§‚é”å®ç°         â”‚ æ‹¦æˆªExecutor.update()          â”‚
â”‚ å¤šç§Ÿæˆ·æ”¯æŒ         â”‚ æ‹¦æˆªStatementHandler           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. æ ¸å¿ƒæ¥å£è®¾è®¡

### 2.1 Interceptoræ¥å£

```java
/**
 * æ‹¦æˆªå™¨æ¥å£ - æ’ä»¶çš„æ ¸å¿ƒæ¥å£
 */
public interface Interceptor {
    
    /**
     * æ‹¦æˆªæ–¹æ³• - æ ¸å¿ƒé€»è¾‘
     * @param invocation è°ƒç”¨ä¿¡æ¯å°è£…
     * @return æ‰§è¡Œç»“æœ
     */
    Object intercept(Invocation invocation) throws Throwable;
    
    /**
     * ç”Ÿæˆä»£ç†å¯¹è±¡
     * @param target ç›®æ ‡å¯¹è±¡
     * @return ä»£ç†å¯¹è±¡æˆ–åŸå¯¹è±¡
     */
    default Object plugin(Object target) {
        return Plugin.wrap(target, this);
    }
    
    /**
     * è®¾ç½®å±æ€§
     * @param properties é…ç½®å±æ€§
     */
    default void setProperties(Properties properties) {
        // é»˜è®¤ç©ºå®ç°
    }
}
```

### 2.2 Invocationå°è£…ç±»

```java
/**
 * è°ƒç”¨ä¿¡æ¯å°è£…
 * åŒ…å«ç›®æ ‡å¯¹è±¡ã€æ–¹æ³•ã€å‚æ•°
 */
public class Invocation {
    
    private final Object target;      // ç›®æ ‡å¯¹è±¡
    private final Method method;      // è¢«æ‹¦æˆªçš„æ–¹æ³•
    private final Object[] args;      // æ–¹æ³•å‚æ•°
    
    public Invocation(Object target, Method method, Object[] args) {
        this.target = target;
        this.method = method;
        this.args = args;
    }
    
    public Object getTarget() {
        return target;
    }
    
    public Method getMethod() {
        return method;
    }
    
    public Object[] getArgs() {
        return args;
    }
    
    /**
     * æ‰§è¡ŒåŸæ–¹æ³•
     * åœ¨æ‹¦æˆªå™¨ä¸­è°ƒç”¨æ­¤æ–¹æ³•ç»§ç»­æ‰§è¡Œ
     */
    public Object proceed() throws InvocationTargetException, IllegalAccessException {
        return method.invoke(target, args);
    }
}
```

### 2.3 InterceptorChainæ‹¦æˆªå™¨é“¾

```java
/**
 * æ‹¦æˆªå™¨é“¾
 * ç®¡ç†æ‰€æœ‰æ³¨å†Œçš„æ‹¦æˆªå™¨
 */
public class InterceptorChain {
    
    // æ‹¦æˆªå™¨åˆ—è¡¨
    private final List<Interceptor> interceptors = new ArrayList<>();
    
    /**
     * å¯¹ç›®æ ‡å¯¹è±¡åº”ç”¨æ‰€æœ‰æ‹¦æˆªå™¨
     * å½¢æˆä»£ç†é“¾
     */
    public Object pluginAll(Object target) {
        for (Interceptor interceptor : interceptors) {
            // æ¯ä¸ªæ‹¦æˆªå™¨éƒ½å¯èƒ½è¿”å›ä»£ç†å¯¹è±¡
            // å½¢æˆä»£ç†çš„ä»£ç†...
            target = interceptor.plugin(target);
        }
        return target;
    }
    
    /**
     * æ·»åŠ æ‹¦æˆªå™¨
     */
    public void addInterceptor(Interceptor interceptor) {
        interceptors.add(interceptor);
    }
    
    public List<Interceptor> getInterceptors() {
        return Collections.unmodifiableList(interceptors);
    }
}
```

### 2.4 @Interceptså’Œ@Signatureæ³¨è§£

```java
/**
 * æ ‡è®°æ‹¦æˆªå™¨ç±»
 * æŒ‡å®šè¦æ‹¦æˆªçš„æ–¹æ³•ç­¾å
 */
@Documented
@Retention(RetentionPolicy.RUNTIME)
@Target(ElementType.TYPE)
public @interface Intercepts {
    /**
     * æ‹¦æˆªçš„æ–¹æ³•ç­¾åæ•°ç»„
     */
    Signature[] value();
}

/**
 * æ–¹æ³•ç­¾å
 * ç²¾ç¡®æŒ‡å®šè¦æ‹¦æˆªçš„ç±»ã€æ–¹æ³•ã€å‚æ•°ç±»å‹
 */
@Documented
@Retention(RetentionPolicy.RUNTIME)
@Target({})
public @interface Signature {
    /**
     * æ‹¦æˆªçš„ç±»ï¼ˆå››å¤§å¯¹è±¡ä¹‹ä¸€ï¼‰
     */
    Class<?> type();
    
    /**
     * æ‹¦æˆªçš„æ–¹æ³•å
     */
    String method();
    
    /**
     * æ–¹æ³•å‚æ•°ç±»å‹ï¼ˆç”¨äºæ–¹æ³•é‡è½½åŒºåˆ†ï¼‰
     */
    Class<?>[] args();
}
```

---

## 3. æ’ä»¶åŠ è½½æµç¨‹

### 3.1 é…ç½®æ–‡ä»¶è§£æ

```xml
<!-- mybatis-config.xml -->
<plugins>
    <plugin interceptor="com.example.MyPlugin">
        <property name="prop1" value="value1"/>
    </plugin>
</plugins>
```

### 3.2 XMLConfigBuilderè§£æ

```java
/**
 * è§£æpluginsèŠ‚ç‚¹
 */
private void pluginElement(XNode parent) throws Exception {
    if (parent != null) {
        for (XNode child : parent.getChildren()) {
            // è·å–æ‹¦æˆªå™¨ç±»å
            String interceptor = child.getStringAttribute("interceptor");
            
            // è·å–é…ç½®å±æ€§
            Properties properties = child.getChildrenAsProperties();
            
            // å®ä¾‹åŒ–æ‹¦æˆªå™¨
            Interceptor interceptorInstance = 
                (Interceptor) resolveClass(interceptor).getDeclaredConstructor().newInstance();
            
            // è®¾ç½®å±æ€§
            interceptorInstance.setProperties(properties);
            
            // æ·»åŠ åˆ°Configuration
            configuration.addInterceptor(interceptorInstance);
        }
    }
}
```

### 3.3 Configurationæ·»åŠ æ‹¦æˆªå™¨

```java
public class Configuration {
    
    protected final InterceptorChain interceptorChain = new InterceptorChain();
    
    public void addInterceptor(Interceptor interceptor) {
        interceptorChain.addInterceptor(interceptor);
    }
    
    /**
     * åˆ›å»ºExecutoræ—¶åº”ç”¨æ’ä»¶
     */
    public Executor newExecutor(Transaction transaction, ExecutorType executorType) {
        executorType = executorType == null ? defaultExecutorType : executorType;
        Executor executor;
        
        if (ExecutorType.BATCH == executorType) {
            executor = new BatchExecutor(this, transaction);
        } else if (ExecutorType.REUSE == executorType) {
            executor = new ReuseExecutor(this, transaction);
        } else {
            executor = new SimpleExecutor(this, transaction);
        }
        
        // å¦‚æœå¼€å¯äºŒçº§ç¼“å­˜ï¼ŒåŒ…è£…CachingExecutor
        if (cacheEnabled) {
            executor = new CachingExecutor(executor);
        }
        
        // ğŸ”¥ åº”ç”¨æ‰€æœ‰æ’ä»¶ï¼Œç”Ÿæˆä»£ç†é“¾
        executor = (Executor) interceptorChain.pluginAll(executor);
        return executor;
    }
    
    /**
     * åˆ›å»ºStatementHandleræ—¶åº”ç”¨æ’ä»¶
     */
    public StatementHandler newStatementHandler(Executor executor, MappedStatement ms, 
            Object parameter, RowBounds rowBounds, ResultHandler resultHandler, 
            BoundSql boundSql) {
        StatementHandler statementHandler = new RoutingStatementHandler(
            executor, ms, parameter, rowBounds, resultHandler, boundSql);
        
        // ğŸ”¥ åº”ç”¨æ‰€æœ‰æ’ä»¶
        statementHandler = (StatementHandler) interceptorChain.pluginAll(statementHandler);
        return statementHandler;
    }
    
    /**
     * åˆ›å»ºParameterHandleræ—¶åº”ç”¨æ’ä»¶
     */
    public ParameterHandler newParameterHandler(MappedStatement ms, Object parameter, 
            BoundSql boundSql) {
        ParameterHandler parameterHandler = ms.getLang()
            .createParameterHandler(ms, parameter, boundSql);
        
        // ğŸ”¥ åº”ç”¨æ‰€æœ‰æ’ä»¶
        parameterHandler = (ParameterHandler) interceptorChain.pluginAll(parameterHandler);
        return parameterHandler;
    }
    
    /**
     * åˆ›å»ºResultSetHandleræ—¶åº”ç”¨æ’ä»¶
     */
    public ResultSetHandler newResultSetHandler(Executor executor, MappedStatement ms,
            RowBounds rowBounds, ParameterHandler parameterHandler, 
            ResultHandler resultHandler, BoundSql boundSql) {
        ResultSetHandler resultSetHandler = new DefaultResultSetHandler(
            executor, ms, parameterHandler, resultHandler, boundSql, rowBounds);
        
        // ğŸ”¥ åº”ç”¨æ‰€æœ‰æ’ä»¶
        resultSetHandler = (ResultSetHandler) interceptorChain.pluginAll(resultSetHandler);
        return resultSetHandler;
    }
}
```


---

## 4. ä»£ç†ç”ŸæˆåŸç†

### 4.1 Pluginä»£ç†ç±»

```java
/**
 * æ’ä»¶ä»£ç†ç±»
 * ä½¿ç”¨JDKåŠ¨æ€ä»£ç†å®ç°
 */
public class Plugin implements InvocationHandler {
    
    private final Object target;                    // ç›®æ ‡å¯¹è±¡
    private final Interceptor interceptor;          // æ‹¦æˆªå™¨
    private final Map<Class<?>, Set<Method>> signatureMap;  // ç­¾åæ˜ å°„
    
    private Plugin(Object target, Interceptor interceptor, 
                   Map<Class<?>, Set<Method>> signatureMap) {
        this.target = target;
        this.interceptor = interceptor;
        this.signatureMap = signatureMap;
    }
    
    /**
     * ğŸ”¥ æ ¸å¿ƒæ–¹æ³•ï¼šåŒ…è£…ç›®æ ‡å¯¹è±¡
     * åˆ¤æ–­æ˜¯å¦éœ€è¦ä»£ç†ï¼Œéœ€è¦åˆ™åˆ›å»ºä»£ç†å¯¹è±¡
     */
    public static Object wrap(Object target, Interceptor interceptor) {
        // 1. è·å–æ‹¦æˆªå™¨çš„ç­¾åä¿¡æ¯
        Map<Class<?>, Set<Method>> signatureMap = getSignatureMap(interceptor);
        
        // 2. è·å–ç›®æ ‡å¯¹è±¡çš„ç±»å‹
        Class<?> type = target.getClass();
        
        // 3. è·å–ç›®æ ‡å¯¹è±¡å®ç°çš„æ¥å£ï¼ˆéœ€è¦è¢«æ‹¦æˆªçš„æ¥å£ï¼‰
        Class<?>[] interfaces = getAllInterfaces(type, signatureMap);
        
        // 4. å¦‚æœæœ‰éœ€è¦æ‹¦æˆªçš„æ¥å£ï¼Œåˆ›å»ºä»£ç†
        if (interfaces.length > 0) {
            return Proxy.newProxyInstance(
                type.getClassLoader(),
                interfaces,
                new Plugin(target, interceptor, signatureMap)
            );
        }
        
        // 5. ä¸éœ€è¦æ‹¦æˆªï¼Œè¿”å›åŸå¯¹è±¡
        return target;
    }
    
    /**
     * ä»£ç†æ–¹æ³•è°ƒç”¨
     */
    @Override
    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
        try {
            // 1. è·å–å½“å‰æ–¹æ³•æ‰€å±ç±»éœ€è¦æ‹¦æˆªçš„æ–¹æ³•é›†åˆ
            Set<Method> methods = signatureMap.get(method.getDeclaringClass());
            
            // 2. åˆ¤æ–­å½“å‰æ–¹æ³•æ˜¯å¦éœ€è¦æ‹¦æˆª
            if (methods != null && methods.contains(method)) {
                // ğŸ”¥ éœ€è¦æ‹¦æˆªï¼Œè°ƒç”¨æ‹¦æˆªå™¨çš„interceptæ–¹æ³•
                return interceptor.intercept(new Invocation(target, method, args));
            }
            
            // 3. ä¸éœ€è¦æ‹¦æˆªï¼Œç›´æ¥è°ƒç”¨åŸæ–¹æ³•
            return method.invoke(target, args);
        } catch (Exception e) {
            throw ExceptionUtil.unwrapThrowable(e);
        }
    }
    
    /**
     * è§£ææ‹¦æˆªå™¨çš„@Interceptsæ³¨è§£
     * è·å–ç­¾åæ˜ å°„
     */
    private static Map<Class<?>, Set<Method>> getSignatureMap(Interceptor interceptor) {
        // 1. è·å–@Interceptsæ³¨è§£
        Intercepts interceptsAnnotation = interceptor.getClass()
            .getAnnotation(Intercepts.class);
        
        if (interceptsAnnotation == null) {
            throw new PluginException("No @Intercepts annotation was found in interceptor " 
                + interceptor.getClass().getName());
        }
        
        // 2. è·å–æ‰€æœ‰@Signature
        Signature[] sigs = interceptsAnnotation.value();
        
        // 3. æ„å»ºç­¾åæ˜ å°„ï¼šClass -> Set<Method>
        Map<Class<?>, Set<Method>> signatureMap = new HashMap<>();
        
        for (Signature sig : sigs) {
            Set<Method> methods = signatureMap.computeIfAbsent(
                sig.type(), k -> new HashSet<>());
            
            try {
                // æ ¹æ®æ–¹æ³•åå’Œå‚æ•°ç±»å‹è·å–Methodå¯¹è±¡
                Method method = sig.type().getMethod(sig.method(), sig.args());
                methods.add(method);
            } catch (NoSuchMethodException e) {
                throw new PluginException("Could not find method on " + sig.type() 
                    + " named " + sig.method() + ". Cause: " + e, e);
            }
        }
        
        return signatureMap;
    }
    
    /**
     * è·å–ç›®æ ‡å¯¹è±¡å®ç°çš„ã€éœ€è¦è¢«æ‹¦æˆªçš„æ¥å£
     */
    private static Class<?>[] getAllInterfaces(Class<?> type, 
            Map<Class<?>, Set<Method>> signatureMap) {
        Set<Class<?>> interfaces = new HashSet<>();
        
        // éå†ç±»ç»§æ‰¿é“¾
        while (type != null) {
            for (Class<?> c : type.getInterfaces()) {
                // åªæ·»åŠ éœ€è¦æ‹¦æˆªçš„æ¥å£
                if (signatureMap.containsKey(c)) {
                    interfaces.add(c);
                }
            }
            type = type.getSuperclass();
        }
        
        return interfaces.toArray(new Class<?>[0]);
    }
}
```

### 4.2 ä»£ç†é“¾å½¢æˆè¿‡ç¨‹

```
å‡è®¾æœ‰3ä¸ªæ’ä»¶ï¼šPlugin1, Plugin2, Plugin3
ç›®æ ‡å¯¹è±¡ï¼šExecutor

pluginAllæ‰§è¡Œè¿‡ç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                     â”‚
â”‚  åŸå§‹Executor                                       â”‚
â”‚       â”‚                                             â”‚
â”‚       â–¼ Plugin1.plugin()                           â”‚
â”‚  Proxy1(Executor)                                  â”‚
â”‚       â”‚                                             â”‚
â”‚       â–¼ Plugin2.plugin()                           â”‚
â”‚  Proxy2(Proxy1)                                    â”‚
â”‚       â”‚                                             â”‚
â”‚       â–¼ Plugin3.plugin()                           â”‚
â”‚  Proxy3(Proxy2)  â† æœ€ç»ˆè¿”å›                        â”‚
â”‚                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è°ƒç”¨æ—¶çš„æ‰§è¡Œé¡ºåºï¼ˆæ´‹è‘±æ¨¡å‹ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                     â”‚
â”‚  è°ƒç”¨ â†’ Proxy3.invoke()                            â”‚
â”‚              â”‚                                      â”‚
â”‚              â–¼                                      â”‚
â”‚         Plugin3.intercept()                        â”‚
â”‚              â”‚                                      â”‚
â”‚              â–¼ invocation.proceed()                â”‚
â”‚         Proxy2.invoke()                            â”‚
â”‚              â”‚                                      â”‚
â”‚              â–¼                                      â”‚
â”‚         Plugin2.intercept()                        â”‚
â”‚              â”‚                                      â”‚
â”‚              â–¼ invocation.proceed()                â”‚
â”‚         Proxy1.invoke()                            â”‚
â”‚              â”‚                                      â”‚
â”‚              â–¼                                      â”‚
â”‚         Plugin1.intercept()                        â”‚
â”‚              â”‚                                      â”‚
â”‚              â–¼ invocation.proceed()                â”‚
â”‚         åŸå§‹Executor.method()                      â”‚
â”‚                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. æ‹¦æˆªå™¨é“¾æ‰§è¡Œ

### 5.1 æ‰§è¡Œæµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ’ä»¶æ‰§è¡Œæµç¨‹                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  SqlSession.selectList()                                   â”‚
â”‚         â”‚                                                   â”‚
â”‚         â–¼                                                   â”‚
â”‚  Executor(Proxy).query()                                   â”‚
â”‚         â”‚                                                   â”‚
â”‚         â–¼                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚     Plugin.invoke()                  â”‚                   â”‚
â”‚  â”‚         â”‚                            â”‚                   â”‚
â”‚  â”‚         â–¼                            â”‚                   â”‚
â”‚  â”‚  æ£€æŸ¥æ–¹æ³•æ˜¯å¦åœ¨signatureMapä¸­        â”‚                   â”‚
â”‚  â”‚         â”‚                            â”‚                   â”‚
â”‚  â”‚    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”                       â”‚                   â”‚
â”‚  â”‚    â”‚         â”‚                       â”‚                   â”‚
â”‚  â”‚   æ˜¯        å¦                       â”‚                   â”‚
â”‚  â”‚    â”‚         â”‚                       â”‚                   â”‚
â”‚  â”‚    â–¼         â–¼                       â”‚                   â”‚
â”‚  â”‚ intercept() method.invoke()         â”‚                   â”‚
â”‚  â”‚    â”‚                                 â”‚                   â”‚
â”‚  â”‚    â–¼                                 â”‚                   â”‚
â”‚  â”‚ æ‰§è¡Œæ‹¦æˆªé€»è¾‘                         â”‚                   â”‚
â”‚  â”‚    â”‚                                 â”‚                   â”‚
â”‚  â”‚    â–¼                                 â”‚                   â”‚
â”‚  â”‚ invocation.proceed()                â”‚                   â”‚
â”‚  â”‚    â”‚                                 â”‚                   â”‚
â”‚  â”‚    â–¼                                 â”‚                   â”‚
â”‚  â”‚ ä¸‹ä¸€å±‚ä»£ç†æˆ–åŸå§‹æ–¹æ³•                 â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 ç¤ºä¾‹ï¼šSQLæ‰§è¡Œç›‘æ§æ’ä»¶

```java
@Intercepts({
    @Signature(
        type = StatementHandler.class,
        method = "query",
        args = {Statement.class, ResultHandler.class}
    ),
    @Signature(
        type = StatementHandler.class,
        method = "update",
        args = {Statement.class}
    )
})
public class SqlExecutionTimePlugin implements Interceptor {
    
    private static final Logger logger = LoggerFactory.getLogger(SqlExecutionTimePlugin.class);
    
    // æ…¢SQLé˜ˆå€¼ï¼ˆæ¯«ç§’ï¼‰
    private long slowSqlThreshold = 1000;
    
    @Override
    public Object intercept(Invocation invocation) throws Throwable {
        // 1. è·å–StatementHandler
        StatementHandler statementHandler = (StatementHandler) invocation.getTarget();
        
        // 2. è·å–BoundSql
        BoundSql boundSql = statementHandler.getBoundSql();
        String sql = boundSql.getSql();
        
        // 3. è®°å½•å¼€å§‹æ—¶é—´
        long startTime = System.currentTimeMillis();
        
        try {
            // 4. æ‰§è¡ŒåŸæ–¹æ³•
            return invocation.proceed();
        } finally {
            // 5. è®¡ç®—æ‰§è¡Œæ—¶é—´
            long executionTime = System.currentTimeMillis() - startTime;
            
            // 6. è®°å½•æ—¥å¿—
            if (executionTime > slowSqlThreshold) {
                logger.warn("æ…¢SQLè­¦å‘Š! æ‰§è¡Œæ—¶é—´: {}ms, SQL: {}", executionTime, sql);
            } else {
                logger.debug("SQLæ‰§è¡Œæ—¶é—´: {}ms, SQL: {}", executionTime, sql);
            }
        }
    }
    
    @Override
    public void setProperties(Properties properties) {
        String threshold = properties.getProperty("slowSqlThreshold");
        if (threshold != null) {
            this.slowSqlThreshold = Long.parseLong(threshold);
        }
    }
}
```


---

## 6. åˆ†é¡µæ’ä»¶åŸç†

### 6.1 åˆ†é¡µæ’ä»¶æ ¸å¿ƒæ€è·¯

```
åˆ†é¡µæ’ä»¶å·¥ä½œåŸç†ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                             â”‚
â”‚  1. æ‹¦æˆªExecutor.query()æ–¹æ³•                               â”‚
â”‚                                                             â”‚
â”‚  2. è·å–åŸå§‹SQL                                            â”‚
â”‚                                                             â”‚
â”‚  3. ç”Ÿæˆcount SQLï¼ŒæŸ¥è¯¢æ€»æ•°                                â”‚
â”‚     SELECT COUNT(*) FROM (åŸå§‹SQL) tmp                     â”‚
â”‚                                                             â”‚
â”‚  4. ä¿®æ”¹åŸå§‹SQLï¼Œæ·»åŠ åˆ†é¡µè¯­å¥                              â”‚
â”‚     MySQL: SELECT ... LIMIT offset, pageSize               â”‚
â”‚     Oracle: SELECT ... WHERE ROWNUM <= ...                 â”‚
â”‚                                                             â”‚
â”‚  5. æ‰§è¡Œåˆ†é¡µSQL                                            â”‚
â”‚                                                             â”‚
â”‚  6. å°è£…åˆ†é¡µç»“æœ                                           â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 ç®€åŒ–ç‰ˆåˆ†é¡µæ’ä»¶å®ç°

```java
@Intercepts({
    @Signature(
        type = Executor.class,
        method = "query",
        args = {MappedStatement.class, Object.class, RowBounds.class, ResultHandler.class}
    )
})
public class SimplePagePlugin implements Interceptor {
    
    @Override
    public Object intercept(Invocation invocation) throws Throwable {
        Object[] args = invocation.getArgs();
        MappedStatement ms = (MappedStatement) args[0];
        Object parameter = args[1];
        RowBounds rowBounds = (RowBounds) args[2];
        
        // 1. åˆ¤æ–­æ˜¯å¦éœ€è¦åˆ†é¡µ
        if (rowBounds == null || rowBounds == RowBounds.DEFAULT) {
            return invocation.proceed();
        }
        
        // 2. è·å–BoundSql
        BoundSql boundSql = ms.getBoundSql(parameter);
        String originalSql = boundSql.getSql();
        
        // 3. æ„å»ºåˆ†é¡µSQL
        String pageSql = buildPageSql(originalSql, rowBounds);
        
        // 4. åˆ›å»ºæ–°çš„BoundSql
        BoundSql newBoundSql = new BoundSql(
            ms.getConfiguration(), 
            pageSql,
            boundSql.getParameterMappings(), 
            parameter
        );
        
        // 5. å¤åˆ¶é™„åŠ å‚æ•°
        for (String key : boundSql.getAdditionalParameters().keySet()) {
            newBoundSql.setAdditionalParameter(key, 
                boundSql.getAdditionalParameter(key));
        }
        
        // 6. åˆ›å»ºæ–°çš„MappedStatement
        MappedStatement newMs = copyMappedStatement(ms, new BoundSqlSqlSource(newBoundSql));
        
        // 7. æ›¿æ¢å‚æ•°
        args[0] = newMs;
        args[2] = RowBounds.DEFAULT;  // æ¸…é™¤RowBoundsï¼Œé¿å…å†…å­˜åˆ†é¡µ
        
        return invocation.proceed();
    }
    
    /**
     * æ„å»ºåˆ†é¡µSQLï¼ˆMySQLç‰ˆæœ¬ï¼‰
     */
    private String buildPageSql(String sql, RowBounds rowBounds) {
        StringBuilder pageSql = new StringBuilder(sql.length() + 20);
        pageSql.append(sql);
        pageSql.append(" LIMIT ");
        pageSql.append(rowBounds.getOffset());
        pageSql.append(", ");
        pageSql.append(rowBounds.getLimit());
        return pageSql.toString();
    }
    
    /**
     * å¤åˆ¶MappedStatement
     */
    private MappedStatement copyMappedStatement(MappedStatement ms, SqlSource newSqlSource) {
        MappedStatement.Builder builder = new MappedStatement.Builder(
            ms.getConfiguration(), 
            ms.getId(), 
            newSqlSource, 
            ms.getSqlCommandType()
        );
        
        builder.resource(ms.getResource());
        builder.fetchSize(ms.getFetchSize());
        builder.statementType(ms.getStatementType());
        builder.keyGenerator(ms.getKeyGenerator());
        builder.timeout(ms.getTimeout());
        builder.parameterMap(ms.getParameterMap());
        builder.resultMaps(ms.getResultMaps());
        builder.resultSetType(ms.getResultSetType());
        builder.cache(ms.getCache());
        builder.flushCacheRequired(ms.isFlushCacheRequired());
        builder.useCache(ms.isUseCache());
        
        return builder.build();
    }
    
    /**
     * BoundSqlåŒ…è£…çš„SqlSource
     */
    private static class BoundSqlSqlSource implements SqlSource {
        private final BoundSql boundSql;
        
        public BoundSqlSqlSource(BoundSql boundSql) {
            this.boundSql = boundSql;
        }
        
        @Override
        public BoundSql getBoundSql(Object parameterObject) {
            return boundSql;
        }
    }
}
```

### 6.3 PageHelperåˆ†é¡µæ’ä»¶åŸç†

```java
/**
 * PageHelperæ ¸å¿ƒåŸç†ï¼ˆç®€åŒ–ç‰ˆï¼‰
 */
public class PageHelper {
    
    // ThreadLocalå­˜å‚¨åˆ†é¡µå‚æ•°
    private static final ThreadLocal<Page<?>> LOCAL_PAGE = new ThreadLocal<>();
    
    /**
     * å¼€å§‹åˆ†é¡µ
     */
    public static <E> Page<E> startPage(int pageNum, int pageSize) {
        Page<E> page = new Page<>(pageNum, pageSize);
        LOCAL_PAGE.set(page);
        return page;
    }
    
    /**
     * è·å–åˆ†é¡µå‚æ•°
     */
    public static <E> Page<E> getLocalPage() {
        return (Page<E>) LOCAL_PAGE.get();
    }
    
    /**
     * æ¸…é™¤åˆ†é¡µå‚æ•°
     */
    public static void clearPage() {
        LOCAL_PAGE.remove();
    }
}

/**
 * PageHelperæ‹¦æˆªå™¨
 */
@Intercepts({
    @Signature(type = Executor.class, method = "query",
        args = {MappedStatement.class, Object.class, RowBounds.class, ResultHandler.class})
})
public class PageInterceptor implements Interceptor {
    
    @Override
    public Object intercept(Invocation invocation) throws Throwable {
        try {
            // 1. è·å–åˆ†é¡µå‚æ•°
            Page<?> page = PageHelper.getLocalPage();
            if (page == null) {
                return invocation.proceed();
            }
            
            Object[] args = invocation.getArgs();
            MappedStatement ms = (MappedStatement) args[0];
            Object parameter = args[1];
            
            // 2. æŸ¥è¯¢æ€»æ•°
            Long total = executeCount(ms, parameter);
            page.setTotal(total);
            
            // 3. å¦‚æœæ€»æ•°ä¸º0ï¼Œç›´æ¥è¿”å›ç©ºç»“æœ
            if (total == 0) {
                return new ArrayList<>();
            }
            
            // 4. æ‰§è¡Œåˆ†é¡µæŸ¥è¯¢
            List<?> result = executePageQuery(invocation, page);
            
            // 5. å°è£…åˆ†é¡µç»“æœ
            page.addAll(result);
            return page;
            
        } finally {
            // 6. æ¸…é™¤ThreadLocal
            PageHelper.clearPage();
        }
    }
    
    private Long executeCount(MappedStatement ms, Object parameter) {
        // ç”Ÿæˆcount SQLå¹¶æ‰§è¡Œ
        // SELECT COUNT(*) FROM (åŸå§‹SQL) tmp_count
        // ...
        return 0L;
    }
    
    private List<?> executePageQuery(Invocation invocation, Page<?> page) throws Throwable {
        // ä¿®æ”¹SQLæ·»åŠ LIMITå¹¶æ‰§è¡Œ
        // ...
        return (List<?>) invocation.proceed();
    }
}
```

---

## 7. è‡ªå®šä¹‰æ’ä»¶å¼€å‘

### 7.1 æ•°æ®æƒé™æ’ä»¶

```java
/**
 * æ•°æ®æƒé™æ’ä»¶
 * è‡ªåŠ¨æ·»åŠ æ•°æ®æƒé™è¿‡æ»¤æ¡ä»¶
 */
@Intercepts({
    @Signature(
        type = StatementHandler.class,
        method = "prepare",
        args = {Connection.class, Integer.class}
    )
})
public class DataPermissionPlugin implements Interceptor {
    
    @Override
    public Object intercept(Invocation invocation) throws Throwable {
        StatementHandler statementHandler = (StatementHandler) invocation.getTarget();
        
        // 1. è·å–MetaObjectï¼Œç”¨äºåå°„æ“ä½œ
        MetaObject metaObject = MetaObject.forObject(
            statementHandler,
            SystemMetaObject.DEFAULT_OBJECT_FACTORY,
            SystemMetaObject.DEFAULT_OBJECT_WRAPPER_FACTORY,
            new DefaultReflectorFactory()
        );
        
        // 2. è·å–MappedStatement
        MappedStatement ms = (MappedStatement) metaObject.getValue("delegate.mappedStatement");
        
        // 3. åªå¤„ç†SELECTè¯­å¥
        if (ms.getSqlCommandType() != SqlCommandType.SELECT) {
            return invocation.proceed();
        }
        
        // 4. è·å–åŸå§‹SQL
        BoundSql boundSql = statementHandler.getBoundSql();
        String originalSql = boundSql.getSql();
        
        // 5. è·å–å½“å‰ç”¨æˆ·çš„æ•°æ®æƒé™
        DataPermission permission = getCurrentUserPermission();
        if (permission == null) {
            return invocation.proceed();
        }
        
        // 6. æ·»åŠ æ•°æ®æƒé™æ¡ä»¶
        String newSql = addPermissionCondition(originalSql, permission);
        
        // 7. æ›¿æ¢SQL
        metaObject.setValue("delegate.boundSql.sql", newSql);
        
        return invocation.proceed();
    }
    
    private DataPermission getCurrentUserPermission() {
        // ä»SecurityContextè·å–å½“å‰ç”¨æˆ·æƒé™
        // ...
        return null;
    }
    
    private String addPermissionCondition(String sql, DataPermission permission) {
        // è§£æSQLï¼Œæ·»åŠ WHEREæ¡ä»¶
        // ä¾‹å¦‚ï¼šæ·»åŠ  AND dept_id IN (1,2,3)
        // ...
        return sql;
    }
}
```

### 7.2 æ•°æ®åŠ è§£å¯†æ’ä»¶

```java
/**
 * æ•æ„Ÿæ•°æ®åŠ è§£å¯†æ’ä»¶
 */
@Intercepts({
    // æ‹¦æˆªå‚æ•°è®¾ç½®ï¼ˆåŠ å¯†ï¼‰
    @Signature(
        type = ParameterHandler.class,
        method = "setParameters",
        args = {PreparedStatement.class}
    ),
    // æ‹¦æˆªç»“æœå¤„ç†ï¼ˆè§£å¯†ï¼‰
    @Signature(
        type = ResultSetHandler.class,
        method = "handleResultSets",
        args = {Statement.class}
    )
})
public class EncryptPlugin implements Interceptor {
    
    private final EncryptService encryptService;
    
    public EncryptPlugin(EncryptService encryptService) {
        this.encryptService = encryptService;
    }
    
    @Override
    public Object intercept(Invocation invocation) throws Throwable {
        Object target = invocation.getTarget();
        
        if (target instanceof ParameterHandler) {
            // å‚æ•°åŠ å¯†
            return handleParameterEncrypt(invocation);
        } else if (target instanceof ResultSetHandler) {
            // ç»“æœè§£å¯†
            return handleResultDecrypt(invocation);
        }
        
        return invocation.proceed();
    }
    
    /**
     * å‚æ•°åŠ å¯†å¤„ç†
     */
    private Object handleParameterEncrypt(Invocation invocation) throws Throwable {
        ParameterHandler parameterHandler = (ParameterHandler) invocation.getTarget();
        Object parameterObject = parameterHandler.getParameterObject();
        
        if (parameterObject != null) {
            // éå†å‚æ•°å¯¹è±¡çš„å­—æ®µ
            encryptFields(parameterObject);
        }
        
        return invocation.proceed();
    }
    
    /**
     * ç»“æœè§£å¯†å¤„ç†
     */
    private Object handleResultDecrypt(Invocation invocation) throws Throwable {
        Object result = invocation.proceed();
        
        if (result instanceof List) {
            for (Object obj : (List<?>) result) {
                decryptFields(obj);
            }
        }
        
        return result;
    }
    
    /**
     * åŠ å¯†æ ‡æ³¨äº†@Encryptæ³¨è§£çš„å­—æ®µ
     */
    private void encryptFields(Object obj) {
        Class<?> clazz = obj.getClass();
        for (Field field : clazz.getDeclaredFields()) {
            if (field.isAnnotationPresent(Encrypt.class)) {
                field.setAccessible(true);
                try {
                    Object value = field.get(obj);
                    if (value instanceof String) {
                        String encrypted = encryptService.encrypt((String) value);
                        field.set(obj, encrypted);
                    }
                } catch (IllegalAccessException e) {
                    throw new RuntimeException(e);
                }
            }
        }
    }
    
    /**
     * è§£å¯†æ ‡æ³¨äº†@Encryptæ³¨è§£çš„å­—æ®µ
     */
    private void decryptFields(Object obj) {
        Class<?> clazz = obj.getClass();
        for (Field field : clazz.getDeclaredFields()) {
            if (field.isAnnotationPresent(Encrypt.class)) {
                field.setAccessible(true);
                try {
                    Object value = field.get(obj);
                    if (value instanceof String) {
                        String decrypted = encryptService.decrypt((String) value);
                        field.set(obj, decrypted);
                    }
                } catch (IllegalAccessException e) {
                    throw new RuntimeException(e);
                }
            }
        }
    }
}

/**
 * åŠ å¯†æ³¨è§£
 */
@Target(ElementType.FIELD)
@Retention(RetentionPolicy.RUNTIME)
public @interface Encrypt {
}
```

### 7.3 ä¹è§‚é”æ’ä»¶

```java
/**
 * ä¹è§‚é”æ’ä»¶
 * è‡ªåŠ¨å¤„ç†versionå­—æ®µ
 */
@Intercepts({
    @Signature(
        type = Executor.class,
        method = "update",
        args = {MappedStatement.class, Object.class}
    )
})
public class OptimisticLockPlugin implements Interceptor {
    
    @Override
    public Object intercept(Invocation invocation) throws Throwable {
        Object[] args = invocation.getArgs();
        MappedStatement ms = (MappedStatement) args[0];
        Object parameter = args[1];
        
        // åªå¤„ç†UPDATEè¯­å¥
        if (ms.getSqlCommandType() != SqlCommandType.UPDATE) {
            return invocation.proceed();
        }
        
        // æ£€æŸ¥å‚æ•°å¯¹è±¡æ˜¯å¦æœ‰@Versionå­—æ®µ
        Field versionField = findVersionField(parameter.getClass());
        if (versionField == null) {
            return invocation.proceed();
        }
        
        // è·å–å½“å‰ç‰ˆæœ¬å·
        versionField.setAccessible(true);
        Object currentVersion = versionField.get(parameter);
        
        // æ‰§è¡Œæ›´æ–°
        int rows = (int) invocation.proceed();
        
        // æ£€æŸ¥æ›´æ–°ç»“æœ
        if (rows == 0) {
            throw new OptimisticLockException("ä¹è§‚é”å†²çªï¼Œæ•°æ®å·²è¢«å…¶ä»–äº‹åŠ¡ä¿®æ”¹");
        }
        
        // æ›´æ–°ç‰ˆæœ¬å·
        if (currentVersion instanceof Integer) {
            versionField.set(parameter, (Integer) currentVersion + 1);
        } else if (currentVersion instanceof Long) {
            versionField.set(parameter, (Long) currentVersion + 1);
        }
        
        return rows;
    }
    
    private Field findVersionField(Class<?> clazz) {
        for (Field field : clazz.getDeclaredFields()) {
            if (field.isAnnotationPresent(Version.class)) {
                return field;
            }
        }
        return null;
    }
}

/**
 * ç‰ˆæœ¬å·æ³¨è§£
 */
@Target(ElementType.FIELD)
@Retention(RetentionPolicy.RUNTIME)
public @interface Version {
}
```


---

## 8. é¢è¯•è¦ç‚¹

### 8.1 é«˜é¢‘é¢è¯•é¢˜

#### Q1: MyBatisæ’ä»¶çš„å®ç°åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ

```
ç­”æ¡ˆè¦ç‚¹ï¼š
1. åŸºäºJDKåŠ¨æ€ä»£ç†å®ç°
2. é€šè¿‡@Interceptså’Œ@Signatureæ³¨è§£æŒ‡å®šæ‹¦æˆªç‚¹
3. å¯æ‹¦æˆªå››å¤§å¯¹è±¡ï¼šExecutorã€StatementHandlerã€ParameterHandlerã€ResultSetHandler
4. å¤šä¸ªæ’ä»¶å½¢æˆä»£ç†é“¾ï¼ŒæŒ‰ç…§é…ç½®é¡ºåºåŒ…è£…
5. æ‰§è¡Œæ—¶æŒ‰ç…§æ´‹è‘±æ¨¡å‹ï¼Œå…ˆè¿›åå‡º

æ ¸å¿ƒæµç¨‹ï¼š
- é…ç½®è§£ææ—¶ï¼Œå°†æ’ä»¶æ·»åŠ åˆ°InterceptorChain
- åˆ›å»ºå››å¤§å¯¹è±¡æ—¶ï¼Œè°ƒç”¨pluginAll()åº”ç”¨æ‰€æœ‰æ’ä»¶
- Plugin.wrap()åˆ¤æ–­æ˜¯å¦éœ€è¦ä»£ç†ï¼Œéœ€è¦åˆ™åˆ›å»ºJDKåŠ¨æ€ä»£ç†
- è°ƒç”¨æ—¶ï¼ŒPlugin.invoke()åˆ¤æ–­æ–¹æ³•æ˜¯å¦éœ€è¦æ‹¦æˆª
- éœ€è¦æ‹¦æˆªåˆ™è°ƒç”¨interceptor.intercept()ï¼Œå¦åˆ™ç›´æ¥è°ƒç”¨åŸæ–¹æ³•
```

#### Q2: åˆ†é¡µæ’ä»¶çš„å®ç°åŸç†ï¼Ÿ

```
ç­”æ¡ˆè¦ç‚¹ï¼š
1. æ‹¦æˆªExecutor.query()æ–¹æ³•
2. ä»ThreadLocalè·å–åˆ†é¡µå‚æ•°
3. å…ˆæ‰§è¡ŒcountæŸ¥è¯¢è·å–æ€»æ•°
4. ä¿®æ”¹åŸSQLæ·»åŠ LIMITè¯­å¥
5. æ‰§è¡Œåˆ†é¡µæŸ¥è¯¢
6. å°è£…åˆ†é¡µç»“æœè¿”å›

å…³é”®æŠ€æœ¯ï¼š
- SQLè§£æå’Œæ”¹å†™
- ThreadLocalä¼ é€’åˆ†é¡µå‚æ•°
- ä¸åŒæ•°æ®åº“çš„åˆ†é¡µè¯­æ³•é€‚é…
```

#### Q3: å¦‚ä½•è‡ªå®šä¹‰MyBatisæ’ä»¶ï¼Ÿ

```java
// 1. å®ç°Interceptoræ¥å£
// 2. ä½¿ç”¨@InterceptsæŒ‡å®šæ‹¦æˆªç‚¹
// 3. åœ¨interceptæ–¹æ³•ä¸­å®ç°æ‹¦æˆªé€»è¾‘
// 4. è°ƒç”¨invocation.proceed()ç»§ç»­æ‰§è¡Œ

@Intercepts({
    @Signature(
        type = Executor.class,
        method = "query",
        args = {MappedStatement.class, Object.class, RowBounds.class, ResultHandler.class}
    )
})
public class MyPlugin implements Interceptor {
    @Override
    public Object intercept(Invocation invocation) throws Throwable {
        // å‰ç½®å¤„ç†
        System.out.println("Before query");
        
        // æ‰§è¡ŒåŸæ–¹æ³•
        Object result = invocation.proceed();
        
        // åç½®å¤„ç†
        System.out.println("After query");
        
        return result;
    }
}
```

#### Q4: å¤šä¸ªæ’ä»¶çš„æ‰§è¡Œé¡ºåºæ˜¯æ€æ ·çš„ï¼Ÿ

```
é…ç½®é¡ºåºï¼šPlugin1 â†’ Plugin2 â†’ Plugin3

åŒ…è£…é¡ºåºï¼ˆpluginAllï¼‰ï¼š
åŸå§‹å¯¹è±¡ â†’ Proxy1 â†’ Proxy2 â†’ Proxy3

æ‰§è¡Œé¡ºåºï¼ˆæ´‹è‘±æ¨¡å‹ï¼‰ï¼š
è¯·æ±‚ â†’ Plugin3.intercept() 
     â†’ Plugin2.intercept() 
     â†’ Plugin1.intercept() 
     â†’ åŸå§‹æ–¹æ³•
     â†’ Plugin1è¿”å›
     â†’ Plugin2è¿”å›
     â†’ Plugin3è¿”å› â†’ å“åº”

ç»“è®ºï¼š
- é…ç½®åœ¨å‰çš„æ’ä»¶ï¼ŒåŒ…è£…åœ¨å†…å±‚
- æ‰§è¡Œæ—¶ï¼Œé…ç½®åœ¨åçš„æ’ä»¶å…ˆæ‰§è¡Œ
- ç±»ä¼¼äºFilteré“¾çš„æ‰§è¡Œé¡ºåº
```

#### Q5: æ’ä»¶èƒ½æ‹¦æˆªå“ªäº›æ–¹æ³•ï¼Ÿ

```java
// Executorï¼ˆæ‰§è¡Œå™¨ï¼‰
update(MappedStatement ms, Object parameter)
query(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler)
query(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, CacheKey cacheKey, BoundSql boundSql)
flushStatements()
commit(boolean required)
rollback(boolean required)
getTransaction()
close(boolean forceRollback)
isClosed()

// StatementHandlerï¼ˆè¯­å¥å¤„ç†å™¨ï¼‰
prepare(Connection connection, Integer transactionTimeout)
parameterize(Statement statement)
batch(Statement statement)
update(Statement statement)
query(Statement statement, ResultHandler resultHandler)

// ParameterHandlerï¼ˆå‚æ•°å¤„ç†å™¨ï¼‰
getParameterObject()
setParameters(PreparedStatement ps)

// ResultSetHandlerï¼ˆç»“æœé›†å¤„ç†å™¨ï¼‰
handleResultSets(Statement stmt)
handleOutputParameters(CallableStatement cs)
```

### 8.2 çŸ¥è¯†ç‚¹æ€»ç»“

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  MyBatisæ’ä»¶æœºåˆ¶æ€»ç»“                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  æ ¸å¿ƒç»„ä»¶ï¼š                                                  â”‚
â”‚  â”œâ”€â”€ Interceptor: æ‹¦æˆªå™¨æ¥å£                                â”‚
â”‚  â”œâ”€â”€ InterceptorChain: æ‹¦æˆªå™¨é“¾                             â”‚
â”‚  â”œâ”€â”€ Plugin: JDKåŠ¨æ€ä»£ç†å®ç°                                â”‚
â”‚  â”œâ”€â”€ Invocation: è°ƒç”¨ä¿¡æ¯å°è£…                               â”‚
â”‚  â””â”€â”€ @Intercepts/@Signature: æ‹¦æˆªç‚¹æ³¨è§£                     â”‚
â”‚                                                             â”‚
â”‚  è®¾è®¡æ¨¡å¼ï¼š                                                  â”‚
â”‚  â”œâ”€â”€ è´£ä»»é“¾æ¨¡å¼: å¤šä¸ªæ’ä»¶å½¢æˆå¤„ç†é“¾                          â”‚
â”‚  â”œâ”€â”€ ä»£ç†æ¨¡å¼: JDKåŠ¨æ€ä»£ç†åŒ…è£…ç›®æ ‡å¯¹è±¡                       â”‚
â”‚  â””â”€â”€ è£…é¥°å™¨æ¨¡å¼: å±‚å±‚åŒ…è£…å¢å¼ºåŠŸèƒ½                            â”‚
â”‚                                                             â”‚
â”‚  åº”ç”¨åœºæ™¯ï¼š                                                  â”‚
â”‚  â”œâ”€â”€ åˆ†é¡µæŸ¥è¯¢                                               â”‚
â”‚  â”œâ”€â”€ SQLç›‘æ§                                                â”‚
â”‚  â”œâ”€â”€ æ•°æ®æƒé™                                               â”‚
â”‚  â”œâ”€â”€ æ•°æ®åŠ è§£å¯†                                             â”‚
â”‚  â”œâ”€â”€ ä¹è§‚é”                                                 â”‚
â”‚  â””â”€â”€ å¤šç§Ÿæˆ·                                                 â”‚
â”‚                                                             â”‚
â”‚  æ³¨æ„äº‹é¡¹ï¼š                                                  â”‚
â”‚  â”œâ”€â”€ æ’ä»¶ä¼šå½±å“æ€§èƒ½ï¼Œè°¨æ…ä½¿ç”¨                                â”‚
â”‚  â”œâ”€â”€ æ³¨æ„æ’ä»¶æ‰§è¡Œé¡ºåº                                       â”‚
â”‚  â”œâ”€â”€ é¿å…ä¿®æ”¹æ ¸å¿ƒé€»è¾‘                                       â”‚
â”‚  â””â”€â”€ åšå¥½å¼‚å¸¸å¤„ç†                                           â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.3 æºç é˜…è¯»å»ºè®®

```
é˜…è¯»é¡ºåºï¼š
1. Interceptoræ¥å£ - ç†è§£æ‹¦æˆªå™¨å¥‘çº¦
2. InterceptorChain - ç†è§£æ‹¦æˆªå™¨ç®¡ç†
3. Pluginç±» - ç†è§£ä»£ç†ç”ŸæˆåŸç†
4. Configuration.newXxx() - ç†è§£æ’ä»¶åº”ç”¨æ—¶æœº
5. åˆ†é¡µæ’ä»¶æºç  - ç†è§£å®é™…åº”ç”¨

è°ƒè¯•æŠ€å·§ï¼š
1. åœ¨Plugin.wrap()è®¾ç½®æ–­ç‚¹ï¼Œè§‚å¯Ÿä»£ç†ç”Ÿæˆ
2. åœ¨Plugin.invoke()è®¾ç½®æ–­ç‚¹ï¼Œè§‚å¯Ÿæ–¹æ³•æ‹¦æˆª
3. åœ¨interceptor.intercept()è®¾ç½®æ–­ç‚¹ï¼Œè§‚å¯Ÿæ‹¦æˆªé€»è¾‘
4. ä½¿ç”¨MetaObjectæŸ¥çœ‹å¯¹è±¡å†…éƒ¨çŠ¶æ€
```

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [MyBatiså®˜æ–¹æ–‡æ¡£ - æ’ä»¶](https://mybatis.org/mybatis-3/zh/configuration.html#plugins)
- [PageHelperåˆ†é¡µæ’ä»¶](https://github.com/pagehelper/Mybatis-PageHelper)
- [MyBatis-Plusæ’ä»¶](https://baomidou.com/pages/2976a3/)

---

**æŒæ¡MyBatisæ’ä»¶æœºåˆ¶ï¼Œçµæ´»æ‰©å±•æ¡†æ¶åŠŸèƒ½ï¼** ğŸš€

*æœ€åæ›´æ–°ï¼š2025-12-28*
