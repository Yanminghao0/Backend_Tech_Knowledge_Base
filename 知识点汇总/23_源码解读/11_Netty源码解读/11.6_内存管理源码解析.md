# å†…å­˜ç®¡ç†æºç è§£æ

> ğŸ’¡ æ·±å…¥ç†è§£Netty ByteBufä¸å†…å­˜æ± çš„æ ¸å¿ƒå®ç°

---

## ğŸ“‹ ç›®å½•

- [1. ByteBufæ¦‚è¿°](#1-bytebufæ¦‚è¿°)
- [2. ByteBufä½“ç³»](#2-bytebufä½“ç³»)
- [3. å†…å­˜æ± è®¾è®¡](#3-å†…å­˜æ± è®¾è®¡)
- [4. å¼•ç”¨è®¡æ•°](#4-å¼•ç”¨è®¡æ•°)
- [5. é›¶æ‹·è´](#5-é›¶æ‹·è´)
- [6. é¢è¯•è¦ç‚¹](#6-é¢è¯•è¦ç‚¹)

---

## 1. ByteBufæ¦‚è¿°

### 1.1 ByteBuf vs ByteBuffer

```
JDK ByteBufferçš„é—®é¢˜ï¼š
- è¯»å†™å…±ç”¨ä¸€ä¸ªæŒ‡é’ˆï¼Œéœ€è¦flipåˆ‡æ¢
- å®¹é‡å›ºå®šï¼Œä¸èƒ½åŠ¨æ€æ‰©å±•
- APIä¸å¤Ÿå‹å¥½

Netty ByteBufçš„ä¼˜åŠ¿ï¼š
- è¯»å†™åˆ†ç¦»ï¼Œä¸¤ä¸ªæŒ‡é’ˆ
- æ”¯æŒåŠ¨æ€æ‰©å®¹
- æ”¯æŒå¼•ç”¨è®¡æ•°
- æ”¯æŒæ± åŒ–
- æ”¯æŒé›¶æ‹·è´
```

### 1.2 ByteBufç»“æ„

```
+-------------------+------------------+------------------+
| discardable bytes |  readable bytes  |  writable bytes  |
|                   |     (CONTENT)    |                  |
+-------------------+------------------+------------------+
|                   |                  |                  |
0      <=      readerIndex   <=   writerIndex    <=    capacity

discardable bytesï¼šå·²è¯»å–çš„æ•°æ®ï¼Œå¯ä¸¢å¼ƒ
readable bytesï¼šå¯è¯»å–çš„æ•°æ®
writable bytesï¼šå¯å†™å…¥çš„ç©ºé—´
```

### 1.3 åŸºæœ¬æ“ä½œ

```java
// åˆ›å»ºByteBuf
ByteBuf buf = Unpooled.buffer(256);

// å†™å…¥æ•°æ®
buf.writeInt(100);
buf.writeBytes("Hello".getBytes());

// è¯»å–æ•°æ®
int value = buf.readInt();
byte[] bytes = new byte[5];
buf.readBytes(bytes);

// è·å–ç´¢å¼•
int readerIndex = buf.readerIndex();
int writerIndex = buf.writerIndex();
int readableBytes = buf.readableBytes();
int writableBytes = buf.writableBytes();

// æ ‡è®°å’Œé‡ç½®
buf.markReaderIndex();
buf.resetReaderIndex();

// ä¸¢å¼ƒå·²è¯»æ•°æ®
buf.discardReadBytes();

// æ¸…ç©º
buf.clear();

// é‡Šæ”¾
buf.release();
```

---

## 2. ByteBufä½“ç³»

### 2.1 ç»§æ‰¿ä½“ç³»

```
ByteBufï¼ˆæŠ½è±¡ç±»ï¼‰
â”œâ”€â”€ AbstractByteBuf
â”‚   â”œâ”€â”€ AbstractReferenceCountedByteBuf
â”‚   â”‚   â”œâ”€â”€ PooledByteBufï¼ˆæ± åŒ–ï¼‰
â”‚   â”‚   â”‚   â”œâ”€â”€ PooledHeapByteBufï¼ˆæ± åŒ–å †å†…å­˜ï¼‰
â”‚   â”‚   â”‚   â””â”€â”€ PooledDirectByteBufï¼ˆæ± åŒ–ç›´æ¥å†…å­˜ï¼‰
â”‚   â”‚   â””â”€â”€ UnpooledByteBufï¼ˆéæ± åŒ–ï¼‰
â”‚   â”‚       â”œâ”€â”€ UnpooledHeapByteBufï¼ˆéæ± åŒ–å †å†…å­˜ï¼‰
â”‚   â”‚       â””â”€â”€ UnpooledDirectByteBufï¼ˆéæ± åŒ–ç›´æ¥å†…å­˜ï¼‰
â”‚   â””â”€â”€ CompositeByteBufï¼ˆç»„åˆï¼‰
â””â”€â”€ EmptyByteBufï¼ˆç©ºï¼‰
```

### 2.2 ByteBufåˆ†ç±»

```
æŒ‰å†…å­˜ä½ç½®åˆ†ï¼š
1. HeapByteBufï¼ˆå †å†…å­˜ï¼‰
   - æ•°æ®å­˜å‚¨åœ¨JVMå †ä¸­
   - åˆ†é…å’Œå›æ”¶å¿«
   - éœ€è¦é¢å¤–æ‹·è´åˆ°ç›´æ¥å†…å­˜æ‰èƒ½å‘é€

2. DirectByteBufï¼ˆç›´æ¥å†…å­˜ï¼‰
   - æ•°æ®å­˜å‚¨åœ¨å †å¤–å†…å­˜
   - åˆ†é…å’Œå›æ”¶æ…¢
   - å¯ä»¥ç›´æ¥å‘é€ï¼Œå‡å°‘æ‹·è´

æŒ‰æ˜¯å¦æ± åŒ–åˆ†ï¼š
1. PooledByteBufï¼ˆæ± åŒ–ï¼‰
   - ä»å†…å­˜æ± åˆ†é…
   - å‡å°‘GCå‹åŠ›
   - éœ€è¦æ‰‹åŠ¨é‡Šæ”¾

2. UnpooledByteBufï¼ˆéæ± åŒ–ï¼‰
   - æ¯æ¬¡æ–°åˆ†é…
   - ç”±GCå›æ”¶
   - é€‚åˆå°å¯¹è±¡
```

### 2.3 ByteBufAllocator

```java
// åˆ†é…å™¨æ¥å£
public interface ByteBufAllocator {
    // åˆ†é…ByteBufï¼ˆé»˜è®¤ç›´æ¥å†…å­˜ï¼‰
    ByteBuf buffer();
    ByteBuf buffer(int initialCapacity);
    ByteBuf buffer(int initialCapacity, int maxCapacity);
    
    // åˆ†é…å †å†…å­˜ByteBuf
    ByteBuf heapBuffer();
    ByteBuf heapBuffer(int initialCapacity);
    
    // åˆ†é…ç›´æ¥å†…å­˜ByteBuf
    ByteBuf directBuffer();
    ByteBuf directBuffer(int initialCapacity);
    
    // åˆ†é…ç»„åˆByteBuf
    CompositeByteBuf compositeBuffer();
}

// æ± åŒ–åˆ†é…å™¨ï¼ˆé»˜è®¤ï¼‰
PooledByteBufAllocator.DEFAULT

// éæ± åŒ–åˆ†é…å™¨
UnpooledByteBufAllocator.DEFAULT

// ä½¿ç”¨ç¤ºä¾‹
ByteBuf buf = PooledByteBufAllocator.DEFAULT.buffer(256);
ByteBuf heapBuf = PooledByteBufAllocator.DEFAULT.heapBuffer(256);
ByteBuf directBuf = PooledByteBufAllocator.DEFAULT.directBuffer(256);
```

---

## 3. å†…å­˜æ± è®¾è®¡

### 3.1 å†…å­˜æ± æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  PooledByteBufAllocator                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    PoolThreadCache                   â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚ tinyCache   â”‚ â”‚ smallCache  â”‚ â”‚ normalCache â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                              â”‚
â”‚                              â–¼                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    PoolArena                         â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚ tinySubpage â”‚ â”‚smallSubpage â”‚ â”‚ PoolChunk   â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æ ¸å¿ƒç»„ä»¶

```java
// PoolArenaï¼šå†…å­˜åŒºåŸŸ
abstract class PoolArena<T> {
    // Tinyå†…å­˜å—ï¼ˆ<512Bï¼‰
    private final PoolSubpage<T>[] tinySubpagePools;
    
    // Smallå†…å­˜å—ï¼ˆ512B-8KBï¼‰
    private final PoolSubpage<T>[] smallSubpagePools;
    
    // Chunkåˆ—è¡¨ï¼ˆæŒ‰ä½¿ç”¨ç‡åˆ†ç»„ï¼‰
    private final PoolChunkList<T> q050;  // 50-100%
    private final PoolChunkList<T> q025;  // 25-75%
    private final PoolChunkList<T> q000;  // 1-50%
    private final PoolChunkList<T> qInit; // 0-25%
    private final PoolChunkList<T> q075;  // 75-100%
    private final PoolChunkList<T> q100;  // 100%
}

// PoolChunkï¼šå†…å­˜å—ï¼ˆé»˜è®¤16MBï¼‰
final class PoolChunk<T> {
    final PoolArena<T> arena;
    final T memory;  // å®é™…å†…å­˜
    final int pageSize;  // é¡µå¤§å°ï¼ˆ8KBï¼‰
    final int maxOrder;  // æœ€å¤§æ·±åº¦ï¼ˆ11ï¼‰
    final int chunkSize; // å—å¤§å°ï¼ˆ16MBï¼‰
    
    // ä½¿ç”¨äºŒå‰æ ‘ç®¡ç†å†…å­˜åˆ†é…
    private final byte[] memoryMap;
    private final byte[] depthMap;
}

// PoolSubpageï¼šå­é¡µï¼ˆç”¨äºå°å†…å­˜åˆ†é…ï¼‰
final class PoolSubpage<T> {
    final PoolChunk<T> chunk;
    final int elemSize;  // å…ƒç´ å¤§å°
    private final long[] bitmap;  // ä½å›¾
}

// PoolThreadCacheï¼šçº¿ç¨‹ç¼“å­˜
final class PoolThreadCache {
    final PoolArena<byte[]> heapArena;
    final PoolArena<ByteBuffer> directArena;
    
    // ç¼“å­˜æ•°ç»„
    private final MemoryRegionCache<byte[]>[] tinySubPageHeapCaches;
    private final MemoryRegionCache<byte[]>[] smallSubPageHeapCaches;
    private final MemoryRegionCache<byte[]>[] normalHeapCaches;
}
```

### 3.3 å†…å­˜åˆ†é…æµç¨‹

```java
// PooledByteBufAllocator.newDirectBuffer()
@Override
protected ByteBuf newDirectBuffer(int initialCapacity, int maxCapacity) {
    // 1. è·å–çº¿ç¨‹ç¼“å­˜
    PoolThreadCache cache = threadCache.get();
    PoolArena<ByteBuffer> directArena = cache.directArena;
    
    final ByteBuf buf;
    if (directArena != null) {
        // 2. ä»Arenaåˆ†é…
        buf = directArena.allocate(cache, initialCapacity, maxCapacity);
    } else {
        // 3. æ— Arenaï¼Œä½¿ç”¨éæ± åŒ–
        buf = PlatformDependent.hasUnsafe() ?
            UnsafeByteBufUtil.newUnsafeDirectByteBuf(this, initialCapacity, maxCapacity) :
            new UnpooledDirectByteBuf(this, initialCapacity, maxCapacity);
    }
    
    return toLeakAwareBuffer(buf);
}

// PoolArena.allocate()
PooledByteBuf<T> allocate(PoolThreadCache cache, int reqCapacity, int maxCapacity) {
    // 1. è·å–ByteBufå¯¹è±¡ï¼ˆä»å¯¹è±¡æ± ï¼‰
    PooledByteBuf<T> buf = newByteBuf(maxCapacity);
    
    // 2. åˆ†é…å†…å­˜
    allocate(cache, buf, reqCapacity);
    
    return buf;
}

private void allocate(PoolThreadCache cache, PooledByteBuf<T> buf, final int reqCapacity) {
    final int normCapacity = normalizeCapacity(reqCapacity);
    
    if (isTinyOrSmall(normCapacity)) {
        // Tinyæˆ–Smallå†…å­˜
        int tableIdx;
        PoolSubpage<T>[] table;
        boolean tiny = isTiny(normCapacity);
        
        if (tiny) {
            // 1. å…ˆä»çº¿ç¨‹ç¼“å­˜åˆ†é…
            if (cache.allocateTiny(this, buf, reqCapacity, normCapacity)) {
                return;
            }
            tableIdx = tinyIdx(normCapacity);
            table = tinySubpagePools;
        } else {
            if (cache.allocateSmall(this, buf, reqCapacity, normCapacity)) {
                return;
            }
            tableIdx = smallIdx(normCapacity);
            table = smallSubpagePools;
        }
        
        // 2. ä»Subpageåˆ†é…
        final PoolSubpage<T> head = table[tableIdx];
        synchronized (head) {
            final PoolSubpage<T> s = head.next;
            if (s != head) {
                long handle = s.allocate();
                s.chunk.initBufWithSubpage(buf, null, handle, reqCapacity);
                return;
            }
        }
        
        // 3. ä»Chunkåˆ†é…æ–°Subpage
        synchronized (this) {
            allocateNormal(buf, reqCapacity, normCapacity);
        }
    } else if (normCapacity <= chunkSize) {
        // Normalå†…å­˜
        if (cache.allocateNormal(this, buf, reqCapacity, normCapacity)) {
            return;
        }
        synchronized (this) {
            allocateNormal(buf, reqCapacity, normCapacity);
        }
    } else {
        // Hugeå†…å­˜ï¼ˆè¶…è¿‡16MBï¼‰
        allocateHuge(buf, reqCapacity);
    }
}
```

### 3.4 å†…å­˜è§„æ ¼

```
Tinyï¼š16B, 32B, 48B, ..., 496Bï¼ˆ16Bé€’å¢ï¼Œå…±31ç§ï¼‰
Smallï¼š512B, 1KB, 2KB, 4KBï¼ˆç¿»å€é€’å¢ï¼Œå…±4ç§ï¼‰
Normalï¼š8KB, 16KB, 32KB, ..., 16MBï¼ˆç¿»å€é€’å¢ï¼‰
Hugeï¼š>16MBï¼ˆä¸æ± åŒ–ï¼‰

Pageå¤§å°ï¼š8KB
Chunkå¤§å°ï¼š16MB = 2048ä¸ªPage
```

---

## 4. å¼•ç”¨è®¡æ•°

### 4.1 ReferenceCountedæ¥å£

```java
public interface ReferenceCounted {
    // è·å–å¼•ç”¨è®¡æ•°
    int refCnt();
    
    // å¢åŠ å¼•ç”¨
    ReferenceCounted retain();
    ReferenceCounted retain(int increment);
    
    // å‡å°‘å¼•ç”¨
    boolean release();
    boolean release(int decrement);
}
```

### 4.2 å¼•ç”¨è®¡æ•°å®ç°

```java
// AbstractReferenceCountedByteBuf
public abstract class AbstractReferenceCountedByteBuf extends AbstractByteBuf {
    
    // å¼•ç”¨è®¡æ•°ï¼ˆä½¿ç”¨å¶æ•°è¡¨ç¤ºï¼Œå¥‡æ•°è¡¨ç¤ºå·²é‡Šæ”¾ï¼‰
    private volatile int refCnt = 2;
    
    @Override
    public int refCnt() {
        return refCnt >>> 1;
    }
    
    @Override
    public ByteBuf retain() {
        return retain0(1);
    }
    
    private ByteBuf retain0(int increment) {
        // CASå¢åŠ å¼•ç”¨è®¡æ•°
        int oldRef = refCntUpdater.getAndAdd(this, increment << 1);
        if ((oldRef & 1) != 0) {
            throw new IllegalReferenceCountException(0, increment);
        }
        if ((oldRef <= 0 && oldRef + (increment << 1) >= 0) ||
            (oldRef >= 0 && oldRef + (increment << 1) < oldRef)) {
            // æº¢å‡ºæ£€æŸ¥
            refCntUpdater.getAndAdd(this, -(increment << 1));
            throw new IllegalReferenceCountException(realRefCnt(oldRef), increment);
        }
        return this;
    }
    
    @Override
    public boolean release() {
        return release0(1);
    }
    
    private boolean release0(int decrement) {
        int oldRef = refCntUpdater.getAndAdd(this, -(decrement << 1));
        if (oldRef == (decrement << 1)) {
            // å¼•ç”¨è®¡æ•°å½’é›¶ï¼Œé‡Šæ”¾èµ„æº
            deallocate();
            return true;
        }
        if ((oldRef & 1) != 0) {
            throw new IllegalReferenceCountException(0, -decrement);
        }
        if ((oldRef < 0 && oldRef - (decrement << 1) >= 0) ||
            (oldRef >= 0 && oldRef - (decrement << 1) > oldRef)) {
            // æº¢å‡ºæ£€æŸ¥
            refCntUpdater.getAndAdd(this, decrement << 1);
            throw new IllegalReferenceCountException(realRefCnt(oldRef), -decrement);
        }
        return false;
    }
}
```

### 4.3 ä½¿ç”¨è§„åˆ™

```java
// æ­£ç¡®ä½¿ç”¨å¼•ç”¨è®¡æ•°
ByteBuf buf = allocator.buffer();
try {
    // ä½¿ç”¨buf
    process(buf);
} finally {
    // é‡Šæ”¾
    buf.release();
}

// ä¼ é€’æ‰€æœ‰æƒ
void passOwnership(ByteBuf buf) {
    // è°ƒç”¨è€…è´Ÿè´£é‡Šæ”¾
    channel.writeAndFlush(buf);
    // writeåä¼šè‡ªåŠ¨release
}

// ä¿ç•™å¼•ç”¨
void keepReference(ByteBuf buf) {
    buf.retain();  // å¢åŠ å¼•ç”¨
    // ä½¿ç”¨buf
    buf.release(); // ä½¿ç”¨å®Œé‡Šæ”¾
}

// å·¥å…·ç±»
ReferenceCountUtil.release(msg);  // å®‰å…¨é‡Šæ”¾
ReferenceCountUtil.retain(msg);   // å®‰å…¨ä¿ç•™
```


---

## 5. é›¶æ‹·è´

### 5.1 é›¶æ‹·è´æ¦‚å¿µ

```
ä¼ ç»ŸIOæ‹·è´ï¼š
1. ç£ç›˜ â†’ å†…æ ¸ç¼“å†²åŒºï¼ˆDMAæ‹·è´ï¼‰
2. å†…æ ¸ç¼“å†²åŒº â†’ ç”¨æˆ·ç¼“å†²åŒºï¼ˆCPUæ‹·è´ï¼‰
3. ç”¨æˆ·ç¼“å†²åŒº â†’ Socketç¼“å†²åŒºï¼ˆCPUæ‹·è´ï¼‰
4. Socketç¼“å†²åŒº â†’ ç½‘å¡ï¼ˆDMAæ‹·è´ï¼‰

é›¶æ‹·è´ï¼š
1. ç£ç›˜ â†’ å†…æ ¸ç¼“å†²åŒºï¼ˆDMAæ‹·è´ï¼‰
2. å†…æ ¸ç¼“å†²åŒº â†’ ç½‘å¡ï¼ˆDMAæ‹·è´ï¼‰

å‡å°‘äº†ç”¨æˆ·æ€å’Œå†…æ ¸æ€ä¹‹é—´çš„æ•°æ®æ‹·è´
```

### 5.2 Nettyé›¶æ‹·è´å®ç°

```java
// 1. CompositeByteBufï¼šç»„åˆå¤šä¸ªByteBuf
CompositeByteBuf composite = Unpooled.compositeBuffer();
composite.addComponents(true, buf1, buf2, buf3);
// é€»è¾‘ä¸Šåˆå¹¶ï¼Œç‰©ç†ä¸Šä¸æ‹·è´

// 2. sliceï¼šåˆ‡ç‰‡
ByteBuf slice = buf.slice(0, 10);
// å…±äº«åº•å±‚æ•°æ®ï¼Œä¸æ‹·è´

// 3. duplicateï¼šå¤åˆ¶
ByteBuf duplicate = buf.duplicate();
// å…±äº«åº•å±‚æ•°æ®ï¼Œç‹¬ç«‹ç´¢å¼•

// 4. wrapï¼šåŒ…è£…
ByteBuf wrapped = Unpooled.wrappedBuffer(byteArray);
// ç›´æ¥åŒ…è£…æ•°ç»„ï¼Œä¸æ‹·è´

// 5. FileRegionï¼šæ–‡ä»¶ä¼ è¾“
FileRegion region = new DefaultFileRegion(fileChannel, 0, fileLength);
channel.writeAndFlush(region);
// ä½¿ç”¨sendfileç³»ç»Ÿè°ƒç”¨ï¼Œé›¶æ‹·è´ä¼ è¾“æ–‡ä»¶
```

### 5.3 CompositeByteBufå®ç°

```java
public class CompositeByteBuf extends AbstractReferenceCountedByteBuf {
    
    // ç»„ä»¶åˆ—è¡¨
    private Component[] components;
    private int componentCount;
    
    // æ·»åŠ ç»„ä»¶
    public CompositeByteBuf addComponent(boolean increaseWriterIndex, ByteBuf buffer) {
        ObjectUtil.checkNotNull(buffer, "buffer");
        addComponent0(increaseWriterIndex, componentCount, buffer);
        consolidateIfNeeded();
        return this;
    }
    
    private int addComponent0(boolean increaseWriterIndex, int cIndex, ByteBuf buffer) {
        // åˆ›å»ºç»„ä»¶
        Component c = newComponent(buffer, 0);
        
        // æ·»åŠ åˆ°æ•°ç»„
        int readableBytes = c.length();
        addComp(cIndex, c);
        
        // æ›´æ–°ç´¢å¼•
        if (increaseWriterIndex) {
            writerIndex += readableBytes;
        }
        
        return cIndex;
    }
    
    // è¯»å–æ•°æ®æ—¶ï¼Œå®šä½åˆ°å¯¹åº”çš„ç»„ä»¶
    @Override
    public byte getByte(int index) {
        Component c = findComponent(index);
        return c.buf.getByte(c.idx(index));
    }
    
    // æŸ¥æ‰¾ç»„ä»¶
    private Component findComponent(int offset) {
        // äºŒåˆ†æŸ¥æ‰¾
        int lo = 0, hi = componentCount;
        while (lo <= hi) {
            int mid = lo + hi >>> 1;
            Component c = components[mid];
            if (offset >= c.endOffset) {
                lo = mid + 1;
            } else if (offset < c.offset) {
                hi = mid - 1;
            } else {
                return c;
            }
        }
        throw new Error("should not reach here");
    }
}
```

### 5.4 FileRegionå®ç°

```java
// DefaultFileRegion
public class DefaultFileRegion extends AbstractReferenceCounted implements FileRegion {
    
    private final FileChannel file;
    private final long position;
    private final long count;
    private long transferred;
    
    @Override
    public long transferTo(WritableByteChannel target, long position) throws IOException {
        long count = this.count - position;
        if (count < 0 || position < 0) {
            throw new IllegalArgumentException();
        }
        if (count == 0) {
            return 0L;
        }
        
        // ä½¿ç”¨FileChannel.transferToå®ç°é›¶æ‹·è´
        long written = file.transferTo(this.position + position, count, target);
        if (written > 0) {
            transferred += written;
        }
        return written;
    }
}

// ä½¿ç”¨ç¤ºä¾‹
RandomAccessFile raf = new RandomAccessFile(file, "r");
FileRegion region = new DefaultFileRegion(raf.getChannel(), 0, raf.length());
channel.writeAndFlush(region).addListener(future -> {
    raf.close();
});
```

---

## 6. é¢è¯•è¦ç‚¹

### 6.1 é«˜é¢‘é—®é¢˜

**Q1: ByteBufå’ŒByteBufferçš„åŒºåˆ«ï¼Ÿ**
```
ByteBufferï¼ˆJDKï¼‰ï¼š
- è¯»å†™å…±ç”¨ä¸€ä¸ªæŒ‡é’ˆï¼Œéœ€è¦flipåˆ‡æ¢
- å®¹é‡å›ºå®šï¼Œä¸èƒ½æ‰©å±•
- åªæœ‰å †å†…å­˜å’Œç›´æ¥å†…å­˜ä¸¤ç§

ByteBufï¼ˆNettyï¼‰ï¼š
- è¯»å†™åˆ†ç¦»ï¼Œä¸¤ä¸ªæŒ‡é’ˆ
- æ”¯æŒåŠ¨æ€æ‰©å®¹
- æ”¯æŒå¼•ç”¨è®¡æ•°
- æ”¯æŒæ± åŒ–
- æ”¯æŒé›¶æ‹·è´
- APIæ›´å‹å¥½
```

**Q2: å †å†…å­˜å’Œç›´æ¥å†…å­˜çš„åŒºåˆ«ï¼Ÿ**
```
å †å†…å­˜ï¼ˆHeapByteBufï¼‰ï¼š
- å­˜å‚¨åœ¨JVMå †ä¸­
- åˆ†é…å’Œå›æ”¶å¿«ï¼ˆGCç®¡ç†ï¼‰
- å‘é€æ•°æ®éœ€è¦æ‹·è´åˆ°ç›´æ¥å†…å­˜
- é€‚åˆä¸šåŠ¡å¤„ç†

ç›´æ¥å†…å­˜ï¼ˆDirectByteBufï¼‰ï¼š
- å­˜å‚¨åœ¨å †å¤–å†…å­˜
- åˆ†é…å’Œå›æ”¶æ…¢
- å¯ä»¥ç›´æ¥å‘é€ï¼Œå‡å°‘æ‹·è´
- é€‚åˆIOæ“ä½œ
```

**Q3: Nettyå†…å­˜æ± çš„è®¾è®¡ï¼Ÿ**
```
åˆ†å±‚è®¾è®¡ï¼š
1. PoolThreadCacheï¼šçº¿ç¨‹æœ¬åœ°ç¼“å­˜
   - å‡å°‘é”ç«äº‰
   - å¿«é€Ÿåˆ†é…

2. PoolArenaï¼šå†…å­˜åŒºåŸŸ
   - ç®¡ç†Chunkå’ŒSubpage
   - å¤šä¸ªArenaå‡å°‘ç«äº‰

3. PoolChunkï¼šå†…å­˜å—ï¼ˆ16MBï¼‰
   - ä½¿ç”¨äºŒå‰æ ‘ç®¡ç†
   - ä¼™ä¼´ç®—æ³•åˆ†é…

4. PoolSubpageï¼šå­é¡µ
   - ç”¨äºå°å†…å­˜åˆ†é…
   - ä½å›¾ç®¡ç†

å†…å­˜è§„æ ¼ï¼š
- Tinyï¼š<512B
- Smallï¼š512B-8KB
- Normalï¼š8KB-16MB
- Hugeï¼š>16MBï¼ˆä¸æ± åŒ–ï¼‰
```

**Q4: å¼•ç”¨è®¡æ•°çš„ä½œç”¨ï¼Ÿ**
```
ä½œç”¨ï¼š
1. ç®¡ç†ByteBufç”Ÿå‘½å‘¨æœŸ
2. æ”¯æŒå…±äº«å’Œä¼ é€’
3. é¿å…å†…å­˜æ³„æ¼

è§„åˆ™ï¼š
- åˆ›å»ºæ—¶refCnt=1
- retain()å¢åŠ è®¡æ•°
- release()å‡å°‘è®¡æ•°
- refCnt=0æ—¶é‡Šæ”¾å†…å­˜

æ³¨æ„ï¼š
- è°æœ€åä½¿ç”¨è°é‡Šæ”¾
- writeåè‡ªåŠ¨release
- ä½¿ç”¨ReferenceCountUtilå·¥å…·ç±»
```

**Q5: Nettyçš„é›¶æ‹·è´æœ‰å“ªäº›ï¼Ÿ**
```
1. CompositeByteBuf
   - ç»„åˆå¤šä¸ªByteBuf
   - é€»è¾‘åˆå¹¶ï¼Œç‰©ç†ä¸æ‹·è´

2. slice/duplicate
   - å…±äº«åº•å±‚æ•°æ®
   - ç‹¬ç«‹è¯»å†™ç´¢å¼•

3. wrap
   - åŒ…è£…å­—èŠ‚æ•°ç»„
   - ä¸æ‹·è´æ•°æ®

4. FileRegion
   - æ–‡ä»¶ä¼ è¾“
   - ä½¿ç”¨sendfileç³»ç»Ÿè°ƒç”¨

5. ç›´æ¥å†…å­˜
   - å‡å°‘ç”¨æˆ·æ€å’Œå†…æ ¸æ€æ‹·è´
```

### 6.2 æ ¸å¿ƒç±»æ€»ç»“

```
ByteBufç›¸å…³ï¼š
- ByteBufï¼šå­—èŠ‚ç¼“å†²åŒºæŠ½è±¡ç±»
- PooledByteBufï¼šæ± åŒ–ByteBuf
- UnpooledByteBufï¼šéæ± åŒ–ByteBuf
- CompositeByteBufï¼šç»„åˆByteBuf

åˆ†é…å™¨ï¼š
- ByteBufAllocatorï¼šåˆ†é…å™¨æ¥å£
- PooledByteBufAllocatorï¼šæ± åŒ–åˆ†é…å™¨
- UnpooledByteBufAllocatorï¼šéæ± åŒ–åˆ†é…å™¨

å†…å­˜æ± ï¼š
- PoolArenaï¼šå†…å­˜åŒºåŸŸ
- PoolChunkï¼šå†…å­˜å—
- PoolSubpageï¼šå­é¡µ
- PoolThreadCacheï¼šçº¿ç¨‹ç¼“å­˜

å·¥å…·ç±»ï¼š
- Unpooledï¼šéæ± åŒ–å·¥å…·
- ByteBufUtilï¼šByteBufå·¥å…·
- ReferenceCountUtilï¼šå¼•ç”¨è®¡æ•°å·¥å…·
```

---

## ğŸ“Š å†…å­˜åˆ†é…æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      åˆ†é…è¯·æ±‚                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    1. è§„æ ¼åŒ–å¤§å°                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Tiny(<512B) / Small(512B-8KB) / Normal / Huge      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    2. çº¿ç¨‹ç¼“å­˜åˆ†é…                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  PoolThreadCache.allocate()                          â”‚   â”‚
â”‚  â”‚  å‘½ä¸­ â†’ è¿”å›                                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚ æœªå‘½ä¸­
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    3. Arenaåˆ†é…                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Tiny/Small â†’ Subpageåˆ†é…                            â”‚   â”‚
â”‚  â”‚  Normal â†’ Chunkåˆ†é…                                  â”‚   â”‚
â”‚  â”‚  Huge â†’ ç›´æ¥åˆ†é…ï¼ˆä¸æ± åŒ–ï¼‰                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    4. è¿”å›ByteBuf                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**æ·±å…¥ç†è§£å†…å­˜ç®¡ç†ï¼ŒæŒæ¡Nettyæ ¸å¿ƒï¼** ğŸš€

*æœ€åæ›´æ–°ï¼š2025-12-28*
