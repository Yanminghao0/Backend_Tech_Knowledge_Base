# Semaphoreæºç è§£æ

> ä¿¡å·é‡ï¼Œæ§åˆ¶åŒæ—¶è®¿é—®èµ„æºçš„çº¿ç¨‹æ•°é‡

## ğŸ“‹ ç›®å½•
- [æ•´ä½“ç»“æ„](#æ•´ä½“ç»“æ„)
- [æ ¸å¿ƒåŸç†](#æ ¸å¿ƒåŸç†)
- [å…¬å¹³ä¸éå…¬å¹³](#å…¬å¹³ä¸éå…¬å¹³)
- [acquireæ–¹æ³•](#acquireæ–¹æ³•)
- [releaseæ–¹æ³•](#releaseæ–¹æ³•)
- [ä½¿ç”¨åœºæ™¯](#ä½¿ç”¨åœºæ™¯)
- [é¢è¯•è¦ç‚¹](#é¢è¯•è¦ç‚¹)

---

## æ•´ä½“ç»“æ„

### ç±»å®šä¹‰

```java
public class Semaphore implements java.io.Serializable {
    
    // å†…éƒ¨åŒæ­¥å™¨
    private final Sync sync;
    
    // æŠ½è±¡åŒæ­¥å™¨
    abstract static class Sync extends AbstractQueuedSynchronizer {
        
        Sync(int permits) {
            setState(permits);  // åˆå§‹åŒ–è®¸å¯æ•°
        }
        
        final int getPermits() {
            return getState();
        }
        
        // éå…¬å¹³å°è¯•è·å–
        final int nonfairTryAcquireShared(int acquires) {
            for (;;) {
                int available = getState();
                int remaining = available - acquires;
                if (remaining < 0 ||
                    compareAndSetState(available, remaining))
                    return remaining;
            }
        }
        
        // é‡Šæ”¾è®¸å¯
        protected final boolean tryReleaseShared(int releases) {
            for (;;) {
                int current = getState();
                int next = current + releases;
                if (next < current) // overflow
                    throw new Error("Maximum permit count exceeded");
                if (compareAndSetState(current, next))
                    return true;
            }
        }
    }
    
    // éå…¬å¹³åŒæ­¥å™¨
    static final class NonfairSync extends Sync {
        NonfairSync(int permits) {
            super(permits);
        }
        
        protected int tryAcquireShared(int acquires) {
            return nonfairTryAcquireShared(acquires);
        }
    }
    
    // å…¬å¹³åŒæ­¥å™¨
    static final class FairSync extends Sync {
        FairSync(int permits) {
            super(permits);
        }
        
        protected int tryAcquireShared(int acquires) {
            for (;;) {
                if (hasQueuedPredecessors())  // æ£€æŸ¥æ˜¯å¦æœ‰æ’é˜Ÿçš„çº¿ç¨‹
                    return -1;
                int available = getState();
                int remaining = available - acquires;
                if (remaining < 0 ||
                    compareAndSetState(available, remaining))
                    return remaining;
            }
        }
    }
}

/**
 * å…³é”®ç‚¹ï¼š
 * 1. åŸºäºAQSå…±äº«æ¨¡å¼å®ç°
 * 2. stateè¡¨ç¤ºå¯ç”¨è®¸å¯æ•°
 * 3. acquireå‡å°‘è®¸å¯ï¼Œreleaseå¢åŠ è®¸å¯
 * 4. æ”¯æŒå…¬å¹³å’Œéå…¬å¹³æ¨¡å¼
 */
```

### å·¥ä½œåŸç†ç¤ºæ„å›¾

```
Semaphore(3) - æœ€å¤šå…è®¸3ä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®

åˆå§‹çŠ¶æ€ï¼špermits = 3

Thread-1: acquire() â†’ permits = 2 â†’ è·å–æˆåŠŸï¼Œæ‰§è¡Œ
Thread-2: acquire() â†’ permits = 1 â†’ è·å–æˆåŠŸï¼Œæ‰§è¡Œ
Thread-3: acquire() â†’ permits = 0 â†’ è·å–æˆåŠŸï¼Œæ‰§è¡Œ
Thread-4: acquire() â†’ permits = 0 â†’ é˜»å¡ç­‰å¾…
Thread-5: acquire() â†’ permits = 0 â†’ é˜»å¡ç­‰å¾…

Thread-1: release() â†’ permits = 1 â†’ Thread-4è¢«å”¤é†’
Thread-4: è·å–æˆåŠŸï¼Œæ‰§è¡Œ
```

---

## æ ¸å¿ƒåŸç†

### AQSå…±äº«æ¨¡å¼

```java
/**
 * Semaphoreä½¿ç”¨AQSçš„å…±äº«æ¨¡å¼
 * 
 * stateçš„å«ä¹‰ï¼š
 * - state > 0ï¼šè¿˜æœ‰å¯ç”¨è®¸å¯
 * - state = 0ï¼šæ²¡æœ‰å¯ç”¨è®¸å¯ï¼Œéœ€è¦ç­‰å¾…
 * 
 * ä¸CountDownLatchçš„åŒºåˆ«ï¼š
 * - CountDownLatchï¼šstateåªèƒ½å‡å°‘ï¼Œå‡åˆ°0åä¸èƒ½æ¢å¤
 * - Semaphoreï¼šstateå¯ä»¥å¢åŠ å’Œå‡å°‘ï¼Œå¯ä»¥é‡å¤ä½¿ç”¨
 */

// tryAcquireSharedè¿”å›å€¼å«ä¹‰ï¼š
// < 0ï¼šè·å–å¤±è´¥ï¼Œéœ€è¦æ’é˜Ÿç­‰å¾…
// >= 0ï¼šè·å–æˆåŠŸï¼Œè¿”å›å‰©ä½™è®¸å¯æ•°

// éå…¬å¹³è·å–
final int nonfairTryAcquireShared(int acquires) {
    for (;;) {
        int available = getState();
        int remaining = available - acquires;
        if (remaining < 0 ||  // è®¸å¯ä¸è¶³
            compareAndSetState(available, remaining))  // CASæˆåŠŸ
            return remaining;
    }
}
```

### çŠ¶æ€è½¬æ¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Semaphore(N)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  state = N (åˆå§‹è®¸å¯æ•°)                              â”‚
â”‚                                                      â”‚
â”‚  acquire() â†’ state = state - 1                      â”‚
â”‚  acquire(n) â†’ state = state - n                     â”‚
â”‚                                                      â”‚
â”‚  release() â†’ state = state + 1                      â”‚
â”‚  release(n) â†’ state = state + n                     â”‚
â”‚                                                      â”‚
â”‚  stateå¯ä»¥è¶…è¿‡åˆå§‹å€¼Nï¼ˆreleaseå¯ä»¥å¢åŠ è®¸å¯ï¼‰         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å…¬å¹³ä¸éå…¬å¹³

### éå…¬å¹³æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰

```java
/**
 * éå…¬å¹³æ¨¡å¼ï¼šæ–°æ¥çš„çº¿ç¨‹å¯ä»¥æ’é˜Ÿ
 */
static final class NonfairSync extends Sync {
    
    protected int tryAcquireShared(int acquires) {
        return nonfairTryAcquireShared(acquires);
    }
}

final int nonfairTryAcquireShared(int acquires) {
    for (;;) {
        int available = getState();
        int remaining = available - acquires;
        // ä¸æ£€æŸ¥é˜Ÿåˆ—ï¼Œç›´æ¥å°è¯•CASè·å–
        if (remaining < 0 ||
            compareAndSetState(available, remaining))
            return remaining;
    }
}

/**
 * éå…¬å¹³æ¨¡å¼ç‰¹ç‚¹ï¼š
 * 1. æ–°çº¿ç¨‹å¯ä»¥ç›´æ¥å°è¯•è·å–è®¸å¯
 * 2. å¯èƒ½å¯¼è‡´ç­‰å¾…é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹é¥¥é¥¿
 * 3. ååé‡æ›´é«˜
 */
```

### å…¬å¹³æ¨¡å¼

```java
/**
 * å…¬å¹³æ¨¡å¼ï¼šæŒ‰ç…§FIFOé¡ºåºè·å–è®¸å¯
 */
static final class FairSync extends Sync {
    
    protected int tryAcquireShared(int acquires) {
        for (;;) {
            // æ£€æŸ¥æ˜¯å¦æœ‰æ’é˜Ÿçš„çº¿ç¨‹
            if (hasQueuedPredecessors())
                return -1;  // æœ‰äººæ’é˜Ÿï¼Œå½“å‰çº¿ç¨‹ä¹Ÿè¦æ’é˜Ÿ
            
            int available = getState();
            int remaining = available - acquires;
            if (remaining < 0 ||
                compareAndSetState(available, remaining))
                return remaining;
        }
    }
}

/**
 * å…¬å¹³æ¨¡å¼ç‰¹ç‚¹ï¼š
 * 1. å…ˆæ¥å…ˆå¾—ï¼ŒæŒ‰é¡ºåºè·å–
 * 2. ä¸ä¼šé¥¥é¥¿
 * 3. ååé‡è¾ƒä½ï¼ˆéœ€è¦æ£€æŸ¥é˜Ÿåˆ—ï¼‰
 */
```

### å…¬å¹³vséå…¬å¹³å¯¹æ¯”

```
éå…¬å¹³æ¨¡å¼ï¼š
Thread-1: acquire() â†’ è·å–æˆåŠŸ
Thread-2: acquire() â†’ é˜»å¡ç­‰å¾…
Thread-3: acquire() â†’ å¯èƒ½æ’é˜ŸæˆåŠŸï¼ˆå¦‚æœæ­¤æ—¶æœ‰è®¸å¯é‡Šæ”¾ï¼‰

å…¬å¹³æ¨¡å¼ï¼š
Thread-1: acquire() â†’ è·å–æˆåŠŸ
Thread-2: acquire() â†’ é˜»å¡ç­‰å¾…
Thread-3: acquire() â†’ å¿…é¡»æ’é˜Ÿç­‰å¾…Thread-2ä¹‹å
```

---

## æ„é€ æ–¹æ³•

```java
/**
 * åˆ›å»ºéå…¬å¹³Semaphore
 */
public Semaphore(int permits) {
    sync = new NonfairSync(permits);
}

/**
 * åˆ›å»ºæŒ‡å®šå…¬å¹³æ€§çš„Semaphore
 */
public Semaphore(int permits, boolean fair) {
    sync = fair ? new FairSync(permits) : new NonfairSync(permits);
}

// ä½¿ç”¨ç¤ºä¾‹
Semaphore semaphore = new Semaphore(3);  // éå…¬å¹³ï¼Œ3ä¸ªè®¸å¯
Semaphore fairSemaphore = new Semaphore(3, true);  // å…¬å¹³ï¼Œ3ä¸ªè®¸å¯
```

---

## acquireæ–¹æ³•

### acquire() - è·å–ä¸€ä¸ªè®¸å¯

```java
/**
 * è·å–ä¸€ä¸ªè®¸å¯ï¼Œå¦‚æœæ²¡æœ‰å¯ç”¨è®¸å¯åˆ™é˜»å¡
 * å¯è¢«ä¸­æ–­
 */
public void acquire() throws InterruptedException {
    sync.acquireSharedInterruptibly(1);
}

// AQS.acquireSharedInterruptibly
public final void acquireSharedInterruptibly(int arg)
        throws InterruptedException {
    if (Thread.interrupted())
        throw new InterruptedException();
    if (tryAcquireShared(arg) < 0)  // å°è¯•è·å–
        doAcquireSharedInterruptibly(arg);  // è·å–å¤±è´¥ï¼Œè¿›å…¥ç­‰å¾…é˜Ÿåˆ—
}
```

### acquire(int permits) - è·å–å¤šä¸ªè®¸å¯

```java
/**
 * è·å–æŒ‡å®šæ•°é‡çš„è®¸å¯
 */
public void acquire(int permits) throws InterruptedException {
    if (permits < 0) throw new IllegalArgumentException();
    sync.acquireSharedInterruptibly(permits);
}

// ä½¿ç”¨ç¤ºä¾‹
semaphore.acquire(2);  // è·å–2ä¸ªè®¸å¯
// ... ä½¿ç”¨èµ„æº ...
semaphore.release(2);  // é‡Šæ”¾2ä¸ªè®¸å¯
```

### acquireUninterruptibly() - ä¸å¯ä¸­æ–­è·å–

```java
/**
 * è·å–è®¸å¯ï¼Œä¸å“åº”ä¸­æ–­
 */
public void acquireUninterruptibly() {
    sync.acquireShared(1);
}

public void acquireUninterruptibly(int permits) {
    if (permits < 0) throw new IllegalArgumentException();
    sync.acquireShared(permits);
}
```

### tryAcquire() - å°è¯•è·å–

```java
/**
 * å°è¯•è·å–è®¸å¯ï¼Œç«‹å³è¿”å›
 * @return true-è·å–æˆåŠŸï¼Œfalse-è·å–å¤±è´¥
 */
public boolean tryAcquire() {
    return sync.nonfairTryAcquireShared(1) >= 0;
}

/**
 * å¸¦è¶…æ—¶çš„å°è¯•è·å–
 */
public boolean tryAcquire(long timeout, TimeUnit unit)
        throws InterruptedException {
    return sync.tryAcquireSharedNanos(1, unit.toNanos(timeout));
}

/**
 * å°è¯•è·å–å¤šä¸ªè®¸å¯
 */
public boolean tryAcquire(int permits) {
    if (permits < 0) throw new IllegalArgumentException();
    return sync.nonfairTryAcquireShared(permits) >= 0;
}

// ä½¿ç”¨ç¤ºä¾‹
if (semaphore.tryAcquire()) {
    try {
        // è·å–æˆåŠŸï¼Œä½¿ç”¨èµ„æº
    } finally {
        semaphore.release();
    }
} else {
    // è·å–å¤±è´¥ï¼Œæ‰§è¡Œå…¶ä»–é€»è¾‘
}
```

---

## releaseæ–¹æ³•

### release() - é‡Šæ”¾ä¸€ä¸ªè®¸å¯

```java
/**
 * é‡Šæ”¾ä¸€ä¸ªè®¸å¯
 */
public void release() {
    sync.releaseShared(1);
}

// AQS.releaseShared
public final boolean releaseShared(int arg) {
    if (tryReleaseShared(arg)) {
        doReleaseShared();  // å”¤é†’ç­‰å¾…çš„çº¿ç¨‹
        return true;
    }
    return false;
}

// Sync.tryReleaseShared
protected final boolean tryReleaseShared(int releases) {
    for (;;) {
        int current = getState();
        int next = current + releases;
        if (next < current) // overflow
            throw new Error("Maximum permit count exceeded");
        if (compareAndSetState(current, next))
            return true;
    }
}
```

### release(int permits) - é‡Šæ”¾å¤šä¸ªè®¸å¯

```java
/**
 * é‡Šæ”¾æŒ‡å®šæ•°é‡çš„è®¸å¯
 */
public void release(int permits) {
    if (permits < 0) throw new IllegalArgumentException();
    sync.releaseShared(permits);
}

// ä½¿ç”¨ç¤ºä¾‹
semaphore.acquire(3);
try {
    // ä½¿ç”¨èµ„æº
} finally {
    semaphore.release(3);
}
```

### æ³¨æ„ï¼šreleaseå¯ä»¥å¢åŠ è®¸å¯

```java
/**
 * releaseä¸è¦æ±‚å…ˆacquire
 * å¯ä»¥ç”¨æ¥åŠ¨æ€å¢åŠ è®¸å¯æ•°
 */
Semaphore semaphore = new Semaphore(3);
System.out.println(semaphore.availablePermits());  // 3

semaphore.release();  // æ²¡æœ‰acquireï¼Œç›´æ¥release
System.out.println(semaphore.availablePermits());  // 4

// è¿™ä¸ªç‰¹æ€§å¯ä»¥ç”¨äºåŠ¨æ€è°ƒæ•´èµ„æºæ± å¤§å°
```

---

## å…¶ä»–æ–¹æ³•

### availablePermits() - å¯ç”¨è®¸å¯æ•°

```java
public int availablePermits() {
    return sync.getPermits();
}
```

### drainPermits() - è·å–æ‰€æœ‰è®¸å¯

```java
/**
 * è·å–å¹¶è¿”å›æ‰€æœ‰å¯ç”¨è®¸å¯
 * å¸¸ç”¨äºå…³é—­èµ„æºæ± 
 */
public int drainPermits() {
    return sync.drainPermits();
}

final int drainPermits() {
    for (;;) {
        int current = getState();
        if (current == 0 || compareAndSetState(current, 0))
            return current;
    }
}

// ä½¿ç”¨ç¤ºä¾‹ï¼šå…³é—­èµ„æºæ± 
int drained = semaphore.drainPermits();
System.out.println("è·å–äº† " + drained + " ä¸ªè®¸å¯");
```

### reducePermits() - å‡å°‘è®¸å¯

```java
/**
 * å‡å°‘å¯ç”¨è®¸å¯æ•°ï¼ˆprotectedæ–¹æ³•ï¼‰
 * ç”¨äºå­ç±»å®ç°åŠ¨æ€è°ƒæ•´
 */
protected void reducePermits(int reduction) {
    if (reduction < 0) throw new IllegalArgumentException();
    sync.reducePermits(reduction);
}
```

### getQueueLength() - ç­‰å¾…é˜Ÿåˆ—é•¿åº¦

```java
public final int getQueueLength() {
    return sync.getQueueLength();
}

// ä½¿ç”¨ç¤ºä¾‹ï¼šç›‘æ§
System.out.println("ç­‰å¾…è·å–è®¸å¯çš„çº¿ç¨‹æ•°: " + semaphore.getQueueLength());
```

---

## ä½¿ç”¨åœºæ™¯

### åœºæ™¯1ï¼šé™æµï¼ˆé™åˆ¶å¹¶å‘æ•°ï¼‰

```java
/**
 * é™åˆ¶åŒæ—¶è®¿é—®æ•°æ®åº“çš„è¿æ¥æ•°
 */
public class DatabaseConnectionPool {
    private final Semaphore semaphore;
    private final List<Connection> connections;
    
    public DatabaseConnectionPool(int poolSize) {
        this.semaphore = new Semaphore(poolSize);
        this.connections = new ArrayList<>(poolSize);
        // åˆå§‹åŒ–è¿æ¥æ± 
        for (int i = 0; i < poolSize; i++) {
            connections.add(createConnection());
        }
    }
    
    public Connection getConnection() throws InterruptedException {
        semaphore.acquire();  // è·å–è®¸å¯
        return getConnectionFromPool();
    }
    
    public void releaseConnection(Connection conn) {
        returnConnectionToPool(conn);
        semaphore.release();  // é‡Šæ”¾è®¸å¯
    }
    
    private Connection getConnectionFromPool() {
        synchronized (connections) {
            return connections.remove(0);
        }
    }
    
    private void returnConnectionToPool(Connection conn) {
        synchronized (connections) {
            connections.add(conn);
        }
    }
}
```

### åœºæ™¯2ï¼šèµ„æºæ± 

```java
/**
 * é€šç”¨èµ„æºæ± 
 */
public class ResourcePool<T> {
    private final Semaphore semaphore;
    private final BlockingQueue<T> resources;
    
    public ResourcePool(List<T> resources) {
        this.semaphore = new Semaphore(resources.size());
        this.resources = new LinkedBlockingQueue<>(resources);
    }
    
    public T acquire() throws InterruptedException {
        semaphore.acquire();
        return resources.poll();
    }
    
    public void release(T resource) {
        resources.offer(resource);
        semaphore.release();
    }
    
    public int availableResources() {
        return semaphore.availablePermits();
    }
}

// ä½¿ç”¨ç¤ºä¾‹
List<String> items = Arrays.asList("èµ„æº1", "èµ„æº2", "èµ„æº3");
ResourcePool<String> pool = new ResourcePool<>(items);

String resource = pool.acquire();
try {
    // ä½¿ç”¨èµ„æº
} finally {
    pool.release(resource);
}
```

### åœºæ™¯3ï¼šé™åˆ¶APIè°ƒç”¨é¢‘ç‡

```java
/**
 * é™åˆ¶APIè°ƒç”¨é¢‘ç‡
 */
public class RateLimiter {
    private final Semaphore semaphore;
    private final int maxPermits;
    private final ScheduledExecutorService scheduler;
    
    public RateLimiter(int permitsPerSecond) {
        this.maxPermits = permitsPerSecond;
        this.semaphore = new Semaphore(permitsPerSecond);
        this.scheduler = Executors.newScheduledThreadPool(1);
        
        // æ¯ç§’é‡ç½®è®¸å¯
        scheduler.scheduleAtFixedRate(() -> {
            int permitsToAdd = maxPermits - semaphore.availablePermits();
            if (permitsToAdd > 0) {
                semaphore.release(permitsToAdd);
            }
        }, 1, 1, TimeUnit.SECONDS);
    }
    
    public boolean tryAcquire() {
        return semaphore.tryAcquire();
    }
    
    public void acquire() throws InterruptedException {
        semaphore.acquire();
    }
    
    public void shutdown() {
        scheduler.shutdown();
    }
}

// ä½¿ç”¨ç¤ºä¾‹
RateLimiter limiter = new RateLimiter(10);  // æ¯ç§’10æ¬¡

for (int i = 0; i < 100; i++) {
    if (limiter.tryAcquire()) {
        // æ‰§è¡ŒAPIè°ƒç”¨
        System.out.println("APIè°ƒç”¨ " + i);
    } else {
        System.out.println("é™æµï¼Œè·³è¿‡ " + i);
    }
}
```

### åœºæ™¯4ï¼šç”Ÿäº§è€…æ¶ˆè´¹è€…ï¼ˆæœ‰ç•Œç¼“å†²åŒºï¼‰

```java
/**
 * ä½¿ç”¨Semaphoreå®ç°æœ‰ç•Œç¼“å†²åŒº
 */
public class BoundedBuffer<T> {
    private final Semaphore availableItems;  // å¯æ¶ˆè´¹çš„æ•°é‡
    private final Semaphore availableSpaces; // å¯ç”Ÿäº§çš„ç©ºé—´
    private final Queue<T> buffer;
    
    public BoundedBuffer(int capacity) {
        this.availableItems = new Semaphore(0);
        this.availableSpaces = new Semaphore(capacity);
        this.buffer = new LinkedList<>();
    }
    
    public void put(T item) throws InterruptedException {
        availableSpaces.acquire();  // ç­‰å¾…ç©ºé—´
        synchronized (buffer) {
            buffer.offer(item);
        }
        availableItems.release();  // å¢åŠ å¯æ¶ˆè´¹æ•°é‡
    }
    
    public T take() throws InterruptedException {
        availableItems.acquire();  // ç­‰å¾…æ•°æ®
        T item;
        synchronized (buffer) {
            item = buffer.poll();
        }
        availableSpaces.release();  // å¢åŠ å¯ç”¨ç©ºé—´
        return item;
    }
}
```

---

## é¢è¯•è¦ç‚¹

### 1. SemaphoreåŸç†

```
Q: Semaphoreçš„å®ç°åŸç†ï¼Ÿ

A:
åŸºäºAQSå…±äº«æ¨¡å¼å®ç°ï¼š

1. stateè¡¨ç¤ºå¯ç”¨è®¸å¯æ•°
2. acquire()ï¼š
   - CASå°†stateå‡1
   - state<0æ—¶è¿›å…¥ç­‰å¾…é˜Ÿåˆ—
3. release()ï¼š
   - CASå°†stateåŠ 1
   - å”¤é†’ç­‰å¾…é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹
4. æ”¯æŒå…¬å¹³å’Œéå…¬å¹³æ¨¡å¼
```

### 2. Semaphore vs synchronized

```
Q: Semaphoreå’Œsynchronizedçš„åŒºåˆ«ï¼Ÿ

A:
| å¯¹æ¯”é¡¹ | Semaphore | synchronized |
|--------|-----------|--------------|
| è®¸å¯æ•° | å¯ä»¥å¤šä¸ª | åªæœ‰1ä¸ª |
| å…¬å¹³æ€§ | å¯é€‰ | éå…¬å¹³ |
| å¯ä¸­æ–­ | æ”¯æŒ | ä¸æ”¯æŒ |
| è¶…æ—¶ | æ”¯æŒ | ä¸æ”¯æŒ |
| æ¡ä»¶å˜é‡ | ä¸æ”¯æŒ | æ”¯æŒwait/notify |

Semaphore(1)å¯ä»¥å®ç°äº’æ–¥é”çš„æ•ˆæœï¼Œä½†åŠŸèƒ½æ›´ä¸°å¯Œ
```

### 3. å…¬å¹³vséå…¬å¹³

```
Q: Semaphoreçš„å…¬å¹³æ¨¡å¼å’Œéå…¬å¹³æ¨¡å¼æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

A:
éå…¬å¹³æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰ï¼š
- æ–°çº¿ç¨‹å¯ä»¥ç›´æ¥å°è¯•è·å–è®¸å¯
- å¯èƒ½å¯¼è‡´ç­‰å¾…çº¿ç¨‹é¥¥é¥¿
- ååé‡æ›´é«˜

å…¬å¹³æ¨¡å¼ï¼š
- æŒ‰FIFOé¡ºåºè·å–è®¸å¯
- ä¸ä¼šé¥¥é¥¿
- ååé‡è¾ƒä½

é€‰æ‹©å»ºè®®ï¼š
- å¤§å¤šæ•°åœºæ™¯ä½¿ç”¨éå…¬å¹³æ¨¡å¼
- å¯¹å…¬å¹³æ€§æœ‰è¦æ±‚æ—¶ä½¿ç”¨å…¬å¹³æ¨¡å¼
```

### 4. releaseä¸éœ€è¦acquire

```
Q: Semaphoreçš„releaseå¯ä»¥ä¸å…ˆacquireå—ï¼Ÿ

A:
å¯ä»¥ï¼è¿™æ˜¯Semaphoreçš„ç‰¹æ€§ï¼š
- releaseåªæ˜¯å¢åŠ è®¸å¯æ•°
- ä¸æ£€æŸ¥å½“å‰çº¿ç¨‹æ˜¯å¦æŒæœ‰è®¸å¯
- å¯ä»¥ç”¨äºåŠ¨æ€å¢åŠ è®¸å¯

åº”ç”¨åœºæ™¯ï¼š
- åŠ¨æ€è°ƒæ•´èµ„æºæ± å¤§å°
- åˆå§‹åŒ–æ—¶è®¾ç½®è®¸å¯æ•°

æ³¨æ„ï¼š
- å¯èƒ½å¯¼è‡´è®¸å¯æ•°è¶…è¿‡åˆå§‹å€¼
- éœ€è¦ä¸šåŠ¡é€»è¾‘ä¿è¯æ­£ç¡®æ€§
```

### 5. ä½¿ç”¨åœºæ™¯

```
Q: Semaphoreçš„å…¸å‹ä½¿ç”¨åœºæ™¯ï¼Ÿ

A:
1. é™æµï¼šé™åˆ¶åŒæ—¶è®¿é—®çš„çº¿ç¨‹æ•°
2. èµ„æºæ± ï¼šæ•°æ®åº“è¿æ¥æ± ã€çº¿ç¨‹æ± 
3. æœ‰ç•Œç¼“å†²åŒºï¼šç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼
4. é™åˆ¶APIè°ƒç”¨é¢‘ç‡

ç¤ºä¾‹ï¼šæ•°æ®åº“è¿æ¥æ± 
Semaphore semaphore = new Semaphore(10);  // æœ€å¤š10ä¸ªè¿æ¥

public Connection getConnection() {
    semaphore.acquire();
    return pool.getConnection();
}

public void releaseConnection(Connection conn) {
    pool.returnConnection(conn);
    semaphore.release();
}
```

---

## ğŸ’¡ æ€»ç»“

```
Semaphoreæ ¸å¿ƒè¦ç‚¹ï¼š

1. å®ç°åŸç†ï¼š
   - åŸºäºAQSå…±äº«æ¨¡å¼
   - stateè¡¨ç¤ºå¯ç”¨è®¸å¯æ•°
   - acquireå‡å°‘è®¸å¯ï¼Œreleaseå¢åŠ è®¸å¯

2. ç‰¹ç‚¹ï¼š
   - æ”¯æŒå¤šä¸ªè®¸å¯
   - æ”¯æŒå…¬å¹³/éå…¬å¹³æ¨¡å¼
   - å¯ä¸­æ–­ã€å¯è¶…æ—¶
   - releaseä¸éœ€è¦å…ˆacquire

3. æ ¸å¿ƒæ–¹æ³•ï¼š
   - acquire()ï¼šè·å–è®¸å¯ï¼Œé˜»å¡
   - tryAcquire()ï¼šå°è¯•è·å–ï¼Œä¸é˜»å¡
   - release()ï¼šé‡Šæ”¾è®¸å¯

4. ä½¿ç”¨åœºæ™¯ï¼š
   - é™æµ
   - èµ„æºæ± 
   - æœ‰ç•Œç¼“å†²åŒº
   - é™åˆ¶å¹¶å‘æ•°

5. æ³¨æ„äº‹é¡¹ï¼š
   - releaseè¦åœ¨finallyä¸­è°ƒç”¨
   - æ³¨æ„è®¸å¯æ•°å¯èƒ½è¶…è¿‡åˆå§‹å€¼
   - é€‰æ‹©åˆé€‚çš„å…¬å¹³æ€§æ¨¡å¼
```

---

*æœ€åæ›´æ–°ï¼š2025-12-28*
