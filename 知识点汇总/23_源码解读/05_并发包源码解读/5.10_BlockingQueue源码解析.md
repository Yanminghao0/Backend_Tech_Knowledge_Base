# BlockingQueueæºç è§£æ

> æ·±å…¥åˆ†æJDKé˜»å¡é˜Ÿåˆ—å®ç°åŸç†ï¼ŒæŒæ¡ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼æ ¸å¿ƒæœºåˆ¶

---

## ğŸ“š ç›®å½•

1. [æ•´ä½“æ¶æ„](#1-æ•´ä½“æ¶æ„)
2. [BlockingQueueæ¥å£](#2-blockingqueueæ¥å£)
3. [ArrayBlockingQueueæºç ](#3-arrayblockingqueueæºç )
4. [LinkedBlockingQueueæºç ](#4-linkedblockingqueueæºç )
5. [PriorityBlockingQueueæºç ](#5-priorityblockingqueueæºç )
6. [SynchronousQueueæºç ](#6-synchronousqueueæºç )
7. [DelayQueueæºç ](#7-delayqueueæºç )
8. [å®ç°å¯¹æ¯”](#8-å®ç°å¯¹æ¯”)
9. [æµç¨‹å›¾è§£](#9-æµç¨‹å›¾è§£)
10. [é¢è¯•è¦ç‚¹](#10-é¢è¯•è¦ç‚¹)

---

## 1. æ•´ä½“æ¶æ„

### 1.1 BlockingQueueç»§æ‰¿ä½“ç³»

```
java.util.concurrent
â”œâ”€â”€ BlockingQueue<E> (æ¥å£)
â”‚   â”œâ”€â”€ ArrayBlockingQueue      # æ•°ç»„å®ç°ï¼Œæœ‰ç•Œ
â”‚   â”œâ”€â”€ LinkedBlockingQueue     # é“¾è¡¨å®ç°ï¼Œå¯é€‰æœ‰ç•Œ
â”‚   â”œâ”€â”€ PriorityBlockingQueue   # ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼Œæ— ç•Œ
â”‚   â”œâ”€â”€ SynchronousQueue        # åŒæ­¥é˜Ÿåˆ—ï¼Œæ— å®¹é‡
â”‚   â”œâ”€â”€ DelayQueue              # å»¶è¿Ÿé˜Ÿåˆ—
â”‚   â””â”€â”€ LinkedTransferQueue     # é“¾è¡¨ä¼ è¾“é˜Ÿåˆ—
â””â”€â”€ BlockingDeque<E> (æ¥å£)
    â””â”€â”€ LinkedBlockingDeque     # åŒç«¯é˜»å¡é˜Ÿåˆ—
```

### 1.2 æ ¸å¿ƒè®¾è®¡æ€æƒ³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 BlockingQueue æ ¸å¿ƒç‰¹æ€§                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. é˜»å¡æ“ä½œï¼š
   - put(): é˜Ÿåˆ—æ»¡æ—¶é˜»å¡
   - take(): é˜Ÿåˆ—ç©ºæ—¶é˜»å¡

2. çº¿ç¨‹å®‰å…¨ï¼š
   - å†…éƒ¨ä½¿ç”¨é”æˆ–CASä¿è¯çº¿ç¨‹å®‰å…¨

3. ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼ï¼š
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Producer â”‚ â”€â”€â†’ â”‚BlockingQueue â”‚ â”€â”€â†’ â”‚ Consumer â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                  â”‚                  â”‚
        â”‚    put()         â”‚      take()      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


---

## 2. BlockingQueueæ¥å£

### 2.1 æ¥å£å®šä¹‰

```java
public interface BlockingQueue<E> extends Queue<E> {
    
    // ========== æ·»åŠ å…ƒç´  ==========
    
    /**
     * æ·»åŠ å…ƒç´ ï¼Œé˜Ÿåˆ—æ»¡æ—¶æŠ›å‡ºå¼‚å¸¸
     */
    boolean add(E e);
    
    /**
     * æ·»åŠ å…ƒç´ ï¼Œé˜Ÿåˆ—æ»¡æ—¶è¿”å›false
     */
    boolean offer(E e);
    
    /**
     * æ·»åŠ å…ƒç´ ï¼Œé˜Ÿåˆ—æ»¡æ—¶é˜»å¡ç­‰å¾…
     */
    void put(E e) throws InterruptedException;
    
    /**
     * æ·»åŠ å…ƒç´ ï¼Œé˜Ÿåˆ—æ»¡æ—¶ç­‰å¾…æŒ‡å®šæ—¶é—´
     */
    boolean offer(E e, long timeout, TimeUnit unit) throws InterruptedException;
    
    // ========== ç§»é™¤å…ƒç´  ==========
    
    /**
     * ç§»é™¤å¹¶è¿”å›å¤´å…ƒç´ ï¼Œé˜Ÿåˆ—ç©ºæ—¶æŠ›å‡ºå¼‚å¸¸
     */
    E remove();
    
    /**
     * ç§»é™¤å¹¶è¿”å›å¤´å…ƒç´ ï¼Œé˜Ÿåˆ—ç©ºæ—¶è¿”å›null
     */
    E poll();
    
    /**
     * ç§»é™¤å¹¶è¿”å›å¤´å…ƒç´ ï¼Œé˜Ÿåˆ—ç©ºæ—¶é˜»å¡ç­‰å¾…
     */
    E take() throws InterruptedException;
    
    /**
     * ç§»é™¤å¹¶è¿”å›å¤´å…ƒç´ ï¼Œé˜Ÿåˆ—ç©ºæ—¶ç­‰å¾…æŒ‡å®šæ—¶é—´
     */
    E poll(long timeout, TimeUnit unit) throws InterruptedException;
    
    // ========== æ£€æŸ¥å…ƒç´  ==========
    
    /**
     * è¿”å›å¤´å…ƒç´ ä½†ä¸ç§»é™¤ï¼Œé˜Ÿåˆ—ç©ºæ—¶æŠ›å‡ºå¼‚å¸¸
     */
    E element();
    
    /**
     * è¿”å›å¤´å…ƒç´ ä½†ä¸ç§»é™¤ï¼Œé˜Ÿåˆ—ç©ºæ—¶è¿”å›null
     */
    E peek();
    
    // ========== å…¶ä»–æ–¹æ³• ==========
    
    /**
     * è¿”å›å‰©ä½™å®¹é‡
     */
    int remainingCapacity();
    
    /**
     * æ‰¹é‡è½¬ç§»åˆ°é›†åˆ
     */
    int drainTo(Collection<? super E> c);
    int drainTo(Collection<? super E> c, int maxElements);
}
```

### 2.2 æ“ä½œæ–¹æ³•å¯¹æ¯”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              BlockingQueue æ“ä½œæ–¹æ³•å¯¹æ¯”                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    æ“ä½œ      â”‚ æŠ›å‡ºå¼‚å¸¸ â”‚ è¿”å›ç‰¹æ®Šå€¼â”‚ é˜»å¡ç­‰å¾… â”‚ è¶…æ—¶ç­‰å¾…   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    æ’å…¥      â”‚  add(e)  â”‚ offer(e) â”‚  put(e)  â”‚offer(e,t,u)â”‚
â”‚    ç§»é™¤      â”‚ remove() â”‚  poll()  â”‚  take()  â”‚poll(t,u)   â”‚
â”‚    æ£€æŸ¥      â”‚ element()â”‚  peek()  â”‚    -     â”‚    -       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è¯´æ˜ï¼š
- æŠ›å‡ºå¼‚å¸¸ï¼šæ“ä½œå¤±è´¥æ—¶æŠ›å‡ºå¼‚å¸¸
- è¿”å›ç‰¹æ®Šå€¼ï¼šæ“ä½œå¤±è´¥æ—¶è¿”å›nullæˆ–false
- é˜»å¡ç­‰å¾…ï¼šæ“ä½œå¤±è´¥æ—¶ä¸€ç›´é˜»å¡
- è¶…æ—¶ç­‰å¾…ï¼šæ“ä½œå¤±è´¥æ—¶é˜»å¡æŒ‡å®šæ—¶é—´
```

---

## 3. ArrayBlockingQueueæºç 

### 3.1 æ ¸å¿ƒå±æ€§

```java
public class ArrayBlockingQueue<E> extends AbstractQueue<E>
        implements BlockingQueue<E>, java.io.Serializable {
    
    /** å­˜å‚¨å…ƒç´ çš„æ•°ç»„ */
    final Object[] items;
    
    /** ä¸‹ä¸€ä¸ªtake/poll/peek/removeçš„ç´¢å¼• */
    int takeIndex;
    
    /** ä¸‹ä¸€ä¸ªput/offer/addçš„ç´¢å¼• */
    int putIndex;
    
    /** é˜Ÿåˆ—ä¸­å…ƒç´ æ•°é‡ */
    int count;
    
    /** ä¸»é”ï¼Œä¿æŠ¤æ‰€æœ‰è®¿é—® */
    final ReentrantLock lock;
    
    /** ç­‰å¾…takeçš„æ¡ä»¶ */
    private final Condition notEmpty;
    
    /** ç­‰å¾…putçš„æ¡ä»¶ */
    private final Condition notFull;
}
```

### 3.2 æ„é€ æ–¹æ³•

```java
/**
 * åˆ›å»ºæŒ‡å®šå®¹é‡çš„é˜Ÿåˆ—
 */
public ArrayBlockingQueue(int capacity) {
    this(capacity, false);  // é»˜è®¤éå…¬å¹³
}

/**
 * åˆ›å»ºæŒ‡å®šå®¹é‡å’Œå…¬å¹³æ€§çš„é˜Ÿåˆ—
 */
public ArrayBlockingQueue(int capacity, boolean fair) {
    if (capacity <= 0)
        throw new IllegalArgumentException();
    this.items = new Object[capacity];
    lock = new ReentrantLock(fair);  // å…¬å¹³/éå…¬å¹³é”
    notEmpty = lock.newCondition();   // éç©ºæ¡ä»¶
    notFull = lock.newCondition();    // éæ»¡æ¡ä»¶
}
```

### 3.3 putæ–¹æ³• - é˜»å¡æ’å…¥

```java
/**
 * æ’å…¥å…ƒç´ ï¼Œé˜Ÿåˆ—æ»¡æ—¶é˜»å¡
 */
public void put(E e) throws InterruptedException {
    checkNotNull(e);  // ä¸å…è®¸null
    final ReentrantLock lock = this.lock;
    lock.lockInterruptibly();  // å¯ä¸­æ–­è·å–é”
    try {
        // é˜Ÿåˆ—æ»¡æ—¶ï¼Œç­‰å¾…notFullæ¡ä»¶
        while (count == items.length)
            notFull.await();
        // å…¥é˜Ÿ
        enqueue(e);
    } finally {
        lock.unlock();
    }
}

/**
 * å…¥é˜Ÿæ“ä½œ
 */
private void enqueue(E x) {
    final Object[] items = this.items;
    items[putIndex] = x;
    // å¾ªç¯æ•°ç»„ï¼šåˆ°è¾¾æœ«å°¾æ—¶å›åˆ°å¼€å¤´
    if (++putIndex == items.length)
        putIndex = 0;
    count++;
    // é€šçŸ¥ç­‰å¾…takeçš„çº¿ç¨‹
    notEmpty.signal();
}
```

### 3.4 takeæ–¹æ³• - é˜»å¡è·å–

```java
/**
 * è·å–å¹¶ç§»é™¤å¤´å…ƒç´ ï¼Œé˜Ÿåˆ—ç©ºæ—¶é˜»å¡
 */
public E take() throws InterruptedException {
    final ReentrantLock lock = this.lock;
    lock.lockInterruptibly();
    try {
        // é˜Ÿåˆ—ç©ºæ—¶ï¼Œç­‰å¾…notEmptyæ¡ä»¶
        while (count == 0)
            notEmpty.await();
        // å‡ºé˜Ÿ
        return dequeue();
    } finally {
        lock.unlock();
    }
}

/**
 * å‡ºé˜Ÿæ“ä½œ
 */
private E dequeue() {
    final Object[] items = this.items;
    @SuppressWarnings("unchecked")
    E x = (E) items[takeIndex];
    items[takeIndex] = null;  // å¸®åŠ©GC
    // å¾ªç¯æ•°ç»„
    if (++takeIndex == items.length)
        takeIndex = 0;
    count--;
    // é€šçŸ¥ç­‰å¾…putçš„çº¿ç¨‹
    notFull.signal();
    return x;
}
```

### 3.5 offeræ–¹æ³• - éé˜»å¡/è¶…æ—¶æ’å…¥

```java
/**
 * éé˜»å¡æ’å…¥ï¼Œé˜Ÿåˆ—æ»¡æ—¶è¿”å›false
 */
public boolean offer(E e) {
    checkNotNull(e);
    final ReentrantLock lock = this.lock;
    lock.lock();
    try {
        if (count == items.length)
            return false;  // é˜Ÿåˆ—æ»¡ï¼Œç›´æ¥è¿”å›
        else {
            enqueue(e);
            return true;
        }
    } finally {
        lock.unlock();
    }
}

/**
 * è¶…æ—¶æ’å…¥
 */
public boolean offer(E e, long timeout, TimeUnit unit)
        throws InterruptedException {
    checkNotNull(e);
    long nanos = unit.toNanos(timeout);
    final ReentrantLock lock = this.lock;
    lock.lockInterruptibly();
    try {
        while (count == items.length) {
            if (nanos <= 0)
                return false;  // è¶…æ—¶è¿”å›
            // ç­‰å¾…æŒ‡å®šæ—¶é—´
            nanos = notFull.awaitNanos(nanos);
        }
        enqueue(e);
        return true;
    } finally {
        lock.unlock();
    }
}
```

### 3.6 å¾ªç¯æ•°ç»„å›¾è§£

```
ArrayBlockingQueue å¾ªç¯æ•°ç»„ç»“æ„ï¼š

åˆå§‹çŠ¶æ€ï¼ˆå®¹é‡5ï¼‰ï¼š
â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”
â”‚   â”‚   â”‚   â”‚   â”‚   â”‚
â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”˜
  â†‘
takeIndex = 0
putIndex = 0
count = 0

æ·»åŠ 3ä¸ªå…ƒç´ åï¼š
â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”
â”‚ A â”‚ B â”‚ C â”‚   â”‚   â”‚
â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”˜
  â†‘           â†‘
takeIndex=0  putIndex=3
count = 3

å–å‡º1ä¸ªå…ƒç´ åï¼š
â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”
â”‚   â”‚ B â”‚ C â”‚   â”‚   â”‚
â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”˜
      â†‘       â†‘
  takeIndex=1 putIndex=3
count = 2

ç»§ç»­æ·»åŠ 3ä¸ªå…ƒç´ ï¼ˆå¾ªç¯ï¼‰ï¼š
â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”
â”‚ F â”‚ B â”‚ C â”‚ D â”‚ E â”‚
â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”˜
  â†‘   â†‘
putIndex=1 takeIndex=1
count = 5 (æ»¡)
```


---

## 4. LinkedBlockingQueueæºç 

### 4.1 æ ¸å¿ƒå±æ€§

```java
public class LinkedBlockingQueue<E> extends AbstractQueue<E>
        implements BlockingQueue<E>, java.io.Serializable {
    
    /**
     * é“¾è¡¨èŠ‚ç‚¹
     */
    static class Node<E> {
        E item;
        Node<E> next;
        Node(E x) { item = x; }
    }
    
    /** å®¹é‡ï¼Œé»˜è®¤Integer.MAX_VALUE */
    private final int capacity;
    
    /** å½“å‰å…ƒç´ æ•°é‡ï¼ˆåŸå­å˜é‡ï¼‰ */
    private final AtomicInteger count = new AtomicInteger();
    
    /** å¤´èŠ‚ç‚¹ï¼ˆå“¨å…µèŠ‚ç‚¹ï¼Œitemä¸ºnullï¼‰ */
    transient Node<E> head;
    
    /** å°¾èŠ‚ç‚¹ */
    private transient Node<E> last;
    
    /** takeé” */
    private final ReentrantLock takeLock = new ReentrantLock();
    
    /** ç­‰å¾…takeçš„æ¡ä»¶ */
    private final Condition notEmpty = takeLock.newCondition();
    
    /** puté” */
    private final ReentrantLock putLock = new ReentrantLock();
    
    /** ç­‰å¾…putçš„æ¡ä»¶ */
    private final Condition notFull = putLock.newCondition();
}
```

### 4.2 åŒé”è®¾è®¡

```
LinkedBlockingQueue åŒé”è®¾è®¡ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åŒé”åˆ†ç¦»è®¾è®¡                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚     LinkedBlockingQueue     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                               â”‚
              â–¼                               â–¼
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚   takeLock   â”‚               â”‚   putLock    â”‚
       â”‚   (å–é”)     â”‚               â”‚   (æ”¾é”)     â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                               â”‚
              â–¼                               â–¼
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚    head      â”‚ â”€â”€â†’ ... â”€â”€â†’  â”‚    last      â”‚
       â”‚   (å¤´èŠ‚ç‚¹)   â”‚               â”‚   (å°¾èŠ‚ç‚¹)   â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¼˜åŠ¿ï¼š
- takeå’Œputå¯ä»¥å¹¶å‘æ‰§è¡Œ
- æé«˜ååé‡

æ³¨æ„ï¼š
- countä½¿ç”¨AtomicIntegerä¿è¯å¯è§æ€§
- éœ€è¦åŒæ—¶è·å–ä¸¤æŠŠé”æ—¶ï¼Œå…ˆè·å–putLockå†è·å–takeLock
```

### 4.3 putæ–¹æ³•

```java
/**
 * æ’å…¥å…ƒç´ ï¼Œé˜Ÿåˆ—æ»¡æ—¶é˜»å¡
 */
public void put(E e) throws InterruptedException {
    if (e == null) throw new NullPointerException();
    int c = -1;
    Node<E> node = new Node<E>(e);
    final ReentrantLock putLock = this.putLock;
    final AtomicInteger count = this.count;
    
    putLock.lockInterruptibly();  // è·å–puté”
    try {
        // é˜Ÿåˆ—æ»¡æ—¶ç­‰å¾…
        while (count.get() == capacity) {
            notFull.await();
        }
        // å…¥é˜Ÿ
        enqueue(node);
        c = count.getAndIncrement();  // åŸå­å¢åŠ 
        // å¦‚æœè¿˜æœ‰ç©ºé—´ï¼Œå”¤é†’å…¶ä»–putçº¿ç¨‹
        if (c + 1 < capacity)
            notFull.signal();
    } finally {
        putLock.unlock();
    }
    // å¦‚æœä¹‹å‰é˜Ÿåˆ—ä¸ºç©ºï¼Œå”¤é†’takeçº¿ç¨‹
    if (c == 0)
        signalNotEmpty();
}

/**
 * å…¥é˜Ÿï¼šæ·»åŠ åˆ°å°¾éƒ¨
 */
private void enqueue(Node<E> node) {
    last = last.next = node;
}

/**
 * å”¤é†’ç­‰å¾…takeçš„çº¿ç¨‹
 */
private void signalNotEmpty() {
    final ReentrantLock takeLock = this.takeLock;
    takeLock.lock();
    try {
        notEmpty.signal();
    } finally {
        takeLock.unlock();
    }
}
```

### 4.4 takeæ–¹æ³•

```java
/**
 * è·å–å¹¶ç§»é™¤å¤´å…ƒç´ ï¼Œé˜Ÿåˆ—ç©ºæ—¶é˜»å¡
 */
public E take() throws InterruptedException {
    E x;
    int c = -1;
    final AtomicInteger count = this.count;
    final ReentrantLock takeLock = this.takeLock;
    
    takeLock.lockInterruptibly();  // è·å–takeé”
    try {
        // é˜Ÿåˆ—ç©ºæ—¶ç­‰å¾…
        while (count.get() == 0) {
            notEmpty.await();
        }
        // å‡ºé˜Ÿ
        x = dequeue();
        c = count.getAndDecrement();  // åŸå­å‡å°‘
        // å¦‚æœè¿˜æœ‰å…ƒç´ ï¼Œå”¤é†’å…¶ä»–takeçº¿ç¨‹
        if (c > 1)
            notEmpty.signal();
    } finally {
        takeLock.unlock();
    }
    // å¦‚æœä¹‹å‰é˜Ÿåˆ—æ»¡ï¼Œå”¤é†’putçº¿ç¨‹
    if (c == capacity)
        signalNotFull();
    return x;
}

/**
 * å‡ºé˜Ÿï¼šç§»é™¤å¤´èŠ‚ç‚¹
 */
private E dequeue() {
    Node<E> h = head;
    Node<E> first = h.next;
    h.next = h;  // å¸®åŠ©GC
    head = first;
    E x = first.item;
    first.item = null;  // å¤´èŠ‚ç‚¹å˜ä¸ºå“¨å…µ
    return x;
}
```

### 4.5 ArrayBlockingQueue vs LinkedBlockingQueue

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      ArrayBlockingQueue vs LinkedBlockingQueue             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    ç‰¹æ€§      â”‚ArrayBlockingQueueâ”‚ LinkedBlockingQueue      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  åº•å±‚ç»“æ„    â”‚  æ•°ç»„            â”‚  é“¾è¡¨                    â”‚
â”‚  å®¹é‡        â”‚  å¿…é¡»æŒ‡å®š        â”‚  å¯é€‰ï¼ˆé»˜è®¤MAX_VALUEï¼‰   â”‚
â”‚  é”æœºåˆ¶      â”‚  å•é”            â”‚  åŒé”ï¼ˆè¯»å†™åˆ†ç¦»ï¼‰        â”‚
â”‚  å†…å­˜å ç”¨    â”‚  é¢„åˆ†é…          â”‚  åŠ¨æ€åˆ†é…                â”‚
â”‚  GCå½±å“      â”‚  å°              â”‚  å¤§ï¼ˆé¢‘ç¹åˆ›å»ºèŠ‚ç‚¹ï¼‰      â”‚
â”‚  ååé‡      â”‚  è¾ƒä½            â”‚  è¾ƒé«˜                    â”‚
â”‚  å…¬å¹³æ€§      â”‚  å¯é…ç½®          â”‚  ä¸æ”¯æŒ                  â”‚
â”‚  é€‚ç”¨åœºæ™¯    â”‚  å®¹é‡å›ºå®š        â”‚  å®¹é‡ä¸å›ºå®š              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. PriorityBlockingQueueæºç 

### 5.1 æ ¸å¿ƒå±æ€§

```java
public class PriorityBlockingQueue<E> extends AbstractQueue<E>
        implements BlockingQueue<E>, java.io.Serializable {
    
    /** é»˜è®¤åˆå§‹å®¹é‡ */
    private static final int DEFAULT_INITIAL_CAPACITY = 11;
    
    /** æœ€å¤§å®¹é‡ */
    private static final int MAX_ARRAY_SIZE = Integer.MAX_VALUE - 8;
    
    /** å­˜å‚¨å…ƒç´ çš„æ•°ç»„ï¼ˆå †ï¼‰ */
    private transient Object[] queue;
    
    /** å…ƒç´ æ•°é‡ */
    private transient int size;
    
    /** æ¯”è¾ƒå™¨ */
    private transient Comparator<? super E> comparator;
    
    /** ä¸»é” */
    private final ReentrantLock lock;
    
    /** ç­‰å¾…takeçš„æ¡ä»¶ï¼ˆæ— ç•Œé˜Ÿåˆ—ï¼Œä¸éœ€è¦notFullï¼‰ */
    private final Condition notEmpty;
    
    /** æ‰©å®¹æ—¶ä½¿ç”¨çš„è‡ªæ—‹é” */
    private transient volatile int allocationSpinLock;
}
```

### 5.2 offeræ–¹æ³• - å †æ’å…¥

```java
/**
 * æ’å…¥å…ƒç´ ï¼ˆæ— ç•Œé˜Ÿåˆ—ï¼Œæ°¸ä¸é˜»å¡ï¼‰
 */
public boolean offer(E e) {
    if (e == null)
        throw new NullPointerException();
    final ReentrantLock lock = this.lock;
    lock.lock();
    int n, cap;
    Object[] array;
    // éœ€è¦æ‰©å®¹
    while ((n = size) >= (cap = (array = queue).length))
        tryGrow(array, cap);
    try {
        Comparator<? super E> cmp = comparator;
        // ä¸Šæµ®æ“ä½œ
        if (cmp == null)
            siftUpComparable(n, e, array);
        else
            siftUpUsingComparator(n, e, array, cmp);
        size = n + 1;
        notEmpty.signal();  // å”¤é†’takeçº¿ç¨‹
    } finally {
        lock.unlock();
    }
    return true;
}

/**
 * ä¸Šæµ®æ“ä½œï¼ˆå°é¡¶å †ï¼‰
 */
private static <T> void siftUpComparable(int k, T x, Object[] array) {
    Comparable<? super T> key = (Comparable<? super T>) x;
    while (k > 0) {
        int parent = (k - 1) >>> 1;  // çˆ¶èŠ‚ç‚¹ç´¢å¼•
        Object e = array[parent];
        if (key.compareTo((T) e) >= 0)
            break;  // å·²æ»¡è¶³å †æ€§è´¨
        array[k] = e;  // çˆ¶èŠ‚ç‚¹ä¸‹ç§»
        k = parent;
    }
    array[k] = key;
}
```

### 5.3 takeæ–¹æ³• - å †åˆ é™¤

```java
/**
 * è·å–å¹¶ç§»é™¤æœ€å°å…ƒç´ 
 */
public E take() throws InterruptedException {
    final ReentrantLock lock = this.lock;
    lock.lockInterruptibly();
    E result;
    try {
        while ((result = dequeue()) == null)
            notEmpty.await();
    } finally {
        lock.unlock();
    }
    return result;
}

/**
 * å‡ºé˜Ÿæ“ä½œ
 */
private E dequeue() {
    int n = size - 1;
    if (n < 0)
        return null;
    else {
        Object[] array = queue;
        E result = (E) array[0];  // å †é¡¶å…ƒç´ 
        E x = (E) array[n];       // æœ€åä¸€ä¸ªå…ƒç´ 
        array[n] = null;
        Comparator<? super E> cmp = comparator;
        // ä¸‹æ²‰æ“ä½œ
        if (cmp == null)
            siftDownComparable(0, x, array, n);
        else
            siftDownUsingComparator(0, x, array, n, cmp);
        size = n;
        return result;
    }
}

/**
 * ä¸‹æ²‰æ“ä½œ
 */
private static <T> void siftDownComparable(int k, T x, Object[] array, int n) {
    if (n > 0) {
        Comparable<? super T> key = (Comparable<? super T>)x;
        int half = n >>> 1;
        while (k < half) {
            int child = (k << 1) + 1;  // å·¦å­èŠ‚ç‚¹
            Object c = array[child];
            int right = child + 1;
            // é€‰æ‹©è¾ƒå°çš„å­èŠ‚ç‚¹
            if (right < n && ((Comparable<? super T>) c).compareTo((T) array[right]) > 0)
                c = array[child = right];
            if (key.compareTo((T) c) <= 0)
                break;
            array[k] = c;
            k = child;
        }
        array[k] = key;
    }
}
```


---

## 6. SynchronousQueueæºç 

### 6.1 æ ¸å¿ƒç‰¹æ€§

```java
/**
 * SynchronousQueueï¼šåŒæ­¥é˜Ÿåˆ—
 * 
 * ç‰¹ç‚¹ï¼š
 * 1. æ²¡æœ‰å®¹é‡ï¼Œä¸å­˜å‚¨å…ƒç´ 
 * 2. æ¯ä¸ªputå¿…é¡»ç­‰å¾…ä¸€ä¸ªtake
 * 3. é€‚åˆä¼ é€’æ€§åœºæ™¯
 */
public class SynchronousQueue<E> extends AbstractQueue<E>
        implements BlockingQueue<E>, java.io.Serializable {
    
    /**
     * ä¼ è¾“å™¨ï¼šæ ¸å¿ƒæ•°æ®ç»“æ„
     * - TransferStackï¼šéå…¬å¹³æ¨¡å¼ï¼ˆLIFOï¼‰
     * - TransferQueueï¼šå…¬å¹³æ¨¡å¼ï¼ˆFIFOï¼‰
     */
    private transient volatile Transferer<E> transferer;
    
    public SynchronousQueue() {
        this(false);  // é»˜è®¤éå…¬å¹³
    }
    
    public SynchronousQueue(boolean fair) {
        transferer = fair ? new TransferQueue<E>() : new TransferStack<E>();
    }
}
```

### 6.2 TransferStackï¼ˆéå…¬å¹³æ¨¡å¼ï¼‰

```java
/**
 * éå…¬å¹³æ¨¡å¼ï¼šä½¿ç”¨æ ˆç»“æ„ï¼ˆLIFOï¼‰
 */
static final class TransferStack<E> extends Transferer<E> {
    
    // èŠ‚ç‚¹æ¨¡å¼
    static final int REQUEST    = 0;  // æ¶ˆè´¹è€…è¯·æ±‚
    static final int DATA       = 1;  // ç”Ÿäº§è€…æ•°æ®
    static final int FULFILLING = 2;  // æ­£åœ¨åŒ¹é…
    
    static final class SNode {
        volatile SNode next;      // ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
        volatile SNode match;     // åŒ¹é…çš„èŠ‚ç‚¹
        volatile Thread waiter;   // ç­‰å¾…çš„çº¿ç¨‹
        Object item;              // æ•°æ®
        int mode;                 // æ¨¡å¼
    }
    
    volatile SNode head;  // æ ˆé¡¶
    
    /**
     * æ ¸å¿ƒä¼ è¾“æ–¹æ³•
     */
    @SuppressWarnings("unchecked")
    E transfer(E e, boolean timed, long nanos) {
        SNode s = null;
        int mode = (e == null) ? REQUEST : DATA;
        
        for (;;) {
            SNode h = head;
            // 1. æ ˆä¸ºç©ºæˆ–æ¨¡å¼ç›¸åŒï¼ˆéƒ½æ˜¯ç”Ÿäº§è€…æˆ–éƒ½æ˜¯æ¶ˆè´¹è€…ï¼‰
            if (h == null || h.mode == mode) {
                if (timed && nanos <= 0) {
                    // è¶…æ—¶ï¼Œæ¸…ç†å–æ¶ˆçš„èŠ‚ç‚¹
                    if (h != null && h.isCancelled())
                        casHead(h, h.next);
                    else
                        return null;
                }
                // å…¥æ ˆç­‰å¾…
                else if (casHead(h, s = snode(s, e, h, mode))) {
                    SNode m = awaitFulfill(s, timed, nanos);
                    if (m == s) {
                        clean(s);
                        return null;
                    }
                    // åŒ¹é…æˆåŠŸ
                    if ((h = head) != null && h.next == s)
                        casHead(h, s.next);
                    return (E) ((mode == REQUEST) ? m.item : s.item);
                }
            }
            // 2. æ¨¡å¼ä¸åŒï¼Œå¯ä»¥åŒ¹é…
            else if (!isFulfilling(h.mode)) {
                if (h.isCancelled())
                    casHead(h, h.next);
                // æ ‡è®°ä¸ºæ­£åœ¨åŒ¹é…
                else if (casHead(h, s = snode(s, e, h, FULFILLING|mode))) {
                    for (;;) {
                        SNode m = s.next;
                        if (m == null) {
                            casHead(s, null);
                            s = null;
                            break;
                        }
                        SNode mn = m.next;
                        if (m.tryMatch(s)) {
                            casHead(s, mn);
                            return (E) ((mode == REQUEST) ? m.item : s.item);
                        } else
                            s.casNext(m, mn);
                    }
                }
            }
            // 3. æœ‰å…¶ä»–çº¿ç¨‹æ­£åœ¨åŒ¹é…ï¼Œå¸®åŠ©å®Œæˆ
            else {
                SNode m = h.next;
                if (m == null)
                    casHead(h, null);
                else {
                    SNode mn = m.next;
                    if (m.tryMatch(h))
                        casHead(h, mn);
                    else
                        h.casNext(m, mn);
                }
            }
        }
    }
}
```

### 6.3 putå’Œtakeæ–¹æ³•

```java
/**
 * æ’å…¥å…ƒç´ ï¼Œç­‰å¾…æ¶ˆè´¹è€…å–èµ°
 */
public void put(E e) throws InterruptedException {
    if (e == null) throw new NullPointerException();
    if (transferer.transfer(e, false, 0) == null) {
        Thread.interrupted();
        throw new InterruptedException();
    }
}

/**
 * è·å–å…ƒç´ ï¼Œç­‰å¾…ç”Ÿäº§è€…æ”¾å…¥
 */
public E take() throws InterruptedException {
    E e = transferer.transfer(null, false, 0);
    if (e != null)
        return e;
    Thread.interrupted();
    throw new InterruptedException();
}
```

### 6.4 SynchronousQueueå·¥ä½œæµç¨‹

```
SynchronousQueue å·¥ä½œæµç¨‹ï¼š

åœºæ™¯1ï¼šç”Ÿäº§è€…å…ˆåˆ°
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ç”Ÿäº§è€…è°ƒç”¨put(A)                                         â”‚
â”‚    - åˆ›å»ºDATAèŠ‚ç‚¹å…¥æ ˆ                                       â”‚
â”‚    - é˜»å¡ç­‰å¾…æ¶ˆè´¹è€…                                         â”‚
â”‚                                                             â”‚
â”‚ 2. æ¶ˆè´¹è€…è°ƒç”¨take()                                         â”‚
â”‚    - å‘ç°æ ˆé¡¶æ˜¯DATAèŠ‚ç‚¹                                     â”‚
â”‚    - åŒ¹é…æˆåŠŸï¼Œå”¤é†’ç”Ÿäº§è€…                                   â”‚
â”‚    - è¿”å›æ•°æ®A                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åœºæ™¯2ï¼šæ¶ˆè´¹è€…å…ˆåˆ°
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æ¶ˆè´¹è€…è°ƒç”¨take()                                         â”‚
â”‚    - åˆ›å»ºREQUESTèŠ‚ç‚¹å…¥æ ˆ                                    â”‚
â”‚    - é˜»å¡ç­‰å¾…ç”Ÿäº§è€…                                         â”‚
â”‚                                                             â”‚
â”‚ 2. ç”Ÿäº§è€…è°ƒç”¨put(A)                                         â”‚
â”‚    - å‘ç°æ ˆé¡¶æ˜¯REQUESTèŠ‚ç‚¹                                  â”‚
â”‚    - åŒ¹é…æˆåŠŸï¼Œå”¤é†’æ¶ˆè´¹è€…                                   â”‚
â”‚    - ä¼ é€’æ•°æ®A                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. DelayQueueæºç 

### 7.1 æ ¸å¿ƒå±æ€§

```java
/**
 * DelayQueueï¼šå»¶è¿Ÿé˜Ÿåˆ—
 * 
 * ç‰¹ç‚¹ï¼š
 * 1. å…ƒç´ å¿…é¡»å®ç°Delayedæ¥å£
 * 2. åªæœ‰å»¶è¿Ÿæ—¶é—´åˆ°æœŸçš„å…ƒç´ æ‰èƒ½è¢«å–å‡º
 * 3. åŸºäºPriorityQueueå®ç°
 */
public class DelayQueue<E extends Delayed> extends AbstractQueue<E>
        implements BlockingQueue<E> {
    
    /** ä¸»é” */
    private final transient ReentrantLock lock = new ReentrantLock();
    
    /** ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼ˆæŒ‰å»¶è¿Ÿæ—¶é—´æ’åºï¼‰ */
    private final PriorityQueue<E> q = new PriorityQueue<E>();
    
    /** ç­‰å¾…é˜Ÿé¦–å…ƒç´ çš„çº¿ç¨‹ï¼ˆLeader-Followeræ¨¡å¼ï¼‰ */
    private Thread leader = null;
    
    /** ç­‰å¾…æ¡ä»¶ */
    private final Condition available = lock.newCondition();
}
```

### 7.2 Delayedæ¥å£

```java
/**
 * å»¶è¿Ÿå…ƒç´ æ¥å£
 */
public interface Delayed extends Comparable<Delayed> {
    /**
     * è¿”å›å‰©ä½™å»¶è¿Ÿæ—¶é—´
     * è¿”å›0æˆ–è´Ÿæ•°è¡¨ç¤ºå·²åˆ°æœŸ
     */
    long getDelay(TimeUnit unit);
}

/**
 * å»¶è¿Ÿä»»åŠ¡ç¤ºä¾‹
 */
public class DelayedTask implements Delayed {
    private final long executeTime;  // æ‰§è¡Œæ—¶é—´
    private final String taskName;
    
    public DelayedTask(String taskName, long delayMs) {
        this.taskName = taskName;
        this.executeTime = System.currentTimeMillis() + delayMs;
    }
    
    @Override
    public long getDelay(TimeUnit unit) {
        long diff = executeTime - System.currentTimeMillis();
        return unit.convert(diff, TimeUnit.MILLISECONDS);
    }
    
    @Override
    public int compareTo(Delayed o) {
        return Long.compare(this.getDelay(TimeUnit.MILLISECONDS),
                           o.getDelay(TimeUnit.MILLISECONDS));
    }
}
```

### 7.3 takeæ–¹æ³•

```java
/**
 * è·å–å¹¶ç§»é™¤åˆ°æœŸå…ƒç´ ï¼Œæœªåˆ°æœŸæ—¶é˜»å¡
 */
public E take() throws InterruptedException {
    final ReentrantLock lock = this.lock;
    lock.lockInterruptibly();
    try {
        for (;;) {
            E first = q.peek();
            if (first == null)
                available.await();  // é˜Ÿåˆ—ç©ºï¼Œç­‰å¾…
            else {
                long delay = first.getDelay(NANOSECONDS);
                if (delay <= 0)
                    return q.poll();  // å·²åˆ°æœŸï¼Œè¿”å›
                first = null;  // é‡Šæ”¾å¼•ç”¨
                
                // Leader-Followeræ¨¡å¼
                if (leader != null)
                    available.await();  // å·²æœ‰leaderï¼Œç­‰å¾…
                else {
                    Thread thisThread = Thread.currentThread();
                    leader = thisThread;
                    try {
                        available.awaitNanos(delay);  // ç­‰å¾…åˆ°æœŸ
                    } finally {
                        if (leader == thisThread)
                            leader = null;
                    }
                }
            }
        }
    } finally {
        if (leader == null && q.peek() != null)
            available.signal();  // å”¤é†’ä¸‹ä¸€ä¸ªç­‰å¾…è€…
        lock.unlock();
    }
}
```

### 7.4 Leader-Followeræ¨¡å¼

```
Leader-Follower æ¨¡å¼ï¼š

ç›®çš„ï¼šå‡å°‘ä¸å¿…è¦çš„ç­‰å¾…å’Œå”¤é†’

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Leader-Follower æ¨¡å¼                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åœºæ™¯ï¼šå¤šä¸ªçº¿ç¨‹ç­‰å¾…å»¶è¿Ÿé˜Ÿåˆ—

ä¼ ç»Ÿæ–¹å¼ï¼ˆé—®é¢˜ï¼‰ï¼š
- æ‰€æœ‰çº¿ç¨‹éƒ½ç­‰å¾…ç›¸åŒæ—¶é—´
- åˆ°æœŸæ—¶å…¨éƒ¨å”¤é†’
- åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½è·å–å…ƒç´ 
- å…¶ä»–çº¿ç¨‹ç™½ç™½å”¤é†’

Leader-Followeræ–¹å¼ï¼š
- åªæœ‰Leaderçº¿ç¨‹ç­‰å¾…æŒ‡å®šæ—¶é—´
- å…¶ä»–çº¿ç¨‹æ— é™ç­‰å¾…
- Leaderè·å–å…ƒç´ åå”¤é†’ä¸‹ä¸€ä¸ªFolloweræˆä¸ºæ–°Leader

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Leader  â”‚ â”€â”€â†’ ç­‰å¾…delayæ—¶é—´ â”€â”€â†’ è·å–å…ƒç´  â”€â”€â†’ å”¤é†’Follower
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Follower â”‚ â”€â”€â†’ æ— é™ç­‰å¾… â”€â”€â†’ è¢«å”¤é†’æˆä¸ºLeader
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Follower â”‚ â”€â”€â†’ æ— é™ç­‰å¾…
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


---

## 8. å®ç°å¯¹æ¯”

### 8.1 å„å®ç°ç±»å¯¹æ¯”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    BlockingQueue å®ç°ç±»å¯¹æ¯”                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚      å®ç°        â”‚ æœ‰ç•Œæ€§ â”‚ æ•°æ®ç»“æ„â”‚  é”    â”‚  æ’åº      â”‚  ç‰¹ç‚¹       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ArrayBlockingQueueâ”‚ æœ‰ç•Œ   â”‚ æ•°ç»„   â”‚ å•é”   â”‚ FIFO       â”‚ å®¹é‡å›ºå®š    â”‚
â”‚LinkedBlockingQueueâ”‚å¯é€‰æœ‰ç•Œâ”‚ é“¾è¡¨   â”‚ åŒé”   â”‚ FIFO       â”‚ ååé‡é«˜    â”‚
â”‚PriorityBlocking  â”‚ æ— ç•Œ   â”‚ å †     â”‚ å•é”   â”‚ ä¼˜å…ˆçº§     â”‚ æŒ‰ä¼˜å…ˆçº§å‡ºé˜Ÿâ”‚
â”‚SynchronousQueue  â”‚ æ— å®¹é‡ â”‚ æ ˆ/é˜Ÿåˆ—â”‚ CAS    â”‚ LIFO/FIFO  â”‚ ç›´æ¥ä¼ é€’    â”‚
â”‚DelayQueue        â”‚ æ— ç•Œ   â”‚ å †     â”‚ å•é”   â”‚ å»¶è¿Ÿæ—¶é—´   â”‚ å»¶è¿Ÿå‡ºé˜Ÿ    â”‚
â”‚LinkedTransferQueueâ”‚æ— ç•Œ   â”‚ é“¾è¡¨   â”‚ CAS    â”‚ FIFO       â”‚ é¢„å æ¨¡å¼    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2 é€‰æ‹©å»ºè®®

```java
/**
 * BlockingQueue é€‰æ‹©æŒ‡å—
 */
public class BlockingQueueSelection {
    
    // 1. å›ºå®šå®¹é‡ï¼Œç®€å•åœºæ™¯
    BlockingQueue<String> array = new ArrayBlockingQueue<>(100);
    
    // 2. é«˜ååé‡ï¼Œç”Ÿäº§æ¶ˆè´¹é€Ÿç‡ä¸å‡
    BlockingQueue<String> linked = new LinkedBlockingQueue<>(1000);
    
    // 3. æŒ‰ä¼˜å…ˆçº§å¤„ç†
    BlockingQueue<Task> priority = new PriorityBlockingQueue<>();
    
    // 4. ç›´æ¥ä¼ é€’ï¼Œçº¿ç¨‹æ± åœºæ™¯
    BlockingQueue<Runnable> sync = new SynchronousQueue<>();
    
    // 5. å»¶è¿Ÿæ‰§è¡Œ
    BlockingQueue<DelayedTask> delay = new DelayQueue<>();
    
    // 6. æ— ç•Œé«˜æ€§èƒ½
    BlockingQueue<String> transfer = new LinkedTransferQueue<>();
}
```

### 8.3 çº¿ç¨‹æ± ä¸­çš„åº”ç”¨

```java
/**
 * çº¿ç¨‹æ± ä¸BlockingQueueçš„é…åˆ
 */
public class ThreadPoolWithQueue {
    
    // 1. å›ºå®šçº¿ç¨‹æ±  - LinkedBlockingQueueï¼ˆæ— ç•Œï¼‰
    ExecutorService fixed = new ThreadPoolExecutor(
        10, 10, 0L, TimeUnit.MILLISECONDS,
        new LinkedBlockingQueue<>()  // æ— ç•Œé˜Ÿåˆ—
    );
    
    // 2. ç¼“å­˜çº¿ç¨‹æ±  - SynchronousQueue
    ExecutorService cached = new ThreadPoolExecutor(
        0, Integer.MAX_VALUE, 60L, TimeUnit.SECONDS,
        new SynchronousQueue<>()  // ç›´æ¥ä¼ é€’
    );
    
    // 3. æœ‰ç•Œçº¿ç¨‹æ±  - ArrayBlockingQueue
    ExecutorService bounded = new ThreadPoolExecutor(
        5, 10, 60L, TimeUnit.SECONDS,
        new ArrayBlockingQueue<>(100),  // æœ‰ç•Œé˜Ÿåˆ—
        new ThreadPoolExecutor.CallerRunsPolicy()
    );
    
    // 4. å®šæ—¶çº¿ç¨‹æ±  - DelayedWorkQueueï¼ˆå†…éƒ¨å®ç°ï¼‰
    ScheduledExecutorService scheduled = 
        Executors.newScheduledThreadPool(5);
}
```

---

## 9. æµç¨‹å›¾è§£

### 9.1 ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Producer   â”‚                           â”‚   Consumer   â”‚
â”‚   (ç”Ÿäº§è€…)    â”‚                           â”‚   (æ¶ˆè´¹è€…)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                          â”‚
       â”‚ put()                              take()â”‚
       â–¼                                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     BlockingQueue                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚  A  â”‚  B  â”‚  C  â”‚  D  â”‚     â”‚     â”‚     â”‚     â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜          â”‚
â”‚       â†‘                   â†‘                                 â”‚
â”‚    takeIndex           putIndex                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

put()æµç¨‹ï¼š
1. è·å–é”
2. æ£€æŸ¥é˜Ÿåˆ—æ˜¯å¦æ»¡
3. æ»¡åˆ™ç­‰å¾…notFullæ¡ä»¶
4. å…¥é˜Ÿï¼Œå”¤é†’notEmpty

take()æµç¨‹ï¼š
1. è·å–é”
2. æ£€æŸ¥é˜Ÿåˆ—æ˜¯å¦ç©º
3. ç©ºåˆ™ç­‰å¾…notEmptyæ¡ä»¶
4. å‡ºé˜Ÿï¼Œå”¤é†’notFull
```

### 9.2 ArrayBlockingQueueæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ArrayBlockingQueue put/take æµç¨‹                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

put(e)æµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   è·å–lock    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     Yes    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ count==å®¹é‡?  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚notFull.await â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ No                        â”‚
       â–¼                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚   enqueue    â”‚ â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚notEmpty.signalâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é‡Šæ”¾lock     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


take()æµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   è·å–lock    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     Yes    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  count==0?   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚notEmpty.awaitâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ No                        â”‚
       â–¼                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚   dequeue    â”‚ â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚notFull.signalâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é‡Šæ”¾lock     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 10. é¢è¯•è¦ç‚¹

### 10.1 é«˜é¢‘é¢è¯•é¢˜

```
Q1: BlockingQueueæœ‰å“ªäº›å®ç°ï¼Ÿå„æœ‰ä»€ä¹ˆç‰¹ç‚¹ï¼Ÿ
A: - ArrayBlockingQueueï¼šæ•°ç»„å®ç°ï¼Œæœ‰ç•Œï¼Œå•é”
   - LinkedBlockingQueueï¼šé“¾è¡¨å®ç°ï¼Œå¯é€‰æœ‰ç•Œï¼ŒåŒé”
   - PriorityBlockingQueueï¼šå †å®ç°ï¼Œæ— ç•Œï¼ŒæŒ‰ä¼˜å…ˆçº§
   - SynchronousQueueï¼šæ— å®¹é‡ï¼Œç›´æ¥ä¼ é€’
   - DelayQueueï¼šå»¶è¿Ÿé˜Ÿåˆ—ï¼ŒæŒ‰å»¶è¿Ÿæ—¶é—´å‡ºé˜Ÿ

Q2: ArrayBlockingQueueå’ŒLinkedBlockingQueueçš„åŒºåˆ«ï¼Ÿ
A: - æ•°æ®ç»“æ„ï¼šæ•°ç»„ vs é“¾è¡¨
   - é”æœºåˆ¶ï¼šå•é” vs åŒé”
   - å®¹é‡ï¼šå¿…é¡»æŒ‡å®š vs å¯é€‰
   - å†…å­˜ï¼šé¢„åˆ†é… vs åŠ¨æ€åˆ†é…
   - ååé‡ï¼šè¾ƒä½ vs è¾ƒé«˜

Q3: putå’Œofferçš„åŒºåˆ«ï¼Ÿ
A: - putï¼šé˜Ÿåˆ—æ»¡æ—¶é˜»å¡ç­‰å¾…
   - offerï¼šé˜Ÿåˆ—æ»¡æ—¶è¿”å›false
   - offer(e,timeout,unit)ï¼šé˜Ÿåˆ—æ»¡æ—¶ç­‰å¾…æŒ‡å®šæ—¶é—´

Q4: SynchronousQueueçš„ç‰¹ç‚¹ï¼Ÿ
A: - æ²¡æœ‰å®¹é‡ï¼Œä¸å­˜å‚¨å…ƒç´ 
   - æ¯ä¸ªputå¿…é¡»ç­‰å¾…ä¸€ä¸ªtake
   - æ”¯æŒå…¬å¹³/éå…¬å¹³æ¨¡å¼
   - é€‚åˆä¼ é€’æ€§åœºæ™¯ï¼ˆå¦‚çº¿ç¨‹æ± ï¼‰

Q5: DelayQueueçš„å®ç°åŸç†ï¼Ÿ
A: - åŸºäºPriorityQueueå®ç°
   - å…ƒç´ å¿…é¡»å®ç°Delayedæ¥å£
   - æŒ‰å»¶è¿Ÿæ—¶é—´æ’åº
   - ä½¿ç”¨Leader-Followeræ¨¡å¼å‡å°‘å”¤é†’
```

### 10.2 ä½¿ç”¨ç¤ºä¾‹

```java
/**
 * ç”Ÿäº§è€…-æ¶ˆè´¹è€…ç¤ºä¾‹
 */
public class ProducerConsumerDemo {
    
    private final BlockingQueue<String> queue = new ArrayBlockingQueue<>(10);
    
    // ç”Ÿäº§è€…
    class Producer implements Runnable {
        @Override
        public void run() {
            try {
                for (int i = 0; i < 100; i++) {
                    queue.put("item-" + i);
                    System.out.println("ç”Ÿäº§: item-" + i);
                }
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
        }
    }
    
    // æ¶ˆè´¹è€…
    class Consumer implements Runnable {
        @Override
        public void run() {
            try {
                while (true) {
                    String item = queue.take();
                    System.out.println("æ¶ˆè´¹: " + item);
                }
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
        }
    }
    
    public void start() {
        new Thread(new Producer()).start();
        new Thread(new Consumer()).start();
    }
}
```

### 10.3 æ³¨æ„äº‹é¡¹

```java
/**
 * ä½¿ç”¨BlockingQueueçš„æ³¨æ„äº‹é¡¹
 */
public class BlockingQueueNotes {
    
    // 1. é€‰æ‹©åˆé€‚çš„å®¹é‡
    // âŒ æ— ç•Œé˜Ÿåˆ—å¯èƒ½å¯¼è‡´OOM
    BlockingQueue<String> unbounded = new LinkedBlockingQueue<>();
    
    // âœ… è®¾ç½®åˆç†çš„å®¹é‡
    BlockingQueue<String> bounded = new LinkedBlockingQueue<>(1000);
    
    // 2. æ­£ç¡®å¤„ç†ä¸­æ–­
    public void correctInterrupt(BlockingQueue<String> queue) {
        try {
            String item = queue.take();
        } catch (InterruptedException e) {
            // æ¢å¤ä¸­æ–­çŠ¶æ€
            Thread.currentThread().interrupt();
            // æˆ–è€…é€€å‡ºå¾ªç¯
        }
    }
    
    // 3. é¿å…åœ¨å¾ªç¯ä¸­ä½¿ç”¨poll
    // âŒ ç©ºè½¬æ¶ˆè€—CPU
    public void wrongPoll(BlockingQueue<String> queue) {
        while (true) {
            String item = queue.poll();  // å¯èƒ½è¿”å›null
            if (item != null) {
                process(item);
            }
            // é˜Ÿåˆ—ç©ºæ—¶ä¼šç©ºè½¬
        }
    }
    
    // âœ… ä½¿ç”¨takeæˆ–å¸¦è¶…æ—¶çš„poll
    public void correctTake(BlockingQueue<String> queue) 
            throws InterruptedException {
        while (true) {
            String item = queue.take();  // é˜»å¡ç­‰å¾…
            process(item);
        }
    }
    
    // 4. æ‰¹é‡æ“ä½œæé«˜æ•ˆç‡
    public void batchProcess(BlockingQueue<String> queue) {
        List<String> batch = new ArrayList<>();
        queue.drainTo(batch, 100);  // æ‰¹é‡å–å‡º
        processBatch(batch);
    }
    
    private void process(String item) { /* å¤„ç† */ }
    private void processBatch(List<String> items) { /* æ‰¹é‡å¤„ç† */ }
}
```

---

## ğŸ“š æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **é˜»å¡æ“ä½œ**ï¼šput/takeåœ¨é˜Ÿåˆ—æ»¡/ç©ºæ—¶é˜»å¡
2. **çº¿ç¨‹å®‰å…¨**ï¼šå†…éƒ¨ä½¿ç”¨é”æˆ–CASä¿è¯
3. **å¤šç§å®ç°**ï¼šæ ¹æ®åœºæ™¯é€‰æ‹©åˆé€‚çš„å®ç°
4. **ç”Ÿäº§è€…-æ¶ˆè´¹è€…**ï¼šBlockingQueueæ˜¯æœ€ä½³å®è·µ

### é€‰æ‹©æŒ‡å—

| åœºæ™¯ | æ¨èå®ç° |
|------|----------|
| å›ºå®šå®¹é‡ | ArrayBlockingQueue |
| é«˜ååé‡ | LinkedBlockingQueue |
| ä¼˜å…ˆçº§å¤„ç† | PriorityBlockingQueue |
| ç›´æ¥ä¼ é€’ | SynchronousQueue |
| å»¶è¿Ÿæ‰§è¡Œ | DelayQueue |

---

*æœ€åæ›´æ–°ï¼š2025-12-28*
