# AtomicIntegeræºç è§£æ

> æ·±å…¥åˆ†æJDKåŸå­ç±»å®ç°åŸç†ï¼ŒæŒæ¡CASæ— é”ç¼–ç¨‹æ ¸å¿ƒæœºåˆ¶

---

## ğŸ“š ç›®å½•

1. [æ•´ä½“æ¶æ„](#1-æ•´ä½“æ¶æ„)
2. [æ ¸å¿ƒå±æ€§](#2-æ ¸å¿ƒå±æ€§)
3. [Unsafeç±»è¯¦è§£](#3-unsafeç±»è¯¦è§£)
4. [CASæ“ä½œåŸç†](#4-casæ“ä½œåŸç†)
5. [æ ¸å¿ƒæ–¹æ³•æºç ](#5-æ ¸å¿ƒæ–¹æ³•æºç )
6. [ABAé—®é¢˜](#6-abaé—®é¢˜)
7. [åŸå­ç±»å®¶æ—](#7-åŸå­ç±»å®¶æ—)
8. [LongAdderä¼˜åŒ–](#8-longadderä¼˜åŒ–)
9. [æµç¨‹å›¾è§£](#9-æµç¨‹å›¾è§£)
10. [é¢è¯•è¦ç‚¹](#10-é¢è¯•è¦ç‚¹)

---

## 1. æ•´ä½“æ¶æ„

### 1.1 åŸå­ç±»ç»§æ‰¿ç»“æ„

```
java.util.concurrent.atomic
â”œâ”€â”€ åŸºæœ¬ç±»å‹åŸå­ç±»
â”‚   â”œâ”€â”€ AtomicInteger      # intåŸå­ç±»
â”‚   â”œâ”€â”€ AtomicLong         # longåŸå­ç±»
â”‚   â””â”€â”€ AtomicBoolean      # booleanåŸå­ç±»
â”œâ”€â”€ æ•°ç»„åŸå­ç±»
â”‚   â”œâ”€â”€ AtomicIntegerArray
â”‚   â”œâ”€â”€ AtomicLongArray
â”‚   â””â”€â”€ AtomicReferenceArray
â”œâ”€â”€ å¼•ç”¨ç±»å‹åŸå­ç±»
â”‚   â”œâ”€â”€ AtomicReference<V>
â”‚   â”œâ”€â”€ AtomicStampedReference<V>   # è§£å†³ABAé—®é¢˜
â”‚   â””â”€â”€ AtomicMarkableReference<V>
â”œâ”€â”€ å­—æ®µæ›´æ–°å™¨
â”‚   â”œâ”€â”€ AtomicIntegerFieldUpdater
â”‚   â”œâ”€â”€ AtomicLongFieldUpdater
â”‚   â””â”€â”€ AtomicReferenceFieldUpdater
â””â”€â”€ JDK8æ–°å¢ï¼ˆé«˜å¹¶å‘ä¼˜åŒ–ï¼‰
    â”œâ”€â”€ LongAdder
    â”œâ”€â”€ DoubleAdder
    â”œâ”€â”€ LongAccumulator
    â””â”€â”€ DoubleAccumulator
```

### 1.2 AtomicIntegerç±»å®šä¹‰

```java
/**
 * AtomicIntegerï¼šå¯ä»¥åŸå­æ›´æ–°çš„intå€¼
 * 
 * æ ¸å¿ƒç‰¹æ€§ï¼š
 * 1. çº¿ç¨‹å®‰å…¨ï¼šåŸºäºCASå®ç°æ— é”å¹¶å‘
 * 2. é«˜æ€§èƒ½ï¼šé¿å…é”çš„å¼€é”€
 * 3. åŸå­æ“ä½œï¼šä¿è¯æ“ä½œçš„åŸå­æ€§
 */
public class AtomicInteger extends Number implements java.io.Serializable {
    
    private static final long serialVersionUID = 6214790243416807050L;
    
    // Unsafeå®ä¾‹ï¼Œç”¨äºæ‰§è¡Œåº•å±‚CASæ“ä½œ
    private static final Unsafe unsafe = Unsafe.getUnsafe();
    
    // valueå­—æ®µçš„å†…å­˜åç§»é‡
    private static final long valueOffset;
    
    // é™æ€ä»£ç å—ï¼šè·å–valueå­—æ®µçš„åç§»é‡
    static {
        try {
            valueOffset = unsafe.objectFieldOffset
                (AtomicInteger.class.getDeclaredField("value"));
        } catch (Exception ex) { throw new Error(ex); }
    }
    
    // å®é™…å­˜å‚¨çš„å€¼ï¼Œä½¿ç”¨volatileä¿è¯å¯è§æ€§
    private volatile int value;
    
    // æ„é€ æ–¹æ³•
    public AtomicInteger(int initialValue) {
        value = initialValue;
    }
    
    public AtomicInteger() {
    }
}
```


---

## 2. æ ¸å¿ƒå±æ€§

### 2.1 å±æ€§è¯¦è§£

```java
public class AtomicInteger extends Number implements java.io.Serializable {
    
    /**
     * Unsafeå®ä¾‹
     * - æä¾›åº•å±‚çš„CASæ“ä½œ
     * - ç›´æ¥æ“ä½œå†…å­˜
     * - åªèƒ½é€šè¿‡åå°„æˆ–ç‰¹æƒä»£ç è·å–
     */
    private static final Unsafe unsafe = Unsafe.getUnsafe();
    
    /**
     * valueå­—æ®µçš„å†…å­˜åç§»é‡
     * - ç”¨äºå®šä½valueåœ¨å¯¹è±¡å†…å­˜ä¸­çš„ä½ç½®
     * - CASæ“ä½œéœ€è¦çŸ¥é“å­—æ®µçš„ç²¾ç¡®ä½ç½®
     */
    private static final long valueOffset;
    
    /**
     * å®é™…å­˜å‚¨çš„intå€¼
     * - volatileä¿è¯å¯è§æ€§
     * - æ‰€æœ‰çº¿ç¨‹éƒ½èƒ½çœ‹åˆ°æœ€æ–°å€¼
     */
    private volatile int value;
}
```

### 2.2 å†…å­˜å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                AtomicInteger å¯¹è±¡å†…å­˜å¸ƒå±€                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å¯¹è±¡å¤´ (Object Header)                                     â”‚
â”‚  â”œâ”€â”€ Mark Word (8 bytes)                                   â”‚
â”‚  â””â”€â”€ Class Pointer (4/8 bytes)                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å®ä¾‹æ•°æ® (Instance Data)                                   â”‚
â”‚  â””â”€â”€ value (4 bytes) â† valueOffset æŒ‡å‘è¿™é‡Œ                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å¯¹é½å¡«å…… (Padding)                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

valueOffset = unsafe.objectFieldOffset(
    AtomicInteger.class.getDeclaredField("value")
);
// valueOffset çš„å€¼å°±æ˜¯ value å­—æ®µç›¸å¯¹äºå¯¹è±¡èµ·å§‹åœ°å€çš„åç§»é‡
```

---

## 3. Unsafeç±»è¯¦è§£

### 3.1 Unsafeç±»æ¦‚è¿°

```java
/**
 * Unsafeç±»ï¼šJavaä¸­çš„"åé—¨"
 * 
 * åŠŸèƒ½ï¼š
 * 1. å†…å­˜æ“ä½œï¼šç›´æ¥åˆ†é…/é‡Šæ”¾å†…å­˜
 * 2. CASæ“ä½œï¼šåŸå­æ€§æ¯”è¾ƒå¹¶äº¤æ¢
 * 3. çº¿ç¨‹è°ƒåº¦ï¼špark/unpark
 * 4. ç±»æ“ä½œï¼šåŠ¨æ€åˆ›å»ºç±»
 * 5. å†…å­˜å±éšœï¼šloadFence/storeFence
 */
public final class Unsafe {
    
    // å•ä¾‹æ¨¡å¼
    private static final Unsafe theUnsafe;
    
    // ç§æœ‰æ„é€ 
    private Unsafe() {}
    
    // è·å–å®ä¾‹ï¼ˆéœ€è¦ç‰¹æƒï¼‰
    @CallerSensitive
    public static Unsafe getUnsafe() {
        Class<?> caller = Reflection.getCallerClass();
        // åªæœ‰Bootstrapç±»åŠ è½½å™¨åŠ è½½çš„ç±»æ‰èƒ½è·å–
        if (!VM.isSystemDomainLoader(caller.getClassLoader()))
            throw new SecurityException("Unsafe");
        return theUnsafe;
    }
}
```

### 3.2 CASç›¸å…³æ–¹æ³•

```java
/**
 * Unsafeä¸­çš„CASæ–¹æ³•
 */
public final class Unsafe {
    
    /**
     * æ¯”è¾ƒå¹¶äº¤æ¢intå€¼
     * @param o å¯¹è±¡
     * @param offset å­—æ®µåç§»é‡
     * @param expected æœŸæœ›å€¼
     * @param x æ–°å€¼
     * @return æ˜¯å¦æˆåŠŸ
     */
    public final native boolean compareAndSwapInt(
        Object o, long offset, int expected, int x);
    
    /**
     * æ¯”è¾ƒå¹¶äº¤æ¢longå€¼
     */
    public final native boolean compareAndSwapLong(
        Object o, long offset, long expected, long x);
    
    /**
     * æ¯”è¾ƒå¹¶äº¤æ¢å¯¹è±¡å¼•ç”¨
     */
    public final native boolean compareAndSwapObject(
        Object o, long offset, Object expected, Object x);
    
    /**
     * è·å–å­—æ®µåç§»é‡
     */
    public native long objectFieldOffset(Field f);
    
    /**
     * è·å–volatile intå€¼
     */
    public native int getIntVolatile(Object o, long offset);
    
    /**
     * è®¾ç½®volatile intå€¼
     */
    public native void putIntVolatile(Object o, long offset, int x);
}
```

### 3.3 è·å–Unsafeå®ä¾‹

```java
/**
 * é€šè¿‡åå°„è·å–Unsafeå®ä¾‹
 */
public class UnsafeDemo {
    
    private static Unsafe unsafe;
    
    static {
        try {
            Field field = Unsafe.class.getDeclaredField("theUnsafe");
            field.setAccessible(true);
            unsafe = (Unsafe) field.get(null);
        } catch (Exception e) {
            throw new RuntimeException(e);
        }
    }
    
    public static void main(String[] args) throws Exception {
        // ä½¿ç”¨Unsafeè¿›è¡ŒCASæ“ä½œ
        AtomicInteger ai = new AtomicInteger(0);
        
        Field valueField = AtomicInteger.class.getDeclaredField("value");
        long offset = unsafe.objectFieldOffset(valueField);
        
        // CASæ“ä½œï¼šæœŸæœ›å€¼0ï¼Œæ–°å€¼1
        boolean success = unsafe.compareAndSwapInt(ai, offset, 0, 1);
        System.out.println("CASç»“æœ: " + success);  // true
        System.out.println("å½“å‰å€¼: " + ai.get());   // 1
    }
}
```

---

## 4. CASæ“ä½œåŸç†

### 4.1 CASæ¦‚å¿µ

```
CAS (Compare And Swap) æ¯”è¾ƒå¹¶äº¤æ¢

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CAS æ“ä½œæµç¨‹                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è¾“å…¥å‚æ•°ï¼š
- Vï¼šå†…å­˜åœ°å€ï¼ˆè¦ä¿®æ”¹çš„å˜é‡ï¼‰
- Eï¼šæœŸæœ›å€¼ï¼ˆExpectedï¼‰
- Nï¼šæ–°å€¼ï¼ˆNewï¼‰

æ‰§è¡Œé€»è¾‘ï¼š
if (V == E) {
    V = N;
    return true;
} else {
    return false;
}

ç‰¹ç‚¹ï¼š
- åŸå­æ“ä½œï¼šç”±CPUæŒ‡ä»¤ä¿è¯
- æ— é”ï¼šä¸éœ€è¦è·å–é”
- ä¹è§‚é”ï¼šå‡è®¾æ²¡æœ‰å†²çªï¼Œå†²çªæ—¶é‡è¯•
```

### 4.2 CASåº•å±‚å®ç°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CAS å®ç°å±‚æ¬¡                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Javaå±‚ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AtomicInteger.compareAndSet(expect, update)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
JNIå±‚ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Unsafe.compareAndSwapInt(obj, offset, expect, update)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
C++å±‚ï¼ˆHotspotï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Atomic::cmpxchg(exchange_value, dest, compare_value)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
æ±‡ç¼–å±‚ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  lock cmpxchg [destination], source                         â”‚
â”‚  (x86æ¶æ„çš„åŸå­æ¯”è¾ƒäº¤æ¢æŒ‡ä»¤)                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è¯´æ˜ï¼š
- lockå‰ç¼€ï¼šé”å®šæ€»çº¿æˆ–ç¼“å­˜è¡Œï¼Œä¿è¯åŸå­æ€§
- cmpxchgï¼šæ¯”è¾ƒå¹¶äº¤æ¢æŒ‡ä»¤
- å¤šæ ¸CPUä¸‹ï¼Œlockä¿è¯æ“ä½œçš„åŸå­æ€§å’Œå¯è§æ€§
```

### 4.3 CAS vs é”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CAS vs é” å¯¹æ¯”                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    ç‰¹æ€§      â”‚      CAS        â”‚         é”               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å®ç°æ–¹å¼    â”‚  CPUæŒ‡ä»¤        â”‚  æ“ä½œç³»ç»Ÿäº’æ–¥é‡           â”‚
â”‚  é˜»å¡        â”‚  éé˜»å¡         â”‚  é˜»å¡                     â”‚
â”‚  ä¸Šä¸‹æ–‡åˆ‡æ¢  â”‚  æ—              â”‚  æœ‰                       â”‚
â”‚  å†²çªå¤„ç†    â”‚  è‡ªæ—‹é‡è¯•       â”‚  ç­‰å¾…å”¤é†’                 â”‚
â”‚  é€‚ç”¨åœºæ™¯    â”‚  ç«äº‰ä¸æ¿€çƒˆ     â”‚  ç«äº‰æ¿€çƒˆ                 â”‚
â”‚  CPUæ¶ˆè€—     â”‚  è‡ªæ—‹æ¶ˆè€—CPU    â”‚  ç­‰å¾…ä¸æ¶ˆè€—CPU            â”‚
â”‚  å…¬å¹³æ€§      â”‚  ä¸ä¿è¯         â”‚  å¯é…ç½®                   â”‚
â”‚  ABAé—®é¢˜     â”‚  å­˜åœ¨           â”‚  ä¸å­˜åœ¨                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


---

## 5. æ ¸å¿ƒæ–¹æ³•æºç 

### 5.1 get/setæ–¹æ³•

```java
/**
 * è·å–å½“å‰å€¼
 * volatileä¿è¯å¯è§æ€§
 */
public final int get() {
    return value;
}

/**
 * è®¾ç½®æ–°å€¼
 * volatileä¿è¯å¯è§æ€§
 */
public final void set(int newValue) {
    value = newValue;
}

/**
 * å»¶è¿Ÿè®¾ç½®æ–°å€¼
 * ä¸ä¿è¯ç«‹å³å¯è§ï¼Œä½†æ€§èƒ½æ›´å¥½
 * é€‚ç”¨äºä¸éœ€è¦ç«‹å³å¯è§çš„åœºæ™¯
 */
public final void lazySet(int newValue) {
    unsafe.putOrderedInt(this, valueOffset, newValue);
}
```

### 5.2 compareAndSetæ–¹æ³•

```java
/**
 * CASæ“ä½œï¼šæ¯”è¾ƒå¹¶è®¾ç½®
 * 
 * @param expect æœŸæœ›å€¼
 * @param update æ–°å€¼
 * @return æ˜¯å¦æˆåŠŸ
 */
public final boolean compareAndSet(int expect, int update) {
    return unsafe.compareAndSwapInt(this, valueOffset, expect, update);
}

/**
 * å¼±CASï¼ˆJDK9ä¹‹å‰ä¸compareAndSetç›¸åŒï¼‰
 * JDK9+å¯èƒ½åœ¨æŸäº›å¹³å°ä¸Šæ€§èƒ½æ›´å¥½
 */
public final boolean weakCompareAndSet(int expect, int update) {
    return unsafe.compareAndSwapInt(this, valueOffset, expect, update);
}
```

### 5.3 getAndSetæ–¹æ³•

```java
/**
 * åŸå­åœ°è®¾ç½®æ–°å€¼å¹¶è¿”å›æ—§å€¼
 * 
 * å®ç°ï¼šè‡ªæ—‹CAS
 */
public final int getAndSet(int newValue) {
    return unsafe.getAndSetInt(this, valueOffset, newValue);
}

// Unsafeä¸­çš„å®ç°
public final int getAndSetInt(Object o, long offset, int newValue) {
    int v;
    do {
        v = getIntVolatile(o, offset);  // è·å–å½“å‰å€¼
    } while (!compareAndSwapInt(o, offset, v, newValue));  // CASç›´åˆ°æˆåŠŸ
    return v;  // è¿”å›æ—§å€¼
}
```

### 5.4 getAndIncrement/getAndDecrement

```java
/**
 * åŸå­åœ°è‡ªå¢å¹¶è¿”å›æ—§å€¼ï¼ˆi++ï¼‰
 */
public final int getAndIncrement() {
    return unsafe.getAndAddInt(this, valueOffset, 1);
}

/**
 * åŸå­åœ°è‡ªå‡å¹¶è¿”å›æ—§å€¼ï¼ˆi--ï¼‰
 */
public final int getAndDecrement() {
    return unsafe.getAndAddInt(this, valueOffset, -1);
}

/**
 * åŸå­åœ°å¢åŠ deltaå¹¶è¿”å›æ—§å€¼
 */
public final int getAndAdd(int delta) {
    return unsafe.getAndAddInt(this, valueOffset, delta);
}

// Unsafeä¸­çš„å®ç°
public final int getAndAddInt(Object o, long offset, int delta) {
    int v;
    do {
        v = getIntVolatile(o, offset);  // è·å–å½“å‰å€¼
    } while (!compareAndSwapInt(o, offset, v, v + delta));  // CASç›´åˆ°æˆåŠŸ
    return v;  // è¿”å›æ—§å€¼
}
```

### 5.5 incrementAndGet/decrementAndGet

```java
/**
 * åŸå­åœ°è‡ªå¢å¹¶è¿”å›æ–°å€¼ï¼ˆ++iï¼‰
 */
public final int incrementAndGet() {
    return unsafe.getAndAddInt(this, valueOffset, 1) + 1;
}

/**
 * åŸå­åœ°è‡ªå‡å¹¶è¿”å›æ–°å€¼ï¼ˆ--iï¼‰
 */
public final int decrementAndGet() {
    return unsafe.getAndAddInt(this, valueOffset, -1) - 1;
}

/**
 * åŸå­åœ°å¢åŠ deltaå¹¶è¿”å›æ–°å€¼
 */
public final int addAndGet(int delta) {
    return unsafe.getAndAddInt(this, valueOffset, delta) + delta;
}
```

### 5.6 updateAndGet/getAndUpdate (JDK8+)

```java
/**
 * åŸå­åœ°æ›´æ–°å€¼ï¼ˆä½¿ç”¨å‡½æ•°å¼æ¥å£ï¼‰
 * 
 * @param updateFunction æ›´æ–°å‡½æ•°
 * @return æ›´æ–°åçš„å€¼
 */
public final int updateAndGet(IntUnaryOperator updateFunction) {
    int prev, next;
    do {
        prev = get();
        next = updateFunction.applyAsInt(prev);
    } while (!compareAndSet(prev, next));
    return next;
}

/**
 * åŸå­åœ°æ›´æ–°å€¼å¹¶è¿”å›æ—§å€¼
 */
public final int getAndUpdate(IntUnaryOperator updateFunction) {
    int prev, next;
    do {
        prev = get();
        next = updateFunction.applyAsInt(prev);
    } while (!compareAndSet(prev, next));
    return prev;
}

/**
 * åŸå­åœ°ç´¯åŠ ï¼ˆä½¿ç”¨äºŒå…ƒå‡½æ•°ï¼‰
 */
public final int accumulateAndGet(int x, IntBinaryOperator accumulatorFunction) {
    int prev, next;
    do {
        prev = get();
        next = accumulatorFunction.applyAsInt(prev, x);
    } while (!compareAndSet(prev, next));
    return next;
}

// ä½¿ç”¨ç¤ºä¾‹
AtomicInteger ai = new AtomicInteger(10);

// å¹³æ–¹
ai.updateAndGet(x -> x * x);  // 100

// å–æœ€å¤§å€¼
ai.accumulateAndGet(50, Math::max);  // 100
```

---

## 6. ABAé—®é¢˜

### 6.1 ä»€ä¹ˆæ˜¯ABAé—®é¢˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ABAé—®é¢˜ç¤ºæ„                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åˆå§‹çŠ¶æ€ï¼švalue = A

çº¿ç¨‹1                              çº¿ç¨‹2
  â”‚                                  â”‚
  â”‚ è¯»å–value=A                      â”‚
  â”‚ å‡†å¤‡CAS(Aâ†’C)                     â”‚
  â”‚                                  â”‚ è¯»å–value=A
  â”‚                                  â”‚ CAS(Aâ†’B) æˆåŠŸ
  â”‚                                  â”‚ CAS(Bâ†’A) æˆåŠŸ
  â”‚                                  â”‚
  â”‚ CAS(Aâ†’C) æˆåŠŸï¼                  â”‚
  â”‚ (ä½†valueå·²ç»è¢«æ”¹è¿‡äº†)            â”‚
  â”‚                                  â”‚

é—®é¢˜ï¼šçº¿ç¨‹1çš„CASæˆåŠŸäº†ï¼Œä½†å®ƒä¸çŸ¥é“valueå·²ç»è¢«ä¿®æ”¹è¿‡
     åœ¨æŸäº›åœºæ™¯ä¸‹ï¼ˆå¦‚é“¾è¡¨æ“ä½œï¼‰ï¼Œè¿™å¯èƒ½å¯¼è‡´é—®é¢˜
```

### 6.2 ABAé—®é¢˜çš„å½±å“

```java
/**
 * ABAé—®é¢˜ç¤ºä¾‹ï¼šé“¾è¡¨å¤´èŠ‚ç‚¹æ“ä½œ
 */
public class ABADemo {
    
    static class Node {
        int value;
        Node next;
        Node(int value) { this.value = value; }
    }
    
    // é“¾è¡¨å¤´ï¼ˆåŸå­å¼•ç”¨ï¼‰
    AtomicReference<Node> head = new AtomicReference<>();
    
    /**
     * åœºæ™¯ï¼š
     * åˆå§‹é“¾è¡¨ï¼šA -> B -> C
     * 
     * çº¿ç¨‹1æƒ³è¦ï¼šç§»é™¤Aï¼Œè®©headæŒ‡å‘B
     * çº¿ç¨‹2æ“ä½œï¼šç§»é™¤Aå’ŒBï¼Œæ·»åŠ æ–°çš„A
     * 
     * ç»“æœï¼šçº¿ç¨‹1çš„CASæˆåŠŸï¼Œä½†é“¾è¡¨ç»“æ„å·²ç»å˜äº†
     */
    public void abaExample() {
        // åˆå§‹åŒ–ï¼šA -> B -> C
        Node c = new Node(3);
        Node b = new Node(2); b.next = c;
        Node a = new Node(1); a.next = b;
        head.set(a);
        
        // çº¿ç¨‹1ï¼šå°è¯•ç§»é™¤å¤´èŠ‚ç‚¹A
        Thread t1 = new Thread(() -> {
            Node oldHead = head.get();  // A
            Node newHead = oldHead.next; // B
            
            // æ¨¡æ‹Ÿå»¶è¿Ÿ
            try { Thread.sleep(100); } catch (Exception e) {}
            
            // CASï¼šæœŸæœ›Aï¼Œè®¾ç½®ä¸ºB
            // æ­¤æ—¶headå¯èƒ½å·²ç»è¢«æ”¹è¿‡äº†ï¼
            boolean success = head.compareAndSet(oldHead, newHead);
            System.out.println("çº¿ç¨‹1 CASç»“æœ: " + success);
        });
        
        // çº¿ç¨‹2ï¼šç§»é™¤Aå’ŒBï¼Œæ·»åŠ æ–°çš„A
        Thread t2 = new Thread(() -> {
            Node oldA = head.get();
            Node oldB = oldA.next;
            
            // ç§»é™¤Aï¼ŒheadæŒ‡å‘B
            head.compareAndSet(oldA, oldB);
            
            // ç§»é™¤Bï¼ŒheadæŒ‡å‘C
            head.compareAndSet(oldB, oldB.next);
            
            // æ·»åŠ æ–°çš„Aï¼ˆå€¼ç›¸åŒä½†æ˜¯æ–°å¯¹è±¡ï¼‰
            Node newA = new Node(1);
            newA.next = head.get();
            head.set(newA);
        });
        
        t1.start();
        t2.start();
    }
}
```

### 6.3 è§£å†³ABAé—®é¢˜

```java
/**
 * æ–¹æ¡ˆ1ï¼šAtomicStampedReferenceï¼ˆç‰ˆæœ¬å·ï¼‰
 * 
 * åŸç†ï¼šæ¯æ¬¡ä¿®æ”¹éƒ½å¢åŠ ç‰ˆæœ¬å·ï¼ŒCASæ—¶åŒæ—¶æ¯”è¾ƒå€¼å’Œç‰ˆæœ¬å·
 */
public class AtomicStampedReferenceDemo {
    
    // åˆå§‹å€¼Aï¼Œç‰ˆæœ¬å·0
    AtomicStampedReference<String> ref = 
        new AtomicStampedReference<>("A", 0);
    
    public void solve() {
        // è·å–å½“å‰å€¼å’Œç‰ˆæœ¬å·
        String value = ref.getReference();
        int stamp = ref.getStamp();
        
        // CASï¼šåŒæ—¶æ¯”è¾ƒå€¼å’Œç‰ˆæœ¬å·
        boolean success = ref.compareAndSet(
            value,      // æœŸæœ›å€¼
            "C",        // æ–°å€¼
            stamp,      // æœŸæœ›ç‰ˆæœ¬å·
            stamp + 1   // æ–°ç‰ˆæœ¬å·
        );
        
        System.out.println("CASç»“æœ: " + success);
        System.out.println("å½“å‰å€¼: " + ref.getReference());
        System.out.println("å½“å‰ç‰ˆæœ¬: " + ref.getStamp());
    }
}

/**
 * æ–¹æ¡ˆ2ï¼šAtomicMarkableReferenceï¼ˆæ ‡è®°ä½ï¼‰
 * 
 * åŸç†ï¼šä½¿ç”¨booleanæ ‡è®°ä½ï¼Œé€‚ç”¨äºåªå…³å¿ƒæ˜¯å¦è¢«ä¿®æ”¹è¿‡çš„åœºæ™¯
 */
public class AtomicMarkableReferenceDemo {
    
    // åˆå§‹å€¼Aï¼Œæ ‡è®°false
    AtomicMarkableReference<String> ref = 
        new AtomicMarkableReference<>("A", false);
    
    public void solve() {
        String value = ref.getReference();
        boolean marked = ref.isMarked();
        
        // CASï¼šåŒæ—¶æ¯”è¾ƒå€¼å’Œæ ‡è®°
        boolean success = ref.compareAndSet(
            value,      // æœŸæœ›å€¼
            "C",        // æ–°å€¼
            marked,     // æœŸæœ›æ ‡è®°
            true        // æ–°æ ‡è®°
        );
    }
}
```

### 6.4 AtomicStampedReferenceæºç 

```java
public class AtomicStampedReference<V> {
    
    // å†…éƒ¨ç±»ï¼šå°è£…å¼•ç”¨å’Œç‰ˆæœ¬å·
    private static class Pair<T> {
        final T reference;
        final int stamp;
        private Pair(T reference, int stamp) {
            this.reference = reference;
            this.stamp = stamp;
        }
        static <T> Pair<T> of(T reference, int stamp) {
            return new Pair<T>(reference, stamp);
        }
    }
    
    // åŸå­å¼•ç”¨
    private volatile Pair<V> pair;
    
    public AtomicStampedReference(V initialRef, int initialStamp) {
        pair = Pair.of(initialRef, initialStamp);
    }
    
    /**
     * CASæ“ä½œï¼šåŒæ—¶æ¯”è¾ƒå¼•ç”¨å’Œç‰ˆæœ¬å·
     */
    public boolean compareAndSet(V expectedReference, V newReference,
                                 int expectedStamp, int newStamp) {
        Pair<V> current = pair;
        return
            expectedReference == current.reference &&
            expectedStamp == current.stamp &&
            ((newReference == current.reference &&
              newStamp == current.stamp) ||
             casPair(current, Pair.of(newReference, newStamp)));
    }
    
    private boolean casPair(Pair<V> cmp, Pair<V> val) {
        return UNSAFE.compareAndSwapObject(this, pairOffset, cmp, val);
    }
}
```


---

## 7. åŸå­ç±»å®¶æ—

### 7.1 åŸºæœ¬ç±»å‹åŸå­ç±»

```java
/**
 * AtomicInteger - intåŸå­ç±»
 * AtomicLong - longåŸå­ç±»
 * AtomicBoolean - booleanåŸå­ç±»
 */
public class BasicAtomicDemo {
    
    AtomicInteger atomicInt = new AtomicInteger(0);
    AtomicLong atomicLong = new AtomicLong(0L);
    AtomicBoolean atomicBoolean = new AtomicBoolean(false);
    
    public void demo() {
        // AtomicInteger
        atomicInt.incrementAndGet();
        atomicInt.compareAndSet(1, 2);
        
        // AtomicLong
        atomicLong.addAndGet(100L);
        
        // AtomicBoolean
        atomicBoolean.compareAndSet(false, true);
    }
}
```

### 7.2 æ•°ç»„åŸå­ç±»

```java
/**
 * AtomicIntegerArray - intæ•°ç»„åŸå­ç±»
 * AtomicLongArray - longæ•°ç»„åŸå­ç±»
 * AtomicReferenceArray - å¼•ç”¨æ•°ç»„åŸå­ç±»
 */
public class ArrayAtomicDemo {
    
    // åˆ›å»ºé•¿åº¦ä¸º10çš„åŸå­æ•°ç»„
    AtomicIntegerArray array = new AtomicIntegerArray(10);
    
    public void demo() {
        // è®¾ç½®ç´¢å¼•0çš„å€¼ä¸º100
        array.set(0, 100);
        
        // åŸå­è‡ªå¢ç´¢å¼•0çš„å€¼
        array.incrementAndGet(0);  // 101
        
        // CASæ“ä½œ
        array.compareAndSet(0, 101, 200);
        
        // è·å–å€¼
        int value = array.get(0);  // 200
    }
}

// AtomicIntegerArrayæºç ç‰‡æ®µ
public class AtomicIntegerArray {
    private final int[] array;
    
    // è®¡ç®—æ•°ç»„å…ƒç´ çš„åç§»é‡
    private long checkedByteOffset(int i) {
        if (i < 0 || i >= array.length)
            throw new IndexOutOfBoundsException("index " + i);
        return byteOffset(i);
    }
    
    private static long byteOffset(int i) {
        return ((long) i << shift) + base;
    }
    
    public final int getAndIncrement(int i) {
        return getAndAdd(i, 1);
    }
    
    public final int getAndAdd(int i, int delta) {
        return unsafe.getAndAddInt(array, checkedByteOffset(i), delta);
    }
}
```

### 7.3 å¼•ç”¨ç±»å‹åŸå­ç±»

```java
/**
 * AtomicReference - å¼•ç”¨åŸå­ç±»
 * AtomicStampedReference - å¸¦ç‰ˆæœ¬å·çš„å¼•ç”¨åŸå­ç±»
 * AtomicMarkableReference - å¸¦æ ‡è®°çš„å¼•ç”¨åŸå­ç±»
 */
public class ReferenceAtomicDemo {
    
    // æ™®é€šå¼•ç”¨åŸå­ç±»
    AtomicReference<User> userRef = new AtomicReference<>();
    
    // å¸¦ç‰ˆæœ¬å·ï¼ˆè§£å†³ABAé—®é¢˜ï¼‰
    AtomicStampedReference<User> stampedRef = 
        new AtomicStampedReference<>(null, 0);
    
    // å¸¦æ ‡è®°ä½
    AtomicMarkableReference<User> markableRef = 
        new AtomicMarkableReference<>(null, false);
    
    public void demo() {
        User oldUser = new User("old");
        User newUser = new User("new");
        
        // AtomicReference
        userRef.set(oldUser);
        userRef.compareAndSet(oldUser, newUser);
        
        // AtomicStampedReference
        stampedRef.set(oldUser, 1);
        int[] stampHolder = new int[1];
        User current = stampedRef.get(stampHolder);
        stampedRef.compareAndSet(current, newUser, stampHolder[0], stampHolder[0] + 1);
        
        // AtomicMarkableReference
        markableRef.set(oldUser, false);
        markableRef.compareAndSet(oldUser, newUser, false, true);
    }
    
    static class User {
        String name;
        User(String name) { this.name = name; }
    }
}
```

### 7.4 å­—æ®µæ›´æ–°å™¨

```java
/**
 * AtomicIntegerFieldUpdater - intå­—æ®µæ›´æ–°å™¨
 * AtomicLongFieldUpdater - longå­—æ®µæ›´æ–°å™¨
 * AtomicReferenceFieldUpdater - å¼•ç”¨å­—æ®µæ›´æ–°å™¨
 * 
 * ç”¨é€”ï¼šå¯¹å·²æœ‰ç±»çš„volatileå­—æ®µè¿›è¡ŒåŸå­æ›´æ–°
 * ä¼˜åŠ¿ï¼šä¸éœ€è¦ä¿®æ”¹åŸæœ‰ç±»ï¼ŒèŠ‚çœå†…å­˜
 */
public class FieldUpdaterDemo {
    
    // ç›®æ ‡ç±»
    static class Account {
        volatile int balance;  // å¿…é¡»æ˜¯volatile
        volatile String owner;
        
        Account(int balance, String owner) {
            this.balance = balance;
            this.owner = owner;
        }
    }
    
    // åˆ›å»ºå­—æ®µæ›´æ–°å™¨
    static final AtomicIntegerFieldUpdater<Account> balanceUpdater =
        AtomicIntegerFieldUpdater.newUpdater(Account.class, "balance");
    
    static final AtomicReferenceFieldUpdater<Account, String> ownerUpdater =
        AtomicReferenceFieldUpdater.newUpdater(Account.class, String.class, "owner");
    
    public void demo() {
        Account account = new Account(100, "Alice");
        
        // åŸå­æ›´æ–°balanceå­—æ®µ
        balanceUpdater.addAndGet(account, 50);  // 150
        balanceUpdater.compareAndSet(account, 150, 200);
        
        // åŸå­æ›´æ–°ownerå­—æ®µ
        ownerUpdater.compareAndSet(account, "Alice", "Bob");
    }
}
```

---

## 8. LongAdderä¼˜åŒ–

### 8.1 AtomicLongçš„é—®é¢˜

```
é«˜å¹¶å‘åœºæ™¯ä¸‹AtomicLongçš„é—®é¢˜ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AtomicLong ç«äº‰æ¿€çƒˆ                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

çº¿ç¨‹1 â”€â”€â”
çº¿ç¨‹2 â”€â”€â”¼â”€â”€â†’ CASç«äº‰åŒä¸€ä¸ªvalue â”€â”€â†’ å¤§é‡CASå¤±è´¥é‡è¯•
çº¿ç¨‹3 â”€â”€â”¤
çº¿ç¨‹4 â”€â”€â”˜

é—®é¢˜ï¼š
1. æ‰€æœ‰çº¿ç¨‹ç«äº‰åŒä¸€ä¸ªå˜é‡
2. CASå¤±è´¥ç‡é«˜
3. è‡ªæ—‹æ¶ˆè€—CPU
```

### 8.2 LongAdderè®¾è®¡æ€æƒ³

```
LongAdderçš„åˆ†æ•£çƒ­ç‚¹è®¾è®¡ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    LongAdder åˆ†æ•£ç«äº‰                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  base   â”‚  â† æ— ç«äº‰æ—¶ä½¿ç”¨
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                â”‚                â”‚
        â–¼                â–¼                â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Cell[0] â”‚      â”‚ Cell[1] â”‚      â”‚ Cell[n] â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†‘                â†‘                â†‘
     çº¿ç¨‹1            çº¿ç¨‹2            çº¿ç¨‹n

æœ€ç»ˆå€¼ = base + sum(Cell[])

ä¼˜åŠ¿ï¼š
1. åˆ†æ•£ç«äº‰åˆ°å¤šä¸ªCell
2. å‡å°‘CASå¤±è´¥
3. æé«˜ååé‡
```

### 8.3 LongAdderæ ¸å¿ƒæºç 

```java
/**
 * LongAdderæ ¸å¿ƒå®ç°
 */
public class LongAdder extends Striped64 {
    
    /**
     * å¢åŠ 1
     */
    public void increment() {
        add(1L);
    }
    
    /**
     * å¢åŠ æŒ‡å®šå€¼
     */
    public void add(long x) {
        Cell[] as; long b, v; int m; Cell a;
        
        // 1. é¦–å…ˆå°è¯•æ›´æ–°baseï¼ˆæ— ç«äº‰æ—¶ï¼‰
        if ((as = cells) != null || !casBase(b = base, b + x)) {
            boolean uncontended = true;
            
            // 2. cellsä¸ºç©ºæˆ–å½“å‰çº¿ç¨‹å¯¹åº”çš„cellä¸ºç©º
            if (as == null || (m = as.length - 1) < 0 ||
                (a = as[getProbe() & m]) == null ||
                // 3. å°è¯•æ›´æ–°å¯¹åº”çš„cell
                !(uncontended = a.cas(v = a.value, v + x)))
                // 4. æ›´æ–°å¤±è´¥ï¼Œè¿›å…¥å®Œæ•´æµç¨‹
                longAccumulate(x, null, uncontended);
        }
    }
    
    /**
     * è·å–æ€»å’Œ
     */
    public long sum() {
        Cell[] as = cells; Cell a;
        long sum = base;
        if (as != null) {
            for (int i = 0; i < as.length; ++i) {
                if ((a = as[i]) != null)
                    sum += a.value;
            }
        }
        return sum;
    }
}
```

### 8.4 Cellç±»è®¾è®¡

```java
/**
 * Cellç±»ï¼šä½¿ç”¨@Contendedé¿å…ä¼ªå…±äº«
 */
@sun.misc.Contended  // å¡«å……ç¼“å­˜è¡Œï¼Œé¿å…ä¼ªå…±äº«
static final class Cell {
    volatile long value;
    
    Cell(long x) { value = x; }
    
    // CASæ›´æ–°value
    final boolean cas(long cmp, long val) {
        return UNSAFE.compareAndSwapLong(this, valueOffset, cmp, val);
    }
    
    private static final sun.misc.Unsafe UNSAFE;
    private static final long valueOffset;
    static {
        try {
            UNSAFE = sun.misc.Unsafe.getUnsafe();
            Class<?> ak = Cell.class;
            valueOffset = UNSAFE.objectFieldOffset
                (ak.getDeclaredField("value"));
        } catch (Exception e) {
            throw new Error(e);
        }
    }
}
```

### 8.5 ä¼ªå…±äº«é—®é¢˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä¼ªå…±äº« (False Sharing)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

CPUç¼“å­˜è¡Œï¼ˆé€šå¸¸64å­—èŠ‚ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Cell[0].value  â”‚  Cell[1].value  â”‚  Cell[2].value  â”‚ ...  â”‚
â”‚    (8 bytes)    â”‚    (8 bytes)    â”‚    (8 bytes)    â”‚      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é—®é¢˜ï¼š
- å¤šä¸ªCellå¯èƒ½åœ¨åŒä¸€ç¼“å­˜è¡Œ
- ä¸€ä¸ªCellæ›´æ–°ä¼šå¯¼è‡´æ•´ä¸ªç¼“å­˜è¡Œå¤±æ•ˆ
- å…¶ä»–CPUæ ¸å¿ƒéœ€è¦é‡æ–°åŠ è½½ç¼“å­˜è¡Œ

è§£å†³æ–¹æ¡ˆï¼š@Contendedæ³¨è§£
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ padding â”‚ Cell[0].value â”‚ padding â”‚ Cell[1].value â”‚ ...   â”‚
â”‚ (å¡«å……)  â”‚   (8 bytes)   â”‚ (å¡«å……)  â”‚   (8 bytes)   â”‚       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ¯ä¸ªCellç‹¬å ä¸€ä¸ªç¼“å­˜è¡Œï¼Œé¿å…ä¼ªå…±äº«
```

### 8.6 LongAdder vs AtomicLong

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              LongAdder vs AtomicLong å¯¹æ¯”                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    ç‰¹æ€§      â”‚   AtomicLong    â”‚      LongAdder            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å®ç°æ–¹å¼    â”‚  å•ä¸€å˜é‡CAS    â”‚  åˆ†æ•£åˆ°å¤šä¸ªCell           â”‚
â”‚  ç«äº‰æ¿€çƒˆæ—¶  â”‚  æ€§èƒ½ä¸‹é™       â”‚  æ€§èƒ½ç¨³å®š                 â”‚
â”‚  å†…å­˜å ç”¨    â”‚  å°             â”‚  å¤§ï¼ˆå¤šä¸ªCellï¼‰           â”‚
â”‚  ç²¾ç¡®è¯»å–    â”‚  æ”¯æŒ           â”‚  ä¸æ”¯æŒï¼ˆsuméåŸå­ï¼‰      â”‚
â”‚  é€‚ç”¨åœºæ™¯    â”‚  ç«äº‰ä¸æ¿€çƒˆ     â”‚  é«˜å¹¶å‘è®¡æ•°               â”‚
â”‚  å…¸å‹åº”ç”¨    â”‚  åºåˆ—å·ç”Ÿæˆ     â”‚  ç»Ÿè®¡è®¡æ•°                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é€‰æ‹©å»ºè®®ï¼š
- éœ€è¦ç²¾ç¡®å€¼ï¼šAtomicLong
- é«˜å¹¶å‘è®¡æ•°ï¼šLongAdder
- ä½å¹¶å‘åœºæ™¯ï¼šéƒ½å¯ä»¥
```


---

## 9. æµç¨‹å›¾è§£

### 9.1 CASæ“ä½œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CAS æ“ä½œæµç¨‹                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ è¯»å–å½“å‰å€¼V  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ è®¡ç®—æ–°å€¼N    â”‚
                    â”‚ N = V + deltaâ”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ CAS(V, N)    â”‚
                    â”‚ æœŸæœ›å€¼V,æ–°å€¼Nâ”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ æˆåŠŸ                    â”‚ å¤±è´¥
              â–¼                         â–¼
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚   è¿”å›ç»“æœ    â”‚          â”‚   è‡ªæ—‹é‡è¯•   â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â””â”€â”€â†’ å›åˆ°"è¯»å–å½“å‰å€¼"
```

### 9.2 getAndIncrementæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              getAndIncrement æ‰§è¡Œæµç¨‹                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

AtomicInteger ai = new AtomicInteger(5);
int old = ai.getAndIncrement();

æ‰§è¡Œè¿‡ç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. è°ƒç”¨ getAndIncrement()                                   â”‚
â”‚    â””â”€â†’ unsafe.getAndAddInt(this, valueOffset, 1)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. getAndAddInt å†…éƒ¨å¾ªç¯                                    â”‚
â”‚    do {                                                     â”‚
â”‚        v = getIntVolatile(o, offset);  // è¯»å–å½“å‰å€¼ 5      â”‚
â”‚    } while (!compareAndSwapInt(o, offset, v, v + 1));       â”‚
â”‚    return v;  // è¿”å›æ—§å€¼ 5                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. CASæ“ä½œ                                                  â”‚
â”‚    compareAndSwapInt(ai, offset, 5, 6)                      â”‚
â”‚    - æ¯”è¾ƒå†…å­˜å€¼æ˜¯å¦ä¸º5                                       â”‚
â”‚    - å¦‚æœæ˜¯ï¼Œè®¾ç½®ä¸º6ï¼Œè¿”å›true                               â”‚
â”‚    - å¦‚æœä¸æ˜¯ï¼Œè¿”å›falseï¼Œç»§ç»­å¾ªç¯                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. ç»“æœ                                                     â”‚
â”‚    old = 5  (è¿”å›æ—§å€¼)                                      â”‚
â”‚    ai.get() = 6  (å½“å‰å€¼)                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 9.3 åŸå­ç±»é€‰æ‹©å†³ç­–æ ‘

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  åŸå­ç±»é€‰æ‹©å†³ç­–æ ‘                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ æ“ä½œä»€ä¹ˆç±»å‹?â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                  â”‚                  â”‚
        â–¼                  â–¼                  â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚åŸºæœ¬ç±»å‹ â”‚       â”‚  æ•°ç»„   â”‚       â”‚å¼•ç”¨ç±»å‹ â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                  â”‚                  â”‚
        â–¼                  â–¼                  â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚AtomicIntâ”‚       â”‚AtomicIntâ”‚       â”‚éœ€è¦è§£å†³ â”‚
   â”‚AtomicLongâ”‚      â”‚Array    â”‚       â”‚ABAé—®é¢˜? â”‚
   â”‚AtomicBoolâ”‚      â”‚AtomicLongâ”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚Array    â”‚            â”‚
        â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
        â–¼                              â”‚ Yes     â”‚ No
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â–¼         â–¼
   â”‚é«˜å¹¶å‘   â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚è®¡æ•°?   â”‚                   â”‚Stamped  â”‚ â”‚Atomic   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚Referenceâ”‚ â”‚Referenceâ”‚
        â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
   â”‚ Yes     â”‚ No
   â–¼         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚LongAdderâ”‚ â”‚AtomicLongâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 10. é¢è¯•è¦ç‚¹

### 10.1 é«˜é¢‘é¢è¯•é¢˜

```
Q1: AtomicIntegerçš„å®ç°åŸç†ï¼Ÿ
A: åŸºäºUnsafeç±»çš„CASæ“ä½œå®ç°ï¼š
   - ä½¿ç”¨volatileä¿è¯valueçš„å¯è§æ€§
   - ä½¿ç”¨Unsafe.compareAndSwapIntè¿›è¡ŒåŸå­æ›´æ–°
   - CASå¤±è´¥æ—¶è‡ªæ—‹é‡è¯•

Q2: CASçš„ä¼˜ç¼ºç‚¹ï¼Ÿ
A: ä¼˜ç‚¹ï¼š
   - æ— é”ï¼Œé¿å…çº¿ç¨‹é˜»å¡å’Œä¸Šä¸‹æ–‡åˆ‡æ¢
   - æ€§èƒ½å¥½ï¼ˆç«äº‰ä¸æ¿€çƒˆæ—¶ï¼‰
   ç¼ºç‚¹ï¼š
   - ABAé—®é¢˜
   - è‡ªæ—‹æ¶ˆè€—CPU
   - åªèƒ½ä¿è¯å•ä¸ªå˜é‡çš„åŸå­æ€§

Q3: ä»€ä¹ˆæ˜¯ABAé—®é¢˜ï¼Ÿå¦‚ä½•è§£å†³ï¼Ÿ
A: ABAé—®é¢˜ï¼šå€¼ä»Aå˜æˆBåˆå˜å›Aï¼ŒCASæ— æ³•æ„ŸçŸ¥ä¸­é—´å˜åŒ–
   è§£å†³æ–¹æ¡ˆï¼š
   - AtomicStampedReferenceï¼šä½¿ç”¨ç‰ˆæœ¬å·
   - AtomicMarkableReferenceï¼šä½¿ç”¨æ ‡è®°ä½

Q4: AtomicIntegerå’Œsynchronizedçš„åŒºåˆ«ï¼Ÿ
A: - AtomicIntegerï¼šCASæ— é”ï¼Œé€‚åˆç«äº‰ä¸æ¿€çƒˆçš„åœºæ™¯
   - synchronizedï¼šæ‚²è§‚é”ï¼Œé€‚åˆç«äº‰æ¿€çƒˆçš„åœºæ™¯
   - AtomicIntegeråªèƒ½ä¿è¯å•ä¸ªå˜é‡åŸå­æ€§
   - synchronizedå¯ä»¥ä¿è¯ä»£ç å—åŸå­æ€§

Q5: LongAdderå’ŒAtomicLongçš„åŒºåˆ«ï¼Ÿ
A: - AtomicLongï¼šå•ä¸€å˜é‡CASï¼Œé«˜å¹¶å‘æ—¶æ€§èƒ½ä¸‹é™
   - LongAdderï¼šåˆ†æ•£åˆ°å¤šä¸ªCellï¼Œé«˜å¹¶å‘æ—¶æ€§èƒ½æ›´å¥½
   - LongAdderçš„sum()ä¸æ˜¯åŸå­æ“ä½œ
   - é«˜å¹¶å‘è®¡æ•°ç”¨LongAdderï¼Œéœ€è¦ç²¾ç¡®å€¼ç”¨AtomicLong
```

### 10.2 ä½¿ç”¨åœºæ™¯

```java
/**
 * åŸå­ç±»å…¸å‹ä½¿ç”¨åœºæ™¯
 */
public class AtomicUseCases {
    
    // 1. è®¡æ•°å™¨
    private AtomicInteger counter = new AtomicInteger(0);
    
    public void count() {
        counter.incrementAndGet();
    }
    
    // 2. åºåˆ—å·ç”Ÿæˆå™¨
    private AtomicLong sequence = new AtomicLong(0);
    
    public long nextId() {
        return sequence.incrementAndGet();
    }
    
    // 3. çŠ¶æ€æ ‡å¿—
    private AtomicBoolean initialized = new AtomicBoolean(false);
    
    public void init() {
        if (initialized.compareAndSet(false, true)) {
            // åªæ‰§è¡Œä¸€æ¬¡çš„åˆå§‹åŒ–é€»è¾‘
            doInit();
        }
    }
    
    // 4. æ— é”æ ˆ
    private AtomicReference<Node> top = new AtomicReference<>();
    
    public void push(int value) {
        Node newNode = new Node(value);
        Node oldTop;
        do {
            oldTop = top.get();
            newNode.next = oldTop;
        } while (!top.compareAndSet(oldTop, newNode));
    }
    
    // 5. é«˜å¹¶å‘ç»Ÿè®¡
    private LongAdder requestCount = new LongAdder();
    
    public void recordRequest() {
        requestCount.increment();
    }
    
    public long getRequestCount() {
        return requestCount.sum();
    }
    
    private void doInit() { /* åˆå§‹åŒ–é€»è¾‘ */ }
    
    static class Node {
        int value;
        Node next;
        Node(int value) { this.value = value; }
    }
}
```

### 10.3 æ³¨æ„äº‹é¡¹

```java
/**
 * ä½¿ç”¨åŸå­ç±»çš„æ³¨æ„äº‹é¡¹
 */
public class AtomicNotes {
    
    private AtomicInteger count = new AtomicInteger(0);
    
    // 1. âŒ é”™è¯¯ï¼šéåŸå­çš„å¤åˆæ“ä½œ
    public void wrongIncrement() {
        if (count.get() < 100) {  // æ£€æŸ¥
            count.incrementAndGet();  // æ“ä½œ
        }
        // é—®é¢˜ï¼šæ£€æŸ¥å’Œæ“ä½œä¸æ˜¯åŸå­çš„
    }
    
    // âœ… æ­£ç¡®ï¼šä½¿ç”¨CASå¾ªç¯
    public void correctIncrement() {
        int current;
        do {
            current = count.get();
            if (current >= 100) return;
        } while (!count.compareAndSet(current, current + 1));
    }
    
    // 2. âŒ é”™è¯¯ï¼šå¤šä¸ªåŸå­å˜é‡çš„å¤åˆæ“ä½œ
    private AtomicInteger x = new AtomicInteger(0);
    private AtomicInteger y = new AtomicInteger(0);
    
    public void wrongUpdate() {
        x.incrementAndGet();
        y.incrementAndGet();
        // é—®é¢˜ï¼šä¸¤ä¸ªæ“ä½œä¸æ˜¯åŸå­çš„
    }
    
    // âœ… æ­£ç¡®ï¼šä½¿ç”¨é”æˆ–åŸå­å¼•ç”¨
    private AtomicReference<Point> point = new AtomicReference<>(new Point(0, 0));
    
    public void correctUpdate() {
        Point oldPoint, newPoint;
        do {
            oldPoint = point.get();
            newPoint = new Point(oldPoint.x + 1, oldPoint.y + 1);
        } while (!point.compareAndSet(oldPoint, newPoint));
    }
    
    // 3. æ³¨æ„è‡ªæ—‹æ¶ˆè€—
    // ç«äº‰æ¿€çƒˆæ—¶ï¼Œè€ƒè™‘ä½¿ç”¨LongAdderæˆ–é”
    
    static class Point {
        final int x, y;
        Point(int x, int y) { this.x = x; this.y = y; }
    }
}
```

---

## ğŸ“š æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **CASåŸç†**ï¼šæ¯”è¾ƒå¹¶äº¤æ¢ï¼Œç”±CPUæŒ‡ä»¤ä¿è¯åŸå­æ€§
2. **Unsafeç±»**ï¼šæä¾›åº•å±‚CASæ“ä½œï¼Œç›´æ¥æ“ä½œå†…å­˜
3. **volatile**ï¼šä¿è¯valueçš„å¯è§æ€§
4. **ABAé—®é¢˜**ï¼šä½¿ç”¨AtomicStampedReferenceè§£å†³
5. **LongAdder**ï¼šé«˜å¹¶å‘åœºæ™¯ä¸‹çš„ä¼˜åŒ–æ–¹æ¡ˆ

### é€‰æ‹©å»ºè®®

| åœºæ™¯ | æ¨è |
|------|------|
| ç®€å•è®¡æ•° | AtomicInteger/AtomicLong |
| é«˜å¹¶å‘è®¡æ•° | LongAdder |
| å¼•ç”¨æ›´æ–° | AtomicReference |
| è§£å†³ABA | AtomicStampedReference |
| å­—æ®µæ›´æ–° | AtomicXxxFieldUpdater |

---

*æœ€åæ›´æ–°ï¼š2025-12-28*
