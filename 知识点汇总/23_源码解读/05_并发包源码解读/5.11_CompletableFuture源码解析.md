# CompletableFutureæºç è§£æ

> Javaå¼‚æ­¥ç¼–ç¨‹åˆ©å™¨æ·±åº¦è§£æ

## ğŸ“‹ ç›®å½•
- [æ•´ä½“ç»“æ„](#æ•´ä½“ç»“æ„)
- [åˆ›å»ºå¼‚æ­¥ä»»åŠ¡](#åˆ›å»ºå¼‚æ­¥ä»»åŠ¡)
- [ç»“æœå¤„ç†](#ç»“æœå¤„ç†)
- [ç»„åˆæ“ä½œ](#ç»„åˆæ“ä½œ)
- [å¼‚å¸¸å¤„ç†](#å¼‚å¸¸å¤„ç†)
- [é¢è¯•è¦ç‚¹](#é¢è¯•è¦ç‚¹)

---

## æ•´ä½“ç»“æ„

### ç±»å®šä¹‰

```java
public class CompletableFuture<T> implements Future<T>, CompletionStage<T> {
    
    // ç»“æœï¼ˆæ­£å¸¸ç»“æœæˆ–å¼‚å¸¸ï¼‰
    volatile Object result;
    
    // ä¾èµ–æ ˆï¼ˆç­‰å¾…å½“å‰ç»“æœçš„åç»­æ“ä½œï¼‰
    volatile Completion stack;
    
    // å¼‚æ­¥æ‰§è¡Œçš„é»˜è®¤çº¿ç¨‹æ± 
    private static final Executor ASYNC_POOL = useCommonPool ?
        ForkJoinPool.commonPool() : new ThreadPerTaskExecutor();
}

/**
 * å…³é”®æ¥å£ï¼š
 * - Futureï¼šè·å–å¼‚æ­¥ç»“æœ
 * - CompletionStageï¼šé“¾å¼æ“ä½œ
 */
```

### æ ¸å¿ƒæ¦‚å¿µ

```
CompletableFutureæ ¸å¿ƒï¼š

1. resultï¼šå­˜å‚¨ç»“æœ
   - æ­£å¸¸ç»“æœï¼šç›´æ¥å­˜å‚¨
   - å¼‚å¸¸ï¼šåŒ…è£…æˆAltResult

2. stackï¼šä¾èµ–æ ˆ
   - å­˜å‚¨ç­‰å¾…å½“å‰ç»“æœçš„åç»­æ“ä½œ
   - ç»“æœå®Œæˆæ—¶è§¦å‘

3. çº¿ç¨‹æ± ï¼š
   - é»˜è®¤ForkJoinPool.commonPool()
   - å¯æŒ‡å®šè‡ªå®šä¹‰çº¿ç¨‹æ± 
```

---

## åˆ›å»ºå¼‚æ­¥ä»»åŠ¡

### supplyAsync

```java
/**
 * æœ‰è¿”å›å€¼çš„å¼‚æ­¥ä»»åŠ¡
 */
public static <U> CompletableFuture<U> supplyAsync(Supplier<U> supplier) {
    return asyncSupplyStage(ASYNC_POOL, supplier);
}

public static <U> CompletableFuture<U> supplyAsync(Supplier<U> supplier, Executor executor) {
    return asyncSupplyStage(screenExecutor(executor), supplier);
}

static <U> CompletableFuture<U> asyncSupplyStage(Executor e, Supplier<U> f) {
    if (f == null) throw new NullPointerException();
    CompletableFuture<U> d = new CompletableFuture<U>();
    // æäº¤ä»»åŠ¡åˆ°çº¿ç¨‹æ± 
    e.execute(new AsyncSupply<U>(d, f));
    return d;
}

// å¼‚æ­¥ä»»åŠ¡åŒ…è£…ç±»
static final class AsyncSupply<T> extends ForkJoinTask<Void> implements Runnable {
    CompletableFuture<T> dep;  // ä¾èµ–çš„CompletableFuture
    Supplier<T> fn;            // ä»»åŠ¡å‡½æ•°
    
    public void run() {
        CompletableFuture<T> d; Supplier<T> f;
        if ((d = dep) != null && (f = fn) != null) {
            dep = null; fn = null;
            if (d.result == null) {
                try {
                    // æ‰§è¡Œä»»åŠ¡ï¼Œè®¾ç½®ç»“æœ
                    d.completeValue(f.get());
                } catch (Throwable ex) {
                    // å¼‚å¸¸ï¼Œè®¾ç½®å¼‚å¸¸ç»“æœ
                    d.completeThrowable(ex);
                }
            }
            // è§¦å‘åç»­æ“ä½œ
            d.postComplete();
        }
    }
}
```

### runAsync

```java
/**
 * æ— è¿”å›å€¼çš„å¼‚æ­¥ä»»åŠ¡
 */
public static CompletableFuture<Void> runAsync(Runnable runnable) {
    return asyncRunStage(ASYNC_POOL, runnable);
}

public static CompletableFuture<Void> runAsync(Runnable runnable, Executor executor) {
    return asyncRunStage(screenExecutor(executor), runnable);
}
```

### ä½¿ç”¨ç¤ºä¾‹

```java
// æœ‰è¿”å›å€¼
CompletableFuture<String> future1 = CompletableFuture.supplyAsync(() -> {
    // æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ
    Thread.sleep(1000);
    return "Hello";
});

// æ— è¿”å›å€¼
CompletableFuture<Void> future2 = CompletableFuture.runAsync(() -> {
    System.out.println("Running...");
});

// æŒ‡å®šçº¿ç¨‹æ± 
ExecutorService executor = Executors.newFixedThreadPool(10);
CompletableFuture<String> future3 = CompletableFuture.supplyAsync(() -> {
    return "Custom Pool";
}, executor);
```

---

## ç»“æœå¤„ç†

### thenApplyï¼ˆè½¬æ¢ç»“æœï¼‰

```java
/**
 * è½¬æ¢ç»“æœï¼ˆåŒæ­¥æ‰§è¡Œï¼‰
 */
public <U> CompletableFuture<U> thenApply(Function<? super T,? extends U> fn) {
    return uniApplyStage(null, fn);
}

/**
 * è½¬æ¢ç»“æœï¼ˆå¼‚æ­¥æ‰§è¡Œï¼‰
 */
public <U> CompletableFuture<U> thenApplyAsync(Function<? super T,? extends U> fn) {
    return uniApplyStage(defaultExecutor(), fn);
}

// ç¤ºä¾‹
CompletableFuture<Integer> future = CompletableFuture
    .supplyAsync(() -> "Hello")
    .thenApply(s -> s.length());  // è½¬æ¢ä¸ºé•¿åº¦
```

### thenAcceptï¼ˆæ¶ˆè´¹ç»“æœï¼‰

```java
/**
 * æ¶ˆè´¹ç»“æœï¼Œæ— è¿”å›å€¼
 */
public CompletableFuture<Void> thenAccept(Consumer<? super T> action) {
    return uniAcceptStage(null, action);
}

// ç¤ºä¾‹
CompletableFuture.supplyAsync(() -> "Hello")
    .thenAccept(s -> System.out.println(s));  // æ‰“å°ç»“æœ
```

### thenRunï¼ˆæ‰§è¡Œåç»­æ“ä½œï¼‰

```java
/**
 * æ‰§è¡Œåç»­æ“ä½œï¼Œä¸å…³å¿ƒç»“æœ
 */
public CompletableFuture<Void> thenRun(Runnable action) {
    return uniRunStage(null, action);
}

// ç¤ºä¾‹
CompletableFuture.supplyAsync(() -> "Hello")
    .thenRun(() -> System.out.println("Done"));  // å®Œæˆåæ‰§è¡Œ
```

### æ–¹æ³•å¯¹æ¯”

```
| æ–¹æ³• | å‚æ•° | è¿”å›å€¼ | è¯´æ˜ |
|------|------|--------|------|
| thenApply | Function<T,U> | CompletableFuture<U> | è½¬æ¢ç»“æœ |
| thenAccept | Consumer<T> | CompletableFuture<Void> | æ¶ˆè´¹ç»“æœ |
| thenRun | Runnable | CompletableFuture<Void> | æ‰§è¡Œæ“ä½œ |

Asyncåç¼€ï¼š
  - æ— Asyncï¼šåœ¨å½“å‰çº¿ç¨‹æˆ–å®Œæˆçº¿ç¨‹æ‰§è¡Œ
  - æœ‰Asyncï¼šåœ¨çº¿ç¨‹æ± ä¸­å¼‚æ­¥æ‰§è¡Œ
```

---

## ç»„åˆæ“ä½œ

### thenComposeï¼ˆæ‰å¹³åŒ–ï¼‰

```java
/**
 * æ‰å¹³åŒ–ç»„åˆï¼ˆç±»ä¼¼flatMapï¼‰
 */
public <U> CompletableFuture<U> thenCompose(
        Function<? super T, ? extends CompletionStage<U>> fn) {
    return uniComposeStage(null, fn);
}

// ç¤ºä¾‹ï¼šé¿å…åµŒå¥—
CompletableFuture<String> future = CompletableFuture
    .supplyAsync(() -> 1)
    .thenCompose(i -> CompletableFuture.supplyAsync(() -> "Result: " + i));

// å¯¹æ¯”thenApplyï¼ˆä¼šäº§ç”ŸåµŒå¥—ï¼‰
CompletableFuture<CompletableFuture<String>> nested = CompletableFuture
    .supplyAsync(() -> 1)
    .thenApply(i -> CompletableFuture.supplyAsync(() -> "Result: " + i));
```

### thenCombineï¼ˆåˆå¹¶ä¸¤ä¸ªç»“æœï¼‰

```java
/**
 * åˆå¹¶ä¸¤ä¸ªCompletableFutureçš„ç»“æœ
 */
public <U,V> CompletableFuture<V> thenCombine(
        CompletionStage<? extends U> other,
        BiFunction<? super T,? super U,? extends V> fn) {
    return biApplyStage(null, other, fn);
}

// ç¤ºä¾‹
CompletableFuture<String> future1 = CompletableFuture.supplyAsync(() -> "Hello");
CompletableFuture<String> future2 = CompletableFuture.supplyAsync(() -> "World");

CompletableFuture<String> combined = future1.thenCombine(future2, (s1, s2) -> s1 + " " + s2);
// ç»“æœï¼š"Hello World"
```

### allOfï¼ˆç­‰å¾…æ‰€æœ‰å®Œæˆï¼‰

```java
/**
 * ç­‰å¾…æ‰€æœ‰CompletableFutureå®Œæˆ
 */
public static CompletableFuture<Void> allOf(CompletableFuture<?>... cfs) {
    return andTree(cfs, 0, cfs.length - 1);
}

// ç¤ºä¾‹
CompletableFuture<String> f1 = CompletableFuture.supplyAsync(() -> "A");
CompletableFuture<String> f2 = CompletableFuture.supplyAsync(() -> "B");
CompletableFuture<String> f3 = CompletableFuture.supplyAsync(() -> "C");

CompletableFuture<Void> all = CompletableFuture.allOf(f1, f2, f3);
all.join();  // ç­‰å¾…æ‰€æœ‰å®Œæˆ

// è·å–æ‰€æœ‰ç»“æœ
List<String> results = Stream.of(f1, f2, f3)
    .map(CompletableFuture::join)
    .collect(Collectors.toList());
```

### anyOfï¼ˆä»»ä¸€å®Œæˆï¼‰

```java
/**
 * ä»»ä¸€CompletableFutureå®Œæˆå³è¿”å›
 */
public static CompletableFuture<Object> anyOf(CompletableFuture<?>... cfs) {
    return orTree(cfs, 0, cfs.length - 1);
}

// ç¤ºä¾‹
CompletableFuture<String> f1 = CompletableFuture.supplyAsync(() -> {
    Thread.sleep(1000);
    return "Slow";
});
CompletableFuture<String> f2 = CompletableFuture.supplyAsync(() -> {
    Thread.sleep(100);
    return "Fast";
});

Object result = CompletableFuture.anyOf(f1, f2).join();
// ç»“æœï¼š"Fast"ï¼ˆå…ˆå®Œæˆçš„ï¼‰
```

---

## å¼‚å¸¸å¤„ç†

### exceptionally

```java
/**
 * å¼‚å¸¸å¤„ç†ï¼Œè¿”å›é»˜è®¤å€¼
 */
public CompletableFuture<T> exceptionally(Function<Throwable, ? extends T> fn) {
    return uniExceptionallyStage(fn);
}

// ç¤ºä¾‹
CompletableFuture<String> future = CompletableFuture
    .supplyAsync(() -> {
        if (true) throw new RuntimeException("Error");
        return "Success";
    })
    .exceptionally(ex -> "Default: " + ex.getMessage());
// ç»“æœï¼š"Default: Error"
```

### handle

```java
/**
 * å¤„ç†ç»“æœæˆ–å¼‚å¸¸
 */
public <U> CompletableFuture<U> handle(BiFunction<? super T, Throwable, ? extends U> fn) {
    return uniHandleStage(null, fn);
}

// ç¤ºä¾‹
CompletableFuture<String> future = CompletableFuture
    .supplyAsync(() -> {
        if (Math.random() > 0.5) throw new RuntimeException("Error");
        return "Success";
    })
    .handle((result, ex) -> {
        if (ex != null) {
            return "Error: " + ex.getMessage();
        }
        return "Result: " + result;
    });
```

### whenComplete

```java
/**
 * å®Œæˆæ—¶å›è°ƒï¼ˆä¸æ”¹å˜ç»“æœï¼‰
 */
public CompletableFuture<T> whenComplete(BiConsumer<? super T, ? super Throwable> action) {
    return uniWhenCompleteStage(null, action);
}

// ç¤ºä¾‹
CompletableFuture<String> future = CompletableFuture
    .supplyAsync(() -> "Hello")
    .whenComplete((result, ex) -> {
        if (ex != null) {
            System.out.println("Error: " + ex);
        } else {
            System.out.println("Result: " + result);
        }
    });
```

### å¼‚å¸¸å¤„ç†å¯¹æ¯”

```
| æ–¹æ³• | å‚æ•° | è¿”å›å€¼ | è¯´æ˜ |
|------|------|--------|------|
| exceptionally | Function<Throwable,T> | CompletableFuture<T> | åªå¤„ç†å¼‚å¸¸ |
| handle | BiFunction<T,Throwable,U> | CompletableFuture<U> | å¤„ç†ç»“æœå’Œå¼‚å¸¸ |
| whenComplete | BiConsumer<T,Throwable> | CompletableFuture<T> | å›è°ƒï¼Œä¸æ”¹å˜ç»“æœ |
```

---

## è·å–ç»“æœ

### get vs join

```java
/**
 * getï¼šé˜»å¡è·å–ç»“æœï¼ŒæŠ›å‡ºæ£€æŸ¥å¼‚å¸¸
 */
public T get() throws InterruptedException, ExecutionException {
    Object r;
    return reportGet((r = result) == null ? waitingGet(true) : r);
}

/**
 * joinï¼šé˜»å¡è·å–ç»“æœï¼ŒæŠ›å‡ºéæ£€æŸ¥å¼‚å¸¸
 */
public T join() {
    Object r;
    return reportJoin((r = result) == null ? waitingGet(false) : r);
}

// åŒºåˆ«
try {
    String result = future.get();  // éœ€è¦try-catch
} catch (InterruptedException | ExecutionException e) {
    e.printStackTrace();
}

String result = future.join();  // ä¸éœ€è¦try-catchï¼ŒæŠ›CompletionException
```

### getNow

```java
/**
 * ç«‹å³è·å–ç»“æœï¼Œæœªå®Œæˆè¿”å›é»˜è®¤å€¼
 */
public T getNow(T valueIfAbsent) {
    Object r;
    return ((r = result) == null) ? valueIfAbsent : reportJoin(r);
}

// ç¤ºä¾‹
String result = future.getNow("Default");
```

---

## é¢è¯•è¦ç‚¹

### 1. CompletableFuture vs Future

```
Q: CompletableFutureå’ŒFutureæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

A:
Futureï¼š
  - åªèƒ½é˜»å¡è·å–ç»“æœï¼ˆgetï¼‰
  - ä¸èƒ½é“¾å¼æ“ä½œ
  - ä¸èƒ½ç»„åˆå¤šä¸ªFuture
  - ä¸èƒ½æ‰‹åŠ¨å®Œæˆ

CompletableFutureï¼š
  - æ”¯æŒå›è°ƒï¼ˆthenApplyç­‰ï¼‰
  - æ”¯æŒé“¾å¼æ“ä½œ
  - æ”¯æŒç»„åˆï¼ˆthenCombineã€allOfç­‰ï¼‰
  - æ”¯æŒå¼‚å¸¸å¤„ç†
  - å¯ä»¥æ‰‹åŠ¨å®Œæˆï¼ˆcompleteï¼‰
```

### 2. å¸¸ç”¨æ–¹æ³•åˆ†ç±»

```
Q: CompletableFutureå¸¸ç”¨æ–¹æ³•æœ‰å“ªäº›ï¼Ÿ

A:
åˆ›å»ºï¼š
  - supplyAsyncï¼šæœ‰è¿”å›å€¼
  - runAsyncï¼šæ— è¿”å›å€¼

è½¬æ¢ï¼š
  - thenApplyï¼šè½¬æ¢ç»“æœ
  - thenComposeï¼šæ‰å¹³åŒ–

æ¶ˆè´¹ï¼š
  - thenAcceptï¼šæ¶ˆè´¹ç»“æœ
  - thenRunï¼šæ‰§è¡Œæ“ä½œ

ç»„åˆï¼š
  - thenCombineï¼šåˆå¹¶ä¸¤ä¸ªç»“æœ
  - allOfï¼šç­‰å¾…æ‰€æœ‰å®Œæˆ
  - anyOfï¼šä»»ä¸€å®Œæˆ

å¼‚å¸¸ï¼š
  - exceptionallyï¼šå¼‚å¸¸å¤„ç†
  - handleï¼šå¤„ç†ç»“æœå’Œå¼‚å¸¸
  - whenCompleteï¼šå®Œæˆå›è°ƒ
```

### 3. çº¿ç¨‹æ± é€‰æ‹©

```
Q: CompletableFutureä½¿ç”¨ä»€ä¹ˆçº¿ç¨‹æ± ï¼Ÿ

A:
é»˜è®¤çº¿ç¨‹æ± ï¼š
  - ForkJoinPool.commonPool()
  - å…±äº«çº¿ç¨‹æ± ï¼Œçº¿ç¨‹æ•° = CPUæ ¸å¿ƒæ•° - 1

é—®é¢˜ï¼š
  - å…±äº«å¯èƒ½å¯¼è‡´ä»»åŠ¡ç›¸äº’å½±å“
  - IOå¯†é›†å‹ä»»åŠ¡å¯èƒ½é˜»å¡

å»ºè®®ï¼š
  - æŒ‡å®šè‡ªå®šä¹‰çº¿ç¨‹æ± 
  - IOå¯†é›†å‹ï¼šçº¿ç¨‹æ•° = CPU * 2
  - CPUå¯†é›†å‹ï¼šçº¿ç¨‹æ•° = CPU + 1

ç¤ºä¾‹ï¼š
ExecutorService executor = Executors.newFixedThreadPool(10);
CompletableFuture.supplyAsync(() -> "Hello", executor);
```

### 4. å®æˆ˜ç¤ºä¾‹

```java
/**
 * å¹¶è¡Œè°ƒç”¨å¤šä¸ªæœåŠ¡
 */
public OrderInfo getOrderInfo(Long orderId) {
    // å¹¶è¡ŒæŸ¥è¯¢
    CompletableFuture<Order> orderFuture = CompletableFuture
        .supplyAsync(() -> orderService.getById(orderId));
    
    CompletableFuture<User> userFuture = CompletableFuture
        .supplyAsync(() -> userService.getById(orderId));
    
    CompletableFuture<List<Product>> productsFuture = CompletableFuture
        .supplyAsync(() -> productService.getByOrderId(orderId));
    
    // ç­‰å¾…æ‰€æœ‰å®Œæˆ
    CompletableFuture.allOf(orderFuture, userFuture, productsFuture).join();
    
    // ç»„è£…ç»“æœ
    OrderInfo info = new OrderInfo();
    info.setOrder(orderFuture.join());
    info.setUser(userFuture.join());
    info.setProducts(productsFuture.join());
    
    return info;
}

/**
 * è¶…æ—¶å¤„ç†
 */
public String getWithTimeout() {
    return CompletableFuture
        .supplyAsync(() -> {
            Thread.sleep(5000);
            return "Result";
        })
        .orTimeout(2, TimeUnit.SECONDS)  // JDK9+
        .exceptionally(ex -> "Timeout")
        .join();
}
```

---

## ğŸ’¡ æ€»ç»“

```
CompletableFutureæ ¸å¿ƒè¦ç‚¹ï¼š

1. åˆ›å»ºä»»åŠ¡ï¼š
   - supplyAsyncï¼šæœ‰è¿”å›å€¼
   - runAsyncï¼šæ— è¿”å›å€¼

2. é“¾å¼æ“ä½œï¼š
   - thenApply/thenAccept/thenRun
   - thenComposeï¼ˆæ‰å¹³åŒ–ï¼‰

3. ç»„åˆæ“ä½œï¼š
   - thenCombineï¼šåˆå¹¶ä¸¤ä¸ª
   - allOfï¼šç­‰å¾…æ‰€æœ‰
   - anyOfï¼šä»»ä¸€å®Œæˆ

4. å¼‚å¸¸å¤„ç†ï¼š
   - exceptionally
   - handle
   - whenComplete

5. è·å–ç»“æœï¼š
   - getï¼šæ£€æŸ¥å¼‚å¸¸
   - joinï¼šéæ£€æŸ¥å¼‚å¸¸
   - getNowï¼šç«‹å³è·å–

6. æœ€ä½³å®è·µï¼š
   - æŒ‡å®šè‡ªå®šä¹‰çº¿ç¨‹æ± 
   - åˆç†å¤„ç†å¼‚å¸¸
   - é¿å…é˜»å¡æ“ä½œ
```

---

*æœ€åæ›´æ–°ï¼š2025-12-28*
