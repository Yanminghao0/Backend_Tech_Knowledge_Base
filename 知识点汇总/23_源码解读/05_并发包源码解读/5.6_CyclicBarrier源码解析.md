# CyclicBarrieræºç è§£æ

> å¾ªç¯å±éšœï¼Œå¤šä¸ªçº¿ç¨‹äº’ç›¸ç­‰å¾…ï¼Œåˆ°è¾¾å±éšœç‚¹åä¸€èµ·ç»§ç»­

## ğŸ“‹ ç›®å½•
- [æ•´ä½“ç»“æ„](#æ•´ä½“ç»“æ„)
- [æ ¸å¿ƒåŸç†](#æ ¸å¿ƒåŸç†)
- [æ„é€ æ–¹æ³•](#æ„é€ æ–¹æ³•)
- [awaitæ–¹æ³•](#awaitæ–¹æ³•)
- [é‡ç½®ä¸å¼‚å¸¸](#é‡ç½®ä¸å¼‚å¸¸)
- [ä½¿ç”¨åœºæ™¯](#ä½¿ç”¨åœºæ™¯)
- [é¢è¯•è¦ç‚¹](#é¢è¯•è¦ç‚¹)

---

## æ•´ä½“ç»“æ„

### ç±»å®šä¹‰

```java
public class CyclicBarrier {
    
    // ç”¨äºä¿æŠ¤å±éšœå…¥å£çš„é”
    private final ReentrantLock lock = new ReentrantLock();
    
    // ç­‰å¾…æ¡ä»¶
    private final Condition trip = lock.newCondition();
    
    // å‚ä¸çš„çº¿ç¨‹æ•°
    private final int parties;
    
    // åˆ°è¾¾å±éšœåæ‰§è¡Œçš„ä»»åŠ¡
    private final Runnable barrierCommand;
    
    // å½“å‰ä»£ï¼ˆæ¯æ¬¡é‡ç½®ågenerationä¼šæ›´æ–°ï¼‰
    private Generation generation = new Generation();
    
    // è¿˜åœ¨ç­‰å¾…çš„çº¿ç¨‹æ•°
    private int count;
    
    // ä»£ï¼Œç”¨äºæ£€æµ‹å±éšœæ˜¯å¦è¢«ç ´åæˆ–é‡ç½®
    private static class Generation {
        boolean broken = false;
    }
}

/**
 * å…³é”®ç‚¹ï¼š
 * 1. åŸºäºReentrantLock + Conditionå®ç°ï¼ˆä¸æ˜¯AQSï¼‰
 * 2. partiesè¡¨ç¤ºéœ€è¦ç­‰å¾…çš„çº¿ç¨‹æ•°
 * 3. countè¡¨ç¤ºè¿˜æœªåˆ°è¾¾çš„çº¿ç¨‹æ•°
 * 4. generationç”¨äºæ”¯æŒå¾ªç¯ä½¿ç”¨
 * 5. æ”¯æŒbarrierActionå›è°ƒ
 */
```

### å·¥ä½œåŸç†ç¤ºæ„å›¾

```
CyclicBarrier(3) - éœ€è¦3ä¸ªçº¿ç¨‹åˆ°è¾¾å±éšœ

ç¬¬ä¸€è½®ï¼š
Thread-1: await() â†’ count=2 â†’ ç­‰å¾…
Thread-2: await() â†’ count=1 â†’ ç­‰å¾…
Thread-3: await() â†’ count=0 â†’ æ‰§è¡ŒbarrierAction â†’ å”¤é†’æ‰€æœ‰ â†’ é‡ç½®count=3

ç¬¬äºŒè½®ï¼ˆå¯é‡å¤ä½¿ç”¨ï¼‰ï¼š
Thread-1: await() â†’ count=2 â†’ ç­‰å¾…
Thread-2: await() â†’ count=1 â†’ ç­‰å¾…
Thread-3: await() â†’ count=0 â†’ æ‰§è¡ŒbarrierAction â†’ å”¤é†’æ‰€æœ‰ â†’ é‡ç½®count=3

æ—¶é—´çº¿ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ T1: â”€â”€â”€â”€â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’   â”‚
â”‚ T2: â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’   â”‚
â”‚ T3: â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’   â”‚
â”‚                     â†‘                    â†‘              â”‚
â”‚                  å±éšœç‚¹1              å±éšœç‚¹2            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ ¸å¿ƒåŸç†

### ä¸CountDownLatchçš„åŒºåˆ«

```java
/**
 * CyclicBarrier vs CountDownLatch
 * 
 * CountDownLatchï¼š
 * - åŸºäºAQSå…±äº«æ¨¡å¼
 * - ä¸€æ¬¡æ€§ä½¿ç”¨ï¼Œä¸èƒ½é‡ç½®
 * - ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ç­‰å¾…å…¶ä»–çº¿ç¨‹
 * - countDown()å’Œawait()å¯ä»¥æ˜¯ä¸åŒçº¿ç¨‹
 * 
 * CyclicBarrierï¼š
 * - åŸºäºReentrantLock + Condition
 * - å¯å¾ªç¯ä½¿ç”¨
 * - å¤šä¸ªçº¿ç¨‹äº’ç›¸ç­‰å¾…
 * - åŒä¸€ä¸ªçº¿ç¨‹è°ƒç”¨await()
 * - æ”¯æŒbarrierActionå›è°ƒ
 */
```

### Generationæœºåˆ¶

```java
/**
 * Generationç”¨äºæ”¯æŒå¾ªç¯ä½¿ç”¨å’Œå¼‚å¸¸å¤„ç†
 */
private static class Generation {
    boolean broken = false;  // å±éšœæ˜¯å¦è¢«ç ´å
}

/**
 * æ¯æ¬¡å±éšœè¢«çªç ´æˆ–é‡ç½®æ—¶ï¼Œä¼šåˆ›å»ºæ–°çš„Generation
 * è¿™æ ·å¯ä»¥åŒºåˆ†ä¸åŒè½®æ¬¡çš„ç­‰å¾…
 */

// é‡ç½®æ—¶åˆ›å»ºæ–°Generation
private void nextGeneration() {
    // å”¤é†’æ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹
    trip.signalAll();
    // é‡ç½®è®¡æ•°
    count = parties;
    // åˆ›å»ºæ–°çš„ä»£
    generation = new Generation();
}

// ç ´åå±éšœ
private void breakBarrier() {
    generation.broken = true;
    count = parties;
    trip.signalAll();
}
```

---

## æ„é€ æ–¹æ³•

### åŸºæœ¬æ„é€ 

```java
/**
 * åˆ›å»ºCyclicBarrier
 * @param parties éœ€è¦ç­‰å¾…çš„çº¿ç¨‹æ•°
 */
public CyclicBarrier(int parties) {
    this(parties, null);
}

/**
 * åˆ›å»ºå¸¦å›è°ƒçš„CyclicBarrier
 * @param parties éœ€è¦ç­‰å¾…çš„çº¿ç¨‹æ•°
 * @param barrierAction æ‰€æœ‰çº¿ç¨‹åˆ°è¾¾åæ‰§è¡Œçš„ä»»åŠ¡
 */
public CyclicBarrier(int parties, Runnable barrierAction) {
    if (parties <= 0) throw new IllegalArgumentException();
    this.parties = parties;
    this.count = parties;
    this.barrierCommand = barrierAction;
}

// ä½¿ç”¨ç¤ºä¾‹
CyclicBarrier barrier = new CyclicBarrier(3);

// å¸¦å›è°ƒ
CyclicBarrier barrierWithAction = new CyclicBarrier(3, () -> {
    System.out.println("æ‰€æœ‰çº¿ç¨‹å·²åˆ°è¾¾å±éšœï¼Œå¼€å§‹ä¸‹ä¸€é˜¶æ®µ");
});
```

---

## awaitæ–¹æ³•

### await() - ç­‰å¾…æ‰€æœ‰çº¿ç¨‹åˆ°è¾¾

```java
/**
 * ç­‰å¾…æ‰€æœ‰çº¿ç¨‹åˆ°è¾¾å±éšœ
 * @return åˆ°è¾¾é¡ºåºï¼ˆ0è¡¨ç¤ºæœ€åä¸€ä¸ªåˆ°è¾¾ï¼‰
 */
public int await() throws InterruptedException, BrokenBarrierException {
    try {
        return dowait(false, 0L);
    } catch (TimeoutException toe) {
        throw new Error(toe); // ä¸ä¼šå‘ç”Ÿ
    }
}

/**
 * å¸¦è¶…æ—¶çš„ç­‰å¾…
 */
public int await(long timeout, TimeUnit unit)
        throws InterruptedException, BrokenBarrierException, TimeoutException {
    return dowait(true, unit.toNanos(timeout));
}
```

### dowait - æ ¸å¿ƒå®ç°

```java
/**
 * æ ¸å¿ƒç­‰å¾…é€»è¾‘
 */
private int dowait(boolean timed, long nanos)
        throws InterruptedException, BrokenBarrierException, TimeoutException {
    
    final ReentrantLock lock = this.lock;
    lock.lock();  // è·å–é”
    try {
        final Generation g = generation;
        
        // 1. æ£€æŸ¥å±éšœæ˜¯å¦è¢«ç ´å
        if (g.broken)
            throw new BrokenBarrierException();
        
        // 2. æ£€æŸ¥çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­
        if (Thread.interrupted()) {
            breakBarrier();  // ç ´åå±éšœ
            throw new InterruptedException();
        }
        
        // 3. è®¡æ•°å‡1
        int index = --count;
        
        // 4. å¦‚æœæ˜¯æœ€åä¸€ä¸ªåˆ°è¾¾çš„çº¿ç¨‹
        if (index == 0) {
            boolean ranAction = false;
            try {
                // æ‰§è¡ŒbarrierAction
                final Runnable command = barrierCommand;
                if (command != null)
                    command.run();
                ranAction = true;
                // è¿›å…¥ä¸‹ä¸€ä»£ï¼Œå”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹
                nextGeneration();
                return 0;
            } finally {
                if (!ranAction)
                    breakBarrier();  // barrierActionå¼‚å¸¸ï¼Œç ´åå±éšœ
            }
        }
        
        // 5. ä¸æ˜¯æœ€åä¸€ä¸ªï¼Œå¾ªç¯ç­‰å¾…
        for (;;) {
            try {
                if (!timed)
                    trip.await();  // æ— é™ç­‰å¾…
                else if (nanos > 0L)
                    nanos = trip.awaitNanos(nanos);  // è¶…æ—¶ç­‰å¾…
            } catch (InterruptedException ie) {
                // è¢«ä¸­æ–­
                if (g == generation && !g.broken) {
                    breakBarrier();
                    throw ie;
                } else {
                    Thread.currentThread().interrupt();
                }
            }
            
            // è¢«å”¤é†’åæ£€æŸ¥
            if (g.broken)
                throw new BrokenBarrierException();
            
            if (g != generation)
                return index;  // æ­£å¸¸è¿”å›
            
            if (timed && nanos <= 0L) {
                breakBarrier();
                throw new TimeoutException();
            }
        }
    } finally {
        lock.unlock();
    }
}
```

### awaitæ‰§è¡Œæµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    await()è°ƒç”¨                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    è·å–locké”                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æ£€æŸ¥å±éšœæ˜¯å¦broken/çº¿ç¨‹æ˜¯å¦ä¸­æ–­              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    count--                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   count == 0        â”‚   â”‚   count > 0         â”‚
â”‚   (æœ€åä¸€ä¸ªåˆ°è¾¾)     â”‚   â”‚   (ä¸æ˜¯æœ€åä¸€ä¸ª)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                       â”‚
              â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ‰§è¡ŒbarrierAction   â”‚   â”‚ trip.await()ç­‰å¾…    â”‚
â”‚ nextGeneration()    â”‚   â”‚ è¢«å”¤é†’åè¿”å›        â”‚
â”‚ å”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹     â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## é‡ç½®ä¸å¼‚å¸¸

### reset() - é‡ç½®å±éšœ

```java
/**
 * é‡ç½®å±éšœåˆ°åˆå§‹çŠ¶æ€
 * ä¼šç ´åå½“å‰ä»£ï¼Œå”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹ï¼ˆæŠ›å‡ºBrokenBarrierExceptionï¼‰
 */
public void reset() {
    final ReentrantLock lock = this.lock;
    lock.lock();
    try {
        breakBarrier();   // ç ´åå½“å‰ä»£
        nextGeneration(); // å¼€å§‹æ–°çš„ä¸€ä»£
    } finally {
        lock.unlock();
    }
}
```

### BrokenBarrierException

```java
/**
 * å±éšœè¢«ç ´åæ—¶æŠ›å‡ºçš„å¼‚å¸¸
 * 
 * è§¦å‘æ¡ä»¶ï¼š
 * 1. æŸä¸ªç­‰å¾…çº¿ç¨‹è¢«ä¸­æ–­
 * 2. æŸä¸ªç­‰å¾…çº¿ç¨‹è¶…æ—¶
 * 3. barrierActionæŠ›å‡ºå¼‚å¸¸
 * 4. è°ƒç”¨reset()æ–¹æ³•
 */
public class BrokenBarrierException extends Exception {
    public BrokenBarrierException() {}
    public BrokenBarrierException(String message) {
        super(message);
    }
}

// å¤„ç†ç¤ºä¾‹
try {
    barrier.await();
} catch (InterruptedException e) {
    // çº¿ç¨‹è¢«ä¸­æ–­
} catch (BrokenBarrierException e) {
    // å±éšœè¢«ç ´å
}
```

### isBroken() - æ£€æŸ¥å±éšœçŠ¶æ€

```java
/**
 * æ£€æŸ¥å±éšœæ˜¯å¦è¢«ç ´å
 */
public boolean isBroken() {
    final ReentrantLock lock = this.lock;
    lock.lock();
    try {
        return generation.broken;
    } finally {
        lock.unlock();
    }
}
```

---

## å…¶ä»–æ–¹æ³•

### getParties() - è·å–å‚ä¸çº¿ç¨‹æ•°

```java
public int getParties() {
    return parties;
}
```

### getNumberWaiting() - è·å–ç­‰å¾…çº¿ç¨‹æ•°

```java
/**
 * è·å–å½“å‰æ­£åœ¨ç­‰å¾…çš„çº¿ç¨‹æ•°
 */
public int getNumberWaiting() {
    final ReentrantLock lock = this.lock;
    lock.lock();
    try {
        return parties - count;
    } finally {
        lock.unlock();
    }
}
```

---

## ä½¿ç”¨åœºæ™¯

### åœºæ™¯1ï¼šå¤šçº¿ç¨‹åˆ†é˜¶æ®µä»»åŠ¡

```java
/**
 * å¤šçº¿ç¨‹åˆ†é˜¶æ®µæ‰§è¡Œä»»åŠ¡
 * æ¯ä¸ªé˜¶æ®µæ‰€æœ‰çº¿ç¨‹éƒ½å®Œæˆåæ‰è¿›å…¥ä¸‹ä¸€é˜¶æ®µ
 */
public class MultiPhaseTask {
    public static void main(String[] args) {
        int threadCount = 3;
        CyclicBarrier barrier = new CyclicBarrier(threadCount, () -> {
            System.out.println("=== æ‰€æœ‰çº¿ç¨‹å®Œæˆå½“å‰é˜¶æ®µ ===\n");
        });
        
        for (int i = 0; i < threadCount; i++) {
            final int threadId = i;
            new Thread(() -> {
                try {
                    // é˜¶æ®µ1ï¼šæ•°æ®å‡†å¤‡
                    System.out.println("çº¿ç¨‹" + threadId + " å®Œæˆæ•°æ®å‡†å¤‡");
                    barrier.await();
                    
                    // é˜¶æ®µ2ï¼šæ•°æ®å¤„ç†
                    System.out.println("çº¿ç¨‹" + threadId + " å®Œæˆæ•°æ®å¤„ç†");
                    barrier.await();
                    
                    // é˜¶æ®µ3ï¼šç»“æœæ±‡æ€»
                    System.out.println("çº¿ç¨‹" + threadId + " å®Œæˆç»“æœæ±‡æ€»");
                    barrier.await();
                    
                    System.out.println("çº¿ç¨‹" + threadId + " å…¨éƒ¨å®Œæˆ");
                } catch (Exception e) {
                    e.printStackTrace();
                }
            }).start();
        }
    }
}

// è¾“å‡ºç¤ºä¾‹ï¼š
// çº¿ç¨‹0 å®Œæˆæ•°æ®å‡†å¤‡
// çº¿ç¨‹1 å®Œæˆæ•°æ®å‡†å¤‡
// çº¿ç¨‹2 å®Œæˆæ•°æ®å‡†å¤‡
// === æ‰€æœ‰çº¿ç¨‹å®Œæˆå½“å‰é˜¶æ®µ ===
// çº¿ç¨‹0 å®Œæˆæ•°æ®å¤„ç†
// ...
```

### åœºæ™¯2ï¼šå¹¶è¡Œè®¡ç®—

```java
/**
 * å¹¶è¡Œè®¡ç®—çŸ©é˜µ
 * æ¯è¡Œç”±ä¸€ä¸ªçº¿ç¨‹è®¡ç®—ï¼Œæ‰€æœ‰è¡Œè®¡ç®—å®Œæˆåæ±‡æ€»
 */
public class ParallelMatrixCompute {
    private final int[][] matrix;
    private final int[] rowSums;
    private final CyclicBarrier barrier;
    
    public ParallelMatrixCompute(int[][] matrix) {
        this.matrix = matrix;
        this.rowSums = new int[matrix.length];
        this.barrier = new CyclicBarrier(matrix.length, () -> {
            // æ‰€æœ‰è¡Œè®¡ç®—å®Œæˆåï¼Œè®¡ç®—æ€»å’Œ
            int total = 0;
            for (int sum : rowSums) {
                total += sum;
            }
            System.out.println("çŸ©é˜µæ€»å’Œ: " + total);
        });
    }
    
    public void compute() {
        for (int i = 0; i < matrix.length; i++) {
            final int row = i;
            new Thread(() -> {
                // è®¡ç®—å½“å‰è¡Œçš„å’Œ
                int sum = 0;
                for (int val : matrix[row]) {
                    sum += val;
                }
                rowSums[row] = sum;
                System.out.println("ç¬¬" + row + "è¡Œå’Œ: " + sum);
                
                try {
                    barrier.await();
                } catch (Exception e) {
                    e.printStackTrace();
                }
            }).start();
        }
    }
    
    public static void main(String[] args) {
        int[][] matrix = {
            {1, 2, 3},
            {4, 5, 6},
            {7, 8, 9}
        };
        new ParallelMatrixCompute(matrix).compute();
    }
}
```

### åœºæ™¯3ï¼šæ¨¡æ‹Ÿèµ›è·‘

```java
/**
 * æ¨¡æ‹Ÿèµ›è·‘ï¼šæ‰€æœ‰é€‰æ‰‹å‡†å¤‡å¥½ååŒæ—¶èµ·è·‘
 */
public class Race {
    public static void main(String[] args) {
        int runnerCount = 5;
        CyclicBarrier startBarrier = new CyclicBarrier(runnerCount, () -> {
            System.out.println("æ‰€æœ‰é€‰æ‰‹å°±ä½ï¼Œæ¯”èµ›å¼€å§‹ï¼");
        });
        CyclicBarrier finishBarrier = new CyclicBarrier(runnerCount, () -> {
            System.out.println("æ‰€æœ‰é€‰æ‰‹å®Œæˆæ¯”èµ›ï¼");
        });
        
        for (int i = 0; i < runnerCount; i++) {
            final int runnerId = i + 1;
            new Thread(() -> {
                try {
                    // å‡†å¤‡é˜¶æ®µ
                    Thread.sleep((long) (Math.random() * 1000));
                    System.out.println("é€‰æ‰‹" + runnerId + " å‡†å¤‡å°±ç»ª");
                    startBarrier.await();  // ç­‰å¾…æ‰€æœ‰é€‰æ‰‹å‡†å¤‡å¥½
                    
                    // æ¯”èµ›é˜¶æ®µ
                    Thread.sleep((long) (Math.random() * 2000));
                    System.out.println("é€‰æ‰‹" + runnerId + " åˆ°è¾¾ç»ˆç‚¹");
                    finishBarrier.await();  // ç­‰å¾…æ‰€æœ‰é€‰æ‰‹å®Œæˆ
                    
                } catch (Exception e) {
                    e.printStackTrace();
                }
            }).start();
        }
    }
}
```

### åœºæ™¯4ï¼šæ•°æ®åŠ è½½ä¸å¤„ç†

```java
/**
 * å¤šæ•°æ®æºåŠ è½½ï¼Œå…¨éƒ¨åŠ è½½å®Œæˆåå¤„ç†
 */
public class DataLoader {
    private final CyclicBarrier barrier;
    private final Map<String, Object> dataMap = new ConcurrentHashMap<>();
    
    public DataLoader() {
        this.barrier = new CyclicBarrier(3, () -> {
            // æ‰€æœ‰æ•°æ®åŠ è½½å®Œæˆï¼Œå¼€å§‹å¤„ç†
            processData();
        });
    }
    
    public void loadFromDatabase() {
        new Thread(() -> {
            try {
                System.out.println("ä»æ•°æ®åº“åŠ è½½æ•°æ®...");
                Thread.sleep(1000);
                dataMap.put("database", "DBæ•°æ®");
                System.out.println("æ•°æ®åº“æ•°æ®åŠ è½½å®Œæˆ");
                barrier.await();
            } catch (Exception e) {
                e.printStackTrace();
            }
        }).start();
    }
    
    public void loadFromFile() {
        new Thread(() -> {
            try {
                System.out.println("ä»æ–‡ä»¶åŠ è½½æ•°æ®...");
                Thread.sleep(1500);
                dataMap.put("file", "æ–‡ä»¶æ•°æ®");
                System.out.println("æ–‡ä»¶æ•°æ®åŠ è½½å®Œæˆ");
                barrier.await();
            } catch (Exception e) {
                e.printStackTrace();
            }
        }).start();
    }
    
    public void loadFromNetwork() {
        new Thread(() -> {
            try {
                System.out.println("ä»ç½‘ç»œåŠ è½½æ•°æ®...");
                Thread.sleep(2000);
                dataMap.put("network", "ç½‘ç»œæ•°æ®");
                System.out.println("ç½‘ç»œæ•°æ®åŠ è½½å®Œæˆ");
                barrier.await();
            } catch (Exception e) {
                e.printStackTrace();
            }
        }).start();
    }
    
    private void processData() {
        System.out.println("æ‰€æœ‰æ•°æ®åŠ è½½å®Œæˆï¼Œå¼€å§‹å¤„ç†: " + dataMap);
    }
    
    public static void main(String[] args) {
        DataLoader loader = new DataLoader();
        loader.loadFromDatabase();
        loader.loadFromFile();
        loader.loadFromNetwork();
    }
}
```

---

## é¢è¯•è¦ç‚¹

### 1. CyclicBarrieråŸç†

```
Q: CyclicBarrierçš„å®ç°åŸç†ï¼Ÿ

A:
åŸºäºReentrantLock + Conditionå®ç°ï¼š

1. ä½¿ç”¨ReentrantLockä¿æŠ¤å…±äº«å˜é‡
2. ä½¿ç”¨Conditionå®ç°çº¿ç¨‹ç­‰å¾…/å”¤é†’
3. countè®°å½•è¿˜æœªåˆ°è¾¾çš„çº¿ç¨‹æ•°
4. æ¯ä¸ªçº¿ç¨‹è°ƒç”¨await()æ—¶count--
5. æœ€åä¸€ä¸ªçº¿ç¨‹ï¼ˆcount=0ï¼‰ï¼š
   - æ‰§è¡ŒbarrierAction
   - è°ƒç”¨nextGeneration()é‡ç½®
   - signalAll()å”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹
6. å…¶ä»–çº¿ç¨‹åœ¨Conditionä¸Šç­‰å¾…
```

### 2. CyclicBarrier vs CountDownLatch

```
Q: CyclicBarrierå’ŒCountDownLatchçš„åŒºåˆ«ï¼Ÿ

A:
| å¯¹æ¯”é¡¹ | CyclicBarrier | CountDownLatch |
|--------|---------------|----------------|
| å®ç°æ–¹å¼ | ReentrantLock+Condition | AQSå…±äº«æ¨¡å¼ |
| é‡ç”¨æ€§ | å¯é‡å¤ä½¿ç”¨ | ä¸€æ¬¡æ€§ |
| ç­‰å¾…æ–¹å¼ | çº¿ç¨‹äº’ç›¸ç­‰å¾… | ç­‰å¾…å…¶ä»–çº¿ç¨‹ |
| è®¡æ•°æ–¹å¼ | é€’å‡åˆ°0åé‡ç½® | é€’å‡åˆ°0åç»“æŸ |
| å›è°ƒ | æ”¯æŒbarrierAction | ä¸æ”¯æŒ |
| å¼‚å¸¸ä¼ æ’­ | ä¸€ä¸ªå¼‚å¸¸ï¼Œå…¨éƒ¨å¼‚å¸¸ | ç‹¬ç«‹ |

ä½¿ç”¨åœºæ™¯ï¼š
- CyclicBarrierï¼šå¤šçº¿ç¨‹åˆ†é˜¶æ®µä»»åŠ¡ï¼Œéœ€è¦äº’ç›¸ç­‰å¾…
- CountDownLatchï¼šä¸»çº¿ç¨‹ç­‰å¾…å¤šä¸ªå·¥ä½œçº¿ç¨‹å®Œæˆ
```

### 3. Generationçš„ä½œç”¨

```
Q: CyclicBarrierä¸­Generationçš„ä½œç”¨ï¼Ÿ

A:
Generationç”¨äºæ”¯æŒå¾ªç¯ä½¿ç”¨å’Œå¼‚å¸¸å¤„ç†ï¼š

1. æ ‡è¯†å½“å‰"ä»£"ï¼š
   - æ¯æ¬¡å±éšœè¢«çªç ´ååˆ›å»ºæ–°Generation
   - çº¿ç¨‹å¯ä»¥åˆ¤æ–­æ˜¯å¦æ˜¯åŒä¸€è½®ç­‰å¾…

2. è®°å½•å±éšœçŠ¶æ€ï¼š
   - brokenå­—æ®µæ ‡è¯†å±éšœæ˜¯å¦è¢«ç ´å
   - è¢«ç ´ååæ‰€æœ‰ç­‰å¾…çº¿ç¨‹æŠ›å‡ºBrokenBarrierException

3. æ”¯æŒresetï¼š
   - reset()ä¼šç ´åå½“å‰ä»£ï¼Œåˆ›å»ºæ–°ä»£
   - ç­‰å¾…ä¸­çš„çº¿ç¨‹ä¼šæ”¶åˆ°å¼‚å¸¸
```

### 4. barrierActionæ‰§è¡Œæ—¶æœº

```
Q: barrierActionåœ¨ä»€ä¹ˆæ—¶å€™æ‰§è¡Œï¼Ÿç”±å“ªä¸ªçº¿ç¨‹æ‰§è¡Œï¼Ÿ

A:
æ‰§è¡Œæ—¶æœºï¼š
- æœ€åä¸€ä¸ªåˆ°è¾¾å±éšœçš„çº¿ç¨‹æ‰§è¡Œ
- åœ¨å”¤é†’å…¶ä»–çº¿ç¨‹ä¹‹å‰æ‰§è¡Œ

æ‰§è¡Œçº¿ç¨‹ï¼š
- æœ€åä¸€ä¸ªè°ƒç”¨await()çš„çº¿ç¨‹
- ä¸æ˜¯å•ç‹¬çš„çº¿ç¨‹

æ³¨æ„äº‹é¡¹ï¼š
- barrierActionåº”è¯¥å¿«é€Ÿæ‰§è¡Œ
- å¦‚æœæŠ›å‡ºå¼‚å¸¸ï¼Œå±éšœä¼šè¢«ç ´å
- æ‰€æœ‰ç­‰å¾…çº¿ç¨‹éƒ½ä¼šæ”¶åˆ°BrokenBarrierException
```

### 5. å±éšœè¢«ç ´åçš„æƒ…å†µ

```
Q: ä»€ä¹ˆæƒ…å†µä¸‹CyclicBarrierä¼šè¢«ç ´åï¼Ÿ

A:
1. ç­‰å¾…çº¿ç¨‹è¢«ä¸­æ–­ï¼š
   - æŸä¸ªawait()çš„çº¿ç¨‹è¢«interrupt()
   - è¯¥çº¿ç¨‹æŠ›å‡ºInterruptedException
   - å…¶ä»–çº¿ç¨‹æŠ›å‡ºBrokenBarrierException

2. ç­‰å¾…è¶…æ—¶ï¼š
   - await(timeout)è¶…æ—¶
   - è¯¥çº¿ç¨‹æŠ›å‡ºTimeoutException
   - å…¶ä»–çº¿ç¨‹æŠ›å‡ºBrokenBarrierException

3. barrierActionå¼‚å¸¸ï¼š
   - barrierActionæ‰§è¡Œæ—¶æŠ›å‡ºå¼‚å¸¸
   - æ‰€æœ‰çº¿ç¨‹æŠ›å‡ºBrokenBarrierException

4. è°ƒç”¨reset()ï¼š
   - ä¸»åŠ¨é‡ç½®å±éšœ
   - ç­‰å¾…ä¸­çš„çº¿ç¨‹æŠ›å‡ºBrokenBarrierException
```

---

## ğŸ’¡ æ€»ç»“

```
CyclicBarrieræ ¸å¿ƒè¦ç‚¹ï¼š

1. å®ç°åŸç†ï¼š
   - åŸºäºReentrantLock + Condition
   - countè®°å½•æœªåˆ°è¾¾çº¿ç¨‹æ•°
   - Generationæ”¯æŒå¾ªç¯ä½¿ç”¨

2. ç‰¹ç‚¹ï¼š
   - å¯å¾ªç¯ä½¿ç”¨
   - çº¿ç¨‹äº’ç›¸ç­‰å¾…
   - æ”¯æŒbarrierActionå›è°ƒ
   - å¼‚å¸¸ä¼šä¼ æ’­åˆ°æ‰€æœ‰çº¿ç¨‹

3. æ ¸å¿ƒæ–¹æ³•ï¼š
   - await()ï¼šç­‰å¾…æ‰€æœ‰çº¿ç¨‹åˆ°è¾¾
   - reset()ï¼šé‡ç½®å±éšœ
   - isBroken()ï¼šæ£€æŸ¥å±éšœçŠ¶æ€

4. ä½¿ç”¨åœºæ™¯ï¼š
   - å¤šçº¿ç¨‹åˆ†é˜¶æ®µä»»åŠ¡
   - å¹¶è¡Œè®¡ç®—æ±‡æ€»
   - æ¨¡æ‹Ÿå¹¶å‘åœºæ™¯
   - å¤šæ•°æ®æºåŠ è½½

5. vs CountDownLatchï¼š
   - CyclicBarrierï¼šå¯é‡ç”¨ï¼Œäº’ç›¸ç­‰å¾…
   - CountDownLatchï¼šä¸€æ¬¡æ€§ï¼Œç­‰å¾…å…¶ä»–çº¿ç¨‹

6. æ³¨æ„äº‹é¡¹ï¼š
   - barrierActionè¦å¿«é€Ÿæ‰§è¡Œ
   - å¤„ç†BrokenBarrierException
   - è€ƒè™‘è¶…æ—¶è®¾ç½®
```

---

*æœ€åæ›´æ–°ï¼š2025-12-28*
