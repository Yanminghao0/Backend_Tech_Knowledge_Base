# CountDownLatchæºç è§£æ

> å€’è®¡æ—¶é—¨é—©ï¼Œä¸€æ¬¡æ€§åŒæ­¥å·¥å…·ï¼Œç­‰å¾…å¤šä¸ªçº¿ç¨‹å®Œæˆ

## ğŸ“‹ ç›®å½•
- [æ•´ä½“ç»“æ„](#æ•´ä½“ç»“æ„)
- [æ ¸å¿ƒåŸç†](#æ ¸å¿ƒåŸç†)
- [æ„é€ æ–¹æ³•](#æ„é€ æ–¹æ³•)
- [awaitæ–¹æ³•](#awaitæ–¹æ³•)
- [countDownæ–¹æ³•](#countdownæ–¹æ³•)
- [ä½¿ç”¨åœºæ™¯](#ä½¿ç”¨åœºæ™¯)
- [é¢è¯•è¦ç‚¹](#é¢è¯•è¦ç‚¹)

---

## æ•´ä½“ç»“æ„

### ç±»å®šä¹‰

```java
public class CountDownLatch {
    
    // å†…éƒ¨åŒæ­¥å™¨ï¼Œç»§æ‰¿AQS
    private static final class Sync extends AbstractQueuedSynchronizer {
        
        Sync(int count) {
            setState(count);  // åˆå§‹åŒ–è®¡æ•°å™¨
        }
        
        int getCount() {
            return getState();
        }
        
        // å°è¯•è·å–å…±äº«é”ï¼ˆawaitæ—¶è°ƒç”¨ï¼‰
        protected int tryAcquireShared(int acquires) {
            return (getState() == 0) ? 1 : -1;
        }
        
        // å°è¯•é‡Šæ”¾å…±äº«é”ï¼ˆcountDownæ—¶è°ƒç”¨ï¼‰
        protected boolean tryReleaseShared(int releases) {
            for (;;) {
                int c = getState();
                if (c == 0)
                    return false;
                int nextc = c - 1;
                if (compareAndSetState(c, nextc))
                    return nextc == 0;
            }
        }
    }
    
    private final Sync sync;
}

/**
 * å…³é”®ç‚¹ï¼š
 * 1. åŸºäºAQSçš„å…±äº«æ¨¡å¼å®ç°
 * 2. stateè¡¨ç¤ºè®¡æ•°å™¨
 * 3. awaitç­‰å¾…stateå˜ä¸º0
 * 4. countDownå°†stateå‡1
 * 5. ä¸€æ¬¡æ€§ä½¿ç”¨ï¼Œä¸èƒ½é‡ç½®
 */
```

### å·¥ä½œåŸç†ç¤ºæ„å›¾

```
åˆå§‹çŠ¶æ€ï¼šcount = 3

Thread-1: await() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ ç»§ç»­æ‰§è¡Œ
Thread-2: await() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ ç»§ç»­æ‰§è¡Œ
                    â†‘                                    â†‘
                    â”‚                                    â”‚
Worker-1: countDown() â”€â”                                 â”‚
Worker-2: countDown() â”€â”¼â”€â†’ count=0 æ—¶å”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹ â”€â”€â”€â”˜
Worker-3: countDown() â”€â”˜

æ—¶é—´çº¿ï¼š
count=3 â†’ count=2 â†’ count=1 â†’ count=0 â†’ å”¤é†’ç­‰å¾…çº¿ç¨‹
```

---

## æ ¸å¿ƒåŸç†

### AQSå…±äº«æ¨¡å¼

```java
/**
 * CountDownLatchä½¿ç”¨AQSçš„å…±äº«æ¨¡å¼
 * 
 * stateçš„å«ä¹‰ï¼š
 * - state > 0ï¼šè¿˜æœ‰ä»»åŠ¡æœªå®Œæˆï¼Œawaitéœ€è¦ç­‰å¾…
 * - state = 0ï¼šæ‰€æœ‰ä»»åŠ¡å®Œæˆï¼Œawaitå¯ä»¥é€šè¿‡
 * 
 * ä¸ç‹¬å æ¨¡å¼çš„åŒºåˆ«ï¼š
 * - ç‹¬å æ¨¡å¼ï¼šåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½è·å–é”
 * - å…±äº«æ¨¡å¼ï¼šå¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶è·å–é”
 */

// tryAcquireSharedè¿”å›å€¼å«ä¹‰ï¼š
// < 0ï¼šè·å–å¤±è´¥ï¼Œéœ€è¦æ’é˜Ÿç­‰å¾…
// = 0ï¼šè·å–æˆåŠŸï¼Œä½†åç»­çº¿ç¨‹ä¸èƒ½è·å–
// > 0ï¼šè·å–æˆåŠŸï¼Œåç»­çº¿ç¨‹ä¹Ÿå¯èƒ½è·å–æˆåŠŸ

protected int tryAcquireShared(int acquires) {
    return (getState() == 0) ? 1 : -1;
    // state=0è¿”å›1ï¼ˆæˆåŠŸï¼‰ï¼Œå¦åˆ™è¿”å›-1ï¼ˆå¤±è´¥ï¼‰
}
```

### çŠ¶æ€è½¬æ¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CountDownLatch                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  state = N (åˆå§‹è®¡æ•°)                                â”‚
â”‚                                                      â”‚
â”‚  countDown() â†’ state = N-1                          â”‚
â”‚  countDown() â†’ state = N-2                          â”‚
â”‚  ...                                                 â”‚
â”‚  countDown() â†’ state = 0 â†’ å”¤é†’æ‰€æœ‰awaitçš„çº¿ç¨‹      â”‚
â”‚                                                      â”‚
â”‚  æ³¨æ„ï¼šstateå˜ä¸º0åä¸èƒ½é‡ç½®                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ„é€ æ–¹æ³•

```java
/**
 * åˆ›å»ºCountDownLatch
 * @param count è®¡æ•°å™¨åˆå§‹å€¼ï¼Œå¿…é¡»>=0
 */
public CountDownLatch(int count) {
    if (count < 0) throw new IllegalArgumentException("count < 0");
    this.sync = new Sync(count);
}

// Syncæ„é€ æ–¹æ³•
Sync(int count) {
    setState(count);  // è®¾ç½®AQSçš„state
}

// ä½¿ç”¨ç¤ºä¾‹
CountDownLatch latch = new CountDownLatch(3);
// éœ€è¦3æ¬¡countDownæ‰èƒ½å”¤é†’awaitçš„çº¿ç¨‹
```

---

## awaitæ–¹æ³•

### await() - æ— é™ç­‰å¾…

```java
/**
 * ç­‰å¾…è®¡æ•°å™¨å˜ä¸º0
 * å¦‚æœå½“å‰è®¡æ•°å™¨å·²ç»æ˜¯0ï¼Œç«‹å³è¿”å›
 * å¦åˆ™é˜»å¡ç›´åˆ°ï¼š
 * 1. è®¡æ•°å™¨å˜ä¸º0
 * 2. çº¿ç¨‹è¢«ä¸­æ–­
 */
public void await() throws InterruptedException {
    sync.acquireSharedInterruptibly(1);
}

// AQS.acquireSharedInterruptibly
public final void acquireSharedInterruptibly(int arg)
        throws InterruptedException {
    if (Thread.interrupted())
        throw new InterruptedException();
    if (tryAcquireShared(arg) < 0)  // state != 0ï¼Œè·å–å¤±è´¥
        doAcquireSharedInterruptibly(arg);  // è¿›å…¥ç­‰å¾…é˜Ÿåˆ—
}

// Sync.tryAcquireShared
protected int tryAcquireShared(int acquires) {
    return (getState() == 0) ? 1 : -1;
    // state=0è¿”å›1ï¼ˆæˆåŠŸï¼Œä¸é˜»å¡ï¼‰
    // state!=0è¿”å›-1ï¼ˆå¤±è´¥ï¼Œéœ€è¦é˜»å¡ï¼‰
}
```

### await(timeout) - è¶…æ—¶ç­‰å¾…

```java
/**
 * å¸¦è¶…æ—¶çš„ç­‰å¾…
 * @return true-è®¡æ•°å™¨å˜ä¸º0ï¼Œfalse-è¶…æ—¶
 */
public boolean await(long timeout, TimeUnit unit)
        throws InterruptedException {
    return sync.tryAcquireSharedNanos(1, unit.toNanos(timeout));
}

// ä½¿ç”¨ç¤ºä¾‹
boolean success = latch.await(10, TimeUnit.SECONDS);
if (!success) {
    System.out.println("ç­‰å¾…è¶…æ—¶");
}
```

### doAcquireSharedInterruptibly - ç­‰å¾…é˜Ÿåˆ—

```java
/**
 * è¿›å…¥ç­‰å¾…é˜Ÿåˆ—å¹¶é˜»å¡
 */
private void doAcquireSharedInterruptibly(int arg)
        throws InterruptedException {
    // 1. åˆ›å»ºå…±äº«æ¨¡å¼èŠ‚ç‚¹ï¼ŒåŠ å…¥ç­‰å¾…é˜Ÿåˆ—
    final Node node = addWaiter(Node.SHARED);
    boolean failed = true;
    try {
        for (;;) {
            final Node p = node.predecessor();
            if (p == head) {
                // 2. å¦‚æœå‰é©±æ˜¯headï¼Œå°è¯•è·å–
                int r = tryAcquireShared(arg);
                if (r >= 0) {
                    // 3. è·å–æˆåŠŸï¼Œè®¾ç½®headå¹¶ä¼ æ’­å”¤é†’
                    setHeadAndPropagate(node, r);
                    p.next = null;
                    failed = false;
                    return;
                }
            }
            // 4. è·å–å¤±è´¥ï¼Œé˜»å¡ç­‰å¾…
            if (shouldParkAfterFailedAcquire(p, node) &&
                parkAndCheckInterrupt())
                throw new InterruptedException();
        }
    } finally {
        if (failed)
            cancelAcquire(node);
    }
}
```

---

## countDownæ–¹æ³•

```java
/**
 * è®¡æ•°å™¨å‡1
 * å¦‚æœå‡åˆ°0ï¼Œå”¤é†’æ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹
 */
public void countDown() {
    sync.releaseShared(1);
}

// AQS.releaseShared
public final boolean releaseShared(int arg) {
    if (tryReleaseShared(arg)) {  // å°è¯•é‡Šæ”¾
        doReleaseShared();  // é‡Šæ”¾æˆåŠŸï¼Œå”¤é†’ç­‰å¾…çº¿ç¨‹
        return true;
    }
    return false;
}

// Sync.tryReleaseShared
protected boolean tryReleaseShared(int releases) {
    for (;;) {
        int c = getState();
        if (c == 0)
            return false;  // å·²ç»æ˜¯0ï¼Œä¸éœ€è¦é‡Šæ”¾
        int nextc = c - 1;
        if (compareAndSetState(c, nextc))  // CASå‡1
            return nextc == 0;  // å‡åˆ°0è¿”å›trueï¼Œè§¦å‘å”¤é†’
    }
}
```

### doReleaseShared - å”¤é†’ç­‰å¾…çº¿ç¨‹

```java
/**
 * å”¤é†’ç­‰å¾…é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹
 * å…±äº«æ¨¡å¼ä¸‹ä¼šä¼ æ’­å”¤é†’
 */
private void doReleaseShared() {
    for (;;) {
        Node h = head;
        if (h != null && h != tail) {
            int ws = h.waitStatus;
            if (ws == Node.SIGNAL) {
                if (!compareAndSetWaitStatus(h, Node.SIGNAL, 0))
                    continue;
                unparkSuccessor(h);  // å”¤é†’åç»§èŠ‚ç‚¹
            }
            else if (ws == 0 &&
                     !compareAndSetWaitStatus(h, 0, Node.PROPAGATE))
                continue;
        }
        if (h == head)
            break;
    }
}
```

---

## å…¶ä»–æ–¹æ³•

### getCount()

```java
/**
 * è·å–å½“å‰è®¡æ•°å€¼
 * ä¸»è¦ç”¨äºè°ƒè¯•å’Œæµ‹è¯•
 */
public long getCount() {
    return sync.getCount();
}

int getCount() {
    return getState();
}

// ä½¿ç”¨ç¤ºä¾‹
System.out.println("å‰©ä½™è®¡æ•°: " + latch.getCount());
```

---

## ä½¿ç”¨åœºæ™¯

### åœºæ™¯1ï¼šç­‰å¾…å¤šä¸ªä»»åŠ¡å®Œæˆ

```java
/**
 * ä¸»çº¿ç¨‹ç­‰å¾…å¤šä¸ªå·¥ä½œçº¿ç¨‹å®Œæˆ
 */
public class WaitForWorkersExample {
    public static void main(String[] args) throws InterruptedException {
        int workerCount = 5;
        CountDownLatch latch = new CountDownLatch(workerCount);
        
        // å¯åŠ¨å¤šä¸ªå·¥ä½œçº¿ç¨‹
        for (int i = 0; i < workerCount; i++) {
            final int workerId = i;
            new Thread(() -> {
                try {
                    // æ¨¡æ‹Ÿå·¥ä½œ
                    Thread.sleep((long) (Math.random() * 1000));
                    System.out.println("Worker " + workerId + " å®Œæˆ");
                } catch (InterruptedException e) {
                    Thread.currentThread().interrupt();
                } finally {
                    latch.countDown();  // å®Œæˆåè®¡æ•°å‡1
                }
            }).start();
        }
        
        // ä¸»çº¿ç¨‹ç­‰å¾…æ‰€æœ‰å·¥ä½œçº¿ç¨‹å®Œæˆ
        System.out.println("ç­‰å¾…æ‰€æœ‰Workerå®Œæˆ...");
        latch.await();
        System.out.println("æ‰€æœ‰Workerå·²å®Œæˆï¼");
    }
}
```

### åœºæ™¯2ï¼šå¤šçº¿ç¨‹åŒæ—¶å¼€å§‹

```java
/**
 * å¤šä¸ªçº¿ç¨‹åŒæ—¶å¼€å§‹æ‰§è¡Œï¼ˆå‘ä»¤æªï¼‰
 */
public class StartTogetherExample {
    public static void main(String[] args) throws InterruptedException {
        int threadCount = 5;
        CountDownLatch startSignal = new CountDownLatch(1);  // å‘ä»¤æª
        CountDownLatch doneSignal = new CountDownLatch(threadCount);  // å®Œæˆä¿¡å·
        
        // åˆ›å»ºå¤šä¸ªçº¿ç¨‹
        for (int i = 0; i < threadCount; i++) {
            final int threadId = i;
            new Thread(() -> {
                try {
                    System.out.println("Thread " + threadId + " å‡†å¤‡å°±ç»ª");
                    startSignal.await();  // ç­‰å¾…å‘ä»¤æª
                    
                    // åŒæ—¶å¼€å§‹æ‰§è¡Œ
                    System.out.println("Thread " + threadId + " å¼€å§‹æ‰§è¡Œ");
                    Thread.sleep((long) (Math.random() * 1000));
                    System.out.println("Thread " + threadId + " æ‰§è¡Œå®Œæˆ");
                } catch (InterruptedException e) {
                    Thread.currentThread().interrupt();
                } finally {
                    doneSignal.countDown();
                }
            }).start();
        }
        
        Thread.sleep(1000);  // ç­‰å¾…æ‰€æœ‰çº¿ç¨‹å‡†å¤‡å°±ç»ª
        System.out.println("å‘ä»¤ï¼");
        startSignal.countDown();  // å‘ä»¤
        
        doneSignal.await();  // ç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆ
        System.out.println("æ‰€æœ‰çº¿ç¨‹æ‰§è¡Œå®Œæˆï¼");
    }
}
```

### åœºæ™¯3ï¼šå¹¶è¡Œè®¡ç®—æ±‡æ€»

```java
/**
 * å¹¶è¡Œè®¡ç®—ï¼Œæ±‡æ€»ç»“æœ
 */
public class ParallelComputeExample {
    public static void main(String[] args) throws InterruptedException {
        int[] data = {1, 2, 3, 4, 5, 6, 7, 8, 9, 10};
        int threadCount = 2;
        int chunkSize = data.length / threadCount;
        
        CountDownLatch latch = new CountDownLatch(threadCount);
        int[] results = new int[threadCount];
        
        for (int i = 0; i < threadCount; i++) {
            final int threadId = i;
            final int start = i * chunkSize;
            final int end = (i == threadCount - 1) ? data.length : start + chunkSize;
            
            new Thread(() -> {
                int sum = 0;
                for (int j = start; j < end; j++) {
                    sum += data[j];
                }
                results[threadId] = sum;
                System.out.println("Thread " + threadId + " è®¡ç®—ç»“æœ: " + sum);
                latch.countDown();
            }).start();
        }
        
        latch.await();
        
        int total = 0;
        for (int result : results) {
            total += result;
        }
        System.out.println("æ€»å’Œ: " + total);
    }
}
```

### åœºæ™¯4ï¼šæœåŠ¡å¯åŠ¨æ£€æŸ¥

```java
/**
 * ç­‰å¾…å¤šä¸ªæœåŠ¡å¯åŠ¨å®Œæˆ
 */
public class ServiceStartupExample {
    public static void main(String[] args) throws InterruptedException {
        CountDownLatch latch = new CountDownLatch(3);
        
        // å¯åŠ¨æ•°æ®åº“æœåŠ¡
        new Thread(() -> {
            System.out.println("æ•°æ®åº“æœåŠ¡å¯åŠ¨ä¸­...");
            try { Thread.sleep(2000); } catch (InterruptedException e) {}
            System.out.println("æ•°æ®åº“æœåŠ¡å¯åŠ¨å®Œæˆ");
            latch.countDown();
        }).start();
        
        // å¯åŠ¨ç¼“å­˜æœåŠ¡
        new Thread(() -> {
            System.out.println("ç¼“å­˜æœåŠ¡å¯åŠ¨ä¸­...");
            try { Thread.sleep(1500); } catch (InterruptedException e) {}
            System.out.println("ç¼“å­˜æœåŠ¡å¯åŠ¨å®Œæˆ");
            latch.countDown();
        }).start();
        
        // å¯åŠ¨æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡
        new Thread(() -> {
            System.out.println("æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡å¯åŠ¨ä¸­...");
            try { Thread.sleep(1000); } catch (InterruptedException e) {}
            System.out.println("æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡å¯åŠ¨å®Œæˆ");
            latch.countDown();
        }).start();
        
        System.out.println("ç­‰å¾…æ‰€æœ‰æœåŠ¡å¯åŠ¨...");
        latch.await();
        System.out.println("æ‰€æœ‰æœåŠ¡å¯åŠ¨å®Œæˆï¼Œç³»ç»Ÿå°±ç»ªï¼");
    }
}
```

---

## é¢è¯•è¦ç‚¹

### 1. CountDownLatchåŸç†

```
Q: CountDownLatchçš„å®ç°åŸç†ï¼Ÿ

A:
åŸºäºAQSçš„å…±äº«æ¨¡å¼å®ç°ï¼š

1. æ„é€ æ—¶è®¾ç½®stateä¸ºè®¡æ•°å€¼
2. await()è°ƒç”¨tryAcquireSharedï¼š
   - state=0è¿”å›1ï¼ˆæˆåŠŸï¼‰
   - state!=0è¿”å›-1ï¼ˆå¤±è´¥ï¼Œè¿›å…¥ç­‰å¾…é˜Ÿåˆ—ï¼‰
3. countDown()è°ƒç”¨tryReleaseSharedï¼š
   - CASå°†stateå‡1
   - å‡åˆ°0æ—¶è¿”å›trueï¼Œå”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹
4. ä¸€æ¬¡æ€§ä½¿ç”¨ï¼Œstateå˜ä¸º0åä¸èƒ½é‡ç½®
```

### 2. CountDownLatch vs CyclicBarrier

```
Q: CountDownLatchå’ŒCyclicBarrierçš„åŒºåˆ«ï¼Ÿ

A:
| å¯¹æ¯”é¡¹ | CountDownLatch | CyclicBarrier |
|--------|----------------|---------------|
| è®¡æ•°æ–¹å¼ | é€’å‡åˆ°0 | é€’å¢åˆ°é˜ˆå€¼ |
| é‡ç”¨æ€§ | ä¸€æ¬¡æ€§ | å¯é‡å¤ä½¿ç”¨ |
| ç­‰å¾…æ–¹ | ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ç­‰å¾…å…¶ä»–çº¿ç¨‹ | å¤šä¸ªçº¿ç¨‹äº’ç›¸ç­‰å¾… |
| å®ç°æ–¹å¼ | AQSå…±äº«æ¨¡å¼ | ReentrantLock + Condition |
| å›è°ƒ | æ—  | å¯è®¾ç½®barrierAction |
| å¼‚å¸¸å¤„ç† | ç‹¬ç«‹ | ä¸€ä¸ªçº¿ç¨‹å¼‚å¸¸ï¼Œå…¶ä»–çº¿ç¨‹ä¹Ÿä¼šå¼‚å¸¸ |

ä½¿ç”¨åœºæ™¯ï¼š
- CountDownLatchï¼šä¸»çº¿ç¨‹ç­‰å¾…å¤šä¸ªå·¥ä½œçº¿ç¨‹å®Œæˆ
- CyclicBarrierï¼šå¤šä¸ªçº¿ç¨‹äº’ç›¸ç­‰å¾…ï¼Œåˆ°è¾¾å±éšœç‚¹åä¸€èµ·ç»§ç»­
```

### 3. ä¸ºä»€ä¹ˆä¸èƒ½é‡ç½®

```
Q: CountDownLatchä¸ºä»€ä¹ˆä¸èƒ½é‡ç½®ï¼Ÿ

A:
è®¾è®¡å†³ç­–ï¼š
1. ç®€åŒ–å®ç°ï¼šä¸éœ€è¦è€ƒè™‘é‡ç½®æ—¶çš„å¹¶å‘é—®é¢˜
2. è¯­ä¹‰æ¸…æ™°ï¼šä¸€æ¬¡æ€§åŒæ­¥å·¥å…·ï¼Œç”¨å®Œå³å¼ƒ
3. é¿å…é”™è¯¯ï¼šé‡ç½®å¯èƒ½å¯¼è‡´å·²ç»é€šè¿‡çš„çº¿ç¨‹å†æ¬¡è¢«é˜»å¡

å¦‚æœéœ€è¦é‡å¤ä½¿ç”¨ï¼š
1. ä½¿ç”¨CyclicBarrier
2. æ¯æ¬¡åˆ›å»ºæ–°çš„CountDownLatch
3. ä½¿ç”¨Phaserï¼ˆæ›´çµæ´»ï¼‰
```

### 4. awaitè¶…æ—¶å¤„ç†

```
Q: CountDownLatchçš„awaitè¶…æ—¶åä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ

A:
await(timeout, unit)è¶…æ—¶åï¼š
1. è¿”å›falseï¼Œè¡¨ç¤ºè¶…æ—¶
2. ä¸ä¼šæŠ›å‡ºå¼‚å¸¸
3. çº¿ç¨‹ç»§ç»­æ‰§è¡Œ
4. è®¡æ•°å™¨çŠ¶æ€ä¸å˜

æ­£ç¡®å¤„ç†æ–¹å¼ï¼š
boolean success = latch.await(10, TimeUnit.SECONDS);
if (!success) {
    // è¶…æ—¶å¤„ç†
    System.out.println("ç­‰å¾…è¶…æ—¶ï¼Œéƒ¨åˆ†ä»»åŠ¡æœªå®Œæˆ");
    // å¯ä»¥é€‰æ‹©ï¼š
    // 1. ç»§ç»­ç­‰å¾…
    // 2. å–æ¶ˆæœªå®Œæˆçš„ä»»åŠ¡
    // 3. è®°å½•æ—¥å¿—å¹¶ç»§ç»­
}
```

### 5. countDownå¤šæ¬¡è°ƒç”¨

```
Q: countDown()è°ƒç”¨æ¬¡æ•°è¶…è¿‡åˆå§‹è®¡æ•°ä¼šæ€æ ·ï¼Ÿ

A:
ä¸ä¼šæœ‰é—®é¢˜ï¼š
1. stateå·²ç»æ˜¯0æ—¶ï¼ŒcountDown()ç›´æ¥è¿”å›
2. ä¸ä¼šå˜æˆè´Ÿæ•°
3. ä¸ä¼šæŠ›å‡ºå¼‚å¸¸

æºç ï¼š
protected boolean tryReleaseShared(int releases) {
    for (;;) {
        int c = getState();
        if (c == 0)
            return false;  // å·²ç»æ˜¯0ï¼Œç›´æ¥è¿”å›
        int nextc = c - 1;
        if (compareAndSetState(c, nextc))
            return nextc == 0;
    }
}
```

---

## ğŸ’¡ æ€»ç»“

```
CountDownLatchæ ¸å¿ƒè¦ç‚¹ï¼š

1. å®ç°åŸç†ï¼š
   - åŸºäºAQSå…±äº«æ¨¡å¼
   - stateè¡¨ç¤ºè®¡æ•°å™¨
   - awaitç­‰å¾…state=0
   - countDownå°†stateå‡1

2. ç‰¹ç‚¹ï¼š
   - ä¸€æ¬¡æ€§ä½¿ç”¨ï¼Œä¸èƒ½é‡ç½®
   - æ”¯æŒå¤šä¸ªçº¿ç¨‹ç­‰å¾…
   - æ”¯æŒè¶…æ—¶ç­‰å¾…
   - çº¿ç¨‹å®‰å…¨

3. ä½¿ç”¨åœºæ™¯ï¼š
   - ç­‰å¾…å¤šä¸ªä»»åŠ¡å®Œæˆ
   - å¤šçº¿ç¨‹åŒæ—¶å¼€å§‹ï¼ˆå‘ä»¤æªï¼‰
   - å¹¶è¡Œè®¡ç®—æ±‡æ€»
   - æœåŠ¡å¯åŠ¨æ£€æŸ¥

4. æ³¨æ„äº‹é¡¹ï¼š
   - è®¡æ•°å™¨ä¸èƒ½é‡ç½®
   - countDownè¦åœ¨finallyä¸­è°ƒç”¨
   - è€ƒè™‘è¶…æ—¶å¤„ç†
   - å¼‚å¸¸æƒ…å†µä¸‹ä¹Ÿè¦countDown

5. vs CyclicBarrierï¼š
   - CountDownLatchï¼šä¸€æ¬¡æ€§ï¼Œç­‰å¾…å…¶ä»–çº¿ç¨‹
   - CyclicBarrierï¼šå¯é‡ç”¨ï¼Œäº’ç›¸ç­‰å¾…
```

---

*æœ€åæ›´æ–°ï¼š2025-12-28*
