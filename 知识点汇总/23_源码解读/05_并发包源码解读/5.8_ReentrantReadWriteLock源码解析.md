# ReentrantReadWriteLockæºç è§£æ

> æ·±å…¥åˆ†æJDKè¯»å†™é”å®ç°åŸç†ï¼ŒæŒæ¡è¯»å†™åˆ†ç¦»çš„å¹¶å‘æ§åˆ¶æœºåˆ¶

---

## ğŸ“š ç›®å½•

1. [æ•´ä½“æ¶æ„](#1-æ•´ä½“æ¶æ„)
2. [æ ¸å¿ƒå±æ€§](#2-æ ¸å¿ƒå±æ€§)
3. [è¯»å†™çŠ¶æ€è®¾è®¡](#3-è¯»å†™çŠ¶æ€è®¾è®¡)
4. [å†™é”å®ç°](#4-å†™é”å®ç°)
5. [è¯»é”å®ç°](#5-è¯»é”å®ç°)
6. [é”é™çº§æœºåˆ¶](#6-é”é™çº§æœºåˆ¶)
7. [å…¬å¹³ä¸éå…¬å¹³](#7-å…¬å¹³ä¸éå…¬å¹³)
8. [Conditionæ”¯æŒ](#8-conditionæ”¯æŒ)
9. [æµç¨‹å›¾è§£](#9-æµç¨‹å›¾è§£)
10. [é¢è¯•è¦ç‚¹](#10-é¢è¯•è¦ç‚¹)

---

## 1. æ•´ä½“æ¶æ„

### 1.1 ç±»ç»§æ‰¿ç»“æ„

```
ReentrantReadWriteLock
â”œâ”€â”€ implements ReadWriteLock
â”œâ”€â”€ Sync extends AQS           # åŒæ­¥å™¨åŸºç±»
â”‚   â”œâ”€â”€ NonfairSync            # éå…¬å¹³åŒæ­¥å™¨
â”‚   â””â”€â”€ FairSync               # å…¬å¹³åŒæ­¥å™¨
â”œâ”€â”€ ReadLock implements Lock   # è¯»é”
â””â”€â”€ WriteLock implements Lock  # å†™é”
```

### 1.2 æ ¸å¿ƒè®¾è®¡æ€æƒ³

```java
/**
 * ReentrantReadWriteLockæ ¸å¿ƒç‰¹æ€§ï¼š
 * 1. è¯»å†™åˆ†ç¦»ï¼šè¯»è¯»å¹¶å‘ï¼Œè¯»å†™/å†™å†™äº’æ–¥
 * 2. å¯é‡å…¥ï¼šåŒä¸€çº¿ç¨‹å¯é‡å¤è·å–é”
 * 3. é”é™çº§ï¼šå†™é”å¯é™çº§ä¸ºè¯»é”
 * 4. å…¬å¹³æ€§ï¼šæ”¯æŒå…¬å¹³/éå…¬å¹³æ¨¡å¼
 */
public class ReentrantReadWriteLock implements ReadWriteLock {
    
    private final ReadLock readerLock;   // è¯»é”
    private final WriteLock writerLock;  // å†™é”
    final Sync sync;                      // åŒæ­¥å™¨
    
    public ReentrantReadWriteLock() {
        this(false);  // é»˜è®¤éå…¬å¹³
    }
    
    public ReentrantReadWriteLock(boolean fair) {
        sync = fair ? new FairSync() : new NonfairSync();
        readerLock = new ReadLock(this);
        writerLock = new WriteLock(this);
    }
}
```


---

## 2. æ ¸å¿ƒå±æ€§

### 2.1 SyncåŒæ­¥å™¨æ ¸å¿ƒå±æ€§

```java
abstract static class Sync extends AbstractQueuedSynchronizer {
    
    // ========== çŠ¶æ€ä½åˆ’åˆ† ==========
    static final int SHARED_SHIFT   = 16;
    static final int SHARED_UNIT    = (1 << SHARED_SHIFT);  // 65536
    static final int MAX_COUNT      = (1 << SHARED_SHIFT) - 1;  // 65535
    static final int EXCLUSIVE_MASK = (1 << SHARED_SHIFT) - 1;  // 0x0000FFFF
    
    // ========== çŠ¶æ€è®¡ç®—æ–¹æ³• ==========
    /** è·å–å…±äº«é”ï¼ˆè¯»é”ï¼‰æŒæœ‰æ•°é‡ - é«˜16ä½ */
    static int sharedCount(int c) { 
        return c >>> SHARED_SHIFT; 
    }
    
    /** è·å–ç‹¬å é”ï¼ˆå†™é”ï¼‰æŒæœ‰æ•°é‡ - ä½16ä½ */
    static int exclusiveCount(int c) { 
        return c & EXCLUSIVE_MASK; 
    }
    
    // ========== è¯»é”è®¡æ•°å™¨ ==========
    /**
     * æ¯ä¸ªçº¿ç¨‹æŒæœ‰è¯»é”çš„è®¡æ•°
     * ä½¿ç”¨ThreadLocalå­˜å‚¨ï¼Œé¿å…é¢‘ç¹æŸ¥è¯¢
     */
    static final class HoldCounter {
        int count = 0;           // æŒæœ‰è¯»é”çš„æ¬¡æ•°
        final long tid = getThreadId(Thread.currentThread());  // çº¿ç¨‹ID
    }
    
    /**
     * ThreadLocalå­ç±»ï¼Œç”¨äºå­˜å‚¨æ¯ä¸ªçº¿ç¨‹çš„è¯»é”è®¡æ•°
     */
    static final class ThreadLocalHoldCounter
        extends ThreadLocal<HoldCounter> {
        public HoldCounter initialValue() {
            return new HoldCounter();
        }
    }
    
    // å½“å‰çº¿ç¨‹çš„è¯»é”è®¡æ•°å™¨
    private transient ThreadLocalHoldCounter readHolds;
    
    // ç¼“å­˜æœ€åä¸€ä¸ªæˆåŠŸè·å–è¯»é”çš„çº¿ç¨‹è®¡æ•°å™¨ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
    private transient HoldCounter cachedHoldCounter;
    
    // ç¬¬ä¸€ä¸ªè·å–è¯»é”çš„çº¿ç¨‹
    private transient Thread firstReader = null;
    // ç¬¬ä¸€ä¸ªè¯»çº¿ç¨‹çš„æŒæœ‰è®¡æ•°
    private transient int firstReaderHoldCount;
}
```

### 2.2 çŠ¶æ€ä½è®¾è®¡å›¾è§£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    32ä½ state çŠ¶æ€å€¼                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚      é«˜16ä½ï¼šè¯»é”è®¡æ•°        â”‚      ä½16ä½ï¼šå†™é”è®¡æ•°          â”‚
â”‚    (å…±äº«é”æŒæœ‰çº¿ç¨‹æ•°)        â”‚    (ç‹¬å é”é‡å…¥æ¬¡æ•°)            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  0000 0000 0000 0011        â”‚  0000 0000 0000 0010          â”‚
â”‚  = 3ä¸ªçº¿ç¨‹æŒæœ‰è¯»é”           â”‚  = å†™é”é‡å…¥2æ¬¡                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç¤ºä¾‹ï¼š
state = 0x00030002
- è¯»é”è®¡æ•° = 0x0003 = 3ï¼ˆ3ä¸ªçº¿ç¨‹æŒæœ‰è¯»é”ï¼‰
- å†™é”è®¡æ•° = 0x0002 = 2ï¼ˆå†™é”é‡å…¥2æ¬¡ï¼‰
```

---

## 3. è¯»å†™çŠ¶æ€è®¾è®¡

### 3.1 çŠ¶æ€æ“ä½œè¯¦è§£

```java
/**
 * çŠ¶æ€æ“ä½œç¤ºä¾‹
 */
public class StateOperationDemo {
    
    static final int SHARED_SHIFT = 16;
    static final int SHARED_UNIT = (1 << SHARED_SHIFT);      // 0x00010000
    static final int EXCLUSIVE_MASK = (1 << SHARED_SHIFT) - 1; // 0x0000FFFF
    
    public static void main(String[] args) {
        int state = 0;
        
        // 1. è·å–å†™é”ï¼ˆç‹¬å é”ï¼‰
        state = state + 1;  // state = 0x00000001
        System.out.println("å†™é”è·å–å: " + Integer.toHexString(state));
        System.out.println("å†™é”è®¡æ•°: " + (state & EXCLUSIVE_MASK));  // 1
        
        // 2. å†™é”é‡å…¥
        state = state + 1;  // state = 0x00000002
        System.out.println("å†™é”é‡å…¥å: " + Integer.toHexString(state));
        System.out.println("å†™é”è®¡æ•°: " + (state & EXCLUSIVE_MASK));  // 2
        
        // 3. é‡Šæ”¾å†™é”
        state = state - 1;  // state = 0x00000001
        state = state - 1;  // state = 0x00000000
        
        // 4. è·å–è¯»é”ï¼ˆå…±äº«é”ï¼‰
        state = state + SHARED_UNIT;  // state = 0x00010000
        System.out.println("è¯»é”è·å–å: " + Integer.toHexString(state));
        System.out.println("è¯»é”è®¡æ•°: " + (state >>> SHARED_SHIFT));  // 1
        
        // 5. å¦ä¸€ä¸ªçº¿ç¨‹è·å–è¯»é”
        state = state + SHARED_UNIT;  // state = 0x00020000
        System.out.println("ç¬¬äºŒä¸ªè¯»é”å: " + Integer.toHexString(state));
        System.out.println("è¯»é”è®¡æ•°: " + (state >>> SHARED_SHIFT));  // 2
    }
}
```

### 3.2 è¯»å†™äº’æ–¥è§„åˆ™

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    è¯»å†™é”äº’æ–¥è§„åˆ™                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   å½“å‰çŠ¶æ€    â”‚   è¯·æ±‚æ“ä½œ   â”‚          ç»“æœ               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   æ— é”       â”‚   è·å–è¯»é”   â”‚   âœ… æˆåŠŸ                    â”‚
â”‚   æ— é”       â”‚   è·å–å†™é”   â”‚   âœ… æˆåŠŸ                    â”‚
â”‚   æœ‰è¯»é”     â”‚   è·å–è¯»é”   â”‚   âœ… æˆåŠŸï¼ˆè¯»è¯»å…±äº«ï¼‰         â”‚
â”‚   æœ‰è¯»é”     â”‚   è·å–å†™é”   â”‚   âŒ é˜»å¡ï¼ˆè¯»å†™äº’æ–¥ï¼‰         â”‚
â”‚   æœ‰å†™é”     â”‚   è·å–è¯»é”   â”‚   âŒ é˜»å¡ï¼ˆå†™è¯»äº’æ–¥ï¼‰         â”‚
â”‚   æœ‰å†™é”     â”‚   è·å–å†™é”   â”‚   âš ï¸ åŒçº¿ç¨‹å¯é‡å…¥ï¼Œå¦åˆ™é˜»å¡   â”‚
â”‚   æœ‰å†™é”     â”‚   åŒçº¿ç¨‹è¯»é” â”‚   âœ… æˆåŠŸï¼ˆé”é™çº§ï¼‰           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


---

## 4. å†™é”å®ç°

### 4.1 WriteLockç±»ç»“æ„

```java
public static class WriteLock implements Lock {
    private final Sync sync;
    
    protected WriteLock(ReentrantReadWriteLock lock) {
        sync = lock.sync;
    }
    
    // è·å–å†™é”
    public void lock() {
        sync.acquire(1);  // è°ƒç”¨AQSçš„acquire
    }
    
    // å¯ä¸­æ–­è·å–
    public void lockInterruptibly() throws InterruptedException {
        sync.acquireInterruptibly(1);
    }
    
    // å°è¯•è·å–
    public boolean tryLock() {
        return sync.tryWriteLock();
    }
    
    // è¶…æ—¶è·å–
    public boolean tryLock(long timeout, TimeUnit unit) throws InterruptedException {
        return sync.tryAcquireNanos(1, unit.toNanos(timeout));
    }
    
    // é‡Šæ”¾å†™é”
    public void unlock() {
        sync.release(1);
    }
    
    // è·å–Condition
    public Condition newCondition() {
        return sync.newCondition();
    }
}
```

### 4.2 tryAcquire - å†™é”è·å–æ ¸å¿ƒ

```java
/**
 * å°è¯•è·å–å†™é”ï¼ˆç‹¬å æ¨¡å¼ï¼‰
 * 
 * è·å–æ¡ä»¶ï¼š
 * 1. æ²¡æœ‰ä»»ä½•é”ï¼ˆè¯»é”å’Œå†™é”éƒ½ä¸º0ï¼‰
 * 2. åªæœ‰å½“å‰çº¿ç¨‹æŒæœ‰å†™é”ï¼ˆå¯é‡å…¥ï¼‰
 */
protected final boolean tryAcquire(int acquires) {
    Thread current = Thread.currentThread();
    int c = getState();
    int w = exclusiveCount(c);  // å†™é”è®¡æ•°ï¼ˆä½16ä½ï¼‰
    
    // 1. æœ‰é”å­˜åœ¨ï¼ˆè¯»é”æˆ–å†™é”ï¼‰
    if (c != 0) {
        // 1.1 å†™é”ä¸º0è¯´æ˜æœ‰è¯»é”ï¼Œæˆ–è€…å†™é”ä¸æ˜¯å½“å‰çº¿ç¨‹æŒæœ‰
        //     è¯»é”å­˜åœ¨æ—¶ä¸èƒ½è·å–å†™é”ï¼ˆé¿å…æ­»é”ï¼‰
        if (w == 0 || current != getExclusiveOwnerThread())
            return false;
        
        // 1.2 å†™é”é‡å…¥æ¬¡æ•°è¶…è¿‡æœ€å¤§å€¼
        if (w + exclusiveCount(acquires) > MAX_COUNT)
            throw new Error("Maximum lock count exceeded");
        
        // 1.3 å†™é”é‡å…¥ï¼Œç›´æ¥è®¾ç½®çŠ¶æ€
        setState(c + acquires);
        return true;
    }
    
    // 2. æ— é”çŠ¶æ€
    // 2.1 æ£€æŸ¥æ˜¯å¦éœ€è¦é˜»å¡ï¼ˆå…¬å¹³é”éœ€è¦æ’é˜Ÿï¼‰
    if (writerShouldBlock() ||
        !compareAndSetState(c, c + acquires))
        return false;
    
    // 2.2 è®¾ç½®ç‹¬å çº¿ç¨‹
    setExclusiveOwnerThread(current);
    return true;
}
```

### 4.3 tryRelease - å†™é”é‡Šæ”¾

```java
/**
 * å°è¯•é‡Šæ”¾å†™é”
 */
protected final boolean tryRelease(int releases) {
    // 1. æ£€æŸ¥æ˜¯å¦æ˜¯å½“å‰çº¿ç¨‹æŒæœ‰
    if (!isHeldExclusively())
        throw new IllegalMonitorStateException();
    
    // 2. è®¡ç®—é‡Šæ”¾åçš„çŠ¶æ€
    int nextc = getState() - releases;
    
    // 3. æ£€æŸ¥å†™é”æ˜¯å¦å®Œå…¨é‡Šæ”¾
    boolean free = exclusiveCount(nextc) == 0;
    if (free)
        setExclusiveOwnerThread(null);  // æ¸…é™¤ç‹¬å çº¿ç¨‹
    
    // 4. æ›´æ–°çŠ¶æ€
    setState(nextc);
    return free;
}
```

### 4.4 å†™é”è·å–æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å†™é”è·å–æµç¨‹                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  è·å–state   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”Œâ”€â”€â”€â”€â”€â”‚  state == 0? â”‚â”€â”€â”€â”€â”€â”
              â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
              â”‚ Yes                      â”‚ No
              â–¼                          â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ writerShouldBlockâ”‚      â”‚ å†™é”è®¡æ•° w == 0? â”‚
    â”‚   æ£€æŸ¥æ˜¯å¦é˜»å¡    â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
              â”‚                   â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
              â–¼                   â”‚ Yes     â”‚ No
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â–¼         â–¼
    â”‚   CASè®¾ç½®state   â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚æœ‰è¯»é”   â”‚ â”‚æ˜¯å½“å‰çº¿ç¨‹?  â”‚
              â”‚             â”‚è¿”å›falseâ”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â–¼             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
    â”‚ è®¾ç½®ç‹¬å çº¿ç¨‹      â”‚              â”‚ Yes       â”‚ No
    â”‚ è¿”å›true         â”‚              â–¼           â–¼
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                â”‚é‡å…¥æˆåŠŸ â”‚ â”‚è¿”å›falseâ”‚
                                â”‚æ›´æ–°stateâ”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


---

## 5. è¯»é”å®ç°

### 5.1 ReadLockç±»ç»“æ„

```java
public static class ReadLock implements Lock {
    private final Sync sync;
    
    protected ReadLock(ReentrantReadWriteLock lock) {
        sync = lock.sync;
    }
    
    // è·å–è¯»é”
    public void lock() {
        sync.acquireShared(1);  // è°ƒç”¨AQSçš„å…±äº«è·å–
    }
    
    // å¯ä¸­æ–­è·å–
    public void lockInterruptibly() throws InterruptedException {
        sync.acquireSharedInterruptibly(1);
    }
    
    // å°è¯•è·å–
    public boolean tryLock() {
        return sync.tryReadLock();
    }
    
    // è¶…æ—¶è·å–
    public boolean tryLock(long timeout, TimeUnit unit) throws InterruptedException {
        return sync.tryAcquireSharedNanos(1, unit.toNanos(timeout));
    }
    
    // é‡Šæ”¾è¯»é”
    public void unlock() {
        sync.releaseShared(1);
    }
    
    // è¯»é”ä¸æ”¯æŒCondition
    public Condition newCondition() {
        throw new UnsupportedOperationException();
    }
}
```

### 5.2 tryAcquireShared - è¯»é”è·å–æ ¸å¿ƒ

```java
/**
 * å°è¯•è·å–è¯»é”ï¼ˆå…±äº«æ¨¡å¼ï¼‰
 * 
 * è¿”å›å€¼ï¼š
 * - è´Ÿæ•°ï¼šè·å–å¤±è´¥
 * - 0ï¼šè·å–æˆåŠŸï¼Œä½†åç»­å…±äº«è·å–ä¸ä¼šæˆåŠŸ
 * - æ­£æ•°ï¼šè·å–æˆåŠŸï¼Œåç»­å…±äº«è·å–ä¹Ÿå¯èƒ½æˆåŠŸ
 */
protected final int tryAcquireShared(int unused) {
    Thread current = Thread.currentThread();
    int c = getState();
    
    // 1. æ£€æŸ¥å†™é”æ˜¯å¦è¢«å…¶ä»–çº¿ç¨‹æŒæœ‰
    //    å¦‚æœå†™é”è¢«å½“å‰çº¿ç¨‹æŒæœ‰ï¼Œå…è®¸è·å–è¯»é”ï¼ˆé”é™çº§ï¼‰
    if (exclusiveCount(c) != 0 &&
        getExclusiveOwnerThread() != current)
        return -1;  // å†™é”è¢«å…¶ä»–çº¿ç¨‹æŒæœ‰ï¼Œè·å–å¤±è´¥
    
    int r = sharedCount(c);  // è¯»é”è®¡æ•°
    
    // 2. å¿«é€Ÿè·¯å¾„ï¼šå°è¯•ç›´æ¥è·å–
    if (!readerShouldBlock() &&      // ä¸éœ€è¦é˜»å¡
        r < MAX_COUNT &&              // æœªè¶…è¿‡æœ€å¤§å€¼
        compareAndSetState(c, c + SHARED_UNIT)) {  // CASæˆåŠŸ
        
        // 2.1 ç¬¬ä¸€ä¸ªè·å–è¯»é”çš„çº¿ç¨‹
        if (r == 0) {
            firstReader = current;
            firstReaderHoldCount = 1;
        }
        // 2.2 ç¬¬ä¸€ä¸ªè¯»çº¿ç¨‹é‡å…¥
        else if (firstReader == current) {
            firstReaderHoldCount++;
        }
        // 2.3 å…¶ä»–çº¿ç¨‹è·å–è¯»é”
        else {
            HoldCounter rh = cachedHoldCounter;
            if (rh == null || rh.tid != getThreadId(current))
                cachedHoldCounter = rh = readHolds.get();
            else if (rh.count == 0)
                readHolds.set(rh);
            rh.count++;
        }
        return 1;  // è·å–æˆåŠŸ
    }
    
    // 3. å¿«é€Ÿè·¯å¾„å¤±è´¥ï¼Œè¿›å…¥å®Œæ•´è·å–æµç¨‹
    return fullTryAcquireShared(current);
}
```

### 5.3 fullTryAcquireShared - å®Œæ•´è¯»é”è·å–

```java
/**
 * å®Œæ•´çš„è¯»é”è·å–æµç¨‹ï¼ˆå¤„ç†CASå¤±è´¥å’Œé‡å…¥ï¼‰
 */
final int fullTryAcquireShared(Thread current) {
    HoldCounter rh = null;
    
    for (;;) {  // è‡ªæ—‹
        int c = getState();
        
        // 1. å†™é”è¢«å…¶ä»–çº¿ç¨‹æŒæœ‰
        if (exclusiveCount(c) != 0) {
            if (getExclusiveOwnerThread() != current)
                return -1;
            // å½“å‰çº¿ç¨‹æŒæœ‰å†™é”ï¼Œå…è®¸è·å–è¯»é”ï¼ˆé”é™çº§ï¼‰
        }
        // 2. éœ€è¦é˜»å¡ï¼ˆå…¬å¹³é”æ£€æŸ¥é˜Ÿåˆ—ï¼‰
        else if (readerShouldBlock()) {
            // ç¡®ä¿ä¸æ˜¯é‡å…¥
            if (firstReader == current) {
                // ç¬¬ä¸€ä¸ªè¯»çº¿ç¨‹é‡å…¥ï¼Œä¸é˜»å¡
            } else {
                if (rh == null) {
                    rh = cachedHoldCounter;
                    if (rh == null || rh.tid != getThreadId(current)) {
                        rh = readHolds.get();
                        if (rh.count == 0)
                            readHolds.remove();
                    }
                }
                if (rh.count == 0)
                    return -1;  // éé‡å…¥ï¼Œéœ€è¦æ’é˜Ÿ
            }
        }
        
        // 3. æ£€æŸ¥è¯»é”è®¡æ•°æ˜¯å¦è¶…é™
        if (sharedCount(c) == MAX_COUNT)
            throw new Error("Maximum lock count exceeded");
        
        // 4. CASè·å–è¯»é”
        if (compareAndSetState(c, c + SHARED_UNIT)) {
            // æ›´æ–°è¯»é”è®¡æ•°å™¨
            if (sharedCount(c) == 0) {
                firstReader = current;
                firstReaderHoldCount = 1;
            } else if (firstReader == current) {
                firstReaderHoldCount++;
            } else {
                if (rh == null)
                    rh = cachedHoldCounter;
                if (rh == null || rh.tid != getThreadId(current))
                    rh = readHolds.get();
                else if (rh.count == 0)
                    readHolds.set(rh);
                rh.count++;
                cachedHoldCounter = rh;
            }
            return 1;
        }
    }
}
```

### 5.4 tryReleaseShared - è¯»é”é‡Šæ”¾

```java
/**
 * å°è¯•é‡Šæ”¾è¯»é”
 */
protected final boolean tryReleaseShared(int unused) {
    Thread current = Thread.currentThread();
    
    // 1. æ›´æ–°å½“å‰çº¿ç¨‹çš„è¯»é”è®¡æ•°
    if (firstReader == current) {
        // ç¬¬ä¸€ä¸ªè¯»çº¿ç¨‹
        if (firstReaderHoldCount == 1)
            firstReader = null;
        else
            firstReaderHoldCount--;
    } else {
        // å…¶ä»–è¯»çº¿ç¨‹
        HoldCounter rh = cachedHoldCounter;
        if (rh == null || rh.tid != getThreadId(current))
            rh = readHolds.get();
        int count = rh.count;
        if (count <= 1) {
            readHolds.remove();  // æ¸…ç†ThreadLocal
            if (count <= 0)
                throw unmatchedUnlockException();
        }
        --rh.count;
    }
    
    // 2. CASæ›´æ–°state
    for (;;) {
        int c = getState();
        int nextc = c - SHARED_UNIT;
        if (compareAndSetState(c, nextc))
            // è¿”å›æ˜¯å¦å®Œå…¨é‡Šæ”¾ï¼ˆè¯»é”è®¡æ•°ä¸º0ï¼‰
            return nextc == 0;
    }
}
```


---

## 6. é”é™çº§æœºåˆ¶

### 6.1 ä»€ä¹ˆæ˜¯é”é™çº§

```java
/**
 * é”é™çº§ï¼šæŒæœ‰å†™é”çš„æƒ…å†µä¸‹è·å–è¯»é”ï¼Œç„¶åé‡Šæ”¾å†™é”
 * 
 * ç›®çš„ï¼šä¿è¯æ•°æ®å¯è§æ€§
 * 
 * æ­£ç¡®çš„é”é™çº§æµç¨‹ï¼š
 * 1. è·å–å†™é”
 * 2. ä¿®æ”¹æ•°æ®
 * 3. è·å–è¯»é”ï¼ˆåœ¨æŒæœ‰å†™é”æ—¶ï¼‰
 * 4. é‡Šæ”¾å†™é”
 * 5. ä½¿ç”¨æ•°æ®
 * 6. é‡Šæ”¾è¯»é”
 */
public class LockDegradeDemo {
    
    private final ReentrantReadWriteLock rwl = new ReentrantReadWriteLock();
    private final Lock readLock = rwl.readLock();
    private final Lock writeLock = rwl.writeLock();
    
    private volatile boolean cacheValid = false;
    private Object data;
    
    public void processCachedData() {
        // 1. å…ˆè·å–è¯»é”æ£€æŸ¥ç¼“å­˜
        readLock.lock();
        try {
            if (!cacheValid) {
                // 2. ç¼“å­˜æ— æ•ˆï¼Œéœ€è¦æ›´æ–°
                //    å¿…é¡»å…ˆé‡Šæ”¾è¯»é”ï¼Œå†è·å–å†™é”
                readLock.unlock();
                writeLock.lock();
                try {
                    // 3. åŒé‡æ£€æŸ¥
                    if (!cacheValid) {
                        data = loadDataFromDB();
                        cacheValid = true;
                    }
                    // 4. é”é™çº§ï¼šåœ¨æŒæœ‰å†™é”æ—¶è·å–è¯»é”
                    readLock.lock();
                } finally {
                    // 5. é‡Šæ”¾å†™é”ï¼Œæ­¤æ—¶ä»æŒæœ‰è¯»é”
                    writeLock.unlock();
                }
            }
            // 6. ä½¿ç”¨æ•°æ®ï¼ˆæŒæœ‰è¯»é”ï¼‰
            useData(data);
        } finally {
            readLock.unlock();
        }
    }
    
    private Object loadDataFromDB() { return new Object(); }
    private void useData(Object data) { /* ä½¿ç”¨æ•°æ® */ }
}
```

### 6.2 ä¸ºä»€ä¹ˆéœ€è¦é”é™çº§

```
åœºæ™¯ï¼šçº¿ç¨‹Aä¿®æ”¹æ•°æ®åéœ€è¦ç»§ç»­ä½¿ç”¨æ•°æ®

âŒ é”™è¯¯æ–¹å¼ï¼ˆä¸ä½¿ç”¨é”é™çº§ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ çº¿ç¨‹A                          â”‚ çº¿ç¨‹B                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. è·å–å†™é”                    â”‚                            â”‚
â”‚ 2. ä¿®æ”¹æ•°æ®                    â”‚                            â”‚
â”‚ 3. é‡Šæ”¾å†™é”                    â”‚                            â”‚
â”‚                                â”‚ 4. è·å–å†™é”                â”‚
â”‚                                â”‚ 5. ä¿®æ”¹æ•°æ®                â”‚
â”‚                                â”‚ 6. é‡Šæ”¾å†™é”                â”‚
â”‚ 7. è·å–è¯»é”                    â”‚                            â”‚
â”‚ 8. è¯»å–æ•°æ®ï¼ˆå·²è¢«Bä¿®æ”¹ï¼ï¼‰      â”‚                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
é—®é¢˜ï¼šçº¿ç¨‹Aè¯»åˆ°çš„æ˜¯çº¿ç¨‹Bä¿®æ”¹åçš„æ•°æ®ï¼Œä¸æ˜¯è‡ªå·±ä¿®æ”¹çš„æ•°æ®

âœ… æ­£ç¡®æ–¹å¼ï¼ˆä½¿ç”¨é”é™çº§ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ çº¿ç¨‹A                          â”‚ çº¿ç¨‹B                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. è·å–å†™é”                    â”‚                            â”‚
â”‚ 2. ä¿®æ”¹æ•°æ®                    â”‚                            â”‚
â”‚ 3. è·å–è¯»é”ï¼ˆé”é™çº§ï¼‰          â”‚                            â”‚
â”‚ 4. é‡Šæ”¾å†™é”                    â”‚                            â”‚
â”‚                                â”‚ 5. å°è¯•è·å–å†™é”ï¼ˆé˜»å¡ï¼‰    â”‚
â”‚ 6. è¯»å–æ•°æ®ï¼ˆè‡ªå·±ä¿®æ”¹çš„ï¼‰      â”‚    â†“ ç­‰å¾…                  â”‚
â”‚ 7. é‡Šæ”¾è¯»é”                    â”‚                            â”‚
â”‚                                â”‚ 8. è·å–å†™é”æˆåŠŸ            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.3 é”å‡çº§ï¼ˆä¸æ”¯æŒï¼‰

```java
/**
 * ReentrantReadWriteLockä¸æ”¯æŒé”å‡çº§
 * 
 * åŸå› ï¼šå¯èƒ½å¯¼è‡´æ­»é”
 */
public class LockUpgradeDemo {
    
    private final ReentrantReadWriteLock rwl = new ReentrantReadWriteLock();
    
    public void wrongUpgrade() {
        rwl.readLock().lock();
        try {
            // âŒ é”™è¯¯ï¼šæŒæœ‰è¯»é”æ—¶å°è¯•è·å–å†™é”ä¼šæ­»é”
            // å› ä¸ºå†™é”éœ€è¦ç­‰å¾…æ‰€æœ‰è¯»é”é‡Šæ”¾
            // è€Œå½“å‰çº¿ç¨‹æŒæœ‰è¯»é”ï¼Œæ— æ³•é‡Šæ”¾
            rwl.writeLock().lock();  // æ°¸è¿œé˜»å¡ï¼
            try {
                // æ°¸è¿œä¸ä¼šæ‰§è¡Œåˆ°è¿™é‡Œ
            } finally {
                rwl.writeLock().unlock();
            }
        } finally {
            rwl.readLock().unlock();
        }
    }
    
    public void correctUpgrade() {
        rwl.readLock().lock();
        try {
            // æ£€æŸ¥æ˜¯å¦éœ€è¦å†™æ“ä½œ
            if (needWrite()) {
                // âœ… æ­£ç¡®ï¼šå…ˆé‡Šæ”¾è¯»é”ï¼Œå†è·å–å†™é”
                rwl.readLock().unlock();
                rwl.writeLock().lock();
                try {
                    // æ‰§è¡Œå†™æ“ä½œ
                    doWrite();
                    // å¯é€‰ï¼šé”é™çº§
                    rwl.readLock().lock();
                } finally {
                    rwl.writeLock().unlock();
                }
            }
        } finally {
            rwl.readLock().unlock();
        }
    }
    
    private boolean needWrite() { return true; }
    private void doWrite() { /* å†™æ“ä½œ */ }
}
```

---

## 7. å…¬å¹³ä¸éå…¬å¹³

### 7.1 å…¬å¹³åŒæ­¥å™¨

```java
/**
 * å…¬å¹³æ¨¡å¼ï¼šä¸¥æ ¼æŒ‰ç…§FIFOé¡ºåºè·å–é”
 */
static final class FairSync extends Sync {
    
    /**
     * å†™é”æ˜¯å¦åº”è¯¥é˜»å¡
     * å…¬å¹³æ¨¡å¼ï¼šå¦‚æœé˜Ÿåˆ—ä¸­æœ‰ç­‰å¾…çº¿ç¨‹ï¼Œåˆ™é˜»å¡
     */
    final boolean writerShouldBlock() {
        return hasQueuedPredecessors();  // æ£€æŸ¥æ˜¯å¦æœ‰å‰é©±èŠ‚ç‚¹
    }
    
    /**
     * è¯»é”æ˜¯å¦åº”è¯¥é˜»å¡
     * å…¬å¹³æ¨¡å¼ï¼šå¦‚æœé˜Ÿåˆ—ä¸­æœ‰ç­‰å¾…çº¿ç¨‹ï¼Œåˆ™é˜»å¡
     */
    final boolean readerShouldBlock() {
        return hasQueuedPredecessors();
    }
}
```

### 7.2 éå…¬å¹³åŒæ­¥å™¨

```java
/**
 * éå…¬å¹³æ¨¡å¼ï¼šå…è®¸æ’é˜Ÿï¼Œæé«˜ååé‡
 */
static final class NonfairSync extends Sync {
    
    /**
     * å†™é”æ˜¯å¦åº”è¯¥é˜»å¡
     * éå…¬å¹³æ¨¡å¼ï¼šæ°¸è¿œä¸é˜»å¡ï¼Œç›´æ¥å°è¯•è·å–
     */
    final boolean writerShouldBlock() {
        return false;  // å†™é”å¯ä»¥ç›´æ¥å°è¯•è·å–
    }
    
    /**
     * è¯»é”æ˜¯å¦åº”è¯¥é˜»å¡
     * éå…¬å¹³æ¨¡å¼ï¼šå¦‚æœé˜Ÿåˆ—å¤´æ˜¯å†™é”è¯·æ±‚ï¼Œåˆ™é˜»å¡
     * 
     * åŸå› ï¼šé˜²æ­¢å†™é”é¥¥é¥¿
     */
    final boolean readerShouldBlock() {
        return apparentlyFirstQueuedIsExclusive();
    }
}

/**
 * æ£€æŸ¥é˜Ÿåˆ—å¤´æ˜¯å¦æ˜¯ç‹¬å æ¨¡å¼ï¼ˆå†™é”è¯·æ±‚ï¼‰
 */
final boolean apparentlyFirstQueuedIsExclusive() {
    Node h, s;
    return (h = head) != null &&
        (s = h.next)  != null &&
        !s.isShared()         &&  // ä¸æ˜¯å…±äº«æ¨¡å¼
        s.thread != null;
}
```

### 7.3 å…¬å¹³ä¸éå…¬å¹³å¯¹æ¯”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                å…¬å¹³æ¨¡å¼ vs éå…¬å¹³æ¨¡å¼                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    ç‰¹æ€§      â”‚    å…¬å¹³æ¨¡å¼      â”‚      éå…¬å¹³æ¨¡å¼           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  è·å–é¡ºåº    â”‚  ä¸¥æ ¼FIFO       â”‚  å…è®¸æ’é˜Ÿ                 â”‚
â”‚  ååé‡      â”‚  è¾ƒä½           â”‚  è¾ƒé«˜                     â”‚
â”‚  é¥¥é¥¿é—®é¢˜    â”‚  ä¸ä¼šé¥¥é¥¿       â”‚  å¯èƒ½é¥¥é¥¿ï¼ˆå·²ä¼˜åŒ–ï¼‰       â”‚
â”‚  ä¸Šä¸‹æ–‡åˆ‡æ¢  â”‚  è¾ƒå¤š           â”‚  è¾ƒå°‘                     â”‚
â”‚  é€‚ç”¨åœºæ™¯    â”‚  å…¬å¹³æ€§è¦æ±‚é«˜   â”‚  æ€§èƒ½è¦æ±‚é«˜               â”‚
â”‚  é»˜è®¤é€‰æ‹©    â”‚  å¦             â”‚  æ˜¯                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


---

## 8. Conditionæ”¯æŒ

### 8.1 å†™é”çš„Condition

```java
/**
 * åªæœ‰å†™é”æ”¯æŒCondition
 * è¯»é”è°ƒç”¨newCondition()ä¼šæŠ›å‡ºUnsupportedOperationException
 */
public class ConditionDemo {
    
    private final ReentrantReadWriteLock rwl = new ReentrantReadWriteLock();
    private final Lock writeLock = rwl.writeLock();
    private final Condition condition = writeLock.newCondition();
    
    private boolean dataReady = false;
    
    // ç”Ÿäº§è€…
    public void produce() throws InterruptedException {
        writeLock.lock();
        try {
            // å‡†å¤‡æ•°æ®
            prepareData();
            dataReady = true;
            // é€šçŸ¥æ¶ˆè´¹è€…
            condition.signalAll();
        } finally {
            writeLock.unlock();
        }
    }
    
    // æ¶ˆè´¹è€…
    public void consume() throws InterruptedException {
        writeLock.lock();
        try {
            // ç­‰å¾…æ•°æ®å‡†å¤‡å¥½
            while (!dataReady) {
                condition.await();
            }
            // æ¶ˆè´¹æ•°æ®
            consumeData();
        } finally {
            writeLock.unlock();
        }
    }
    
    private void prepareData() { /* å‡†å¤‡æ•°æ® */ }
    private void consumeData() { /* æ¶ˆè´¹æ•°æ® */ }
}
```

---

## 9. æµç¨‹å›¾è§£

### 9.1 è¯»å†™é”æ•´ä½“æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  ReentrantReadWriteLock æ•´ä½“æ¶æ„             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ ReentrantReadWrite  â”‚
                    â”‚       Lock          â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚               â”‚               â”‚
              â–¼               â–¼               â–¼
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚ ReadLock â”‚    â”‚WriteLock â”‚    â”‚   Sync   â”‚
       â”‚  (å…±äº«)   â”‚    â”‚  (ç‹¬å )  â”‚    â”‚  (AQS)   â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚               â”‚               â”‚
              â”‚               â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
              â”‚               â”‚        â”‚             â”‚
              â–¼               â–¼        â–¼             â–¼
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚           state (32ä½)            â”‚   â”‚FairSync  â”‚
       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚   â”‚NonfairSyncâ”‚
       â”‚  â”‚ é«˜16ä½    â”‚ ä½16ä½    â”‚       â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚  â”‚ è¯»é”è®¡æ•°  â”‚ å†™é”è®¡æ•°  â”‚       â”‚
       â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 9.2 è¯»é”è·å–æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    è¯»é”è·å–æµç¨‹                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ è·å–state    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ å†™é”è®¡æ•° > 0?â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Yes                     â”‚ No
              â–¼                         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ æ˜¯å½“å‰çº¿ç¨‹æŒæœ‰?   â”‚      â”‚ readerShouldBlockâ”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚   æ£€æŸ¥æ˜¯å¦é˜»å¡    â”‚
              â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”                 â”‚
       â”‚ Yes         â”‚ No         â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
       â–¼             â–¼            â”‚ Yes     â”‚ No
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â–¼         â–¼
  â”‚é”é™çº§   â”‚  â”‚è¿”å›-1   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚å…è®¸è·å– â”‚  â”‚è·å–å¤±è´¥ â”‚   â”‚fullTry  â”‚ â”‚CASè·å–  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚å®Œæ•´æµç¨‹ â”‚ â”‚è¯»é”     â”‚
                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 9.3 å†™é”è·å–æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å†™é”è·å–æµç¨‹                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ è·å–state    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ state != 0?  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Yes                     â”‚ No
              â–¼                         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ å†™é”è®¡æ•° == 0?   â”‚      â”‚ writerShouldBlockâ”‚
    â”‚ (æœ‰è¯»é”?)        â”‚      â”‚   æ£€æŸ¥æ˜¯å¦é˜»å¡    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                        â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
       â”‚ Yes         â”‚ No        â”‚ Yes       â”‚ No
       â–¼             â–¼           â–¼           â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚æœ‰è¯»é”   â”‚  â”‚æ˜¯å½“å‰çº¿ç¨‹?  â”‚ â”‚å…¥é˜Ÿç­‰å¾… â”‚ â”‚CASè·å–  â”‚
  â”‚è¿”å›falseâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚å†™é”     â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
              â”‚ Yes         â”‚ No
              â–¼             â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚é‡å…¥æˆåŠŸ â”‚   â”‚è¿”å›falseâ”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 10. é¢è¯•è¦ç‚¹

### 10.1 é«˜é¢‘é¢è¯•é¢˜

```
Q1: ReentrantReadWriteLockçš„å®ç°åŸç†ï¼Ÿ
A: åŸºäºAQSå®ç°ï¼Œä½¿ç”¨ä¸€ä¸ª32ä½çš„stateå˜é‡ï¼š
   - é«˜16ä½è¡¨ç¤ºè¯»é”è®¡æ•°ï¼ˆå…±äº«é”æŒæœ‰çº¿ç¨‹æ•°ï¼‰
   - ä½16ä½è¡¨ç¤ºå†™é”è®¡æ•°ï¼ˆç‹¬å é”é‡å…¥æ¬¡æ•°ï¼‰
   - è¯»é”ä½¿ç”¨AQSå…±äº«æ¨¡å¼ï¼Œå†™é”ä½¿ç”¨ç‹¬å æ¨¡å¼

Q2: è¯»å†™é”çš„äº’æ–¥è§„åˆ™æ˜¯ä»€ä¹ˆï¼Ÿ
A: - è¯»è¯»å…±äº«ï¼šå¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶æŒæœ‰è¯»é”
   - è¯»å†™äº’æ–¥ï¼šæœ‰è¯»é”æ—¶ä¸èƒ½è·å–å†™é”
   - å†™è¯»äº’æ–¥ï¼šæœ‰å†™é”æ—¶å…¶ä»–çº¿ç¨‹ä¸èƒ½è·å–è¯»é”
   - å†™å†™äº’æ–¥ï¼šåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æŒæœ‰å†™é”

Q3: ä»€ä¹ˆæ˜¯é”é™çº§ï¼Ÿä¸ºä»€ä¹ˆéœ€è¦ï¼Ÿ
A: é”é™çº§æ˜¯æŒ‡æŒæœ‰å†™é”çš„æƒ…å†µä¸‹è·å–è¯»é”ï¼Œç„¶åé‡Šæ”¾å†™é”ã€‚
   ç›®çš„æ˜¯ä¿è¯æ•°æ®å¯è§æ€§ï¼Œé˜²æ­¢åœ¨é‡Šæ”¾å†™é”åã€è·å–è¯»é”å‰
   å…¶ä»–çº¿ç¨‹ä¿®æ”¹æ•°æ®ã€‚

Q4: ä¸ºä»€ä¹ˆä¸æ”¯æŒé”å‡çº§ï¼Ÿ
A: é”å‡çº§ï¼ˆæŒæœ‰è¯»é”æ—¶è·å–å†™é”ï¼‰å¯èƒ½å¯¼è‡´æ­»é”ã€‚
   å› ä¸ºå†™é”éœ€è¦ç­‰å¾…æ‰€æœ‰è¯»é”é‡Šæ”¾ï¼Œè€Œå½“å‰çº¿ç¨‹æŒæœ‰è¯»é”
   æ— æ³•é‡Šæ”¾ï¼Œå½¢æˆæ­»é”ã€‚

Q5: å…¬å¹³æ¨¡å¼å’Œéå…¬å¹³æ¨¡å¼çš„åŒºåˆ«ï¼Ÿ
A: - å…¬å¹³æ¨¡å¼ï¼šä¸¥æ ¼æŒ‰FIFOé¡ºåºè·å–é”ï¼Œååé‡è¾ƒä½
   - éå…¬å¹³æ¨¡å¼ï¼šå…è®¸æ’é˜Ÿï¼Œååé‡è¾ƒé«˜
   - éå…¬å¹³æ¨¡å¼ä¸‹ï¼Œè¯»é”ä¼šæ£€æŸ¥é˜Ÿåˆ—å¤´æ˜¯å¦æ˜¯å†™é”è¯·æ±‚ï¼Œ
     é˜²æ­¢å†™é”é¥¥é¥¿
```

### 10.2 ä½¿ç”¨åœºæ™¯

```java
/**
 * é€‚ç”¨åœºæ™¯ï¼šè¯»å¤šå†™å°‘
 * 
 * å…¸å‹åº”ç”¨ï¼š
 * 1. ç¼“å­˜ç³»ç»Ÿ
 * 2. é…ç½®ç®¡ç†
 * 3. æ•°æ®å­—å…¸
 */
public class CacheWithReadWriteLock<K, V> {
    
    private final Map<K, V> cache = new HashMap<>();
    private final ReentrantReadWriteLock rwl = new ReentrantReadWriteLock();
    private final Lock readLock = rwl.readLock();
    private final Lock writeLock = rwl.writeLock();
    
    // è¯»æ“ä½œï¼šä½¿ç”¨è¯»é”
    public V get(K key) {
        readLock.lock();
        try {
            return cache.get(key);
        } finally {
            readLock.unlock();
        }
    }
    
    // å†™æ“ä½œï¼šä½¿ç”¨å†™é”
    public void put(K key, V value) {
        writeLock.lock();
        try {
            cache.put(key, value);
        } finally {
            writeLock.unlock();
        }
    }
    
    // æ¸…ç©ºç¼“å­˜ï¼šä½¿ç”¨å†™é”
    public void clear() {
        writeLock.lock();
        try {
            cache.clear();
        } finally {
            writeLock.unlock();
        }
    }
    
    // è·å–å¤§å°ï¼šä½¿ç”¨è¯»é”
    public int size() {
        readLock.lock();
        try {
            return cache.size();
        } finally {
            readLock.unlock();
        }
    }
}
```

### 10.3 ä¸å…¶ä»–é”å¯¹æ¯”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ReentrantReadWriteLock vs å…¶ä»–é”                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    ç‰¹æ€§      â”‚ ReentrantLock   â”‚ ReentrantReadWriteLock    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  é”ç±»å‹      â”‚  ç‹¬å é”         â”‚  è¯»å†™åˆ†ç¦»é”               â”‚
â”‚  å¹¶å‘è¯»      â”‚  ä¸æ”¯æŒ         â”‚  æ”¯æŒ                     â”‚
â”‚  é€‚ç”¨åœºæ™¯    â”‚  è¯»å†™å‡è¡¡       â”‚  è¯»å¤šå†™å°‘                 â”‚
â”‚  å®ç°å¤æ‚åº¦  â”‚  ç®€å•           â”‚  å¤æ‚                     â”‚
â”‚  æ€§èƒ½        â”‚  è¯»å†™å‡è¡¡æ—¶å¥½   â”‚  è¯»å¤šæ—¶å¥½                 â”‚
â”‚  Condition   â”‚  æ”¯æŒ           â”‚  ä»…å†™é”æ”¯æŒ               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    ReentrantReadWriteLock vs StampedLock (JDK8+)           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    ç‰¹æ€§      â”‚ ReadWriteLock   â”‚ StampedLock               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ä¹è§‚è¯»      â”‚  ä¸æ”¯æŒ         â”‚  æ”¯æŒ                     â”‚
â”‚  é”å‡çº§      â”‚  ä¸æ”¯æŒ         â”‚  æ”¯æŒ                     â”‚
â”‚  å¯é‡å…¥      â”‚  æ”¯æŒ           â”‚  ä¸æ”¯æŒ                   â”‚
â”‚  Condition   â”‚  å†™é”æ”¯æŒ       â”‚  ä¸æ”¯æŒ                   â”‚
â”‚  æ€§èƒ½        â”‚  ä¸€èˆ¬           â”‚  æ›´é«˜                     â”‚
â”‚  ä½¿ç”¨å¤æ‚åº¦  â”‚  ç®€å•           â”‚  å¤æ‚                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 10.4 æ³¨æ„äº‹é¡¹

```java
/**
 * ä½¿ç”¨æ³¨æ„äº‹é¡¹
 */
public class ReadWriteLockNotes {
    
    private final ReentrantReadWriteLock rwl = new ReentrantReadWriteLock();
    
    // 1. é¿å…é”å‡çº§ï¼ˆä¼šæ­»é”ï¼‰
    public void avoidLockUpgrade() {
        rwl.readLock().lock();
        try {
            // âŒ é”™è¯¯ï¼šä¼šæ­»é”
            // rwl.writeLock().lock();
        } finally {
            rwl.readLock().unlock();
        }
    }
    
    // 2. æ­£ç¡®ä½¿ç”¨é”é™çº§
    public void correctLockDegrade() {
        rwl.writeLock().lock();
        try {
            // ä¿®æ”¹æ•°æ®
            rwl.readLock().lock();  // é”é™çº§
        } finally {
            rwl.writeLock().unlock();
        }
        try {
            // ä½¿ç”¨æ•°æ®
        } finally {
            rwl.readLock().unlock();
        }
    }
    
    // 3. è¯»é”ä¸æ”¯æŒCondition
    public void readLockNoCondition() {
        // âŒ é”™è¯¯ï¼šä¼šæŠ›å‡ºUnsupportedOperationException
        // rwl.readLock().newCondition();
        
        // âœ… æ­£ç¡®ï¼šä½¿ç”¨å†™é”çš„Condition
        Condition condition = rwl.writeLock().newCondition();
    }
    
    // 4. æ³¨æ„é”çš„é‡Šæ”¾é¡ºåº
    public void lockReleaseOrder() {
        rwl.writeLock().lock();
        rwl.readLock().lock();  // é”é™çº§
        rwl.writeLock().unlock();  // å…ˆé‡Šæ”¾å†™é”
        // ... ä½¿ç”¨æ•°æ®
        rwl.readLock().unlock();   // åé‡Šæ”¾è¯»é”
    }
}
```

---

## ğŸ“š æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **çŠ¶æ€è®¾è®¡**ï¼š32ä½stateï¼Œé«˜16ä½è¯»é”è®¡æ•°ï¼Œä½16ä½å†™é”è®¡æ•°
2. **è¯»å†™äº’æ–¥**ï¼šè¯»è¯»å…±äº«ï¼Œè¯»å†™/å†™å†™äº’æ–¥
3. **é”é™çº§**ï¼šæ”¯æŒå†™é”é™çº§ä¸ºè¯»é”ï¼Œä¿è¯æ•°æ®å¯è§æ€§
4. **é”å‡çº§**ï¼šä¸æ”¯æŒï¼Œä¼šå¯¼è‡´æ­»é”
5. **å…¬å¹³æ€§**ï¼šæ”¯æŒå…¬å¹³/éå…¬å¹³æ¨¡å¼ï¼Œéå…¬å¹³æ¨¡å¼é˜²æ­¢å†™é”é¥¥é¥¿

### é€‚ç”¨åœºæ™¯

- è¯»å¤šå†™å°‘çš„åœºæ™¯
- ç¼“å­˜ç³»ç»Ÿ
- é…ç½®ç®¡ç†
- æ•°æ®å­—å…¸

---

*æœ€åæ›´æ–°ï¼š2025-12-28*
