# Tomcatç±»åŠ è½½æœºåˆ¶æºç è§£æ

> ğŸ’¡ æ·±å…¥ç†è§£Tomcatå¦‚ä½•å®ç°ç±»åŠ è½½éš”ç¦»å’Œçƒ­éƒ¨ç½²

---

## ğŸ“š ç›®å½•

1. [ç±»åŠ è½½æ¦‚è¿°](#1-ç±»åŠ è½½æ¦‚è¿°)
2. [Tomcatç±»åŠ è½½å™¨ä½“ç³»](#2-tomcatç±»åŠ è½½å™¨ä½“ç³»)
3. [WebappClassLoader](#3-webappclassloader)
4. [ç±»åŠ è½½éš”ç¦»æœºåˆ¶](#4-ç±»åŠ è½½éš”ç¦»æœºåˆ¶)
5. [çƒ­éƒ¨ç½²å®ç°](#5-çƒ­éƒ¨ç½²å®ç°)
6. [å†…å­˜æ³„æ¼é˜²æŠ¤](#6-å†…å­˜æ³„æ¼é˜²æŠ¤)
7. [é¢è¯•è¦ç‚¹](#7-é¢è¯•è¦ç‚¹)

---

## 1. ç±»åŠ è½½æ¦‚è¿°

### 1.1 Javaç±»åŠ è½½å™¨å±‚æ¬¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Javaç±»åŠ è½½å™¨å±‚æ¬¡                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Bootstrap ClassLoader (å¯åŠ¨ç±»åŠ è½½å™¨)                       â”‚
â”‚  â”œâ”€â”€ åŠ è½½JDKæ ¸å¿ƒç±»åº“                                        â”‚
â”‚  â””â”€â”€ $JAVA_HOME/jre/lib/rt.jar                             â”‚
â”‚      â”‚                                                     â”‚
â”‚      â–¼                                                     â”‚
â”‚  Extension ClassLoader (æ‰©å±•ç±»åŠ è½½å™¨)                       â”‚
â”‚  â”œâ”€â”€ åŠ è½½JDKæ‰©å±•ç±»åº“                                        â”‚
â”‚  â””â”€â”€ $JAVA_HOME/jre/lib/ext/*.jar                          â”‚
â”‚      â”‚                                                     â”‚
â”‚      â–¼                                                     â”‚
â”‚  Application ClassLoader (åº”ç”¨ç±»åŠ è½½å™¨)                     â”‚
â”‚  â”œâ”€â”€ åŠ è½½åº”ç”¨ç¨‹åºç±»                                         â”‚
â”‚  â””â”€â”€ $CLASSPATH                                            â”‚
â”‚                                                             â”‚
â”‚  åŒäº²å§”æ´¾æ¨¡å‹ï¼š                                              â”‚
â”‚  1. å…ˆå§”æ‰˜çˆ¶ç±»åŠ è½½å™¨åŠ è½½                                     â”‚
â”‚  2. çˆ¶ç±»åŠ è½½å™¨æ— æ³•åŠ è½½æ—¶ï¼Œè‡ªå·±åŠ è½½                           â”‚
â”‚  3. ä¿è¯ç±»åŠ è½½çš„å”¯ä¸€æ€§å’Œå®‰å…¨æ€§                               â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 Tomcatç±»åŠ è½½éœ€æ±‚

```
Tomcatç±»åŠ è½½ç‰¹æ®Šéœ€æ±‚ï¼š

1. éš”ç¦»æ€§
   - ä¸åŒWebåº”ç”¨ä¹‹é—´ç±»éš”ç¦»
   - Webåº”ç”¨ä¸Tomcatå®¹å™¨ç±»éš”ç¦»
   - é¿å…ç±»å†²çª

2. å…±äº«æ€§
   - å…¬å…±ç±»åº“å¯ä»¥å…±äº«
   - å‡å°‘å†…å­˜å ç”¨
   - æé«˜åŠ è½½æ•ˆç‡

3. çµæ´»æ€§
   - æ”¯æŒçƒ­éƒ¨ç½²
   - åŠ¨æ€åŠ è½½/å¸è½½åº”ç”¨
   - ä¸å½±å“å…¶ä»–åº”ç”¨

4. å®‰å…¨æ€§
   - é˜²æ­¢æ¶æ„ä»£ç è®¿é—®å®¹å™¨ç±»
   - æ§åˆ¶ç±»çš„å¯è§æ€§
   - ä¿æŠ¤ç³»ç»Ÿå®‰å…¨
```

---

## 2. Tomcatç±»åŠ è½½å™¨ä½“ç³»

### 2.1 ç±»åŠ è½½å™¨å±‚æ¬¡ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Tomcatç±»åŠ è½½å™¨ä½“ç³»                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Bootstrap ClassLoader                                      â”‚
â”‚      â”‚                                                     â”‚
â”‚      â–¼                                                     â”‚
â”‚  Extension ClassLoader                                      â”‚
â”‚      â”‚                                                     â”‚
â”‚      â–¼                                                     â”‚
â”‚  Application ClassLoader                                    â”‚
â”‚      â”‚                                                     â”‚
â”‚      â–¼                                                     â”‚
â”‚  Common ClassLoader                                         â”‚
â”‚  â”œâ”€â”€ $CATALINA_HOME/lib/*.jar                              â”‚
â”‚  â””â”€â”€ å®¹å™¨å’Œåº”ç”¨å…±äº«çš„ç±»                                     â”‚
â”‚      â”‚                                                     â”‚
â”‚      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚      â–¼                 â–¼                 â–¼                 â”‚
â”‚  Catalina          Server            Shared                â”‚
â”‚  ClassLoader       ClassLoader       ClassLoader           â”‚
â”‚  (å®¹å™¨ç±»)          (æœåŠ¡å™¨ç±»)        (å…±äº«ç±»)              â”‚
â”‚      â”‚                 â”‚                 â”‚                 â”‚
â”‚      â”‚                 â”‚                 â–¼                 â”‚
â”‚      â”‚                 â”‚            WebappClassLoader      â”‚
â”‚      â”‚                 â”‚            â”œâ”€â”€ /WEB-INF/classes  â”‚
â”‚      â”‚                 â”‚            â”œâ”€â”€ /WEB-INF/lib/*.jarâ”‚
â”‚      â”‚                 â”‚            â””â”€â”€ Webåº”ç”¨ç±»          â”‚
â”‚      â”‚                 â”‚                 â”‚                 â”‚
â”‚      â”‚                 â”‚                 â–¼                 â”‚
â”‚      â”‚                 â”‚            JasperLoader           â”‚
â”‚      â”‚                 â”‚            â””â”€â”€ JSPç¼–è¯‘ç±»          â”‚
â”‚      â”‚                 â”‚                                   â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 å„ç±»åŠ è½½å™¨èŒè´£

```java
/**
 * Tomcatç±»åŠ è½½å™¨èŒè´£åˆ†å·¥
 */
public class TomcatClassLoaderResponsibilities {
    
    // 1. Common ClassLoader
    // - åŠ è½½Tomcatå’ŒWebåº”ç”¨å…±äº«çš„ç±»
    // - $CATALINA_HOME/lib/*.jar
    // - å¦‚servlet-api.jar, jsp-api.jarç­‰
    
    // 2. Catalina ClassLoader  
    // - åŠ è½½Tomcatå®¹å™¨ä¸“ç”¨ç±»
    // - $CATALINA_HOME/server/lib/*.jar
    // - å¯¹Webåº”ç”¨ä¸å¯è§
    
    // 3. Shared ClassLoader
    // - åŠ è½½æ‰€æœ‰Webåº”ç”¨å…±äº«çš„ç±»
    // - $CATALINA_HOME/shared/lib/*.jar
    // - å¯¹å®¹å™¨ä¸å¯è§
    
    // 4. WebappClassLoader
    // - åŠ è½½ç‰¹å®šWebåº”ç”¨çš„ç±»
    // - /WEB-INF/classes/
    // - /WEB-INF/lib/*.jar
    // - å®ç°åº”ç”¨éš”ç¦»
    
    // 5. JasperLoader
    // - åŠ è½½JSPç¼–è¯‘åçš„ç±»
    // - æ”¯æŒJSPçƒ­åŠ è½½
    // - æ¯ä¸ªJSPä¸€ä¸ªç±»åŠ è½½å™¨
}
```

---

## 3. WebappClassLoader

### 3.1 WebappClassLoaderç±»ç»“æ„

```java
/**
 * WebappClassLoader - Webåº”ç”¨ç±»åŠ è½½å™¨
 * å®ç°Webåº”ç”¨çš„ç±»åŠ è½½éš”ç¦»
 */
public class WebappClassLoader extends URLClassLoader implements Lifecycle {
    
    private static final Log log = LogFactory.getLog(WebappClassLoader.class);
    
    // ğŸ”¥ èµ„æºé›†åˆ
    protected WebResourceRoot resources = null;
    
    // ğŸ”¥ å§”æ‰˜æ ‡å¿—
    protected boolean delegate = false;
    
    // ğŸ”¥ æœç´¢å¤–éƒ¨ä»“åº“ä¼˜å…ˆ
    protected boolean searchExternalFirst = false;
    
    // ğŸ”¥ åŒ…è¿‡æ»¤å™¨
    protected final Set<String> packageTriggers = new HashSet<>();
    
    // ğŸ”¥ èµ„æºç¼“å­˜
    protected final Map<String, ResourceEntry> resourceEntries = 
        new ConcurrentHashMap<>();
    
    // ğŸ”¥ æœªæ‰¾åˆ°çš„èµ„æºç¼“å­˜
    protected final Set<String> notFoundResources = 
        ConcurrentHashMap.newKeySet();
    
    // ğŸ”¥ æƒé™é›†åˆ
    protected final HashMap<String, PermissionCollection> loaderPC = new HashMap<>();
    
    // ğŸ”¥ çŠ¶æ€æ ‡å¿—
    protected LifecycleState state = LifecycleState.NEW;
    
    // ğŸ”¥ æ˜¯å¦å·²å¯åŠ¨
    protected boolean started = false;
    
    /**
     * ğŸ”¥ åŠ è½½ç±» - æ ¸å¿ƒæ–¹æ³•
     */
    @Override
    public Class<?> loadClass(String name, boolean resolve) throws ClassNotFoundException {
        
        synchronized (getClassLoadingLock(name)) {
            if (log.isDebugEnabled()) {
                log.debug("loadClass(" + name + ", " + resolve + ")");
            }
            
            Class<?> clazz = null;
            
            // ğŸ”¥ æ£€æŸ¥æœ¬åœ°ç¼“å­˜
            clazz = findLoadedClass0(name);
            if (clazz != null) {
                if (log.isDebugEnabled()) {
                    log.debug("  Returning class from cache");
                }
                if (resolve) {
                    resolveClass(clazz);
                }
                return clazz;
            }
            
            // ğŸ”¥ æ£€æŸ¥ç³»ç»Ÿç±»ç¼“å­˜
            clazz = findLoadedClass(name);
            if (clazz != null) {
                if (log.isDebugEnabled()) {
                    log.debug("  Returning class from cache");
                }
                if (resolve) {
                    resolveClass(clazz);
                }
                return clazz;
            }
            
            // ğŸ”¥ æ£€æŸ¥æ˜¯å¦ä¸ºç³»ç»Ÿç±»
            String resourceName = binaryNameToPath(name, false);
            
            ClassLoader javaseLoader = getJavaseClassLoader();
            boolean tryLoadingFromJavaseLoader;
            try {
                // Use getResource as it won't trigger an expensive
                // ClassNotFoundException if the resource is not available from
                // the Java SE class loader. However (see
                // https://bz.apache.org/bugzilla/show_bug.cgi?id=58125 for
                // details) when running under a security manager in rare cases
                // this call may trigger a ClassCircularityError.
                // See https://bz.apache.org/bugzilla/show_bug.cgi?id=61424 for
                // details of how this may trigger a StackOverflowError
                // Given these reported errors, catch Throwable to ensure any
                // other edge cases are also caught
                URL url;
                if (securityManager != null) {
                    PrivilegedAction<URL> dp = new PrivilegedJavaseGetResource(resourceName);
                    url = AccessController.doPrivileged(dp);
                } else {
                    url = javaseLoader.getResource(resourceName);
                }
                tryLoadingFromJavaseLoader = (url != null);
            } catch (Throwable t) {
                // Swallow all exceptions apart from those that must be re-thrown
                ExceptionUtils.handleThrowable(t);
                // The getResource() trick won't work for this class. We have to
                // try loading it directly and accept that we might get a
                // ClassNotFoundException.
                tryLoadingFromJavaseLoader = true;
            }
            
            if (tryLoadingFromJavaseLoader) {
                try {
                    clazz = javaseLoader.loadClass(name);
                    if (clazz != null) {
                        if (resolve) {
                            resolveClass(clazz);
                        }
                        return clazz;
                    }
                } catch (ClassNotFoundException e) {
                    // Ignore
                }
            }
            
            // ğŸ”¥ æ£€æŸ¥æƒé™
            if (securityManager != null) {
                int i = name.lastIndexOf('.');
                if (i >= 0) {
                    try {
                        securityManager.checkPackageAccess(name.substring(0, i));
                    } catch (SecurityException se) {
                        String error = "Security Violation, attempt to use " +
                            "Restricted Class: " + name;
                        log.info(error, se);
                        throw new ClassNotFoundException(error, se);
                    }
                }
            }
            
            boolean delegateLoad = delegate || filter(name, true);
            
            // ğŸ”¥ å§”æ‰˜åŠ è½½
            if (delegateLoad) {
                if (log.isDebugEnabled()) {
                    log.debug("  Delegating to parent classloader1 " + parent);
                }
                try {
                    clazz = Class.forName(name, false, parent);
                    if (clazz != null) {
                        if (log.isDebugEnabled()) {
                            log.debug("  Loading class from parent");
                        }
                        if (resolve) {
                            resolveClass(clazz);
                        }
                        return clazz;
                    }
                } catch (ClassNotFoundException e) {
                    // Ignore
                }
            }
            
            // ğŸ”¥ æœ¬åœ°åŠ è½½
            if (log.isDebugEnabled()) {
                log.debug("  Searching local repositories");
            }
            try {
                clazz = findClass(name);
                if (clazz != null) {
                    if (log.isDebugEnabled()) {
                        log.debug("  Loading class from local repository");
                    }
                    if (resolve) {
                        resolveClass(clazz);
                    }
                    return clazz;
                }
            } catch (ClassNotFoundException e) {
                // Ignore
            }
            
            // ğŸ”¥ å§”æ‰˜ç»™çˆ¶ç±»åŠ è½½å™¨
            if (!delegateLoad) {
                if (log.isDebugEnabled()) {
                    log.debug("  Delegating to parent classloader at end: " + parent);
                }
                try {
                    clazz = Class.forName(name, false, parent);
                    if (clazz != null) {
                        if (log.isDebugEnabled()) {
                            log.debug("  Loading class from parent");
                        }
                        if (resolve) {
                            resolveClass(clazz);
                        }
                        return clazz;
                    }
                } catch (ClassNotFoundException e) {
                    // Ignore
                }
            }
        }
        
        throw new ClassNotFoundException(name);
    }
    
    /**
     * ğŸ”¥ æŸ¥æ‰¾ç±»
     */
    @Override
    public Class<?> findClass(String name) throws ClassNotFoundException {
        
        if (log.isDebugEnabled()) {
            log.debug("    findClass(" + name + ")");
        }
        
        checkStateForClassLoading(name);
        
        // (1) Permission to define this class when using a SecurityManager
        if (securityManager != null) {
            int i = name.lastIndexOf('.');
            if (i >= 0) {
                try {
                    if (log.isTraceEnabled()) {
                        log.trace("      securityManager.checkPackageDefinition");
                    }
                    securityManager.checkPackageDefinition(name.substring(0, i));
                } catch (Exception se) {
                    if (log.isTraceEnabled()) {
                        log.trace("      -->Exception-->ClassNotFoundException", se);
                    }
                    throw new ClassNotFoundException(name, se);
                }
            }
        }
        
        // Ask our superclass to locate this class, if possible
        // (throws ClassNotFoundException if it is not found)
        Class<?> clazz = null;
        try {
            if (log.isTraceEnabled()) {
                log.trace("      findClassInternal(" + name + ")");
            }
            
            try {
                if (securityManager != null) {
                    PrivilegedAction<Class<?>> dp = new PrivilegedFindClassByName(name);
                    clazz = AccessController.doPrivileged(dp);
                } else {
                    clazz = findClassInternal(name);
                }
            } catch (AccessControlException ace) {
                log.warn("WebappClassLoader.findClassInternal(" + name + 
                    ") security exception: " + ace.getMessage(), ace);
                throw new ClassNotFoundException(name, ace);
            } catch (RuntimeException e) {
                if (log.isTraceEnabled()) {
                    log.trace("      -->RuntimeException Rethrown", e);
                }
                throw e;
            }
            
            if ((clazz == null) && hasExternalRepositories) {
                try {
                    clazz = super.findClass(name);
                } catch (AccessControlException ace) {
                    log.warn("WebappClassLoader.findClass(" + name + 
                        ") security exception: " + ace.getMessage(), ace);
                    throw new ClassNotFoundException(name, ace);
                } catch (RuntimeException e) {
                    if (log.isTraceEnabled()) {
                        log.trace("      -->RuntimeException Rethrown", e);
                    }
                    throw e;
                }
            }
            
            if (clazz == null) {
                if (log.isDebugEnabled()) {
                    log.debug("    --> Returning ClassNotFoundException");
                }
                throw new ClassNotFoundException(name);
            }
        } catch (ClassNotFoundException e) {
            if (log.isTraceEnabled()) {
                log.trace("    --> Passing on ClassNotFoundException");
            }
            throw e;
        }
        
        // Return the class we have located
        if (log.isTraceEnabled()) {
            log.debug("      Returning class " + clazz);
        }
        
        if (log.isTraceEnabled()) {
            ClassLoader cl;
            if (Globals.IS_SECURITY_ENABLED) {
                cl = AccessController.doPrivileged(new PrivilegedGetClassLoader(clazz));
            } else {
                cl = clazz.getClassLoader();
            }
            log.debug("      Loaded by " + cl.toString());
        }
        return clazz;
    }
}
```

---

## 4. ç±»åŠ è½½éš”ç¦»æœºåˆ¶

### 4.1 éš”ç¦»åŸç†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Tomcatç±»åŠ è½½éš”ç¦»æœºåˆ¶                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  åº”ç”¨A (WebappClassLoader A)                                â”‚
â”‚  â”œâ”€â”€ /WEB-INF/classes/                                      â”‚
â”‚  â”œâ”€â”€ /WEB-INF/lib/spring-3.2.jar                           â”‚
â”‚  â””â”€â”€ åªèƒ½è®¿é—®è‡ªå·±çš„ç±»å’Œå…±äº«ç±»                                â”‚
â”‚      â”‚                                                     â”‚
â”‚      â”‚  éš”ç¦»è¾¹ç•Œ                                            â”‚
â”‚      â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚
â”‚      â”‚                                                     â”‚
â”‚  åº”ç”¨B (WebappClassLoader B)                                â”‚
â”‚  â”œâ”€â”€ /WEB-INF/classes/                                      â”‚
â”‚  â”œâ”€â”€ /WEB-INF/lib/spring-4.1.jar                           â”‚
â”‚  â””â”€â”€ åªèƒ½è®¿é—®è‡ªå·±çš„ç±»å’Œå…±äº«ç±»                                â”‚
â”‚                                                             â”‚
â”‚  å…±äº«åŒºåŸŸ (Shared ClassLoader)                              â”‚
â”‚  â”œâ”€â”€ å…¬å…±å·¥å…·ç±»                                             â”‚
â”‚  â”œâ”€â”€ æ•°æ®åº“é©±åŠ¨                                             â”‚
â”‚  â””â”€â”€ æ‰€æœ‰åº”ç”¨éƒ½å¯è®¿é—®                                       â”‚
â”‚                                                             â”‚
â”‚  å®¹å™¨åŒºåŸŸ (Catalina ClassLoader)                            â”‚
â”‚  â”œâ”€â”€ Tomcatå†…éƒ¨ç±»                                           â”‚
â”‚  â”œâ”€â”€ å®¹å™¨ç®¡ç†ç±»                                             â”‚
â”‚  â””â”€â”€ åº”ç”¨æ— æ³•è®¿é—®                                           â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 å§”æ‰˜æœºåˆ¶å®ç°

```java
/**
 * WebappClassLoaderå§”æ‰˜æœºåˆ¶
 */
public class WebappClassLoaderDelegation {
    
    /**
     * ğŸ”¥ ç±»åŠ è½½å§”æ‰˜ç­–ç•¥
     */
    public Class<?> loadClassWithDelegation(String name, boolean resolve) 
            throws ClassNotFoundException {
        
        // 1. æ£€æŸ¥æ˜¯å¦å·²åŠ è½½
        Class<?> clazz = findLoadedClass(name);
        if (clazz != null) {
            return clazz;
        }
        
        // 2. ç³»ç»Ÿç±»ä¼˜å…ˆ
        if (isSystemClass(name)) {
            return loadSystemClass(name);
        }
        
        // 3. æ£€æŸ¥å§”æ‰˜æ ‡å¿—
        boolean delegateLoad = delegate || filter(name, true);
        
        if (delegateLoad) {
            // ğŸ”¥ å§”æ‰˜ç»™çˆ¶ç±»åŠ è½½å™¨
            try {
                clazz = parent.loadClass(name);
                if (clazz != null) {
                    return clazz;
                }
            } catch (ClassNotFoundException e) {
                // ç»§ç»­æœ¬åœ°åŠ è½½
            }
        }
        
        // 4. æœ¬åœ°åŠ è½½
        try {
            clazz = findClass(name);
            if (clazz != null) {
                return clazz;
            }
        } catch (ClassNotFoundException e) {
            // ç»§ç»­å§”æ‰˜
        }
        
        // 5. æœ€åå§”æ‰˜ç»™çˆ¶ç±»
        if (!delegateLoad) {
            clazz = parent.loadClass(name);
        }
        
        return clazz;
    }
    
    /**
     * ğŸ”¥ åŒ…è¿‡æ»¤æœºåˆ¶
     */
    protected boolean filter(String name, boolean isClassName) {
        
        if (name == null) {
            return false;
        }
        
        char ch;
        if (name.startsWith("javax")) {
            return true;
        }
        if (name.startsWith("java")) {
            return true;
        }
        if (name.startsWith("org.apache.catalina")) {
            return true;
        }
        if (name.startsWith("org.apache.coyote")) {
            return true;
        }
        if (name.startsWith("org.apache.jasper")) {
            return true;
        }
        if (name.startsWith("org.apache.naming")) {
            return true;
        }
        if (name.startsWith("org.apache.tomcat")) {
            return true;
        }
        
        return false;
    }
}
```

### 4.3 èµ„æºæŸ¥æ‰¾æœºåˆ¶

```java
/**
 * èµ„æºæŸ¥æ‰¾å’Œç¼“å­˜æœºåˆ¶
 */
public class ResourceFindingMechanism {
    
    // ğŸ”¥ èµ„æºç¼“å­˜
    protected final Map<String, ResourceEntry> resourceEntries = 
        new ConcurrentHashMap<>();
    
    // ğŸ”¥ æœªæ‰¾åˆ°èµ„æºç¼“å­˜
    protected final Set<String> notFoundResources = 
        ConcurrentHashMap.newKeySet();
    
    /**
     * ğŸ”¥ æŸ¥æ‰¾ç±»èµ„æº
     */
    protected Class<?> findClassInternal(String name) throws ClassNotFoundException {
        
        checkStateForResourceLoading(name);
        
        String path = binaryNameToPath(name, true);
        
        ResourceEntry entry = resourceEntries.get(path);
        WebResource resource = null;
        
        if (entry == null) {
            // ğŸ”¥ ä»èµ„æºæ ¹æŸ¥æ‰¾
            resource = resources.getClassLoaderResource(path);
            
            if (!resource.exists()) {
                // ğŸ”¥ æ·»åŠ åˆ°æœªæ‰¾åˆ°ç¼“å­˜
                notFoundResources.add(path);
                throw new ClassNotFoundException(name);
            }
            
            // ğŸ”¥ åˆ›å»ºèµ„æºæ¡ç›®
            entry = new ResourceEntry();
            entry.lastModified = resource.getLastModified();
            
            // ğŸ”¥ è¯»å–å­—èŠ‚ç 
            try (InputStream binaryStream = resource.getInputStream()) {
                byte[] binaryContent = IOTools.readFully(binaryStream, (int) resource.getContentLength());
                entry.binaryContent = binaryContent;
            } catch (IOException e) {
                throw new ClassNotFoundException(name, e);
            }
            
            // ğŸ”¥ ç¼“å­˜èµ„æºæ¡ç›®
            resourceEntries.put(path, entry);
        } else {
            // ğŸ”¥ æ£€æŸ¥èµ„æºæ˜¯å¦è¿‡æœŸ
            resource = resources.getClassLoaderResource(path);
            if (!resource.exists()) {
                resourceEntries.remove(path);
                notFoundResources.add(path);
                throw new ClassNotFoundException(name);
            }
            
            if (resource.getLastModified() != entry.lastModified) {
                // ğŸ”¥ èµ„æºå·²æ›´æ–°ï¼Œé‡æ–°åŠ è½½
                try (InputStream binaryStream = resource.getInputStream()) {
                    byte[] binaryContent = IOTools.readFully(binaryStream, (int) resource.getContentLength());
                    entry.binaryContent = binaryContent;
                    entry.lastModified = resource.getLastModified();
                } catch (IOException e) {
                    throw new ClassNotFoundException(name, e);
                }
            }
        }
        
        // ğŸ”¥ å®šä¹‰ç±»
        return defineClass(name, entry.binaryContent, 0, entry.binaryContent.length);
    }
    
    /**
     * ğŸ”¥ èµ„æºæ¡ç›®
     */
    protected static final class ResourceEntry {
        public long lastModified = -1;
        public byte[] binaryContent = null;
        public volatile Class<?> loadedClass = null;
    }
}
```

---

## 5. çƒ­éƒ¨ç½²å®ç°

### 5.1 çƒ­éƒ¨ç½²åŸç†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Tomcatçƒ­éƒ¨ç½²æœºåˆ¶                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  1. æ–‡ä»¶ç›‘æ§                                                â”‚
â”‚  â”œâ”€â”€ HostConfigç›‘æ§webappsç›®å½•                              â”‚
â”‚  â”œâ”€â”€ Contextç›‘æ§WEB-INFç›®å½•                                 â”‚
â”‚  â””â”€â”€ æ£€æµ‹æ–‡ä»¶å˜åŒ–                                           â”‚
â”‚      â”‚                                                     â”‚
â”‚      â–¼                                                     â”‚
â”‚  2. åº”ç”¨é‡è½½                                                â”‚
â”‚  â”œâ”€â”€ åœæ­¢æ—§åº”ç”¨                                             â”‚
â”‚  â”œâ”€â”€ é”€æ¯WebappClassLoader                                  â”‚
â”‚  â”œâ”€â”€ æ¸…ç†èµ„æºå’Œç¼“å­˜                                         â”‚
â”‚  â””â”€â”€ åˆ›å»ºæ–°çš„WebappClassLoader                              â”‚
â”‚      â”‚                                                     â”‚
â”‚      â–¼                                                     â”‚
â”‚  3. é‡æ–°éƒ¨ç½²                                                â”‚
â”‚  â”œâ”€â”€ é‡æ–°è§£æweb.xml                                        â”‚
â”‚  â”œâ”€â”€ é‡æ–°åŠ è½½ç±»å’Œèµ„æº                                       â”‚
â”‚  â”œâ”€â”€ é‡æ–°åˆå§‹åŒ–Servlet                                      â”‚
â”‚  â””â”€â”€ å¯åŠ¨æ–°åº”ç”¨                                             â”‚
â”‚                                                             â”‚
â”‚  çƒ­éƒ¨ç½²ä¼˜åŠ¿ï¼š                                                â”‚
â”‚  âœ… æ— éœ€é‡å¯Tomcat                                          â”‚
â”‚  âœ… å…¶ä»–åº”ç”¨ä¸å—å½±å“                                        â”‚
â”‚  âœ… å¼€å‘æ•ˆç‡é«˜                                              â”‚
â”‚                                                             â”‚
â”‚  æ³¨æ„äº‹é¡¹ï¼š                                                  â”‚
â”‚  âš ï¸  å¯èƒ½å¯¼è‡´å†…å­˜æ³„æ¼                                       â”‚
â”‚  âš ï¸  é™æ€å˜é‡ä¸ä¼šé‡ç½®                                       â”‚
â”‚  âš ï¸  çº¿ç¨‹å¯èƒ½æ— æ³•æ­£ç¡®æ¸…ç†                                   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 HostConfigçƒ­éƒ¨ç½²å®ç°

```java
/**
 * HostConfig - ä¸»æœºé…ç½®å’Œçƒ­éƒ¨ç½²ç®¡ç†
 */
public class HostConfig implements LifecycleListener {
    
    private static final Log log = LogFactory.getLog(HostConfig.class);
    
    // ğŸ”¥ éƒ¨ç½²çš„åº”ç”¨
    protected final Map<String, DeployedApplication> deployed = new HashMap<>();
    
    // ğŸ”¥ è‡ªåŠ¨éƒ¨ç½²æ ‡å¿—
    protected boolean autoDeploy = true;
    
    // ğŸ”¥ æ£€æŸ¥é—´éš”
    protected int checkInterval = 15;
    
    /**
     * ğŸ”¥ æ£€æŸ¥åº”ç”¨å˜åŒ–
     */
    protected void check() {
        
        if (host.getAutoDeploy()) {
            // ğŸ”¥ æ£€æŸ¥æ–°åº”ç”¨
            deployApps();
            
            // ğŸ”¥ æ£€æŸ¥å·²éƒ¨ç½²åº”ç”¨çš„å˜åŒ–
            for (Iterator<Map.Entry<String, DeployedApplication>> iterator = 
                 deployed.entrySet().iterator(); iterator.hasNext();) {
                
                Map.Entry<String, DeployedApplication> entry = iterator.next();
                DeployedApplication app = entry.getValue();
                
                if (app.hasChanged()) {
                    // ğŸ”¥ åº”ç”¨å·²å˜åŒ–ï¼Œéœ€è¦é‡æ–°éƒ¨ç½²
                    if (log.isInfoEnabled()) {
                        log.info("Application " + app.name + " has changed, redeploying");
                    }
                    
                    // åœæ­¢åº”ç”¨
                    Context context = (Context) host.findChild(app.name);
                    if (context != null) {
                        context.reload();
                    }
                }
            }
        }
    }
    
    /**
     * ğŸ”¥ å·²éƒ¨ç½²åº”ç”¨ä¿¡æ¯
     */
    protected static class DeployedApplication {
        public String name;
        public boolean hasDescriptor = false;
        public boolean hasWar = false;
        public boolean hasDirectory = false;
        
        // ğŸ”¥ æ–‡ä»¶æ—¶é—´æˆ³
        public long descriptorLastModified = -1;
        public long warLastModified = -1;
        public long directoryLastModified = -1;
        
        // ğŸ”¥ èµ„æºæ—¶é—´æˆ³
        public final LinkedHashMap<String, Long> reloadResources = new LinkedHashMap<>();
        
        /**
         * ğŸ”¥ æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
         */
        public boolean hasChanged() {
            
            // æ£€æŸ¥æè¿°ç¬¦
            if (hasDescriptor) {
                File descriptor = new File(host.getConfigBaseFile(), name + ".xml");
                if (descriptor.exists()) {
                    if (descriptor.lastModified() > descriptorLastModified) {
                        return true;
                    }
                } else {
                    return true; // æè¿°ç¬¦è¢«åˆ é™¤
                }
            }
            
            // æ£€æŸ¥WARæ–‡ä»¶
            if (hasWar) {
                File war = new File(host.getAppBaseFile(), name + ".war");
                if (war.exists()) {
                    if (war.lastModified() > warLastModified) {
                        return true;
                    }
                } else {
                    return true; // WARæ–‡ä»¶è¢«åˆ é™¤
                }
            }
            
            // æ£€æŸ¥ç›®å½•
            if (hasDirectory) {
                File dir = new File(host.getAppBaseFile(), name);
                if (dir.exists()) {
                    if (dir.lastModified() > directoryLastModified) {
                        return true;
                    }
                } else {
                    return true; // ç›®å½•è¢«åˆ é™¤
                }
            }
            
            // æ£€æŸ¥é‡è½½èµ„æº
            for (Map.Entry<String, Long> entry : reloadResources.entrySet()) {
                File resource = new File(entry.getKey());
                if (resource.exists()) {
                    if (resource.lastModified() > entry.getValue()) {
                        return true;
                    }
                } else {
                    return true; // èµ„æºè¢«åˆ é™¤
                }
            }
            
            return false;
        }
    }
}
```

### 5.3 Contexté‡è½½æœºåˆ¶

```java
/**
 * StandardContexté‡è½½æœºåˆ¶
 */
public class StandardContext extends ContainerBase implements Context {
    
    /**
     * ğŸ”¥ é‡è½½åº”ç”¨
     */
    @Override
    public synchronized void reload() {
        
        // ğŸ”¥ è®¾ç½®é‡è½½æ ‡å¿—
        setPaused(true);
        
        try {
            // ğŸ”¥ åœæ­¢åº”ç”¨
            stop();
        } catch (LifecycleException e) {
            log.error("Error stopping context " + getName(), e);
        }
        
        try {
            // ğŸ”¥ å¯åŠ¨åº”ç”¨
            start();
        } catch (LifecycleException e) {
            log.error("Error starting context " + getName(), e);
        }
        
        // ğŸ”¥ æ¸…é™¤é‡è½½æ ‡å¿—
        setPaused(false);
    }
    
    /**
     * ğŸ”¥ åœæ­¢åº”ç”¨
     */
    @Override
    protected synchronized void stopInternal() throws LifecycleException {
        
        // ğŸ”¥ åœæ­¢å­å®¹å™¨
        Container children[] = findChildren();
        for (Container child : children) {
            child.stop();
        }
        
        // ğŸ”¥ åœæ­¢è¿‡æ»¤å™¨
        filterStop();
        
        // ğŸ”¥ åœæ­¢åº”ç”¨ç›‘å¬å™¨
        listenerStop();
        
        // ğŸ”¥ æ¸…ç†ç±»åŠ è½½å™¨
        if (loader != null && loader instanceof Lifecycle) {
            ((Lifecycle) loader).stop();
        }
        
        // ğŸ”¥ æ¸…ç†ç®¡ç†å™¨
        if (manager != null && manager instanceof Lifecycle) {
            ((Lifecycle) manager).stop();
        }
        
        // ğŸ”¥ æ¸…ç†èµ„æº
        if (resources != null && resources instanceof Lifecycle) {
            ((Lifecycle) resources).stop();
        }
        
        setState(LifecycleState.STOPPED);
    }
    
    /**
     * ğŸ”¥ å¯åŠ¨åº”ç”¨
     */
    @Override
    protected synchronized void startInternal() throws LifecycleException {
        
        // ğŸ”¥ åˆ›å»ºæ–°çš„ç±»åŠ è½½å™¨
        if (getLoader() == null) {
            WebappLoader webappLoader = new WebappLoader(getParentClassLoader());
            webappLoader.setDelegate(getDelegate());
            setLoader(webappLoader);
        }
        
        // ğŸ”¥ å¯åŠ¨ç±»åŠ è½½å™¨
        if (loader != null && loader instanceof Lifecycle) {
            ((Lifecycle) loader).start();
        }
        
        // ğŸ”¥ å¯åŠ¨èµ„æº
        if (resources != null && resources instanceof Lifecycle) {
            ((Lifecycle) resources).start();
        }
        
        // ğŸ”¥ å¯åŠ¨ç®¡ç†å™¨
        if (manager != null && manager instanceof Lifecycle) {
            ((Lifecycle) manager).start();
        }
        
        // ğŸ”¥ å¯åŠ¨åº”ç”¨ç›‘å¬å™¨
        listenerStart();
        
        // ğŸ”¥ å¯åŠ¨è¿‡æ»¤å™¨
        filterStart();
        
        // ğŸ”¥ å¯åŠ¨å­å®¹å™¨
        Container children[] = findChildren();
        for (Container child : children) {
            child.start();
        }
        
        setState(LifecycleState.STARTED);
    }
}
```

---

## 6. å†…å­˜æ³„æ¼é˜²æŠ¤

### 6.1 å†…å­˜æ³„æ¼åŸå› 

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Tomcatå†…å­˜æ³„æ¼å¸¸è§åŸå›                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  1. ç±»åŠ è½½å™¨æ³„æ¼                                            â”‚
â”‚  â”œâ”€â”€ WebappClassLoaderæ— æ³•è¢«GCå›æ”¶                          â”‚
â”‚  â”œâ”€â”€ é™æ€å˜é‡æŒæœ‰åº”ç”¨ç±»å¼•ç”¨                                 â”‚
â”‚  â””â”€â”€ ç¬¬ä¸‰æ–¹åº“æ³¨å†Œå…¨å±€å›è°ƒ                                   â”‚
â”‚                                                             â”‚
â”‚  2. çº¿ç¨‹æ³„æ¼                                                â”‚
â”‚  â”œâ”€â”€ åº”ç”¨å¯åŠ¨çš„çº¿ç¨‹æœªæ­£ç¡®å…³é—­                               â”‚
â”‚  â”œâ”€â”€ çº¿ç¨‹æ± æœªæ­£ç¡®shutdown                                   â”‚
â”‚  â””â”€â”€ Timer/TimerTaskæœªå–æ¶ˆ                                  â”‚
â”‚                                                             â”‚
â”‚  3. èµ„æºæ³„æ¼                                                â”‚
â”‚  â”œâ”€â”€ æ•°æ®åº“è¿æ¥æœªå…³é—­                                       â”‚
â”‚  â”œâ”€â”€ æ–‡ä»¶æµæœªå…³é—­                                           â”‚
â”‚  â””â”€â”€ Socketè¿æ¥æœªå…³é—­                                       â”‚
â”‚                                                             â”‚
â”‚  4. ç¼“å­˜æ³„æ¼                                                â”‚
â”‚  â”œâ”€â”€ é™æ€Mapç¼“å­˜æœªæ¸…ç†                                      â”‚
â”‚  â”œâ”€â”€ ç¬¬ä¸‰æ–¹ç¼“å­˜æœªæ¸…ç†                                       â”‚
â”‚  â””â”€â”€ JVMçº§åˆ«ç¼“å­˜æœªæ¸…ç†                                      â”‚
â”‚                                                             â”‚
â”‚  5. ç›‘å¬å™¨æ³„æ¼                                              â”‚
â”‚  â”œâ”€â”€ JMX MBeanæœªæ³¨é”€                                        â”‚
â”‚  â”œâ”€â”€ äº‹ä»¶ç›‘å¬å™¨æœªç§»é™¤                                       â”‚
â”‚  â””â”€â”€ å›è°ƒå‡½æ•°æœªæ¸…ç†                                         â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 WebappClassLoaderBaseå†…å­˜æ³„æ¼æ£€æµ‹

```java
/**
 * WebappClassLoaderBaseå†…å­˜æ³„æ¼æ£€æµ‹å’Œæ¸…ç†
 */
public abstract class WebappClassLoaderBase extends URLClassLoader implements Lifecycle {
    
    /**
     * ğŸ”¥ æ¸…ç†èµ„æºï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
     */
    @Override
    protected void stopInternal() throws LifecycleException {
        
        if (log.isDebugEnabled()) {
            log.debug("Stopping WebappClassLoader");
        }
        
        setState(LifecycleState.STOPPING);
        
        // ğŸ”¥ æ¸…ç†èµ„æºç¼“å­˜
        resourceEntries.clear();
        notFoundResources.clear();
        
        // ğŸ”¥ æ£€æŸ¥å’Œæ¸…ç†å†…å­˜æ³„æ¼
        checkForLeaks();
        
        // ğŸ”¥ æ¸…ç†æƒé™
        loaderPC.clear();
        
        // ğŸ”¥ æ¸…ç†åŒ…è§¦å‘å™¨
        packageTriggers.clear();
        
        setState(LifecycleState.STOPPED);
    }
    
    /**
     * ğŸ”¥ æ£€æŸ¥å†…å­˜æ³„æ¼
     */
    private void checkForLeaks() {
        
        // ğŸ”¥ æ£€æŸ¥çº¿ç¨‹æ³„æ¼
        checkThreadLocalMapForLeaks();
        
        // ğŸ”¥ æ£€æŸ¥JDBCé©±åŠ¨æ³„æ¼
        checkForJdbcDriverLeaks();
        
        // ğŸ”¥ æ£€æŸ¥çº¿ç¨‹æ³„æ¼
        checkForThreadLeaks();
        
        // ğŸ”¥ æ£€æŸ¥èµ„æºæŸæ³„æ¼
        checkForResourceBundleLeaks();
        
        // ğŸ”¥ å¼ºåˆ¶åƒåœ¾å›æ”¶
        if (clearReferencesStopTimerThreads || clearReferencesStopThreads) {
            System.gc();
        }
    }
    
    /**
     * ğŸ”¥ æ£€æŸ¥ThreadLocalæ³„æ¼
     */
    private void checkThreadLocalMapForLeaks() {
        
        Thread[] threads = getThreads();
        
        try {
            // ğŸ”¥ è·å–ThreadLocalMapå­—æ®µ
            Field threadLocalsField = Thread.class.getDeclaredField("threadLocals");
            threadLocalsField.setAccessible(true);
            Field inheritableThreadLocalsField = Thread.class.getDeclaredField("inheritableThreadLocals");
            inheritableThreadLocalsField.setAccessible(true);
            
            // ğŸ”¥ è·å–ThreadLocalMap.Entryå­—æ®µ
            Class<?> tlmClass = Class.forName("java.lang.ThreadLocal$ThreadLocalMap");
            Field tableField = tlmClass.getDeclaredField("table");
            tableField.setAccessible(true);
            
            for (Thread thread : threads) {
                Object threadLocalMap;
                
                // ğŸ”¥ æ£€æŸ¥threadLocals
                threadLocalMap = threadLocalsField.get(thread);
                if (threadLocalMap != null) {
                    checkThreadLocalMapForLeaks(threadLocalMap, tableField);
                }
                
                // ğŸ”¥ æ£€æŸ¥inheritableThreadLocals
                threadLocalMap = inheritableThreadLocalsField.get(thread);
                if (threadLocalMap != null) {
                    checkThreadLocalMapForLeaks(threadLocalMap, tableField);
                }
            }
        } catch (Throwable t) {
            ExceptionUtils.handleThrowable(t);
            log.warn("Failed to check for ThreadLocal leaks", t);
        }
    }
    
    /**
     * ğŸ”¥ æ£€æŸ¥JDBCé©±åŠ¨æ³„æ¼
     */
    private void checkForJdbcDriverLeaks() {
        
        List<java.sql.Driver> driversToDeregister = new ArrayList<>();
        
        Enumeration<java.sql.Driver> drivers = DriverManager.getDrivers();
        while (drivers.hasMoreElements()) {
            java.sql.Driver driver = drivers.nextElement();
            
            if (driver.getClass().getClassLoader() == this) {
                // ğŸ”¥ å‘ç°ç”±æ­¤ç±»åŠ è½½å™¨åŠ è½½çš„é©±åŠ¨
                driversToDeregister.add(driver);
            }
        }
        
        // ğŸ”¥ æ³¨é”€é©±åŠ¨
        for (java.sql.Driver driver : driversToDeregister) {
            try {
                DriverManager.deregisterDriver(driver);
                log.warn("Deregistered JDBC driver " + driver);
            } catch (SQLException e) {
                log.warn("Error deregistering JDBC driver " + driver, e);
            }
        }
    }
    
    /**
     * ğŸ”¥ æ£€æŸ¥çº¿ç¨‹æ³„æ¼
     */
    private void checkForThreadLeaks() {
        
        Thread[] threads = getThreads();
        
        for (Thread thread : threads) {
            if (thread != null) {
                ClassLoader ccl = thread.getContextClassLoader();
                if (ccl == this) {
                    // ğŸ”¥ å‘ç°ä½¿ç”¨æ­¤ç±»åŠ è½½å™¨çš„çº¿ç¨‹
                    
                    // å°è¯•åœæ­¢çº¿ç¨‹
                    if (clearReferencesStopThreads) {
                        // ğŸ”¥ è®¾ç½®æ–°çš„ç±»åŠ è½½å™¨
                        thread.setContextClassLoader(parent);
                        log.warn("Cleared context class loader from thread " + thread.getName());
                        
                        // ğŸ”¥ ä¸­æ–­çº¿ç¨‹
                        if (clearReferencesStopTimerThreads) {
                            thread.interrupt();
                        }
                    } else {
                        log.warn("Thread " + thread.getName() + 
                            " is still running with context class loader " + this);
                    }
                }
            }
        }
    }
    
    /**
     * ğŸ”¥ è·å–æ‰€æœ‰çº¿ç¨‹
     */
    private Thread[] getThreads() {
        // ğŸ”¥ è·å–æ ¹çº¿ç¨‹ç»„
        ThreadGroup tg = Thread.currentThread().getThreadGroup();
        ThreadGroup parent = tg.getParent();
        while (parent != null) {
            tg = parent;
            parent = tg.getParent();
        }
        
        // ğŸ”¥ è·å–æ‰€æœ‰çº¿ç¨‹
        int threadCountGuess = tg.activeCount() + 50;
        Thread[] threads = new Thread[threadCountGuess];
        int threadCountActual = tg.enumerate(threads);
        
        // ğŸ”¥ ç¡®ä¿æ•°ç»„è¶³å¤Ÿå¤§
        while (threadCountActual == threadCountGuess) {
            threadCountGuess *= 2;
            threads = new Thread[threadCountGuess];
            threadCountActual = tg.enumerate(threads);
        }
        
        return threads;
    }
}
```

### 6.3 å†…å­˜æ³„æ¼é¢„é˜²é…ç½®

```xml
<!-- ğŸ”¥ Contexté…ç½® - é˜²æ­¢å†…å­˜æ³„æ¼ -->
<Context>
    <!-- æ¸…ç†å¼•ç”¨é…ç½® -->
    <Loader className="org.apache.catalina.loader.WebappLoader"
            clearReferencesStatic="true"
            clearReferencesStopThreads="true"
            clearReferencesStopTimerThreads="true"
            clearReferencesHttpClientKeepAliveThread="true"
            clearReferencesObjectStreamClassCaches="true"
            clearReferencesRmiTargets="true"
            clearReferencesThreadLocals="true" />
    
    <!-- JarScanneré…ç½® -->
    <JarScanner>
        <JarScanFilter 
            tldSkip="*.jar"
            pluggabilitySkip="*.jar" />
    </JarScanner>
</Context>
```

---

## 7. é¢è¯•è¦ç‚¹

### 7.1 æ ¸å¿ƒæ¦‚å¿µ

```
ğŸ¯ Tomcatç±»åŠ è½½æœºåˆ¶é¢è¯•è¦ç‚¹

1. ç±»åŠ è½½å™¨å±‚æ¬¡ç»“æ„
   Q: Tomcatçš„ç±»åŠ è½½å™¨æœ‰å“ªäº›ï¼Ÿ
   A: Bootstrap â†’ Extension â†’ Application â†’ Common â†’ 
      Catalina/Server/Shared â†’ WebappClassLoader â†’ JasperLoader

2. åŒäº²å§”æ´¾æ¨¡å‹çš„æ‰“ç ´
   Q: Tomcatä¸ºä»€ä¹ˆè¦æ‰“ç ´åŒäº²å§”æ´¾æ¨¡å‹ï¼Ÿ
   A: 
   - å®ç°Webåº”ç”¨éš”ç¦»
   - æ”¯æŒä¸åŒç‰ˆæœ¬çš„ç±»åº“
   - å®ç°çƒ­éƒ¨ç½²åŠŸèƒ½
   - æä¾›çµæ´»çš„ç±»åŠ è½½ç­–ç•¥

3. WebappClassLoaderç‰¹ç‚¹
   Q: WebappClassLoaderæœ‰ä»€ä¹ˆç‰¹æ®Šä¹‹å¤„ï¼Ÿ
   A:
   - ä¼˜å…ˆåŠ è½½WEB-INF/classeså’ŒWEB-INF/lib
   - å®ç°åº”ç”¨é—´ç±»éš”ç¦»
   - æ”¯æŒçƒ­éƒ¨ç½²å’Œé‡è½½
   - æä¾›å†…å­˜æ³„æ¼æ£€æµ‹

4. ç±»åŠ è½½é¡ºåº
   Q: WebappClassLoaderçš„ç±»åŠ è½½é¡ºåºæ˜¯ä»€ä¹ˆï¼Ÿ
   A:
   - æ£€æŸ¥æœ¬åœ°ç¼“å­˜
   - æ£€æŸ¥ç³»ç»Ÿç±»
   - æ ¹æ®delegateæ ‡å¿—å†³å®šå§”æ‰˜æ—¶æœº
   - æœ¬åœ°æŸ¥æ‰¾ï¼ˆWEB-INF/classes, WEB-INF/libï¼‰
   - å§”æ‰˜ç»™çˆ¶ç±»åŠ è½½å™¨
```

### 7.2 å®é™…åº”ç”¨

```
ğŸ”§ å®é™…åº”ç”¨åœºæ™¯

1. ç±»å†²çªè§£å†³
   é—®é¢˜: åº”ç”¨Aä½¿ç”¨Spring 3.xï¼Œåº”ç”¨Bä½¿ç”¨Spring 4.x
   è§£å†³: WebappClassLoaderéš”ç¦»ï¼Œå„è‡ªåŠ è½½è‡ªå·±çš„ç‰ˆæœ¬

2. çƒ­éƒ¨ç½²å®ç°
   åŸç†: 
   - ç›‘æ§æ–‡ä»¶å˜åŒ–
   - é”€æ¯æ—§çš„WebappClassLoader
   - åˆ›å»ºæ–°çš„WebappClassLoader
   - é‡æ–°åŠ è½½åº”ç”¨

3. å†…å­˜æ³„æ¼é¢„é˜²
   æªæ–½:
   - æ¸…ç†ThreadLocal
   - æ³¨é”€JDBCé©±åŠ¨
   - åœæ­¢åº”ç”¨çº¿ç¨‹
   - æ¸…ç†é™æ€å¼•ç”¨

4. æ€§èƒ½ä¼˜åŒ–
   ç­–ç•¥:
   - èµ„æºç¼“å­˜
   - å»¶è¿ŸåŠ è½½
   - å¹¶è¡ŒåŠ è½½
   - é¢„ç¼–è¯‘JSP
```

### 7.3 å¸¸è§é—®é¢˜

```
â“ å¸¸è§é¢è¯•é—®é¢˜

Q1: Tomcatå¦‚ä½•å®ç°å¤šä¸ªWebåº”ç”¨çš„ç±»éš”ç¦»ï¼Ÿ
A1: é€šè¿‡ä¸ºæ¯ä¸ªWebåº”ç”¨åˆ›å»ºç‹¬ç«‹çš„WebappClassLoaderå®ç°éš”ç¦»ï¼Œ
    æ¯ä¸ªç±»åŠ è½½å™¨åªèƒ½è®¿é—®è‡ªå·±çš„ç±»å’Œå…±äº«çš„ç±»ã€‚

Q2: ä¸ºä»€ä¹ˆTomcatè¦æ‰“ç ´åŒäº²å§”æ´¾æ¨¡å‹ï¼Ÿ
A2: 
- å®ç°åº”ç”¨éš”ç¦»ï¼šä¸åŒåº”ç”¨å¯ä»¥ä½¿ç”¨ä¸åŒç‰ˆæœ¬çš„ç±»åº“
- æ”¯æŒçƒ­éƒ¨ç½²ï¼šå¯ä»¥é‡æ–°åŠ è½½åº”ç”¨è€Œä¸å½±å“å…¶ä»–åº”ç”¨
- çµæ´»æ€§ï¼šå¯ä»¥ä¼˜å…ˆåŠ è½½åº”ç”¨è‡ªå·±çš„ç±»

Q3: Tomcatçƒ­éƒ¨ç½²æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ
A3:
- HostConfigç›‘æ§æ–‡ä»¶å˜åŒ–
- æ£€æµ‹åˆ°å˜åŒ–ååœæ­¢æ—§åº”ç”¨
- é”€æ¯æ—§çš„WebappClassLoader
- åˆ›å»ºæ–°çš„WebappClassLoaderé‡æ–°åŠ è½½

Q4: WebappClassLoaderå¯èƒ½å¯¼è‡´å“ªäº›å†…å­˜æ³„æ¼ï¼Ÿ
A4:
- ThreadLocalæ³„æ¼
- é™æ€å˜é‡å¼•ç”¨
- çº¿ç¨‹æœªæ­£ç¡®å…³é—­
- JDBCé©±åŠ¨æœªæ³¨é”€
- ç¬¬ä¸‰æ–¹åº“å…¨å±€æ³¨å†Œ

Q5: å¦‚ä½•é¢„é˜²Tomcatå†…å­˜æ³„æ¼ï¼Ÿ
A5:
- é…ç½®clearReferenceså‚æ•°
- æ­£ç¡®å…³é—­èµ„æºå’Œçº¿ç¨‹
- é¿å…é™æ€å˜é‡æŒæœ‰åº”ç”¨å¯¹è±¡
- ä½¿ç”¨å†…å­˜åˆ†æå·¥å…·ç›‘æ§
```

### 7.4 æœ€ä½³å®è·µ

```
âœ… å¼€å‘æœ€ä½³å®è·µ

1. é¿å…å†…å­˜æ³„æ¼
   - æ­£ç¡®å…³é—­èµ„æºï¼ˆConnection, Streamç­‰ï¼‰
   - é¿å…é™æ€å˜é‡æŒæœ‰åº”ç”¨å¯¹è±¡
   - æ­£ç¡®åœæ­¢åº”ç”¨å¯åŠ¨çš„çº¿ç¨‹
   - æ¸…ç†ThreadLocalå˜é‡

2. ç±»åŠ è½½ä¼˜åŒ–
   - åˆç†ä½¿ç”¨å…±äº«ç±»åº“
   - é¿å…é‡å¤çš„jaråŒ…
   - ä½¿ç”¨Maven/Gradleç®¡ç†ä¾èµ–
   - é…ç½®JarScannerè¿‡æ»¤

3. çƒ­éƒ¨ç½²é…ç½®
   - å¼€å‘ç¯å¢ƒå¯ç”¨autoDeploy
   - ç”Ÿäº§ç¯å¢ƒå…³é—­autoDeploy
   - é…ç½®åˆé€‚çš„æ£€æŸ¥é—´éš”
   - ç›‘æ§å†…å­˜ä½¿ç”¨æƒ…å†µ

4. æ€§èƒ½è°ƒä¼˜
   - é…ç½®åˆé€‚çš„ç±»åŠ è½½å™¨å‚æ•°
   - ä½¿ç”¨ç±»åŠ è½½ç¼“å­˜
   - é¢„ç¼–è¯‘JSPé¡µé¢
   - ç›‘æ§ç±»åŠ è½½æ€§èƒ½
```

---

## ğŸ“‹ æ€»ç»“

Tomcatç±»åŠ è½½æœºåˆ¶æ˜¯ä¸€ä¸ªç²¾å¿ƒè®¾è®¡çš„ç³»ç»Ÿï¼Œé€šè¿‡æ‰“ç ´ä¼ ç»Ÿçš„åŒäº²å§”æ´¾æ¨¡å‹ï¼Œå®ç°äº†Webåº”ç”¨çš„éš”ç¦»ã€å…±äº«å’Œçƒ­éƒ¨ç½²åŠŸèƒ½ã€‚ç†è§£è¿™ä¸ªæœºåˆ¶å¯¹äºJava Webå¼€å‘å’ŒTomcatè°ƒä¼˜éƒ½éå¸¸é‡è¦ã€‚

**æ ¸å¿ƒè¦ç‚¹**ï¼š
- **å±‚æ¬¡ç»“æ„**ï¼šå¤šå±‚æ¬¡çš„ç±»åŠ è½½å™¨å®ç°ä¸åŒçº§åˆ«çš„éš”ç¦»å’Œå…±äº«
- **å§”æ‰˜æœºåˆ¶**ï¼šçµæ´»çš„å§”æ‰˜ç­–ç•¥å¹³è¡¡éš”ç¦»æ€§å’Œæ€§èƒ½
- **çƒ­éƒ¨ç½²**ï¼šé€šè¿‡é‡å»ºç±»åŠ è½½å™¨å®ç°åº”ç”¨çš„åŠ¨æ€é‡è½½
- **å†…å­˜ç®¡ç†**ï¼šå®Œå–„çš„æ³„æ¼æ£€æµ‹å’Œæ¸…ç†æœºåˆ¶ä¿è¯ç³»ç»Ÿç¨³å®šæ€§

æŒæ¡è¿™äº›çŸ¥è¯†ç‚¹ï¼Œèƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬æ›´å¥½åœ°ç†è§£Tomcatçš„å·¥ä½œåŸç†ï¼Œè§£å†³å®é™…å¼€å‘ä¸­çš„ç±»åŠ è½½é—®é¢˜ï¼Œå¹¶è¿›è¡Œæœ‰æ•ˆçš„æ€§èƒ½è°ƒä¼˜ã€‚
```