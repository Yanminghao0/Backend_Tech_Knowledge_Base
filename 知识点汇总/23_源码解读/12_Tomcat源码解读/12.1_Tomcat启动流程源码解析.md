# Tomcatå¯åŠ¨æµç¨‹æºç è§£æ

> ğŸ’¡ æ·±å…¥ç†è§£TomcatæœåŠ¡å™¨çš„å¯åŠ¨è¿‡ç¨‹ï¼ŒæŒæ¡ç»„ä»¶ç”Ÿå‘½å‘¨æœŸç®¡ç†

---

## ğŸ“š ç›®å½•

1. [å¯åŠ¨æµç¨‹æ¦‚è¿°](#1-å¯åŠ¨æµç¨‹æ¦‚è¿°)
2. [Bootstrapå¯åŠ¨ç±»](#2-bootstrapå¯åŠ¨ç±»)
3. [Catalinaæ ¸å¿ƒç±»](#3-catalinaæ ¸å¿ƒç±»)
4. [ç”Ÿå‘½å‘¨æœŸç®¡ç†](#4-ç”Ÿå‘½å‘¨æœŸç®¡ç†)
5. [Serveråˆå§‹åŒ–](#5-serveråˆå§‹åŒ–)
6. [ç»„ä»¶å¯åŠ¨é¡ºåº](#6-ç»„ä»¶å¯åŠ¨é¡ºåº)
7. [é¢è¯•è¦ç‚¹](#7-é¢è¯•è¦ç‚¹)

---

## 1. å¯åŠ¨æµç¨‹æ¦‚è¿°

### 1.1 å¯åŠ¨å…¥å£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Tomcatå¯åŠ¨æµç¨‹                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  startup.sh / startup.bat                                  â”‚
â”‚         â”‚                                                   â”‚
â”‚         â–¼                                                   â”‚
â”‚  Bootstrap.main()                                          â”‚
â”‚         â”‚                                                   â”‚
â”‚         â”œâ”€â”€ init() åˆå§‹åŒ–ç±»åŠ è½½å™¨                          â”‚
â”‚         â”‚                                                   â”‚
â”‚         â””â”€â”€ load() + start()                               â”‚
â”‚                â”‚                                            â”‚
â”‚                â–¼                                            â”‚
â”‚         Catalina.load()                                    â”‚
â”‚                â”‚                                            â”‚
â”‚                â”œâ”€â”€ è§£æserver.xml                          â”‚
â”‚                â”‚                                            â”‚
â”‚                â””â”€â”€ Server.init()                           â”‚
â”‚                        â”‚                                    â”‚
â”‚                        â–¼                                    â”‚
â”‚                 Service.init()                             â”‚
â”‚                        â”‚                                    â”‚
â”‚                â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚                â–¼               â–¼                            â”‚
â”‚         Connector.init()  Container.init()                 â”‚
â”‚                                                             â”‚
â”‚         Catalina.start()                                   â”‚
â”‚                â”‚                                            â”‚
â”‚                â””â”€â”€ Server.start()                          â”‚
â”‚                        â”‚                                    â”‚
â”‚                        â–¼                                    â”‚
â”‚                 é€’å½’å¯åŠ¨æ‰€æœ‰ç»„ä»¶                            â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ ¸å¿ƒç±»å…³ç³»

```java
// å¯åŠ¨å…¥å£
Bootstrap â†’ Catalina â†’ Server â†’ Service â†’ Connector + Container

// ç”Ÿå‘½å‘¨æœŸæ¥å£
Lifecycle
â”œâ”€â”€ init()      // åˆå§‹åŒ–
â”œâ”€â”€ start()     // å¯åŠ¨
â”œâ”€â”€ stop()      // åœæ­¢
â””â”€â”€ destroy()   // é”€æ¯
```


---

## 2. Bootstrapå¯åŠ¨ç±»

### 2.1 mainæ–¹æ³•

```java
/**
 * Tomcatå¯åŠ¨å…¥å£
 */
public final class Bootstrap {
    
    private static final Log log = LogFactory.getLog(Bootstrap.class);
    
    private static Bootstrap daemon = null;
    
    private Object catalinaDaemon = null;
    
    ClassLoader commonLoader = null;
    ClassLoader catalinaLoader = null;
    ClassLoader sharedLoader = null;
    
    /**
     * ğŸ”¥ å¯åŠ¨å…¥å£
     */
    public static void main(String args[]) {
        synchronized (daemonLock) {
            if (daemon == null) {
                Bootstrap bootstrap = new Bootstrap();
                try {
                    // 1. åˆå§‹åŒ–
                    bootstrap.init();
                } catch (Throwable t) {
                    handleThrowable(t);
                    t.printStackTrace();
                    return;
                }
                daemon = bootstrap;
            } else {
                Thread.currentThread().setContextClassLoader(daemon.catalinaLoader);
            }
        }
        
        try {
            String command = "start";
            if (args.length > 0) {
                command = args[args.length - 1];
            }
            
            if (command.equals("startd")) {
                args[args.length - 1] = "start";
                daemon.load(args);
                daemon.start();
            } else if (command.equals("stopd")) {
                args[args.length - 1] = "stop";
                daemon.stop();
            } else if (command.equals("start")) {
                daemon.setAwait(true);
                // 2. åŠ è½½é…ç½®
                daemon.load(args);
                // 3. å¯åŠ¨æœåŠ¡
                daemon.start();
                if (null == daemon.getServer()) {
                    System.exit(1);
                }
            } else if (command.equals("stop")) {
                daemon.stopServer(args);
            } else if (command.equals("configtest")) {
                daemon.load(args);
                if (null == daemon.getServer()) {
                    System.exit(1);
                }
                System.exit(0);
            } else {
                log.warn("Bootstrap: command \"" + command + "\" does not exist.");
            }
        } catch (Throwable t) {
            handleThrowable(t);
            t.printStackTrace();
            System.exit(1);
        }
    }
}
```

### 2.2 initæ–¹æ³• - åˆå§‹åŒ–ç±»åŠ è½½å™¨

```java
/**
 * åˆå§‹åŒ–Bootstrap
 */
public void init() throws Exception {
    // 1. ğŸ”¥ åˆå§‹åŒ–ç±»åŠ è½½å™¨
    initClassLoaders();
    
    // 2. è®¾ç½®å½“å‰çº¿ç¨‹çš„ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨
    Thread.currentThread().setContextClassLoader(catalinaLoader);
    
    // 3. è®¾ç½®å®‰å…¨ç±»åŠ è½½å™¨
    SecurityClassLoad.securityClassLoad(catalinaLoader);
    
    // 4. ğŸ”¥ åå°„åˆ›å»ºCatalinaå®ä¾‹
    if (log.isDebugEnabled()) {
        log.debug("Loading startup class");
    }
    Class<?> startupClass = catalinaLoader.loadClass(
        "org.apache.catalina.startup.Catalina");
    Object startupInstance = startupClass.getConstructor().newInstance();
    
    // 5. è®¾ç½®çˆ¶ç±»åŠ è½½å™¨
    if (log.isDebugEnabled()) {
        log.debug("Setting startup class properties");
    }
    String methodName = "setParentClassLoader";
    Class<?> paramTypes[] = new Class[1];
    paramTypes[0] = Class.forName("java.lang.ClassLoader");
    Object paramValues[] = new Object[1];
    paramValues[0] = sharedLoader;
    Method method = startupInstance.getClass().getMethod(methodName, paramTypes);
    method.invoke(startupInstance, paramValues);
    
    catalinaDaemon = startupInstance;
}

/**
 * åˆå§‹åŒ–ç±»åŠ è½½å™¨ä½“ç³»
 */
private void initClassLoaders() {
    try {
        // Commonç±»åŠ è½½å™¨ - åŠ è½½å…¬å…±ç±»åº“
        commonLoader = createClassLoader("common", null);
        if (commonLoader == null) {
            commonLoader = this.getClass().getClassLoader();
        }
        
        // Catalinaç±»åŠ è½½å™¨ - åŠ è½½Tomcatæ ¸å¿ƒç±»
        catalinaLoader = createClassLoader("server", commonLoader);
        
        // Sharedç±»åŠ è½½å™¨ - åŠ è½½Webåº”ç”¨å…±äº«ç±»
        sharedLoader = createClassLoader("shared", commonLoader);
    } catch (Throwable t) {
        handleThrowable(t);
        log.error("Class loader creation threw exception", t);
        System.exit(1);
    }
}
```

### 2.3 loadæ–¹æ³•

```java
/**
 * åŠ è½½é…ç½®
 */
private void load(String[] arguments) throws Exception {
    // åå°„è°ƒç”¨Catalina.load()
    String methodName = "load";
    Object param[];
    Class<?> paramTypes[];
    
    if (arguments == null || arguments.length == 0) {
        paramTypes = null;
        param = null;
    } else {
        paramTypes = new Class[1];
        paramTypes[0] = arguments.getClass();
        param = new Object[1];
        param[0] = arguments;
    }
    
    Method method = catalinaDaemon.getClass().getMethod(methodName, paramTypes);
    if (log.isDebugEnabled()) {
        log.debug("Calling startup class " + method);
    }
    method.invoke(catalinaDaemon, param);
}

/**
 * å¯åŠ¨æœåŠ¡
 */
public void start() throws Exception {
    if (catalinaDaemon == null) {
        init();
    }
    
    // åå°„è°ƒç”¨Catalina.start()
    Method method = catalinaDaemon.getClass().getMethod("start", (Class[]) null);
    method.invoke(catalinaDaemon, (Object[]) null);
}
```

---

## 3. Catalinaæ ¸å¿ƒç±»

### 3.1 loadæ–¹æ³• - è§£æé…ç½®

```java
/**
 * Catalina - Tomcatæ ¸å¿ƒå¯åŠ¨ç±»
 */
public class Catalina {
    
    protected Server server = null;
    protected ClassLoader parentClassLoader = Catalina.class.getClassLoader();
    protected boolean await = false;
    
    /**
     * ğŸ”¥ åŠ è½½é…ç½®
     */
    public void load() {
        if (loaded) {
            return;
        }
        loaded = true;
        
        long t1 = System.nanoTime();
        
        // 1. åˆå§‹åŒ–ç›®å½•
        initDirs();
        
        // 2. åˆå§‹åŒ–å‘½åæœåŠ¡
        initNaming();
        
        // 3. ğŸ”¥ åˆ›å»ºDigesterè§£æserver.xml
        Digester digester = createStartDigester();
        
        InputSource inputSource = null;
        InputStream inputStream = null;
        File file = null;
        
        try {
            // 4. è¯»å–server.xmlé…ç½®æ–‡ä»¶
            file = configFile();
            inputStream = new FileInputStream(file);
            inputSource = new InputSource(file.toURI().toURL().toString());
            inputSource.setByteStream(inputStream);
            
            // 5. ğŸ”¥ è§£æé…ç½®æ–‡ä»¶ï¼Œåˆ›å»ºServerå¯¹è±¡
            digester.push(this);
            digester.parse(inputSource);
            
        } catch (Exception e) {
            log.warn("Catalina.start using " + getConfigFile() + ": " + e.getMessage());
            return;
        } finally {
            // å…³é—­æµ
        }
        
        // 6. è®¾ç½®Serverçš„Catalinaå¼•ç”¨
        getServer().setCatalina(this);
        getServer().setCatalinaHome(Bootstrap.getCatalinaHomeFile());
        getServer().setCatalinaBase(Bootstrap.getCatalinaBaseFile());
        
        // 7. é‡å®šå‘è¾“å‡ºæµ
        initStreams();
        
        // 8. ğŸ”¥ åˆå§‹åŒ–Server
        try {
            getServer().init();
        } catch (LifecycleException e) {
            if (Boolean.getBoolean("org.apache.catalina.startup.EXIT_ON_INIT_FAILURE")) {
                throw new java.lang.Error(e);
            } else {
                log.error("Catalina.start", e);
            }
        }
        
        long t2 = System.nanoTime();
        if (log.isInfoEnabled()) {
            log.info("Initialization processed in " + ((t2 - t1) / 1000000) + " ms");
        }
    }
}
```

### 3.2 startæ–¹æ³• - å¯åŠ¨æœåŠ¡

```java
/**
 * å¯åŠ¨Tomcat
 */
public void start() {
    if (getServer() == null) {
        load();
    }
    
    if (getServer() == null) {
        log.fatal("Cannot start server. Server instance is not configured.");
        return;
    }
    
    long t1 = System.nanoTime();
    
    // ğŸ”¥ å¯åŠ¨Server
    try {
        getServer().start();
    } catch (LifecycleException e) {
        log.fatal(sm.getString("catalina.serverStartFail"), e);
        try {
            getServer().destroy();
        } catch (LifecycleException e1) {
            log.debug("destroy() failed for failed Server ", e1);
        }
        return;
    }
    
    long t2 = System.nanoTime();
    if (log.isInfoEnabled()) {
        log.info("Server startup in " + ((t2 - t1) / 1000000) + " ms");
    }
    
    // æ³¨å†Œå…³é—­é’©å­
    if (useShutdownHook) {
        if (shutdownHook == null) {
            shutdownHook = new CatalinaShutdownHook();
        }
        Runtime.getRuntime().addShutdownHook(shutdownHook);
    }
    
    // ğŸ”¥ ç­‰å¾…å…³é—­å‘½ä»¤
    if (await) {
        await();
        stop();
    }
}

/**
 * ç­‰å¾…å…³é—­
 */
public void await() {
    getServer().await();
}
```

---

## 4. ç”Ÿå‘½å‘¨æœŸç®¡ç†

### 4.1 Lifecycleæ¥å£

```java
/**
 * ç”Ÿå‘½å‘¨æœŸæ¥å£
 * Tomcatæ‰€æœ‰ç»„ä»¶éƒ½å®ç°æ­¤æ¥å£
 */
public interface Lifecycle {
    
    // ç”Ÿå‘½å‘¨æœŸäº‹ä»¶
    public static final String BEFORE_INIT_EVENT = "before_init";
    public static final String AFTER_INIT_EVENT = "after_init";
    public static final String START_EVENT = "start";
    public static final String BEFORE_START_EVENT = "before_start";
    public static final String AFTER_START_EVENT = "after_start";
    public static final String STOP_EVENT = "stop";
    public static final String BEFORE_STOP_EVENT = "before_stop";
    public static final String AFTER_STOP_EVENT = "after_stop";
    public static final String AFTER_DESTROY_EVENT = "after_destroy";
    public static final String BEFORE_DESTROY_EVENT = "before_destroy";
    
    // ç”Ÿå‘½å‘¨æœŸç›‘å¬å™¨
    public void addLifecycleListener(LifecycleListener listener);
    public LifecycleListener[] findLifecycleListeners();
    public void removeLifecycleListener(LifecycleListener listener);
    
    // ğŸ”¥ ç”Ÿå‘½å‘¨æœŸæ–¹æ³•
    public void init() throws LifecycleException;
    public void start() throws LifecycleException;
    public void stop() throws LifecycleException;
    public void destroy() throws LifecycleException;
    
    // çŠ¶æ€æŸ¥è¯¢
    public LifecycleState getState();
    public String getStateName();
}
```

### 4.2 LifecycleBaseæŠ½è±¡ç±»

```java
/**
 * ç”Ÿå‘½å‘¨æœŸåŸºç±»
 * å®ç°çŠ¶æ€ç®¡ç†å’Œäº‹ä»¶é€šçŸ¥
 */
public abstract class LifecycleBase implements Lifecycle {
    
    private final List<LifecycleListener> lifecycleListeners = 
        new CopyOnWriteArrayList<>();
    
    private volatile LifecycleState state = LifecycleState.NEW;
    
    /**
     * ğŸ”¥ åˆå§‹åŒ–
     */
    @Override
    public final synchronized void init() throws LifecycleException {
        // çŠ¶æ€æ£€æŸ¥
        if (!state.equals(LifecycleState.NEW)) {
            invalidTransition(Lifecycle.BEFORE_INIT_EVENT);
        }
        
        try {
            // è®¾ç½®çŠ¶æ€ä¸ºINITIALIZING
            setStateInternal(LifecycleState.INITIALIZING, null, false);
            
            // ğŸ”¥ è°ƒç”¨å­ç±»å®ç°
            initInternal();
            
            // è®¾ç½®çŠ¶æ€ä¸ºINITIALIZED
            setStateInternal(LifecycleState.INITIALIZED, null, false);
        } catch (Throwable t) {
            handleSubClassException(t, "lifecycleBase.initFail", toString());
        }
    }
    
    /**
     * å­ç±»å®ç°åˆå§‹åŒ–é€»è¾‘
     */
    protected abstract void initInternal() throws LifecycleException;
    
    /**
     * ğŸ”¥ å¯åŠ¨
     */
    @Override
    public final synchronized void start() throws LifecycleException {
        // çŠ¶æ€æ£€æŸ¥
        if (LifecycleState.STARTING_PREP.equals(state) || 
            LifecycleState.STARTING.equals(state) ||
            LifecycleState.STARTED.equals(state)) {
            // å·²ç»å¯åŠ¨æˆ–æ­£åœ¨å¯åŠ¨
            return;
        }
        
        if (state.equals(LifecycleState.NEW)) {
            init();
        } else if (state.equals(LifecycleState.FAILED)) {
            stop();
        } else if (!state.equals(LifecycleState.INITIALIZED) &&
                   !state.equals(LifecycleState.STOPPED)) {
            invalidTransition(Lifecycle.BEFORE_START_EVENT);
        }
        
        try {
            // è®¾ç½®çŠ¶æ€ä¸ºSTARTING_PREP
            setStateInternal(LifecycleState.STARTING_PREP, null, false);
            
            // ğŸ”¥ è°ƒç”¨å­ç±»å®ç°
            startInternal();
            
            if (state.equals(LifecycleState.FAILED)) {
                stop();
            } else if (!state.equals(LifecycleState.STARTING)) {
                invalidTransition(Lifecycle.AFTER_START_EVENT);
            } else {
                // è®¾ç½®çŠ¶æ€ä¸ºSTARTED
                setStateInternal(LifecycleState.STARTED, null, false);
            }
        } catch (Throwable t) {
            handleSubClassException(t, "lifecycleBase.startFail", toString());
        }
    }
    
    /**
     * å­ç±»å®ç°å¯åŠ¨é€»è¾‘
     */
    protected abstract void startInternal() throws LifecycleException;
    
    /**
     * è®¾ç½®çŠ¶æ€å¹¶è§¦å‘äº‹ä»¶
     */
    private synchronized void setStateInternal(LifecycleState state, 
            Object data, boolean check) throws LifecycleException {
        
        this.state = state;
        String lifecycleEvent = state.getLifecycleEvent();
        
        if (lifecycleEvent != null) {
            // ğŸ”¥ è§¦å‘ç”Ÿå‘½å‘¨æœŸäº‹ä»¶
            fireLifecycleEvent(lifecycleEvent, data);
        }
    }
    
    /**
     * è§¦å‘ç”Ÿå‘½å‘¨æœŸäº‹ä»¶
     */
    protected void fireLifecycleEvent(String type, Object data) {
        LifecycleEvent event = new LifecycleEvent(this, type, data);
        for (LifecycleListener listener : lifecycleListeners) {
            listener.lifecycleEvent(event);
        }
    }
}
```

### 4.3 ç”Ÿå‘½å‘¨æœŸçŠ¶æ€

```java
/**
 * ç”Ÿå‘½å‘¨æœŸçŠ¶æ€æšä¸¾
 */
public enum LifecycleState {
    NEW(false, null),
    INITIALIZING(false, Lifecycle.BEFORE_INIT_EVENT),
    INITIALIZED(false, Lifecycle.AFTER_INIT_EVENT),
    STARTING_PREP(false, Lifecycle.BEFORE_START_EVENT),
    STARTING(true, Lifecycle.START_EVENT),
    STARTED(true, Lifecycle.AFTER_START_EVENT),
    STOPPING_PREP(true, Lifecycle.BEFORE_STOP_EVENT),
    STOPPING(false, Lifecycle.STOP_EVENT),
    STOPPED(false, Lifecycle.AFTER_STOP_EVENT),
    DESTROYING(false, Lifecycle.BEFORE_DESTROY_EVENT),
    DESTROYED(false, Lifecycle.AFTER_DESTROY_EVENT),
    FAILED(false, null);
    
    private final boolean available;
    private final String lifecycleEvent;
    
    // ...
}
```


---

## 5. Serveråˆå§‹åŒ–

### 5.1 StandardServer

```java
/**
 * Serveræ ‡å‡†å®ç°
 */
public final class StandardServer extends LifecycleMBeanBase implements Server {
    
    private Service services[] = new Service[0];
    private final Object servicesLock = new Object();
    
    private int port = 8005;
    private String address = "localhost";
    private String shutdown = "SHUTDOWN";
    
    /**
     * ğŸ”¥ åˆå§‹åŒ–Server
     */
    @Override
    protected void initInternal() throws LifecycleException {
        super.initInternal();
        
        // æ³¨å†Œå…¨å±€å­—ç¬¦ä¸²ç¼“å­˜
        onameStringCache = register(new StringCache(), "type=StringCache");
        
        // æ³¨å†ŒMBeanFactory
        MBeanFactory factory = new MBeanFactory();
        factory.setContainer(this);
        onameMBeanFactory = register(factory, "type=MBeanFactory");
        
        // æ³¨å†Œå…¨å±€å‘½åèµ„æº
        globalNamingResources.init();
        
        // åˆå§‹åŒ–ç±»åŠ è½½å™¨èµ„æº
        if (getCatalina() != null) {
            ClassLoader cl = getCatalina().getParentClassLoader();
            while (cl != null && cl != ClassLoader.getSystemClassLoader()) {
                if (cl instanceof URLClassLoader) {
                    URL[] urls = ((URLClassLoader) cl).getURLs();
                    for (URL url : urls) {
                        if (url.getProtocol().equals("file")) {
                            try {
                                File f = new File(url.toURI());
                                if (f.isFile() && f.getName().endsWith(".jar")) {
                                    ExtensionValidator.addSystemResource(f);
                                }
                            } catch (Exception e) {
                                // Ignore
                            }
                        }
                    }
                }
                cl = cl.getParent();
            }
        }
        
        // ğŸ”¥ åˆå§‹åŒ–æ‰€æœ‰Service
        for (int i = 0; i < services.length; i++) {
            services[i].init();
        }
    }
    
    /**
     * ğŸ”¥ å¯åŠ¨Server
     */
    @Override
    protected void startInternal() throws LifecycleException {
        // è§¦å‘CONFIGURE_START_EVENTäº‹ä»¶
        fireLifecycleEvent(CONFIGURE_START_EVENT, null);
        
        // è®¾ç½®çŠ¶æ€ä¸ºSTARTING
        setState(LifecycleState.STARTING);
        
        // å¯åŠ¨å…¨å±€å‘½åèµ„æº
        globalNamingResources.start();
        
        // ğŸ”¥ å¯åŠ¨æ‰€æœ‰Service
        synchronized (servicesLock) {
            for (int i = 0; i < services.length; i++) {
                services[i].start();
            }
        }
    }
    
    /**
     * ç­‰å¾…å…³é—­å‘½ä»¤
     */
    @Override
    public void await() {
        // åˆ›å»ºServerSocketç›‘å¬å…³é—­å‘½ä»¤
        try {
            awaitSocket = new ServerSocket(port, 1, 
                InetAddress.getByName(address));
        } catch (IOException e) {
            log.error("StandardServer.await: create[" + address + ":" + port + "]: ", e);
            return;
        }
        
        try {
            awaitThread = Thread.currentThread();
            
            while (!stopAwait) {
                ServerSocket serverSocket = awaitSocket;
                if (serverSocket == null) {
                    break;
                }
                
                Socket socket = null;
                StringBuilder command = new StringBuilder();
                try {
                    // ç­‰å¾…è¿æ¥
                    socket = serverSocket.accept();
                    socket.setSoTimeout(10 * 1000);
                    
                    // è¯»å–å‘½ä»¤
                    InputStream stream = socket.getInputStream();
                    int expected = shutdown.length();
                    while (expected > 0) {
                        int ch = stream.read();
                        if (ch < 32 || ch == 127) {
                            break;
                        }
                        command.append((char) ch);
                        expected--;
                    }
                } finally {
                    try {
                        if (socket != null) {
                            socket.close();
                        }
                    } catch (IOException e) {
                        // Ignore
                    }
                }
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯å…³é—­å‘½ä»¤
                boolean match = command.toString().equals(shutdown);
                if (match) {
                    log.info(sm.getString("standardServer.shutdownViaPort"));
                    break;
                }
            }
        } finally {
            // å…³é—­ServerSocket
        }
    }
}
```

### 5.2 StandardService

```java
/**
 * Serviceæ ‡å‡†å®ç°
 */
public class StandardService extends LifecycleMBeanBase implements Service {
    
    private String name = null;
    private Server server = null;
    
    protected Connector connectors[] = new Connector[0];
    private final Object connectorsLock = new Object();
    
    private Engine engine = null;
    
    protected final Mapper mapper = new Mapper();
    protected final MapperListener mapperListener = new MapperListener(this);
    
    /**
     * ğŸ”¥ åˆå§‹åŒ–Service
     */
    @Override
    protected void initInternal() throws LifecycleException {
        super.initInternal();
        
        // ğŸ”¥ åˆå§‹åŒ–Engine
        if (engine != null) {
            engine.init();
        }
        
        // åˆå§‹åŒ–Executor
        for (Executor executor : findExecutors()) {
            if (executor instanceof JmxEnabled) {
                ((JmxEnabled) executor).setDomain(getDomain());
            }
            executor.init();
        }
        
        // åˆå§‹åŒ–MapperListener
        mapperListener.init();
        
        // ğŸ”¥ åˆå§‹åŒ–æ‰€æœ‰Connector
        synchronized (connectorsLock) {
            for (Connector connector : connectors) {
                connector.init();
            }
        }
    }
    
    /**
     * ğŸ”¥ å¯åŠ¨Service
     */
    @Override
    protected void startInternal() throws LifecycleException {
        if (log.isInfoEnabled()) {
            log.info(sm.getString("standardService.start.name", this.name));
        }
        
        setState(LifecycleState.STARTING);
        
        // ğŸ”¥ å¯åŠ¨Engine
        if (engine != null) {
            synchronized (engine) {
                engine.start();
            }
        }
        
        // å¯åŠ¨Executor
        synchronized (executors) {
            for (Executor executor : executors) {
                executor.start();
            }
        }
        
        // å¯åŠ¨MapperListener
        mapperListener.start();
        
        // ğŸ”¥ å¯åŠ¨æ‰€æœ‰Connector
        synchronized (connectorsLock) {
            for (Connector connector : connectors) {
                // å¦‚æœConnectorå·²ç»æš‚åœï¼Œè·³è¿‡
                if (connector.getState() != LifecycleState.FAILED) {
                    connector.start();
                }
            }
        }
    }
}
```

---

## 6. ç»„ä»¶å¯åŠ¨é¡ºåº

### 6.1 å®Œæ•´å¯åŠ¨é¡ºåº

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Tomcatç»„ä»¶å¯åŠ¨é¡ºåº                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  åˆå§‹åŒ–é˜¶æ®µ (init)ï¼š                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 1. Server.init()                                    â”‚   â”‚
â”‚  â”‚    â””â”€â”€ 2. Service.init()                            â”‚   â”‚
â”‚  â”‚        â”œâ”€â”€ 3. Engine.init()                         â”‚   â”‚
â”‚  â”‚        â”‚   â””â”€â”€ 4. Host.init()                       â”‚   â”‚
â”‚  â”‚        â”‚       â””â”€â”€ 5. Context.init()                â”‚   â”‚
â”‚  â”‚        â”‚           â””â”€â”€ 6. Wrapper.init()            â”‚   â”‚
â”‚  â”‚        â””â”€â”€ 7. Connector.init()                      â”‚   â”‚
â”‚  â”‚            â””â”€â”€ 8. ProtocolHandler.init()            â”‚   â”‚
â”‚  â”‚                â””â”€â”€ 9. Endpoint.init()               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  å¯åŠ¨é˜¶æ®µ (start)ï¼š                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 1. Server.start()                                   â”‚   â”‚
â”‚  â”‚    â””â”€â”€ 2. Service.start()                           â”‚   â”‚
â”‚  â”‚        â”œâ”€â”€ 3. Engine.start()                        â”‚   â”‚
â”‚  â”‚        â”‚   â””â”€â”€ 4. Host.start()                      â”‚   â”‚
â”‚  â”‚        â”‚       â””â”€â”€ 5. Context.start()               â”‚   â”‚
â”‚  â”‚        â”‚           â”œâ”€â”€ 6. åŠ è½½Servlet               â”‚   â”‚
â”‚  â”‚        â”‚           â””â”€â”€ 7. Wrapper.start()           â”‚   â”‚
â”‚  â”‚        â””â”€â”€ 8. Connector.start()                     â”‚   â”‚
â”‚  â”‚            â””â”€â”€ 9. ProtocolHandler.start()           â”‚   â”‚
â”‚  â”‚                â””â”€â”€ 10. Endpoint.start()             â”‚   â”‚
â”‚  â”‚                    â””â”€â”€ 11. ç»‘å®šç«¯å£ï¼Œå¼€å§‹ç›‘å¬       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 å…³é”®æ—¶é—´ç‚¹

```java
// å¯åŠ¨æ—¥å¿—ç¤ºä¾‹
INFO: Initializing ProtocolHandler ["http-nio-8080"]
INFO: Starting service [Catalina]
INFO: Starting Servlet engine: [Apache Tomcat/9.0.x]
INFO: Deploying web application directory [webapps/ROOT]
INFO: Deployment of web application directory [webapps/ROOT] has finished in [xxx] ms
INFO: Starting ProtocolHandler ["http-nio-8080"]
INFO: Server startup in [xxxx] milliseconds
```

---

## 7. é¢è¯•è¦ç‚¹

### 7.1 é«˜é¢‘é¢è¯•é¢˜

#### Q1: Tomcatçš„å¯åŠ¨æµç¨‹ï¼Ÿ

```
ç­”æ¡ˆè¦ç‚¹ï¼š
1. Bootstrap.main() å…¥å£
2. åˆå§‹åŒ–ç±»åŠ è½½å™¨ï¼ˆcommonã€catalinaã€sharedï¼‰
3. åå°„åˆ›å»ºCatalinaå®ä¾‹
4. Catalina.load() è§£æserver.xml
5. Server.init() é€’å½’åˆå§‹åŒ–æ‰€æœ‰ç»„ä»¶
6. Catalina.start() å¯åŠ¨Server
7. Server.start() é€’å½’å¯åŠ¨æ‰€æœ‰ç»„ä»¶
8. await() ç­‰å¾…å…³é—­å‘½ä»¤

å…³é”®ç±»ï¼š
Bootstrap â†’ Catalina â†’ Server â†’ Service â†’ Connector + Engine
```

#### Q2: Tomcatçš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Ÿ

```
ç­”æ¡ˆè¦ç‚¹ï¼š
1. æ‰€æœ‰ç»„ä»¶å®ç°Lifecycleæ¥å£
2. LifecycleBaseæä¾›æ¨¡æ¿æ–¹æ³•
3. çŠ¶æ€æœºç®¡ç†ï¼šNEW â†’ INITIALIZED â†’ STARTED â†’ STOPPED â†’ DESTROYED
4. äº‹ä»¶æœºåˆ¶ï¼šLifecycleListenerç›‘å¬çŠ¶æ€å˜åŒ–
5. çˆ¶ç»„ä»¶è´Ÿè´£ç®¡ç†å­ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸ

æ ¸å¿ƒæ–¹æ³•ï¼š
- init(): åˆå§‹åŒ–èµ„æº
- start(): å¯åŠ¨æœåŠ¡
- stop(): åœæ­¢æœåŠ¡
- destroy(): é‡Šæ”¾èµ„æº
```

#### Q3: Tomcatçš„ç±»åŠ è½½å™¨ä½“ç³»ï¼Ÿ

```
ç±»åŠ è½½å™¨å±‚æ¬¡ï¼š
Bootstrap ClassLoader
    â””â”€â”€ System ClassLoader
        â””â”€â”€ Common ClassLoader (common)
            â”œâ”€â”€ Catalina ClassLoader (server)
            â””â”€â”€ Shared ClassLoader (shared)
                â””â”€â”€ WebApp ClassLoader (æ¯ä¸ªåº”ç”¨ç‹¬ç«‹)

ç‰¹ç‚¹ï¼š
- æ‰“ç ´åŒäº²å§”æ´¾ï¼šWebAppä¼˜å…ˆåŠ è½½è‡ªå·±çš„ç±»
- ç±»éš”ç¦»ï¼šä¸åŒåº”ç”¨çš„ç±»äº’ä¸å½±å“
- çƒ­éƒ¨ç½²ï¼šé‡æ–°åŠ è½½WebApp ClassLoader
```

### 7.2 çŸ¥è¯†ç‚¹æ€»ç»“

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Tomcatå¯åŠ¨æµç¨‹æ€»ç»“                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  å¯åŠ¨å…¥å£ï¼š                                                  â”‚
â”‚  Bootstrap.main() â†’ init() â†’ load() â†’ start()              â”‚
â”‚                                                             â”‚
â”‚  æ ¸å¿ƒç»„ä»¶ï¼š                                                  â”‚
â”‚  â”œâ”€â”€ Server: æ•´ä¸ªTomcatå®ä¾‹                                â”‚
â”‚  â”œâ”€â”€ Service: åŒ…å«Connectorå’ŒContainer                     â”‚
â”‚  â”œâ”€â”€ Connector: å¤„ç†ç½‘ç»œè¿æ¥                               â”‚
â”‚  â””â”€â”€ Container: å¤„ç†è¯·æ±‚ï¼ˆEngine/Host/Context/Wrapperï¼‰    â”‚
â”‚                                                             â”‚
â”‚  ç”Ÿå‘½å‘¨æœŸï¼š                                                  â”‚
â”‚  â”œâ”€â”€ Lifecycleæ¥å£å®šä¹‰ç”Ÿå‘½å‘¨æœŸæ–¹æ³•                          â”‚
â”‚  â”œâ”€â”€ LifecycleBaseæä¾›æ¨¡æ¿å®ç°                             â”‚
â”‚  â”œâ”€â”€ çŠ¶æ€æœºç®¡ç†ç»„ä»¶çŠ¶æ€                                    â”‚
â”‚  â””â”€â”€ äº‹ä»¶æœºåˆ¶é€šçŸ¥çŠ¶æ€å˜åŒ–                                  â”‚
â”‚                                                             â”‚
â”‚  ç±»åŠ è½½å™¨ï¼š                                                  â”‚
â”‚  â”œâ”€â”€ Common: å…¬å…±ç±»åº“                                      â”‚
â”‚  â”œâ”€â”€ Catalina: Tomcatæ ¸å¿ƒç±»                                â”‚
â”‚  â”œâ”€â”€ Shared: åº”ç”¨å…±äº«ç±»                                    â”‚
â”‚  â””â”€â”€ WebApp: åº”ç”¨ç‹¬ç«‹ç±»                                    â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [Tomcatå®˜æ–¹æ–‡æ¡£](https://tomcat.apache.org/tomcat-9.0-doc/)
- [Tomcatæºç ](https://github.com/apache/tomcat)

---

**æŒæ¡Tomcatå¯åŠ¨æµç¨‹ï¼Œæ·±å…¥ç†è§£Webå®¹å™¨åŸç†ï¼** ğŸš€

*æœ€åæ›´æ–°ï¼š2025-12-28*
