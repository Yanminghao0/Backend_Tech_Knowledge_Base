# DubboæœåŠ¡å¼•ç”¨æºç è§£æ

> ğŸ’¡ æ·±å…¥ç†è§£Dubboæ¶ˆè´¹ç«¯å¦‚ä½•å¼•ç”¨è¿œç¨‹æœåŠ¡å¹¶å‘èµ·è°ƒç”¨

---

## ğŸ“š ç›®å½•

1. [æœåŠ¡å¼•ç”¨æ¦‚è¿°](#1-æœåŠ¡å¼•ç”¨æ¦‚è¿°)
2. [ReferenceBeanå¤„ç†](#2-referencebeanå¤„ç†)
3. [æœåŠ¡å¼•ç”¨æµç¨‹](#3-æœåŠ¡å¼•ç”¨æµç¨‹)
4. [ä»£ç†ç”Ÿæˆæœºåˆ¶](#4-ä»£ç†ç”Ÿæˆæœºåˆ¶)
5. [é›†ç¾¤å®¹é”™](#5-é›†ç¾¤å®¹é”™)
6. [å®æˆ˜åº”ç”¨](#6-å®æˆ˜åº”ç”¨)
7. [é¢è¯•è¦ç‚¹](#7-é¢è¯•è¦ç‚¹)

---

## 1. æœåŠ¡å¼•ç”¨æ¦‚è¿°

### 1.1 æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  DubboæœåŠ¡å¼•ç”¨æ¶æ„                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  æœåŠ¡æ¶ˆè´¹è€…                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ReferenceBean                                       â”‚   â”‚
â”‚  â”‚      â”‚                                               â”‚   â”‚
â”‚  â”‚      â–¼                                               â”‚   â”‚
â”‚  â”‚  ReferenceConfig.get()                               â”‚   â”‚
â”‚  â”‚      â”‚                                               â”‚   â”‚
â”‚  â”‚      â”œâ”€â”€ æœ¬åœ°å¼•ç”¨ (injvm)                            â”‚   â”‚
â”‚  â”‚      â”‚     â””â”€â”€ InjvmProtocol.refer()                â”‚   â”‚
â”‚  â”‚      â”‚                                               â”‚   â”‚
â”‚  â”‚      â””â”€â”€ è¿œç¨‹å¼•ç”¨                                    â”‚   â”‚
â”‚  â”‚            â”œâ”€â”€ Registry.subscribe() è®¢é˜…æœåŠ¡         â”‚   â”‚
â”‚  â”‚            â”œâ”€â”€ Protocol.refer() åˆ›å»ºInvoker         â”‚   â”‚
â”‚  â”‚            â”œâ”€â”€ Cluster.join() é›†ç¾¤å®¹é”™              â”‚   â”‚
â”‚  â”‚            â””â”€â”€ ProxyFactory.getProxy() ç”Ÿæˆä»£ç†     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ ¸å¿ƒæ¦‚å¿µ

```java
/**
 * æœåŠ¡å¼•ç”¨æ¶‰åŠçš„æ ¸å¿ƒæ¦‚å¿µ
 */
public class ServiceReferenceConcepts {
    
    // 1. Invoker - æœåŠ¡è°ƒç”¨çš„æŠ½è±¡
    // æ¶ˆè´¹ç«¯æŒæœ‰çš„è¿œç¨‹æœåŠ¡è°ƒç”¨å™¨
    Invoker<T> invoker;
    
    // 2. Directory - æœåŠ¡ç›®å½•
    // ç»´æŠ¤æœåŠ¡æä¾›è€…åˆ—è¡¨
    Directory<T> directory;
    
    // 3. Cluster - é›†ç¾¤å®¹é”™
    // å°†å¤šä¸ªInvokerä¼ªè£…æˆä¸€ä¸ª
    Cluster cluster;
    
    // 4. LoadBalance - è´Ÿè½½å‡è¡¡
    // ä»å¤šä¸ªInvokerä¸­é€‰æ‹©ä¸€ä¸ª
    LoadBalance loadBalance;
    
    // 5. Proxy - æœåŠ¡ä»£ç†
    // æ¶ˆè´¹ç«¯ä½¿ç”¨çš„ä»£ç†å¯¹è±¡
    T proxy;
}
```


### 1.3 å¼•ç”¨æµç¨‹æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  æœåŠ¡å¼•ç”¨æµç¨‹                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  1. Springå®¹å™¨å¯åŠ¨                                          â”‚
â”‚     â”‚                                                       â”‚
â”‚     â–¼                                                       â”‚
â”‚  2. ReferenceBeanåˆå§‹åŒ–                                     â”‚
â”‚     â”‚                                                       â”‚
â”‚     â–¼                                                       â”‚
â”‚  3. è°ƒç”¨get()æ–¹æ³•è·å–ä»£ç†                                   â”‚
â”‚     â”‚                                                       â”‚
â”‚     â”œâ”€â”€ 3.1 æ£€æŸ¥é…ç½®                                        â”‚
â”‚     â”‚                                                       â”‚
â”‚     â”œâ”€â”€ 3.2 ç»„è£…URL                                         â”‚
â”‚     â”‚                                                       â”‚
â”‚     â”œâ”€â”€ 3.3 è®¢é˜…æœåŠ¡                                        â”‚
â”‚     â”‚     â””â”€â”€ Registry.subscribe()                          â”‚
â”‚     â”‚                                                       â”‚
â”‚     â”œâ”€â”€ 3.4 åˆ›å»ºInvoker                                     â”‚
â”‚     â”‚     â””â”€â”€ Protocol.refer()                              â”‚
â”‚     â”‚                                                       â”‚
â”‚     â”œâ”€â”€ 3.5 é›†ç¾¤å®¹é”™                                        â”‚
â”‚     â”‚     â””â”€â”€ Cluster.join()                                â”‚
â”‚     â”‚                                                       â”‚
â”‚     â””â”€â”€ 3.6 ç”Ÿæˆä»£ç†                                        â”‚
â”‚           â””â”€â”€ ProxyFactory.getProxy()                       â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ReferenceBeanå¤„ç†

### 2.1 ReferenceBeanç±»ç»“æ„

```java
/**
 * ReferenceBean - æœåŠ¡å¼•ç”¨çš„å…¥å£
 * ç»§æ‰¿ReferenceConfigï¼Œå®ç°FactoryBean
 */
public class ReferenceBean<T> extends ReferenceConfig<T>
        implements FactoryBean<T>, ApplicationContextAware,
        InitializingBean, DisposableBean {
    
    private transient ApplicationContext applicationContext;
    
    public ReferenceBean() {
        super();
    }
    
    public ReferenceBean(Reference reference) {
        super(reference);
    }
    
    /**
     * ğŸ”¥ FactoryBean.getObject() - è·å–ä»£ç†å¯¹è±¡
     */
    @Override
    public T getObject() {
        return get();
    }
    
    @Override
    public Class<?> getObjectType() {
        return getInterfaceClass();
    }
    
    @Override
    public boolean isSingleton() {
        return true;
    }
}
```

### 2.2 åˆå§‹åŒ–è¿‡ç¨‹

```java
/**
 * Spring Beanåˆå§‹åŒ–å®Œæˆåè°ƒç”¨
 */
@Override
public void afterPropertiesSet() throws Exception {
    // 1. æ£€æŸ¥Consumeré…ç½®
    if (getConsumer() == null) {
        Map<String, ConsumerConfig> consumerConfigMap = 
            applicationContext.getBeansOfType(ConsumerConfig.class, false, false);
        if (!consumerConfigMap.isEmpty()) {
            // è®¾ç½®Consumeré…ç½®
        }
    }
    
    // 2. æ£€æŸ¥Applicationé…ç½®
    if (getApplication() == null && (getConsumer() == null || 
            getConsumer().getApplication() == null)) {
        Map<String, ApplicationConfig> applicationConfigMap = 
            applicationContext.getBeansOfType(ApplicationConfig.class, false, false);
        if (!applicationConfigMap.isEmpty()) {
            // è®¾ç½®Applicationé…ç½®
        }
    }
    
    // 3. æ£€æŸ¥Moduleé…ç½®
    // 4. æ£€æŸ¥Registryé…ç½®
    // 5. æ£€æŸ¥Monitoré…ç½®
    
    // 6. ğŸ”¥ å¦‚æœé…ç½®äº†init=trueï¼Œç«‹å³åˆå§‹åŒ–
    if (shouldInit()) {
        getObject();
    }
}
```

---

## 3. æœåŠ¡å¼•ç”¨æµç¨‹

### 3.1 get()å…¥å£

```java
/**
 * ReferenceConfig.get() - è·å–æœåŠ¡ä»£ç†
 */
public synchronized T get() {
    if (destroyed) {
        throw new IllegalStateException("...");
    }
    
    // ğŸ”¥ æ‡’åŠ è½½ï¼Œé¦–æ¬¡è°ƒç”¨æ—¶åˆå§‹åŒ–
    if (ref == null) {
        init();
    }
    return ref;
}

/**
 * åˆå§‹åŒ–æœåŠ¡å¼•ç”¨
 */
private void init() {
    if (initialized) {
        return;
    }
    initialized = true;
    
    // æ£€æŸ¥æ¥å£å
    if (StringUtils.isEmpty(interfaceName)) {
        throw new IllegalStateException("...");
    }
    
    // æ£€æŸ¥æœ¬åœ°å­˜æ ¹
    checkStubAndLocal(interfaceClass);
    
    // æ£€æŸ¥Mocké…ç½®
    ConfigValidationUtils.checkMock(interfaceClass, this);
    
    // ğŸ”¥ æ„å»ºå‚æ•°Map
    Map<String, String> map = new HashMap<>();
    map.put(SIDE_KEY, CONSUMER_SIDE);
    
    // æ·»åŠ è¿è¡Œæ—¶å‚æ•°
    ReferenceConfigBase.appendRuntimeParameters(map);
    
    // æ·»åŠ å„ç§é…ç½®å‚æ•°
    AbstractConfig.appendParameters(map, getMetrics());
    AbstractConfig.appendParameters(map, getApplication());
    AbstractConfig.appendParameters(map, getModule());
    AbstractConfig.appendParameters(map, consumer);
    AbstractConfig.appendParameters(map, this);
    
    // æ·»åŠ æ–¹æ³•çº§é…ç½®
    // ...
    
    // ğŸ”¥ åˆ›å»ºä»£ç†
    ref = createProxy(map);
    
    // æ³¨å†Œæ¶ˆè´¹è€…
    serviceMetadata.setTarget(ref);
    serviceMetadata.addAttribute(PROXY_CLASS_REF, ref);
    
    // å‘å¸ƒå¼•ç”¨äº‹ä»¶
    dispatch(new ServiceConfigurationInitializedEvent(this, ref));
}
```

### 3.2 createProxy()

```java
/**
 * ğŸ”¥ åˆ›å»ºæœåŠ¡ä»£ç†
 */
private T createProxy(Map<String, String> map) {
    // 1. åˆ¤æ–­æ˜¯å¦æœ¬åœ°å¼•ç”¨
    if (shouldJvmRefer(map)) {
        // æœ¬åœ°å¼•ç”¨
        URL url = new URL(LOCAL_PROTOCOL, LOCALHOST_VALUE, 0, 
            interfaceClass.getName()).addParameters(map);
        invoker = REF_PROTOCOL.refer(interfaceClass, url);
        
    } else {
        urls.clear();
        
        // 2. å¤„ç†ç›´è¿URL
        if (url != null && url.length() > 0) {
            String[] us = SEMICOLON_SPLIT_PATTERN.split(url);
            if (us != null && us.length > 0) {
                for (String u : us) {
                    URL url = URL.valueOf(u);
                    if (StringUtils.isEmpty(url.getPath())) {
                        url = url.setPath(interfaceName);
                    }
                    if (UrlUtils.isRegistry(url)) {
                        urls.add(url.addParameterAndEncoded(REFER_KEY, 
                            StringUtils.toQueryString(map)));
                    } else {
                        urls.add(ClusterUtils.mergeUrl(url, map));
                    }
                }
            }
        } else {
            // 3. ğŸ”¥ ä»æ³¨å†Œä¸­å¿ƒè·å–æœåŠ¡URL
            if (!LOCAL_PROTOCOL.equalsIgnoreCase(getProtocol())) {
                checkRegistry();
                List<URL> us = ConfigValidationUtils.loadRegistries(this, false);
                if (CollectionUtils.isNotEmpty(us)) {
                    for (URL u : us) {
                        URL monitorUrl = ConfigValidationUtils.loadMonitor(this, u);
                        if (monitorUrl != null) {
                            map.put(MONITOR_KEY, URL.encode(monitorUrl.toFullString()));
                        }
                        urls.add(u.addParameterAndEncoded(REFER_KEY, 
                            StringUtils.toQueryString(map)));
                    }
                }
            }
        }
        
        // 4. ğŸ”¥ åˆ›å»ºInvoker
        if (urls.size() == 1) {
            // å•ä¸ªæ³¨å†Œä¸­å¿ƒ
            invoker = REF_PROTOCOL.refer(interfaceClass, urls.get(0));
        } else {
            // å¤šä¸ªæ³¨å†Œä¸­å¿ƒ
            List<Invoker<?>> invokers = new ArrayList<>();
            URL registryURL = null;
            for (URL url : urls) {
                invokers.add(REF_PROTOCOL.refer(interfaceClass, url));
                if (UrlUtils.isRegistry(url)) {
                    registryURL = url;
                }
            }
            if (registryURL != null) {
                // ä½¿ç”¨RegistryAwareCluster
                URL u = registryURL.addParameter(CLUSTER_KEY, RegistryAwareCluster.NAME);
                invoker = CLUSTER.join(new StaticDirectory(u, invokers));
            } else {
                invoker = CLUSTER.join(new StaticDirectory(invokers));
            }
        }
    }
    
    // 5. æ£€æŸ¥æœåŠ¡å¯ç”¨æ€§
    if (shouldCheck() && !invoker.isAvailable()) {
        throw new IllegalStateException("...");
    }
    
    // 6. ğŸ”¥ åˆ›å»ºä»£ç†å¯¹è±¡
    return (T) PROXY_FACTORY.getProxy(invoker, ProtocolUtils.isGeneric(generic));
}
```

### 3.3 RegistryProtocol.refer()

```java
/**
 * RegistryProtocol - æ³¨å†Œä¸­å¿ƒåè®®å¼•ç”¨
 */
public class RegistryProtocol implements Protocol {
    
    /**
     * ğŸ”¥ å¼•ç”¨æœåŠ¡
     */
    @Override
    public <T> Invoker<T> refer(Class<T> type, URL url) throws RpcException {
        // 1. è·å–æ³¨å†Œä¸­å¿ƒURL
        url = getRegistryUrl(url);
        
        // 2. ğŸ”¥ è·å–æ³¨å†Œä¸­å¿ƒ
        Registry registry = registryFactory.getRegistry(url);
        
        if (RegistryService.class.equals(type)) {
            return proxyFactory.getInvoker((T) registry, type, url);
        }
        
        // 3. è·å–å¼•ç”¨å‚æ•°
        Map<String, String> qs = StringUtils.parseQueryString(url.getParameterAndDecoded(REFER_KEY));
        String group = qs.get(GROUP_KEY);
        
        // 4. å¤„ç†åˆ†ç»„èšåˆ
        if (group != null && group.length() > 0) {
            if ((COMMA_SPLIT_PATTERN.split(group)).length > 1 || "*".equals(group)) {
                return doRefer(getMergeableCluster(), registry, type, url);
            }
        }
        
        // 5. ğŸ”¥ æ‰§è¡Œå¼•ç”¨
        return doRefer(cluster, registry, type, url);
    }
    
    /**
     * æ‰§è¡ŒæœåŠ¡å¼•ç”¨
     */
    private <T> Invoker<T> doRefer(Cluster cluster, Registry registry, 
            Class<T> type, URL url) {
        
        // 1. ğŸ”¥ åˆ›å»ºRegistryDirectory
        RegistryDirectory<T> directory = new RegistryDirectory<>(type, url);
        directory.setRegistry(registry);
        directory.setProtocol(protocol);
        
        // 2. æ„å»ºè®¢é˜…URL
        Map<String, String> parameters = new HashMap<>(directory.getConsumerUrl().getParameters());
        URL subscribeUrl = new URL(CONSUMER_PROTOCOL, parameters.remove(REGISTER_IP_KEY), 0, 
            type.getName(), parameters);
        
        // 3. æ³¨å†Œæ¶ˆè´¹è€…
        if (directory.isShouldRegister()) {
            directory.setRegisteredConsumerUrl(subscribeUrl);
            registry.register(directory.getRegisteredConsumerUrl());
        }
        
        // 4. æ„å»ºè·¯ç”±é“¾
        directory.buildRouterChain(subscribeUrl);
        
        // 5. ğŸ”¥ è®¢é˜…æœåŠ¡
        directory.subscribe(toSubscribeUrl(subscribeUrl));
        
        // 6. ğŸ”¥ é›†ç¾¤å®¹é”™
        Invoker<T> invoker = cluster.join(directory);
        
        // 7. æ³¨å†Œæ¶ˆè´¹è€…
        List<RegistryProtocolListener> listeners = findRegistryProtocolListeners(url);
        if (CollectionUtils.isEmpty(listeners)) {
            return invoker;
        }
        
        RegistryInvokerWrapper<T> registryInvokerWrapper = 
            new RegistryInvokerWrapper<>(directory, cluster, invoker);
        
        for (RegistryProtocolListener listener : listeners) {
            listener.onRefer(this, registryInvokerWrapper);
        }
        return registryInvokerWrapper;
    }
}
```

---

## 4. ä»£ç†ç”Ÿæˆæœºåˆ¶

### 4.1 ProxyFactoryæ¥å£

```java
/**
 * ProxyFactory - ä»£ç†å·¥å‚æ¥å£
 */
@SPI("javassist")
public interface ProxyFactory {
    
    /**
     * ğŸ”¥ åˆ›å»ºä»£ç†å¯¹è±¡
     */
    @Adaptive({PROXY_KEY})
    <T> T getProxy(Invoker<T> invoker) throws RpcException;
    
    @Adaptive({PROXY_KEY})
    <T> T getProxy(Invoker<T> invoker, boolean generic) throws RpcException;
    
    /**
     * åˆ›å»ºInvoker
     */
    @Adaptive({PROXY_KEY})
    <T> Invoker<T> getInvoker(T proxy, Class<T> type, URL url) throws RpcException;
}
```

### 4.2 JavassistProxyFactory

```java
/**
 * JavassistProxyFactory - åŸºäºJavassistçš„ä»£ç†å·¥å‚
 */
public class JavassistProxyFactory extends AbstractProxyFactory {
    
    /**
     * ğŸ”¥ åˆ›å»ºä»£ç†å¯¹è±¡
     */
    @Override
    public <T> T getProxy(Invoker<T> invoker, Class<?>[] interfaces) {
        return (T) Proxy.getProxy(interfaces).newInstance(
            new InvokerInvocationHandler(invoker));
    }
    
    /**
     * åˆ›å»ºInvoker
     */
    @Override
    public <T> Invoker<T> getInvoker(T proxy, Class<T> type, URL url) {
        // åŒ…è£…ç±»å¤„ç†
        final Wrapper wrapper = Wrapper.getWrapper(
            proxy.getClass().getName().indexOf('$') < 0 ? proxy.getClass() : type);
        
        return new AbstractProxyInvoker<T>(proxy, type, url) {
            @Override
            protected Object doInvoke(T proxy, String methodName,
                    Class<?>[] parameterTypes, Object[] arguments) throws Throwable {
                return wrapper.invokeMethod(proxy, methodName, parameterTypes, arguments);
            }
        };
    }
}
```

### 4.3 InvokerInvocationHandler

```java
/**
 * InvokerInvocationHandler - ä»£ç†è°ƒç”¨å¤„ç†å™¨
 */
public class InvokerInvocationHandler implements InvocationHandler {
    
    private final Invoker<?> invoker;
    private ConsumerModel consumerModel;
    
    public InvokerInvocationHandler(Invoker<?> handler) {
        this.invoker = handler;
        String serviceKey = invoker.getUrl().getServiceKey();
        if (serviceKey != null) {
            this.consumerModel = ApplicationModel.getConsumerModel(serviceKey);
        }
    }
    
    /**
     * ğŸ”¥ ä»£ç†æ–¹æ³•è°ƒç”¨
     */
    @Override
    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
        // 1. å¤„ç†Objectæ–¹æ³•
        if (method.getDeclaringClass() == Object.class) {
            return method.invoke(invoker, args);
        }
        
        String methodName = method.getName();
        Class<?>[] parameterTypes = method.getParameterTypes();
        
        // 2. å¤„ç†æ— å‚æ–¹æ³•
        if (parameterTypes.length == 0) {
            if ("toString".equals(methodName)) {
                return invoker.toString();
            } else if ("$destroy".equals(methodName)) {
                invoker.destroy();
                return null;
            } else if ("hashCode".equals(methodName)) {
                return invoker.hashCode();
            }
        } else if (parameterTypes.length == 1 && "equals".equals(methodName)) {
            return invoker.equals(args[0]);
        }
        
        // 3. ğŸ”¥ åˆ›å»ºRpcInvocation
        RpcInvocation rpcInvocation = new RpcInvocation(method, 
            invoker.getInterface().getName(), args);
        
        // 4. è®¾ç½®æœåŠ¡Key
        String serviceKey = invoker.getUrl().getServiceKey();
        rpcInvocation.setTargetServiceUniqueName(serviceKey);
        
        // 5. è®¾ç½®æ–¹æ³•ä¿¡æ¯
        if (consumerModel != null) {
            rpcInvocation.put(Constants.CONSUMER_MODEL, consumerModel);
            rpcInvocation.put(Constants.METHOD_MODEL, 
                consumerModel.getMethodModel(method));
        }
        
        // 6. ğŸ”¥ æ‰§è¡Œè°ƒç”¨
        return invoker.invoke(rpcInvocation).recreate();
    }
}
```


---

## 5. é›†ç¾¤å®¹é”™

### 5.1 Clusteræ¥å£

```java
/**
 * Cluster - é›†ç¾¤å®¹é”™æ¥å£
 */
@SPI(FailoverCluster.NAME)
public interface Cluster {
    
    /**
     * ğŸ”¥ å°†Directoryä¸­çš„å¤šä¸ªInvokeråˆå¹¶æˆä¸€ä¸ª
     */
    @Adaptive
    <T> Invoker<T> join(Directory<T> directory) throws RpcException;
}
```

### 5.2 FailoverCluster

```java
/**
 * FailoverCluster - å¤±è´¥è‡ªåŠ¨åˆ‡æ¢ï¼ˆé»˜è®¤ï¼‰
 */
public class FailoverCluster implements Cluster {
    
    public static final String NAME = "failover";
    
    @Override
    public <T> Invoker<T> join(Directory<T> directory) throws RpcException {
        return new FailoverClusterInvoker<>(directory);
    }
}

/**
 * FailoverClusterInvoker - å¤±è´¥è‡ªåŠ¨åˆ‡æ¢Invoker
 */
public class FailoverClusterInvoker<T> extends AbstractClusterInvoker<T> {
    
    @Override
    public Result doInvoke(Invocation invocation, final List<Invoker<T>> invokers,
            LoadBalance loadbalance) throws RpcException {
        
        List<Invoker<T>> copyInvokers = invokers;
        checkInvokers(copyInvokers, invocation);
        
        String methodName = RpcUtils.getMethodName(invocation);
        
        // è·å–é‡è¯•æ¬¡æ•°
        int len = getUrl().getMethodParameter(methodName, RETRIES_KEY, DEFAULT_RETRIES) + 1;
        if (len <= 0) {
            len = 1;
        }
        
        RpcException le = null;
        List<Invoker<T>> invoked = new ArrayList<>(copyInvokers.size());
        Set<String> providers = new HashSet<>(len);
        
        // ğŸ”¥ é‡è¯•å¾ªç¯
        for (int i = 0; i < len; i++) {
            if (i > 0) {
                checkWhetherDestroyed();
                copyInvokers = list(invocation);
                checkInvokers(copyInvokers, invocation);
            }
            
            // ğŸ”¥ è´Ÿè½½å‡è¡¡é€‰æ‹©Invoker
            Invoker<T> invoker = select(loadbalance, invocation, copyInvokers, invoked);
            invoked.add(invoker);
            RpcContext.getContext().setInvokers((List) invoked);
            
            try {
                // ğŸ”¥ æ‰§è¡Œè°ƒç”¨
                Result result = invoker.invoke(invocation);
                if (le != null && logger.isWarnEnabled()) {
                    logger.warn("...");
                }
                return result;
                
            } catch (RpcException e) {
                if (e.isBiz()) {
                    throw e;
                }
                le = e;
            } catch (Throwable e) {
                le = new RpcException(e.getMessage(), e);
            } finally {
                providers.add(invoker.getUrl().getAddress());
            }
        }
        
        throw new RpcException("Failed to invoke the method " + methodName + "...");
    }
}
```

### 5.3 å…¶ä»–é›†ç¾¤ç­–ç•¥

```java
/**
 * FailfastCluster - å¿«é€Ÿå¤±è´¥
 */
public class FailfastCluster implements Cluster {
    public static final String NAME = "failfast";
    
    @Override
    public <T> Invoker<T> join(Directory<T> directory) throws RpcException {
        return new FailfastClusterInvoker<>(directory);
    }
}

/**
 * FailsafeCluster - å¤±è´¥å®‰å…¨
 */
public class FailsafeCluster implements Cluster {
    public static final String NAME = "failsafe";
    
    @Override
    public <T> Invoker<T> join(Directory<T> directory) throws RpcException {
        return new FailsafeClusterInvoker<>(directory);
    }
}

/**
 * FailbackCluster - å¤±è´¥è‡ªåŠ¨æ¢å¤
 */
public class FailbackCluster implements Cluster {
    public static final String NAME = "failback";
    
    @Override
    public <T> Invoker<T> join(Directory<T> directory) throws RpcException {
        return new FailbackClusterInvoker<>(directory);
    }
}

/**
 * ForkingCluster - å¹¶è¡Œè°ƒç”¨
 */
public class ForkingCluster implements Cluster {
    public static final String NAME = "forking";
    
    @Override
    public <T> Invoker<T> join(Directory<T> directory) throws RpcException {
        return new ForkingClusterInvoker<>(directory);
    }
}

/**
 * BroadcastCluster - å¹¿æ’­è°ƒç”¨
 */
public class BroadcastCluster implements Cluster {
    public static final String NAME = "broadcast";
    
    @Override
    public <T> Invoker<T> join(Directory<T> directory) throws RpcException {
        return new BroadcastClusterInvoker<>(directory);
    }
}
```

### 5.4 é›†ç¾¤ç­–ç•¥å¯¹æ¯”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  é›†ç¾¤å®¹é”™ç­–ç•¥å¯¹æ¯”                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç­–ç•¥          â”‚ è¡Œä¸º                â”‚ é€‚ç”¨åœºæ™¯             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  failover     â”‚ å¤±è´¥è‡ªåŠ¨åˆ‡æ¢é‡è¯•    â”‚ è¯»æ“ä½œï¼ˆé»˜è®¤ï¼‰       â”‚
â”‚  failfast     â”‚ å¿«é€Ÿå¤±è´¥ï¼Œåªè°ƒä¸€æ¬¡  â”‚ å†™æ“ä½œ               â”‚
â”‚  failsafe     â”‚ å¤±è´¥å®‰å…¨ï¼Œå¿½ç•¥å¼‚å¸¸  â”‚ æ—¥å¿—è®°å½•             â”‚
â”‚  failback     â”‚ å¤±è´¥è‡ªåŠ¨æ¢å¤ï¼Œåå°é‡è¯•â”‚ æ¶ˆæ¯é€šçŸ¥           â”‚
â”‚  forking      â”‚ å¹¶è¡Œè°ƒç”¨å¤šä¸ª        â”‚ å®æ—¶æ€§è¦æ±‚é«˜         â”‚
â”‚  broadcast    â”‚ å¹¿æ’­è°ƒç”¨æ‰€æœ‰        â”‚ é€šçŸ¥æ‰€æœ‰æä¾›è€…       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. å®æˆ˜åº”ç”¨

### 6.1 æœåŠ¡å¼•ç”¨é…ç½®

```xml
<!-- XMLé…ç½®æ–¹å¼ -->
<dubbo:application name="demo-consumer"/>

<dubbo:registry address="zookeeper://127.0.0.1:2181"/>

<!-- å¼•ç”¨æœåŠ¡ -->
<dubbo:reference id="userService" interface="com.example.UserService">
    <dubbo:method name="getUser" timeout="3000" retries="2"/>
</dubbo:reference>
```

```java
/**
 * æ³¨è§£é…ç½®æ–¹å¼
 */
@DubboReference(version = "1.0.0", timeout = 3000, retries = 2)
private UserService userService;
```

### 6.2 ç›´è¿é…ç½®

```java
/**
 * ç›´è¿æœåŠ¡æä¾›è€…ï¼ˆç»•è¿‡æ³¨å†Œä¸­å¿ƒï¼‰
 */
@DubboReference(url = "dubbo://192.168.1.1:20880")
private UserService userService;

// æˆ–è€…é€šè¿‡JVMå‚æ•°
// -Dcom.example.UserService=dubbo://192.168.1.1:20880
```

### 6.3 é›†ç¾¤å®¹é”™é…ç½®

```java
/**
 * é…ç½®é›†ç¾¤å®¹é”™ç­–ç•¥
 */
@DubboReference(cluster = "failfast")  // å¿«é€Ÿå¤±è´¥
private UserService userService;

@DubboReference(cluster = "failsafe")  // å¤±è´¥å®‰å…¨
private LogService logService;

@DubboReference(cluster = "forking", forks = 3)  // å¹¶è¡Œè°ƒç”¨3ä¸ª
private SearchService searchService;
```

### 6.4 å¼‚æ­¥è°ƒç”¨

```java
/**
 * å¼‚æ­¥è°ƒç”¨é…ç½®
 */
@DubboReference(async = true)
private UserService userService;

// ä½¿ç”¨æ–¹å¼
public void asyncCall() {
    // è°ƒç”¨åç«‹å³è¿”å›null
    userService.getUser(1L);
    
    // è·å–Future
    Future<User> future = RpcContext.getContext().getFuture();
    
    // é˜»å¡è·å–ç»“æœ
    User user = future.get();
}

// CompletableFutureæ–¹å¼
public CompletableFuture<User> asyncCallWithFuture() {
    return RpcContext.getContext().asyncCall(
        () -> userService.getUser(1L));
}
```

---

## 7. é¢è¯•è¦ç‚¹

### 7.1 é«˜é¢‘é¢è¯•é¢˜

#### Q1: DubboæœåŠ¡å¼•ç”¨çš„æ•´ä½“æµç¨‹ï¼Ÿ

```
æœåŠ¡å¼•ç”¨æµç¨‹ï¼š

1. Springå®¹å™¨å¯åŠ¨
   - è§£æDubboé…ç½®
   - åˆ›å»ºReferenceBean

2. ReferenceBeanåˆå§‹åŒ–
   - å®ç°FactoryBeanæ¥å£
   - getObject()è¿”å›ä»£ç†å¯¹è±¡

3. è°ƒç”¨get()æ–¹æ³•
   - æ£€æŸ¥é…ç½®å‚æ•°
   - ç»„è£…å¼•ç”¨URL

4. è®¢é˜…æœåŠ¡
   - Registry.subscribe()
   - è·å–æœåŠ¡æä¾›è€…åˆ—è¡¨

5. åˆ›å»ºInvoker
   - Protocol.refer()
   - å»ºç«‹ç½‘ç»œè¿æ¥

6. é›†ç¾¤å®¹é”™
   - Cluster.join()
   - å°†å¤šä¸ªInvokeråˆå¹¶

7. ç”Ÿæˆä»£ç†
   - ProxyFactory.getProxy()
   - è¿”å›ä»£ç†å¯¹è±¡
```

#### Q2: ReferenceBeanå’ŒReferenceConfigçš„å…³ç³»ï¼Ÿ

```java
/**
 * ReferenceBeanç»§æ‰¿ReferenceConfig
 * 
 * ReferenceConfigï¼š
 * - æœåŠ¡å¼•ç”¨é…ç½®ç±»
 * - åŒ…å«æœåŠ¡å¼•ç”¨çš„æ ¸å¿ƒé€»è¾‘
 * - get()ã€createProxy()ç­‰æ–¹æ³•
 * 
 * ReferenceBeanï¼š
 * - Springé›†æˆç±»
 * - å®ç°FactoryBeanæ¥å£
 * - getObject()è¿”å›ä»£ç†å¯¹è±¡
 * - è´Ÿè´£ä¸Springå®¹å™¨äº¤äº’
 */
public class ReferenceBean<T> extends ReferenceConfig<T>
        implements FactoryBean<T>, InitializingBean {
    
    @Override
    public T getObject() {
        return get();  // è°ƒç”¨çˆ¶ç±»æ–¹æ³•
    }
}
```

#### Q3: Directoryçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ

```java
/**
 * Directory - æœåŠ¡ç›®å½•
 * 
 * ä½œç”¨ï¼š
 * 1. ç»´æŠ¤æœåŠ¡æä¾›è€…åˆ—è¡¨
 * 2. ç›‘å¬æ³¨å†Œä¸­å¿ƒå˜åŒ–
 * 3. åŠ¨æ€æ›´æ–°Invokeråˆ—è¡¨
 * 
 * å®ç°ç±»ï¼š
 * - RegistryDirectoryï¼šä»æ³¨å†Œä¸­å¿ƒè·å–
 * - StaticDirectoryï¼šé™æ€é…ç½®
 */
public interface Directory<T> extends Node {
    
    // è·å–æœåŠ¡æ¥å£
    Class<T> getInterface();
    
    // ğŸ”¥ è·å–Invokeråˆ—è¡¨
    List<Invoker<T>> list(Invocation invocation) throws RpcException;
    
    // è·å–æ‰€æœ‰Invoker
    List<Invoker<T>> getAllInvokers();
}
```

#### Q4: é›†ç¾¤å®¹é”™å’Œè´Ÿè½½å‡è¡¡çš„åŒºåˆ«ï¼Ÿ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              é›†ç¾¤å®¹é”™ vs è´Ÿè½½å‡è¡¡                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç»´åº¦          â”‚ é›†ç¾¤å®¹é”™          â”‚ è´Ÿè½½å‡è¡¡               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ä½œç”¨          â”‚ å¤„ç†è°ƒç”¨å¤±è´¥      â”‚ é€‰æ‹©è°ƒç”¨ç›®æ ‡           â”‚
â”‚  æ—¶æœº          â”‚ è°ƒç”¨å¤±è´¥å        â”‚ è°ƒç”¨ä¹‹å‰               â”‚
â”‚  å…³æ³¨ç‚¹        â”‚ å®¹é”™ç­–ç•¥          â”‚ æµé‡åˆ†é…               â”‚
â”‚  å®ç°          â”‚ Clusteræ¥å£       â”‚ LoadBalanceæ¥å£        â”‚
â”‚  é»˜è®¤å€¼        â”‚ failover          â”‚ random                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è°ƒç”¨é“¾è·¯ï¼š
Cluster â†’ LoadBalance â†’ Invoker
```

### 7.2 æºç é˜…è¯»è¦ç‚¹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  æœåŠ¡å¼•ç”¨æºç é˜…è¯»è·¯çº¿                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  å…¥å£ï¼šReferenceBean.getObject()                            â”‚
â”‚    â”‚                                                        â”‚
â”‚    â–¼                                                        â”‚
â”‚  ReferenceConfig.get()                                      â”‚
â”‚    â”‚                                                        â”‚
â”‚    â”œâ”€â”€ init()                                               â”‚
â”‚    â”‚     â””â”€â”€ createProxy()                                  â”‚
â”‚    â”‚           â”‚                                            â”‚
â”‚    â”‚           â”œâ”€â”€ RegistryProtocol.refer()                 â”‚
â”‚    â”‚           â”‚     â”œâ”€â”€ åˆ›å»ºRegistryDirectory              â”‚
â”‚    â”‚           â”‚     â”œâ”€â”€ è®¢é˜…æœåŠ¡                           â”‚
â”‚    â”‚           â”‚     â””â”€â”€ Cluster.join()                     â”‚
â”‚    â”‚           â”‚                                            â”‚
â”‚    â”‚           â””â”€â”€ ProxyFactory.getProxy()                  â”‚
â”‚    â”‚                 â””â”€â”€ InvokerInvocationHandler           â”‚
â”‚    â”‚                                                        â”‚
â”‚    â””â”€â”€ è¿”å›ä»£ç†å¯¹è±¡                                         â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.3 å…³é”®ç±»æ€»ç»“

```
æœåŠ¡å¼•ç”¨æ¶‰åŠçš„å…³é”®ç±»ï¼š

1. é…ç½®å±‚
   - ReferenceConfigï¼šæœåŠ¡å¼•ç”¨é…ç½®
   - ReferenceBeanï¼šSpringé›†æˆ

2. ä»£ç†å±‚
   - ProxyFactoryï¼šåˆ›å»ºä»£ç†
   - InvokerInvocationHandlerï¼šè°ƒç”¨å¤„ç†å™¨

3. é›†ç¾¤å±‚
   - Clusterï¼šé›†ç¾¤å®¹é”™
   - Directoryï¼šæœåŠ¡ç›®å½•
   - LoadBalanceï¼šè´Ÿè½½å‡è¡¡
   - Routerï¼šè·¯ç”±è§„åˆ™

4. åè®®å±‚
   - Protocolï¼šåè®®æ¥å£
   - RegistryProtocolï¼šæ³¨å†Œåè®®
   - DubboProtocolï¼šDubboåè®®

5. æ³¨å†Œå±‚
   - Registryï¼šæ³¨å†Œä¸­å¿ƒ
   - RegistryDirectoryï¼šæ³¨å†Œç›®å½•
```

---

## ğŸ“š æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

```
1. æœåŠ¡å¼•ç”¨ç”±ReferenceBeanè§¦å‘
   - å®ç°FactoryBeanæ¥å£
   - getObject()è¿”å›ä»£ç†å¯¹è±¡

2. å¼•ç”¨æµç¨‹åŒ…å«å¤šä¸ªæ­¥éª¤
   - è®¢é˜…æœåŠ¡è·å–æä¾›è€…åˆ—è¡¨
   - åˆ›å»ºInvokerå»ºç«‹è¿æ¥
   - é›†ç¾¤å®¹é”™åˆå¹¶Invoker
   - ç”Ÿæˆä»£ç†å¯¹è±¡

3. Directoryç»´æŠ¤æœåŠ¡æä¾›è€…
   - ç›‘å¬æ³¨å†Œä¸­å¿ƒå˜åŒ–
   - åŠ¨æ€æ›´æ–°Invokeråˆ—è¡¨

4. Clusterå®ç°é›†ç¾¤å®¹é”™
   - å¤šç§å®¹é”™ç­–ç•¥å¯é€‰
   - é»˜è®¤failoverå¤±è´¥é‡è¯•

5. ä»£ç†å¯¹è±¡å°è£…è°ƒç”¨é€»è¾‘
   - InvokerInvocationHandlerå¤„ç†è°ƒç”¨
   - åˆ›å»ºRpcInvocationæ‰§è¡Œè¿œç¨‹è°ƒç”¨
```

---

**ç›¸å…³æ–‡æ¡£**ï¼š
- [SPIæœºåˆ¶æºç è§£æ](./SPIæœºåˆ¶æºç è§£æ.md)
- [æœåŠ¡æš´éœ²æºç è§£æ](./æœåŠ¡æš´éœ²æºç è§£æ.md)
- [è´Ÿè½½å‡è¡¡æºç è§£æ](./è´Ÿè½½å‡è¡¡æºç è§£æ.md)
