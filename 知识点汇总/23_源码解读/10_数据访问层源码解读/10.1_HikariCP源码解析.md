# HikariCPæºç è§£æ

> ğŸ’¡ æ·±å…¥ç†è§£æœ€å¿«çš„Javaæ•°æ®åº“è¿æ¥æ± å®ç°åŸç†

---

## ğŸ“š ç›®å½•

1. [HikariCPæ¦‚è¿°](#1-hikaricpæ¦‚è¿°)
2. [æ ¸å¿ƒç»„ä»¶](#2-æ ¸å¿ƒç»„ä»¶)
3. [è¿æ¥è·å–æµç¨‹](#3-è¿æ¥è·å–æµç¨‹)
4. [ConcurrentBagå®ç°](#4-concurrentbagå®ç°)
5. [FastListä¼˜åŒ–](#5-fastlistä¼˜åŒ–)
6. [è¿æ¥ç®¡ç†](#6-è¿æ¥ç®¡ç†)
7. [é¢è¯•è¦ç‚¹](#7-é¢è¯•è¦ç‚¹)

---

## 1. HikariCPæ¦‚è¿°

### 1.1 ä¸ºä»€ä¹ˆHikariCPæœ€å¿«

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  HikariCPæ€§èƒ½ä¼˜åŒ–                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  1. å­—èŠ‚ç ç²¾ç®€                                              â”‚
â”‚     - ä»£ç é‡å°ï¼ŒJITç¼–è¯‘ä¼˜åŒ–æ›´å¥½                             â”‚
â”‚     - å‡å°‘æ–¹æ³•è°ƒç”¨å¼€é”€                                      â”‚
â”‚                                                             â”‚
â”‚  2. ConcurrentBag                                          â”‚
â”‚     - æ— é”è®¾è®¡ï¼Œå‡å°‘çº¿ç¨‹ç«äº‰                                â”‚
â”‚     - ThreadLocalç¼“å­˜ï¼Œä¼˜å…ˆè·å–æœ¬çº¿ç¨‹è¿æ¥                   â”‚
â”‚                                                             â”‚
â”‚  3. FastList                                               â”‚
â”‚     - æ›¿ä»£ArrayListï¼Œå»é™¤èŒƒå›´æ£€æŸ¥                           â”‚
â”‚     - å°¾éƒ¨åˆ é™¤ä¼˜åŒ–                                          â”‚
â”‚                                                             â”‚
â”‚  4. ä»£ç†ç±»ä¼˜åŒ–                                              â”‚
â”‚     - ä½¿ç”¨Javassistç”Ÿæˆä»£ç†                                 â”‚
â”‚     - é¿å…åå°„è°ƒç”¨å¼€é”€                                      â”‚
â”‚                                                             â”‚
â”‚  5. è¿æ¥çŠ¶æ€è¿½è¸ª                                            â”‚
â”‚     - ç²¾ç¡®çš„è¿æ¥çŠ¶æ€ç®¡ç†                                    â”‚
â”‚     - å¿«é€Ÿçš„è¿æ¥éªŒè¯                                        â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ ¸å¿ƒé…ç½®

```java
HikariConfig config = new HikariConfig();
config.setJdbcUrl("jdbc:mysql://localhost:3306/test");
config.setUsername("root");
config.setPassword("password");

// è¿æ¥æ± å¤§å°
config.setMaximumPoolSize(10);      // æœ€å¤§è¿æ¥æ•°
config.setMinimumIdle(5);           // æœ€å°ç©ºé—²è¿æ¥

// è¶…æ—¶é…ç½®
config.setConnectionTimeout(30000); // è·å–è¿æ¥è¶…æ—¶ï¼ˆ30ç§’ï¼‰
config.setIdleTimeout(600000);      // ç©ºé—²è¶…æ—¶ï¼ˆ10åˆ†é’Ÿï¼‰
config.setMaxLifetime(1800000);     // æœ€å¤§ç”Ÿå‘½å‘¨æœŸï¼ˆ30åˆ†é’Ÿï¼‰

// è¿æ¥æµ‹è¯•
config.setConnectionTestQuery("SELECT 1");
config.setValidationTimeout(5000);  // éªŒè¯è¶…æ—¶ï¼ˆ5ç§’ï¼‰

HikariDataSource ds = new HikariDataSource(config);
```


---

## 2. æ ¸å¿ƒç»„ä»¶

### 2.1 HikariDataSource

```java
/**
 * HikariCPæ•°æ®æº
 */
public class HikariDataSource extends HikariConfig implements DataSource, Closeable {
    
    private final AtomicBoolean isShutdown = new AtomicBoolean();
    
    // è¿æ¥æ± ï¼ˆå»¶è¿Ÿåˆå§‹åŒ–ï¼‰
    private volatile HikariPool pool;
    
    // å¿«é€Ÿè·¯å¾„æ ‡è®°
    private final HikariPool fastPathPool;
    
    /**
     * ğŸ”¥ è·å–è¿æ¥
     */
    @Override
    public Connection getConnection() throws SQLException {
        if (isClosed()) {
            throw new SQLException("HikariDataSource has been closed.");
        }
        
        // å¿«é€Ÿè·¯å¾„ï¼šæ± å·²åˆå§‹åŒ–
        if (fastPathPool != null) {
            return fastPathPool.getConnection();
        }
        
        // æ…¢è·¯å¾„ï¼šéœ€è¦åˆå§‹åŒ–æ± 
        HikariPool result = pool;
        if (result == null) {
            synchronized (this) {
                result = pool;
                if (result == null) {
                    validate();
                    pool = result = new HikariPool(this);
                    this.seal();
                }
            }
        }
        
        return result.getConnection();
    }
    
    /**
     * å…³é—­æ•°æ®æº
     */
    @Override
    public void close() {
        if (isShutdown.getAndSet(true)) {
            return;
        }
        
        HikariPool p = pool;
        if (p != null) {
            try {
                p.shutdown();
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
        }
    }
}
```

### 2.2 HikariPool

```java
/**
 * HikariCPè¿æ¥æ± æ ¸å¿ƒç±»
 */
public final class HikariPool extends PoolBase implements HikariPoolMXBean, IBagStateListener {
    
    // ğŸ”¥ è¿æ¥å®¹å™¨
    private final ConcurrentBag<PoolEntry> connectionBag;
    
    // æ·»åŠ è¿æ¥çš„çº¿ç¨‹æ± 
    private final ThreadPoolExecutor addConnectionExecutor;
    
    // å…³é—­è¿æ¥çš„çº¿ç¨‹æ± 
    private final ThreadPoolExecutor closeConnectionExecutor;
    
    // è¿æ¥è¶…æ—¶æ—¶é—´
    private final long connectionTimeout;
    
    // éªŒè¯è¶…æ—¶æ—¶é—´
    private final long validationTimeout;
    
    // æ± çŠ¶æ€
    private volatile boolean isShutdown;
    
    /**
     * æ„é€ å‡½æ•°
     */
    public HikariPool(final HikariConfig config) {
        super(config);
        
        this.connectionBag = new ConcurrentBag<>(this);
        this.connectionTimeout = config.getConnectionTimeout();
        this.validationTimeout = config.getValidationTimeout();
        
        // åˆ›å»ºçº¿ç¨‹æ± 
        this.addConnectionExecutor = createThreadPoolExecutor(
            config.getMaximumPoolSize(),
            "HikariPool-" + poolName + " connection adder",
            config.getThreadFactory(),
            new ThreadPoolExecutor.DiscardOldestPolicy());
        
        this.closeConnectionExecutor = createThreadPoolExecutor(
            config.getMaximumPoolSize(),
            "HikariPool-" + poolName + " connection closer",
            config.getThreadFactory(),
            new ThreadPoolExecutor.CallerRunsPolicy());
        
        // åˆå§‹åŒ–è¿æ¥
        checkFailFast();
        
        // å¯åŠ¨åå°ä»»åŠ¡
        if (config.getScheduledExecutor() == null) {
            this.houseKeepingExecutorService = initializeHouseKeepingExecutorService();
        }
        
        // å¡«å……è¿æ¥æ± 
        fillPool();
    }
    
    /**
     * ğŸ”¥ è·å–è¿æ¥
     */
    public Connection getConnection() throws SQLException {
        return getConnection(connectionTimeout);
    }
    
    public Connection getConnection(final long hardTimeout) throws SQLException {
        suspendResumeLock.acquire();
        final long startTime = currentTime();
        
        try {
            long timeout = hardTimeout;
            do {
                // ğŸ”¥ ä»ConcurrentBagå€Ÿç”¨è¿æ¥
                PoolEntry poolEntry = connectionBag.borrow(timeout, MILLISECONDS);
                
                if (poolEntry == null) {
                    break; // è¶…æ—¶
                }
                
                final long now = currentTime();
                
                // æ£€æŸ¥è¿æ¥æ˜¯å¦è¢«é©±é€æˆ–éœ€è¦éªŒè¯
                if (poolEntry.isMarkedEvicted() || 
                    (elapsedMillis(poolEntry.lastAccessed, now) > aliveBypassWindowMs && 
                     !isConnectionAlive(poolEntry.connection))) {
                    
                    // å…³é—­æ— æ•ˆè¿æ¥
                    closeConnection(poolEntry, poolEntry.isMarkedEvicted() ? 
                        EVICTED_CONNECTION_MESSAGE : DEAD_CONNECTION_MESSAGE);
                    
                    timeout = hardTimeout - elapsedMillis(startTime);
                } else {
                    // ğŸ”¥ è¿”å›ä»£ç†è¿æ¥
                    return poolEntry.createProxyConnection(leakTaskFactory.schedule(poolEntry), now);
                }
            } while (timeout > 0L);
            
            // è·å–è¿æ¥è¶…æ—¶
            throw createTimeoutException(startTime);
            
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
            throw new SQLException("Interrupted during connection acquisition", e);
        } finally {
            suspendResumeLock.release();
        }
    }
    
    /**
     * å½’è¿˜è¿æ¥
     */
    void recycle(final PoolEntry poolEntry) {
        metricsTracker.recordConnectionUsage(poolEntry);
        
        // ğŸ”¥ å½’è¿˜åˆ°ConcurrentBag
        connectionBag.requite(poolEntry);
    }
}
```

---

## 3. è¿æ¥è·å–æµç¨‹

### 3.1 æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  è¿æ¥è·å–æµç¨‹                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  getConnection()                                           â”‚
â”‚       â”‚                                                     â”‚
â”‚       â–¼                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ 1. connectionBag.borrow()               â”‚               â”‚
â”‚  â”‚    å°è¯•ä»ConcurrentBagå€Ÿç”¨è¿æ¥          â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚       â”‚                                                     â”‚
â”‚       â”œâ”€â”€ ä¼˜å…ˆä»ThreadLocalè·å–                            â”‚
â”‚       â”‚                                                     â”‚
â”‚       â”œâ”€â”€ å…¶æ¬¡ä»å…±äº«é˜Ÿåˆ—è·å–                               â”‚
â”‚       â”‚                                                     â”‚
â”‚       â””â”€â”€ æœ€åç­‰å¾…æ–°è¿æ¥                                   â”‚
â”‚       â”‚                                                     â”‚
â”‚       â–¼                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ 2. æ£€æŸ¥è¿æ¥æœ‰æ•ˆæ€§                        â”‚               â”‚
â”‚  â”‚    - æ˜¯å¦è¢«é©±é€                          â”‚               â”‚
â”‚  â”‚    - æ˜¯å¦å­˜æ´»                            â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚       â”‚                                                     â”‚
â”‚       â”œâ”€â”€ æ— æ•ˆï¼šå…³é—­è¿æ¥ï¼Œé‡æ–°è·å–                         â”‚
â”‚       â”‚                                                     â”‚
â”‚       â””â”€â”€ æœ‰æ•ˆï¼šç»§ç»­                                       â”‚
â”‚       â”‚                                                     â”‚
â”‚       â–¼                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ 3. åˆ›å»ºä»£ç†è¿æ¥                          â”‚               â”‚
â”‚  â”‚    ProxyConnectionåŒ…è£…çœŸå®è¿æ¥           â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚       â”‚                                                     â”‚
â”‚       â–¼                                                     â”‚
â”‚  è¿”å›Connection                                            â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 è¿æ¥å½’è¿˜æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  è¿æ¥å½’è¿˜æµç¨‹                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  connection.close()                                        â”‚
â”‚       â”‚                                                     â”‚
â”‚       â–¼                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ ProxyConnection.close()                 â”‚               â”‚
â”‚  â”‚ - ä¸æ˜¯çœŸæ­£å…³é—­è¿æ¥                       â”‚               â”‚
â”‚  â”‚ - è°ƒç”¨æ± çš„recycleæ–¹æ³•                   â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚       â”‚                                                     â”‚
â”‚       â–¼                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ HikariPool.recycle()                    â”‚               â”‚
â”‚  â”‚ - è®°å½•ä½¿ç”¨æŒ‡æ ‡                          â”‚               â”‚
â”‚  â”‚ - è°ƒç”¨connectionBag.requite()           â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚       â”‚                                                     â”‚
â”‚       â–¼                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ ConcurrentBag.requite()                 â”‚               â”‚
â”‚  â”‚ - æ›´æ–°çŠ¶æ€ä¸ºNOT_IN_USE                  â”‚               â”‚
â”‚  â”‚ - å”¤é†’ç­‰å¾…çš„çº¿ç¨‹                        â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. ConcurrentBagå®ç°

### 4.1 æ ¸å¿ƒè®¾è®¡

```java
/**
 * ConcurrentBag - æ— é”å¹¶å‘å®¹å™¨
 * HikariCPæ€§èƒ½çš„å…³é”®
 */
public class ConcurrentBag<T extends IConcurrentBagEntry> implements AutoCloseable {
    
    // ğŸ”¥ ThreadLocalç¼“å­˜ - ä¼˜å…ˆä»æœ¬çº¿ç¨‹è·å–
    private final ThreadLocal<List<Object>> threadList;
    
    // ğŸ”¥ å…±äº«é˜Ÿåˆ— - æ‰€æœ‰è¿æ¥
    private final CopyOnWriteArrayList<T> sharedList;
    
    // ğŸ”¥ ç­‰å¾…é˜Ÿåˆ— - ç­‰å¾…è¿æ¥çš„çº¿ç¨‹
    private final SynchronousQueue<T> handoffQueue;
    
    // ç­‰å¾…è€…è®¡æ•°
    private final AtomicInteger waiters;
    
    // çŠ¶æ€ç›‘å¬å™¨
    private final IBagStateListener listener;
    
    // æ˜¯å¦å…³é—­
    private volatile boolean closed;
    
    /**
     * ğŸ”¥ å€Ÿç”¨è¿æ¥
     */
    public T borrow(long timeout, final TimeUnit timeUnit) throws InterruptedException {
        // 1. ä¼˜å…ˆä»ThreadLocalè·å–
        final List<Object> list = threadList.get();
        for (int i = list.size() - 1; i >= 0; i--) {
            final Object entry = list.remove(i);
            @SuppressWarnings("unchecked")
            final T bagEntry = (T) entry;
            
            // CASæ›´æ–°çŠ¶æ€ï¼šNOT_IN_USE -> IN_USE
            if (bagEntry.compareAndSet(STATE_NOT_IN_USE, STATE_IN_USE)) {
                return bagEntry;
            }
        }
        
        // 2. å¢åŠ ç­‰å¾…è€…è®¡æ•°
        final int waiting = waiters.incrementAndGet();
        try {
            // 3. ä»å…±äº«é˜Ÿåˆ—è·å–
            for (T bagEntry : sharedList) {
                if (bagEntry.compareAndSet(STATE_NOT_IN_USE, STATE_IN_USE)) {
                    // å¯èƒ½éœ€è¦æ·»åŠ æ–°è¿æ¥
                    if (waiting > 1) {
                        listener.addBagItem(waiting - 1);
                    }
                    return bagEntry;
                }
            }
            
            // 4. é€šçŸ¥æ·»åŠ æ–°è¿æ¥
            listener.addBagItem(waiting);
            
            // 5. ç­‰å¾…è¿æ¥
            timeout = timeUnit.toNanos(timeout);
            do {
                final long start = currentTime();
                
                // ä»handoffQueueç­‰å¾…
                final T bagEntry = handoffQueue.poll(timeout, NANOSECONDS);
                
                if (bagEntry == null || bagEntry.compareAndSet(STATE_NOT_IN_USE, STATE_IN_USE)) {
                    return bagEntry;
                }
                
                timeout -= elapsedNanos(start);
            } while (timeout > 10_000);
            
            return null;
            
        } finally {
            waiters.decrementAndGet();
        }
    }
    
    /**
     * ğŸ”¥ å½’è¿˜è¿æ¥
     */
    public void requite(final T bagEntry) {
        // æ›´æ–°çŠ¶æ€
        bagEntry.setState(STATE_NOT_IN_USE);
        
        // å¦‚æœæœ‰ç­‰å¾…è€…ï¼Œç›´æ¥äº¤ç»™ç­‰å¾…è€…
        for (int i = 0; waiters.get() > 0; i++) {
            if (bagEntry.getState() != STATE_NOT_IN_USE || 
                handoffQueue.offer(bagEntry)) {
                return;
            } else if ((i & 0xff) == 0xff) {
                parkNanos(MICROSECONDS.toNanos(10));
            } else {
                Thread.yield();
            }
        }
        
        // æ”¾å…¥ThreadLocalç¼“å­˜
        final List<Object> threadLocalList = threadList.get();
        if (threadLocalList.size() < 50) {
            threadLocalList.add(weakThreadLocals ? new WeakReference<>(bagEntry) : bagEntry);
        }
    }
    
    /**
     * æ·»åŠ è¿æ¥
     */
    public void add(final T bagEntry) {
        if (closed) {
            throw new IllegalStateException("ConcurrentBag has been closed");
        }
        
        sharedList.add(bagEntry);
        
        // å¦‚æœæœ‰ç­‰å¾…è€…ï¼Œå°è¯•ç›´æ¥äº¤ç»™ç­‰å¾…è€…
        while (waiters.get() > 0 && bagEntry.getState() == STATE_NOT_IN_USE && 
               !handoffQueue.offer(bagEntry)) {
            Thread.yield();
        }
    }
}
```

### 4.2 è¿æ¥çŠ¶æ€

```java
/**
 * è¿æ¥çŠ¶æ€
 */
public interface IConcurrentBagEntry {
    int STATE_NOT_IN_USE = 0;  // ç©ºé—²
    int STATE_IN_USE = 1;       // ä½¿ç”¨ä¸­
    int STATE_REMOVED = -1;     // å·²ç§»é™¤
    int STATE_RESERVED = -2;    // ä¿ç•™ï¼ˆç”¨äºé©±é€ï¼‰
    
    boolean compareAndSet(int expectState, int newState);
    void setState(int newState);
    int getState();
}
```

---

## 5. FastListä¼˜åŒ–

### 5.1 FastListå®ç°

```java
/**
 * FastList - ä¼˜åŒ–çš„ArrayList
 * å»é™¤èŒƒå›´æ£€æŸ¥ï¼Œä¼˜åŒ–å°¾éƒ¨åˆ é™¤
 */
public final class FastList<T> implements List<T>, RandomAccess, Serializable {
    
    private final Class<?> clazz;
    private T[] elementData;
    private int size;
    
    @SuppressWarnings("unchecked")
    public FastList(Class<?> clazz) {
        this.elementData = (T[]) Array.newInstance(clazz, 32);
        this.clazz = clazz;
    }
    
    /**
     * ğŸ”¥ æ·»åŠ å…ƒç´  - æ— èŒƒå›´æ£€æŸ¥
     */
    @Override
    public boolean add(T element) {
        if (size < elementData.length) {
            elementData[size++] = element;
        } else {
            // æ‰©å®¹
            final int oldCapacity = elementData.length;
            final int newCapacity = oldCapacity << 1;
            @SuppressWarnings("unchecked")
            final T[] newElementData = (T[]) Array.newInstance(clazz, newCapacity);
            System.arraycopy(elementData, 0, newElementData, 0, oldCapacity);
            newElementData[size++] = element;
            elementData = newElementData;
        }
        return true;
    }
    
    /**
     * ğŸ”¥ è·å–å…ƒç´  - æ— èŒƒå›´æ£€æŸ¥
     */
    @Override
    public T get(int index) {
        return elementData[index];
    }
    
    /**
     * ğŸ”¥ ä»å°¾éƒ¨åˆ é™¤ - O(1)å¤æ‚åº¦
     */
    public T removeLast() {
        T element = elementData[--size];
        elementData[size] = null;
        return element;
    }
    
    /**
     * ğŸ”¥ åˆ é™¤æŒ‡å®šå…ƒç´  - ä»å°¾éƒ¨å¼€å§‹æŸ¥æ‰¾
     */
    @Override
    public boolean remove(Object element) {
        // ä»å°¾éƒ¨å¼€å§‹æŸ¥æ‰¾ï¼Œå› ä¸ºæœ€è¿‘æ·»åŠ çš„æœ€å¯èƒ½è¢«åˆ é™¤
        for (int index = size - 1; index >= 0; index--) {
            if (element == elementData[index]) {
                final int numMoved = size - index - 1;
                if (numMoved > 0) {
                    System.arraycopy(elementData, index + 1, elementData, index, numMoved);
                }
                elementData[--size] = null;
                return true;
            }
        }
        return false;
    }
    
    @Override
    public int size() {
        return size;
    }
    
    @Override
    public boolean isEmpty() {
        return size == 0;
    }
}
```

### 5.2 FastList vs ArrayList

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       æ“ä½œ         â”‚    FastList     â”‚   ArrayList     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ get(index)         â”‚ æ— èŒƒå›´æ£€æŸ¥      â”‚ æœ‰èŒƒå›´æ£€æŸ¥      â”‚
â”‚ add(element)       â”‚ æ— èŒƒå›´æ£€æŸ¥      â”‚ æœ‰èŒƒå›´æ£€æŸ¥      â”‚
â”‚ remove(element)    â”‚ ä»å°¾éƒ¨æŸ¥æ‰¾      â”‚ ä»å¤´éƒ¨æŸ¥æ‰¾      â”‚
â”‚ removeLast()       â”‚ O(1)           â”‚ ä¸æ”¯æŒ          â”‚
â”‚ åˆå§‹å®¹é‡           â”‚ 32             â”‚ 10              â”‚
â”‚ æ‰©å®¹ç­–ç•¥           â”‚ 2å€            â”‚ 1.5å€           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¼˜åŒ–åŸç†ï¼š
1. å»é™¤èŒƒå›´æ£€æŸ¥ï¼šå‡å°‘æ¡ä»¶åˆ¤æ–­
2. ä»å°¾éƒ¨åˆ é™¤ï¼šè¿æ¥æ± åœºæ™¯ï¼Œæœ€è¿‘è·å–çš„è¿æ¥æœ€å¯èƒ½å½’è¿˜
3. æ›´å¤§åˆå§‹å®¹é‡ï¼šå‡å°‘æ‰©å®¹æ¬¡æ•°
```


---

## 6. è¿æ¥ç®¡ç†

### 6.1 è¿æ¥åˆ›å»º

```java
/**
 * PoolBase - è¿æ¥åˆ›å»ºåŸºç±»
 */
abstract class PoolBase {
    
    /**
     * åˆ›å»ºæ–°è¿æ¥
     */
    PoolEntry newPoolEntry() throws Exception {
        // åˆ›å»ºç‰©ç†è¿æ¥
        return new PoolEntry(newConnection(), this, isReadOnly, isAutoCommit);
    }
    
    /**
     * åˆ›å»ºç‰©ç†è¿æ¥
     */
    private Connection newConnection() throws Exception {
        final long start = currentTime();
        
        Connection connection = null;
        try {
            String username = config.getUsername();
            String password = config.getPassword();
            
            // ä½¿ç”¨DataSourceæˆ–DriverManageråˆ›å»ºè¿æ¥
            connection = (username == null) ? 
                dataSource.getConnection() : 
                dataSource.getConnection(username, password);
            
            if (connection == null) {
                throw new SQLTransientConnectionException("DataSource returned null");
            }
            
            // è®¾ç½®è¿æ¥å±æ€§
            setupConnection(connection);
            
            lastConnectionFailure.set(null);
            return connection;
            
        } catch (Exception e) {
            if (connection != null) {
                quietlyCloseConnection(connection, "(Failed to create/setup connection)");
            }
            lastConnectionFailure.set(e);
            throw e;
        } finally {
            // è®°å½•åˆ›å»ºæ—¶é—´
            if (metricsTracker != null) {
                metricsTracker.recordConnectionCreated(elapsedMillis(start));
            }
        }
    }
    
    /**
     * è®¾ç½®è¿æ¥å±æ€§
     */
    private void setupConnection(final Connection connection) throws SQLException {
        if (networkTimeout != UNSET) {
            connection.setNetworkTimeout(netTimeoutExecutor, (int) networkTimeout);
        }
        
        if (transactionIsolation != UNSET) {
            connection.setTransactionIsolation(transactionIsolation);
        }
        
        if (isAutoCommit != connection.getAutoCommit()) {
            connection.setAutoCommit(isAutoCommit);
        }
        
        if (isReadOnly != connection.isReadOnly()) {
            connection.setReadOnly(isReadOnly);
        }
        
        if (catalog != null) {
            connection.setCatalog(catalog);
        }
        
        if (schema != null) {
            connection.setSchema(schema);
        }
        
        // æ‰§è¡Œåˆå§‹åŒ–SQL
        executeSql(connection, config.getConnectionInitSql(), true);
    }
}
```

### 6.2 è¿æ¥éªŒè¯

```java
/**
 * éªŒè¯è¿æ¥æ˜¯å¦å­˜æ´»
 */
boolean isConnectionAlive(final Connection connection) {
    try {
        try {
            // è®¾ç½®éªŒè¯è¶…æ—¶
            setNetworkTimeout(connection, validationTimeout);
            
            final int validationSeconds = (int) Math.max(1000L, validationTimeout) / 1000;
            
            // ğŸ”¥ ä¼˜å…ˆä½¿ç”¨JDBC4çš„isValidæ–¹æ³•
            if (isUseJdbc4Validation) {
                return connection.isValid(validationSeconds);
            }
            
            // ğŸ”¥ é™çº§ä½¿ç”¨æµ‹è¯•SQL
            try (Statement statement = connection.createStatement()) {
                if (isNetworkTimeoutSupported != TRUE) {
                    setQueryTimeout(statement, validationSeconds);
                }
                statement.execute(config.getConnectionTestQuery());
            }
        } finally {
            // æ¢å¤ç½‘ç»œè¶…æ—¶
            setNetworkTimeout(connection, networkTimeout);
            
            // å¦‚æœéªŒè¯æœŸé—´æœ‰äº‹åŠ¡ï¼Œå›æ»š
            if (isIsolateInternalQueries && !isAutoCommit) {
                connection.rollback();
            }
        }
        
        return true;
        
    } catch (Exception e) {
        lastConnectionFailure.set(e);
        return false;
    }
}
```

### 6.3 è¿æ¥æ³„æ¼æ£€æµ‹

```java
/**
 * è¿æ¥æ³„æ¼æ£€æµ‹ä»»åŠ¡
 */
class ProxyLeakTask implements Runnable {
    
    private final PoolEntry poolEntry;
    private final long leakDetectionThreshold;
    private ScheduledFuture<?> scheduledFuture;
    
    @Override
    public void run() {
        // è¿æ¥ä½¿ç”¨æ—¶é—´è¶…è¿‡é˜ˆå€¼ï¼Œè®°å½•è­¦å‘Š
        final StackTraceElement[] stackTrace = exception.getStackTrace();
        final StackTraceElement[] trace = new StackTraceElement[stackTrace.length - 5];
        System.arraycopy(stackTrace, 5, trace, 0, trace.length);
        
        exception.setStackTrace(trace);
        LOGGER.warn("Connection leak detection triggered for {}, stack trace follows", 
            poolEntry.connection, exception);
    }
    
    void cancel() {
        if (scheduledFuture != null) {
            scheduledFuture.cancel(false);
        }
    }
}

// é…ç½®æ³„æ¼æ£€æµ‹
config.setLeakDetectionThreshold(60000); // 60ç§’
```

### 6.4 åå°ç»´æŠ¤ä»»åŠ¡

```java
/**
 * HouseKeeper - åå°ç»´æŠ¤ä»»åŠ¡
 */
private final class HouseKeeper implements Runnable {
    
    private volatile long previous = plusMillis(currentTime(), -housekeepingPeriodMs);
    
    @Override
    public void run() {
        try {
            // è¯»å–é…ç½®
            connectionTimeout = config.getConnectionTimeout();
            validationTimeout = config.getValidationTimeout();
            leakTaskFactory = (leakDetectionThreshold > 0) ? 
                new ProxyLeakTaskFactory(leakDetectionThreshold, houseKeepingExecutorService) : 
                ProxyLeakTaskFactory.NO_LEAK;
            
            final long idleTimeout = config.getIdleTimeout();
            final long now = currentTime();
            
            // æ£€æŸ¥æ—¶é’Ÿå›æ‹¨
            if (plusMillis(now, 128) < plusMillis(previous, housekeepingPeriodMs)) {
                softEvictConnections();
                return;
            }
            
            previous = now;
            
            // ğŸ”¥ å…³é—­ç©ºé—²è¶…æ—¶çš„è¿æ¥
            if (idleTimeout > 0L && config.getMinimumIdle() < config.getMaximumPoolSize()) {
                logPoolState("Before cleanup ");
                
                final List<PoolEntry> notInUse = connectionBag.values(STATE_NOT_IN_USE);
                int toRemove = notInUse.size() - config.getMinimumIdle();
                
                for (PoolEntry entry : notInUse) {
                    if (toRemove > 0 && 
                        elapsedMillis(entry.lastAccessed, now) > idleTimeout &&
                        connectionBag.reserve(entry)) {
                        
                        closeConnection(entry, "(connection has passed idleTimeout)");
                        toRemove--;
                    }
                }
                
                logPoolState("After cleanup  ");
            }
            
            // ğŸ”¥ å¡«å……è¿æ¥æ± åˆ°æœ€å°ç©ºé—²æ•°
            fillPool();
            
        } catch (Exception e) {
            LOGGER.error("Unexpected exception in housekeeping task", e);
        }
    }
}
```

---

## 7. é¢è¯•è¦ç‚¹

### 7.1 é«˜é¢‘é¢è¯•é¢˜

#### Q1: HikariCPä¸ºä»€ä¹ˆæ€§èƒ½æœ€å¥½ï¼Ÿ

```
ç­”æ¡ˆè¦ç‚¹ï¼š
1. ConcurrentBagæ— é”è®¾è®¡
   - ThreadLocalç¼“å­˜ï¼Œä¼˜å…ˆè·å–æœ¬çº¿ç¨‹è¿æ¥
   - CASæ“ä½œæ›´æ–°çŠ¶æ€ï¼Œå‡å°‘é”ç«äº‰
   
2. FastListä¼˜åŒ–
   - å»é™¤èŒƒå›´æ£€æŸ¥
   - ä»å°¾éƒ¨åˆ é™¤ï¼ŒO(1)å¤æ‚åº¦
   
3. å­—èŠ‚ç ç²¾ç®€
   - ä»£ç é‡å°ï¼ŒJITä¼˜åŒ–æ›´å¥½
   - ä½¿ç”¨Javassistç”Ÿæˆä»£ç†ï¼Œé¿å…åå°„
   
4. è¿æ¥çŠ¶æ€ç²¾ç¡®ç®¡ç†
   - å¿«é€Ÿçš„è¿æ¥éªŒè¯
   - ç²¾ç¡®çš„è¶…æ—¶æ§åˆ¶
```

#### Q2: ConcurrentBagçš„å·¥ä½œåŸç†ï¼Ÿ

```
ç­”æ¡ˆè¦ç‚¹ï¼š
1. ä¸‰çº§è·å–ç­–ç•¥ï¼š
   - ä¼˜å…ˆä»ThreadLocalè·å–ï¼ˆæ— ç«äº‰ï¼‰
   - å…¶æ¬¡ä»å…±äº«é˜Ÿåˆ—è·å–ï¼ˆCASç«äº‰ï¼‰
   - æœ€åç­‰å¾…æ–°è¿æ¥ï¼ˆé˜»å¡ï¼‰

2. å½’è¿˜ç­–ç•¥ï¼š
   - å¦‚æœæœ‰ç­‰å¾…è€…ï¼Œç›´æ¥äº¤ç»™ç­‰å¾…è€…
   - å¦åˆ™æ”¾å…¥ThreadLocalç¼“å­˜

3. çŠ¶æ€ç®¡ç†ï¼š
   - CASæ›´æ–°çŠ¶æ€ï¼Œæ— é”è®¾è®¡
   - çŠ¶æ€ï¼šNOT_IN_USEã€IN_USEã€REMOVEDã€RESERVED
```

#### Q3: è¿æ¥æ± çš„å…³é”®é…ç½®å‚æ•°ï¼Ÿ

```java
// è¿æ¥æ± å¤§å°
maximumPoolSize: 10    // æœ€å¤§è¿æ¥æ•°
minimumIdle: 5         // æœ€å°ç©ºé—²è¿æ¥

// è¶…æ—¶é…ç½®
connectionTimeout: 30000  // è·å–è¿æ¥è¶…æ—¶
idleTimeout: 600000       // ç©ºé—²è¶…æ—¶
maxLifetime: 1800000      // æœ€å¤§ç”Ÿå‘½å‘¨æœŸ

// è¿æ¥éªŒè¯
validationTimeout: 5000   // éªŒè¯è¶…æ—¶
connectionTestQuery: "SELECT 1"  // æµ‹è¯•SQL

// æ³„æ¼æ£€æµ‹
leakDetectionThreshold: 60000  // æ³„æ¼æ£€æµ‹é˜ˆå€¼

æœ€ä½³å®è·µï¼š
- maximumPoolSize = CPUæ ¸å¿ƒæ•° * 2 + ç£ç›˜æ•°
- maxLifetime < æ•°æ®åº“wait_timeout
- å¼€å¯æ³„æ¼æ£€æµ‹
```

### 7.2 çŸ¥è¯†ç‚¹æ€»ç»“

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  HikariCPæºç æ€»ç»“                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  æ ¸å¿ƒç»„ä»¶ï¼š                                                  â”‚
â”‚  â”œâ”€â”€ HikariDataSource: æ•°æ®æºå…¥å£                          â”‚
â”‚  â”œâ”€â”€ HikariPool: è¿æ¥æ± æ ¸å¿ƒ                                â”‚
â”‚  â”œâ”€â”€ ConcurrentBag: æ— é”è¿æ¥å®¹å™¨                           â”‚
â”‚  â”œâ”€â”€ PoolEntry: è¿æ¥åŒ…è£…                                   â”‚
â”‚  â””â”€â”€ FastList: ä¼˜åŒ–çš„åˆ—è¡¨                                  â”‚
â”‚                                                             â”‚
â”‚  æ€§èƒ½ä¼˜åŒ–ï¼š                                                  â”‚
â”‚  â”œâ”€â”€ ThreadLocalç¼“å­˜                                       â”‚
â”‚  â”œâ”€â”€ CASæ— é”æ“ä½œ                                           â”‚
â”‚  â”œâ”€â”€ å»é™¤èŒƒå›´æ£€æŸ¥                                          â”‚
â”‚  â””â”€â”€ Javassistä»£ç†                                         â”‚
â”‚                                                             â”‚
â”‚  è¿æ¥ç®¡ç†ï¼š                                                  â”‚
â”‚  â”œâ”€â”€ è¿æ¥åˆ›å»ºå’ŒéªŒè¯                                        â”‚
â”‚  â”œâ”€â”€ ç©ºé—²è¶…æ—¶æ¸…ç†                                          â”‚
â”‚  â”œâ”€â”€ æœ€å¤§ç”Ÿå‘½å‘¨æœŸæ§åˆ¶                                      â”‚
â”‚  â””â”€â”€ æ³„æ¼æ£€æµ‹                                              â”‚
â”‚                                                             â”‚
â”‚  è·å–æµç¨‹ï¼š                                                  â”‚
â”‚  ThreadLocal â†’ å…±äº«é˜Ÿåˆ— â†’ ç­‰å¾…æ–°è¿æ¥                       â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [HikariCPå®˜æ–¹æ–‡æ¡£](https://github.com/brettwooldridge/HikariCP)
- [HikariCP Wiki](https://github.com/brettwooldridge/HikariCP/wiki)

---

**æŒæ¡HikariCPæºç ï¼Œç†è§£é«˜æ€§èƒ½è¿æ¥æ± è®¾è®¡ï¼** ğŸš€

*æœ€åæ›´æ–°ï¼š2025-12-28*
