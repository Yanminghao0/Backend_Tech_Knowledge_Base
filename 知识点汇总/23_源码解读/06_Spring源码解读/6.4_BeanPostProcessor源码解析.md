# BeanPostProcessoræºç è§£æ

> ğŸ’¡ æ·±å…¥ç†è§£Spring Beanåç½®å¤„ç†å™¨æœºåˆ¶ï¼ŒæŒæ¡Beanç”Ÿå‘½å‘¨æœŸæ‰©å±•ç‚¹

---

## ğŸ“š ç›®å½•

1. [BeanPostProcessoræ¦‚è¿°](#1-beanpostprocessoræ¦‚è¿°)
2. [æ ¸å¿ƒæ¥å£ä½“ç³»](#2-æ ¸å¿ƒæ¥å£ä½“ç³»)
3. [æ‰§è¡Œæ—¶æœºåˆ†æ](#3-æ‰§è¡Œæ—¶æœºåˆ†æ)
4. [å¸¸è§å®ç°ç±»](#4-å¸¸è§å®ç°ç±»)
5. [AOPä»£ç†åˆ›å»º](#5-aopä»£ç†åˆ›å»º)
6. [è‡ªå®šä¹‰æ‰©å±•å¼€å‘](#6-è‡ªå®šä¹‰æ‰©å±•å¼€å‘)
7. [é¢è¯•è¦ç‚¹](#7-é¢è¯•è¦ç‚¹)

---

## 1. BeanPostProcessoræ¦‚è¿°

### 1.1 ä»€ä¹ˆæ˜¯BeanPostProcessor

BeanPostProcessoræ˜¯Springæä¾›çš„Beanç”Ÿå‘½å‘¨æœŸæ‰©å±•ç‚¹ï¼Œå…è®¸åœ¨Beanåˆå§‹åŒ–å‰åè¿›è¡Œè‡ªå®šä¹‰å¤„ç†ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Beanç”Ÿå‘½å‘¨æœŸä¸­çš„ä½ç½®                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  1. å®ä¾‹åŒ– (Instantiation)                                 â”‚
â”‚         â”‚                                                   â”‚
â”‚         â–¼                                                   â”‚
â”‚  2. å±æ€§å¡«å…… (Populate)                                    â”‚
â”‚         â”‚                                                   â”‚
â”‚         â–¼                                                   â”‚
â”‚  3. Awareæ¥å£å›è°ƒ                                          â”‚
â”‚         â”‚                                                   â”‚
â”‚         â–¼                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚ ğŸ”¥ postProcessBeforeInitialization  â”‚ â† BeanPostProcessorâ”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚         â”‚                                                   â”‚
â”‚         â–¼                                                   â”‚
â”‚  4. åˆå§‹åŒ–æ–¹æ³• (InitializingBean/init-method)              â”‚
â”‚         â”‚                                                   â”‚
â”‚         â–¼                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚ ğŸ”¥ postProcessAfterInitialization   â”‚ â† BeanPostProcessorâ”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚         â”‚                                                   â”‚
â”‚         â–¼                                                   â”‚
â”‚  5. Beanå°±ç»ªï¼Œå¯ä»¥ä½¿ç”¨                                     â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ ¸å¿ƒä½œç”¨

```java
// BeanPostProcessorçš„å…¸å‹åº”ç”¨ï¼š
// 1. AOPä»£ç†åˆ›å»º - AbstractAutoProxyCreator
// 2. @Autowiredæ³¨å…¥ - AutowiredAnnotationBeanPostProcessor
// 3. @Resourceæ³¨å…¥ - CommonAnnotationBeanPostProcessor
// 4. @PostConstruct/@PreDestroy - CommonAnnotationBeanPostProcessor
// 5. @Asyncå¼‚æ­¥å¤„ç† - AsyncAnnotationBeanPostProcessor
// 6. @Scheduledå®šæ—¶ä»»åŠ¡ - ScheduledAnnotationBeanPostProcessor
```


---

## 2. æ ¸å¿ƒæ¥å£ä½“ç³»

### 2.1 BeanPostProcessoræ¥å£

```java
/**
 * Beanåç½®å¤„ç†å™¨æ¥å£
 * åœ¨Beanåˆå§‹åŒ–å‰åè¿›è¡Œå¤„ç†
 */
public interface BeanPostProcessor {
    
    /**
     * åˆå§‹åŒ–å‰å¤„ç†
     * åœ¨InitializingBean.afterPropertiesSet()å’Œinit-methodä¹‹å‰è°ƒç”¨
     * 
     * @param bean åŸå§‹Beanå®ä¾‹
     * @param beanName Beanåç§°
     * @return å¤„ç†åçš„Beanï¼ˆå¯ä»¥æ˜¯åŸå§‹Beanæˆ–åŒ…è£…åçš„ä»£ç†ï¼‰
     */
    @Nullable
    default Object postProcessBeforeInitialization(Object bean, String beanName) 
            throws BeansException {
        return bean;
    }
    
    /**
     * åˆå§‹åŒ–åå¤„ç†
     * åœ¨InitializingBean.afterPropertiesSet()å’Œinit-methodä¹‹åè°ƒç”¨
     * 
     * @param bean åŸå§‹Beanå®ä¾‹ï¼ˆæˆ–å‰ä¸€ä¸ªå¤„ç†å™¨è¿”å›çš„Beanï¼‰
     * @param beanName Beanåç§°
     * @return å¤„ç†åçš„Beanï¼ˆå¯ä»¥æ˜¯åŸå§‹Beanæˆ–åŒ…è£…åçš„ä»£ç†ï¼‰
     */
    @Nullable
    default Object postProcessAfterInitialization(Object bean, String beanName) 
            throws BeansException {
        return bean;
    }
}
```

### 2.2 InstantiationAwareBeanPostProcessor

```java
/**
 * å®ä¾‹åŒ–æ„ŸçŸ¥çš„Beanåç½®å¤„ç†å™¨
 * æ‰©å±•äº†å®ä¾‹åŒ–å‰åçš„å¤„ç†èƒ½åŠ›
 */
public interface InstantiationAwareBeanPostProcessor extends BeanPostProcessor {
    
    /**
     * å®ä¾‹åŒ–å‰å¤„ç†
     * åœ¨Beanå®ä¾‹åŒ–ä¹‹å‰è°ƒç”¨ï¼Œå¯ä»¥è¿”å›ä»£ç†å¯¹è±¡æ›¿ä»£åŸå§‹Bean
     * 
     * @return ä»£ç†å¯¹è±¡ï¼ˆå¦‚æœè¿”å›énullï¼Œåˆ™è·³è¿‡æ­£å¸¸çš„å®ä¾‹åŒ–æµç¨‹ï¼‰
     */
    @Nullable
    default Object postProcessBeforeInstantiation(Class<?> beanClass, String beanName) 
            throws BeansException {
        return null;
    }
    
    /**
     * å®ä¾‹åŒ–åå¤„ç†
     * åœ¨Beanå®ä¾‹åŒ–ä¹‹åã€å±æ€§å¡«å……ä¹‹å‰è°ƒç”¨
     * 
     * @return trueç»§ç»­å±æ€§å¡«å……ï¼Œfalseè·³è¿‡å±æ€§å¡«å……
     */
    default boolean postProcessAfterInstantiation(Object bean, String beanName) 
            throws BeansException {
        return true;
    }
    
    /**
     * å±æ€§å€¼å¤„ç†
     * åœ¨å±æ€§å¡«å……ä¹‹å‰è°ƒç”¨ï¼Œå¯ä»¥ä¿®æ”¹å±æ€§å€¼
     */
    @Nullable
    default PropertyValues postProcessProperties(PropertyValues pvs, Object bean, String beanName)
            throws BeansException {
        return null;
    }
}
```

### 2.3 SmartInstantiationAwareBeanPostProcessor

```java
/**
 * æ™ºèƒ½å®ä¾‹åŒ–æ„ŸçŸ¥çš„Beanåç½®å¤„ç†å™¨
 * æä¾›æ›´å¤šçš„å®ä¾‹åŒ–ç›¸å…³å›è°ƒ
 */
public interface SmartInstantiationAwareBeanPostProcessor 
        extends InstantiationAwareBeanPostProcessor {
    
    /**
     * é¢„æµ‹Beanç±»å‹
     * ç”¨äºç±»å‹åŒ¹é…
     */
    @Nullable
    default Class<?> predictBeanType(Class<?> beanClass, String beanName) 
            throws BeansException {
        return null;
    }
    
    /**
     * ç¡®å®šå€™é€‰æ„é€ å‡½æ•°
     * ç”¨äºæ„é€ å‡½æ•°æ³¨å…¥
     */
    @Nullable
    default Constructor<?>[] determineCandidateConstructors(Class<?> beanClass, String beanName)
            throws BeansException {
        return null;
    }
    
    /**
     * ğŸ”¥ è·å–æ—©æœŸBeanå¼•ç”¨
     * ç”¨äºè§£å†³å¾ªç¯ä¾èµ–ï¼Œè¿”å›å¯èƒ½è¢«ä»£ç†çš„Bean
     */
    default Object getEarlyBeanReference(Object bean, String beanName) 
            throws BeansException {
        return bean;
    }
}
```

### 2.4 DestructionAwareBeanPostProcessor

```java
/**
 * é”€æ¯æ„ŸçŸ¥çš„Beanåç½®å¤„ç†å™¨
 * æä¾›Beané”€æ¯å‰çš„å›è°ƒ
 */
public interface DestructionAwareBeanPostProcessor extends BeanPostProcessor {
    
    /**
     * é”€æ¯å‰å¤„ç†
     * åœ¨Beané”€æ¯ä¹‹å‰è°ƒç”¨
     */
    void postProcessBeforeDestruction(Object bean, String beanName) throws BeansException;
    
    /**
     * æ˜¯å¦éœ€è¦é”€æ¯å¤„ç†
     */
    default boolean requiresDestruction(Object bean) {
        return true;
    }
}
```

### 2.5 MergedBeanDefinitionPostProcessor

```java
/**
 * åˆå¹¶Beanå®šä¹‰åç½®å¤„ç†å™¨
 * åœ¨Beanå®šä¹‰åˆå¹¶åã€å®ä¾‹åŒ–å‰è°ƒç”¨
 */
public interface MergedBeanDefinitionPostProcessor extends BeanPostProcessor {
    
    /**
     * å¤„ç†åˆå¹¶åçš„Beanå®šä¹‰
     * ç”¨äºæ”¶é›†æ³¨è§£ä¿¡æ¯ç­‰
     */
    void postProcessMergedBeanDefinition(RootBeanDefinition beanDefinition, 
            Class<?> beanType, String beanName);
    
    /**
     * é‡ç½®Beanå®šä¹‰
     */
    default void resetBeanDefinition(String beanName) {
    }
}
```

### 2.6 æ¥å£ç»§æ‰¿å…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              BeanPostProcessoræ¥å£ä½“ç³»                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  BeanPostProcessor                                         â”‚
â”‚  â”œâ”€â”€ postProcessBeforeInitialization()                     â”‚
â”‚  â””â”€â”€ postProcessAfterInitialization()                      â”‚
â”‚         â”‚                                                   â”‚
â”‚         â”œâ”€â”€ InstantiationAwareBeanPostProcessor            â”‚
â”‚         â”‚   â”œâ”€â”€ postProcessBeforeInstantiation()           â”‚
â”‚         â”‚   â”œâ”€â”€ postProcessAfterInstantiation()            â”‚
â”‚         â”‚   â””â”€â”€ postProcessProperties()                    â”‚
â”‚         â”‚         â”‚                                         â”‚
â”‚         â”‚         â””â”€â”€ SmartInstantiationAwareBeanPostProcessor
â”‚         â”‚             â”œâ”€â”€ predictBeanType()                â”‚
â”‚         â”‚             â”œâ”€â”€ determineCandidateConstructors() â”‚
â”‚         â”‚             â””â”€â”€ getEarlyBeanReference()          â”‚
â”‚         â”‚                                                   â”‚
â”‚         â”œâ”€â”€ DestructionAwareBeanPostProcessor              â”‚
â”‚         â”‚   â””â”€â”€ postProcessBeforeDestruction()             â”‚
â”‚         â”‚                                                   â”‚
â”‚         â””â”€â”€ MergedBeanDefinitionPostProcessor              â”‚
â”‚             â””â”€â”€ postProcessMergedBeanDefinition()          â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. æ‰§è¡Œæ—¶æœºåˆ†æ

### 3.1 å®Œæ•´ç”Ÿå‘½å‘¨æœŸä¸­çš„æ‰§è¡Œç‚¹

```java
/**
 * AbstractAutowireCapableBeanFactory.doCreateBean()
 * Beanåˆ›å»ºçš„æ ¸å¿ƒæ–¹æ³•
 */
protected Object doCreateBean(String beanName, RootBeanDefinition mbd, Object[] args) {
    BeanWrapper instanceWrapper = null;
    
    // 1. ğŸ”¥ å®ä¾‹åŒ–å‰å¤„ç†
    // InstantiationAwareBeanPostProcessor.postProcessBeforeInstantiation()
    // å¦‚æœè¿”å›énullï¼Œç›´æ¥è¿”å›ä»£ç†å¯¹è±¡
    
    // 2. å®ä¾‹åŒ–Bean
    if (instanceWrapper == null) {
        instanceWrapper = createBeanInstance(beanName, mbd, args);
    }
    Object bean = instanceWrapper.getWrappedInstance();
    
    // 3. ğŸ”¥ MergedBeanDefinitionPostProcessor.postProcessMergedBeanDefinition()
    // æ”¶é›†@Autowiredã€@Resourceç­‰æ³¨è§£ä¿¡æ¯
    synchronized (mbd.postProcessingLock) {
        if (!mbd.postProcessed) {
            applyMergedBeanDefinitionPostProcessors(mbd, beanType, beanName);
            mbd.postProcessed = true;
        }
    }
    
    // 4. ğŸ”¥ æå‰æš´éœ²ï¼ˆè§£å†³å¾ªç¯ä¾èµ–ï¼‰
    // SmartInstantiationAwareBeanPostProcessor.getEarlyBeanReference()
    boolean earlySingletonExposure = (mbd.isSingleton() && 
        this.allowCircularReferences && isSingletonCurrentlyInCreation(beanName));
    if (earlySingletonExposure) {
        addSingletonFactory(beanName, () -> getEarlyBeanReference(beanName, mbd, bean));
    }
    
    Object exposedObject = bean;
    
    // 5. ğŸ”¥ å®ä¾‹åŒ–åå¤„ç† + å±æ€§å¡«å……
    // InstantiationAwareBeanPostProcessor.postProcessAfterInstantiation()
    // InstantiationAwareBeanPostProcessor.postProcessProperties()
    populateBean(beanName, mbd, instanceWrapper);
    
    // 6. ğŸ”¥ åˆå§‹åŒ–Bean
    // BeanPostProcessor.postProcessBeforeInitialization()
    // InitializingBean.afterPropertiesSet() / init-method
    // BeanPostProcessor.postProcessAfterInitialization()
    exposedObject = initializeBean(beanName, exposedObject, mbd);
    
    return exposedObject;
}
```

### 3.2 initializeBeanè¯¦ç»†æµç¨‹

```java
/**
 * åˆå§‹åŒ–Bean
 */
protected Object initializeBean(String beanName, Object bean, RootBeanDefinition mbd) {
    
    // 1. è°ƒç”¨Awareæ¥å£æ–¹æ³•
    if (System.getSecurityManager() != null) {
        AccessController.doPrivileged((PrivilegedAction<Object>) () -> {
            invokeAwareMethods(beanName, bean);
            return null;
        }, getAccessControlContext());
    } else {
        invokeAwareMethods(beanName, bean);
    }
    
    Object wrappedBean = bean;
    
    // 2. ğŸ”¥ åˆå§‹åŒ–å‰å¤„ç†
    if (mbd == null || !mbd.isSynthetic()) {
        wrappedBean = applyBeanPostProcessorsBeforeInitialization(wrappedBean, beanName);
    }
    
    // 3. è°ƒç”¨åˆå§‹åŒ–æ–¹æ³•
    try {
        invokeInitMethods(beanName, wrappedBean, mbd);
    } catch (Throwable ex) {
        throw new BeanCreationException(...);
    }
    
    // 4. ğŸ”¥ åˆå§‹åŒ–åå¤„ç†
    if (mbd == null || !mbd.isSynthetic()) {
        wrappedBean = applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName);
    }
    
    return wrappedBean;
}

/**
 * åº”ç”¨åˆå§‹åŒ–å‰å¤„ç†å™¨
 */
public Object applyBeanPostProcessorsBeforeInitialization(Object existingBean, String beanName) {
    Object result = existingBean;
    
    // éå†æ‰€æœ‰BeanPostProcessor
    for (BeanPostProcessor processor : getBeanPostProcessors()) {
        Object current = processor.postProcessBeforeInitialization(result, beanName);
        if (current == null) {
            return result;  // è¿”å›nullåˆ™ä½¿ç”¨ä¸Šä¸€ä¸ªç»“æœ
        }
        result = current;
    }
    
    return result;
}

/**
 * åº”ç”¨åˆå§‹åŒ–åå¤„ç†å™¨
 */
public Object applyBeanPostProcessorsAfterInitialization(Object existingBean, String beanName) {
    Object result = existingBean;
    
    // éå†æ‰€æœ‰BeanPostProcessor
    for (BeanPostProcessor processor : getBeanPostProcessors()) {
        Object current = processor.postProcessAfterInitialization(result, beanName);
        if (current == null) {
            return result;
        }
        result = current;
    }
    
    return result;
}
```

### 3.3 æ‰§è¡Œé¡ºåºå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              BeanPostProcessoræ‰§è¡Œé¡ºåº                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  getBean("userService")                                    â”‚
â”‚         â”‚                                                   â”‚
â”‚         â–¼                                                   â”‚
â”‚  â‘  postProcessBeforeInstantiation() â† å¯è¿”å›ä»£ç†è·³è¿‡å®ä¾‹åŒ–  â”‚
â”‚         â”‚                                                   â”‚
â”‚         â–¼                                                   â”‚
â”‚  â‘¡ æ„é€ å‡½æ•°å®ä¾‹åŒ–                                          â”‚
â”‚         â”‚                                                   â”‚
â”‚         â–¼                                                   â”‚
â”‚  â‘¢ postProcessMergedBeanDefinition() â† æ”¶é›†æ³¨è§£ä¿¡æ¯        â”‚
â”‚         â”‚                                                   â”‚
â”‚         â–¼                                                   â”‚
â”‚  â‘£ getEarlyBeanReference() â† ä¸‰çº§ç¼“å­˜ï¼Œè§£å†³å¾ªç¯ä¾èµ–        â”‚
â”‚         â”‚                                                   â”‚
â”‚         â–¼                                                   â”‚
â”‚  â‘¤ postProcessAfterInstantiation() â† è¿”å›falseè·³è¿‡å±æ€§å¡«å…… â”‚
â”‚         â”‚                                                   â”‚
â”‚         â–¼                                                   â”‚
â”‚  â‘¥ postProcessProperties() â† @Autowiredæ³¨å…¥               â”‚
â”‚         â”‚                                                   â”‚
â”‚         â–¼                                                   â”‚
â”‚  â‘¦ Awareæ¥å£å›è°ƒ                                           â”‚
â”‚         â”‚                                                   â”‚
â”‚         â–¼                                                   â”‚
â”‚  â‘§ postProcessBeforeInitialization() â† @PostConstruct     â”‚
â”‚         â”‚                                                   â”‚
â”‚         â–¼                                                   â”‚
â”‚  â‘¨ InitializingBean.afterPropertiesSet()                  â”‚
â”‚         â”‚                                                   â”‚
â”‚         â–¼                                                   â”‚
â”‚  â‘© init-method                                             â”‚
â”‚         â”‚                                                   â”‚
â”‚         â–¼                                                   â”‚
â”‚  â‘ª postProcessAfterInitialization() â† AOPä»£ç†åˆ›å»º         â”‚
â”‚         â”‚                                                   â”‚
â”‚         â–¼                                                   â”‚
â”‚  Beanå°±ç»ª                                                   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


---

## 4. å¸¸è§å®ç°ç±»

### 4.1 AutowiredAnnotationBeanPostProcessor

```java
/**
 * å¤„ç†@Autowiredã€@Valueã€@Injectæ³¨è§£
 */
public class AutowiredAnnotationBeanPostProcessor 
        implements SmartInstantiationAwareBeanPostProcessor, 
                   MergedBeanDefinitionPostProcessor {
    
    // ç¼“å­˜æ³¨å…¥å…ƒæ•°æ®
    private final Map<String, InjectionMetadata> injectionMetadataCache = 
        new ConcurrentHashMap<>(256);
    
    /**
     * æ”¶é›†@Autowiredæ³¨è§£ä¿¡æ¯
     */
    @Override
    public void postProcessMergedBeanDefinition(RootBeanDefinition beanDefinition,
            Class<?> beanType, String beanName) {
        // æŸ¥æ‰¾@Autowiredæ³¨è§£çš„å­—æ®µå’Œæ–¹æ³•
        InjectionMetadata metadata = findAutowiringMetadata(beanName, beanType, null);
        metadata.checkConfigMembers(beanDefinition);
    }
    
    /**
     * æ‰§è¡Œ@Autowiredæ³¨å…¥
     */
    @Override
    public PropertyValues postProcessProperties(PropertyValues pvs, Object bean, 
            String beanName) {
        // è·å–æ³¨å…¥å…ƒæ•°æ®
        InjectionMetadata metadata = findAutowiringMetadata(beanName, bean.getClass(), pvs);
        
        // ğŸ”¥ æ‰§è¡Œæ³¨å…¥
        metadata.inject(bean, beanName, pvs);
        
        return pvs;
    }
    
    /**
     * æŸ¥æ‰¾@Autowiredæ³¨è§£å…ƒæ•°æ®
     */
    private InjectionMetadata findAutowiringMetadata(String beanName, Class<?> clazz, 
            PropertyValues pvs) {
        String cacheKey = (StringUtils.hasLength(beanName) ? beanName : clazz.getName());
        
        // ä»ç¼“å­˜è·å–
        InjectionMetadata metadata = this.injectionMetadataCache.get(cacheKey);
        if (InjectionMetadata.needsRefresh(metadata, clazz)) {
            synchronized (this.injectionMetadataCache) {
                metadata = this.injectionMetadataCache.get(cacheKey);
                if (InjectionMetadata.needsRefresh(metadata, clazz)) {
                    // æ„å»ºæ³¨å…¥å…ƒæ•°æ®
                    metadata = buildAutowiringMetadata(clazz);
                    this.injectionMetadataCache.put(cacheKey, metadata);
                }
            }
        }
        return metadata;
    }
    
    /**
     * æ„å»ºæ³¨å…¥å…ƒæ•°æ®
     */
    private InjectionMetadata buildAutowiringMetadata(Class<?> clazz) {
        List<InjectionMetadata.InjectedElement> elements = new ArrayList<>();
        Class<?> targetClass = clazz;
        
        do {
            List<InjectionMetadata.InjectedElement> currElements = new ArrayList<>();
            
            // å¤„ç†å­—æ®µ
            ReflectionUtils.doWithLocalFields(targetClass, field -> {
                MergedAnnotation<?> ann = findAutowiredAnnotation(field);
                if (ann != null) {
                    if (Modifier.isStatic(field.getModifiers())) {
                        return;  // é™æ€å­—æ®µä¸æ”¯æŒ
                    }
                    boolean required = determineRequiredStatus(ann);
                    currElements.add(new AutowiredFieldElement(field, required));
                }
            });
            
            // å¤„ç†æ–¹æ³•
            ReflectionUtils.doWithLocalMethods(targetClass, method -> {
                Method bridgedMethod = BridgeMethodResolver.findBridgedMethod(method);
                if (!BridgeMethodResolver.isVisibilityBridgeMethodPair(method, bridgedMethod)) {
                    return;
                }
                MergedAnnotation<?> ann = findAutowiredAnnotation(bridgedMethod);
                if (ann != null && method.equals(ClassUtils.getMostSpecificMethod(method, clazz))) {
                    if (Modifier.isStatic(method.getModifiers())) {
                        return;
                    }
                    boolean required = determineRequiredStatus(ann);
                    PropertyDescriptor pd = BeanUtils.findPropertyForMethod(bridgedMethod, clazz);
                    currElements.add(new AutowiredMethodElement(method, required, pd));
                }
            });
            
            elements.addAll(0, currElements);
            targetClass = targetClass.getSuperclass();
        } while (targetClass != null && targetClass != Object.class);
        
        return InjectionMetadata.forElements(elements, clazz);
    }
}
```

### 4.2 CommonAnnotationBeanPostProcessor

```java
/**
 * å¤„ç†@Resourceã€@PostConstructã€@PreDestroyæ³¨è§£
 */
public class CommonAnnotationBeanPostProcessor 
        implements InstantiationAwareBeanPostProcessor, 
                   DestructionAwareBeanPostProcessor,
                   MergedBeanDefinitionPostProcessor {
    
    /**
     * æ”¶é›†@Resourceã€@PostConstructã€@PreDestroyæ³¨è§£ä¿¡æ¯
     */
    @Override
    public void postProcessMergedBeanDefinition(RootBeanDefinition beanDefinition,
            Class<?> beanType, String beanName) {
        // æŸ¥æ‰¾ç”Ÿå‘½å‘¨æœŸæ–¹æ³•
        LifecycleMetadata metadata = findLifecycleMetadata(beanType);
        metadata.checkConfigMembers(beanDefinition);
        
        // æŸ¥æ‰¾@Resourceæ³¨è§£
        InjectionMetadata resourceMetadata = findResourceMetadata(beanName, beanType, null);
        resourceMetadata.checkConfigMembers(beanDefinition);
    }
    
    /**
     * ğŸ”¥ æ‰§è¡Œ@PostConstructæ–¹æ³•
     */
    @Override
    public Object postProcessBeforeInitialization(Object bean, String beanName) {
        LifecycleMetadata metadata = findLifecycleMetadata(bean.getClass());
        
        // è°ƒç”¨@PostConstructæ–¹æ³•
        metadata.invokeInitMethods(bean, beanName);
        
        return bean;
    }
    
    /**
     * æ‰§è¡Œ@Resourceæ³¨å…¥
     */
    @Override
    public PropertyValues postProcessProperties(PropertyValues pvs, Object bean, 
            String beanName) {
        InjectionMetadata metadata = findResourceMetadata(beanName, bean.getClass(), pvs);
        metadata.inject(bean, beanName, pvs);
        return pvs;
    }
    
    /**
     * ğŸ”¥ æ‰§è¡Œ@PreDestroyæ–¹æ³•
     */
    @Override
    public void postProcessBeforeDestruction(Object bean, String beanName) {
        LifecycleMetadata metadata = findLifecycleMetadata(bean.getClass());
        metadata.invokeDestroyMethods(bean, beanName);
    }
}
```

### 4.3 ApplicationContextAwareProcessor

```java
/**
 * å¤„ç†å„ç§Awareæ¥å£
 */
class ApplicationContextAwareProcessor implements BeanPostProcessor {
    
    private final ConfigurableApplicationContext applicationContext;
    
    @Override
    public Object postProcessBeforeInitialization(Object bean, String beanName) {
        // å¤„ç†å„ç§Awareæ¥å£
        if (bean instanceof Aware) {
            if (bean instanceof EnvironmentAware) {
                ((EnvironmentAware) bean).setEnvironment(this.applicationContext.getEnvironment());
            }
            if (bean instanceof EmbeddedValueResolverAware) {
                ((EmbeddedValueResolverAware) bean).setEmbeddedValueResolver(
                    this.embeddedValueResolver);
            }
            if (bean instanceof ResourceLoaderAware) {
                ((ResourceLoaderAware) bean).setResourceLoader(this.applicationContext);
            }
            if (bean instanceof ApplicationEventPublisherAware) {
                ((ApplicationEventPublisherAware) bean).setApplicationEventPublisher(
                    this.applicationContext);
            }
            if (bean instanceof MessageSourceAware) {
                ((MessageSourceAware) bean).setMessageSource(this.applicationContext);
            }
            if (bean instanceof ApplicationContextAware) {
                ((ApplicationContextAware) bean).setApplicationContext(this.applicationContext);
            }
        }
        return bean;
    }
}
```

---

## 5. AOPä»£ç†åˆ›å»º

### 5.1 AbstractAutoProxyCreator

```java
/**
 * AOPè‡ªåŠ¨ä»£ç†åˆ›å»ºå™¨
 * åœ¨postProcessAfterInitializationä¸­åˆ›å»ºä»£ç†
 */
public abstract class AbstractAutoProxyCreator 
        implements SmartInstantiationAwareBeanPostProcessor {
    
    // æ—©æœŸä»£ç†å¼•ç”¨ç¼“å­˜
    private final Map<Object, Object> earlyProxyReferences = new ConcurrentHashMap<>(16);
    
    /**
     * ğŸ”¥ åˆå§‹åŒ–ååˆ›å»ºä»£ç†
     */
    @Override
    public Object postProcessAfterInitialization(@Nullable Object bean, String beanName) {
        if (bean != null) {
            Object cacheKey = getCacheKey(bean.getClass(), beanName);
            
            // æ£€æŸ¥æ˜¯å¦å·²ç»åœ¨getEarlyBeanReferenceä¸­åˆ›å»ºè¿‡ä»£ç†
            if (this.earlyProxyReferences.remove(cacheKey) != bean) {
                // ğŸ”¥ åŒ…è£…ä¸ºä»£ç†
                return wrapIfNecessary(bean, beanName, cacheKey);
            }
        }
        return bean;
    }
    
    /**
     * ğŸ”¥ è·å–æ—©æœŸBeanå¼•ç”¨ï¼ˆè§£å†³å¾ªç¯ä¾èµ–ï¼‰
     */
    @Override
    public Object getEarlyBeanReference(Object bean, String beanName) {
        Object cacheKey = getCacheKey(bean.getClass(), beanName);
        
        // è®°å½•æ—©æœŸä»£ç†å¼•ç”¨
        this.earlyProxyReferences.put(cacheKey, bean);
        
        // åˆ›å»ºä»£ç†
        return wrapIfNecessary(bean, beanName, cacheKey);
    }
    
    /**
     * åŒ…è£…ä¸ºä»£ç†ï¼ˆå¦‚æœéœ€è¦ï¼‰
     */
    protected Object wrapIfNecessary(Object bean, String beanName, Object cacheKey) {
        // æ£€æŸ¥æ˜¯å¦å·²ç»å¤„ç†è¿‡
        if (StringUtils.hasLength(beanName) && this.targetSourcedBeans.contains(beanName)) {
            return bean;
        }
        if (Boolean.FALSE.equals(this.advisedBeans.get(cacheKey))) {
            return bean;
        }
        // æ£€æŸ¥æ˜¯å¦æ˜¯åŸºç¡€è®¾æ–½ç±»
        if (isInfrastructureClass(bean.getClass()) || shouldSkip(bean.getClass(), beanName)) {
            this.advisedBeans.put(cacheKey, Boolean.FALSE);
            return bean;
        }
        
        // ğŸ”¥ è·å–é€‚ç”¨çš„Advisor
        Object[] specificInterceptors = getAdvicesAndAdvisorsForBean(
            bean.getClass(), beanName, null);
        
        if (specificInterceptors != DO_NOT_PROXY) {
            this.advisedBeans.put(cacheKey, Boolean.TRUE);
            
            // ğŸ”¥ åˆ›å»ºä»£ç†
            Object proxy = createProxy(
                bean.getClass(), beanName, specificInterceptors, new SingletonTargetSource(bean));
            
            this.proxyTypes.put(cacheKey, proxy.getClass());
            return proxy;
        }
        
        this.advisedBeans.put(cacheKey, Boolean.FALSE);
        return bean;
    }
    
    /**
     * åˆ›å»ºä»£ç†
     */
    protected Object createProxy(Class<?> beanClass, @Nullable String beanName,
            @Nullable Object[] specificInterceptors, TargetSource targetSource) {
        
        ProxyFactory proxyFactory = new ProxyFactory();
        proxyFactory.copyFrom(this);
        
        // å†³å®šä½¿ç”¨JDKä»£ç†è¿˜æ˜¯CGLIBä»£ç†
        if (!proxyFactory.isProxyTargetClass()) {
            if (shouldProxyTargetClass(beanClass, beanName)) {
                proxyFactory.setProxyTargetClass(true);
            } else {
                evaluateProxyInterfaces(beanClass, proxyFactory);
            }
        }
        
        // æ„å»ºAdvisoræ•°ç»„
        Advisor[] advisors = buildAdvisors(beanName, specificInterceptors);
        proxyFactory.addAdvisors(advisors);
        proxyFactory.setTargetSource(targetSource);
        customizeProxyFactory(proxyFactory);
        
        // ğŸ”¥ åˆ›å»ºä»£ç†å¯¹è±¡
        return proxyFactory.getProxy(getProxyClassLoader());
    }
}
```

### 5.2 AOPä»£ç†åˆ›å»ºæ—¶æœº

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              AOPä»£ç†åˆ›å»ºæ—¶æœº                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  æ­£å¸¸æƒ…å†µï¼ˆæ— å¾ªç¯ä¾èµ–ï¼‰ï¼š                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ postProcessAfterInitialization()        â”‚               â”‚
â”‚  â”‚     â”‚                                   â”‚               â”‚
â”‚  â”‚     â–¼                                   â”‚               â”‚
â”‚  â”‚ wrapIfNecessary()                       â”‚               â”‚
â”‚  â”‚     â”‚                                   â”‚               â”‚
â”‚  â”‚     â–¼                                   â”‚               â”‚
â”‚  â”‚ createProxy() â†’ è¿”å›ä»£ç†å¯¹è±¡            â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                             â”‚
â”‚  å¾ªç¯ä¾èµ–æƒ…å†µï¼š                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ getEarlyBeanReference()  â† ä¸‰çº§ç¼“å­˜è°ƒç”¨  â”‚               â”‚
â”‚  â”‚     â”‚                                   â”‚               â”‚
â”‚  â”‚     â–¼                                   â”‚               â”‚
â”‚  â”‚ wrapIfNecessary()                       â”‚               â”‚
â”‚  â”‚     â”‚                                   â”‚               â”‚
â”‚  â”‚     â–¼                                   â”‚               â”‚
â”‚  â”‚ createProxy() â†’ è¿”å›ä»£ç†å¯¹è±¡            â”‚               â”‚
â”‚  â”‚     â”‚                                   â”‚               â”‚
â”‚  â”‚     â–¼                                   â”‚               â”‚
â”‚  â”‚ è®°å½•åˆ°earlyProxyReferences              â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                             â”‚
â”‚  åç»­postProcessAfterInitialization()ï¼š                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ æ£€æŸ¥earlyProxyReferences                â”‚               â”‚
â”‚  â”‚     â”‚                                   â”‚               â”‚
â”‚  â”‚     â–¼                                   â”‚               â”‚
â”‚  â”‚ å·²åˆ›å»ºè¿‡ä»£ç†ï¼Œç›´æ¥è¿”å›åŸBean            â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


---

## 6. è‡ªå®šä¹‰æ‰©å±•å¼€å‘

### 6.1 è‡ªå®šä¹‰æ³¨è§£å¤„ç†å™¨

```java
/**
 * è‡ªå®šä¹‰@Logæ³¨è§£å¤„ç†å™¨
 * è‡ªåŠ¨ä¸ºæ ‡æ³¨@Logçš„æ–¹æ³•æ·»åŠ æ—¥å¿—
 */
@Component
public class LogAnnotationBeanPostProcessor implements BeanPostProcessor {
    
    @Override
    public Object postProcessAfterInitialization(Object bean, String beanName) {
        Class<?> targetClass = bean.getClass();
        
        // æ£€æŸ¥ç±»æˆ–æ–¹æ³•æ˜¯å¦æœ‰@Logæ³¨è§£
        boolean hasLogAnnotation = targetClass.isAnnotationPresent(Log.class);
        if (!hasLogAnnotation) {
            for (Method method : targetClass.getDeclaredMethods()) {
                if (method.isAnnotationPresent(Log.class)) {
                    hasLogAnnotation = true;
                    break;
                }
            }
        }
        
        if (hasLogAnnotation) {
            // åˆ›å»ºä»£ç†
            return createProxy(bean, targetClass);
        }
        
        return bean;
    }
    
    private Object createProxy(Object target, Class<?> targetClass) {
        return Proxy.newProxyInstance(
            targetClass.getClassLoader(),
            targetClass.getInterfaces(),
            (proxy, method, args) -> {
                Log logAnnotation = method.getAnnotation(Log.class);
                if (logAnnotation == null) {
                    logAnnotation = targetClass.getAnnotation(Log.class);
                }
                
                if (logAnnotation != null) {
                    System.out.println("[LOG] æ–¹æ³•å¼€å§‹: " + method.getName());
                    long start = System.currentTimeMillis();
                    try {
                        Object result = method.invoke(target, args);
                        System.out.println("[LOG] æ–¹æ³•ç»“æŸ: " + method.getName() + 
                            ", è€—æ—¶: " + (System.currentTimeMillis() - start) + "ms");
                        return result;
                    } catch (Exception e) {
                        System.out.println("[LOG] æ–¹æ³•å¼‚å¸¸: " + method.getName() + 
                            ", å¼‚å¸¸: " + e.getMessage());
                        throw e;
                    }
                }
                
                return method.invoke(target, args);
            }
        );
    }
}

@Target({ElementType.TYPE, ElementType.METHOD})
@Retention(RetentionPolicy.RUNTIME)
public @interface Log {
}
```

### 6.2 è‡ªå®šä¹‰å±æ€§æ³¨å…¥å¤„ç†å™¨

```java
/**
 * è‡ªå®šä¹‰@InjectConfigæ³¨è§£å¤„ç†å™¨
 * ä»é…ç½®ä¸­å¿ƒæ³¨å…¥é…ç½®å€¼
 */
@Component
public class ConfigInjectionBeanPostProcessor 
        implements InstantiationAwareBeanPostProcessor, MergedBeanDefinitionPostProcessor {
    
    @Autowired
    private ConfigCenter configCenter;
    
    private final Map<String, InjectionMetadata> injectionMetadataCache = 
        new ConcurrentHashMap<>();
    
    @Override
    public void postProcessMergedBeanDefinition(RootBeanDefinition beanDefinition,
            Class<?> beanType, String beanName) {
        // æ”¶é›†@InjectConfigæ³¨è§£ä¿¡æ¯
        InjectionMetadata metadata = buildInjectionMetadata(beanType);
        injectionMetadataCache.put(beanName, metadata);
    }
    
    @Override
    public PropertyValues postProcessProperties(PropertyValues pvs, Object bean, 
            String beanName) {
        InjectionMetadata metadata = injectionMetadataCache.get(beanName);
        if (metadata != null) {
            // æ‰§è¡Œæ³¨å…¥
            for (InjectedElement element : metadata.getInjectedElements()) {
                element.inject(bean);
            }
        }
        return pvs;
    }
    
    private InjectionMetadata buildInjectionMetadata(Class<?> clazz) {
        List<InjectedElement> elements = new ArrayList<>();
        
        for (Field field : clazz.getDeclaredFields()) {
            InjectConfig annotation = field.getAnnotation(InjectConfig.class);
            if (annotation != null) {
                elements.add(new ConfigInjectedElement(field, annotation.value()));
            }
        }
        
        return new InjectionMetadata(clazz, elements);
    }
    
    private class ConfigInjectedElement extends InjectedElement {
        private final Field field;
        private final String configKey;
        
        public ConfigInjectedElement(Field field, String configKey) {
            this.field = field;
            this.configKey = configKey;
        }
        
        @Override
        public void inject(Object target) {
            try {
                field.setAccessible(true);
                String value = configCenter.getConfig(configKey);
                Object convertedValue = convertValue(value, field.getType());
                field.set(target, convertedValue);
            } catch (Exception e) {
                throw new RuntimeException("Config injection failed", e);
            }
        }
        
        private Object convertValue(String value, Class<?> targetType) {
            if (targetType == String.class) {
                return value;
            } else if (targetType == Integer.class || targetType == int.class) {
                return Integer.parseInt(value);
            } else if (targetType == Long.class || targetType == long.class) {
                return Long.parseLong(value);
            } else if (targetType == Boolean.class || targetType == boolean.class) {
                return Boolean.parseBoolean(value);
            }
            return value;
        }
    }
}

@Target(ElementType.FIELD)
@Retention(RetentionPolicy.RUNTIME)
public @interface InjectConfig {
    String value();
}
```

### 6.3 BeanéªŒè¯å¤„ç†å™¨

```java
/**
 * BeanéªŒè¯å¤„ç†å™¨
 * åœ¨Beanåˆå§‹åŒ–åè¿›è¡ŒéªŒè¯
 */
@Component
public class BeanValidationPostProcessor implements BeanPostProcessor {
    
    private final Validator validator;
    
    public BeanValidationPostProcessor() {
        ValidatorFactory factory = Validation.buildDefaultValidatorFactory();
        this.validator = factory.getValidator();
    }
    
    @Override
    public Object postProcessAfterInitialization(Object bean, String beanName) {
        // éªŒè¯Bean
        Set<ConstraintViolation<Object>> violations = validator.validate(bean);
        
        if (!violations.isEmpty()) {
            StringBuilder sb = new StringBuilder();
            sb.append("Bean validation failed for '").append(beanName).append("': ");
            for (ConstraintViolation<Object> violation : violations) {
                sb.append(violation.getPropertyPath())
                  .append(" ")
                  .append(violation.getMessage())
                  .append("; ");
            }
            throw new BeanCreationException(sb.toString());
        }
        
        return bean;
    }
}
```

---

## 7. é¢è¯•è¦ç‚¹

### 7.1 é«˜é¢‘é¢è¯•é¢˜

#### Q1: BeanPostProcessorçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ

```
ç­”æ¡ˆè¦ç‚¹ï¼š
1. Beanç”Ÿå‘½å‘¨æœŸæ‰©å±•ç‚¹
2. åœ¨Beanåˆå§‹åŒ–å‰åè¿›è¡Œè‡ªå®šä¹‰å¤„ç†
3. å¯ä»¥ä¿®æ”¹Beanæˆ–è¿”å›ä»£ç†å¯¹è±¡

å…¸å‹åº”ç”¨ï¼š
- @Autowiredæ³¨å…¥ï¼šAutowiredAnnotationBeanPostProcessor
- @PostConstructï¼šCommonAnnotationBeanPostProcessor
- AOPä»£ç†ï¼šAbstractAutoProxyCreator
- @Asyncå¼‚æ­¥ï¼šAsyncAnnotationBeanPostProcessor
```

#### Q2: BeanPostProcessorçš„æ‰§è¡Œæ—¶æœºï¼Ÿ

```
æ‰§è¡Œé¡ºåºï¼š
1. å®ä¾‹åŒ–Bean
2. å±æ€§å¡«å……
3. Awareæ¥å£å›è°ƒ
4. ğŸ”¥ postProcessBeforeInitialization()
5. InitializingBean.afterPropertiesSet()
6. init-method
7. ğŸ”¥ postProcessAfterInitialization()

å…³é”®ç‚¹ï¼š
- Beforeåœ¨åˆå§‹åŒ–æ–¹æ³•ä¹‹å‰
- Afteråœ¨åˆå§‹åŒ–æ–¹æ³•ä¹‹å
- AOPä»£ç†é€šå¸¸åœ¨Afterä¸­åˆ›å»º
```

#### Q3: InstantiationAwareBeanPostProcessorå’ŒBeanPostProcessorçš„åŒºåˆ«ï¼Ÿ

```
BeanPostProcessorï¼š
- postProcessBeforeInitialization()
- postProcessAfterInitialization()
- åœ¨åˆå§‹åŒ–é˜¶æ®µæ‰§è¡Œ

InstantiationAwareBeanPostProcessorï¼š
- ç»§æ‰¿BeanPostProcessor
- æ–°å¢postProcessBeforeInstantiation()
- æ–°å¢postProcessAfterInstantiation()
- æ–°å¢postProcessProperties()
- åœ¨å®ä¾‹åŒ–å’Œå±æ€§å¡«å……é˜¶æ®µæ‰§è¡Œ

SmartInstantiationAwareBeanPostProcessorï¼š
- ç»§æ‰¿InstantiationAwareBeanPostProcessor
- æ–°å¢getEarlyBeanReference()
- ç”¨äºè§£å†³å¾ªç¯ä¾èµ–
```

#### Q4: AOPä»£ç†æ˜¯åœ¨å“ªä¸ªé˜¶æ®µåˆ›å»ºçš„ï¼Ÿ

```
æ­£å¸¸æƒ…å†µï¼š
- postProcessAfterInitialization()é˜¶æ®µ
- AbstractAutoProxyCreator.wrapIfNecessary()

å¾ªç¯ä¾èµ–æƒ…å†µï¼š
- getEarlyBeanReference()é˜¶æ®µ
- æå‰åˆ›å»ºä»£ç†æ”¾å…¥ä¸‰çº§ç¼“å­˜
- åç»­postProcessAfterInitialization()æ£€æµ‹åˆ°å·²åˆ›å»ºï¼Œè·³è¿‡

å…³é”®ç±»ï¼š
- AbstractAutoProxyCreator
- AnnotationAwareAspectJAutoProxyCreator
```

### 7.2 çŸ¥è¯†ç‚¹æ€»ç»“

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              BeanPostProcessoræºç æ€»ç»“                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  æ ¸å¿ƒæ¥å£ï¼š                                                  â”‚
â”‚  â”œâ”€â”€ BeanPostProcessor: åˆå§‹åŒ–å‰åå¤„ç†                      â”‚
â”‚  â”œâ”€â”€ InstantiationAwareBeanPostProcessor: å®ä¾‹åŒ–æ„ŸçŸ¥        â”‚
â”‚  â”œâ”€â”€ SmartInstantiationAwareBeanPostProcessor: æ™ºèƒ½å®ä¾‹åŒ–   â”‚
â”‚  â”œâ”€â”€ DestructionAwareBeanPostProcessor: é”€æ¯æ„ŸçŸ¥            â”‚
â”‚  â””â”€â”€ MergedBeanDefinitionPostProcessor: Beanå®šä¹‰å¤„ç†        â”‚
â”‚                                                             â”‚
â”‚  æ‰§è¡Œæ—¶æœºï¼š                                                  â”‚
â”‚  â”œâ”€â”€ postProcessBeforeInstantiation: å®ä¾‹åŒ–å‰               â”‚
â”‚  â”œâ”€â”€ postProcessMergedBeanDefinition: Beanå®šä¹‰åˆå¹¶å        â”‚
â”‚  â”œâ”€â”€ getEarlyBeanReference: ä¸‰çº§ç¼“å­˜è·å–                    â”‚
â”‚  â”œâ”€â”€ postProcessAfterInstantiation: å®ä¾‹åŒ–å                â”‚
â”‚  â”œâ”€â”€ postProcessProperties: å±æ€§å¡«å……å‰                      â”‚
â”‚  â”œâ”€â”€ postProcessBeforeInitialization: åˆå§‹åŒ–å‰              â”‚
â”‚  â”œâ”€â”€ postProcessAfterInitialization: åˆå§‹åŒ–å               â”‚
â”‚  â””â”€â”€ postProcessBeforeDestruction: é”€æ¯å‰                   â”‚
â”‚                                                             â”‚
â”‚  å¸¸è§å®ç°ï¼š                                                  â”‚
â”‚  â”œâ”€â”€ AutowiredAnnotationBeanPostProcessor: @Autowired       â”‚
â”‚  â”œâ”€â”€ CommonAnnotationBeanPostProcessor: @Resource/@PostConstruct
â”‚  â”œâ”€â”€ AbstractAutoProxyCreator: AOPä»£ç†                      â”‚
â”‚  â””â”€â”€ ApplicationContextAwareProcessor: Awareæ¥å£            â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [Springå®˜æ–¹æ–‡æ¡£ - BeanPostProcessor](https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#beans-factory-extension-bpp)
- [Springæºç  - BeanPostProcessor](https://github.com/spring-projects/spring-framework)

---

**æŒæ¡BeanPostProcessorï¼Œæ·±å…¥ç†è§£Springæ‰©å±•æœºåˆ¶ï¼** ğŸš€

*æœ€åæ›´æ–°ï¼š2025-12-28*
