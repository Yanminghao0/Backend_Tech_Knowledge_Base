# IoCå®¹å™¨æºç è§£æ

> ğŸ’¡ æ·±å…¥ç†è§£Spring IoCå®¹å™¨çš„æ ¸å¿ƒå®ç°åŸç†

---

## ğŸ“‹ ç›®å½•

- [1. IoCå®¹å™¨æ¦‚è¿°](#1-iocå®¹å™¨æ¦‚è¿°)
- [2. æ ¸å¿ƒæ¥å£ä½“ç³»](#2-æ ¸å¿ƒæ¥å£ä½“ç³»)
- [3. Beanå®šä¹‰åŠ è½½](#3-beanå®šä¹‰åŠ è½½)
- [4. Beanå®ä¾‹åŒ–æµç¨‹](#4-beanå®ä¾‹åŒ–æµç¨‹)
- [5. ä¾èµ–æ³¨å…¥å®ç°](#5-ä¾èµ–æ³¨å…¥å®ç°)
- [6. å¾ªç¯ä¾èµ–è§£å†³](#6-å¾ªç¯ä¾èµ–è§£å†³)
- [7. Beanç”Ÿå‘½å‘¨æœŸ](#7-beanç”Ÿå‘½å‘¨æœŸ)

---

## 1. IoCå®¹å™¨æ¦‚è¿°

### 1.1 ä»€ä¹ˆæ˜¯IoC

#### ğŸ¯ æ§åˆ¶åè½¬ï¼ˆInversion of Controlï¼‰
```
ä¼ ç»Ÿæ–¹å¼ï¼š
- å¯¹è±¡ä¸»åŠ¨åˆ›å»ºä¾èµ–å¯¹è±¡
- å¯¹è±¡æ§åˆ¶ä¾èµ–å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸ

IoCæ–¹å¼ï¼š
- å®¹å™¨è´Ÿè´£åˆ›å»ºå’Œç®¡ç†å¯¹è±¡
- å¯¹è±¡è¢«åŠ¨æ¥æ”¶ä¾èµ–æ³¨å…¥
- æ§åˆ¶æƒä»å¯¹è±¡è½¬ç§»åˆ°å®¹å™¨
```

#### ğŸ“Š å¯¹æ¯”ç¤ºä¾‹
```java
// ä¼ ç»Ÿæ–¹å¼ï¼šä¸»åŠ¨åˆ›å»ºä¾èµ–
public class UserService {
    private UserDao userDao = new UserDaoImpl(); // ä¸»åŠ¨åˆ›å»º
    
    public User getUser(Long id) {
        return userDao.findById(id);
    }
}

// IoCæ–¹å¼ï¼šè¢«åŠ¨æ¥æ”¶ä¾èµ–
public class UserService {
    private UserDao userDao; // ç”±å®¹å™¨æ³¨å…¥
    
    public void setUserDao(UserDao userDao) {
        this.userDao = userDao;
    }
    
    public User getUser(Long id) {
        return userDao.findById(id);
    }
}
```

### 1.2 IoCå®¹å™¨çš„ä½œç”¨

```
1. Beançš„åˆ›å»ºå’Œç®¡ç†
   - æ ¹æ®é…ç½®åˆ›å»ºBeanå®ä¾‹
   - ç®¡ç†Beançš„ç”Ÿå‘½å‘¨æœŸ
   - ç»´æŠ¤Beanä¹‹é—´çš„ä¾èµ–å…³ç³»

2. ä¾èµ–æ³¨å…¥ï¼ˆDIï¼‰
   - æ„é€ å™¨æ³¨å…¥
   - Setteræ³¨å…¥
   - å­—æ®µæ³¨å…¥

3. é…ç½®ç®¡ç†
   - XMLé…ç½®
   - æ³¨è§£é…ç½®
   - Javaé…ç½®
```

---

## 2. æ ¸å¿ƒæ¥å£ä½“ç³»

### 2.1 BeanFactoryæ¥å£ä½“ç³»

#### ğŸ“Š æ¥å£ç»§æ‰¿å…³ç³»
```
BeanFactoryï¼ˆæ ¹æ¥å£ï¼‰
â”œâ”€â”€ HierarchicalBeanFactoryï¼ˆå±‚çº§å®¹å™¨ï¼‰
â”‚   â””â”€â”€ ConfigurableBeanFactoryï¼ˆå¯é…ç½®ï¼‰
â”‚       â””â”€â”€ ConfigurableListableBeanFactory
â”œâ”€â”€ ListableBeanFactoryï¼ˆå¯åˆ—ä¸¾ï¼‰
â”‚   â””â”€â”€ ConfigurableListableBeanFactory
â””â”€â”€ AutowireCapableBeanFactoryï¼ˆè‡ªåŠ¨è£…é…ï¼‰
    â””â”€â”€ ConfigurableListableBeanFactory
    
DefaultListableBeanFactoryï¼ˆé»˜è®¤å®ç°ï¼‰
â””â”€â”€ å®ç°äº†ConfigurableListableBeanFactory
```

#### ğŸ” æ ¸å¿ƒæ¥å£è¯´æ˜
```java
// BeanFactoryï¼šæœ€åŸºç¡€çš„å®¹å™¨æ¥å£
public interface BeanFactory {
    Object getBean(String name);
    <T> T getBean(Class<T> requiredType);
    boolean containsBean(String name);
    boolean isSingleton(String name);
    boolean isPrototype(String name);
}

// ListableBeanFactoryï¼šå¯åˆ—ä¸¾æ‰€æœ‰Bean
public interface ListableBeanFactory extends BeanFactory {
    String[] getBeanDefinitionNames();
    <T> Map<String, T> getBeansOfType(Class<T> type);
    String[] getBeanNamesForType(Class<?> type);
}

// ConfigurableBeanFactoryï¼šå¯é…ç½®çš„å®¹å™¨
public interface ConfigurableBeanFactory extends HierarchicalBeanFactory {
    void setParentBeanFactory(BeanFactory parentBeanFactory);
    void addBeanPostProcessor(BeanPostProcessor beanPostProcessor);
    void destroySingletons();
}
```

### 2.2 ApplicationContextæ¥å£ä½“ç³»

#### ğŸ“Š æ¥å£ç»§æ‰¿å…³ç³»
```
ApplicationContext
â”œâ”€â”€ ConfigurableApplicationContext
â”‚   â”œâ”€â”€ AbstractApplicationContext
â”‚   â”‚   â”œâ”€â”€ AbstractRefreshableApplicationContext
â”‚   â”‚   â”‚   â””â”€â”€ ClassPathXmlApplicationContext
â”‚   â”‚   â””â”€â”€ GenericApplicationContext
â”‚   â”‚       â””â”€â”€ AnnotationConfigApplicationContext
â”‚   â””â”€â”€ WebApplicationContext
```

#### ğŸ” ApplicationContext vs BeanFactory
```
BeanFactoryï¼š
- å»¶è¿ŸåŠ è½½Bean
- åŸºç¡€çš„IoCåŠŸèƒ½
- èµ„æºæ¶ˆè€—å°‘

ApplicationContextï¼š
- é¢„åŠ è½½å•ä¾‹Bean
- æ”¯æŒå›½é™…åŒ–
- æ”¯æŒäº‹ä»¶å‘å¸ƒ
- æ”¯æŒAOP
- æ›´ä¸°å¯Œçš„åŠŸèƒ½
```

### 2.3 BeanDefinition

#### ğŸ“Š Beanå®šä¹‰ä¿¡æ¯
```java
public interface BeanDefinition {
    // Beanç±»å
    String getBeanClassName();
    
    // ä½œç”¨åŸŸ
    String getScope();
    
    // æ˜¯å¦æ‡’åŠ è½½
    boolean isLazyInit();
    
    // ä¾èµ–çš„Bean
    String[] getDependsOn();
    
    // æ˜¯å¦è‡ªåŠ¨è£…é…å€™é€‰
    boolean isAutowireCandidate();
    
    // æ˜¯å¦ä¸»è¦å€™é€‰
    boolean isPrimary();
    
    // åˆå§‹åŒ–æ–¹æ³•
    String getInitMethodName();
    
    // é”€æ¯æ–¹æ³•
    String getDestroyMethodName();
    
    // æ„é€ å‚æ•°
    ConstructorArgumentValues getConstructorArgumentValues();
    
    // å±æ€§å€¼
    MutablePropertyValues getPropertyValues();
}
```

---

## 3. Beanå®šä¹‰åŠ è½½

### 3.1 XMLé…ç½®åŠ è½½

#### ğŸ”„ åŠ è½½æµç¨‹
```java
// å…¥å£
ClassPathXmlApplicationContext context = 
    new ClassPathXmlApplicationContext("spring.xml");

// è°ƒç”¨é“¾
ClassPathXmlApplicationContext
  â†’ AbstractApplicationContext.refresh()
    â†’ obtainFreshBeanFactory()
      â†’ refreshBeanFactory()
        â†’ loadBeanDefinitions(beanFactory)
          â†’ XmlBeanDefinitionReader.loadBeanDefinitions()
            â†’ doLoadBeanDefinitions()
              â†’ registerBeanDefinitions()
```

#### ğŸ“ æ ¸å¿ƒä»£ç 
```java
// AbstractXmlApplicationContext
@Override
protected void loadBeanDefinitions(DefaultListableBeanFactory beanFactory) {
    // åˆ›å»ºXMLè¯»å–å™¨
    XmlBeanDefinitionReader beanDefinitionReader = 
        new XmlBeanDefinitionReader(beanFactory);
    
    // é…ç½®è¯»å–å™¨
    beanDefinitionReader.setEnvironment(this.getEnvironment());
    beanDefinitionReader.setResourceLoader(this);
    beanDefinitionReader.setEntityResolver(new ResourceEntityResolver(this));
    
    // åŠ è½½Beanå®šä¹‰
    loadBeanDefinitions(beanDefinitionReader);
}

// XmlBeanDefinitionReader
protected int doLoadBeanDefinitions(InputSource inputSource, Resource resource) {
    // è§£æXMLæ–‡æ¡£
    Document doc = doLoadDocument(inputSource, resource);
    
    // æ³¨å†ŒBeanå®šä¹‰
    int count = registerBeanDefinitions(doc, resource);
    return count;
}
```

### 3.2 æ³¨è§£é…ç½®åŠ è½½

#### ğŸ”„ åŠ è½½æµç¨‹
```java
// å…¥å£
AnnotationConfigApplicationContext context = 
    new AnnotationConfigApplicationContext(AppConfig.class);

// è°ƒç”¨é“¾
AnnotationConfigApplicationContext
  â†’ register(componentClasses)
    â†’ AnnotatedBeanDefinitionReader.register()
      â†’ doRegisterBean()
  â†’ refresh()
    â†’ invokeBeanFactoryPostProcessors()
      â†’ ConfigurationClassPostProcessor.postProcessBeanDefinitionRegistry()
        â†’ processConfigBeanDefinitions()
          â†’ ConfigurationClassParser.parse()
            â†’ è§£æ@ComponentScanã€@Importã€@Beanç­‰
```

#### ğŸ“ æ ¸å¿ƒä»£ç 
```java
// AnnotatedBeanDefinitionReader
private <T> void doRegisterBean(Class<T> beanClass, ...) {
    // åˆ›å»ºBeanå®šä¹‰
    AnnotatedGenericBeanDefinition abd = 
        new AnnotatedGenericBeanDefinition(beanClass);
    
    // è§£ææ¡ä»¶æ³¨è§£
    if (this.conditionEvaluator.shouldSkip(abd.getMetadata())) {
        return;
    }
    
    // è§£æä½œç”¨åŸŸ
    ScopeMetadata scopeMetadata = 
        this.scopeMetadataResolver.resolveScopeMetadata(abd);
    abd.setScope(scopeMetadata.getScopeName());
    
    // ç”ŸæˆBeanåç§°
    String beanName = (name != null ? name : 
        this.beanNameGenerator.generateBeanName(abd, this.registry));
    
    // å¤„ç†é€šç”¨æ³¨è§£
    AnnotationConfigUtils.processCommonDefinitionAnnotations(abd);
    
    // æ³¨å†ŒBeanå®šä¹‰
    BeanDefinitionHolder definitionHolder = 
        new BeanDefinitionHolder(abd, beanName);
    BeanDefinitionReaderUtils.registerBeanDefinition(
        definitionHolder, this.registry);
}
```

---

## 4. Beanå®ä¾‹åŒ–æµç¨‹

### 4.1 getBeanæµç¨‹

#### ğŸ”„ å®Œæ•´æµç¨‹å›¾
```mermaid
graph TD
    A[getBean] --> B[doGetBean]
    B --> C{ç¼“å­˜ä¸­æ˜¯å¦å­˜åœ¨?}
    C -->|æ˜¯| D[è¿”å›ç¼“å­˜Bean]
    C -->|å¦| E{æ˜¯å¦æ­£åœ¨åˆ›å»º?}
    E -->|æ˜¯| F[å¤„ç†å¾ªç¯ä¾èµ–]
    E -->|å¦| G[è·å–BeanDefinition]
    G --> H{æ˜¯å¦æœ‰ä¾èµ–?}
    H -->|æ˜¯| I[å…ˆåˆ›å»ºä¾èµ–Bean]
    H -->|å¦| J[createBean]
    I --> J
    J --> K[doCreateBean]
    K --> L[createBeanInstance]
    L --> M[populateBean]
    M --> N[initializeBean]
    N --> O[è¿”å›Bean]
```

#### ğŸ“ æ ¸å¿ƒä»£ç 
```java
// AbstractBeanFactory.doGetBean()
protected <T> T doGetBean(String name, Class<T> requiredType, 
        Object[] args, boolean typeCheckOnly) {
    
    String beanName = transformedBeanName(name);
    Object bean;
    
    // 1. ä»ç¼“å­˜è·å–å•ä¾‹Bean
    Object sharedInstance = getSingleton(beanName);
    if (sharedInstance != null && args == null) {
        bean = getObjectForBeanInstance(sharedInstance, name, beanName, null);
    } else {
        // 2. æ£€æŸ¥æ˜¯å¦æ­£åœ¨åˆ›å»ºï¼ˆå¾ªç¯ä¾èµ–æ£€æµ‹ï¼‰
        if (isPrototypeCurrentlyInCreation(beanName)) {
            throw new BeanCurrentlyInCreationException(beanName);
        }
        
        // 3. è·å–BeanDefinition
        RootBeanDefinition mbd = getMergedLocalBeanDefinition(beanName);
        
        // 4. å¤„ç†ä¾èµ–
        String[] dependsOn = mbd.getDependsOn();
        if (dependsOn != null) {
            for (String dep : dependsOn) {
                registerDependentBean(dep, beanName);
                getBean(dep); // é€’å½’åˆ›å»ºä¾èµ–
            }
        }
        
        // 5. åˆ›å»ºBean
        if (mbd.isSingleton()) {
            sharedInstance = getSingleton(beanName, () -> {
                return createBean(beanName, mbd, args);
            });
            bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);
        } else if (mbd.isPrototype()) {
            Object prototypeInstance = createBean(beanName, mbd, args);
            bean = getObjectForBeanInstance(prototypeInstance, name, beanName, mbd);
        }
    }
    
    return (T) bean;
}
```

### 4.2 createBeanæµç¨‹

#### ğŸ“ æ ¸å¿ƒä»£ç 
```java
// AbstractAutowireCapableBeanFactory.createBean()
@Override
protected Object createBean(String beanName, RootBeanDefinition mbd, Object[] args) {
    
    RootBeanDefinition mbdToUse = mbd;
    
    // 1. è§£æBeanç±»å‹
    Class<?> resolvedClass = resolveBeanClass(mbd, beanName);
    
    // 2. å‡†å¤‡æ–¹æ³•è¦†ç›–
    mbdToUse.prepareMethodOverrides();
    
    // 3. ç»™BeanPostProcessorä¸€ä¸ªè¿”å›ä»£ç†çš„æœºä¼š
    Object bean = resolveBeforeInstantiation(beanName, mbdToUse);
    if (bean != null) {
        return bean;
    }
    
    // 4. å®é™…åˆ›å»ºBean
    Object beanInstance = doCreateBean(beanName, mbdToUse, args);
    return beanInstance;
}

// doCreateBean
protected Object doCreateBean(String beanName, RootBeanDefinition mbd, Object[] args) {
    
    BeanWrapper instanceWrapper = null;
    
    // 1. åˆ›å»ºBeanå®ä¾‹
    if (mbd.isSingleton()) {
        instanceWrapper = this.factoryBeanInstanceCache.remove(beanName);
    }
    if (instanceWrapper == null) {
        instanceWrapper = createBeanInstance(beanName, mbd, args);
    }
    
    Object bean = instanceWrapper.getWrappedInstance();
    Class<?> beanType = instanceWrapper.getWrappedClass();
    
    // 2. å…è®¸ä¿®æ”¹BeanDefinition
    synchronized (mbd.postProcessingLock) {
        if (!mbd.postProcessed) {
            applyMergedBeanDefinitionPostProcessors(mbd, beanType, beanName);
            mbd.postProcessed = true;
        }
    }
    
    // 3. æå‰æš´éœ²Beanï¼ˆè§£å†³å¾ªç¯ä¾èµ–ï¼‰
    boolean earlySingletonExposure = (mbd.isSingleton() && 
        this.allowCircularReferences && isSingletonCurrentlyInCreation(beanName));
    if (earlySingletonExposure) {
        addSingletonFactory(beanName, () -> getEarlyBeanReference(beanName, mbd, bean));
    }
    
    Object exposedObject = bean;
    
    // 4. å¡«å……å±æ€§
    populateBean(beanName, mbd, instanceWrapper);
    
    // 5. åˆå§‹åŒ–Bean
    exposedObject = initializeBean(beanName, exposedObject, mbd);
    
    // 6. æ³¨å†Œé”€æ¯å›è°ƒ
    registerDisposableBeanIfNecessary(beanName, bean, mbd);
    
    return exposedObject;
}
```

---

## 5. ä¾èµ–æ³¨å…¥å®ç°

### 5.1 å±æ€§å¡«å……ï¼ˆpopulateBeanï¼‰

#### ğŸ“ æ ¸å¿ƒä»£ç 
```java
protected void populateBean(String beanName, RootBeanDefinition mbd, BeanWrapper bw) {
    
    // 1. ç»™InstantiationAwareBeanPostProcessoræœºä¼š
    if (!mbd.isSynthetic() && hasInstantiationAwareBeanPostProcessors()) {
        for (BeanPostProcessor bp : getBeanPostProcessors()) {
            if (bp instanceof InstantiationAwareBeanPostProcessor) {
                InstantiationAwareBeanPostProcessor ibp = 
                    (InstantiationAwareBeanPostProcessor) bp;
                if (!ibp.postProcessAfterInstantiation(bw.getWrappedInstance(), beanName)) {
                    return;
                }
            }
        }
    }
    
    PropertyValues pvs = mbd.getPropertyValues();
    
    // 2. è‡ªåŠ¨è£…é…
    int resolvedAutowireMode = mbd.getResolvedAutowireMode();
    if (resolvedAutowireMode == AUTOWIRE_BY_NAME || 
        resolvedAutowireMode == AUTOWIRE_BY_TYPE) {
        MutablePropertyValues newPvs = new MutablePropertyValues(pvs);
        if (resolvedAutowireMode == AUTOWIRE_BY_NAME) {
            autowireByName(beanName, mbd, bw, newPvs);
        }
        if (resolvedAutowireMode == AUTOWIRE_BY_TYPE) {
            autowireByType(beanName, mbd, bw, newPvs);
        }
        pvs = newPvs;
    }
    
    // 3. å¤„ç†@Autowiredã€@Valueç­‰æ³¨è§£
    for (BeanPostProcessor bp : getBeanPostProcessors()) {
        if (bp instanceof InstantiationAwareBeanPostProcessor) {
            InstantiationAwareBeanPostProcessor ibp = 
                (InstantiationAwareBeanPostProcessor) bp;
            PropertyValues pvsToUse = ibp.postProcessProperties(pvs, 
                bw.getWrappedInstance(), beanName);
            pvs = pvsToUse;
        }
    }
    
    // 4. åº”ç”¨å±æ€§å€¼
    if (pvs != null) {
        applyPropertyValues(beanName, mbd, bw, pvs);
    }
}
```

### 5.2 @Autowiredæ³¨å…¥åŸç†

#### ğŸ“ AutowiredAnnotationBeanPostProcessor
```java
// AutowiredAnnotationBeanPostProcessor.postProcessProperties()
@Override
public PropertyValues postProcessProperties(PropertyValues pvs, 
        Object bean, String beanName) {
    
    // 1. è·å–æ³¨å…¥å…ƒæ•°æ®
    InjectionMetadata metadata = findAutowiringMetadata(beanName, 
        bean.getClass(), pvs);
    
    // 2. æ‰§è¡Œæ³¨å…¥
    metadata.inject(bean, beanName, pvs);
    
    return pvs;
}

// InjectionMetadata.inject()
public void inject(Object target, String beanName, PropertyValues pvs) {
    Collection<InjectedElement> checkedElements = this.checkedElements;
    for (InjectedElement element : checkedElements) {
        element.inject(target, beanName, pvs);
    }
}

// AutowiredFieldElement.inject()
@Override
protected void inject(Object bean, String beanName, PropertyValues pvs) {
    Field field = (Field) this.member;
    Object value;
    
    // è§£æä¾èµ–
    DependencyDescriptor desc = new DependencyDescriptor(field, this.required);
    value = beanFactory.resolveDependency(desc, beanName, autowiredBeanNames, typeConverter);
    
    // åå°„æ³¨å…¥
    if (value != null) {
        ReflectionUtils.makeAccessible(field);
        field.set(bean, value);
    }
}
```

---

## 6. å¾ªç¯ä¾èµ–è§£å†³

### 6.1 ä¸‰çº§ç¼“å­˜

#### ğŸ“Š ç¼“å­˜ç»“æ„
```java
// DefaultSingletonBeanRegistry

// ä¸€çº§ç¼“å­˜ï¼šå­˜æ”¾å®Œæ•´çš„Bean
private final Map<String, Object> singletonObjects = new ConcurrentHashMap<>(256);

// äºŒçº§ç¼“å­˜ï¼šå­˜æ”¾æ—©æœŸæš´éœ²çš„Beanï¼ˆæœªå®Œæˆå±æ€§å¡«å……ï¼‰
private final Map<String, Object> earlySingletonObjects = new ConcurrentHashMap<>(16);

// ä¸‰çº§ç¼“å­˜ï¼šå­˜æ”¾Beanå·¥å‚ï¼ˆç”¨äºåˆ›å»ºä»£ç†ï¼‰
private final Map<String, ObjectFactory<?>> singletonFactories = new HashMap<>(16);
```

### 6.2 è§£å†³æµç¨‹

#### ğŸ”„ æµç¨‹å›¾
```
Aä¾èµ–Bï¼ŒBä¾èµ–Açš„è§£å†³æµç¨‹ï¼š

1. åˆ›å»ºA
   - createBeanInstance(A) â†’ Aå®ä¾‹åŒ–
   - addSingletonFactory(A) â†’ Aæ”¾å…¥ä¸‰çº§ç¼“å­˜
   - populateBean(A) â†’ å¡«å……å±æ€§ï¼Œå‘ç°ä¾èµ–B

2. åˆ›å»ºB
   - createBeanInstance(B) â†’ Bå®ä¾‹åŒ–
   - addSingletonFactory(B) â†’ Bæ”¾å…¥ä¸‰çº§ç¼“å­˜
   - populateBean(B) â†’ å¡«å……å±æ€§ï¼Œå‘ç°ä¾èµ–A
   - getSingleton(A) â†’ ä»ä¸‰çº§ç¼“å­˜è·å–A
     - æ‰§è¡ŒObjectFactory.getObject()
     - Aç§»åˆ°äºŒçº§ç¼“å­˜
   - Bå®Œæˆå±æ€§å¡«å……
   - initializeBean(B) â†’ Båˆå§‹åŒ–å®Œæˆ
   - Bæ”¾å…¥ä¸€çº§ç¼“å­˜

3. ç»§ç»­åˆ›å»ºA
   - getSingleton(B) â†’ ä»ä¸€çº§ç¼“å­˜è·å–B
   - Aå®Œæˆå±æ€§å¡«å……
   - initializeBean(A) â†’ Aåˆå§‹åŒ–å®Œæˆ
   - Aæ”¾å…¥ä¸€çº§ç¼“å­˜
```

#### ğŸ“ æ ¸å¿ƒä»£ç 
```java
// DefaultSingletonBeanRegistry.getSingleton()
protected Object getSingleton(String beanName, boolean allowEarlyReference) {
    // 1. ä»ä¸€çº§ç¼“å­˜è·å–
    Object singletonObject = this.singletonObjects.get(beanName);
    
    if (singletonObject == null && isSingletonCurrentlyInCreation(beanName)) {
        // 2. ä»äºŒçº§ç¼“å­˜è·å–
        singletonObject = this.earlySingletonObjects.get(beanName);
        
        if (singletonObject == null && allowEarlyReference) {
            synchronized (this.singletonObjects) {
                // åŒé‡æ£€æŸ¥
                singletonObject = this.singletonObjects.get(beanName);
                if (singletonObject == null) {
                    singletonObject = this.earlySingletonObjects.get(beanName);
                    if (singletonObject == null) {
                        // 3. ä»ä¸‰çº§ç¼“å­˜è·å–
                        ObjectFactory<?> singletonFactory = 
                            this.singletonFactories.get(beanName);
                        if (singletonFactory != null) {
                            // æ‰§è¡Œå·¥å‚æ–¹æ³•
                            singletonObject = singletonFactory.getObject();
                            // ç§»åˆ°äºŒçº§ç¼“å­˜
                            this.earlySingletonObjects.put(beanName, singletonObject);
                            this.singletonFactories.remove(beanName);
                        }
                    }
                }
            }
        }
    }
    return singletonObject;
}

// æ·»åŠ åˆ°ä¸‰çº§ç¼“å­˜
protected void addSingletonFactory(String beanName, ObjectFactory<?> singletonFactory) {
    synchronized (this.singletonObjects) {
        if (!this.singletonObjects.containsKey(beanName)) {
            this.singletonFactories.put(beanName, singletonFactory);
            this.earlySingletonObjects.remove(beanName);
            this.registeredSingletons.add(beanName);
        }
    }
}
```

### 6.3 ä¸ºä»€ä¹ˆéœ€è¦ä¸‰çº§ç¼“å­˜

#### ğŸ¤” é—®é¢˜åˆ†æ
```
Q: ä¸ºä»€ä¹ˆä¸èƒ½åªç”¨äºŒçº§ç¼“å­˜ï¼Ÿ

A: å› ä¸ºéœ€è¦æ”¯æŒAOPä»£ç†

å¦‚æœåªç”¨äºŒçº§ç¼“å­˜ï¼š
- æ—©æœŸæš´éœ²çš„æ˜¯åŸå§‹å¯¹è±¡
- ä½†æœ€ç»ˆéœ€è¦çš„å¯èƒ½æ˜¯ä»£ç†å¯¹è±¡
- ä¼šå¯¼è‡´æ³¨å…¥çš„å¯¹è±¡ä¸ä¸€è‡´

ä¸‰çº§ç¼“å­˜çš„ä½œç”¨ï¼š
- ObjectFactoryå¯ä»¥åœ¨éœ€è¦æ—¶åˆ›å»ºä»£ç†
- ä¿è¯æ³¨å…¥çš„æ˜¯æœ€ç»ˆçš„ä»£ç†å¯¹è±¡
- å»¶è¿Ÿä»£ç†åˆ›å»ºï¼Œæé«˜æ€§èƒ½
```

#### ğŸ“ ä»£ç†åˆ›å»ºä»£ç 
```java
// AbstractAutowireCapableBeanFactory.getEarlyBeanReference()
protected Object getEarlyBeanReference(String beanName, RootBeanDefinition mbd, Object bean) {
    Object exposedObject = bean;
    if (!mbd.isSynthetic() && hasInstantiationAwareBeanPostProcessors()) {
        for (BeanPostProcessor bp : getBeanPostProcessors()) {
            if (bp instanceof SmartInstantiationAwareBeanPostProcessor) {
                SmartInstantiationAwareBeanPostProcessor ibp = 
                    (SmartInstantiationAwareBeanPostProcessor) bp;
                // è¿™é‡Œå¯èƒ½åˆ›å»ºä»£ç†
                exposedObject = ibp.getEarlyBeanReference(exposedObject, beanName);
            }
        }
    }
    return exposedObject;
}
```

---

## 7. Beanç”Ÿå‘½å‘¨æœŸ

### 7.1 å®Œæ•´ç”Ÿå‘½å‘¨æœŸ

#### ğŸ“Š ç”Ÿå‘½å‘¨æœŸå›¾
```
1. å®ä¾‹åŒ–ï¼ˆInstantiationï¼‰
   â””â”€â”€ createBeanInstance()

2. å±æ€§å¡«å……ï¼ˆPopulate Propertiesï¼‰
   â””â”€â”€ populateBean()

3. Awareæ¥å£å›è°ƒ
   â”œâ”€â”€ BeanNameAware.setBeanName()
   â”œâ”€â”€ BeanClassLoaderAware.setBeanClassLoader()
   â””â”€â”€ BeanFactoryAware.setBeanFactory()

4. BeanPostProcessorå‰ç½®å¤„ç†
   â””â”€â”€ postProcessBeforeInitialization()

5. åˆå§‹åŒ–
   â”œâ”€â”€ InitializingBean.afterPropertiesSet()
   â””â”€â”€ è‡ªå®šä¹‰init-method

6. BeanPostProcessoråç½®å¤„ç†
   â””â”€â”€ postProcessAfterInitialization()

7. ä½¿ç”¨Bean

8. é”€æ¯
   â”œâ”€â”€ DisposableBean.destroy()
   â””â”€â”€ è‡ªå®šä¹‰destroy-method
```

#### ğŸ“ initializeBeanä»£ç 
```java
protected Object initializeBean(String beanName, Object bean, RootBeanDefinition mbd) {
    
    // 1. Awareæ¥å£å›è°ƒ
    invokeAwareMethods(beanName, bean);
    
    Object wrappedBean = bean;
    
    // 2. BeanPostProcessorå‰ç½®å¤„ç†
    if (mbd == null || !mbd.isSynthetic()) {
        wrappedBean = applyBeanPostProcessorsBeforeInitialization(wrappedBean, beanName);
    }
    
    // 3. åˆå§‹åŒ–æ–¹æ³•
    invokeInitMethods(beanName, wrappedBean, mbd);
    
    // 4. BeanPostProcessoråç½®å¤„ç†
    if (mbd == null || !mbd.isSynthetic()) {
        wrappedBean = applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName);
    }
    
    return wrappedBean;
}

private void invokeAwareMethods(String beanName, Object bean) {
    if (bean instanceof Aware) {
        if (bean instanceof BeanNameAware) {
            ((BeanNameAware) bean).setBeanName(beanName);
        }
        if (bean instanceof BeanClassLoaderAware) {
            ((BeanClassLoaderAware) bean).setBeanClassLoader(getBeanClassLoader());
        }
        if (bean instanceof BeanFactoryAware) {
            ((BeanFactoryAware) bean).setBeanFactory(this);
        }
    }
}
```

### 7.2 ç”Ÿå‘½å‘¨æœŸç¤ºä¾‹

```java
@Component
public class LifecycleBean implements BeanNameAware, BeanFactoryAware, 
        InitializingBean, DisposableBean {
    
    private String beanName;
    private BeanFactory beanFactory;
    
    public LifecycleBean() {
        System.out.println("1. æ„é€ æ–¹æ³•");
    }
    
    @Autowired
    public void setDependency(SomeDependency dependency) {
        System.out.println("2. å±æ€§æ³¨å…¥");
    }
    
    @Override
    public void setBeanName(String name) {
        System.out.println("3. BeanNameAware.setBeanName()");
        this.beanName = name;
    }
    
    @Override
    public void setBeanFactory(BeanFactory beanFactory) {
        System.out.println("4. BeanFactoryAware.setBeanFactory()");
        this.beanFactory = beanFactory;
    }
    
    @PostConstruct
    public void postConstruct() {
        System.out.println("5. @PostConstruct");
    }
    
    @Override
    public void afterPropertiesSet() {
        System.out.println("6. InitializingBean.afterPropertiesSet()");
    }
    
    public void customInit() {
        System.out.println("7. è‡ªå®šä¹‰init-method");
    }
    
    @PreDestroy
    public void preDestroy() {
        System.out.println("8. @PreDestroy");
    }
    
    @Override
    public void destroy() {
        System.out.println("9. DisposableBean.destroy()");
    }
    
    public void customDestroy() {
        System.out.println("10. è‡ªå®šä¹‰destroy-method");
    }
}
```

---

## ğŸ“š é¢è¯•è¦ç‚¹

### é«˜é¢‘é—®é¢˜

**Q1: Spring Beançš„ç”Ÿå‘½å‘¨æœŸï¼Ÿ**
```
1. å®ä¾‹åŒ–ï¼šé€šè¿‡åå°„åˆ›å»ºBeanå®ä¾‹
2. å±æ€§å¡«å……ï¼šæ³¨å…¥ä¾èµ–
3. Awareå›è°ƒï¼šè®¾ç½®BeanNameã€BeanFactoryç­‰
4. BeanPostProcessorå‰ç½®å¤„ç†
5. åˆå§‹åŒ–ï¼š@PostConstructã€afterPropertiesSetã€init-method
6. BeanPostProcessoråç½®å¤„ç†ï¼ˆAOPä»£ç†åœ¨è¿™é‡Œåˆ›å»ºï¼‰
7. ä½¿ç”¨
8. é”€æ¯ï¼š@PreDestroyã€destroyã€destroy-method
```

**Q2: Springå¦‚ä½•è§£å†³å¾ªç¯ä¾èµ–ï¼Ÿ**
```
é€šè¿‡ä¸‰çº§ç¼“å­˜ï¼š
- ä¸€çº§ç¼“å­˜ï¼šå®Œæ•´Bean
- äºŒçº§ç¼“å­˜ï¼šæ—©æœŸæš´éœ²çš„Bean
- ä¸‰çº§ç¼“å­˜ï¼šBeanå·¥å‚

æµç¨‹ï¼š
1. Aå®ä¾‹åŒ–åæ”¾å…¥ä¸‰çº§ç¼“å­˜
2. Aå¡«å……å±æ€§éœ€è¦B
3. Bå®ä¾‹åŒ–åæ”¾å…¥ä¸‰çº§ç¼“å­˜
4. Bå¡«å……å±æ€§éœ€è¦Aï¼Œä»ä¸‰çº§ç¼“å­˜è·å–A
5. Bå®Œæˆåˆ›å»ºï¼Œæ”¾å…¥ä¸€çº§ç¼“å­˜
6. Aè·å–Bï¼Œå®Œæˆåˆ›å»º
```

**Q3: ä¸ºä»€ä¹ˆéœ€è¦ä¸‰çº§ç¼“å­˜ï¼Ÿ**
```
ä¸ºäº†æ”¯æŒAOPä»£ç†ï¼š
- ä¸‰çº§ç¼“å­˜å­˜å‚¨ObjectFactory
- å¯ä»¥åœ¨éœ€è¦æ—¶åˆ›å»ºä»£ç†å¯¹è±¡
- ä¿è¯æ³¨å…¥çš„æ˜¯æœ€ç»ˆçš„ä»£ç†å¯¹è±¡
```

---

**æ·±å…¥ç†è§£IoCï¼ŒæŒæ¡Springæ ¸å¿ƒï¼** ğŸš€

*æœ€åæ›´æ–°ï¼š2025-12-26*