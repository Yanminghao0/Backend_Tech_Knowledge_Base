# @EnableAutoConfigurationæºç è§£æ

> ğŸ’¡ æ·±å…¥ç†è§£SpringBootè‡ªåŠ¨é…ç½®çš„æ ¸å¿ƒæœºåˆ¶ï¼ŒæŒæ¡SPIåŠ è½½åŸç†

---

## ğŸ“š ç›®å½•

1. [è‡ªåŠ¨é…ç½®æ¦‚è¿°](#1-è‡ªåŠ¨é…ç½®æ¦‚è¿°)
2. [æ ¸å¿ƒæ³¨è§£è§£æ](#2-æ ¸å¿ƒæ³¨è§£è§£æ)
3. [AutoConfigurationImportSelector](#3-autoconfigurationimportselector)
4. [æ¡ä»¶æ³¨è§£æœºåˆ¶](#4-æ¡ä»¶æ³¨è§£æœºåˆ¶)
5. [è‡ªåŠ¨é…ç½®åŠ è½½æµç¨‹](#5-è‡ªåŠ¨é…ç½®åŠ è½½æµç¨‹)
6. [è‡ªå®šä¹‰è‡ªåŠ¨é…ç½®](#6-è‡ªå®šä¹‰è‡ªåŠ¨é…ç½®)
7. [é¢è¯•è¦ç‚¹](#7-é¢è¯•è¦ç‚¹)

---

## 1. è‡ªåŠ¨é…ç½®æ¦‚è¿°

### 1.1 ä»€ä¹ˆæ˜¯è‡ªåŠ¨é…ç½®

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  SpringBootè‡ªåŠ¨é…ç½®                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  ä¼ ç»ŸSpringé…ç½®ï¼š                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ @Bean DataSource dataSource() {...}     â”‚               â”‚
â”‚  â”‚ @Bean JdbcTemplate jdbcTemplate() {...} â”‚               â”‚
â”‚  â”‚ @Bean TransactionManager txManager()... â”‚               â”‚
â”‚  â”‚ ...å¤§é‡é…ç½®ä»£ç                           â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                             â”‚
â”‚  SpringBootè‡ªåŠ¨é…ç½®ï¼š                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ å¼•å…¥spring-boot-starter-jdbc            â”‚               â”‚
â”‚  â”‚ é…ç½®æ•°æ®åº“è¿æ¥ä¿¡æ¯                       â”‚               â”‚
â”‚  â”‚ è‡ªåŠ¨é…ç½®DataSourceã€JdbcTemplateç­‰      â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ ¸å¿ƒåŸç†

```java
// @SpringBootApplication = @SpringBootConfiguration + @EnableAutoConfiguration + @ComponentScan
@SpringBootApplication
public class MyApplication {
    public static void main(String[] args) {
        SpringApplication.run(MyApplication.class, args);
    }
}

// è‡ªåŠ¨é…ç½®çš„æ ¸å¿ƒï¼š
// 1. @EnableAutoConfiguration å¼€å¯è‡ªåŠ¨é…ç½®
// 2. AutoConfigurationImportSelector åŠ è½½è‡ªåŠ¨é…ç½®ç±»
// 3. spring.factories / AutoConfiguration.imports é…ç½®æ–‡ä»¶
// 4. @Conditional æ¡ä»¶æ³¨è§£æ§åˆ¶æ˜¯å¦ç”Ÿæ•ˆ
```


---

## 2. æ ¸å¿ƒæ³¨è§£è§£æ

### 2.1 @SpringBootApplication

```java
@Target(ElementType.TYPE)
@Retention(RetentionPolicy.RUNTIME)
@Documented
@Inherited
@SpringBootConfiguration  // æ ‡è®°ä¸ºé…ç½®ç±»
@EnableAutoConfiguration  // ğŸ”¥ å¼€å¯è‡ªåŠ¨é…ç½®
@ComponentScan(excludeFilters = {  // ç»„ä»¶æ‰«æ
    @Filter(type = FilterType.CUSTOM, classes = TypeExcludeFilter.class),
    @Filter(type = FilterType.CUSTOM, classes = AutoConfigurationExcludeFilter.class)
})
public @interface SpringBootApplication {
    
    // æ’é™¤ç‰¹å®šè‡ªåŠ¨é…ç½®ç±»
    @AliasFor(annotation = EnableAutoConfiguration.class)
    Class<?>[] exclude() default {};
    
    // æ’é™¤ç‰¹å®šè‡ªåŠ¨é…ç½®ç±»ï¼ˆæŒ‰åç§°ï¼‰
    @AliasFor(annotation = EnableAutoConfiguration.class)
    String[] excludeName() default {};
    
    // æ‰«æçš„åŸºç¡€åŒ…
    @AliasFor(annotation = ComponentScan.class, attribute = "basePackages")
    String[] scanBasePackages() default {};
    
    // æ‰«æçš„åŸºç¡€åŒ…ï¼ˆæŒ‰ç±»ï¼‰
    @AliasFor(annotation = ComponentScan.class, attribute = "basePackageClasses")
    Class<?>[] scanBasePackageClasses() default {};
    
    // Beanåç§°ç”Ÿæˆå™¨
    @AliasFor(annotation = ComponentScan.class, attribute = "nameGenerator")
    Class<? extends BeanNameGenerator> nameGenerator() default BeanNameGenerator.class;
    
    // æ˜¯å¦ä»£ç†@Beanæ–¹æ³•
    @AliasFor(annotation = Configuration.class)
    boolean proxyBeanMethods() default true;
}
```

### 2.2 @EnableAutoConfiguration

```java
@Target(ElementType.TYPE)
@Retention(RetentionPolicy.RUNTIME)
@Documented
@Inherited
@AutoConfigurationPackage  // æ³¨å†Œè‡ªåŠ¨é…ç½®åŒ…
@Import(AutoConfigurationImportSelector.class)  // ğŸ”¥ å¯¼å…¥è‡ªåŠ¨é…ç½®é€‰æ‹©å™¨
public @interface EnableAutoConfiguration {
    
    /**
     * ç¯å¢ƒå±æ€§ï¼Œç”¨äºå¯ç”¨/ç¦ç”¨è‡ªåŠ¨é…ç½®
     */
    String ENABLED_OVERRIDE_PROPERTY = "spring.boot.enableautoconfiguration";
    
    /**
     * æ’é™¤ç‰¹å®šè‡ªåŠ¨é…ç½®ç±»
     */
    Class<?>[] exclude() default {};
    
    /**
     * æ’é™¤ç‰¹å®šè‡ªåŠ¨é…ç½®ç±»ï¼ˆæŒ‰åç§°ï¼‰
     */
    String[] excludeName() default {};
}
```

### 2.3 @AutoConfigurationPackage

```java
@Target(ElementType.TYPE)
@Retention(RetentionPolicy.RUNTIME)
@Documented
@Inherited
@Import(AutoConfigurationPackages.Registrar.class)  // æ³¨å†Œè‡ªåŠ¨é…ç½®åŒ…
public @interface AutoConfigurationPackage {
    
    /**
     * åŸºç¡€åŒ…
     */
    String[] basePackages() default {};
    
    /**
     * åŸºç¡€åŒ…ç±»
     */
    Class<?>[] basePackageClasses() default {};
}

/**
 * æ³¨å†Œè‡ªåŠ¨é…ç½®åŒ…
 */
static class Registrar implements ImportBeanDefinitionRegistrar, DeterminableImports {
    
    @Override
    public void registerBeanDefinitions(AnnotationMetadata metadata, 
            BeanDefinitionRegistry registry) {
        // æ³¨å†Œä¸»ç±»æ‰€åœ¨åŒ…ä¸ºè‡ªåŠ¨é…ç½®åŒ…
        register(registry, new PackageImports(metadata).getPackageNames().toArray(new String[0]));
    }
    
    @Override
    public Set<Object> determineImports(AnnotationMetadata metadata) {
        return Collections.singleton(new PackageImports(metadata));
    }
}
```

---

## 3. AutoConfigurationImportSelector

### 3.1 ç±»å®šä¹‰

```java
/**
 * è‡ªåŠ¨é…ç½®å¯¼å…¥é€‰æ‹©å™¨
 * è´Ÿè´£åŠ è½½æ‰€æœ‰è‡ªåŠ¨é…ç½®ç±»
 */
public class AutoConfigurationImportSelector 
        implements DeferredImportSelector,  // å»¶è¿Ÿå¯¼å…¥
                   BeanClassLoaderAware, 
                   ResourceLoaderAware,
                   BeanFactoryAware, 
                   EnvironmentAware, 
                   Ordered {
    
    private static final AutoConfigurationEntry EMPTY_ENTRY = new AutoConfigurationEntry();
    
    private static final String[] NO_IMPORTS = {};
    
    private ConfigurableListableBeanFactory beanFactory;
    private Environment environment;
    private ClassLoader beanClassLoader;
    private ResourceLoader resourceLoader;
    
    // é…ç½®ç±»è¿‡æ»¤å™¨
    private ConfigurationClassFilter configurationClassFilter;
}
```

### 3.2 selectImportsæ–¹æ³•

```java
/**
 * é€‰æ‹©è¦å¯¼å…¥çš„è‡ªåŠ¨é…ç½®ç±»
 */
@Override
public String[] selectImports(AnnotationMetadata annotationMetadata) {
    // æ£€æŸ¥æ˜¯å¦å¯ç”¨è‡ªåŠ¨é…ç½®
    if (!isEnabled(annotationMetadata)) {
        return NO_IMPORTS;
    }
    
    // ğŸ”¥ è·å–è‡ªåŠ¨é…ç½®æ¡ç›®
    AutoConfigurationEntry autoConfigurationEntry = getAutoConfigurationEntry(annotationMetadata);
    
    return StringUtils.toStringArray(autoConfigurationEntry.getConfigurations());
}

/**
 * æ£€æŸ¥æ˜¯å¦å¯ç”¨è‡ªåŠ¨é…ç½®
 */
protected boolean isEnabled(AnnotationMetadata metadata) {
    if (getClass() == AutoConfigurationImportSelector.class) {
        // æ£€æŸ¥spring.boot.enableautoconfigurationå±æ€§
        return getEnvironment().getProperty(
            EnableAutoConfiguration.ENABLED_OVERRIDE_PROPERTY, Boolean.class, true);
    }
    return true;
}
```

### 3.3 getAutoConfigurationEntryæ ¸å¿ƒæ–¹æ³•

```java
/**
 * ğŸ”¥ è·å–è‡ªåŠ¨é…ç½®æ¡ç›® - æ ¸å¿ƒæ–¹æ³•
 */
protected AutoConfigurationEntry getAutoConfigurationEntry(AnnotationMetadata annotationMetadata) {
    // 1. æ£€æŸ¥æ˜¯å¦å¯ç”¨
    if (!isEnabled(annotationMetadata)) {
        return EMPTY_ENTRY;
    }
    
    // 2. è·å–æ³¨è§£å±æ€§
    AnnotationAttributes attributes = getAttributes(annotationMetadata);
    
    // 3. ğŸ”¥ è·å–å€™é€‰é…ç½®ç±»
    List<String> configurations = getCandidateConfigurations(annotationMetadata, attributes);
    
    // 4. å»é‡
    configurations = removeDuplicates(configurations);
    
    // 5. è·å–æ’é™¤çš„é…ç½®ç±»
    Set<String> exclusions = getExclusions(annotationMetadata, attributes);
    
    // 6. æ£€æŸ¥æ’é™¤ç±»æ˜¯å¦å­˜åœ¨
    checkExcludedClasses(configurations, exclusions);
    
    // 7. ç§»é™¤æ’é™¤çš„é…ç½®ç±»
    configurations.removeAll(exclusions);
    
    // 8. ğŸ”¥ è¿‡æ»¤é…ç½®ç±»ï¼ˆæ ¹æ®æ¡ä»¶æ³¨è§£ï¼‰
    configurations = getConfigurationClassFilter().filter(configurations);
    
    // 9. è§¦å‘è‡ªåŠ¨é…ç½®å¯¼å…¥äº‹ä»¶
    fireAutoConfigurationImportEvents(configurations, exclusions);
    
    return new AutoConfigurationEntry(configurations, exclusions);
}
```

### 3.4 getCandidateConfigurationsåŠ è½½é…ç½®

```java
/**
 * è·å–å€™é€‰è‡ªåŠ¨é…ç½®ç±»
 */
protected List<String> getCandidateConfigurations(AnnotationMetadata metadata,
        AnnotationAttributes attributes) {
    
    // ğŸ”¥ SpringBoot 2.7+ ä½¿ç”¨æ–°çš„åŠ è½½æ–¹å¼
    List<String> configurations = new ArrayList<>(
        SpringFactoriesLoader.loadFactoryNames(getSpringFactoriesLoaderFactoryClass(), 
            getBeanClassLoader()));
    
    // åŠ è½½AutoConfiguration.importsæ–‡ä»¶
    ImportCandidates.load(AutoConfiguration.class, getBeanClassLoader())
        .forEach(configurations::add);
    
    Assert.notEmpty(configurations,
        "No auto configuration classes found in META-INF/spring.factories nor in " +
        "META-INF/spring/org.springframework.boot.autoconfigure.AutoConfiguration.imports");
    
    return configurations;
}

/**
 * è·å–å·¥å‚ç±»
 */
protected Class<?> getSpringFactoriesLoaderFactoryClass() {
    return EnableAutoConfiguration.class;
}
```

### 3.5 SpringFactoriesLoader

```java
/**
 * Spring SPIåŠ è½½å™¨
 * ä»META-INF/spring.factoriesåŠ è½½é…ç½®
 */
public final class SpringFactoriesLoader {
    
    public static final String FACTORIES_RESOURCE_LOCATION = "META-INF/spring.factories";
    
    /**
     * åŠ è½½å·¥å‚åç§°
     */
    public static List<String> loadFactoryNames(Class<?> factoryType, 
            @Nullable ClassLoader classLoader) {
        
        ClassLoader classLoaderToUse = classLoader;
        if (classLoaderToUse == null) {
            classLoaderToUse = SpringFactoriesLoader.class.getClassLoader();
        }
        
        String factoryTypeName = factoryType.getName();
        
        // ğŸ”¥ åŠ è½½å¹¶è·å–æŒ‡å®šç±»å‹çš„å·¥å‚åç§°
        return loadSpringFactories(classLoaderToUse)
            .getOrDefault(factoryTypeName, Collections.emptyList());
    }
    
    /**
     * åŠ è½½æ‰€æœ‰spring.factoriesé…ç½®
     */
    private static Map<String, List<String>> loadSpringFactories(ClassLoader classLoader) {
        // ä»ç¼“å­˜è·å–
        Map<String, List<String>> result = cache.get(classLoader);
        if (result != null) {
            return result;
        }
        
        result = new HashMap<>();
        try {
            // ğŸ”¥ åŠ è½½æ‰€æœ‰META-INF/spring.factoriesæ–‡ä»¶
            Enumeration<URL> urls = classLoader.getResources(FACTORIES_RESOURCE_LOCATION);
            
            while (urls.hasMoreElements()) {
                URL url = urls.nextElement();
                UrlResource resource = new UrlResource(url);
                
                // è§£æpropertiesæ–‡ä»¶
                Properties properties = PropertiesLoaderUtils.loadProperties(resource);
                
                for (Map.Entry<?, ?> entry : properties.entrySet()) {
                    String factoryTypeName = ((String) entry.getKey()).trim();
                    
                    // è§£æé€—å·åˆ†éš”çš„ç±»å
                    String[] factoryImplementationNames = 
                        StringUtils.commaDelimitedListToStringArray((String) entry.getValue());
                    
                    for (String factoryImplementationName : factoryImplementationNames) {
                        result.computeIfAbsent(factoryTypeName, key -> new ArrayList<>())
                            .add(factoryImplementationName.trim());
                    }
                }
            }
            
            // å»é‡å¹¶è½¬ä¸ºä¸å¯å˜åˆ—è¡¨
            result.replaceAll((factoryType, implementations) -> 
                implementations.stream().distinct().collect(
                    Collectors.collectingAndThen(Collectors.toList(), 
                        Collections::unmodifiableList)));
            
            cache.put(classLoader, result);
        } catch (IOException ex) {
            throw new IllegalArgumentException("Unable to load factories from location [" +
                FACTORIES_RESOURCE_LOCATION + "]", ex);
        }
        
        return result;
    }
}
```

### 3.6 spring.factoriesæ–‡ä»¶ç¤ºä¾‹

```properties
# META-INF/spring.factories

# Auto Configure
org.springframework.boot.autoconfigure.EnableAutoConfiguration=\
org.springframework.boot.autoconfigure.admin.SpringApplicationAdminJmxAutoConfiguration,\
org.springframework.boot.autoconfigure.aop.AopAutoConfiguration,\
org.springframework.boot.autoconfigure.amqp.RabbitAutoConfiguration,\
org.springframework.boot.autoconfigure.batch.BatchAutoConfiguration,\
org.springframework.boot.autoconfigure.cache.CacheAutoConfiguration,\
org.springframework.boot.autoconfigure.data.jdbc.JdbcRepositoriesAutoConfiguration,\
org.springframework.boot.autoconfigure.data.jpa.JpaRepositoriesAutoConfiguration,\
org.springframework.boot.autoconfigure.data.redis.RedisAutoConfiguration,\
org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration,\
org.springframework.boot.autoconfigure.jdbc.JdbcTemplateAutoConfiguration,\
org.springframework.boot.autoconfigure.web.servlet.WebMvcAutoConfiguration
```


---

## 4. æ¡ä»¶æ³¨è§£æœºåˆ¶

### 4.1 @Conditionalæ³¨è§£ä½“ç³»

```java
/**
 * æ¡ä»¶æ³¨è§£åŸºç±»
 */
@Target({ElementType.TYPE, ElementType.METHOD})
@Retention(RetentionPolicy.RUNTIME)
@Documented
public @interface Conditional {
    /**
     * æ¡ä»¶ç±»
     */
    Class<? extends Condition>[] value();
}

/**
 * æ¡ä»¶æ¥å£
 */
@FunctionalInterface
public interface Condition {
    /**
     * åˆ¤æ–­æ¡ä»¶æ˜¯å¦åŒ¹é…
     */
    boolean matches(ConditionContext context, AnnotatedTypeMetadata metadata);
}
```

### 4.2 å¸¸ç”¨æ¡ä»¶æ³¨è§£

```java
// ç±»å­˜åœ¨æ—¶ç”Ÿæ•ˆ
@ConditionalOnClass(DataSource.class)

// ç±»ä¸å­˜åœ¨æ—¶ç”Ÿæ•ˆ
@ConditionalOnMissingClass("com.example.SomeClass")

// Beanå­˜åœ¨æ—¶ç”Ÿæ•ˆ
@ConditionalOnBean(DataSource.class)

// Beanä¸å­˜åœ¨æ—¶ç”Ÿæ•ˆ
@ConditionalOnMissingBean(DataSource.class)

// å±æ€§åŒ¹é…æ—¶ç”Ÿæ•ˆ
@ConditionalOnProperty(prefix = "spring.datasource", name = "enabled", havingValue = "true")

// Webåº”ç”¨æ—¶ç”Ÿæ•ˆ
@ConditionalOnWebApplication

// éWebåº”ç”¨æ—¶ç”Ÿæ•ˆ
@ConditionalOnNotWebApplication

// èµ„æºå­˜åœ¨æ—¶ç”Ÿæ•ˆ
@ConditionalOnResource(resources = "classpath:application.yml")

// è¡¨è¾¾å¼ä¸ºtrueæ—¶ç”Ÿæ•ˆ
@ConditionalOnExpression("${my.feature.enabled:false}")

// å•å€™é€‰Beanæ—¶ç”Ÿæ•ˆ
@ConditionalOnSingleCandidate(DataSource.class)
```

### 4.3 @ConditionalOnClasså®ç°

```java
@Target({ElementType.TYPE, ElementType.METHOD})
@Retention(RetentionPolicy.RUNTIME)
@Documented
@Conditional(OnClassCondition.class)
public @interface ConditionalOnClass {
    
    /**
     * å¿…é¡»å­˜åœ¨çš„ç±»
     */
    Class<?>[] value() default {};
    
    /**
     * å¿…é¡»å­˜åœ¨çš„ç±»å
     */
    String[] name() default {};
}

/**
 * OnClassConditionå®ç°
 */
@Order(Ordered.HIGHEST_PRECEDENCE)
class OnClassCondition extends FilteringSpringBootCondition {
    
    @Override
    protected final ConditionOutcome[] getOutcomes(String[] autoConfigurationClasses,
            AutoConfigurationMetadata autoConfigurationMetadata) {
        
        // åˆ†æ‰¹å¤„ç†ï¼Œæé«˜æ€§èƒ½
        if (autoConfigurationClasses.length > 1 && 
                Runtime.getRuntime().availableProcessors() > 1) {
            return resolveOutcomesThreaded(autoConfigurationClasses, autoConfigurationMetadata);
        } else {
            OutcomesResolver outcomesResolver = new StandardOutcomesResolver(
                autoConfigurationClasses, 0, autoConfigurationClasses.length,
                autoConfigurationMetadata, getBeanClassLoader());
            return outcomesResolver.resolveOutcomes();
        }
    }
    
    @Override
    public ConditionOutcome getMatchOutcome(ConditionContext context,
            AnnotatedTypeMetadata metadata) {
        
        ClassLoader classLoader = context.getClassLoader();
        ConditionMessage matchMessage = ConditionMessage.empty();
        
        // è·å–@ConditionalOnClassçš„valueå±æ€§
        List<String> onClasses = getCandidates(metadata, ConditionalOnClass.class);
        if (onClasses != null) {
            // ğŸ”¥ æ£€æŸ¥ç±»æ˜¯å¦å­˜åœ¨
            List<String> missing = filter(onClasses, ClassNameFilter.MISSING, classLoader);
            if (!missing.isEmpty()) {
                return ConditionOutcome.noMatch(
                    ConditionMessage.forCondition(ConditionalOnClass.class)
                        .didNotFind("required class", "required classes")
                        .items(Style.QUOTE, missing));
            }
            matchMessage = matchMessage.andCondition(ConditionalOnClass.class)
                .found("required class", "required classes")
                .items(Style.QUOTE, filter(onClasses, ClassNameFilter.PRESENT, classLoader));
        }
        
        // è·å–@ConditionalOnMissingClassçš„valueå±æ€§
        List<String> onMissingClasses = getCandidates(metadata, ConditionalOnMissingClass.class);
        if (onMissingClasses != null) {
            List<String> present = filter(onMissingClasses, ClassNameFilter.PRESENT, classLoader);
            if (!present.isEmpty()) {
                return ConditionOutcome.noMatch(
                    ConditionMessage.forCondition(ConditionalOnMissingClass.class)
                        .found("unwanted class", "unwanted classes")
                        .items(Style.QUOTE, present));
            }
            matchMessage = matchMessage.andCondition(ConditionalOnMissingClass.class)
                .didNotFind("unwanted class", "unwanted classes")
                .items(Style.QUOTE, filter(onMissingClasses, ClassNameFilter.MISSING, classLoader));
        }
        
        return ConditionOutcome.match(matchMessage);
    }
}
```

### 4.4 @ConditionalOnBeanå®ç°

```java
@Target({ElementType.TYPE, ElementType.METHOD})
@Retention(RetentionPolicy.RUNTIME)
@Documented
@Conditional(OnBeanCondition.class)
public @interface ConditionalOnBean {
    
    Class<?>[] value() default {};
    
    String[] type() default {};
    
    Class<? extends Annotation>[] annotation() default {};
    
    String[] name() default {};
    
    SearchStrategy search() default SearchStrategy.ALL;
    
    Class<?>[] parameterizedContainer() default {};
}

/**
 * OnBeanConditionå®ç°
 */
@Order(Ordered.LOWEST_PRECEDENCE)
class OnBeanCondition extends FilteringSpringBootCondition implements ConfigurationCondition {
    
    @Override
    public ConfigurationPhase getConfigurationPhase() {
        // åœ¨Beanæ³¨å†Œé˜¶æ®µè¯„ä¼°
        return ConfigurationPhase.REGISTER_BEAN;
    }
    
    @Override
    public ConditionOutcome getMatchOutcome(ConditionContext context,
            AnnotatedTypeMetadata metadata) {
        
        ConditionMessage matchMessage = ConditionMessage.empty();
        MergedAnnotations annotations = metadata.getAnnotations();
        
        // å¤„ç†@ConditionalOnBean
        if (annotations.isPresent(ConditionalOnBean.class)) {
            Spec<ConditionalOnBean> spec = new Spec<>(context, metadata, annotations,
                ConditionalOnBean.class);
            MatchResult matchResult = getMatchingBeans(context, spec);
            
            if (!matchResult.isAllMatched()) {
                String reason = createOnBeanNoMatchReason(matchResult);
                return ConditionOutcome.noMatch(spec.message().because(reason));
            }
            matchMessage = spec.message(matchMessage)
                .found("bean", "beans")
                .items(Style.QUOTE, matchResult.getNamesOfAllMatches());
        }
        
        // å¤„ç†@ConditionalOnMissingBean
        if (annotations.isPresent(ConditionalOnMissingBean.class)) {
            Spec<ConditionalOnMissingBean> spec = new Spec<>(context, metadata, annotations,
                ConditionalOnMissingBean.class);
            MatchResult matchResult = getMatchingBeans(context, spec);
            
            if (matchResult.isAnyMatched()) {
                String reason = createOnMissingBeanNoMatchReason(matchResult);
                return ConditionOutcome.noMatch(spec.message().because(reason));
            }
            matchMessage = spec.message(matchMessage)
                .didNotFind("any beans")
                .atAll();
        }
        
        return ConditionOutcome.match(matchMessage);
    }
}
```

---

## 5. è‡ªåŠ¨é…ç½®åŠ è½½æµç¨‹

### 5.1 å®Œæ•´æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  è‡ªåŠ¨é…ç½®åŠ è½½æµç¨‹                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  1. @SpringBootApplication                                 â”‚
â”‚         â”‚                                                   â”‚
â”‚         â–¼                                                   â”‚
â”‚  2. @EnableAutoConfiguration                               â”‚
â”‚         â”‚                                                   â”‚
â”‚         â–¼                                                   â”‚
â”‚  3. @Import(AutoConfigurationImportSelector.class)         â”‚
â”‚         â”‚                                                   â”‚
â”‚         â–¼                                                   â”‚
â”‚  4. AutoConfigurationImportSelector.selectImports()        â”‚
â”‚         â”‚                                                   â”‚
â”‚         â–¼                                                   â”‚
â”‚  5. getAutoConfigurationEntry()                            â”‚
â”‚         â”‚                                                   â”‚
â”‚         â”œâ”€â”€â–¶ getCandidateConfigurations()                  â”‚
â”‚         â”‚         â”‚                                         â”‚
â”‚         â”‚         â–¼                                         â”‚
â”‚         â”‚    SpringFactoriesLoader.loadFactoryNames()      â”‚
â”‚         â”‚         â”‚                                         â”‚
â”‚         â”‚         â–¼                                         â”‚
â”‚         â”‚    åŠ è½½META-INF/spring.factories                 â”‚
â”‚         â”‚    åŠ è½½META-INF/spring/...AutoConfiguration.imports
â”‚         â”‚                                                   â”‚
â”‚         â”œâ”€â”€â–¶ removeDuplicates() å»é‡                       â”‚
â”‚         â”‚                                                   â”‚
â”‚         â”œâ”€â”€â–¶ getExclusions() è·å–æ’é™¤é¡¹                    â”‚
â”‚         â”‚                                                   â”‚
â”‚         â””â”€â”€â–¶ filter() æ¡ä»¶è¿‡æ»¤                             â”‚
â”‚                   â”‚                                         â”‚
â”‚                   â–¼                                         â”‚
â”‚              OnClassCondition                              â”‚
â”‚              OnBeanCondition                               â”‚
â”‚              OnPropertyCondition                           â”‚
â”‚                   â”‚                                         â”‚
â”‚                   â–¼                                         â”‚
â”‚  6. è¿”å›è¿‡æ»¤åçš„è‡ªåŠ¨é…ç½®ç±»åˆ—è¡¨                              â”‚
â”‚         â”‚                                                   â”‚
â”‚         â–¼                                                   â”‚
â”‚  7. ConfigurationClassParserè§£æé…ç½®ç±»                     â”‚
â”‚         â”‚                                                   â”‚
â”‚         â–¼                                                   â”‚
â”‚  8. æ³¨å†ŒBeanDefinition                                     â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 è‡ªåŠ¨é…ç½®ç±»ç¤ºä¾‹

```java
/**
 * DataSourceè‡ªåŠ¨é…ç½®
 */
@AutoConfiguration(before = SqlInitializationAutoConfiguration.class)
@ConditionalOnClass({DataSource.class, EmbeddedDatabaseType.class})
@ConditionalOnMissingBean(type = "io.r2dbc.spi.ConnectionFactory")
@EnableConfigurationProperties(DataSourceProperties.class)
@Import({
    DataSourcePoolMetadataProvidersConfiguration.class,
    DataSourceInitializationConfiguration.class
})
public class DataSourceAutoConfiguration {
    
    @Configuration(proxyBeanMethods = false)
    @Conditional(EmbeddedDatabaseCondition.class)
    @ConditionalOnMissingBean({DataSource.class, XADataSource.class})
    @Import(EmbeddedDataSourceConfiguration.class)
    protected static class EmbeddedDatabaseConfiguration {
    }
    
    @Configuration(proxyBeanMethods = false)
    @Conditional(PooledDataSourceCondition.class)
    @ConditionalOnMissingBean({DataSource.class, XADataSource.class})
    @Import({
        DataSourceConfiguration.Hikari.class,
        DataSourceConfiguration.Tomcat.class,
        DataSourceConfiguration.Dbcp2.class,
        DataSourceConfiguration.OracleUcp.class,
        DataSourceConfiguration.Generic.class,
        DataSourceJmxConfiguration.class
    })
    protected static class PooledDataSourceConfiguration {
    }
}
```

---

## 6. è‡ªå®šä¹‰è‡ªåŠ¨é…ç½®

### 6.1 åˆ›å»ºè‡ªåŠ¨é…ç½®ç±»

```java
/**
 * è‡ªå®šä¹‰è‡ªåŠ¨é…ç½®ç±»
 */
@AutoConfiguration
@ConditionalOnClass(MyService.class)
@ConditionalOnProperty(prefix = "my.service", name = "enabled", havingValue = "true", matchIfMissing = true)
@EnableConfigurationProperties(MyServiceProperties.class)
public class MyServiceAutoConfiguration {
    
    @Bean
    @ConditionalOnMissingBean
    public MyService myService(MyServiceProperties properties) {
        MyService service = new MyService();
        service.setName(properties.getName());
        service.setTimeout(properties.getTimeout());
        return service;
    }
    
    @Bean
    @ConditionalOnBean(MyService.class)
    @ConditionalOnMissingBean
    public MyServiceHealthIndicator myServiceHealthIndicator(MyService myService) {
        return new MyServiceHealthIndicator(myService);
    }
}
```

### 6.2 é…ç½®å±æ€§ç±»

```java
@ConfigurationProperties(prefix = "my.service")
public class MyServiceProperties {
    
    private String name = "default";
    private int timeout = 5000;
    private boolean enabled = true;
    
    // getters and setters
}
```

### 6.3 æ³¨å†Œè‡ªåŠ¨é…ç½®

```properties
# META-INF/spring/org.springframework.boot.autoconfigure.AutoConfiguration.imports
com.example.autoconfigure.MyServiceAutoConfiguration
```

æˆ–è€…ï¼ˆSpringBoot 2.7ä¹‹å‰ï¼‰ï¼š

```properties
# META-INF/spring.factories
org.springframework.boot.autoconfigure.EnableAutoConfiguration=\
com.example.autoconfigure.MyServiceAutoConfiguration
```

---

## 7. é¢è¯•è¦ç‚¹

### 7.1 é«˜é¢‘é¢è¯•é¢˜

#### Q1: SpringBootè‡ªåŠ¨é…ç½®åŸç†ï¼Ÿ

```
ç­”æ¡ˆè¦ç‚¹ï¼š
1. @EnableAutoConfigurationå¼€å¯è‡ªåŠ¨é…ç½®
2. @Importå¯¼å…¥AutoConfigurationImportSelector
3. ä»spring.factories/AutoConfiguration.importsåŠ è½½é…ç½®ç±»
4. é€šè¿‡@Conditionalæ¡ä»¶æ³¨è§£è¿‡æ»¤
5. ç¬¦åˆæ¡ä»¶çš„é…ç½®ç±»è¢«è§£æå¹¶æ³¨å†ŒBean

æ ¸å¿ƒæµç¨‹ï¼š
@SpringBootApplication 
â†’ @EnableAutoConfiguration 
â†’ AutoConfigurationImportSelector 
â†’ SpringFactoriesLoader 
â†’ æ¡ä»¶è¿‡æ»¤ 
â†’ æ³¨å†ŒBean
```

#### Q2: spring.factoriesçš„ä½œç”¨ï¼Ÿ

```
ç­”æ¡ˆè¦ç‚¹ï¼š
1. Spring SPIæœºåˆ¶çš„é…ç½®æ–‡ä»¶
2. ä½äºMETA-INF/spring.factories
3. key-valueæ ¼å¼ï¼Œkeyæ˜¯æ¥å£ï¼Œvalueæ˜¯å®ç°ç±»
4. SpringFactoriesLoaderè´Ÿè´£åŠ è½½
5. SpringBoot 2.7+æ¨èä½¿ç”¨AutoConfiguration.imports

å¸¸è§é…ç½®ï¼š
- EnableAutoConfiguration: è‡ªåŠ¨é…ç½®ç±»
- ApplicationContextInitializer: ä¸Šä¸‹æ–‡åˆå§‹åŒ–å™¨
- ApplicationListener: åº”ç”¨ç›‘å¬å™¨
- EnvironmentPostProcessor: ç¯å¢ƒåç½®å¤„ç†å™¨
```

#### Q3: @Conditionalæ³¨è§£çš„ä½œç”¨ï¼Ÿ

```
ç­”æ¡ˆè¦ç‚¹ï¼š
1. æ¡ä»¶åŒ–é…ç½®çš„æ ¸å¿ƒæ³¨è§£
2. æ ¹æ®æ¡ä»¶å†³å®šæ˜¯å¦åˆ›å»ºBeanæˆ–é…ç½®ç±»
3. å¸¸ç”¨æ´¾ç”Ÿæ³¨è§£ï¼š
   - @ConditionalOnClass: ç±»å­˜åœ¨
   - @ConditionalOnMissingBean: Beanä¸å­˜åœ¨
   - @ConditionalOnProperty: å±æ€§åŒ¹é…
4. å®ç°Conditionæ¥å£è‡ªå®šä¹‰æ¡ä»¶

æ‰§è¡Œæ—¶æœºï¼š
- OnClassCondition: é…ç½®ç±»è§£æé˜¶æ®µ
- OnBeanCondition: Beanæ³¨å†Œé˜¶æ®µ
```

### 7.2 çŸ¥è¯†ç‚¹æ€»ç»“

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              @EnableAutoConfigurationæ€»ç»“                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  æ ¸å¿ƒç»„ä»¶ï¼š                                                  â”‚
â”‚  â”œâ”€â”€ @EnableAutoConfiguration: å¼€å¯è‡ªåŠ¨é…ç½®                 â”‚
â”‚  â”œâ”€â”€ AutoConfigurationImportSelector: é…ç½®é€‰æ‹©å™¨            â”‚
â”‚  â”œâ”€â”€ SpringFactoriesLoader: SPIåŠ è½½å™¨                       â”‚
â”‚  â””â”€â”€ @Conditional: æ¡ä»¶æ³¨è§£                                 â”‚
â”‚                                                             â”‚
â”‚  é…ç½®æ–‡ä»¶ï¼š                                                  â”‚
â”‚  â”œâ”€â”€ META-INF/spring.factories (æ—§)                        â”‚
â”‚  â””â”€â”€ META-INF/spring/...AutoConfiguration.imports (æ–°)     â”‚
â”‚                                                             â”‚
â”‚  æ¡ä»¶æ³¨è§£ï¼š                                                  â”‚
â”‚  â”œâ”€â”€ @ConditionalOnClass: ç±»å­˜åœ¨                           â”‚
â”‚  â”œâ”€â”€ @ConditionalOnMissingBean: Beanä¸å­˜åœ¨                 â”‚
â”‚  â”œâ”€â”€ @ConditionalOnProperty: å±æ€§åŒ¹é…                      â”‚
â”‚  â””â”€â”€ @ConditionalOnWebApplication: Webåº”ç”¨                 â”‚
â”‚                                                             â”‚
â”‚  è‡ªå®šä¹‰è‡ªåŠ¨é…ç½®ï¼š                                            â”‚
â”‚  1. åˆ›å»º@AutoConfigurationé…ç½®ç±»                            â”‚
â”‚  2. æ·»åŠ @Conditionalæ¡ä»¶æ³¨è§£                                â”‚
â”‚  3. æ³¨å†Œåˆ°AutoConfiguration.imports                        â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [SpringBootå®˜æ–¹æ–‡æ¡£ - Auto-configuration](https://docs.spring.io/spring-boot/docs/current/reference/html/using.html#using.auto-configuration)
- [SpringBootæºç  - AutoConfigurationImportSelector](https://github.com/spring-projects/spring-boot)

---

**æŒæ¡è‡ªåŠ¨é…ç½®åŸç†ï¼Œæ·±å…¥ç†è§£SpringBooté­”æ³•ï¼** ğŸš€

*æœ€åæ›´æ–°ï¼š2025-12-28*
