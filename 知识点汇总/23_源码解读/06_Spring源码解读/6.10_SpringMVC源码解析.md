# SpringMVCæºç è§£æ

> SpringMVCè¯·æ±‚å¤„ç†æµç¨‹æ·±åº¦è§£æ

## ğŸ“‹ ç›®å½•
- [æ•´ä½“æ¶æ„](#æ•´ä½“æ¶æ„)
- [æ ¸å¿ƒç»„ä»¶](#æ ¸å¿ƒç»„ä»¶)
- [è¯·æ±‚å¤„ç†æµç¨‹](#è¯·æ±‚å¤„ç†æµç¨‹)
- [å‚æ•°è§£æ](#å‚æ•°è§£æ)
- [è¿”å›å€¼å¤„ç†](#è¿”å›å€¼å¤„ç†)
- [é¢è¯•è¦ç‚¹](#é¢è¯•è¦ç‚¹)

---

## æ•´ä½“æ¶æ„

### MVCæ¶æ„

```
è¯·æ±‚ â†’ DispatcherServlet â†’ HandlerMapping â†’ HandlerAdapter â†’ Controller
                                                                â†“
å“åº” â† ViewResolver â† View â† ModelAndView â†â†â†â†â†â†â†â†â†â†â†â†â†â†â†â†â†â†â†â†â†
```

### æ ¸å¿ƒç»„ä»¶

```java
/**
 * DispatcherServletï¼šå‰ç«¯æ§åˆ¶å™¨
 * - æ‰€æœ‰è¯·æ±‚çš„å…¥å£
 * - åè°ƒå„ç»„ä»¶å·¥ä½œ
 */
public class DispatcherServlet extends FrameworkServlet {
    
    // å¤„ç†å™¨æ˜ å°„å™¨
    private List<HandlerMapping> handlerMappings;
    
    // å¤„ç†å™¨é€‚é…å™¨
    private List<HandlerAdapter> handlerAdapters;
    
    // è§†å›¾è§£æå™¨
    private List<ViewResolver> viewResolvers;
    
    // å¼‚å¸¸å¤„ç†å™¨
    private List<HandlerExceptionResolver> handlerExceptionResolvers;
}
```

---

## æ ¸å¿ƒç»„ä»¶

### 1. HandlerMapping

```java
/**
 * HandlerMappingï¼šå¤„ç†å™¨æ˜ å°„å™¨
 * - æ ¹æ®è¯·æ±‚URLæ‰¾åˆ°å¯¹åº”çš„Handler
 */
public interface HandlerMapping {
    HandlerExecutionChain getHandler(HttpServletRequest request) throws Exception;
}

// å¸¸ç”¨å®ç°
RequestMappingHandlerMapping  // @RequestMappingæ³¨è§£
BeanNameUrlHandlerMapping     // Beanåç§°æ˜ å°„
SimpleUrlHandlerMapping       // ç®€å•URLæ˜ å°„

/**
 * HandlerExecutionChainï¼šå¤„ç†å™¨æ‰§è¡Œé“¾
 * - åŒ…å«Handlerå’Œæ‹¦æˆªå™¨
 */
public class HandlerExecutionChain {
    private final Object handler;  // å¤„ç†å™¨ï¼ˆControlleræ–¹æ³•ï¼‰
    private List<HandlerInterceptor> interceptorList;  // æ‹¦æˆªå™¨é“¾
}
```

### 2. HandlerAdapter

```java
/**
 * HandlerAdapterï¼šå¤„ç†å™¨é€‚é…å™¨
 * - é€‚é…ä¸åŒç±»å‹çš„Handler
 * - æ‰§è¡ŒHandlerå¹¶è¿”å›ModelAndView
 */
public interface HandlerAdapter {
    // æ˜¯å¦æ”¯æŒè¯¥Handler
    boolean supports(Object handler);
    
    // æ‰§è¡ŒHandler
    ModelAndView handle(HttpServletRequest request, 
                       HttpServletResponse response, 
                       Object handler) throws Exception;
}

// å¸¸ç”¨å®ç°
RequestMappingHandlerAdapter  // @RequestMappingæ–¹æ³•
HttpRequestHandlerAdapter     // HttpRequestHandler
SimpleControllerHandlerAdapter // Controlleræ¥å£
```

### 3. ViewResolver

```java
/**
 * ViewResolverï¼šè§†å›¾è§£æå™¨
 * - æ ¹æ®è§†å›¾åè§£æå‡ºViewå¯¹è±¡
 */
public interface ViewResolver {
    View resolveViewName(String viewName, Locale locale) throws Exception;
}

// å¸¸ç”¨å®ç°
InternalResourceViewResolver  // JSPè§†å›¾
ThymeleafViewResolver         // Thymeleafæ¨¡æ¿
FreeMarkerViewResolver        // FreeMarkeræ¨¡æ¿
ContentNegotiatingViewResolver // å†…å®¹åå•†
```

---

## è¯·æ±‚å¤„ç†æµç¨‹

### doDispatchæ ¸å¿ƒæ–¹æ³•

```java
protected void doDispatch(HttpServletRequest request, HttpServletResponse response) 
        throws Exception {
    
    HttpServletRequest processedRequest = request;
    HandlerExecutionChain mappedHandler = null;
    boolean multipartRequestParsed = false;
    
    WebAsyncManager asyncManager = WebAsyncUtils.getAsyncManager(request);
    
    try {
        ModelAndView mv = null;
        Exception dispatchException = null;
        
        try {
            // 1. æ£€æŸ¥æ˜¯å¦æ–‡ä»¶ä¸Šä¼ è¯·æ±‚
            processedRequest = checkMultipart(request);
            multipartRequestParsed = (processedRequest != request);
            
            // 2. è·å–Handleræ‰§è¡Œé“¾ï¼ˆHandler + æ‹¦æˆªå™¨ï¼‰
            mappedHandler = getHandler(processedRequest);
            if (mappedHandler == null) {
                noHandlerFound(processedRequest, response);
                return;
            }
            
            // 3. è·å–HandlerAdapter
            HandlerAdapter ha = getHandlerAdapter(mappedHandler.getHandler());
            
            // 4. æ‰§è¡Œæ‹¦æˆªå™¨preHandle
            if (!mappedHandler.applyPreHandle(processedRequest, response)) {
                return;
            }
            
            // 5. æ‰§è¡ŒHandlerï¼ˆControlleræ–¹æ³•ï¼‰
            mv = ha.handle(processedRequest, response, mappedHandler.getHandler());
            
            // 6. å¤„ç†å¼‚æ­¥è¯·æ±‚
            if (asyncManager.isConcurrentHandlingStarted()) {
                return;
            }
            
            // 7. è®¾ç½®é»˜è®¤è§†å›¾å
            applyDefaultViewName(processedRequest, mv);
            
            // 8. æ‰§è¡Œæ‹¦æˆªå™¨postHandle
            mappedHandler.applyPostHandle(processedRequest, response, mv);
        }
        catch (Exception ex) {
            dispatchException = ex;
        }
        
        // 9. å¤„ç†ç»“æœï¼ˆæ¸²æŸ“è§†å›¾æˆ–å¤„ç†å¼‚å¸¸ï¼‰
        processDispatchResult(processedRequest, response, mappedHandler, mv, dispatchException);
    }
    catch (Exception ex) {
        // 10. æ‰§è¡Œæ‹¦æˆªå™¨afterCompletion
        triggerAfterCompletion(processedRequest, response, mappedHandler, ex);
    }
    finally {
        // 11. æ¸…ç†èµ„æº
        if (asyncManager.isConcurrentHandlingStarted()) {
            if (mappedHandler != null) {
                mappedHandler.applyAfterConcurrentHandlingStarted(processedRequest, response);
            }
        }
        else {
            if (multipartRequestParsed) {
                cleanupMultipart(processedRequest);
            }
        }
    }
}
```

### æµç¨‹å›¾

```
HTTPè¯·æ±‚
    â†“
DispatcherServlet.doDispatch()
    â†“
1. checkMultipart() - æ£€æŸ¥æ–‡ä»¶ä¸Šä¼ 
    â†“
2. getHandler() - è·å–Handleræ‰§è¡Œé“¾
    â†“
3. getHandlerAdapter() - è·å–é€‚é…å™¨
    â†“
4. preHandle() - æ‹¦æˆªå™¨å‰ç½®å¤„ç†
    â†“ è¿”å›trueç»§ç»­ï¼Œfalseç»“æŸ
5. handle() - æ‰§è¡ŒControlleræ–¹æ³•
    â†“
6. postHandle() - æ‹¦æˆªå™¨åç½®å¤„ç†
    â†“
7. processDispatchResult() - å¤„ç†ç»“æœ
    â†“
8. render() - æ¸²æŸ“è§†å›¾
    â†“
9. afterCompletion() - æ‹¦æˆªå™¨å®Œæˆå¤„ç†
    â†“
HTTPå“åº”
```

### æ‹¦æˆªå™¨æ‰§è¡Œé¡ºåº

```java
/**
 * æ‹¦æˆªå™¨æ‰§è¡Œé¡ºåº
 */
// æ­£å¸¸æµç¨‹
preHandle1 â†’ preHandle2 â†’ preHandle3
    â†“
Controlleræ‰§è¡Œ
    â†“
postHandle3 â†’ postHandle2 â†’ postHandle1
    â†“
afterCompletion3 â†’ afterCompletion2 â†’ afterCompletion1

// preHandleè¿”å›false
preHandle1 â†’ preHandle2(è¿”å›false)
    â†“
afterCompletion1  // åªæ‰§è¡Œå·²é€šè¿‡çš„æ‹¦æˆªå™¨

// å¼‚å¸¸æµç¨‹
preHandle1 â†’ preHandle2 â†’ preHandle3
    â†“
ControlleræŠ›å¼‚å¸¸
    â†“
afterCompletion3 â†’ afterCompletion2 â†’ afterCompletion1
```

---

## å‚æ•°è§£æ

### HandlerMethodArgumentResolver

```java
/**
 * å‚æ•°è§£æå™¨æ¥å£
 */
public interface HandlerMethodArgumentResolver {
    // æ˜¯å¦æ”¯æŒè¯¥å‚æ•°
    boolean supportsParameter(MethodParameter parameter);
    
    // è§£æå‚æ•°
    Object resolveArgument(MethodParameter parameter,
                          ModelAndViewContainer mavContainer,
                          NativeWebRequest webRequest,
                          WebDataBinderFactory binderFactory) throws Exception;
}

// å¸¸ç”¨å®ç°
RequestParamMethodArgumentResolver      // @RequestParam
PathVariableMethodArgumentResolver      // @PathVariable
RequestBodyMethodArgumentResolver       // @RequestBody
RequestHeaderMethodArgumentResolver     // @RequestHeader
ModelAttributeMethodProcessor           // @ModelAttribute
```

### @RequestBodyè§£æ

```java
/**
 * RequestResponseBodyMethodProcessor
 * å¤„ç†@RequestBodyå’Œ@ResponseBody
 */
public class RequestResponseBodyMethodProcessor implements HandlerMethodArgumentResolver {
    
    private final List<HttpMessageConverter<?>> messageConverters;
    
    @Override
    public Object resolveArgument(MethodParameter parameter,
                                 ModelAndViewContainer mavContainer,
                                 NativeWebRequest webRequest,
                                 WebDataBinderFactory binderFactory) throws Exception {
        
        // 1. è·å–è¯·æ±‚ä½“
        HttpInputMessage inputMessage = createInputMessage(webRequest);
        
        // 2. è·å–å‚æ•°ç±»å‹
        Type paramType = parameter.getGenericParameterType();
        
        // 3. é€‰æ‹©åˆé€‚çš„MessageConverter
        for (HttpMessageConverter<?> converter : messageConverters) {
            if (converter.canRead(paramType, contentType)) {
                // 4. è¯»å–å¹¶è½¬æ¢
                return converter.read(paramType, inputMessage);
            }
        }
        
        throw new HttpMediaTypeNotSupportedException(contentType);
    }
}

// å¸¸ç”¨MessageConverter
MappingJackson2HttpMessageConverter  // JSON
StringHttpMessageConverter           // String
ByteArrayHttpMessageConverter        // byte[]
FormHttpMessageConverter             // è¡¨å•
```

---

## è¿”å›å€¼å¤„ç†

### HandlerMethodReturnValueHandler

```java
/**
 * è¿”å›å€¼å¤„ç†å™¨æ¥å£
 */
public interface HandlerMethodReturnValueHandler {
    // æ˜¯å¦æ”¯æŒè¯¥è¿”å›å€¼ç±»å‹
    boolean supportsReturnType(MethodParameter returnType);
    
    // å¤„ç†è¿”å›å€¼
    void handleReturnValue(Object returnValue,
                          MethodParameter returnType,
                          ModelAndViewContainer mavContainer,
                          NativeWebRequest webRequest) throws Exception;
}

// å¸¸ç”¨å®ç°
RequestResponseBodyMethodProcessor  // @ResponseBody
ViewNameMethodReturnValueHandler    // Stringè§†å›¾å
ModelAndViewMethodReturnValueHandler // ModelAndView
```

### @ResponseBodyå¤„ç†

```java
/**
 * @ResponseBodyè¿”å›å€¼å¤„ç†
 */
@Override
public void handleReturnValue(Object returnValue,
                             MethodParameter returnType,
                             ModelAndViewContainer mavContainer,
                             NativeWebRequest webRequest) throws Exception {
    
    // 1. æ ‡è®°è¯·æ±‚å·²å¤„ç†ï¼ˆä¸éœ€è¦è§†å›¾è§£æï¼‰
    mavContainer.setRequestHandled(true);
    
    // 2. è·å–è¾“å‡ºæµ
    HttpOutputMessage outputMessage = createOutputMessage(webRequest);
    
    // 3. é€‰æ‹©åˆé€‚çš„MessageConverter
    for (HttpMessageConverter<?> converter : messageConverters) {
        if (converter.canWrite(returnType, contentType)) {
            // 4. å†™å…¥å“åº”
            converter.write(returnValue, contentType, outputMessage);
            return;
        }
    }
}
```

---

## é¢è¯•è¦ç‚¹

### 1. SpringMVCæ‰§è¡Œæµç¨‹

```
Q: SpringMVCçš„æ‰§è¡Œæµç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ

A:
1. è¯·æ±‚åˆ°è¾¾DispatcherServlet
2. DispatcherServletè°ƒç”¨HandlerMappingè·å–Handler
3. DispatcherServletè°ƒç”¨HandlerAdapteræ‰§è¡ŒHandler
4. Handleræ‰§è¡Œå®Œè¿”å›ModelAndView
5. DispatcherServletè°ƒç”¨ViewResolverè§£æè§†å›¾
6. Viewæ¸²æŸ“è§†å›¾è¿”å›å“åº”

æ ¸å¿ƒç»„ä»¶ï¼š
- DispatcherServletï¼šå‰ç«¯æ§åˆ¶å™¨
- HandlerMappingï¼šå¤„ç†å™¨æ˜ å°„å™¨
- HandlerAdapterï¼šå¤„ç†å™¨é€‚é…å™¨
- ViewResolverï¼šè§†å›¾è§£æå™¨
```

### 2. æ‹¦æˆªå™¨å’Œè¿‡æ»¤å™¨åŒºåˆ«

```
Q: æ‹¦æˆªå™¨å’Œè¿‡æ»¤å™¨æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

A:
| å¯¹æ¯”é¡¹ | è¿‡æ»¤å™¨Filter | æ‹¦æˆªå™¨Interceptor |
|--------|-------------|-------------------|
| è§„èŒƒ | Servletè§„èŒƒ | Springè§„èŒƒ |
| ä½œç”¨èŒƒå›´ | æ‰€æœ‰è¯·æ±‚ | Springç®¡ç†çš„è¯·æ±‚ |
| æ‰§è¡Œé¡ºåº | å…ˆæ‰§è¡Œ | åæ‰§è¡Œ |
| è·å–Bean | ä¸èƒ½ç›´æ¥è·å– | å¯ä»¥æ³¨å…¥Bean |
| æ‰§è¡Œæ—¶æœº | è¯·æ±‚è¿›å…¥Servletå‰å | Handleræ‰§è¡Œå‰å |
| ä¸­æ–­æ–¹å¼ | chain.doFilter() | return false |
```

### 3. @RequestBodyåŸç†

```
Q: @RequestBodyæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ

A:
1. RequestResponseBodyMethodProcessorå¤„ç†
2. æ ¹æ®Content-Typeé€‰æ‹©HttpMessageConverter
3. å¸¸ç”¨JSONï¼šMappingJackson2HttpMessageConverter
4. è¯»å–è¯·æ±‚ä½“ï¼Œååºåˆ—åŒ–ä¸ºJavaå¯¹è±¡
5. ç»‘å®šåˆ°æ–¹æ³•å‚æ•°
```

### 4. @ResponseBodyåŸç†

```
Q: @ResponseBodyæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ

A:
1. RequestResponseBodyMethodProcessorå¤„ç†
2. è®¾ç½®mavContainer.setRequestHandled(true)
3. æ ¹æ®Accepté€‰æ‹©HttpMessageConverter
4. åºåˆ—åŒ–è¿”å›å€¼
5. å†™å…¥å“åº”ä½“
6. ä¸ç»è¿‡è§†å›¾è§£æå™¨
```

---

## ğŸ’¡ æ€»ç»“

```
SpringMVCæ ¸å¿ƒè¦ç‚¹ï¼š

1. æ ¸å¿ƒç»„ä»¶ï¼š
   - DispatcherServletï¼šå‰ç«¯æ§åˆ¶å™¨
   - HandlerMappingï¼šURL â†’ Handler
   - HandlerAdapterï¼šæ‰§è¡ŒHandler
   - ViewResolverï¼šè§†å›¾è§£æ

2. æ‰§è¡Œæµç¨‹ï¼š
   è¯·æ±‚ â†’ HandlerMapping â†’ HandlerAdapter â†’ Controller
   å“åº” â† ViewResolver â† View â† ModelAndView

3. å‚æ•°è§£æï¼š
   - HandlerMethodArgumentResolver
   - HttpMessageConverter

4. è¿”å›å€¼å¤„ç†ï¼š
   - HandlerMethodReturnValueHandler
   - @ResponseBodyè·³è¿‡è§†å›¾è§£æ
```

---

*æœ€åæ›´æ–°ï¼š2025-12-28*
