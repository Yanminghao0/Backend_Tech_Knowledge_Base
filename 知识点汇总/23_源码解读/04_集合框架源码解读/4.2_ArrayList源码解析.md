# ArrayListæºç è§£æ

> ArrayListåŠ¨æ€æ•°ç»„å®ç°åŸç†æ·±åº¦è§£æ

## ğŸ“‹ ç›®å½•
- [æ•´ä½“ç»“æ„](#æ•´ä½“ç»“æ„)
- [æ ¸å¿ƒå±æ€§](#æ ¸å¿ƒå±æ€§)
- [æ„é€ æ–¹æ³•](#æ„é€ æ–¹æ³•)
- [æ·»åŠ å…ƒç´ ](#æ·»åŠ å…ƒç´ )
- [æ‰©å®¹æœºåˆ¶](#æ‰©å®¹æœºåˆ¶)
- [åˆ é™¤å…ƒç´ ](#åˆ é™¤å…ƒç´ )
- [é¢è¯•è¦ç‚¹](#é¢è¯•è¦ç‚¹)

---

## æ•´ä½“ç»“æ„

### ç±»å®šä¹‰

```java
public class ArrayList<E> extends AbstractList<E>
        implements List<E>, RandomAccess, Cloneable, java.io.Serializable {
    
    // åº•å±‚æ•°ç»„
    transient Object[] elementData;
    
    // å…ƒç´ æ•°é‡
    private int size;
}

/**
 * å…³é”®æ¥å£ï¼š
 * - Listï¼šåˆ—è¡¨æ“ä½œ
 * - RandomAccessï¼šæ ‡è®°æ¥å£ï¼Œæ”¯æŒå¿«é€Ÿéšæœºè®¿é—®
 * - Cloneableï¼šå¯å…‹éš†
 * - Serializableï¼šå¯åºåˆ—åŒ–
 */
```

### ç‰¹ç‚¹

```
ArrayListç‰¹ç‚¹ï¼š
1. åº•å±‚æ˜¯Objectæ•°ç»„
2. æ”¯æŒéšæœºè®¿é—®ï¼ˆO(1)ï¼‰
3. åŠ¨æ€æ‰©å®¹ï¼ˆ1.5å€ï¼‰
4. éçº¿ç¨‹å®‰å…¨
5. å…è®¸nullå…ƒç´ 
6. æœ‰åºï¼ˆæ’å…¥é¡ºåºï¼‰
```

---

## æ ¸å¿ƒå±æ€§

### é‡è¦å¸¸é‡

```java
// é»˜è®¤åˆå§‹å®¹é‡
private static final int DEFAULT_CAPACITY = 10;

// ç©ºæ•°ç»„ï¼ˆæŒ‡å®šå®¹é‡ä¸º0æ—¶ä½¿ç”¨ï¼‰
private static final Object[] EMPTY_ELEMENTDATA = {};

// é»˜è®¤ç©ºæ•°ç»„ï¼ˆæ— å‚æ„é€ æ—¶ä½¿ç”¨ï¼‰
private static final Object[] DEFAULTCAPACITY_EMPTY_ELEMENTDATA = {};

// æœ€å¤§æ•°ç»„å¤§å°
private static final int MAX_ARRAY_SIZE = Integer.MAX_VALUE - 8;
```

### ä¸ºä»€ä¹ˆæœ‰ä¸¤ä¸ªç©ºæ•°ç»„ï¼Ÿ

```java
/**
 * EMPTY_ELEMENTDATAï¼š
 *   - new ArrayList(0) æ—¶ä½¿ç”¨
 *   - æ‰©å®¹æ—¶æŒ‰æ­£å¸¸é€»è¾‘
 * 
 * DEFAULTCAPACITY_EMPTY_ELEMENTDATAï¼š
 *   - new ArrayList() æ—¶ä½¿ç”¨
 *   - ç¬¬ä¸€æ¬¡æ·»åŠ å…ƒç´ æ—¶æ‰©å®¹åˆ°DEFAULT_CAPACITY(10)
 */

// åŒºåˆ†ä¸¤ç§æƒ…å†µï¼š
// 1. ç”¨æˆ·æ˜ç¡®æŒ‡å®šå®¹é‡ä¸º0
// 2. ç”¨æˆ·ä½¿ç”¨é»˜è®¤æ„é€ ï¼ˆæ‡’åŠ è½½ï¼Œç¬¬ä¸€æ¬¡addæ—¶åˆ†é…10ï¼‰
```

---

## æ„é€ æ–¹æ³•

### ä¸‰ç§æ„é€ æ–¹æ³•

```java
/**
 * 1. æ— å‚æ„é€ ï¼ˆæ‡’åŠ è½½ï¼‰
 */
public ArrayList() {
    this.elementData = DEFAULTCAPACITY_EMPTY_ELEMENTDATA;
}
// æ³¨æ„ï¼šæ­¤æ—¶æ•°ç»„é•¿åº¦ä¸º0ï¼Œç¬¬ä¸€æ¬¡addæ—¶æ‰åˆ†é…10

/**
 * 2. æŒ‡å®šåˆå§‹å®¹é‡
 */
public ArrayList(int initialCapacity) {
    if (initialCapacity > 0) {
        this.elementData = new Object[initialCapacity];
    } else if (initialCapacity == 0) {
        this.elementData = EMPTY_ELEMENTDATA;
    } else {
        throw new IllegalArgumentException("Illegal Capacity: " + initialCapacity);
    }
}

/**
 * 3. ä»é›†åˆæ„é€ 
 */
public ArrayList(Collection<? extends E> c) {
    Object[] a = c.toArray();
    if ((size = a.length) != 0) {
        if (c.getClass() == ArrayList.class) {
            elementData = a;
        } else {
            elementData = Arrays.copyOf(a, size, Object[].class);
        }
    } else {
        elementData = EMPTY_ELEMENTDATA;
    }
}
```

---

## æ·»åŠ å…ƒç´ 

### add(E e)

```java
/**
 * æ·»åŠ å…ƒç´ åˆ°æœ«å°¾
 */
public boolean add(E e) {
    // 1. ç¡®ä¿å®¹é‡è¶³å¤Ÿ
    ensureCapacityInternal(size + 1);
    // 2. æ·»åŠ å…ƒç´ 
    elementData[size++] = e;
    return true;
}

private void ensureCapacityInternal(int minCapacity) {
    ensureExplicitCapacity(calculateCapacity(elementData, minCapacity));
}

private static int calculateCapacity(Object[] elementData, int minCapacity) {
    // å¦‚æœæ˜¯é»˜è®¤ç©ºæ•°ç»„ï¼Œè¿”å›DEFAULT_CAPACITYå’ŒminCapacityçš„è¾ƒå¤§å€¼
    if (elementData == DEFAULTCAPACITY_EMPTY_ELEMENTDATA) {
        return Math.max(DEFAULT_CAPACITY, minCapacity);
    }
    return minCapacity;
}

private void ensureExplicitCapacity(int minCapacity) {
    modCount++;  // ä¿®æ”¹æ¬¡æ•°+1ï¼ˆfail-fastï¼‰
    
    // éœ€è¦æ‰©å®¹
    if (minCapacity - elementData.length > 0)
        grow(minCapacity);
}
```

### add(int index, E element)

```java
/**
 * åœ¨æŒ‡å®šä½ç½®æ’å…¥å…ƒç´ 
 */
public void add(int index, E element) {
    // 1. æ£€æŸ¥ç´¢å¼•
    rangeCheckForAdd(index);
    
    // 2. ç¡®ä¿å®¹é‡
    ensureCapacityInternal(size + 1);
    
    // 3. ç§»åŠ¨å…ƒç´ ï¼ˆindexåçš„å…ƒç´ åç§»ä¸€ä½ï¼‰
    System.arraycopy(elementData, index, elementData, index + 1, size - index);
    
    // 4. æ’å…¥å…ƒç´ 
    elementData[index] = element;
    size++;
}

private void rangeCheckForAdd(int index) {
    if (index > size || index < 0)
        throw new IndexOutOfBoundsException(outOfBoundsMsg(index));
}
```

### æ·»åŠ æµç¨‹å›¾

```
add(e)
    â†“
ensureCapacityInternal(size + 1)
    â†“
æ˜¯é»˜è®¤ç©ºæ•°ç»„? â†’ æ˜¯ â†’ minCapacity = max(10, size+1)
    â†“ å¦
minCapacity = size + 1
    â†“
minCapacity > æ•°ç»„é•¿åº¦?
    â†“ æ˜¯              â†“ å¦
  grow()æ‰©å®¹      ç›´æ¥æ·»åŠ 
    â†“
elementData[size++] = e
```

---

## æ‰©å®¹æœºåˆ¶

### growæ‰©å®¹

```java
/**
 * æ‰©å®¹æ ¸å¿ƒæ–¹æ³•
 */
private void grow(int minCapacity) {
    int oldCapacity = elementData.length;
    
    // æ–°å®¹é‡ = æ—§å®¹é‡ * 1.5ï¼ˆå³ç§»1ä½ç›¸å½“äºé™¤2ï¼‰
    int newCapacity = oldCapacity + (oldCapacity >> 1);
    
    // æ–°å®¹é‡ä¸å¤Ÿï¼Œä½¿ç”¨minCapacity
    if (newCapacity - minCapacity < 0)
        newCapacity = minCapacity;
    
    // æ–°å®¹é‡è¶…è¿‡æœ€å¤§å€¼
    if (newCapacity - MAX_ARRAY_SIZE > 0)
        newCapacity = hugeCapacity(minCapacity);
    
    // å¤åˆ¶åˆ°æ–°æ•°ç»„
    elementData = Arrays.copyOf(elementData, newCapacity);
}

private static int hugeCapacity(int minCapacity) {
    if (minCapacity < 0)
        throw new OutOfMemoryError();
    return (minCapacity > MAX_ARRAY_SIZE) ?
        Integer.MAX_VALUE :
        MAX_ARRAY_SIZE;
}
```

### æ‰©å®¹ç¤ºä¾‹

```
åˆå§‹ï¼šelementData = []ï¼ˆé»˜è®¤ç©ºæ•°ç»„ï¼‰

ç¬¬1æ¬¡addï¼š
  minCapacity = max(10, 1) = 10
  grow(10)
  newCapacity = 0 + 0 = 0ï¼ˆä¸å¤Ÿï¼‰
  newCapacity = 10
  elementData = new Object[10]

ç¬¬11æ¬¡addï¼š
  minCapacity = 11
  grow(11)
  newCapacity = 10 + 5 = 15
  elementData = Arrays.copyOf(elementData, 15)

ç¬¬16æ¬¡addï¼š
  minCapacity = 16
  grow(16)
  newCapacity = 15 + 7 = 22
  elementData = Arrays.copyOf(elementData, 22)

æ‰©å®¹è§„å¾‹ï¼š
  10 â†’ 15 â†’ 22 â†’ 33 â†’ 49 â†’ ...
  æ¯æ¬¡æ‰©å®¹çº¦1.5å€
```

### ä¸ºä»€ä¹ˆæ˜¯1.5å€ï¼Ÿ

```
æ‰©å®¹å€æ•°é€‰æ‹©ï¼š

1.5å€çš„ä¼˜åŠ¿ï¼š
  1. ç©ºé—´åˆ©ç”¨ç‡è¾ƒé«˜
  2. æ‰©å®¹æ¬¡æ•°é€‚ä¸­
  3. å¯ä»¥å¤ç”¨ä¹‹å‰é‡Šæ”¾çš„å†…å­˜

å¯¹æ¯”ï¼š
  - 2å€æ‰©å®¹ï¼šç©ºé—´æµªè´¹å¤šï¼Œä½†æ‰©å®¹æ¬¡æ•°å°‘
  - 1.5å€æ‰©å®¹ï¼šç©ºé—´åˆ©ç”¨ç‡å’Œæ‰©å®¹æ¬¡æ•°çš„å¹³è¡¡

å†…å­˜å¤ç”¨ï¼š
  å‡è®¾åˆå§‹å®¹é‡4ï¼Œ2å€æ‰©å®¹ï¼š4 â†’ 8 â†’ 16 â†’ 32
  é‡Šæ”¾çš„å†…å­˜ï¼š4 + 8 + 16 = 28 < 32
  æ— æ³•å¤ç”¨ä¹‹å‰çš„å†…å­˜

  1.5å€æ‰©å®¹ï¼š4 â†’ 6 â†’ 9 â†’ 13 â†’ 19
  é‡Šæ”¾çš„å†…å­˜ï¼š4 + 6 + 9 + 13 = 32 > 19
  å¯ä»¥å¤ç”¨ä¹‹å‰çš„å†…å­˜
```

---

## åˆ é™¤å…ƒç´ 

### remove(int index)

```java
/**
 * åˆ é™¤æŒ‡å®šä½ç½®çš„å…ƒç´ 
 */
public E remove(int index) {
    // 1. æ£€æŸ¥ç´¢å¼•
    rangeCheck(index);
    
    modCount++;
    
    // 2. è·å–æ—§å€¼
    E oldValue = elementData(index);
    
    // 3. è®¡ç®—éœ€è¦ç§»åŠ¨çš„å…ƒç´ æ•°é‡
    int numMoved = size - index - 1;
    if (numMoved > 0)
        // 4. ç§»åŠ¨å…ƒç´ ï¼ˆindexåçš„å…ƒç´ å‰ç§»ä¸€ä½ï¼‰
        System.arraycopy(elementData, index+1, elementData, index, numMoved);
    
    // 5. æœ€åä¸€ä¸ªä½ç½®ç½®nullï¼ˆhelp GCï¼‰
    elementData[--size] = null;
    
    return oldValue;
}

private void rangeCheck(int index) {
    if (index >= size)
        throw new IndexOutOfBoundsException(outOfBoundsMsg(index));
}
```

### remove(Object o)

```java
/**
 * åˆ é™¤ç¬¬ä¸€ä¸ªåŒ¹é…çš„å…ƒç´ 
 */
public boolean remove(Object o) {
    if (o == null) {
        for (int index = 0; index < size; index++)
            if (elementData[index] == null) {
                fastRemove(index);
                return true;
            }
    } else {
        for (int index = 0; index < size; index++)
            if (o.equals(elementData[index])) {
                fastRemove(index);
                return true;
            }
    }
    return false;
}

// å¿«é€Ÿåˆ é™¤ï¼ˆä¸æ£€æŸ¥ç´¢å¼•ï¼Œä¸è¿”å›æ—§å€¼ï¼‰
private void fastRemove(int index) {
    modCount++;
    int numMoved = size - index - 1;
    if (numMoved > 0)
        System.arraycopy(elementData, index+1, elementData, index, numMoved);
    elementData[--size] = null;
}
```

### åˆ é™¤æµç¨‹å›¾

```
remove(index)
    â†“
æ£€æŸ¥ç´¢å¼•èŒƒå›´
    â†“
è·å–æ—§å€¼ oldValue = elementData[index]
    â†“
è®¡ç®—ç§»åŠ¨æ•°é‡ numMoved = size - index - 1
    â†“
numMoved > 0?
    â†“ æ˜¯
System.arraycopy(index+1 â†’ index)
    â†“
elementData[--size] = null
    â†“
è¿”å›oldValue

ç¤ºä¾‹ï¼šåˆ é™¤index=2
[A][B][C][D][E] size=5
       â†“
[A][B][D][E][null] size=4
```

---

## å…¶ä»–é‡è¦æ–¹æ³•

### getå’Œset

```java
/**
 * è·å–å…ƒç´ ï¼ˆO(1)ï¼‰
 */
public E get(int index) {
    rangeCheck(index);
    return elementData(index);
}

E elementData(int index) {
    return (E) elementData[index];
}

/**
 * è®¾ç½®å…ƒç´ ï¼ˆO(1)ï¼‰
 */
public E set(int index, E element) {
    rangeCheck(index);
    E oldValue = elementData(index);
    elementData[index] = element;
    return oldValue;
}
```

### clear

```java
/**
 * æ¸…ç©ºåˆ—è¡¨
 */
public void clear() {
    modCount++;
    
    // æ‰€æœ‰å…ƒç´ ç½®nullï¼ˆhelp GCï¼‰
    for (int i = 0; i < size; i++)
        elementData[i] = null;
    
    size = 0;
}
```

### trimToSize

```java
/**
 * ç¼©å®¹ï¼šå°†æ•°ç»„å¤§å°è°ƒæ•´ä¸ºå®é™…å…ƒç´ æ•°é‡
 */
public void trimToSize() {
    modCount++;
    if (size < elementData.length) {
        elementData = (size == 0)
          ? EMPTY_ELEMENTDATA
          : Arrays.copyOf(elementData, size);
    }
}

// ä½¿ç”¨åœºæ™¯ï¼š
// å¤§é‡åˆ é™¤åï¼Œé‡Šæ”¾å¤šä½™ç©ºé—´
list.trimToSize();
```

---

## é¢è¯•è¦ç‚¹

### 1. ArrayListæ‰©å®¹æœºåˆ¶

```
Q: ArrayListçš„æ‰©å®¹æœºåˆ¶æ˜¯ä»€ä¹ˆï¼Ÿ

A:
1. é»˜è®¤åˆå§‹å®¹é‡ï¼š10ï¼ˆæ‡’åŠ è½½ï¼Œç¬¬ä¸€æ¬¡addæ—¶åˆ†é…ï¼‰
2. æ‰©å®¹æ—¶æœºï¼šsize + 1 > æ•°ç»„é•¿åº¦
3. æ‰©å®¹å¤§å°ï¼šåŸå®¹é‡çš„1.5å€ï¼ˆoldCapacity + oldCapacity >> 1ï¼‰
4. æ‰©å®¹æ–¹å¼ï¼šArrays.copyOf()åˆ›å»ºæ–°æ•°ç»„

æ‰©å®¹è¿‡ç¨‹ï¼š
  10 â†’ 15 â†’ 22 â†’ 33 â†’ 49 â†’ ...
```

### 2. ArrayList vs LinkedList

```
Q: ArrayListå’ŒLinkedListçš„åŒºåˆ«ï¼Ÿ

A:
| å¯¹æ¯”é¡¹ | ArrayList | LinkedList |
|--------|-----------|------------|
| åº•å±‚ç»“æ„ | æ•°ç»„ | åŒå‘é“¾è¡¨ |
| éšæœºè®¿é—® | O(1) | O(n) |
| å¤´éƒ¨æ’å…¥ | O(n) | O(1) |
| å°¾éƒ¨æ’å…¥ | O(1)å‡æ‘Š | O(1) |
| ä¸­é—´æ’å…¥ | O(n) | O(n) |
| å†…å­˜å ç”¨ | è¿ç»­ï¼Œè¾ƒå°‘ | ä¸è¿ç»­ï¼Œè¾ƒå¤š |
| ç¼“å­˜å‹å¥½ | æ˜¯ | å¦ |

ä½¿ç”¨å»ºè®®ï¼š
- éšæœºè®¿é—®å¤šï¼šArrayList
- å¤´éƒ¨æ’å…¥å¤šï¼šLinkedList
- å¤§å¤šæ•°åœºæ™¯ï¼šArrayListï¼ˆç¼“å­˜å‹å¥½ï¼‰
```

### 3. ä¸ºä»€ä¹ˆelementDataç”¨transient

```
Q: ä¸ºä»€ä¹ˆelementDataç”¨transientä¿®é¥°ï¼Ÿ

A:
1. elementDataæ•°ç»„å¯èƒ½æœ‰ç©ºä½
   - å®¹é‡15ï¼Œå®é™…å…ƒç´ 10
   - åºåˆ—åŒ–ç©ºä½æµªè´¹ç©ºé—´

2. ArrayListè‡ªå®šä¹‰åºåˆ—åŒ–
   - writeObject()åªåºåˆ—åŒ–å®é™…å…ƒç´ 
   - readObject()åªååºåˆ—åŒ–å®é™…å…ƒç´ 

private void writeObject(ObjectOutputStream s) {
    s.defaultWriteObject();
    s.writeInt(size);
    for (int i = 0; i < size; i++) {
        s.writeObject(elementData[i]);
    }
}
```

### 4. fail-fastæœºåˆ¶

```
Q: ä»€ä¹ˆæ˜¯fail-fastï¼Ÿ

A:
å¿«é€Ÿå¤±è´¥æœºåˆ¶ï¼š
  - è¿­ä»£è¿‡ç¨‹ä¸­æ£€æµ‹åˆ°å¹¶å‘ä¿®æ”¹
  - ç«‹å³æŠ›å‡ºConcurrentModificationException

å®ç°åŸç†ï¼š
  - modCountï¼šä¿®æ”¹æ¬¡æ•°
  - æ¯æ¬¡add/removeéƒ½ä¼šmodCount++
  - è¿­ä»£å™¨è®°å½•expectedModCount
  - æ¯æ¬¡next()æ£€æŸ¥modCount == expectedModCount

ç¤ºä¾‹ï¼š
List<String> list = new ArrayList<>();
list.add("A");
list.add("B");

for (String s : list) {
    list.remove(s);  // æŠ›å‡ºConcurrentModificationException
}

æ­£ç¡®åšæ³•ï¼š
Iterator<String> it = list.iterator();
while (it.hasNext()) {
    it.next();
    it.remove();  // ä½¿ç”¨è¿­ä»£å™¨çš„remove
}
```

### 5. çº¿ç¨‹å®‰å…¨é—®é¢˜

```
Q: ArrayListçº¿ç¨‹å®‰å…¨å—ï¼Ÿå¦‚ä½•ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Ÿ

A:
ArrayListä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚

è§£å†³æ–¹æ¡ˆï¼š

1. Collections.synchronizedList()
   List<String> list = Collections.synchronizedList(new ArrayList<>());
   // æ‰€æœ‰æ–¹æ³•åŠ synchronized

2. CopyOnWriteArrayList
   List<String> list = new CopyOnWriteArrayList<>();
   // å†™æ—¶å¤åˆ¶ï¼Œè¯»ä¸åŠ é”

3. æ‰‹åŠ¨åŠ é”
   synchronized (list) {
       list.add("A");
   }

æ¨èï¼š
- è¯»å¤šå†™å°‘ï¼šCopyOnWriteArrayList
- å†™å¤šï¼šCollections.synchronizedListæˆ–æ‰‹åŠ¨åŠ é”
```

---

## ğŸ’¡ æ€»ç»“

```
ArrayListæ ¸å¿ƒè¦ç‚¹ï¼š

1. åº•å±‚ç»“æ„ï¼š
   - Objectæ•°ç»„
   - æ”¯æŒéšæœºè®¿é—®O(1)

2. æ‰©å®¹æœºåˆ¶ï¼š
   - é»˜è®¤å®¹é‡10ï¼ˆæ‡’åŠ è½½ï¼‰
   - 1.5å€æ‰©å®¹
   - Arrays.copyOf()

3. æ·»åŠ åˆ é™¤ï¼š
   - å°¾éƒ¨æ·»åŠ O(1)å‡æ‘Š
   - ä¸­é—´æ’å…¥/åˆ é™¤O(n)
   - System.arraycopy()ç§»åŠ¨å…ƒç´ 

4. æ³¨æ„äº‹é¡¹ï¼š
   - éçº¿ç¨‹å®‰å…¨
   - fail-fastæœºåˆ¶
   - transient + è‡ªå®šä¹‰åºåˆ—åŒ–
```

---

*æœ€åæ›´æ–°ï¼š2025-12-28*
