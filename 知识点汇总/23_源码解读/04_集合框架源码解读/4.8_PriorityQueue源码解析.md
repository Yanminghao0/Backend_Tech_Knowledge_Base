# PriorityQueueæºç è§£æ

> æ·±å…¥åˆ†æJDKä¼˜å…ˆçº§é˜Ÿåˆ—å®ç°åŸç†ï¼ŒæŒæ¡å †æ•°æ®ç»“æ„çš„æ ¸å¿ƒæœºåˆ¶

---

## ğŸ“š ç›®å½•

1. [æ•´ä½“æ¶æ„](#1-æ•´ä½“æ¶æ„)
2. [æ ¸å¿ƒå±æ€§](#2-æ ¸å¿ƒå±æ€§)
3. [å †ç»“æ„åŸç†](#3-å †ç»“æ„åŸç†)
4. [æ ¸å¿ƒæ–¹æ³•æºç ](#4-æ ¸å¿ƒæ–¹æ³•æºç )
5. [æ‰©å®¹æœºåˆ¶](#5-æ‰©å®¹æœºåˆ¶)
6. [è¿­ä»£å™¨å®ç°](#6-è¿­ä»£å™¨å®ç°)
7. [æµç¨‹å›¾è§£](#7-æµç¨‹å›¾è§£)
8. [é¢è¯•è¦ç‚¹](#8-é¢è¯•è¦ç‚¹)

---

## 1. æ•´ä½“æ¶æ„

### 1.1 ç±»ç»§æ‰¿ç»“æ„

```
PriorityQueue<E>
â”œâ”€â”€ extends AbstractQueue<E>
â”‚   â””â”€â”€ extends AbstractCollection<E>
â”‚       â””â”€â”€ implements Collection<E>
â”œâ”€â”€ implements Queue<E>
â””â”€â”€ implements Serializable
```

### 1.2 æ ¸å¿ƒè®¾è®¡æ€æƒ³

```java
/**
 * PriorityQueueï¼šåŸºäºå †çš„ä¼˜å…ˆçº§é˜Ÿåˆ—
 * 
 * æ ¸å¿ƒç‰¹æ€§ï¼š
 * 1. åŸºäºæ•°ç»„å®ç°çš„å®Œå…¨äºŒå‰æ ‘ï¼ˆå †ï¼‰
 * 2. é»˜è®¤å°é¡¶å †ï¼Œé˜Ÿé¦–æ˜¯æœ€å°å…ƒç´ 
 * 3. ä¸å…è®¸nullå…ƒç´ 
 * 4. éçº¿ç¨‹å®‰å…¨
 * 5. æ’å…¥å’Œåˆ é™¤æ—¶é—´å¤æ‚åº¦O(log n)
 */
public class PriorityQueue<E> extends AbstractQueue<E>
        implements java.io.Serializable {
    
    // é»˜è®¤åˆå§‹å®¹é‡
    private static final int DEFAULT_INITIAL_CAPACITY = 11;
    
    // å­˜å‚¨å…ƒç´ çš„æ•°ç»„ï¼ˆå †ï¼‰
    transient Object[] queue;
    
    // å…ƒç´ æ•°é‡
    private int size = 0;
    
    // æ¯”è¾ƒå™¨ï¼ˆnullè¡¨ç¤ºä½¿ç”¨è‡ªç„¶é¡ºåºï¼‰
    private final Comparator<? super E> comparator;
    
    // ä¿®æ”¹æ¬¡æ•°ï¼ˆç”¨äºå¿«é€Ÿå¤±è´¥ï¼‰
    transient int modCount = 0;
}
```


---

## 2. æ ¸å¿ƒå±æ€§

### 2.1 å±æ€§è¯¦è§£

```java
public class PriorityQueue<E> extends AbstractQueue<E> {
    
    /**
     * é»˜è®¤åˆå§‹å®¹é‡
     */
    private static final int DEFAULT_INITIAL_CAPACITY = 11;
    
    /**
     * å­˜å‚¨å…ƒç´ çš„æ•°ç»„
     * - ä½¿ç”¨æ•°ç»„è¡¨ç¤ºå®Œå…¨äºŒå‰æ ‘
     * - queue[0] æ˜¯å †é¡¶ï¼ˆæœ€å°/æœ€å¤§å…ƒç´ ï¼‰
     * - queue[n] çš„å·¦å­èŠ‚ç‚¹æ˜¯ queue[2*n+1]
     * - queue[n] çš„å³å­èŠ‚ç‚¹æ˜¯ queue[2*n+2]
     * - queue[n] çš„çˆ¶èŠ‚ç‚¹æ˜¯ queue[(n-1)/2]
     */
    transient Object[] queue;
    
    /**
     * å…ƒç´ æ•°é‡
     */
    private int size = 0;
    
    /**
     * æ¯”è¾ƒå™¨
     * - nullè¡¨ç¤ºä½¿ç”¨å…ƒç´ çš„è‡ªç„¶é¡ºåºï¼ˆComparableï¼‰
     * - énullè¡¨ç¤ºä½¿ç”¨æŒ‡å®šçš„æ¯”è¾ƒå™¨
     */
    private final Comparator<? super E> comparator;
    
    /**
     * ä¿®æ”¹æ¬¡æ•°
     * - ç”¨äºè¿­ä»£å™¨çš„å¿«é€Ÿå¤±è´¥æœºåˆ¶
     */
    transient int modCount = 0;
}
```

### 2.2 æ„é€ æ–¹æ³•

```java
/**
 * é»˜è®¤æ„é€ ï¼šå®¹é‡11ï¼Œè‡ªç„¶é¡ºåº
 */
public PriorityQueue() {
    this(DEFAULT_INITIAL_CAPACITY, null);
}

/**
 * æŒ‡å®šåˆå§‹å®¹é‡
 */
public PriorityQueue(int initialCapacity) {
    this(initialCapacity, null);
}

/**
 * æŒ‡å®šæ¯”è¾ƒå™¨
 */
public PriorityQueue(Comparator<? super E> comparator) {
    this(DEFAULT_INITIAL_CAPACITY, comparator);
}

/**
 * æŒ‡å®šå®¹é‡å’Œæ¯”è¾ƒå™¨
 */
public PriorityQueue(int initialCapacity, Comparator<? super E> comparator) {
    if (initialCapacity < 1)
        throw new IllegalArgumentException();
    this.queue = new Object[initialCapacity];
    this.comparator = comparator;
}

/**
 * ä»é›†åˆæ„é€ 
 */
public PriorityQueue(Collection<? extends E> c) {
    if (c instanceof SortedSet<?>) {
        SortedSet<? extends E> ss = (SortedSet<? extends E>) c;
        this.comparator = (Comparator<? super E>) ss.comparator();
        initElementsFromCollection(ss);
    }
    else if (c instanceof PriorityQueue<?>) {
        PriorityQueue<? extends E> pq = (PriorityQueue<? extends E>) c;
        this.comparator = (Comparator<? super E>) pq.comparator();
        initFromPriorityQueue(pq);
    }
    else {
        this.comparator = null;
        initFromCollection(c);
    }
}
```

---

## 3. å †ç»“æ„åŸç†

### 3.1 å®Œå…¨äºŒå‰æ ‘çš„æ•°ç»„è¡¨ç¤º

```
å †çš„æ•°ç»„è¡¨ç¤ºï¼ˆå°é¡¶å †ç¤ºä¾‹ï¼‰ï¼š

æ•°ç»„ç´¢å¼•ï¼š  0    1    2    3    4    5    6
æ•°ç»„å†…å®¹ï¼š [1]  [3]  [2]  [6]  [5]  [7]  [8]

å¯¹åº”çš„å®Œå…¨äºŒå‰æ ‘ï¼š
                    1 (index=0)
                   / \
                  /   \
           3 (1)       2 (2)
           / \         / \
          /   \       /   \
       6 (3)  5 (4) 7 (5)  8 (6)

ç´¢å¼•å…³ç³»ï¼š
- çˆ¶èŠ‚ç‚¹ç´¢å¼•ï¼šparent(i) = (i - 1) / 2
- å·¦å­èŠ‚ç‚¹ç´¢å¼•ï¼šleft(i) = 2 * i + 1
- å³å­èŠ‚ç‚¹ç´¢å¼•ï¼šright(i) = 2 * i + 2

å †æ€§è´¨ï¼ˆå°é¡¶å †ï¼‰ï¼š
- ä»»æ„èŠ‚ç‚¹çš„å€¼ <= å…¶å­èŠ‚ç‚¹çš„å€¼
- å †é¡¶ï¼ˆqueue[0]ï¼‰æ˜¯æœ€å°å€¼
```

### 3.2 å †æ“ä½œå›¾è§£

```
ä¸Šæµ®æ“ä½œï¼ˆsiftUpï¼‰- æ’å…¥æ–°å…ƒç´ åè°ƒæ•´ï¼š

æ’å…¥å…ƒç´ 0åˆ°æœ«å°¾ï¼š
[1, 3, 2, 6, 5, 7, 8, 0]
                       â†‘ æ–°å…ƒç´ 

Step 1: 0 < 6ï¼Œäº¤æ¢
[1, 3, 2, 0, 5, 7, 8, 6]
            â†‘

Step 2: 0 < 3ï¼Œäº¤æ¢
[1, 0, 2, 3, 5, 7, 8, 6]
    â†‘

Step 3: 0 < 1ï¼Œäº¤æ¢
[0, 1, 2, 3, 5, 7, 8, 6]
 â†‘ å®Œæˆ

---

ä¸‹æ²‰æ“ä½œï¼ˆsiftDownï¼‰- åˆ é™¤å †é¡¶åè°ƒæ•´ï¼š

åˆ é™¤å †é¡¶1ï¼Œç”¨æœ€åå…ƒç´ 6æ›¿æ¢ï¼š
[6, 3, 2, _, 5, 7, 8]
 â†‘ éœ€è¦ä¸‹æ²‰

Step 1: æ¯”è¾ƒ6å’Œå­èŠ‚ç‚¹3ã€2ï¼Œ2æœ€å°ï¼Œäº¤æ¢
[2, 3, 6, _, 5, 7, 8]
       â†‘

Step 2: æ¯”è¾ƒ6å’Œå­èŠ‚ç‚¹7ã€8ï¼Œ6æœ€å°ï¼Œåœæ­¢
[2, 3, 6, _, 5, 7, 8]
       â†‘ å®Œæˆ
```

---

## 4. æ ¸å¿ƒæ–¹æ³•æºç 

### 4.1 offer - æ’å…¥å…ƒç´ 

```java
/**
 * æ’å…¥å…ƒç´ åˆ°é˜Ÿåˆ—
 * æ—¶é—´å¤æ‚åº¦ï¼šO(log n)
 */
public boolean offer(E e) {
    if (e == null)
        throw new NullPointerException();  // ä¸å…è®¸null
    modCount++;
    int i = size;
    if (i >= queue.length)
        grow(i + 1);  // æ‰©å®¹
    size = i + 1;
    if (i == 0)
        queue[0] = e;  // ç¬¬ä¸€ä¸ªå…ƒç´ ç›´æ¥æ”¾å…¥
    else
        siftUp(i, e);  // ä¸Šæµ®è°ƒæ•´
    return true;
}

/**
 * ä¸Šæµ®æ“ä½œ
 */
private void siftUp(int k, E x) {
    if (comparator != null)
        siftUpUsingComparator(k, x);
    else
        siftUpComparable(k, x);
}

/**
 * ä½¿ç”¨è‡ªç„¶é¡ºåºçš„ä¸Šæµ®
 */
@SuppressWarnings("unchecked")
private void siftUpComparable(int k, E x) {
    Comparable<? super E> key = (Comparable<? super E>) x;
    while (k > 0) {
        int parent = (k - 1) >>> 1;  // çˆ¶èŠ‚ç‚¹ç´¢å¼•
        Object e = queue[parent];
        // å¦‚æœæ–°å…ƒç´  >= çˆ¶èŠ‚ç‚¹ï¼Œåœæ­¢
        if (key.compareTo((E) e) >= 0)
            break;
        // çˆ¶èŠ‚ç‚¹ä¸‹ç§»
        queue[k] = e;
        k = parent;
    }
    queue[k] = key;
}

/**
 * ä½¿ç”¨æ¯”è¾ƒå™¨çš„ä¸Šæµ®
 */
@SuppressWarnings("unchecked")
private void siftUpUsingComparator(int k, E x) {
    while (k > 0) {
        int parent = (k - 1) >>> 1;
        Object e = queue[parent];
        if (comparator.compare(x, (E) e) >= 0)
            break;
        queue[k] = e;
        k = parent;
    }
    queue[k] = x;
}
```

### 4.2 poll - ç§»é™¤å †é¡¶

```java
/**
 * ç§»é™¤å¹¶è¿”å›å †é¡¶å…ƒç´ 
 * æ—¶é—´å¤æ‚åº¦ï¼šO(log n)
 */
@SuppressWarnings("unchecked")
public E poll() {
    if (size == 0)
        return null;
    int s = --size;
    modCount++;
    E result = (E) queue[0];  // å †é¡¶å…ƒç´ 
    E x = (E) queue[s];       // æœ€åä¸€ä¸ªå…ƒç´ 
    queue[s] = null;          // æ¸…é™¤å¼•ç”¨
    if (s != 0)
        siftDown(0, x);       // ä¸‹æ²‰è°ƒæ•´
    return result;
}

/**
 * ä¸‹æ²‰æ“ä½œ
 */
private void siftDown(int k, E x) {
    if (comparator != null)
        siftDownUsingComparator(k, x);
    else
        siftDownComparable(k, x);
}

/**
 * ä½¿ç”¨è‡ªç„¶é¡ºåºçš„ä¸‹æ²‰
 */
@SuppressWarnings("unchecked")
private void siftDownComparable(int k, E x) {
    Comparable<? super E> key = (Comparable<? super E>)x;
    int half = size >>> 1;  // éå¶å­èŠ‚ç‚¹çš„æœ€å¤§ç´¢å¼•+1
    while (k < half) {
        int child = (k << 1) + 1;  // å·¦å­èŠ‚ç‚¹
        Object c = queue[child];
        int right = child + 1;
        // é€‰æ‹©è¾ƒå°çš„å­èŠ‚ç‚¹
        if (right < size &&
            ((Comparable<? super E>) c).compareTo((E) queue[right]) > 0)
            c = queue[child = right];
        // å¦‚æœkey <= è¾ƒå°å­èŠ‚ç‚¹ï¼Œåœæ­¢
        if (key.compareTo((E) c) <= 0)
            break;
        // å­èŠ‚ç‚¹ä¸Šç§»
        queue[k] = c;
        k = child;
    }
    queue[k] = key;
}
```

### 4.3 peek - æŸ¥çœ‹å †é¡¶

```java
/**
 * è¿”å›å †é¡¶å…ƒç´ ä½†ä¸ç§»é™¤
 * æ—¶é—´å¤æ‚åº¦ï¼šO(1)
 */
@SuppressWarnings("unchecked")
public E peek() {
    return (size == 0) ? null : (E) queue[0];
}
```

### 4.4 remove - ç§»é™¤æŒ‡å®šå…ƒç´ 

```java
/**
 * ç§»é™¤æŒ‡å®šå…ƒç´ 
 * æ—¶é—´å¤æ‚åº¦ï¼šO(n)
 */
public boolean remove(Object o) {
    int i = indexOf(o);  // æŸ¥æ‰¾å…ƒç´ ç´¢å¼•
    if (i == -1)
        return false;
    else {
        removeAt(i);
        return true;
    }
}

/**
 * æŸ¥æ‰¾å…ƒç´ ç´¢å¼•
 */
private int indexOf(Object o) {
    if (o != null) {
        for (int i = 0; i < size; i++)
            if (o.equals(queue[i]))
                return i;
    }
    return -1;
}

/**
 * ç§»é™¤æŒ‡å®šç´¢å¼•çš„å…ƒç´ 
 */
@SuppressWarnings("unchecked")
private E removeAt(int i) {
    modCount++;
    int s = --size;
    if (s == i)
        queue[i] = null;  // ç§»é™¤æœ€åä¸€ä¸ªå…ƒç´ 
    else {
        E moved = (E) queue[s];
        queue[s] = null;
        siftDown(i, moved);  // å…ˆå°è¯•ä¸‹æ²‰
        // å¦‚æœæ²¡æœ‰ä¸‹æ²‰ï¼Œå°è¯•ä¸Šæµ®
        if (queue[i] == moved) {
            siftUp(i, moved);
            if (queue[i] != moved)
                return moved;
        }
    }
    return null;
}
```

---

## 5. æ‰©å®¹æœºåˆ¶

### 5.1 growæ–¹æ³•

```java
/**
 * æ‰©å®¹
 */
private void grow(int minCapacity) {
    int oldCapacity = queue.length;
    // æ‰©å®¹ç­–ç•¥ï¼š
    // - å®¹é‡å°äº64æ—¶ï¼Œæ‰©å®¹ä¸º oldCapacity * 2 + 2
    // - å®¹é‡å¤§äºç­‰äº64æ—¶ï¼Œæ‰©å®¹ä¸º oldCapacity * 1.5
    int newCapacity = oldCapacity + ((oldCapacity < 64) ?
                                     (oldCapacity + 2) :
                                     (oldCapacity >> 1));
    // æ£€æŸ¥æ˜¯å¦è¶…è¿‡æœ€å¤§å®¹é‡
    if (newCapacity - MAX_ARRAY_SIZE > 0)
        newCapacity = hugeCapacity(minCapacity);
    queue = Arrays.copyOf(queue, newCapacity);
}

private static int hugeCapacity(int minCapacity) {
    if (minCapacity < 0)
        throw new OutOfMemoryError();
    return (minCapacity > MAX_ARRAY_SIZE) ?
        Integer.MAX_VALUE :
        MAX_ARRAY_SIZE;
}
```

### 5.2 æ‰©å®¹ç­–ç•¥å›¾è§£

```
æ‰©å®¹ç­–ç•¥ï¼š

å®¹é‡ < 64 æ—¶ï¼šnewCapacity = oldCapacity * 2 + 2
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 11 â†’ 24 â†’ 50 â†’ 102 (è¶…è¿‡64ï¼Œåˆ‡æ¢ç­–ç•¥)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å®¹é‡ >= 64 æ—¶ï¼šnewCapacity = oldCapacity * 1.5
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 64 â†’ 96 â†’ 144 â†’ 216 â†’ 324 â†’ ...               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åŸå› ï¼š
- å°å®¹é‡æ—¶å¿«é€Ÿæ‰©å®¹ï¼Œå‡å°‘æ‰©å®¹æ¬¡æ•°
- å¤§å®¹é‡æ—¶ç¼“æ…¢æ‰©å®¹ï¼Œé¿å…å†…å­˜æµªè´¹
```

---

## 6. è¿­ä»£å™¨å®ç°

### 6.1 è¿­ä»£å™¨ç‰¹ç‚¹

```java
/**
 * PriorityQueueçš„è¿­ä»£å™¨
 * 
 * æ³¨æ„ï¼šè¿­ä»£é¡ºåºä¸æ˜¯ä¼˜å…ˆçº§é¡ºåºï¼
 * è¿­ä»£å™¨æŒ‰æ•°ç»„é¡ºåºéå†ï¼Œä¸ä¿è¯å…ƒç´ çš„ä¼˜å…ˆçº§é¡ºåº
 */
private final class Itr implements Iterator<E> {
    private int cursor = 0;           // ä¸‹ä¸€ä¸ªè¿”å›çš„ç´¢å¼•
    private int lastRet = -1;         // ä¸Šä¸€ä¸ªè¿”å›çš„ç´¢å¼•
    private ArrayDeque<E> forgetMeNot = null;  // ç§»é™¤æ—¶å¯èƒ½éœ€è¦çš„å…ƒç´ 
    private E lastRetElt = null;      // ä¸Šä¸€ä¸ªè¿”å›çš„å…ƒç´ 
    private int expectedModCount = modCount;
    
    public boolean hasNext() {
        return cursor < size ||
            (forgetMeNot != null && !forgetMeNot.isEmpty());
    }
    
    @SuppressWarnings("unchecked")
    public E next() {
        if (expectedModCount != modCount)
            throw new ConcurrentModificationException();
        if (cursor < size)
            return (E) queue[lastRet = cursor++];
        if (forgetMeNot != null) {
            lastRet = -1;
            lastRetElt = forgetMeNot.poll();
            if (lastRetElt != null)
                return lastRetElt;
        }
        throw new NoSuchElementException();
    }
    
    public void remove() {
        if (expectedModCount != modCount)
            throw new ConcurrentModificationException();
        if (lastRet != -1) {
            E moved = PriorityQueue.this.removeAt(lastRet);
            lastRet = -1;
            if (moved == null)
                cursor--;
            else {
                if (forgetMeNot == null)
                    forgetMeNot = new ArrayDeque<>();
                forgetMeNot.add(moved);
            }
        } else if (lastRetElt != null) {
            PriorityQueue.this.removeEq(lastRetElt);
            lastRetElt = null;
        } else {
            throw new IllegalStateException();
        }
        expectedModCount = modCount;
    }
}
```

### 6.2 æŒ‰ä¼˜å…ˆçº§é¡ºåºéå†

```java
/**
 * å¦‚æœéœ€è¦æŒ‰ä¼˜å…ˆçº§é¡ºåºéå†ï¼Œä½¿ç”¨ä»¥ä¸‹æ–¹å¼
 */
public class PriorityQueueIteration {
    
    public static void main(String[] args) {
        PriorityQueue<Integer> pq = new PriorityQueue<>();
        pq.addAll(Arrays.asList(5, 3, 8, 1, 9, 2));
        
        // âŒ é”™è¯¯ï¼šè¿­ä»£å™¨ä¸ä¿è¯ä¼˜å…ˆçº§é¡ºåº
        System.out.println("è¿­ä»£å™¨é¡ºåºï¼ˆä¸ä¿è¯ä¼˜å…ˆçº§ï¼‰ï¼š");
        for (Integer i : pq) {
            System.out.print(i + " ");  // å¯èƒ½è¾“å‡ºï¼š1 3 2 5 9 8
        }
        
        // âœ… æ­£ç¡®ï¼šä½¿ç”¨poll()æŒ‰ä¼˜å…ˆçº§é¡ºåº
        System.out.println("\nä¼˜å…ˆçº§é¡ºåºï¼š");
        while (!pq.isEmpty()) {
            System.out.print(pq.poll() + " ");  // è¾“å‡ºï¼š1 2 3 5 8 9
        }
    }
}
```


---

## 7. æµç¨‹å›¾è§£

### 7.1 offeræ“ä½œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    offer(e) æ“ä½œæµç¨‹                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  e == null?  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Yes                     â”‚ No
              â–¼                         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ æŠ›å‡ºNPE          â”‚      â”‚ éœ€è¦æ‰©å®¹?        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚ Yes             â”‚ No
                              â–¼                 â”‚
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
                       â”‚   grow()     â”‚         â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
                              â”‚                 â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚  size == 0?      â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚ Yes             â”‚ No
                              â–¼                 â–¼
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚queue[0] = e  â”‚  â”‚ siftUp(i, e) â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚                 â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚   return true    â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 pollæ“ä½œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    poll() æ“ä½œæµç¨‹                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  size == 0?  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Yes                     â”‚ No
              â–¼                         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   return null    â”‚      â”‚ result = queue[0]â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚ x = queue[--size]â”‚
                              â”‚ queue[size]=null â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚   size != 0?     â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚ Yes             â”‚ No
                              â–¼                 â”‚
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
                       â”‚siftDown(0,x) â”‚         â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
                              â”‚                 â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚  return result   â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.3 å †è°ƒæ•´åŠ¨ç”»

```
siftUp ä¸Šæµ®è¿‡ç¨‹ï¼ˆæ’å…¥å…ƒç´ 2ï¼‰ï¼š

åˆå§‹çŠ¶æ€ï¼š[1, 5, 3, 8, 7, 6, 4, _, _, _, 2]
                                        â†‘ æ–°å…ƒç´ ä½ç½®

Step 1: æ¯”è¾ƒ 2 å’Œçˆ¶èŠ‚ç‚¹ 7
        2 < 7ï¼Œäº¤æ¢
        [1, 5, 3, 8, 2, 6, 4, _, _, _, 7]
                     â†‘

Step 2: æ¯”è¾ƒ 2 å’Œçˆ¶èŠ‚ç‚¹ 5
        2 < 5ï¼Œäº¤æ¢
        [1, 2, 3, 8, 5, 6, 4, _, _, _, 7]
            â†‘

Step 3: æ¯”è¾ƒ 2 å’Œçˆ¶èŠ‚ç‚¹ 1
        2 > 1ï¼Œåœæ­¢
        [1, 2, 3, 8, 5, 6, 4, _, _, _, 7]
         â†‘ å †é¡¶ä¸å˜

---

siftDown ä¸‹æ²‰è¿‡ç¨‹ï¼ˆåˆ é™¤å †é¡¶åï¼‰ï¼š

åˆå§‹çŠ¶æ€ï¼š[7, 2, 3, 8, 5, 6, 4]  (7æ˜¯åŸæœ€åå…ƒç´ ï¼Œæ”¾åˆ°å †é¡¶)
           â†‘ éœ€è¦ä¸‹æ²‰

Step 1: æ¯”è¾ƒ 7 å’Œå­èŠ‚ç‚¹ 2, 3
        æœ€å°æ˜¯ 2ï¼Œäº¤æ¢
        [2, 7, 3, 8, 5, 6, 4]
            â†‘

Step 2: æ¯”è¾ƒ 7 å’Œå­èŠ‚ç‚¹ 8, 5
        æœ€å°æ˜¯ 5ï¼Œäº¤æ¢
        [2, 5, 3, 8, 7, 6, 4]
                  â†‘

Step 3: 7 æ²¡æœ‰å­èŠ‚ç‚¹ï¼Œåœæ­¢
        [2, 5, 3, 8, 7, 6, 4]
                  â†‘ å®Œæˆ
```

---

## 8. é¢è¯•è¦ç‚¹

### 8.1 é«˜é¢‘é¢è¯•é¢˜

```
Q1: PriorityQueueçš„å®ç°åŸç†ï¼Ÿ
A: åŸºäºæ•°ç»„å®ç°çš„å®Œå…¨äºŒå‰æ ‘ï¼ˆå †ï¼‰ï¼š
   - é»˜è®¤æ˜¯å°é¡¶å †ï¼Œå †é¡¶æ˜¯æœ€å°å…ƒç´ 
   - ä½¿ç”¨æ•°ç»„å­˜å‚¨ï¼Œé€šè¿‡ç´¢å¼•è®¡ç®—çˆ¶å­å…³ç³»
   - æ’å…¥å’Œåˆ é™¤æ—¶é€šè¿‡ä¸Šæµ®/ä¸‹æ²‰ç»´æŠ¤å †æ€§è´¨
   - æ—¶é—´å¤æ‚åº¦ï¼šæ’å…¥O(log n)ï¼Œåˆ é™¤O(log n)ï¼ŒæŸ¥çœ‹å †é¡¶O(1)

Q2: PriorityQueueçš„è¿­ä»£å™¨æ˜¯å¦æŒ‰ä¼˜å…ˆçº§é¡ºåºï¼Ÿ
A: ä¸æ˜¯ã€‚è¿­ä»£å™¨æŒ‰æ•°ç»„é¡ºåºéå†ï¼Œä¸ä¿è¯ä¼˜å…ˆçº§é¡ºåºã€‚
   å¦‚æœéœ€è¦æŒ‰ä¼˜å…ˆçº§é¡ºåºï¼Œåº”è¯¥ä½¿ç”¨poll()æ–¹æ³•ã€‚

Q3: PriorityQueueæ˜¯å¦å…è®¸nullï¼Ÿ
A: ä¸å…è®¸ã€‚æ’å…¥nullä¼šæŠ›å‡ºNullPointerExceptionã€‚

Q4: PriorityQueueæ˜¯å¦çº¿ç¨‹å®‰å…¨ï¼Ÿ
A: ä¸æ˜¯ã€‚å¤šçº¿ç¨‹ç¯å¢ƒä¸‹åº”ä½¿ç”¨PriorityBlockingQueueã€‚

Q5: å¦‚ä½•å®ç°å¤§é¡¶å †ï¼Ÿ
A: ä½¿ç”¨è‡ªå®šä¹‰æ¯”è¾ƒå™¨ï¼š
   PriorityQueue<Integer> maxHeap = 
       new PriorityQueue<>(Collections.reverseOrder());
   æˆ–
   PriorityQueue<Integer> maxHeap = 
       new PriorityQueue<>((a, b) -> b - a);
```

### 8.2 ä½¿ç”¨ç¤ºä¾‹

```java
/**
 * PriorityQueue ä½¿ç”¨ç¤ºä¾‹
 */
public class PriorityQueueDemo {
    
    public static void main(String[] args) {
        // 1. å°é¡¶å †ï¼ˆé»˜è®¤ï¼‰
        PriorityQueue<Integer> minHeap = new PriorityQueue<>();
        minHeap.addAll(Arrays.asList(5, 3, 8, 1, 9, 2));
        System.out.println("å°é¡¶å †é¡¶ï¼š" + minHeap.peek());  // 1
        
        // 2. å¤§é¡¶å †
        PriorityQueue<Integer> maxHeap = 
            new PriorityQueue<>(Collections.reverseOrder());
        maxHeap.addAll(Arrays.asList(5, 3, 8, 1, 9, 2));
        System.out.println("å¤§é¡¶å †é¡¶ï¼š" + maxHeap.peek());  // 9
        
        // 3. è‡ªå®šä¹‰å¯¹è±¡
        PriorityQueue<Task> taskQueue = new PriorityQueue<>(
            Comparator.comparingInt(t -> t.priority)
        );
        taskQueue.offer(new Task("ä½ä¼˜å…ˆçº§", 3));
        taskQueue.offer(new Task("é«˜ä¼˜å…ˆçº§", 1));
        taskQueue.offer(new Task("ä¸­ä¼˜å…ˆçº§", 2));
        
        while (!taskQueue.isEmpty()) {
            System.out.println(taskQueue.poll().name);
        }
        // è¾“å‡ºï¼šé«˜ä¼˜å…ˆçº§ã€ä¸­ä¼˜å…ˆçº§ã€ä½ä¼˜å…ˆçº§
    }
    
    static class Task {
        String name;
        int priority;
        Task(String name, int priority) {
            this.name = name;
            this.priority = priority;
        }
    }
}
```

### 8.3 å…¸å‹åº”ç”¨åœºæ™¯

```java
/**
 * PriorityQueue å…¸å‹åº”ç”¨
 */
public class PriorityQueueApplications {
    
    // 1. Top K é—®é¢˜ - æ‰¾æœ€å¤§çš„Kä¸ªæ•°
    public int[] topK(int[] nums, int k) {
        // ä½¿ç”¨å°é¡¶å †ï¼Œä¿æŒå †å¤§å°ä¸ºk
        PriorityQueue<Integer> minHeap = new PriorityQueue<>();
        for (int num : nums) {
            minHeap.offer(num);
            if (minHeap.size() > k) {
                minHeap.poll();  // ç§»é™¤æœ€å°çš„
            }
        }
        return minHeap.stream().mapToInt(i -> i).toArray();
    }
    
    // 2. åˆå¹¶Kä¸ªæœ‰åºé“¾è¡¨
    public ListNode mergeKLists(ListNode[] lists) {
        PriorityQueue<ListNode> pq = new PriorityQueue<>(
            Comparator.comparingInt(n -> n.val)
        );
        for (ListNode node : lists) {
            if (node != null) pq.offer(node);
        }
        
        ListNode dummy = new ListNode(0);
        ListNode curr = dummy;
        while (!pq.isEmpty()) {
            ListNode min = pq.poll();
            curr.next = min;
            curr = curr.next;
            if (min.next != null) {
                pq.offer(min.next);
            }
        }
        return dummy.next;
    }
    
    // 3. ä»»åŠ¡è°ƒåº¦
    public void scheduleTask() {
        PriorityQueue<ScheduledTask> scheduler = new PriorityQueue<>(
            Comparator.comparingLong(t -> t.executeTime)
        );
        // æ·»åŠ ä»»åŠ¡
        scheduler.offer(new ScheduledTask("task1", System.currentTimeMillis() + 1000));
        scheduler.offer(new ScheduledTask("task2", System.currentTimeMillis() + 500));
        
        // æ‰§è¡Œä»»åŠ¡
        while (!scheduler.isEmpty()) {
            ScheduledTask task = scheduler.poll();
            // ç­‰å¾…åˆ°æ‰§è¡Œæ—¶é—´
            // æ‰§è¡Œä»»åŠ¡
        }
    }
    
    static class ListNode {
        int val;
        ListNode next;
        ListNode(int val) { this.val = val; }
    }
    
    static class ScheduledTask {
        String name;
        long executeTime;
        ScheduledTask(String name, long executeTime) {
            this.name = name;
            this.executeTime = executeTime;
        }
    }
}
```

### 8.4 æ³¨æ„äº‹é¡¹

```java
/**
 * ä½¿ç”¨PriorityQueueçš„æ³¨æ„äº‹é¡¹
 */
public class PriorityQueueNotes {
    
    // 1. å…ƒç´ å¿…é¡»å¯æ¯”è¾ƒ
    // âŒ é”™è¯¯ï¼šæ²¡æœ‰å®ç°Comparableä¹Ÿæ²¡æœ‰æä¾›Comparator
    // PriorityQueue<Object> pq = new PriorityQueue<>();
    // pq.offer(new Object());  // ClassCastException
    
    // âœ… æ­£ç¡®ï¼šå®ç°Comparableæˆ–æä¾›Comparator
    PriorityQueue<String> pq1 = new PriorityQueue<>();  // Stringå®ç°äº†Comparable
    PriorityQueue<Task> pq2 = new PriorityQueue<>(
        Comparator.comparingInt(t -> t.priority)
    );
    
    // 2. è¿­ä»£å™¨ä¸ä¿è¯é¡ºåº
    // âŒ é”™è¯¯ç†è§£ï¼šè®¤ä¸ºè¿­ä»£å™¨æŒ‰ä¼˜å…ˆçº§é¡ºåº
    // âœ… æ­£ç¡®ï¼šä½¿ç”¨poll()è·å–ä¼˜å…ˆçº§é¡ºåº
    
    // 3. éçº¿ç¨‹å®‰å…¨
    // âŒ å¤šçº¿ç¨‹ç›´æ¥ä½¿ç”¨
    // âœ… ä½¿ç”¨PriorityBlockingQueueæˆ–åŠ é”
    
    // 4. ä¸å…è®¸null
    // âŒ pq.offer(null);  // NullPointerException
    
    static class Task {
        int priority;
    }
}
```

---

## ğŸ“š æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **æ•°æ®ç»“æ„**ï¼šåŸºäºæ•°ç»„çš„å®Œå…¨äºŒå‰æ ‘ï¼ˆå †ï¼‰
2. **é»˜è®¤æ’åº**ï¼šå°é¡¶å †ï¼Œå †é¡¶æ˜¯æœ€å°å…ƒç´ 
3. **æ—¶é—´å¤æ‚åº¦**ï¼šæ’å…¥O(log n)ï¼Œåˆ é™¤O(log n)ï¼ŒæŸ¥çœ‹O(1)
4. **è¿­ä»£é¡ºåº**ï¼šä¸ä¿è¯ä¼˜å…ˆçº§é¡ºåº
5. **çº¿ç¨‹å®‰å…¨**ï¼šéçº¿ç¨‹å®‰å…¨

### é€‚ç”¨åœºæ™¯

- Top K é—®é¢˜
- ä»»åŠ¡è°ƒåº¦
- åˆå¹¶æœ‰åºåºåˆ—
- ä¼˜å…ˆçº§å¤„ç†

---

*æœ€åæ›´æ–°ï¼š2025-12-28*
