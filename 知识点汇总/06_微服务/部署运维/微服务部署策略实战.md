# å¾®æœåŠ¡éƒ¨ç½²ç­–ç•¥å®æˆ˜

> æ„å»ºå¯é é«˜æ•ˆçš„å¾®æœåŠ¡äº¤ä»˜æµæ°´çº¿

## ğŸ“‹ ç›®å½•

1. [å¾®æœåŠ¡éƒ¨ç½²æ¦‚è¿°](#1-å¾®æœåŠ¡éƒ¨ç½²æ¦‚è¿°)
2. [å®¹å™¨åŒ–åŸºç¡€ä¸Dockerå®æˆ˜](#2-å®¹å™¨åŒ–åŸºç¡€ä¸dockerå®æˆ˜)
3. [Kubernetesç¼–æ’ä¸ç®¡ç†](#3-kubernetesç¼–æ’ä¸ç®¡ç†)
4. [éƒ¨ç½²ç­–ç•¥è¯¦è§£](#4-éƒ¨ç½²ç­–ç•¥è¯¦è§£)
5. [CI/CDæµæ°´çº¿æ„å»º](#5-cicdæµæ°´çº¿æ„å»º)
6. [é…ç½®ç®¡ç†ä¸æœåŠ¡å‘ç°é›†æˆ](#6-é…ç½®ç®¡ç†ä¸æœåŠ¡å‘ç°é›†æˆ)
7. [ç›‘æ§ä¸æ—¥å¿—èšåˆ](#7-ç›‘æ§ä¸æ—¥å¿—èšåˆ)
8. [é«˜å¯ç”¨æ¶æ„è®¾è®¡](#8-é«˜å¯ç”¨æ¶æ„è®¾è®¡)
9. [éƒ¨ç½²å®‰å…¨æœ€ä½³å®è·µ](#9-éƒ¨ç½²å®‰å…¨æœ€ä½³å®è·µ)
10. [æ¡ˆä¾‹åˆ†æä¸ç»éªŒæ€»ç»“](#10-æ¡ˆä¾‹åˆ†æä¸ç»éªŒæ€»ç»“)

---

## 1. å¾®æœåŠ¡éƒ¨ç½²æ¦‚è¿°

### 1.1 ä¼ ç»Ÿéƒ¨ç½² vs å¾®æœåŠ¡éƒ¨ç½²

| ç»´åº¦ | ä¼ ç»Ÿå•ä½“éƒ¨ç½² | å¾®æœåŠ¡éƒ¨ç½² |
|------|------------|-----------|
| éƒ¨ç½²å•å…ƒ | æ•´ä¸ªåº”ç”¨ | ç‹¬ç«‹æœåŠ¡ |
| æŠ€æœ¯æ ˆ | ç»Ÿä¸€æŠ€æœ¯æ ˆ | å¤šè¯­è¨€å¤šæ¡†æ¶ |
| æ‰©å±•èƒ½åŠ› | æ•´ä½“æ‰©å±• | æŒ‰éœ€æœåŠ¡æ‰©å±• |
| æ•…éšœå½±å“ | æ•´ä½“åº”ç”¨ | å±€éƒ¨æœåŠ¡ |
| å‘å¸ƒå‘¨æœŸ | é•¿å‘¨æœŸ | çŸ­å‘¨æœŸé¢‘ç¹å‘å¸ƒ |
| å¤æ‚åº¦ | ä½ | é«˜ï¼ˆåè°ƒå¤šæœåŠ¡ï¼‰ |
| åŸºç¡€è®¾æ–½éœ€æ±‚ | ç®€å• | å¤æ‚ï¼ˆç¼–æ’ã€æœåŠ¡ç½‘æ ¼ç­‰ï¼‰ |

### 1.2 å¾®æœåŠ¡éƒ¨ç½²æŒ‘æˆ˜

- **æœåŠ¡åè°ƒ**ï¼šç®¡ç†æ•°åç”šè‡³æ•°ç™¾ä¸ªç‹¬ç«‹æœåŠ¡
- **ä¾èµ–ç®¡ç†**ï¼šå¤„ç†æœåŠ¡é—´å¤æ‚ä¾èµ–å…³ç³»
- **é…ç½®ç®¡ç†**ï¼šè·¨ç¯å¢ƒé…ç½®ä¸€è‡´æ€§ç»´æŠ¤
- **ç‰ˆæœ¬æ§åˆ¶**ï¼šå¤šæœåŠ¡ç‰ˆæœ¬å…¼å®¹æ€§ä¿è¯
- **éƒ¨ç½²é¢‘ç‡**ï¼šæ”¯æŒé«˜é¢‘æ¬¡å®‰å…¨å‘å¸ƒ
- **æ•…éšœéš”ç¦»**ï¼šé™åˆ¶å•ä¸ªæœåŠ¡æ•…éšœå½±å“èŒƒå›´
- **å¯è§‚æµ‹æ€§**ï¼šè·¨æœåŠ¡ç›‘æ§ä¸é—®é¢˜å®šä½
- **èµ„æºä¼˜åŒ–**ï¼šåˆç†åˆ†é…è®¡ç®—èµ„æº

### 1.3 éƒ¨ç½²ç­–ç•¥æ¼”è¿›

1. **æ‰‹åŠ¨éƒ¨ç½²**ï¼šè„šæœ¬+SSHï¼Œé€‚åˆåˆåˆ›é˜¶æ®µ
2. **è‡ªåŠ¨åŒ–éƒ¨ç½²**ï¼šCI/CDå·¥å…·+é…ç½®ç®¡ç†
3. **å®¹å™¨åŒ–éƒ¨ç½²**ï¼šDocker+ç¼–æ’å·¥å…·
4. **äº‘åŸç”Ÿéƒ¨ç½²**ï¼šKubernetes+æœåŠ¡ç½‘æ ¼
5. **Serverlesséƒ¨ç½²**ï¼šå‡½æ•°å³æœåŠ¡ï¼Œå‡å°‘åŸºç¡€è®¾æ–½ç®¡ç†

---

## 2. å®¹å™¨åŒ–åŸºç¡€ä¸Dockerå®æˆ˜

### 2.1 Dockeræ ¸å¿ƒæ¦‚å¿µ

- **é•œåƒ(Image)**ï¼šåŒ…å«ä»£ç ã€è¿è¡Œæ—¶ã€åº“ã€ç¯å¢ƒå˜é‡å’Œé…ç½®æ–‡ä»¶çš„ä¸å¯å˜æ¨¡æ¿
- **å®¹å™¨(Container)**ï¼šé•œåƒçš„å¯è¿è¡Œå®ä¾‹ï¼ŒåŒ…å«éš”ç¦»çš„æ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œå’Œè¿›ç¨‹ç©ºé—´
- **Dockerfile**ï¼šç”¨äºæ„å»ºé•œåƒçš„æ–‡æœ¬æ–‡ä»¶ï¼ŒåŒ…å«ä¸€ç³»åˆ—æŒ‡ä»¤
- **Docker Compose**ï¼šç”¨äºå®šä¹‰å’Œè¿è¡Œå¤šå®¹å™¨Dockeråº”ç”¨çš„å·¥å…·
- **é•œåƒä»“åº“**ï¼šå­˜å‚¨å’Œåˆ†å‘Dockeré•œåƒçš„ä»“åº“

### 2.2 å¾®æœåŠ¡Dockerfileæœ€ä½³å®è·µ

```dockerfile
# å¤šé˜¶æ®µæ„å»ºï¼šæ„å»ºé˜¶æ®µ
FROM maven:3.8.5-openjdk-17-slim AS build
WORKDIR /app
COPY pom.xml .
# ç¼“å­˜Mavenä¾èµ–
RUN mvn dependency:go-offline
COPY src ./src
RUN mvn package -DskipTests

# è¿è¡Œé˜¶æ®µ
FROM openjdk:17-jdk-slim
WORKDIR /app

# åˆ›å»ºérootç”¨æˆ·
RUN groupadd -r appuser && useradd -r -g appuser appuser

# è®¾ç½®æ—¶åŒº
ENV TZ=Asia/Shanghai
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

# å¤åˆ¶æ„å»ºäº§ç‰©
COPY --from=build /app/target/*.jar app.jar

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --retries=3 \
  CMD curl -f http://localhost:8080/actuator/health || exit 1

# åˆ‡æ¢åˆ°érootç”¨æˆ·
USER appuser

# JVMä¼˜åŒ–å‚æ•°
ENV JAVA_OPTS="-XX:+UseContainerSupport -XX:MaxRAMPercentage=75.0 -XX:+UseG1GC"

# å…¥å£ç‚¹
ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar app.jar"]
```

### 2.3 Docker Composeç¼–æ’

```yaml
version: '3.8'

services:
  order-service:
    build: ./order-service
    image: microservice-demo/order-service:1.0.0
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - DB_HOST=order-db
      - DB_PORT=5432
      - DB_NAME=orderdb
      - DB_USER=postgres
      - DB_PASSWORD=secret
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
    depends_on:
      - order-db
      - kafka
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 3s
      retries: 3

  inventory-service:
    build: ./inventory-service
    image: microservice-demo/inventory-service:1.0.0
    ports:
      - "8081:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - DB_HOST=inventory-db
      - REDIS_HOST=redis
    depends_on:
      - inventory-db
      - redis
    restart: unless-stopped

  order-db:
    image: postgres:14-alpine
    volumes:
      - order-db-data:/var/lib/postgresql/data
      - ./order-service/src/main/resources/db/schema.sql:/docker-entrypoint-initdb.d/1-schema.sql
    environment:
      - POSTGRES_DB=orderdb
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=secret
    ports:
      - "5432:5432"

  inventory-db:
    image: mysql:8.0
    volumes:
      - inventory-db-data:/var/lib/mysql
    environment:
      - MYSQL_DATABASE=inventorydb
      - MYSQL_ROOT_PASSWORD=secret
      - MYSQL_USER=appuser
      - MYSQL_PASSWORD=apppass
    ports:
      - "3306:3306"

  redis:
    image: redis:7-alpine
    volumes:
      - redis-data:/data
    ports:
      - "6379:6379"

  kafka:
    image: confluentinc/cp-kafka:7.3.0
    depends_on:
      - zookeeper
    environment:
      - KAFKA_BROKER_ID=1
      - KAFKA_ZOOKEEPER_CONNECT=zookeeper:2181
      - KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:9093
      - KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1
    ports:
      - "9092:9092"
      - "9093:9093"

  zookeeper:
    image: confluentinc/cp-zookeeper:7.3.0
    environment:
      - ZOOKEEPER_CLIENT_PORT=2181
      - ZOOKEEPER_TICK_TIME=2000
    ports:
      - "2181:2181"

volumes:
  order-db-data:
  inventory-db-data:
  redis-data:
```

### 2.4 é•œåƒä¼˜åŒ–ç­–ç•¥

1. **å¤šé˜¶æ®µæ„å»º**ï¼šå‡å°‘æœ€ç»ˆé•œåƒå¤§å°
2. **é€‚å½“åŸºç¡€é•œåƒ**ï¼šalpineç‰ˆæœ¬ä½“ç§¯æ›´å°
3. **åˆå¹¶RUNæŒ‡ä»¤**ï¼šå‡å°‘é•œåƒå±‚æ•°
4. **.dockerignoreæ–‡ä»¶**ï¼šæ’é™¤ä¸å¿…è¦æ–‡ä»¶
5. **é•œåƒæ ‡ç­¾ç®¡ç†**ï¼šè¯­ä¹‰åŒ–ç‰ˆæœ¬+ç¯å¢ƒæ ‡è¯†
6. **érootç”¨æˆ·è¿è¡Œ**ï¼šå¢å¼ºå®‰å…¨æ€§
7. **æ„å»ºç¼“å­˜åˆ©ç”¨**ï¼šåˆç†æ’åºDockerfileæŒ‡ä»¤
8. **é•œåƒæ‰«æ**ï¼šé›†æˆå®‰å…¨æ‰«æå·¥å…·

```dockerfile
# ä¼˜åŒ–ç¤ºä¾‹ï¼šåˆå¹¶RUNæŒ‡ä»¤
RUN apt-get update && \
    apt-get install -y --no-install-recommends curl && \
    rm -rf /var/lib/apt/lists/* && \
    curl -L https://example.com/binary > /usr/local/bin/binary && \
    chmod +x /usr/local/bin/binary
```

---

## 3. Kubernetesç¼–æ’ä¸ç®¡ç†

### 3.1 Kubernetesæ ¸å¿ƒç»„ä»¶

- **æ§åˆ¶å¹³é¢**ï¼šAPI Serverã€Controller Managerã€Schedulerã€etcd
- **èŠ‚ç‚¹ç»„ä»¶**ï¼šKubeletã€Kube-proxyã€å®¹å™¨è¿è¡Œæ—¶
- **æ ¸å¿ƒèµ„æº**ï¼šPodã€Serviceã€Deploymentã€StatefulSetã€ConfigMapã€Secret
- **ç½‘ç»œæ’ä»¶**ï¼šCalicoã€Flannelã€Weave Net
- **å­˜å‚¨æ’ä»¶**ï¼šCSIå…¼å®¹å­˜å‚¨é©±åŠ¨

### 3.2 å¾®æœåŠ¡Deploymenté…ç½®

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: order-service
  namespace: microservices
  labels:
    app: order-service
    version: v1.0.0
spec:
  replicas: 3
  selector:
    matchLabels:
      app: order-service
      version: v1.0.0
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  template:
    metadata:
      labels:
        app: order-service
        version: v1.0.0
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/path: "/actuator/prometheus"
        prometheus.io/port: "8080"
    spec:
      containers:
      - name: order-service
        image: microservice-demo/order-service:1.0.0
        ports:
        - containerPort: 8080
          name: http
        resources:
          requests:
            cpu: 200m
            memory: 256Mi
          limits:
            cpu: 500m
            memory: 512Mi
        env:
        - name: SPRING_PROFILES_ACTIVE
          value: "production"
        - name: SERVER_PORT
          value: "8080"
        - name: DB_HOST
          valueFrom:
            configMapKeyRef:
              name: order-service-config
              key: db.host
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: order-service-secrets
              key: db.password
        readinessProbe:
          httpGet:
            path: /actuator/health/readiness
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 3
          failureThreshold: 3
        livenessProbe:
          httpGet:
            path: /actuator/health/liveness
            port: 8080
          initialDelaySeconds: 60
          periodSeconds: 15
          timeoutSeconds: 3
          failureThreshold: 3
        volumeMounts:
        - name: config-volume
          mountPath: /app/config
      volumes:
      - name: config-volume
        configMap:
          name: order-service-config
```

### 3.3 æœåŠ¡æš´éœ²ä¸è´Ÿè½½å‡è¡¡

```yaml
# Serviceé…ç½®
apiVersion: v1
kind: Service
metadata:
  name: order-service
  namespace: microservices
spec:
  selector:
    app: order-service
  ports:
  - port: 80
    targetPort: http
    name: http
  type: ClusterIP

# Ingressé…ç½®
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: order-service-ingress
  namespace: microservices
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "300"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
spec:
  tls:
  - hosts:
    - api.example.com
    secretName: api-tls
  rules:
  - host: api.example.com
    http:
      paths:
      - path: /orders
        pathType: Prefix
        backend:
          service:
            name: order-service
            port:
              name: http
      - path: /inventory
        pathType: Prefix
        backend:
          service:
            name: inventory-service
            port:
              name: http
```

### 3.4 æœ‰çŠ¶æ€æœåŠ¡éƒ¨ç½²

```yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: user-db
  namespace: microservices
spec:
  serviceName: user-db
  replicas: 3
  selector:
    matchLabels:
      app: user-db
  template:
    metadata:
      labels:
        app: user-db
    spec:
      containers:
      - name: user-db
        image: postgres:14-alpine
        ports:
        - containerPort: 5432
        env:
        - name: POSTGRES_DB
          value: userdb
        - name: POSTGRES_USER
          valueFrom:
            secretKeyRef:
              name: user-db-secrets
              key: username
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: user-db-secrets
              key: password
        volumeMounts:
        - name: data
          mountPath: /var/lib/postgresql/data
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes: ["ReadWriteOnce"]
      resources:
        requests:
          storage: 10Gi
      storageClassName: "fast"
```

---

## 4. éƒ¨ç½²ç­–ç•¥è¯¦è§£

### 4.1 è“ç»¿éƒ¨ç½²

**åŸç†**ï¼šç»´æŠ¤ä¸¤ä¸ªç›¸åŒç¯å¢ƒï¼ˆè“ç»¿ï¼‰ï¼Œæ–°ç‰ˆæœ¬éƒ¨ç½²åˆ°éæ´»åŠ¨ç¯å¢ƒï¼Œæµ‹è¯•é€šè¿‡ååˆ‡æ¢æµé‡

**ä¼˜åŠ¿**ï¼šé›¶åœæœºæ—¶é—´ï¼Œå¿«é€Ÿå›æ»šèƒ½åŠ›
**åŠ£åŠ¿**ï¼šèµ„æºéœ€æ±‚é«˜ï¼Œéœ€è¦ä¸¤å€åŸºç¡€è®¾æ–½

**å®æ–½æ­¥éª¤**ï¼š
1. å‡†å¤‡ç»¿è‰²ç¯å¢ƒï¼ˆæ–°ç‰ˆæœ¬ï¼‰
2. éƒ¨ç½²æ–°ç‰ˆæœ¬åˆ°ç»¿è‰²ç¯å¢ƒ
3. è¿è¡Œæµ‹è¯•éªŒè¯ç»¿è‰²ç¯å¢ƒ
4. åˆ‡æ¢æµé‡åˆ°ç»¿è‰²ç¯å¢ƒ
5. ç›‘æ§ç³»ç»ŸçŠ¶æ€
6. é—®é¢˜å‘ç”Ÿæ—¶åˆ‡æ¢å›è“è‰²ç¯å¢ƒ

**Kuberneteså®ç°**ï¼š
```yaml
# ç»¿è‰²ç‰ˆæœ¬Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: order-service-green
  # ...å…¶ä»–é…ç½®ä¸è“è‰²ç‰ˆæœ¬ç›¸åŒ
  template:
    spec:
      containers:
      - name: order-service
        image: microservice-demo/order-service:1.1.0
        # ...
---
# åˆ‡æ¢Serviceé€‰æ‹©å™¨
apiVersion: v1
kind: Service
metadata:
  name: order-service
# ...
spec:
  selector:
    app: order-service
    version: green # ä»blueåˆ‡æ¢åˆ°green
```

### 4.2 é‡‘ä¸é›€å‘å¸ƒ

**åŸç†**ï¼šå°†æ–°ç‰ˆæœ¬é€æ­¥æ¨å¹¿ç»™éƒ¨åˆ†ç”¨æˆ·ï¼Œæ ¹æ®åé¦ˆå†³å®šæ˜¯å¦å…¨é‡å‘å¸ƒ

**ä¼˜åŠ¿**ï¼šé£é™©å¯æ§ï¼Œå¯åŸºäºæŒ‡æ ‡è‡ªåŠ¨/æ‰‹åŠ¨è°ƒæ•´æµé‡æ¯”ä¾‹
**åŠ£åŠ¿**ï¼šå®ç°å¤æ‚ï¼Œéœ€è¦æµé‡æ§åˆ¶èƒ½åŠ›

**å®æ–½æ–¹å¼**ï¼š
- åŸºäºæƒé‡çš„æµé‡åˆ†é…
- åŸºäºç”¨æˆ·ç‰¹å¾çš„æµé‡åˆ†é…
- åŸºäºè¯·æ±‚ç‰¹å¾çš„æµé‡åˆ†é…

**Istioå®ç°**ï¼š
```yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: order-service
spec:
  hosts:
  - order-service
  http:
  - route:
    - destination:
        host: order-service
        subset: v1
      weight: 90
    - destination:
        host: order-service
        subset: v2
      weight: 10
---
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: order-service
spec:
  host: order-service
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
```

### 4.3 æ»šåŠ¨æ›´æ–°

**åŸç†**ï¼šé€æ­¥æ›¿æ¢æ—§ç‰ˆæœ¬å®ä¾‹ï¼Œæ¯æ¬¡æ›¿æ¢ä¸€éƒ¨åˆ†ï¼Œç›´åˆ°å…¨éƒ¨æ›´æ–°å®Œæˆ

**ä¼˜åŠ¿**ï¼šèµ„æºéœ€æ±‚ä½ï¼Œæ— éœ€é¢å¤–ç¯å¢ƒ
**åŠ£åŠ¿**ï¼šæ›´æ–°è¿‡ç¨‹ä¸­ç³»ç»Ÿå­˜åœ¨ç‰ˆæœ¬æ··åˆ

**Kubernetesé…ç½®**ï¼š
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: order-service
spec:
  replicas: 5
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1        # æœ€å¤šå¯è¶…å‡ºæœŸæœ›å‰¯æœ¬æ•°çš„æ•°é‡
      maxUnavailable: 0  # æ›´æ–°è¿‡ç¨‹ä¸­ä¸å¯ç”¨çš„æœ€å¤§Podæ•°é‡
  # ...
```

### 4.4 ç°åº¦å‘å¸ƒ

**åŸç†**ï¼šåŸºäºç‰¹å®šæ¡ä»¶ï¼ˆç”¨æˆ·ã€åœ°åŒºã€åŠŸèƒ½æ ‡å¿—ï¼‰æ§åˆ¶æ–°ç‰ˆæœ¬å¯è§æ€§

**åŠŸèƒ½æ ‡å¿—å®ç°**ï¼š
```java
@RestController
@RequestMapping("/orders")
public class OrderController {
    @Autowired
    private FeatureToggleService featureToggleService;
    @Autowired
    private OrderService orderService;
    @Autowired
    private NewOrderService newOrderService;

    @PostMapping
    public ResponseEntity<OrderDTO> createOrder(@RequestBody OrderRequest request) {
        // æ£€æŸ¥åŠŸèƒ½æ ‡å¿—
        if (featureToggleService.isEnabled("new-order-flow", request.getUserId())) {
            return ResponseEntity.ok(newOrderService.createOrder(request));
        } else {
            return ResponseEntity.ok(orderService.createOrder(request));
        }
    }
}
```

### 4.5 A/Bæµ‹è¯•

**åŸç†**ï¼šåŒæ—¶è¿è¡Œå¤šä¸ªç‰ˆæœ¬ï¼Œæ”¶é›†ç”¨æˆ·åé¦ˆæ•°æ®å†³å®šæœ€ä½³ç‰ˆæœ¬

**ä¸é‡‘ä¸é›€åŒºåˆ«**ï¼šA/Bæµ‹è¯•å…³æ³¨ç”¨æˆ·ä½“éªŒæŒ‡æ ‡ï¼Œè€Œéä»…éªŒè¯åŠŸèƒ½æ­£ç¡®æ€§

**å®æ–½å…³é”®**ï¼š
- æ˜ç¡®æµ‹è¯•ç›®æ ‡ä¸æˆåŠŸæŒ‡æ ‡
- ç¡®ä¿æ ·æœ¬é‡ç»Ÿè®¡æ˜¾è‘—æ€§
- æ§åˆ¶å˜é‡ï¼Œä¸€æ¬¡æµ‹è¯•ä¸€ä¸ªåŠŸèƒ½
- å®Œæ•´çš„æ•°æ®åˆ†æè®¡åˆ’

---

## 5. CI/CDæµæ°´çº¿æ„å»º

### 5.1 Jenkins Pipelineé…ç½®

```groovy
pipeline {
    agent any
    environment {
        DOCKER_REGISTRY = 'docker.example.com'
        SERVICE_NAME = 'order-service'
        VERSION = sh(script: 'git describe --tags --abbrev=0', returnStdout: true).trim()
        BUILD_NUMBER = currentBuild.number
        IMAGE_NAME = "${DOCKER_REGISTRY}/${SERVICE_NAME}:${VERSION}-${BUILD_NUMBER}"
    }
    stages {
        stage('Build & Test') {
            steps {
                sh 'mvn clean package -DskipTests'
                sh 'mvn test'
            }
            post {
                always {
                    junit '**/target/surefire-reports/TEST-*.xml'
                    archiveArtifacts artifacts: 'target/*.jar', fingerprint: true
                }
            }
        }
        stage('Code Quality') {
            steps {
                sh 'mvn sonar:sonar'
            }
        }
        stage('Build Docker Image') {
            steps {
                sh "docker build -t ${IMAGE_NAME} ."
                sh "docker tag ${IMAGE_NAME} ${DOCKER_REGISTRY}/${SERVICE_NAME}:latest"
            }
        }
        stage('Push Docker Image') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'docker-registry', passwordVariable: 'DOCKER_PASSWORD', usernameVariable: 'DOCKER_USERNAME')]) {
                    sh "docker login -u ${DOCKER_USERNAME} -p ${DOCKER_PASSWORD} ${DOCKER_REGISTRY}"
                    sh "docker push ${IMAGE_NAME}"
                    sh "docker push ${DOCKER_REGISTRY}/${SERVICE_NAME}:latest"
                }
            }
        }
        stage('Deploy to Dev') {
            steps {
                kubeconfig([credentialsId: 'kubeconfig']) {
                    sh "sed -i 's|IMAGE_NAME|${IMAGE_NAME}|g' k8s/deployment.yaml"
                    sh "kubectl apply -f k8s/deployment.yaml -n dev"
                    sh "kubectl rollout status deployment/${SERVICE_NAME} -n dev"
                }
            }
        }
        stage('Integration Tests') {
            steps {
                sh 'mvn verify -Pintegration-tests'
            }
        }
        stage('Deploy to Production') {
            when {
                branch 'main'
            }
            steps {
                input message: 'Deploy to production?', ok: 'Yes'
                kubeconfig([credentialsId: 'kubeconfig']) {
                    sh "kubectl apply -f k8s/deployment.yaml -n production"
                    sh "kubectl rollout status deployment/${SERVICE_NAME} -n production"
                }
            }
        }
    }
    post {
        success {
            slackSend channel: '#deployments', message: "âœ… ${SERVICE_NAME} ${IMAGE_NAME} deployed successfully!"
        }
        failure {
            slackSend channel: '#alerts', message: "âŒ ${SERVICE_NAME} deployment failed!"
        }
    }
}
```

### 5.2 GitLab CI/CDé…ç½®

```yaml
stages:
  - build-test
  - code-quality
  - build-image
  - push-image
  - deploy-dev
  - integration-test
  - deploy-prod

variables:
  DOCKER_REGISTRY: docker.example.com
  SERVICE_NAME: order-service
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"

cache:
  paths:
    - .m2/repository/
    - node_modules/

build-test:
  stage: build-test
  image: maven:3.8-openjdk-17
  script:
    - mvn clean package -DskipTests
    - mvn test
  artifacts:
    paths:
      - target/*.jar
    reports:
      junit: target/surefire-reports/TEST-*.xml

code-quality:
  stage: code-quality
  image: maven:3.8-openjdk-17
  script:
    - mvn sonar:sonar

build-image:
  stage: build-image
  image: docker:latest
  services:
    - docker:dind
  script:
    - docker build -t $DOCKER_REGISTRY/$SERVICE_NAME:$CI_COMMIT_TAG-$CI_PIPELINE_ID .
    - docker tag $DOCKER_REGISTRY/$SERVICE_NAME:$CI_COMMIT_TAG-$CI_PIPELINE_ID $DOCKER_REGISTRY/$SERVICE_NAME:latest
  only:
    - tags

push-image:
  stage: push-image
  image: docker:latest
  services:
    - docker:dind
  script:
    - docker login -u $DOCKER_USER -p $DOCKER_PASSWORD $DOCKER_REGISTRY
    - docker push $DOCKER_REGISTRY/$SERVICE_NAME:$CI_COMMIT_TAG-$CI_PIPELINE_ID
    - docker push $DOCKER_REGISTRY/$SERVICE_NAME:latest
  only:
    - tags

deploy-dev:
  stage: deploy-dev
  image: bitnami/kubectl:latest
  script:
    - sed -i "s|IMAGE_NAME|$DOCKER_REGISTRY/$SERVICE_NAME:$CI_COMMIT_TAG-$CI_PIPELINE_ID|g" k8s/deployment.yaml
    - kubectl apply -f k8s/deployment.yaml -n dev
    - kubectl rollout status deployment/$SERVICE_NAME -n dev
  only:
    - tags

integration-test:
  stage: integration-test
  image: maven:3.8-openjdk-17
  script:
    - mvn verify -Pintegration-tests
  only:
    - tags

deploy-prod:
  stage: deploy-prod
  image: bitnami/kubectl:latest
  script:
    - sed -i "s|IMAGE_NAME|$DOCKER_REGISTRY/$SERVICE_NAME:$CI_COMMIT_TAG-$CI_PIPELINE_ID|g" k8s/deployment.yaml
    - kubectl apply -f k8s/deployment.yaml -n production
    - kubectl rollout status deployment/$SERVICE_NAME -n production
  when:
    manual
  only:
    - tags
```

### 5.3 æµæ°´çº¿æœ€ä½³å®è·µ

1. **ä¿æŒæµæ°´çº¿ç®€æ´**ï¼šæ¯ä¸ªé˜¶æ®µä¸“æ³¨å•ä¸€èŒè´£
2. **å¹¶è¡Œæ‰§è¡Œ**ï¼šç‹¬ç«‹ä»»åŠ¡å¹¶è¡ŒåŒ–ï¼Œå‡å°‘æ•´ä½“æ—¶é—´
3. **æŒç»­åé¦ˆ**ï¼šåŠæ—¶é€šçŸ¥æˆåŠŸ/å¤±è´¥çŠ¶æ€
4. **ç¯å¢ƒä¸€è‡´æ€§**ï¼šæ‰€æœ‰ç¯å¢ƒä½¿ç”¨ç›¸åŒæ„å»ºäº§ç‰©
5. **å®‰å…¨é›†æˆ**ï¼šå‡­è¯ç®¡ç†ï¼Œä»£ç æ‰«æï¼Œä¾èµ–æ£€æŸ¥
6. **è‡ªåŠ¨åŒ–æµ‹è¯•**ï¼šå„å±‚çº§æµ‹è¯•è‡ªåŠ¨åŒ–é›†æˆ
7. **åŸºç¡€è®¾æ–½å³ä»£ç **ï¼šéƒ¨ç½²é…ç½®çº³å…¥ç‰ˆæœ¬æ§åˆ¶
8. **å®šæœŸæ¸…ç†**ï¼šè‡ªåŠ¨æ¸…ç†æ—§æ„å»ºå’Œç¯å¢ƒ
9. **æ€§èƒ½ä¼˜åŒ–**ï¼šç¼“å­˜ä¾èµ–ï¼Œä¼˜åŒ–æ„å»ºæ­¥éª¤
10. **å¯è¿½æº¯æ€§**ï¼šç‰ˆæœ¬ä¸éƒ¨ç½²å…³è”ï¼Œä¾¿äºé—®é¢˜å®šä½

---

## 6. é…ç½®ç®¡ç†ä¸æœåŠ¡å‘ç°é›†æˆ

### 6.1 é›†ä¸­å¼é…ç½®ç®¡ç†

**Spring Cloud Configå®ç°**ï¼š
```yaml
# bootstrap.yaml
spring:
  application:
    name: order-service
  cloud:
    config:
      uri: http://config-server:8888
      fail-fast: true
      retry:
        max-attempts: 6
        initial-interval: 1000
        max-interval: 2000
        multiplier: 1.1
  profiles:
    active: ${SPRING_PROFILES_ACTIVE:default}
```

**é…ç½®æœåŠ¡å™¨å­˜å‚¨ç»“æ„**ï¼š
```
config-repo/
â”œâ”€â”€ order-service-dev.yaml
â”œâ”€â”€ order-service-test.yaml
â”œâ”€â”€ order-service-prod.yaml
â”œâ”€â”€ inventory-service-dev.yaml
â””â”€â”€ ...
```

### 6.2 åŠ¨æ€é…ç½®æ›´æ–°

**Apolloé…ç½®ä¸­å¿ƒå®ç°**ï¼š
```java
@RestController
@RequestMapping("/config")
public class ConfigController {
    @ApolloConfig
    private Config config;
    @ApolloConfigChangeListener
    private void onChange(ConfigChangeEvent changeEvent) {
        if (changeEvent.isChanged("order.timeout")) {
            ConfigChange change = changeEvent.getChange("order.timeout");
            log.info("è®¢å•è¶…æ—¶é…ç½®å˜æ›´: {} -> {}", change.getOldValue(), change.getNewValue());
            // æ›´æ–°æœ¬åœ°é…ç½®
            updateOrderTimeout(Integer.parseInt(change.getNewValue()));
        }
    }

    @GetMapping("/timeout")
    public int getOrderTimeout() {
        return config.getIntProperty("order.timeout", 3000);
    }
}
```

### 6.3 æœåŠ¡å‘ç°æœºåˆ¶

**Eurekaå®¢æˆ·ç«¯é…ç½®**ï¼š
```yaml
# application.yaml
spring:
  application:
    name: order-service

eureka:
  client:
    serviceUrl:
      defaultZone: http://eureka-server1:8761/eureka/,http://eureka-server2:8762/eureka/
    registerWithEureka: true
    fetchRegistry: true
  instance:
    preferIpAddress: true
    lease-renewal-interval-in-seconds: 30
    metadata-map:
      version: ${VERSION}
      management.context-path: /actuator
```

**æœåŠ¡è°ƒç”¨**ï¼š
```java
@Service
public class OrderServiceImpl implements OrderService {
    @Autowired
    private RestTemplate restTemplate;

    @Override
    public OrderDTO createOrder(OrderRequest request) {
        // ä½¿ç”¨æœåŠ¡åè°ƒç”¨
        InventoryResponse response = restTemplate.postForObject(
            "http://inventory-service/inventory/check",
            buildInventoryRequest(request),
            InventoryResponse.class
        );
        // ...
    }
}
```

### 6.4 æœåŠ¡ç½‘æ ¼é›†æˆ

**Istioæµé‡ç®¡ç†**ï¼š
```yaml
# è™šæ‹ŸæœåŠ¡é…ç½®
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: order-service
  namespace: microservices
spec:
  hosts:
  - order-service
  http:
  - route:
    - destination:
        host: order-service
        subset: v1
    retries:
      attempts: 3
      perTryTimeout: 2s
    timeout: 5s
    fault:
      delay:
        percentage:
          value: 5
        fixedDelay: 1s
```

---

## 7. ç›‘æ§ä¸æ—¥å¿—èšåˆ

### 7.1 Prometheus + Grafanaç›‘æ§

**Spring Bootåº”ç”¨æš´éœ²æŒ‡æ ‡**ï¼š
```xml
<!-- pom.xml -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-actuator</artifactId>
</dependency>
<dependency>
    <groupId>io.micrometer</groupId>
    <artifactId>micrometer-registry-prometheus</artifactId>
</dependency>
```

```yaml
# application.yaml
management:
  endpoints:
    web:
      exposure:
        include: health,info,prometheus,metrics
  metrics:
    export:
      prometheus:
        enabled: true
  endpoint:
    health:
      show-details: always
      probes:
        enabled: true
      group:
        readiness:
          include: db,kafka,redis
```

**PrometheusæŠ“å–é…ç½®**ï¼š
```yaml
scrape_configs:
  - job_name: 'spring-actuator'
    metrics_path: '/actuator/prometheus'
    kubernetes_sd_configs:
      - role: pod
    relabel_configs:
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
        action: keep
        regex: true
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
        action: replace
        target_label: __metrics_path__
        regex: (.+)
```

### 7.2 åˆ†å¸ƒå¼æ—¥å¿—æ”¶é›†

**ELK Stacké…ç½®**ï¼š
```yaml
# logback-spring.xml
<appender name="JSON_FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
    <file>logs/order-service.json</file>
    <encoder class="net.logstash.logback.encoder.LogstashEncoder">
        <includeMdcKeyName>traceId</includeMdcKeyName>
        <includeMdcKeyName>spanId</includeMdcKeyName>
        <includeMdcKeyName>userId</includeMdcKeyName>
        <fieldNames>
            <timestamp>timestamp</timestamp>
            <message>message</message>
            <logger>logger</logger>
            <thread>thread</thread>
            <level>level</level>
        </fieldNames>
        <customFields>"application":"order-service","environment":"${SPRING_PROFILES_ACTIVE:-default}"</customFields>
    </encoder>
    <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
        <fileNamePattern>logs/order-service.%d{yyyy-MM-dd}.json</fileNamePattern>
        <maxHistory>7</maxHistory>
    </rollingPolicy>
</appender>
```

**Filebeaté…ç½®**ï¼š
```yaml
filebeat.inputs:
- type: log
  paths:
    - /var/log/*.log
  json.keys_under_root: true
  json.add_error_key: true
  json.message_key: message

processors:
  - add_kubernetes_metadata:
      host: ${NODE_NAME}
      matchers:
      - logs_path:
          logs_path: 