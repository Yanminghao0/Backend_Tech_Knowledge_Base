# åˆ†å¸ƒå¼è¿½è¸ªå®æˆ˜

> å¾®æœåŠ¡æ¶æ„ä¸‹çš„è¯·æ±‚é“¾è·¯è¿½è¸ªä¸é—®é¢˜è¯Šæ–­æ–¹æ¡ˆ

## ğŸ“‹ ç›®å½•

1. [åˆ†å¸ƒå¼è¿½è¸ªæ¦‚è¿°](#1-åˆ†å¸ƒå¼è¿½è¸ªæ¦‚è¿°)
2. [æ ¸å¿ƒåŸç†ä¸æ•°æ®æ¨¡å‹](#2-æ ¸å¿ƒåŸç†ä¸æ•°æ®æ¨¡å‹)
3. [ä¸»æµå®ç°å¯¹æ¯”](#3-ä¸»æµå®ç°å¯¹æ¯”)
4. [Spring Cloud Sleuth + Zipkinå®æˆ˜](#4-spring-cloud-sleuth--zipkinå®æˆ˜)
5. [Jaegerå®æˆ˜](#5-jaegerå®æˆ˜)
6. [SkyWalkingå®æˆ˜](#6-skywalkingå®æˆ˜)
7. [åˆ†å¸ƒå¼è¿½è¸ªé«˜çº§ç‰¹æ€§](#7-åˆ†å¸ƒå¼è¿½è¸ªé«˜çº§ç‰¹æ€§)
8. [æœ€ä½³å®è·µä¸æ€§èƒ½ä¼˜åŒ–](#8-æœ€ä½³å®è·µä¸æ€§èƒ½ä¼˜åŒ–)

---

## 1. åˆ†å¸ƒå¼è¿½è¸ªæ¦‚è¿°

### 1.1 å®šä¹‰ä¸ä»·å€¼

åˆ†å¸ƒå¼è¿½è¸ªï¼ˆDistributed Tracingï¼‰æ˜¯ä¸€ç§ç”¨äºç›‘æ§å’Œè¯Šæ–­åˆ†å¸ƒå¼ç³»ç»Ÿçš„æŠ€æœ¯ï¼Œé€šè¿‡è¿½è¸ªè¯·æ±‚åœ¨å¤šä¸ªæœåŠ¡é—´çš„ä¼ æ’­è·¯å¾„ï¼Œå¸®åŠ©å¼€å‘äººå‘˜ç†è§£ç³»ç»Ÿè¡Œä¸ºã€æ’æŸ¥æ€§èƒ½ç“¶é¢ˆå’Œå®šä½æ•…éšœç‚¹ã€‚

**è§£å†³çš„æ ¸å¿ƒé—®é¢˜**ï¼š
- è·¨æœåŠ¡è¯·æ±‚é“¾è·¯å¯è§†åŒ–
- æ€§èƒ½ç“¶é¢ˆå®šä½
- æœåŠ¡ä¾èµ–å…³ç³»åˆ†æ
- å¼‚å¸¸è¯·æ±‚è¿½è¸ª
- ç³»ç»Ÿè¡Œä¸ºåŸºçº¿å»ºç«‹

### 1.2 å‘å±•å†ç¨‹

- 2010å¹´ï¼šGoogleå‘è¡¨Dapperè®ºæ–‡ï¼Œå¥ å®šåˆ†å¸ƒå¼è¿½è¸ªåŸºç¡€
- 2012å¹´ï¼šTwitterå¼€æºZipkin
- 2015å¹´ï¼šUberå¼€æºJaeger
- 2017å¹´ï¼šApache SkyWalkingå¼€æº
- 2019å¹´ï¼šCNCFæˆç«‹OpenTelemetryé¡¹ç›®

### 1.3 å…¸å‹åº”ç”¨åœºæ™¯

- å¾®æœåŠ¡æ¶æ„ä¸‹çš„è¯·æ±‚è¿½è¸ª
- åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜æ’æŸ¥
- å…¨é“¾è·¯æ€§èƒ½ä¼˜åŒ–
- æœåŠ¡ä¾èµ–åˆ†æ
- å®¹é‡è§„åˆ’ä¸èµ„æºä¼˜åŒ–

```mermaid
graph TD
    A[ç”¨æˆ·è¯·æ±‚] --> B[API Gateway]
    B --> C[è®¢å•æœåŠ¡] --> D[ç”¨æˆ·æœåŠ¡]
    C --> E[æ”¯ä»˜æœåŠ¡] --> F[ç¬¬ä¸‰æ–¹æ”¯ä»˜API]
    C --> G[åº“å­˜æœåŠ¡]
    B --> H[æ—¥å¿—æœåŠ¡]
    classDef trace fill:#f9f,stroke:#333
    class A,B,C,D,E,F,G,H trace
```

---

## 2. æ ¸å¿ƒåŸç†ä¸æ•°æ®æ¨¡å‹

### 2.1 åŸºæœ¬åŸç†

åˆ†å¸ƒå¼è¿½è¸ªé€šè¿‡åœ¨è¯·æ±‚æµç»çš„å„ä¸ªæœåŠ¡é—´ä¼ é€’è¿½è¸ªæ ‡è¯†ï¼ˆTrace IDï¼‰å’Œè·¨åº¦æ ‡è¯†ï¼ˆSpan IDï¼‰ï¼Œè®°å½•è¯·æ±‚çš„è·¯å¾„ã€è€—æ—¶å’Œå…ƒæ•°æ®ï¼Œæœ€ç»ˆå½¢æˆå®Œæ•´çš„è°ƒç”¨é“¾è·¯è§†å›¾ã€‚

### 2.2 æ ¸å¿ƒæ¦‚å¿µ

| æ¦‚å¿µ | æè¿° |
|------|------|
| **Trace ID** | å…¨å±€å”¯ä¸€çš„è¯·æ±‚æ ‡è¯†ï¼Œè´¯ç©¿æ•´ä¸ªåˆ†å¸ƒå¼è°ƒç”¨é“¾è·¯ |
| **Span ID** | æ¯ä¸ªæœåŠ¡å¤„ç†å•å…ƒçš„å”¯ä¸€æ ‡è¯†ï¼Œå½¢æˆçˆ¶å­å…³ç³» |
| **Span** | åŸºæœ¬å·¥ä½œå•å…ƒï¼Œä»£è¡¨ä¸€ä¸ªæœåŠ¡çš„å¤„ç†è¿‡ç¨‹ |
| **Annotation** | æ—¶é—´ç‚¹äº‹ä»¶æ ‡è®°ï¼Œå¦‚è¯·æ±‚å¼€å§‹ã€è¯·æ±‚ç»“æŸç­‰ |
| **Tag** | é”®å€¼å¯¹å±æ€§ï¼Œç”¨äºå­˜å‚¨é¢å¤–ä¿¡æ¯ |
| **Context Propagation** | è·¨è¿›ç¨‹ä¼ é€’è¿½è¸ªä¸Šä¸‹æ–‡ä¿¡æ¯ |

### 2.3 æ•°æ®æ¨¡å‹

```
Trace
â”œâ”€â”€ Span (API Gateway)
â”‚   â”œâ”€â”€ Annotation: cs, sr, ss, cr
â”‚   â”œâ”€â”€ Tag: http.method=GET, http.url=/api/order
â”‚   â””â”€â”€ Span (è®¢å•æœåŠ¡)
â”‚       â”œâ”€â”€ Tag: db.instance=order_db
â”‚       â”œâ”€â”€ Span (ç”¨æˆ·æœåŠ¡)
â”‚       â””â”€â”€ Span (æ”¯ä»˜æœåŠ¡)
â”‚           â””â”€â”€ Span (ç¬¬ä¸‰æ–¹æ”¯ä»˜API)
â””â”€â”€ Span (æ—¥å¿—æœåŠ¡)
```

### 2.4 è¿½è¸ªæµç¨‹

1. **è¿½è¸ªä¸Šä¸‹æ–‡ç”Ÿæˆ**ï¼šè¯·æ±‚è¿›å…¥ç³»ç»Ÿæ—¶ç”ŸæˆTrace ID
2. **ä¸Šä¸‹æ–‡ä¼ é€’**ï¼šé€šè¿‡ç½‘ç»œè¯·æ±‚å¤´ä¼ é€’Trace IDå’ŒSpan ID
3. **æœ¬åœ°è¿½è¸ª**ï¼šæ¯ä¸ªæœåŠ¡è®°å½•å¤„ç†å¼€å§‹å’Œç»“æŸæ—¶é—´
4. **æ•°æ®æ”¶é›†**ï¼šå°†Spanä¿¡æ¯å‘é€åˆ°è¿½è¸ªç³»ç»Ÿ
5. **æ•°æ®å­˜å‚¨ä¸åˆ†æ**ï¼šå­˜å‚¨è¿½è¸ªæ•°æ®å¹¶æä¾›æŸ¥è¯¢åˆ†æèƒ½åŠ›
6. **å¯è§†åŒ–å±•ç¤º**ï¼šä»¥å›¾è¡¨å½¢å¼å±•ç¤ºå®Œæ•´è°ƒç”¨é“¾è·¯

---

## 3. ä¸»æµå®ç°å¯¹æ¯”

| ç‰¹æ€§ | Zipkin | Jaeger | SkyWalking | OpenTelemetry |
|------|--------|--------|------------|---------------|
| **å¼€å‘è¯­è¨€** | Java | Go | Java | å¤šè¯­è¨€ |
| **æ¶æ„** | ä¼ ç»Ÿæ¶æ„ | äº‘åŸç”Ÿæ¶æ„ | æ¢é’ˆ+åç«¯æ¶æ„ | è§„èŒƒ+SDK |
| **æ•°æ®é‡‡é›†** | ä¸»åŠ¨ä¸ŠæŠ¥ | ä¸»åŠ¨ä¸ŠæŠ¥ | å­—èŠ‚ç å¢å¼º | å¤šæ–¹å¼é‡‡é›† |
| **å­˜å‚¨** | å†…å­˜/MySQL/Cassandra/Elasticsearch | Cassandra/Elasticsearch | Elasticsearch/MySQL/TiDB | å¤šå­˜å‚¨æ”¯æŒ |
| **UI** | åŸºç¡€é“¾è·¯å±•ç¤º | ä¸°å¯Œçš„å¯è§†åŒ– | å…¨é¢çš„ç›‘æ§è§†å›¾ | ä¾èµ–å¤–éƒ¨UI |
| **æ€§èƒ½å½±å“** | è¾ƒä½ | ä½ | ä½ | å¯é…ç½® |
| **ç”Ÿæ€é›†æˆ** | Spring Cloud/Sleuth | Kubernetes/OpenShift | å¤šè¯­è¨€/å¤šæ¡†æ¶ | å¹¿æ³›é›†æˆ |
| **é«˜çº§ç‰¹æ€§** | åŸºç¡€ | æµé‡æ§åˆ¶/è‡ªé€‚åº”é‡‡æ · | APM/æœåŠ¡ç½‘æ ¼æ”¯æŒ |  vendorä¸­ç«‹ |
| **ç¤¾åŒºæ´»è·ƒåº¦** | ä¸­ | é«˜ | é«˜ | é«˜ |

---

## 4. Spring Cloud Sleuth + Zipkinå®æˆ˜

### 4.1 ç¯å¢ƒæ­å»º

**1. æ·»åŠ ä¾èµ–**ï¼š
```xml
<!-- Spring Cloud Sleuth -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-sleuth</artifactId>
</dependency>

<!-- Zipkinå®¢æˆ·ç«¯ -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-sleuth-zipkin</artifactId>
</dependency>
```

**2. é…ç½®æ–‡ä»¶**ï¼š
```yaml
spring:
  application:
    name: order-service
  zipkin:
    base-url: http://localhost:9411
  sleuth:
    sampler:
      probability: 1.0 # é‡‡æ ·ç‡100%ï¼Œç”Ÿäº§ç¯å¢ƒå»ºè®®0.1-0.01
    baggage:
      remote-fields: x-request-id, x-tenant-id
      correlation-fields: x-request-id, x-tenant-id
```

**3. å¯åŠ¨Zipkin**ï¼š
```bash
# æ–¹å¼ä¸€ï¼šä½¿ç”¨Docker
docker run -d -p 9411:9411 openzipkin/zipkin

# æ–¹å¼äºŒï¼šä½¿ç”¨Java
curl -sSL https://zipkin.io/quickstart.sh | bash -s
java -jar zipkin.jar

# è®¿é—®Zipkin UI
open http://localhost:9411
```

### 4.2 åŸºæœ¬ä½¿ç”¨

**1. è‡ªåŠ¨è¿½è¸ª**ï¼š
Spring Cloud Sleuthä¼šè‡ªåŠ¨ä¸ºä»¥ä¸‹ç»„ä»¶ç”Ÿæˆè¿½è¸ªä¿¡æ¯ï¼š
- RestTemplate
- WebClient
- Feign Client
- Spring MVCæ§åˆ¶å™¨
- å¼‚æ­¥æ“ä½œï¼ˆ@Asyncï¼‰
- æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆRabbitMQã€Kafkaç­‰ï¼‰

**2. æ‰‹åŠ¨åˆ›å»ºSpan**ï¼š
```java
@Service
public class OrderServiceImpl implements OrderService {

    private static final Logger log = LoggerFactory.getLogger(OrderServiceImpl.class);

    @Autowired
    private UserService userService;

    @Override
    public OrderDTO createOrder(OrderRequest request) {
        // æ‰‹åŠ¨åˆ›å»ºSpan
        try (Span span = tracer.nextSpan().name("order-processing").start()) {
            log.info("å¼€å§‹åˆ›å»ºè®¢å•: {}", request.getOrderNo());

            // æ·»åŠ è‡ªå®šä¹‰Tag
            span.tag("orderNo", request.getOrderNo());
            span.tag("userId", request.getUserId());

            // è°ƒç”¨ç”¨æˆ·æœåŠ¡
            UserDTO user = userService.getUserById(request.getUserId());

            // æ·»åŠ äº‹ä»¶æ ‡è®°
            span.addEvent("ç”¨æˆ·ä¿¡æ¯è·å–å®Œæˆ");

            // åˆ›å»ºè®¢å•é€»è¾‘
            OrderDTO order = new OrderDTO();
            // ...

            log.info("è®¢å•åˆ›å»ºå®Œæˆ: {}", order.getId());
            return order;
        }
    }
}
```

### 4.3 è‡ªå®šä¹‰è¿½è¸ªä¸Šä¸‹æ–‡

```java
@Component
public class CustomTraceFilter extends OncePerRequestFilter {

    @Autowired
    private Tracer tracer;

    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) {
        // ä»è¯·æ±‚å¤´è·å–è‡ªå®šä¹‰ID
        String requestId = request.getHeader("X-Request-ID");
        String tenantId = request.getHeader("X-Tenant-ID");

        // å°†è‡ªå®šä¹‰IDæ·»åŠ åˆ°è¿½è¸ªä¸Šä¸‹æ–‡
        if (requestId != null) {
            tracer.currentSpan().tag("X-Request-ID", requestId);
        }
        if (tenantId != null) {
            tracer.currentSpan().tag("X-Tenant-ID", tenantId);
        }

        filterChain.doFilter(request, response);
    }
}
```

### 4.4 é›†æˆæ—¥å¿—æ¡†æ¶

```xml
<dependency>
    <groupId>net.logstash.logback</groupId>
    <artifactId>logstash-logback-encoder</artifactId>
    <version>6.6</version>
</dependency>
```

```xml
<!-- logback-spring.xml -->
<appender name="JSON_FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
    <file>logs/order-service.json</file>
    <encoder class="net.logstash.logback.encoder.LogstashEncoder">
        <includeMdcKeyName>traceId</includeMdcKeyName>
        <includeMdcKeyName>spanId</includeMdcKeyName>
        <includeMdcKeyName>X-Request-ID</includeMdcKeyName>
        <fieldNames>
            <timestamp>timestamp</timestamp>
            <message>message</message>
            <logger>logger</logger>
            <thread>thread</thread>
            <level>level</level>
        </fieldNames>
    </encoder>
</appender>
```

---

## 5. Jaegerå®æˆ˜

### 5.1 Jaegeréƒ¨ç½²

```bash
# Docker Composeéƒ¨ç½²
curl -O https://raw.githubusercontent.com/jaegertracing/jaeger/master/docker-compose.yml
 docker-compose up -d

# è®¿é—®Jaeger UI
open http://localhost:16686
```

### 5.2 Spring Booté›†æˆJaeger

**1. æ·»åŠ ä¾èµ–**ï¼š
```xml
<dependency>
    <groupId>io.opentracing.contrib</groupId>
    <artifactId>opentracing-spring-jaeger-cloud-starter</artifactId>
    <version>3.3.1</version>
</dependency>
```

**2. é…ç½®æ–‡ä»¶**ï¼š
```yaml
opentracing:
  jaeger:
    service-name: order-service
    udp-sender:
      host: localhost
      port: 6831
    sampler:
      type: const
      param: 1
    logs:
      enabled: true
```

### 5.3 å¾®æœåŠ¡é›†æˆç¤ºä¾‹

```java
@RestController
@RequestMapping("/orders")
public class OrderController {

    private static final Logger log = LoggerFactory.getLogger(OrderController.class);

    @Autowired
    private OrderService orderService;

    @Autowired
    private Tracer tracer;

    @PostMapping
    public ResponseEntity<OrderDTO> createOrder(@RequestBody @Valid OrderRequest request) {
        // åˆ›å»ºè‡ªå®šä¹‰Span
        Span span = tracer.buildSpan("createOrderController").start();
        try (Scope scope = tracer.scopeManager().activate(span)) {
            log.info("æ¥æ”¶è®¢å•åˆ›å»ºè¯·æ±‚: {}", request.getOrderNo());
            OrderDTO order = orderService.createOrder(request);
            return ResponseEntity.ok(order);
        } catch (Exception e) {
            // è®°å½•å¼‚å¸¸ä¿¡æ¯
            span.log(Map.of("error", e.getMessage()));
            span.setTag(Tags.ERROR, true);
            throw e;
        } finally {
            span.finish();
        }
    }
}
```

---

## 6. SkyWalkingå®æˆ˜

### 6.1 SkyWalkingéƒ¨ç½²

```bash
# ä¸‹è½½SkyWalking
wget https://archive.apache.org/dist/skywalking/8.7.0/apache-skywalking-apm-8.7.0.tar.gz

tar -zxvf apache-skywalking-apm-8.7.0.tar.gz
cd apache-skywalking-apm-bin

# å¯åŠ¨åç«¯æœåŠ¡
bin/startup.sh

# è®¿é—®SkyWalking UI
open http://localhost:8080
```

### 6.2 åº”ç”¨æ¥å…¥

**1. é…ç½®SkyWalking Agent**ï¼š
```bash
java -javaagent:/path/to/skywalking-agent/skywalking-agent.jar \
     -Dskywalking.agent.service_name=order-service \
     -Dskywalking.collector.backend_service=localhost:11800 \
     -jar order-service.jar
```

**2. Dockeré›†æˆ**ï¼š
```dockerfile
FROM openjdk:11-jre-slim
COPY skywalking-agent /usr/local/skywalking-agent
COPY target/order-service.jar app.jar
ENTRYPOINT [