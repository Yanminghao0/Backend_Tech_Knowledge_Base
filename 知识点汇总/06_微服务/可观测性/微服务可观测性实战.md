# 微服务可观测性实战

> 构建全方位的微服务监控、日志与追踪体系

## 📋 目录

1. [可观测性概述](#1-可观测性概述)
2. [日志收集与分析](#2-日志收集与分析)
3. [指标监控体系](#3-指标监控体系)
4. [分布式追踪实战](#4-分布式追踪实战)
5. [告警与通知机制](#5-告警与通知机制)
6. [可观测性平台搭建](#6-可观测性平台搭建)
7. [最佳实践与案例分析](#7-最佳实践与案例分析)

---

## 1. 可观测性概述

### 1.1 定义与三大支柱

微服务可观测性(Observability)是指通过外部输出了解系统内部状态的能力，使运维和开发人员能够快速识别、诊断和解决系统问题。它建立在三大支柱之上：

- **日志(Logs)**：系统事件的离散记录
- **指标(Metrics)**：系统状态的量化数据
- **追踪(Traces)**：请求在分布式系统中的路径

![可观测性三大支柱](https://i.imgur.com/xyz123.png)

### 1.2 微服务可观测性挑战

- **分布式系统复杂性**：请求跨多个服务和网络
- **数据量爆炸**：大规模集群产生海量数据
- **异构环境**：多种技术栈并存
- **动态性**：服务实例频繁扩缩容
- **故障定位困难**：单一故障可能引发连锁反应

### 1.3 核心价值

- **快速故障定位**：缩短MTTD(平均检测时间)和MTTR(平均恢复时间)
- **性能优化**：识别系统瓶颈
- **容量规划**：基于实际数据预测资源需求
- **用户体验提升**：发现并解决影响用户的问题
- **系统可靠性**：提高整体系统稳定性

---

## 2. 日志收集与分析

### 2.1 日志设计原则

#### 2.1.1 结构化日志

采用JSON格式记录日志，便于检索和分析：

```java
@Slf4j
@Service
public class OrderService {
    public void createOrder(OrderRequest request) {
        // 记录结构化日志
        log.info("{}", JsonUtil.toJson(
            new LogEvent()
                .setEventType("ORDER_CREATE")
                .setTraceId(MDC.get("traceId"))
                .setOrderId(request.getOrderId())
                .setUserId(request.getUserId())
                .setItems(request.getItems().size())
                .setTimestamp(LocalDateTime.now())
        ));

        // 业务逻辑...
    }
}
```

#### 2.1.2 关键日志字段

每条日志应包含以下关键字段：
- `timestamp`: 时间戳
- `level`: 日志级别
- `service`: 服务名称
- `traceId`: 分布式追踪ID
- `spanId`: 当前追踪跨度ID
- `userId`: 用户ID
- `eventType`: 事件类型
- `message`: 日志消息
- `stackTrace`: 异常堆栈(错误日志)

### 2.2 日志收集架构

#### 2.2.1 ELK/EFK Stack

![ELK架构](https://i.imgur.com/abc456.png)

- **Filebeat**: 轻量级日志收集器
- **Logstash**: 日志处理与转换
- **Elasticsearch**: 日志存储与检索
- **Kibana**: 日志可视化与分析

#### 2.2.2 Filebeat配置

```yaml
# filebeat.yml
filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /var/log/application/*.log
  json.keys_under_root: true
  json.add_error_key: true
  tags: [