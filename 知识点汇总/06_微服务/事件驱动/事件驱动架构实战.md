# äº‹ä»¶é©±åŠ¨æ¶æ„å®æˆ˜

> æ„å»ºå“åº”å¼ã€æ¾è€¦åˆçš„å¾®æœåŠ¡ç³»ç»Ÿ

## ğŸ“‹ ç›®å½•

1. [äº‹ä»¶é©±åŠ¨æ¶æ„æ¦‚è¿°](#1-äº‹ä»¶é©±åŠ¨æ¶æ„æ¦‚è¿°)
2. [äº‹ä»¶é©±åŠ¨æ ¸å¿ƒç»„ä»¶](#2-äº‹ä»¶é©±åŠ¨æ ¸å¿ƒç»„ä»¶)
3. [äº‹ä»¶è®¾è®¡åŸåˆ™](#3-äº‹ä»¶è®¾è®¡åŸåˆ™)
4. [äº‹ä»¶é€šä¿¡æ¨¡å¼](#4-äº‹ä»¶é€šä¿¡æ¨¡å¼)
5. [äº‹ä»¶æµå¤„ç†å®æˆ˜](#5-äº‹ä»¶æµå¤„ç†å®æˆ˜)
6. [äº‹ä»¶æº¯æºå®æˆ˜](#6-äº‹ä»¶æº¯æºå®æˆ˜)
7. [CQRSä¸äº‹ä»¶é©±åŠ¨ç»“åˆ](#7-cqrsä¸äº‹ä»¶é©±åŠ¨ç»“åˆ)
8. [äº‹ä»¶é©±åŠ¨æ¶æ„æ¨¡å¼](#8-äº‹ä»¶é©±åŠ¨æ¶æ„æ¨¡å¼)
9. [äº‹ä»¶é©±åŠ¨æ€§èƒ½ä¼˜åŒ–](#9-äº‹ä»¶é©±åŠ¨æ€§èƒ½ä¼˜åŒ–)
10. [äº‹ä»¶é©±åŠ¨å¯é æ€§ä¿éšœ](#10-äº‹ä»¶é©±åŠ¨å¯é æ€§ä¿éšœ)
11. [ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ](#11-ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ)
12. [äº‹ä»¶é©±åŠ¨æ¡†æ¶é€‰å‹](#12-äº‹ä»¶é©±åŠ¨æ¡†æ¶é€‰å‹)
13. [æ¡ˆä¾‹åˆ†æ](#13-æ¡ˆä¾‹åˆ†æ)

---

## 1. äº‹ä»¶é©±åŠ¨æ¶æ„æ¦‚è¿°

### 1.1 ä»€ä¹ˆæ˜¯äº‹ä»¶é©±åŠ¨æ¶æ„

äº‹ä»¶é©±åŠ¨æ¶æ„(Event-Driven Architecture, EDA)æ˜¯ä¸€ç§è½¯ä»¶æ¶æ„èŒƒå¼ï¼Œå®ƒä»¥äº‹ä»¶çš„äº§ç”Ÿã€ä¼ æ’­å’Œå¤„ç†ä¸ºæ ¸å¿ƒæ¥è®¾è®¡ç³»ç»Ÿã€‚åœ¨EDAä¸­ï¼Œç³»ç»Ÿç»„ä»¶é€šè¿‡äº§ç”Ÿå’Œå“åº”äº‹ä»¶è¿›è¡Œé€šä¿¡ï¼Œå®ç°æ¾è€¦åˆå’Œé«˜åº¦å¯æ‰©å±•çš„ç³»ç»Ÿè®¾è®¡ã€‚

**äº‹ä»¶å®šä¹‰**ï¼šæè¿°ç³»ç»Ÿä¸­å‘ç”Ÿçš„æŸä»¶äº‹çš„ä¸å¯å˜è®°å½•ï¼Œé€šå¸¸åŒ…å«äº‹ä»¶ç±»å‹ã€å‘ç”Ÿæ—¶é—´ã€ç›¸å…³æ•°æ®ç­‰ä¿¡æ¯ã€‚

**äº‹ä»¶é©±åŠ¨æ¶æ„çš„æ ¸å¿ƒæ€æƒ³**ï¼š
- ç³»ç»Ÿç”±äº‹ä»¶ç”Ÿäº§è€…å’Œäº‹ä»¶æ¶ˆè´¹è€…ç»„æˆ
- ç”Ÿäº§è€…äº§ç”Ÿäº‹ä»¶ï¼Œä¸å…³å¿ƒè°ä¼šæ¶ˆè´¹è¿™äº›äº‹ä»¶
- æ¶ˆè´¹è€…è®¢é˜…æ„Ÿå…´è¶£çš„äº‹ä»¶ï¼Œå¹¶å®šä¹‰å¦‚ä½•å“åº”
- äº‹ä»¶é€šè¿‡äº‹ä»¶é€šé“è¿›è¡Œä¼ é€’
- åŸºäºäº‹ä»¶æµæ„å»ºä¸šåŠ¡æµç¨‹

### 1.2 äº‹ä»¶é©±åŠ¨æ¶æ„çš„ä¼˜åŠ¿

- **æ¾è€¦åˆ**ï¼šç»„ä»¶ä¹‹é—´é€šè¿‡äº‹ä»¶é—´æ¥é€šä¿¡ï¼Œæ— éœ€äº†è§£å½¼æ­¤
- **å¯æ‰©å±•æ€§**ï¼šå¯ä»¥ç‹¬ç«‹æ‰©å±•ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…
- **å¼¹æ€§**ï¼šå•ä¸ªç»„ä»¶æ•…éšœä¸ä¼šå½±å“æ•´ä¸ªç³»ç»Ÿ
- **å“åº”å¼**ï¼šèƒ½å¤Ÿå®æ—¶å“åº”ä¸šåŠ¡äº‹ä»¶
- **å¯é‡ç”¨æ€§**ï¼šäº‹ä»¶å¯ä»¥è¢«å¤šä¸ªæ¶ˆè´¹è€…ä½¿ç”¨
- **å¯ç»´æŠ¤æ€§**ï¼šç»„ä»¶è¾¹ç•Œæ¸…æ™°ï¼ŒèŒè´£å•ä¸€
- **å¯æµ‹è¯•æ€§**ï¼šç»„ä»¶å¯ä»¥ç‹¬ç«‹æµ‹è¯•
- **ä¸šåŠ¡æ•æ·æ€§**ï¼šæ”¯æŒå¢é‡å¼€å‘å’Œå¿«é€Ÿè¿­ä»£

### 1.3 äº‹ä»¶é©±åŠ¨æ¶æ„é€‚ç”¨åœºæ™¯

- **å®æ—¶æ•°æ®å¤„ç†**ï¼šå¦‚é‡‘èäº¤æ˜“ã€å®æ—¶ç›‘æ§
- **å¤æ‚ä¸šåŠ¡æµç¨‹**ï¼šå¦‚è®¢å•å¤„ç†ã€ä¾›åº”é“¾ç®¡ç†
- **é«˜å¹¶å‘ç³»ç»Ÿ**ï¼šéœ€è¦å¤„ç†å¤§é‡å¹¶å‘è¯·æ±‚
- **æ¾è€¦åˆç³»ç»Ÿ**ï¼šæœåŠ¡é—´ä¾èµ–å…³ç³»å¤æ‚
- **æ•°æ®å¯†é›†å‹åº”ç”¨**ï¼šéœ€è¦å¤„ç†å’Œåˆ†æå¤§é‡æ•°æ®
- **è·¨ç»„ç»‡é›†æˆ**ï¼šéœ€è¦ä¸å¤–éƒ¨ç³»ç»Ÿé›†æˆ
- **å®æ—¶åˆ†æ**ï¼šéœ€è¦å®æ—¶å¤„ç†å’Œåˆ†æäº‹ä»¶æµ

### 1.4 äº‹ä»¶é©±åŠ¨æ¶æ„æŒ‘æˆ˜

- **åˆ†å¸ƒå¼å¤æ‚æ€§**ï¼šåˆ†å¸ƒå¼ç³»ç»Ÿå¸¦æ¥çš„ä¸€è‡´æ€§ã€å¯é æ€§æŒ‘æˆ˜
- **äº‹ä»¶é¡ºåº**ï¼šç¡®ä¿äº‹ä»¶æŒ‰æ­£ç¡®é¡ºåºå¤„ç†
- **æ•°æ®ä¸€è‡´æ€§**ï¼šç»´æŠ¤è·¨æœåŠ¡æ•°æ®ä¸€è‡´æ€§
- **è°ƒè¯•ä¸è¿½è¸ª**ï¼šåˆ†å¸ƒå¼äº‹ä»¶æµéš¾ä»¥è¿½è¸ªå’Œè°ƒè¯•
- **äº‹ä»¶ç‰ˆæœ¬ç®¡ç†**ï¼šå¤„ç†äº‹ä»¶ç»“æ„å˜æ›´
- **ç³»ç»Ÿå¯è§‚æ€§**ï¼šç›‘æ§å’Œç†è§£äº‹ä»¶æµ
- **äº‹åŠ¡ç®¡ç†**ï¼šè·¨å¤šä¸ªæœåŠ¡çš„äº‹åŠ¡å¤„ç†
- **æ€§èƒ½ä¼˜åŒ–**ï¼šå¤„ç†é«˜ååé‡äº‹ä»¶æµ

---

## 2. äº‹ä»¶é©±åŠ¨æ ¸å¿ƒç»„ä»¶

### 2.1 äº‹ä»¶(Event)

äº‹ä»¶æ˜¯äº‹ä»¶é©±åŠ¨æ¶æ„çš„åŸºæœ¬æ„å»ºå—ï¼Œä»£è¡¨ç³»ç»Ÿä¸­å‘ç”Ÿçš„æŸä»¶äº‹ã€‚

**äº‹ä»¶ç‰¹å¾**ï¼š
- **ä¸å¯å˜æ€§**ï¼šäº‹ä»¶ä¸€æ—¦åˆ›å»ºï¼Œä¸èƒ½è¢«ä¿®æ”¹
- **æ—¶é—´æˆ³**ï¼šè®°å½•äº‹ä»¶å‘ç”Ÿçš„æ—¶é—´
- **å”¯ä¸€æ ‡è¯†**ï¼šäº‹ä»¶çš„å”¯ä¸€æ ‡è¯†ç¬¦
- **äº‹ä»¶ç±»å‹**ï¼šæè¿°äº‹ä»¶çš„ç±»åˆ«
- **äº‹ä»¶æ•°æ®**ï¼šä¸äº‹ä»¶ç›¸å…³çš„æ•°æ®
- **å…ƒæ•°æ®**ï¼šäº‹ä»¶çš„ä¸Šä¸‹æ–‡ä¿¡æ¯

**äº‹ä»¶ç¤ºä¾‹**ï¼š
```json
{
  "eventId": "f47ac10b-58cc-4372-a567-0e02b2c3d479",
  "eventType": "com.example.order.created",
  "timestamp": "2023-05-15T14:30:45.123Z",
  "data": {
    "orderId": "ord-12345",
    "userId": "usr-789",
    "items": [
      {"productId": "prod-1", "quantity": 2, "price": 99.99},
      {"productId": "prod-2", "quantity": 1, "price": 149.99}
    ],
    "totalAmount": 349.97
  },
  "metadata": {
    "source": "order-service",
    "traceId": "trace-abc-123",
    "version": "1.0"
  }
}
```

### 2.2 äº‹ä»¶ç”Ÿäº§è€…(Event Producer)

äº‹ä»¶ç”Ÿäº§è€…æ˜¯äº§ç”Ÿå¹¶å‘å¸ƒäº‹ä»¶çš„ç»„ä»¶ï¼Œå®ƒä¸å…³å¿ƒè°ä¼šæ¶ˆè´¹è¿™äº›äº‹ä»¶ã€‚

**ç”Ÿäº§è€…èŒè´£**ï¼š
- æ£€æµ‹é¢†åŸŸäº‹ä»¶
- åˆ›å»ºäº‹ä»¶å¯¹è±¡
- å‘å¸ƒäº‹ä»¶åˆ°äº‹ä»¶é€šé“
- ç¡®ä¿äº‹ä»¶å‘å¸ƒçš„å¯é æ€§

**å®ç°æ–¹å¼**ï¼š
- ç›´æ¥é›†æˆåˆ°ä¸šåŠ¡é€»è¾‘ä¸­
- é€šè¿‡æ‹¦æˆªå™¨æˆ–AOPè‡ªåŠ¨å‘å¸ƒ
- åŸºäºé¢†åŸŸæ¨¡å‹çš„äº‹ä»¶å‘å¸ƒ

### 2.3 äº‹ä»¶æ¶ˆè´¹è€…(Event Consumer)

äº‹ä»¶æ¶ˆè´¹è€…æ˜¯è®¢é˜…å¹¶å¤„ç†äº‹ä»¶çš„ç»„ä»¶ï¼Œå®ƒå®šä¹‰äº†å¯¹ç‰¹å®šäº‹ä»¶çš„å“åº”é€»è¾‘ã€‚

**æ¶ˆè´¹è€…èŒè´£**ï¼š
- è®¢é˜…æ„Ÿå…´è¶£çš„äº‹ä»¶
- æ¥æ”¶å¹¶å¤„ç†äº‹ä»¶
- å®ç°ä¸šåŠ¡é€»è¾‘å“åº”
- å¤„ç†äº‹ä»¶å¤„ç†å¤±è´¥

**æ¶ˆè´¹è€…ç±»å‹**ï¼š
- **é€šçŸ¥å‹æ¶ˆè´¹è€…**ï¼šæ¥æ”¶äº‹ä»¶å¹¶æ‰§è¡ŒæŸäº›æ“ä½œï¼Œä¸äº§ç”Ÿæ–°äº‹ä»¶
- **èšåˆå‹æ¶ˆè´¹è€…**ï¼šæ¥æ”¶å¤šä¸ªäº‹ä»¶å¹¶èšåˆå¤„ç†
- **è½¬æ¢å‹æ¶ˆè´¹è€…**ï¼šæ¥æ”¶äº‹ä»¶ï¼Œå¤„ç†åäº§ç”Ÿæ–°äº‹ä»¶

### 2.4 äº‹ä»¶é€šé“(Event Channel)

äº‹ä»¶é€šé“æ˜¯è¿æ¥äº‹ä»¶ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„é€šä¿¡åŸºç¡€è®¾æ–½ï¼Œè´Ÿè´£äº‹ä»¶çš„ä¼ é€’ã€‚

**äº‹ä»¶é€šé“ç±»å‹**ï¼š
- **ç‚¹å¯¹ç‚¹é€šé“**ï¼šæ¯ä¸ªäº‹ä»¶åªè¢«ä¸€ä¸ªæ¶ˆè´¹è€…å¤„ç†
- **å‘å¸ƒ/è®¢é˜…é€šé“**ï¼šäº‹ä»¶è¢«æ‰€æœ‰è®¢é˜…çš„æ¶ˆè´¹è€…å¤„ç†
- **ä¸»é¢˜é€šé“**ï¼šåŸºäºä¸»é¢˜å¯¹äº‹ä»¶è¿›è¡Œåˆ†ç±»ä¼ é€’
- **é˜Ÿåˆ—é€šé“**ï¼šä½¿ç”¨é˜Ÿåˆ—å®ç°äº‹ä»¶çš„å¼‚æ­¥ä¼ é€’

### 2.5 äº‹ä»¶å¤„ç†å¼•æ“(Event Processing Engine)

äº‹ä»¶å¤„ç†å¼•æ“æ˜¯å¤„ç†å¤æ‚äº‹ä»¶æµçš„ç»„ä»¶ï¼Œæ”¯æŒäº‹ä»¶è¿‡æ»¤ã€è½¬æ¢ã€èšåˆç­‰æ“ä½œã€‚

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- äº‹ä»¶è¿‡æ»¤ï¼šé€‰æ‹©æ„Ÿå…´è¶£çš„äº‹ä»¶
- äº‹ä»¶è½¬æ¢ï¼šå°†äº‹ä»¶ä»ä¸€ç§æ ¼å¼è½¬æ¢ä¸ºå¦ä¸€ç§æ ¼å¼
- äº‹ä»¶èšåˆï¼šç»„åˆå¤šä¸ªäº‹ä»¶äº§ç”Ÿæ–°äº‹ä»¶
- äº‹ä»¶æ’åºï¼šç¡®ä¿äº‹ä»¶æŒ‰ç‰¹å®šé¡ºåºå¤„ç†
- äº‹ä»¶å…³è”ï¼šè¯†åˆ«äº‹ä»¶ä¹‹é—´çš„å…³ç³»
- å¤æ‚äº‹ä»¶å¤„ç†ï¼šæ£€æµ‹äº‹ä»¶æ¨¡å¼å’Œå¤æ‚æ¡ä»¶

### 2.6 äº‹ä»¶å­˜å‚¨(Event Store)

äº‹ä»¶å­˜å‚¨æ˜¯ä¸“é—¨ç”¨äºæŒä¹…åŒ–äº‹ä»¶çš„æ•°æ®åº“ï¼Œæ”¯æŒäº‹ä»¶çš„è¿½åŠ å’ŒæŸ¥è¯¢ã€‚

**äº‹ä»¶å­˜å‚¨ç‰¹æ€§**ï¼š
- åªè¿½åŠ (Append-only)å†™å…¥
- äº‹ä»¶å†å²æŸ¥è¯¢
- äº‹ä»¶æµé‡æ”¾
- äº‹åŠ¡æ”¯æŒ
- é«˜ååé‡

---

## 3. äº‹ä»¶è®¾è®¡åŸåˆ™

### 3.1 äº‹ä»¶å‘½åè§„èŒƒ

- ä½¿ç”¨**è¿‡å»æ—¶æ€**å‘½åäº‹ä»¶ï¼š`OrderCreated`ã€`PaymentProcessed`
- ä½¿ç”¨**é¢†åŸŸæœ¯è¯­**è€ŒéæŠ€æœ¯æœ¯è¯­
- åŒ…å«**è§¦å‘å®ä½“**ï¼š`OrderCreated`è€Œé`CreatedOrder`
- ä½¿ç”¨**å±‚æ¬¡åŒ–å‘½åç©ºé—´**ï¼š`com.company.domain.boundedcontext.eventname`
- ä¿æŒ**åç§°ç®€æ´æ˜ç¡®**ï¼Œå‡†ç¡®åæ˜ äº‹ä»¶æœ¬è´¨

### 3.2 äº‹ä»¶ç²’åº¦è®¾è®¡

**äº‹ä»¶ç²’åº¦åŸåˆ™**ï¼š
- **è¶³å¤Ÿè¯¦ç»†**ï¼šåŒ…å«æ‰€æœ‰å¿…è¦ä¿¡æ¯ï¼Œé¿å…æ¶ˆè´¹è€…éœ€è¦æŸ¥è¯¢é¢å¤–æ•°æ®
- **ä¸è¿‡åº¦è¯¦ç»†**ï¼šåªåŒ…å«ç›¸å…³æ•°æ®ï¼Œé¿å…ä¿¡æ¯è¿‡è½½
- **ä¸šåŠ¡ç›¸å…³**ï¼šåŸºäºä¸šåŠ¡é¢†åŸŸè¾¹ç•Œå®šä¹‰äº‹ä»¶ç²’åº¦
- **ç¨³å®šæ€§**ï¼šäº‹ä»¶ç»“æ„åº”ç›¸å¯¹ç¨³å®šï¼Œé¿å…é¢‘ç¹å˜æ›´

**ç²’åº¦é€‰æ‹©æŒ‡å—**ï¼š
- é«˜é¢‘å˜åŒ–çš„æ•°æ®åº”ä½œä¸ºå¼•ç”¨è€ŒéåµŒå…¥
- è·¨é¢†åŸŸä½¿ç”¨çš„æ•°æ®åº”è®¾è®¡ä¸ºç‹¬ç«‹äº‹ä»¶
- è€ƒè™‘äº‹ä»¶çš„æ¶ˆè´¹åœºæ™¯å’Œé¢‘ç‡

### 3.3 äº‹ä»¶ç‰ˆæœ¬ç®¡ç†

**ç‰ˆæœ¬æ§åˆ¶ç­–ç•¥**ï¼š
- **æ˜¾å¼ç‰ˆæœ¬å·**ï¼šåœ¨äº‹ä»¶å…ƒæ•°æ®ä¸­åŒ…å«ç‰ˆæœ¬ä¿¡æ¯
- **å‘åå…¼å®¹**ï¼šæ–°ç‰ˆæœ¬äº‹ä»¶åº”å…¼å®¹æ—§ç‰ˆæœ¬æ¶ˆè´¹è€…
- **æ¼”è¿›ç­–ç•¥**ï¼š
  - æ·»åŠ å­—æ®µï¼šä¿æŒå‘åå…¼å®¹
  - åˆ é™¤å­—æ®µï¼šæ ‡è®°ä¸ºè¿‡æ—¶è€Œéç«‹å³åˆ é™¤
  - ä¿®æ”¹å­—æ®µï¼šåˆ›å»ºæ–°ç‰ˆæœ¬äº‹ä»¶
- **ç‰ˆæœ¬å‘½å**ï¼šä½¿ç”¨ç®€å•æ•°å­—(1.0, 2.0)æˆ–æ—¥æœŸ(2023-01-01)

**ç‰ˆæœ¬è¿ç§»**ï¼š
- å¹¶è¡Œè¿è¡Œå¤šä¸ªç‰ˆæœ¬çš„äº‹ä»¶å¤„ç†å™¨
- ä½¿ç”¨é€‚é…å™¨è½¬æ¢ä¸åŒç‰ˆæœ¬äº‹ä»¶
- é€æ­¥è¿ç§»åˆ°æ–°ç‰ˆæœ¬

### 3.4 äº‹ä»¶å…ƒæ•°æ®è®¾è®¡

**æ ¸å¿ƒå…ƒæ•°æ®**ï¼š
- **äº‹ä»¶ID**ï¼šå”¯ä¸€æ ‡è¯†ç¬¦
- **äº‹ä»¶ç±»å‹**ï¼šäº‹ä»¶çš„åˆ†ç±»
- **æ—¶é—´æˆ³**ï¼šäº‹ä»¶å‘ç”Ÿçš„æ—¶é—´
- **æºä¿¡æ¯**ï¼šäº‹ä»¶äº§ç”Ÿçš„æœåŠ¡/ç»„ä»¶
- **è·Ÿè¸ªID**ï¼šåˆ†å¸ƒå¼è¿½è¸ªæ ‡è¯†ç¬¦
- **ç‰ˆæœ¬ä¿¡æ¯**ï¼šäº‹ä»¶ schema ç‰ˆæœ¬

**æ‰©å±•å…ƒæ•°æ®**ï¼š
- **ç›¸å…³äº‹ä»¶ID**ï¼šå…³è”çš„çˆ¶äº‹ä»¶
- **ä¼˜å…ˆçº§**ï¼šäº‹ä»¶å¤„ç†ä¼˜å…ˆçº§
- **å®‰å…¨ä¸Šä¸‹æ–‡**ï¼šäº‹ä»¶äº§ç”Ÿçš„å®‰å…¨ä¸Šä¸‹æ–‡
- **æ•°æ®èµ·æº**ï¼šæ•°æ®çš„åŸå§‹æ¥æº

### 3.5 äº‹ä»¶ schema è®¾è®¡

**schema è®¾è®¡åŸåˆ™**ï¼š
- ä½¿ç”¨**å¼ºç±»å‹ schema**ï¼šå¦‚Avroã€Protobuf
- å®šä¹‰**æ¸…æ™°çš„å­—æ®µç±»å‹**ï¼šé¿å…ä½¿ç”¨æ¨¡ç³Šç±»å‹
- æ·»åŠ **æè¿°æ€§å…ƒæ•°æ®**ï¼šå­—æ®µè¯´æ˜ã€çº¦æŸæ¡ä»¶
- **ä¿æŒå…¼å®¹æ€§**ï¼šæ”¯æŒæ¼”è¿›è€Œä¸ç ´åæ¶ˆè´¹è€…

**schema æ³¨å†Œ**ï¼š
- ä½¿ç”¨schemaæ³¨å†Œè¡¨ç®¡ç†äº‹ä»¶schema
- è‡ªåŠ¨åŒ–schemaç‰ˆæœ¬æ§åˆ¶
- é›†æˆæ„å»ºå’Œéƒ¨ç½²æµç¨‹

---

## 4. äº‹ä»¶é€šä¿¡æ¨¡å¼

### 4.1 å‘å¸ƒ/è®¢é˜…æ¨¡å¼(Publish/Subscribe)

å‘å¸ƒ/è®¢é˜…æ¨¡å¼æ˜¯ä¸€ç§ä¸€å¯¹å¤šçš„é€šä¿¡æ¨¡å¼ï¼Œäº‹ä»¶è¢«å‘å¸ƒåˆ°ä¸»é¢˜ï¼Œæ‰€æœ‰è®¢é˜…è¯¥ä¸»é¢˜çš„æ¶ˆè´¹è€…éƒ½ä¼šæ”¶åˆ°äº‹ä»¶ã€‚

![å‘å¸ƒ/è®¢é˜…æ¨¡å¼](https://i.imgur.com/pubsub_pattern.png)

**å®ç°æ–¹å¼**ï¼š
```java
// å‘å¸ƒè€…
@Service
public class OrderService {
    @Autowired
    private KafkaTemplate<String, OrderEvent> kafkaTemplate;

    @Transactional
    public void createOrder(Order order) {
        // ä¿å­˜è®¢å•
        orderRepository.save(order);
        
        // å‘å¸ƒè®¢å•åˆ›å»ºäº‹ä»¶
        OrderCreatedEvent event = new OrderCreatedEvent(order);
        kafkaTemplate.send("order-events", event.getOrderId(), event);
    }
}

// æ¶ˆè´¹è€…1
@Service
public class InventoryService {
    @KafkaListener(topics = "order-events", groupId = "inventory-group")
    public void handleOrderEvent(OrderCreatedEvent event) {
        // å¤„ç†åº“å­˜æ‰£å‡
        deductInventory(event);
    }
}

// æ¶ˆè´¹è€…2
@Service
public class NotificationService {
    @KafkaListener(topics = "order-events", groupId = "notification-group")
    public void handleOrderEvent(OrderCreatedEvent event) {
        // å‘é€é€šçŸ¥
        sendOrderConfirmation(event);
    }
}
```

**é€‚ç”¨åœºæ™¯**ï¼š
- äº‹ä»¶éœ€è¦è¢«å¤šä¸ªç‹¬ç«‹ç»„ä»¶å¤„ç†
- ç³»ç»Ÿéœ€è¦å¹¿æ’­é‡è¦çŠ¶æ€å˜æ›´
- å®ç°è·¨æœåŠ¡çš„ä¸šåŠ¡æµç¨‹

**ä¼˜åŠ¿**ï¼š
- æ¾è€¦åˆï¼šç”Ÿäº§è€…æ— éœ€çŸ¥é“æ¶ˆè´¹è€…
- å¯æ‰©å±•æ€§ï¼šå¯ç‹¬ç«‹æ·»åŠ æ–°çš„æ¶ˆè´¹è€…
- çµæ´»æ€§ï¼šæ”¯æŒå¤šç§æ¶ˆè´¹æ¨¡å¼

**æŒ‘æˆ˜**ï¼š
- äº‹ä»¶é¡ºåºä¿è¯
- é‡å¤äº‹ä»¶å¤„ç†
- æ¶ˆè´¹è€…æ•…éšœå¤„ç†

### 4.2 äº‹ä»¶æµæ¨¡å¼(Event Streaming)

äº‹ä»¶æµæ¨¡å¼å¤„ç†è¿ç»­çš„äº‹ä»¶æµï¼Œæ”¯æŒå®æ—¶å’Œå†å²äº‹ä»¶å¤„ç†ã€‚

![äº‹ä»¶æµæ¨¡å¼](https://i.imgur.com/event_stream_pattern.png)

**å®ç°æ–¹å¼**ï¼š
```java
// Kafka Streams å¤„ç†ç¤ºä¾‹
@Configuration
public class OrderEventStream {
    @Bean
    public KStream<String, OrderEvent> processOrderStream(StreamsBuilder streamsBuilder) {
        KStream<String, OrderEvent> orderStream = streamsBuilder
            .stream("order-events", Consumed.with(Serdes.String(), new JsonSerde<>(OrderEvent.class)));

        // è¿‡æ»¤å·²æ”¯ä»˜è®¢å•
        KStream<String, OrderEvent> paidOrders = orderStream
            .filter((key, event) -> event.getType() == OrderEventType.PAID);

        // æŒ‰å®¢æˆ·IDåˆ†ç»„å¹¶è®¡æ•°
        KTable<String, Long> customerOrderCount = paidOrders
            .groupBy((key, event) -> event.getCustomerId(), Grouped.with(Serdes.String(), new JsonSerde<>(OrderEvent.class)))
            .count();

        // å°†ç»“æœå†™å…¥è¾“å‡ºä¸»é¢˜
        customerOrderCount.toStream().to("customer-order-counts", Produced.with(Serdes.String(), Serdes.Long()));

        return orderStream;
    }
}
```

**é€‚ç”¨åœºæ™¯**ï¼š
- å®æ—¶åˆ†æå’Œç›‘æ§
- æ•°æ®é›†æˆå’ŒETL
- äº‹ä»¶æº¯æº
- å¤æ‚äº‹ä»¶å¤„ç†

### 4.3 è¯·æ±‚/å“åº”æ¨¡å¼(Request/Response)

è¯·æ±‚/å“åº”æ¨¡å¼æ˜¯ä¸€ç§åŸºäºäº‹ä»¶çš„åŒæ­¥é€šä¿¡æ¨¡å¼ï¼Œé€šè¿‡äº‹ä»¶å®ç°è¯·æ±‚å’Œå“åº”çš„é…å¯¹ã€‚

![è¯·æ±‚/å“åº”æ¨¡å¼](https://i.imgur.com/request_response_pattern.png)

**å®ç°æ–¹å¼**ï¼š
```java
// è¯·æ±‚æ–¹
@Service
public class OrderService {
    @Autowired
    private KafkaTemplate<String, OrderRequestEvent> requestTemplate;
    @Autowired
    private KafkaConsumer<String, OrderResponseEvent> responseConsumer;

    public OrderStatus checkOrderStatus(String orderId) {
        // åˆ›å»ºè¯·æ±‚äº‹ä»¶
        String correlationId = UUID.randomUUID().toString();
        OrderRequestEvent request = new OrderRequestEvent(orderId, correlationId);

        // å‘é€è¯·æ±‚
        requestTemplate.send("order-status-requests", orderId, request);

        // ç­‰å¾…å“åº”
        ConsumerRecords<String, OrderResponseEvent> records = responseConsumer.poll(Duration.ofSeconds(5));
        for (ConsumerRecord<String, OrderResponseEvent> record : records) {
            if (record.value().getCorrelationId().equals(correlationId)) {
                return record.value().getStatus();
            }
        }

        throw new TimeoutException("Order status request timed out");
    }
}

// å“åº”æ–¹
@Service
public class OrderStatusService {
    @KafkaListener(topics = "order-status-requests")
    public void handleStatusRequest(OrderRequestEvent request, @SendTo("order-status-responses") OrderResponseEvent response) {
        OrderStatus status = orderRepository.findById(request.getOrderId())
            .map(Order::getStatus)
            .orElse(OrderStatus.NOT_FOUND);

        return new OrderResponseEvent(
            request.getOrderId(),
            request.getCorrelationId(),
            status
        );
    }
}
```

**é€‚ç”¨åœºæ™¯**ï¼š
- éœ€è¦åŒæ­¥é€šä¿¡çš„åœºæ™¯
- ç®€å•æŸ¥è¯¢æ“ä½œ
- éœ€è¦ç«‹å³å“åº”çš„ä¸šåŠ¡åœºæ™¯

### 4.4 äº‹ä»¶æº¯æºæ¨¡å¼(Event Sourcing)

äº‹ä»¶æº¯æºæ¨¡å¼å°†å®ä½“çš„çŠ¶æ€å˜åŒ–å­˜å‚¨ä¸ºäº‹ä»¶åºåˆ—ï¼Œé€šè¿‡é‡æ”¾äº‹ä»¶é‡å»ºå®ä½“çŠ¶æ€ã€‚

è¯¦ç»†å†…å®¹è¯·å‚è§ç¬¬6èŠ‚ï¼š[äº‹ä»¶æº¯æºå®æˆ˜](#6-äº‹ä»¶æº¯æºå®æˆ˜)

### 4.5 CQRSæ¨¡å¼(Command Query Responsibility Segregation)

CQRSæ¨¡å¼å°†è¯»å†™æ“ä½œåˆ†ç¦»ä¸ºå‘½ä»¤æ¨¡å‹(å†™)å’ŒæŸ¥è¯¢æ¨¡å‹(è¯»)ï¼Œé€šè¿‡äº‹ä»¶åŒæ­¥ä¸¤è€…ã€‚

è¯¦ç»†å†…å®¹è¯·å‚è§ç¬¬7èŠ‚ï¼š[CQRSä¸äº‹ä»¶é©±åŠ¨ç»“åˆ](#7-cqrsä¸äº‹ä»¶é©±åŠ¨ç»“åˆ)

---

## 5. äº‹ä»¶æµå¤„ç†å®æˆ˜

### 5.1 äº‹ä»¶æµå¤„ç†æ¦‚å¿µ

äº‹ä»¶æµå¤„ç†(Event Stream Processing, ESP)æ˜¯å¯¹è¿ç»­äº‹ä»¶æµè¿›è¡Œå®æ—¶å¤„ç†çš„æŠ€æœ¯ï¼Œæ”¯æŒè¿‡æ»¤ã€è½¬æ¢ã€èšåˆç­‰æ“ä½œã€‚

**äº‹ä»¶æµç‰¹æ€§**ï¼š
- **æ— é™æ€§**ï¼šäº‹ä»¶æµç†è®ºä¸Šæ˜¯æ— é™çš„
- **è¿ç»­æ€§**ï¼šäº‹ä»¶æŒç»­äº§ç”Ÿ
- **æ—¶åºæ€§**ï¼šäº‹ä»¶æœ‰æ˜ç¡®çš„æ—¶é—´é¡ºåº
- **æ— åºæ€§**ï¼šå®é™…ç³»ç»Ÿä¸­äº‹ä»¶å¯èƒ½æ— åºåˆ°è¾¾

**äº‹ä»¶æµå¤„ç†æ“ä½œ**ï¼š
- **è¿‡æ»¤(Filtering)**ï¼šé€‰æ‹©æ»¡è¶³æ¡ä»¶çš„äº‹ä»¶
- **è½¬æ¢(Transformation)**ï¼šæ”¹å˜äº‹ä»¶æ ¼å¼æˆ–å†…å®¹
- **èšåˆ(Aggregation)**ï¼šè®¡ç®—äº‹ä»¶æµçš„ç»Ÿè®¡ä¿¡æ¯
- **è¿æ¥(Joining)**ï¼šå…³è”å¤šä¸ªäº‹ä»¶æµ
- **æ’åº(Ordering)**ï¼šé‡ç»„äº‹ä»¶é¡ºåº
- **çª—å£(Windowing)**ï¼šåœ¨æ—¶é—´æˆ–æ•°é‡çª—å£ä¸Šå¤„ç†äº‹ä»¶

### 5.2 Kafka Streamså®æˆ˜

Kafka Streamsæ˜¯ä¸€ä¸ªç”¨äºæ„å»ºæµå¤„ç†åº”ç”¨çš„å®¢æˆ·ç«¯åº“ï¼ŒåŸºäºKafkaè¿›è¡Œäº‹ä»¶æµå¤„ç†ã€‚

**ç¯å¢ƒé…ç½®**ï¼š
```java
@Configuration
@EnableKafkaStreams
public class KafkaStreamsConfig {
    @Value("${spring.kafka.bootstrap-servers}")
    private String bootstrapServers;

    @Bean(name = KafkaStreamsDefaultConfiguration.DEFAULT_STREAMS_CONFIG_BEAN_NAME)
    public StreamsConfig streamsConfig() {
        Map<String, Object> config = new HashMap<>();
        config.put(StreamsConfig.APPLICATION_ID_CONFIG, "order-processing-app");
        config.put(StreamsConfig.BOOTSTRAP_SERVERS_CONFIG, bootstrapServers);
        config.put(StreamsConfig.DEFAULT_KEY_SERDE_CLASS_CONFIG, Serdes.String().getClass().getName());
        config.put(StreamsConfig.DEFAULT_VALUE_SERDE_CLASS_CONFIG, JsonSerde.class.getName());
        config.put(StreamsConfig.PROCESSING_GUARANTEE_CONFIG, StreamsConfig.AT_LEAST_ONCE);
        return new StreamsConfig(config);
    }
}
```

**æµå¤„ç†æ‹“æ‰‘**ï¼š
```java
@Service
public class OrderStreamProcessor {
    @Bean
    public KStream<String, OrderEvent> processOrderStream(StreamsBuilder builder) {
        // ä»ä¸»é¢˜è¯»å–è®¢å•äº‹ä»¶æµ
        KStream<String, OrderEvent> orderStream = builder
            .stream("order-events", Consumed.with(Serdes.String(), new JsonSerde<>(OrderEvent.class)));

        // 1. è¿‡æ»¤é«˜ä»·å€¼è®¢å•
        KStream<String, OrderEvent> highValueOrders = orderStream
            .filter((key, event) -> event.getAmount() > 1000);

        highValueOrders.to("high-value-orders");

        // 2. æŒ‰å®¢æˆ·IDåˆ†ç»„å¹¶è®¡ç®—æ€»è®¢å•é‡‘é¢
        KTable<String, Double> customerTotalSpending = orderStream
            .filter((key, event) -> event.getType() == OrderEventType.COMPLETED)
            .groupBy((key, event) -> event.getCustomerId(), Grouped.with(Serdes.String(), new JsonSerde<>(OrderEvent.class)))
            .aggregate(
                () -> 0.0,
                (customerId, event, total) -> total + event.getAmount(),
                Materialized.<String, Double, KeyValueStore<Bytes, byte[]>>as("customer-total-spending")
                    .withKeySerde(Serdes.String())
                    .withValueSerde(Serdes.Double())
            );

        customerTotalSpending.toStream().to("customer-total-spending");

        // 3. æŒ‰æ—¶é—´çª—å£ç»Ÿè®¡è®¢å•é‡
        KTable<Windowed<String>, Long> hourlyOrderCounts = orderStream
            .groupBy((key, event) -> event.getRegion(), Grouped.with(Serdes.String(), new JsonSerde<>(OrderEvent.class)))
            .windowedBy(TimeWindows.of(Duration.ofHours(1)))
            .count();

        hourlyOrderCounts.toStream()
            .map((windowedKey, count) -> new KeyValue<>(windowedKey.key() + "|" + windowedKey.window().startTime(), count))
            .to("hourly-order-counts");

        return orderStream;
    }
}
```

### 5.3 Flinkæµå¤„ç†å®æˆ˜

Apache Flinkæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼æµå¤„ç†æ¡†æ¶ï¼Œæ”¯æŒé«˜ååã€ä½å»¶è¿Ÿçš„äº‹ä»¶æµå¤„ç†ã€‚

**Flinkä½œä¸šå®ç°**ï¼š
```java
public class OrderProcessingJob {
    public static void main(String[] args) throws Exception {
        // åˆ›å»ºFlinkæ‰§è¡Œç¯å¢ƒ
        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();
        env.setStreamTimeCharacteristic(TimeCharacteristic.EventTime);

        // é…ç½®Kafkaæ¶ˆè´¹è€…
        Properties properties = new Properties();
        properties.setProperty("bootstrap.servers", "localhost:9092");
        properties.setProperty("group.id", "flink-order-processing");

        // è¯»å–Kafkaäº‹ä»¶æµ
        DataStream<OrderEvent> orderStream = env
            .addSource(new FlinkKafkaConsumer<>(
                "order-events",
                new JsonDeserializationSchema<>(OrderEvent.class),
                properties
            ))
            .assignTimestampsAndWatermarks(
                WatermarkStrategy.<OrderEvent>
                    forBoundedOutOfOrderness(Duration.ofSeconds(5))
                    .withTimestampAssigner((event, timestamp) -> event.getTimestamp())
            );

        // å¤„ç†é«˜ä»·å€¼è®¢å•
        DataStream<OrderEvent> highValueOrders = orderStream
            .filter(event -> event.getAmount() > 1000);

        highValueOrders.addSink(new FlinkKafkaProducer<>(
            "high-value-orders",
            new JsonSerializationSchema<>(),
            properties
        ));

        // æŒ‰å®¢æˆ·IDåˆ†ç»„å¹¶è®¡ç®—æ€»è®¢å•é‡‘é¢
        DataStream<Tuple2<String, Double>> customerTotalSpending = orderStream
            .filter(event -> event.getType() == OrderEventType.COMPLETED)
            .keyBy(OrderEvent::getCustomerId)
            .window(TumblingProcessingTimeWindows.of(Time.hours(1)))
            .aggregate(new OrderAmountAggregator());

        customerTotalSpending.addSink(new FlinkKafkaProducer<>(
            "customer-total-spending",
            new KeyedSerializationSchemaWrapper<>(new JsonSerializationSchema<>()),
            properties
        ));

        // æ‰§è¡ŒFlinkä½œä¸š
        env.execute("Order Processing Job");
    }

    public static class OrderAmountAggregator implements AggregateFunction<OrderEvent, Double, Tuple2<String, Double>> {
        @Override
        public Double createAccumulator() {
            return 0.0;
        }

        @Override
        public Double add(OrderEvent event, Double accumulator) {
            return accumulator + event.getAmount();
        }

        @Override
        public Tuple2<String, Double> getResult(Double accumulator) {
            return new Tuple2<>(event.getCustomerId(), accumulator);
        }

        @Override
        public Double merge(Double a, Double b) {
            return a + b;
        }
    }
}
```

### 5.4 äº‹ä»¶çª—å£å¤„ç†

çª—å£å¤„ç†æ˜¯äº‹ä»¶æµå¤„ç†ä¸­çš„æ ¸å¿ƒæ¦‚å¿µï¼Œç”¨äºå°†æ— é™äº‹ä»¶æµåˆ’åˆ†ä¸ºæœ‰é™çš„äº‹ä»¶é›†åˆè¿›è¡Œå¤„ç†ã€‚

**çª—å£ç±»å‹**ï¼š
- **æ»šåŠ¨çª—å£(Tumbling Window)**ï¼šå›ºå®šå¤§å°ï¼Œæ— é‡å 
- **æ»‘åŠ¨çª—å£(Sliding Window)**ï¼šå›ºå®šå¤§å°ï¼Œæœ‰é‡å 
- **ä¼šè¯çª—å£(Session Window)**ï¼šåŸºäºä¼šè¯é—´éš™åˆ’åˆ†
- **è®¡æ•°çª—å£(Count Window)**ï¼šåŸºäºäº‹ä»¶æ•°é‡åˆ’åˆ†

**çª—å£å¤„ç†å®ç°**ï¼š
```java
// Kafka Streamsçª—å£å¤„ç†ç¤ºä¾‹
KTable<Windowed<String>, Long> dailySales = orderStream
    .filter((key, event) -> event.getType() == OrderEventType.COMPLETED)
    .groupBy((key, event) -> event.getProductId())
    .windowedBy(TimeWindows.of(Duration.ofDays(1)))
    .count(Materialized.as("daily-sales-count"));

// æ»‘åŠ¨çª—å£ç¤ºä¾‹
KTable<Windowed<String>, Double> hourlySalesSliding = orderStream
    .filter((key, event) -> event.getType() == OrderEventType.COMPLETED)
    .groupBy((key, event) -> event.getRegion())
    .windowedBy(TimeWindows.of(Duration.ofHours(1)).advanceBy(Duration.ofMinutes(15)))
    .aggregate(
        () -> 0.0,
        (key, event, total) -> total + event.getAmount(),
        Materialized.as("hourly-sales-sliding")
    );

// ä¼šè¯çª—å£ç¤ºä¾‹
KTable<Windowed<String>, Double> sessionSales = orderStream
    .filter((key, event) -> event.getType() == OrderEventType.COMPLETED)
    .groupBy((key, event) -> event.getCustomerId())
    .windowedBy(SessionWindows.with(Duration.ofMinutes(30)))
    .aggregate(
        () -> 0.0,
        (key, event, total) -> total + event.getAmount(),
        Materialized.as("session-sales")
    );
```

---

## 6. äº‹ä»¶æº¯æºå®æˆ˜

### 6.1 äº‹ä»¶æº¯æºæ ¸å¿ƒæ¦‚å¿µ

äº‹ä»¶æº¯æº(Event Sourcing)æ˜¯ä¸€ç§æ•°æ®å­˜å‚¨æ¨¡å¼ï¼Œå®ƒå°†å®ä½“çš„çŠ¶æ€å˜åŒ–å­˜å‚¨ä¸ºäº‹ä»¶åºåˆ—ï¼Œè€Œä¸æ˜¯å­˜å‚¨å®ä½“çš„å½“å‰çŠ¶æ€ã€‚é€šè¿‡é‡æ”¾äº‹ä»¶å¯ä»¥é‡å»ºå®ä½“çš„ä»»ä½•å†å²çŠ¶æ€ã€‚

**äº‹ä»¶æº¯æºä¼˜åŠ¿**ï¼š
- å®Œæ•´çš„å®¡è®¡è·Ÿè¸ª
- æ”¯æŒä»»æ„æ—¶é—´ç‚¹çš„çŠ¶æ€é‡å»º
- ç®€åŒ–å¤æ‚ä¸šåŠ¡é€»è¾‘
- æ”¯æŒäº‹ä»¶æµå¤„ç†
- æé«˜ç³»ç»Ÿå¼¹æ€§

**äº‹ä»¶æº¯æºæŒ‘æˆ˜**ï¼š
- å­¦ä¹ æ›²çº¿é™¡å³­
- çŠ¶æ€é‡å»ºæ€§èƒ½
- äº‹ä»¶schemaæ¼”è¿›
- å¤æ‚æŸ¥è¯¢å¤„ç†

### 6.2 äº‹ä»¶æº¯æºå®ç°æ¶æ„

![äº‹ä»¶æº¯æºæ¶æ„](https://i.imgur.com/event_sourcing_architecture.png)

**æ ¸å¿ƒç»„ä»¶**ï¼š
- **äº‹ä»¶å­˜å‚¨**ï¼šä¸“é—¨å­˜å‚¨äº‹ä»¶çš„æ•°æ®åº“
- **èšåˆæ ¹**ï¼šåŸºäºäº‹ä»¶æµé‡å»ºçš„ä¸šåŠ¡å®ä½“
- **å‘½ä»¤å¤„ç†å™¨**ï¼šå¤„ç†å‘½ä»¤å¹¶ç”Ÿæˆäº‹ä»¶
- **äº‹ä»¶å‘å¸ƒè€…**ï¼šå‘å¸ƒæ–°ç”Ÿæˆçš„äº‹ä»¶
- **æŠ•å½±**ï¼šä»äº‹ä»¶æµæ„å»ºæŸ¥è¯¢æ¨¡å‹

### 6.3 Axon Frameworkå®æˆ˜

Axon Frameworkæ˜¯ä¸€ä¸ªJavaæ¡†æ¶ï¼Œæä¾›äº†äº‹ä»¶æº¯æºå’ŒCQRSçš„å®Œæ•´å®ç°ã€‚

**èšåˆæ ¹å®ç°**ï¼š
```java
@Aggregate
public class OrderAggregate {
    @AggregateIdentifier
    private String orderId;
    private String customerId;
    private List<OrderItem> items;
    private OrderStatus status;
    private double totalAmount;

    // ç©ºæ„é€ å‡½æ•°ï¼Œç”¨äºäº‹ä»¶æº¯æº
    protected OrderAggregate() {
    }

    @CommandHandler
    public OrderAggregate(CreateOrderCommand command) {
        // éªŒè¯å‘½ä»¤
        if (command.getItems().isEmpty()) {
            throw new IllegalArgumentException("Order must contain at least one item");
        }

        // å‘å¸ƒè®¢å•åˆ›å»ºäº‹ä»¶
        AggregateLifecycle.apply(new OrderCreatedEvent(
            command.getOrderId(),
            command.getCustomerId(),
            command.getItems(),
            command.getTotalAmount()
        ));
    }

    @EventSourcingHandler
    public void on(OrderCreatedEvent event) {
        this.orderId = event.getOrderId();
        this.customerId = event.getCustomerId();
        this.items = event.getItems();
        this.totalAmount = event.getTotalAmount();
        this.status = OrderStatus.CREATED;
    }

    @CommandHandler
    public void handle(PayOrderCommand command) {
        if (this.status != OrderStatus.CREATED) {
            throw new IllegalStateException("Only created orders can be paid");
        }

        AggregateLifecycle.apply(new OrderPaidEvent(
            this.orderId,
            command.getPaymentId(),
            command.getPaymentAmount(),
            command.getPaymentDate()
        ));
    }

    @EventSourcingHandler
    public void on(OrderPaidEvent event) {
        if (event.getPaymentAmount() != this.totalAmount) {
            throw new IllegalArgumentException("Payment amount does not match order amount");
        }
        this.status = OrderStatus.PAID;
    }

    @CommandHandler
    public void handle(ShipOrderCommand command) {
        if (this.status != OrderStatus.PAID) {
            throw new IllegalStateException("Only paid orders can be shipped");
        }

        AggregateLifecycle.apply(new OrderShippedEvent(
            this.orderId,
            command.getShipmentId(),
            command.getShippingDate()
        ));
    }

    @EventSourcingHandler
    public void on(OrderShippedEvent event) {
        this.status = OrderStatus.SHIPPED;
    }
}
```

**å‘½ä»¤å’Œäº‹ä»¶å®šä¹‰**ï¼š
```java
// å‘½ä»¤
public class CreateOrderCommand {
    @TargetAggregateIdentifier
    private final String orderId;
    private final String customerId;
    private final List<OrderItem> items;
    private final double totalAmount;

    // constructor, getters
}

public class PayOrderCommand {
    @TargetAggregateIdentifier
    private final String orderId;
    private final String paymentId;
    private final double paymentAmount;
    private final LocalDateTime paymentDate;

    // constructor, getters
}

// äº‹ä»¶
public class OrderCreatedEvent {
    private final String orderId;
    private final String customerId;
    private final List<OrderItem> items;
    private final double totalAmount;
    private final LocalDateTime createdDate;

    // constructor, getters
}

public class OrderPaidEvent {
    private final String orderId;
    private final String paymentId;
    private final double paymentAmount;
    private final LocalDateTime paymentDate;

    // constructor, getters
}
```

**é…ç½®Axon**ï¼š
```java
@Configuration
public class AxonConfig {
    @Bean
    public EventStorageEngine eventStorageEngine(DataSource dataSource) {
        return new JpaEventStorageEngine(dataSource);
    }

    @Bean
    public TokenStore tokenStore(DataSource dataSource) {
        return new JpaTokenStore(dataSource);
    }

    @Bean
    public EventBus eventBus() {
        return new SimpleEventBus();
    }
}
```

**åˆ›å»ºæŠ•å½±**ï¼š
```java
@ProjectionPayload
public class OrderSummaryProjection {
    private final String orderId;
    private final String customerId;
    private final OrderStatus status;
    private final double totalAmount;
    private final LocalDateTime createdDate;

    @ProjectionConstructor
    public OrderSummaryProjection(OrderCreatedEvent event) {
        this.orderId = event.getOrderId();
        this.customerId = event.getCustomerId();
        this.status = OrderStatus.CREATED;
        this.totalAmount = event.getTotalAmount();
        this.createdDate = event.getCreatedDate();
    }

    @EventHandler
    public void on(OrderPaidEvent event, @PayloadType Class<? extends Event> payloadType) {
        this.status = OrderStatus.PAID;
    }

    @EventHandler
    public void on(OrderShippedEvent event) {
        this.status = OrderStatus.SHIPPED;
    }

    // getters
}
```

### 6.5 äº‹ä»¶å­˜å‚¨å®ç°

äº‹ä»¶å­˜å‚¨æ˜¯äº‹ä»¶æº¯æºçš„å…³é”®ç»„ä»¶ï¼Œéœ€è¦æ”¯æŒé«˜ååé‡çš„å†™å…¥å’Œé«˜æ•ˆçš„äº‹ä»¶æµè¯»å–ã€‚

**ä¸»æµäº‹ä»¶å­˜å‚¨æ–¹æ¡ˆ**ï¼š
- **å…³ç³»å‹æ•°æ®åº“**ï¼šPostgreSQL, MySQL
- **æ–‡æ¡£æ•°æ®åº“**ï¼šMongoDB
- **æ—¶åºæ•°æ®åº“**ï¼šInfluxDB, TimescaleDB
- **ä¸“ç”¨äº‹ä»¶å­˜å‚¨**ï¼šEventStoreDB, Axon Server

**EventStoreDBå®æˆ˜**ï¼š
```java
@Configuration
public class EventStoreConfig {
    @Bean
    public EventStore eventStore() {
        ConnectionSettings settings = ConnectionSettings.create()
            .address("localhost:1113")
            .defaultCredentials("admin", "changeit")
            .build();

        return EventStoreFactory.forConnection(settings);
    }

    @Bean
    public EventPublisher eventPublisher(EventStore eventStore) {
        return new EventStoreEventPublisher(eventStore);
    }

    @Bean
    public OrderRepository orderRepository(EventStore eventStore) {
        return new EventSourcedOrderRepository(eventStore);
    }
}

public class EventSourcedOrderRepository implements OrderRepository {
    private final EventStore eventStore;
    private final JsonSerializer serializer;

    public EventSourcedOrderRepository(EventStore eventStore) {
        this.eventStore = eventStore;
        this.serializer = new JsonSerializer();
    }

    @Override
    public Order findById(String orderId) {
        Stream<ResolvedEvent> events = eventStore.readStreamForward("order-" + orderId);
        if (!events.hasNext()) {
            throw new OrderNotFoundException(orderId);
        }

        Order order = new Order();
        events.forEach(event -> {
            OrderEvent orderEvent = deserializeEvent(event);
            order.apply(event);
        });

        return order;
    }

    @Override
    public void save(Order order) {
        List<OrderEvent> pendingEvents = order.getPendingEvents();
        if (pendingEvents.isEmpty()) {
            return;
        }

        String streamName = "order-" + order.getId();
        long expectedVersion = order.getVersion() - pendingEvents.size();

        List<EventData> eventDataList = pendingEvents.stream()
            .map(this::toEventData)
            .collect(Collectors.toList());

        eventStore.appendToStream(streamName, ExpectedVersion.of(expectedVersion), eventDataList);

        order.clearPendingEvents();
    }

    private EventData toEventData(OrderEvent event) {
        String eventType = event.getClass().getSimpleName();
        byte[] data = serializer.serialize(event);
        byte[] metadata = serializer.serialize(new EventMetadata(eventType));

        return new EventData(UUID.randomUUID(), eventType, data, metadata);
    }

    private OrderEvent deserializeEvent(ResolvedEvent resolvedEvent) {
        String eventType = resolvedEvent.getEvent().getEventType();
        byte[] data = resolvedEvent.getEvent().getData();

        try {
            Class<? extends OrderEvent> eventClass = Class.forName("com.example.order.event." + eventType);
            return serializer.deserialize(data, eventClass);
        } catch (ClassNotFoundException e) {
            throw new EventDeserializationException("Could not deserialize event", e);
        }
    }
}
```

---

## 7. CQRSä¸äº‹ä»¶é©±åŠ¨ç»“åˆ

### 7.1 CQRSæ ¸å¿ƒæ¦‚å¿µ

CQRS(å‘½ä»¤æŸ¥è¯¢èŒè´£åˆ†ç¦»)æ˜¯ä¸€ç§æ¶æ„æ¨¡å¼ï¼Œå°†ç³»ç»Ÿåˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š
- **å‘½ä»¤æ¨¡å‹**ï¼šå¤„ç†å†™æ“ä½œï¼Œè´Ÿè´£ç³»ç»ŸçŠ¶æ€å˜æ›´
- **æŸ¥è¯¢æ¨¡å‹**ï¼šå¤„ç†è¯»æ“ä½œï¼Œè´Ÿè´£æ•°æ®æŸ¥è¯¢

![CQRSæ¶æ„](https://i.imgur.com/cqrs_architecture.png)

**CQRSä¼˜åŠ¿**ï¼š
- è¯»å†™æ¨¡å‹å¯ä»¥ç‹¬ç«‹ä¼˜åŒ–
- å¯ä»¥ä½¿ç”¨ä¸åŒçš„æ•°æ®å­˜å‚¨æŠ€æœ¯
- ç®€åŒ–å¤æ‚ä¸šåŠ¡é€»è¾‘
- æé«˜ç³»ç»Ÿå¯æ‰©å±•æ€§
- æ”¯æŒæ›´çµæ´»çš„æŸ¥è¯¢æ¨¡å‹

### 7.2 CQRSå®ç°æ¶æ„

**CQRSæ¶æ„ç»„ä»¶**ï¼š
- **å‘½ä»¤**ï¼šè¯·æ±‚çŠ¶æ€å˜æ›´çš„æ“ä½œ
- **å‘½ä»¤å¤„ç†å™¨**ï¼šå¤„ç†å‘½ä»¤å¹¶ç”Ÿæˆäº‹ä»¶
- **äº‹ä»¶**ï¼šæè¿°çŠ¶æ€å˜æ›´çš„ä¸å¯å˜è®°å½•
- **äº‹ä»¶å­˜å‚¨**ï¼šå­˜å‚¨äº‹ä»¶çš„æŒä¹…åŒ–æœºåˆ¶
- **æŸ¥è¯¢æ¨¡å‹**ï¼šä¼˜åŒ–æŸ¥è¯¢çš„æ•°æ®æ¨¡å‹
- **æŠ•å½±**ï¼šä»äº‹ä»¶æ›´æ–°æŸ¥è¯¢æ¨¡å‹çš„ç»„ä»¶
- **æŸ¥è¯¢å¤„ç†å™¨**ï¼šå¤„ç†æŸ¥è¯¢è¯·æ±‚

### 7.3 Spring Boot CQRSå®æˆ˜

ä½¿ç”¨Spring Bootå®ç°CQRSæ¶æ„ï¼Œç»“åˆäº‹ä»¶é©±åŠ¨é€šä¿¡ã€‚

**å‘½ä»¤æ¨¡å‹å®ç°**ï¼š
```java
// å‘½ä»¤
public class CreateProductCommand {
    private final String productId;
    private final String name;
    private final String description;
    private final double price;
    private final int stock;

    // constructor, getters
}

// å‘½ä»¤å¤„ç†å™¨
@Service
@Transactional
public class ProductCommandService {
    @Autowired
    private ProductRepository productRepository;
    @Autowired
    private EventPublisher eventPublisher;

    public void createProduct(CreateProductCommand command) {
        Product product = new Product(
            command.getProductId(),
            command.getName(),
            command.getDescription(),
            command.getPrice(),
            command.getStock()
        );

        productRepository.save(product);
        eventPublisher.publish(new ProductCreatedEvent(
            command.getProductId(),
            command.getName(),
            command.getDescription(),
            command.getPrice(),
            command.getStock()
        ));
    }

    public void updatePrice(UpdatePriceCommand command) {
        Product product = productRepository.findById(command.getProductId())
            .orElseThrow(() -> new ProductNotFoundException(command.getProductId()));

        double oldPrice = product.getPrice();
        product.setPrice(command.getNewPrice());
        productRepository.save(product);

        eventPublisher.publish(new ProductPriceUpdatedEvent(
            command.getProductId(),
            oldPrice,
            command.getNewPrice()
        ));
    }
}
```

**æŸ¥è¯¢æ¨¡å‹å®ç°**ï¼š
```java
// æŸ¥è¯¢
public class ProductDetailQuery {
    private final String productId;

    // constructor, getters
}

public class ProductSummaryQuery {
    private final int page;
    private final int size;

    // constructor, getters
}

// æŸ¥è¯¢æ¨¡å‹
@Entity
@Table(name = "product_summary")
public class ProductSummary {
    @Id
    private String productId;
    private String name;
    private double price;
    private int stock;
    private boolean active;
    private LocalDateTime createdAt;

    // constructor, getters, setters
}

// æŸ¥è¯¢å¤„ç†å™¨
@Service
@Transactional(readOnly = true)
public class ProductQueryService {
    @Autowired
    private ProductSummaryRepository summaryRepository;
    @Autowired
    private ProductDetailRepository detailRepository;

    public ProductDetailDTO getProductDetail(ProductDetailQuery query) {
        return detailRepository.findByProductId(query.getProductId())
            .orElseThrow(() -> new ProductNotFoundException(query.getProductId()));
    }

    public Page<ProductSummaryDTO> getProductSummaries(ProductSummaryQuery query) {
        return summaryRepository.findAll(
            PageRequest.of(query.getPage(), query.getSize())
        ).map(this::toProductSummaryDTO);
    }

    private ProductSummaryDTO toProductSummaryDTO(ProductSummary summary) {
        return new ProductSummaryDTO(
            summary.getProductId(),
            summary.getName(),
            summary.getPrice(),
            summary.isActive()
        );
    }
}
```

**æŠ•å½±å®ç°**ï¼š
```java
@Service
public class ProductProjection {
    @Autowired
    private ProductSummaryRepository summaryRepository;
    @Autowired
    private ProductDetailRepository detailRepository;

    @EventListener
    public void on(ProductCreatedEvent event) {
        // æ›´æ–°æŸ¥è¯¢æ¨¡å‹
        ProductSummary summary = new ProductSummary(
            event.getProductId(),
            event.getName(),
            event.getPrice(),
            event.getStock(),
            true,
            LocalDateTime.now()
        );
        summaryRepository.save(summary);

        ProductDetail detail = new ProductDetail(
            event.getProductId(),
            event.getName(),
            event.getDescription(),
            event.getPrice(),
            event.getStock(),
            LocalDateTime.now()
        );
        detailRepository.save(detail);
    }

    @EventListener
    public void on(ProductPriceUpdatedEvent event) {
        summaryRepository.findById(event.getProductId())
            .ifPresent(summary -> {
                summary.setPrice(event.getNewPrice());
                summaryRepository.save(summary);
            });

        detailRepository.findById(event.getProductId())
            .ifPresent(detail -> {
                detail.setPrice(event.getNewPrice());
                detail.setUpdatedAt(LocalDateTime.now());
                detailRepository.save(detail);
            });
    }

    @EventListener
    public void on(ProductStockChangedEvent event) {
        summaryRepository.findById(event.getProductId())
            .ifPresent(summary -> {
                summary.setStock(event.getNewStock());
                summaryRepository.save(summary);
            });

        detailRepository.findById(event.getProductId())
            .ifPresent(detail -> {
                detail.setStock(event.getNewStock());
                detail.setUpdatedAt(LocalDateTime.now());
                detailRepository.save(detail);
            });
    }
}
```

---

## 8. äº‹ä»¶é©±åŠ¨æ¶æ„æ¨¡å¼

### 8.1 é¢†åŸŸäº‹ä»¶æ¨¡å¼(Domain Event)

é¢†åŸŸäº‹ä»¶æ¨¡å¼æ•è·é¢†åŸŸä¸­å‘ç”Ÿçš„é‡è¦äº‹ä»¶ï¼Œç”¨äºåœ¨é¢†åŸŸæ¨¡å‹ä¸­ä¼ æ’­çŠ¶æ€å˜æ›´ã€‚

**å®ç°æ–¹å¼**ï¼š
```java
// é¢†åŸŸäº‹ä»¶
@Value
public class OrderCreatedEvent {
    @NonNull String orderId;
    @NonNull String customerId;
    @NonNull List<OrderItem> items;
    @NonNull LocalDateTime createdAt;
}

// é¢†åŸŸæ¨¡å‹
@Entity
public class Order {
    @Id
    private String id;
    private String customerId;
    @OneToMany(cascade = CascadeType.ALL)
    private List<OrderItem> items;
    private OrderStatus status;
    private LocalDateTime createdAt;
    @Transient
    private List<DomainEvent> pendingEvents = new ArrayList<>();

    public static Order create(String orderId, String customerId, List<OrderItem> items) {
        Order order = new Order();
        order.id = orderId;
        order.customerId = customerId;
        order.items = items;
        order.status = OrderStatus.CREATED;
        order.createdAt = LocalDateTime.now();

        // è®°å½•é¢†åŸŸäº‹ä»¶
        order.pendingEvents.add(new OrderCreatedEvent(orderId, customerId, items, order.createdAt));

        return order;
    }

    public void pay(PaymentDetails payment) {
        if (this.status != OrderStatus.CREATED) {
            throw new IllegalStateException("Cannot pay for an order that is not created");
        }

        this.status = OrderStatus.PAID;
        this.pendingEvents.add(new OrderPaidEvent(this.id, payment.getPaymentId(), LocalDateTime.now()));
    }

    // è·å–å¹¶æ¸…é™¤å¾…å¤„ç†äº‹ä»¶
    public List<DomainEvent> releaseEvents() {
        List<DomainEvent> events = new ArrayList<>(pendingEvents);
        pendingEvents.clear();
        return events;
    }
}

// äº‹ä»¶å‘å¸ƒæœåŠ¡
@Service
public class DomainEventPublisher {
    @Autowired
    private ApplicationEventPublisher applicationEventPublisher;
    @Autowired
    private OrderRepository orderRepository;

    @Transactional
    public void publishEvents() {
        List<Order> ordersWithEvents = orderRepository.findWithPendingEvents();

        for (Order order : ordersWithEvents) {
            List<DomainEvent> events = order.releaseEvents();
            for (DomainEvent event : events) {
                applicationEventPublisher.publishEvent(event);
            }
            orderRepository.save(order);
        }
    }
}
```

### 8.2 äº‹ä»¶æµæ¨¡å¼(Event Stream)

äº‹ä»¶æµæ¨¡å¼å°†äº‹ä»¶ç»„ç»‡ä¸ºæœ‰åºçš„äº‹ä»¶æµï¼Œæ”¯æŒå®æ—¶å’Œå†å²å¤„ç†ã€‚

### 8.3 é€šçŸ¥æ¨¡å¼(Notification)

é€šçŸ¥æ¨¡å¼é€šè¿‡äº‹ä»¶é€šçŸ¥å…¶ä»–æœåŠ¡ç³»ç»ŸçŠ¶æ€å˜æ›´ï¼Œå®ç°æ¾è€¦åˆçš„ç³»ç»Ÿé›†æˆã€‚

### 8.4 èšåˆå™¨æ¨¡å¼(Aggregator)

èšåˆå™¨æ¨¡å¼ä»å¤šä¸ªäº‹ä»¶æµæ”¶é›†äº‹ä»¶å¹¶èšåˆå¤„ç†ï¼Œç”Ÿæˆæ–°çš„èšåˆç»“æœã€‚

### 8.5  Sagaæ¨¡å¼

Sagaæ¨¡å¼é€šè¿‡ä¸€ç³»åˆ—æœ¬åœ°äº‹åŠ¡å’Œè¡¥å¿äº‹åŠ¡å®ç°åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œé€šå¸¸åŸºäºäº‹ä»¶é©±åŠ¨ã€‚

è¯¦ç»†å†…å®¹è¯·å‚è§ã€ŠSagaæ¨¡å¼ä¸åˆ†å¸ƒå¼äº‹åŠ¡å®æˆ˜ã€‹

---

## 9. äº‹ä»¶é©±åŠ¨æ€§èƒ½ä¼˜åŒ–

### 9.1 äº‹ä»¶æ‰¹å¤„ç†

äº‹ä»¶æ‰¹å¤„ç†é€šè¿‡å‡å°‘ç½‘ç»œå¾€è¿”å’Œå¤„ç†å¼€é”€æ¥æé«˜ç³»ç»Ÿååé‡ã€‚

**å®ç°æ–¹å¼**ï¼š
```java
@Service
public class BatchEventProcessor {
    @Autowired
    private KafkaTemplate<String, List<Event>> kafkaTemplate;
    private final Queue<Event> eventQueue = new ConcurrentLinkedQueue<>();
    private final ScheduledExecutorService scheduler = Executors.newScheduledThreadPool(1);
    private final int batchSize = 100;
    private final long batchTimeoutMs = 500;

    @PostConstruct
    public void init() {
        // å®šæ—¶æ‰¹å¤„ç†
        scheduler.scheduleAtFixedRate(this::processBatch, 0, batchTimeoutMs, TimeUnit.MILLISECONDS);
    }

    public void queueEvent(Event event) {
        eventQueue.add(event);
        // å¦‚æœè¾¾åˆ°æ‰¹å¤„ç†å¤§å°ï¼Œç«‹å³å¤„ç†
        if (eventQueue.size() >= batchSize) {
            processBatch();
        }
    }

    private void processBatch() {
        if (eventQueue.isEmpty()) {
            return;
        }

        List<Event> batch = new ArrayList<>();
        eventQueue.drainTo(batch, batchSize);

        try {
            // æŒ‰äº‹ä»¶ç±»å‹åˆ†ç»„å‘é€
            Map<String, List<Event>> eventsByType = batch.stream()
                .collect(Collectors.groupingBy(Event::getType));

            for (Map.Entry<String, List<Event>> entry : eventsByType.entrySet()) {
                kafkaTemplate.send(entry.getKey() + "-batch-events", entry.getValue());
            }

            log.info("Processed batch of {} events", batch.size());
        } catch (Exception e) {
            log.error("Failed to process event batch", e);
            // å°†å¤±è´¥çš„äº‹ä»¶é‡æ–°åŠ å…¥é˜Ÿåˆ—
            eventQueue.addAll(batch);
        }
    }

    @PreDestroy
    public void destroy() {
        // å¤„ç†å‰©ä½™äº‹ä»¶
        processBatch();
        scheduler.shutdown();
    }
}
```

### 9.2 äº‹ä»¶å‹ç¼©

äº‹ä»¶å‹ç¼©å‡å°‘äº‹ä»¶æ•°æ®å¤§å°ï¼Œé™ä½å­˜å‚¨å’Œç½‘ç»œä¼ è¾“æˆæœ¬ã€‚

**å®ç°æ–¹å¼**ï¼š
```java
public class CompressedEventSerializer implements Serializer<Event> {
    private final ObjectMapper objectMapper = new ObjectMapper();
    private final GZIPCompressor compressor = new GZIPCompressor();

    @Override
    public byte[] serialize(String topic, Event data) {
        try {
            byte[] jsonBytes = objectMapper.writeValueAsBytes(data);
            return compressor.compress(jsonBytes);
        } catch (Exception e) {
            throw new SerializationException("Error serializing event", e);
        }
    }
}

public class CompressedEventDeserializer implements Deserializer<Event> {
    private final ObjectMapper objectMapper = new ObjectMapper();
    private final GZIPDecompressor decompressor = new GZIPDecompressor();

    @Override
    public Event deserialize(String topic, byte[] data) {
        try {
            byte[] decompressed = decompressor.decompress(data);
            return objectMapper.readValue(decompressed, Event.class);
        } catch (Exception e) {
            throw new SerializationException("Error deserializing event", e);
        }
    }
}
```

### 9.3 å¼‚æ­¥äº‹ä»¶å¤„ç†

å¼‚æ­¥äº‹ä»¶å¤„ç†å…è®¸äº‹ä»¶æ¶ˆè´¹è€…åœ¨åå°å¤„ç†äº‹ä»¶ï¼Œæé«˜ç³»ç»Ÿå“åº”æ€§ã€‚

**å®ç°æ–¹å¼**ï¼š
```java
@Service
public class AsyncEventProcessor {
    @Autowired
    private EventRepository eventRepository;
    @Autowired
    private TaskExecutor taskExecutor;
    @Autowired
    private OrderService orderService;
    @Autowired
    private InventoryService inventoryService;

    @EventListener
    public void handleOrderCreatedEvent(OrderCreatedEvent event) {
        // å¼‚æ­¥å¤„ç†
        taskExecutor.execute(() -> {
            try {
                // å¤„ç†è®¢å•
                orderService.processOrder(event.getOrderId());
                // æ›´æ–°åº“å­˜
                inventoryService.updateInventory(event.getItems());
                // è®°å½•å·²å¤„ç†äº‹ä»¶
                eventRepository.markAsProcessed(event.getEventId());
            } catch (Exception e) {
                log.error("Error processing event {}", event.getEventId(), e);
                eventRepository.markAsFailed(event.getEventId(), e.getMessage());
            }
        });
    }
}
```

### 9.4 äº‹ä»¶åˆ†åŒº

äº‹ä»¶åˆ†åŒºå°†äº‹ä»¶æµåˆ†å¸ƒåˆ°å¤šä¸ªåˆ†åŒºï¼Œå®ç°å¹¶è¡Œå¤„ç†å’Œè´Ÿè½½å‡è¡¡ã€‚

**Kafkaåˆ†åŒºç­–ç•¥**ï¼š
```java
@Configuration
public class KafkaProducerConfig {
    @Bean
    public ProducerFactory<String, Event> producerFactory() {
        Map<String, Object> configProps = new HashMap<>();
        configProps.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, bootstrapServers);
        configProps.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer.class);
        configProps.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, JsonSerializer.class);
        return new DefaultKafkaProducerFactory<>(configProps);
    }

    @Bean
    public KafkaTemplate<String, Event> kafkaTemplate() {
        KafkaTemplate<String, Event> template = new KafkaTemplate<>(producerFactory());
        template.setDefaultTopic("events");
        return template;
    }

    @Bean
    public EventPublisher eventPublisher(KafkaTemplate<String, Event> template) {
        return new KafkaEventPublisher(template, new CustomerIdPartitioner());
    }
}

public class CustomerIdPartitioner implements EventPartitioner {
    @Override
    public int partition(Event event, int numPartitions) {
        if (event instanceof CustomerEvent) {
            String customerId = ((CustomerEvent) event).getCustomerId();
            return Math.abs(customerId.hashCode()) % numPartitions;
        }

        // é»˜è®¤åˆ†åŒºç­–ç•¥
        return Math.abs(event.getEventId().hashCode()) % numPartitions;
    }
}
```

---

## 10. äº‹ä»¶é©±åŠ¨å¯é æ€§ä¿éšœ

### 10.1 äº‹ä»¶å¯é æŠ•é€’

ç¡®ä¿äº‹ä»¶ä»ç”Ÿäº§è€…åˆ°æ¶ˆè´¹è€…çš„å¯é ä¼ é€’æ˜¯äº‹ä»¶é©±åŠ¨æ¶æ„çš„å…³é”®æŒ‘æˆ˜ã€‚

**å®ç°ç­–ç•¥**ï¼š
- **äº‹åŠ¡æ€§äº‹ä»¶å‘å¸ƒ**ï¼šå°†äº‹ä»¶å‘å¸ƒä¸ä¸šåŠ¡æ“ä½œæ”¾åœ¨åŒä¸€äº‹åŠ¡ä¸­
- **æŒä¹…åŒ–äº‹ä»¶**ï¼šåœ¨å¤„ç†å‰æŒä¹…åŒ–äº‹ä»¶
- **ç¡®è®¤æœºåˆ¶**ï¼šå®ç°äº‹ä»¶æ¥æ”¶ç¡®è®¤
- **é‡è¯•æœºåˆ¶**ï¼šè‡ªåŠ¨é‡è¯•å¤±è´¥çš„äº‹ä»¶ä¼ é€’
- **æ­»ä¿¡é˜Ÿåˆ—**ï¼šå¤„ç†æ— æ³•ä¼ é€’çš„äº‹ä»¶

**äº‹åŠ¡æ€§å‘å¸ƒå®ç°**ï¼š
```java
@Service
public class OrderService {
    @Autowired
    private OrderRepository orderRepository;
    @Autowired
    private EventRepository eventRepository;
    @Autowired
    private KafkaTemplate<String, Event> kafkaTemplate;

    @Transactional
    public void createOrder(OrderRequest request) {
        // åˆ›å»ºè®¢å•
        Order order = new Order();
        order.setId(UUID.randomUUID().toString());
        order.setCustomerId(request.getCustomerId());
        order.setItems(request.getItems());
        order.setStatus(OrderStatus.CREATED);
        order.setCreatedAt(LocalDateTime.now());

        orderRepository.save(order);

        // åˆ›å»ºå¹¶ä¿å­˜äº‹ä»¶
        OrderCreatedEvent event = new OrderCreatedEvent();
        event.setEventId(UUID.randomUUID().toString());
        event.setOrderId(order.getId());
        event.setCustomerId(order.getCustomerId());
        event.setItems(order.getItems());
        event.setCreatedAt(order.getCreatedAt());
        event.setStatus(EventStatus.PENDING);

        eventRepository.save(event);

        try {
            // å‘é€äº‹ä»¶
            kafkaTemplate.send("order-events", event.getOrderId(), event).get();

            // æ›´æ–°äº‹ä»¶çŠ¶æ€
            event.setStatus(EventStatus.PUBLISHED);
            eventRepository.save(event);
        } catch (Exception e) {
            // å‘é€å¤±è´¥ï¼Œäº‹åŠ¡å›æ»š
            throw new EventPublicationException("Failed to publish event", e);
        }
    }
}
```

### 10.2 äº‹ä»¶å¹‚ç­‰å¤„ç†

äº‹ä»¶å¹‚ç­‰å¤„ç†ç¡®ä¿é‡å¤æ¥æ”¶åŒä¸€äº‹ä»¶ä¸ä¼šå¯¼è‡´ä¸æ­£ç¡®çš„ç³»ç»ŸçŠ¶æ€ã€‚

**å®ç°ç­–ç•¥**ï¼š
- **å”¯ä¸€äº‹ä»¶ID**ï¼šä¸ºæ¯ä¸ªäº‹ä»¶åˆ†é…å”¯ä¸€ID
- **äº‹ä»¶å¤„ç†æ—¥å¿—**ï¼šè®°å½•å·²å¤„ç†çš„äº‹ä»¶ID
- **å¹‚ç­‰æ“ä½œ**ï¼šè®¾è®¡å¯é‡å¤æ‰§è¡Œçš„æ“ä½œ
- **ç‰ˆæœ¬æ§åˆ¶**ï¼šä½¿ç”¨ç‰ˆæœ¬å·é˜²æ­¢é‡å¤æ›´æ–°

**å¹‚ç­‰æ¶ˆè´¹è€…å®ç°**ï¼š
```java
@Service
public class InventoryEventHandler {
    @Autowired
    private InventoryRepository inventoryRepository;
    @Autowired
    private EventProcessingLogRepository logRepository;

    @KafkaListener(topics = "order-events")
    public void handleOrderEvent(OrderCreatedEvent event) {
        // æ£€æŸ¥äº‹ä»¶æ˜¯å¦å·²å¤„ç†
        if (logRepository.existsByEventId(event.getEventId())) {
            log.info("Event {} already processed, skipping", event.getEventId());
            return;
        }

        try {
            // å¤„ç†äº‹ä»¶
            for (OrderItem item : event.getItems()) {
                inventoryRepository.deductStock(
                    item.getProductId(), 
                    item.getQuantity(),
                    event.getEventId() // ä½¿ç”¨äº‹ä»¶IDä½œä¸ºæ“ä½œID
                );
            }

            // è®°å½•äº‹ä»¶å¤„ç†æ—¥å¿—
            EventProcessingLog log = new EventProcessingLog();
            log.setEventId(event.getEventId());
            log.setEventType(event.getClass().getSimpleName());
            log.setProcessedAt(LocalDateTime.now());
            log.setStatus(ProcessingStatus.SUCCESS);

            logRepository.save(log);
        } catch (Exception e) {
            log.error("Error processing event {}", event.getEventId(), e);
            EventProcessingLog log = new EventProcessingLog();
            log.setEventId(event.getEventId());
            log.setEventType(event.getClass().getSimpleName());
            log.setProcessedAt(LocalDateTime.now());
            log.setStatus(ProcessingStatus.FAILED);
            log.setErrorMessage(e.getMessage());

            logRepository.save(log);
        }
    }
}

// å¹‚ç­‰åº“å­˜æ‰£å‡
@Repository
public class JpaInventoryRepository implements InventoryRepository {
    @Autowired
    private EntityManager entityManager;

    @Transactional
    public void deductStock(String productId, int quantity, String operationId) {
        // æ£€æŸ¥æ“ä½œæ˜¯å¦å·²æ‰§è¡Œ
        if (entityManager.createQuery("SELECT COUNT(*) FROM InventoryOperation WHERE operationId = :opId")
            .setParameter("opId", operationId)
            .getSingleResult() != 0) {
            return;
        }

        // æ‰£å‡åº“å­˜
        int updated = entityManager.createQuery(
                "UPDATE Inventory SET stock = stock - :qty WHERE productId = :prodId AND stock >= :qty")
            .setParameter("prodId", productId)
            .setParameter("qty", quantity)
            .executeUpdate();

        if (updated == 0) {
            throw new InsufficientStockException(productId, quantity);
        }

        // è®°å½•æ“ä½œ
        InventoryOperation operation = new InventoryOperation();
        operation.setOperationId(operationId);
        operation.setProductId(productId);
        operation.setQuantity(quantity);
        operation.setType(OperationType.DEDUCT);
        operation.setTimestamp(LocalDateTime.now());

        entityManager.persist(operation);
    }
}
```

### 10.3 äº‹ä»¶é¡ºåºä¿è¯

ç¡®ä¿äº‹ä»¶æŒ‰æ­£ç¡®é¡ºåºå¤„ç†å¯¹äºç»´æŠ¤ç³»ç»Ÿä¸€è‡´æ€§è‡³å…³é‡è¦ã€‚

**å®ç°ç­–ç•¥**ï¼š
- **åˆ†åŒºé¡ºåº**ï¼šåœ¨åˆ†åŒºå†…ä¿è¯äº‹ä»¶é¡ºåº
- **äº‹ä»¶æ’åºé”®**ï¼šä½¿ç”¨ä¸šåŠ¡é”®ä½œä¸ºæ’åºé”®
- **ç‰ˆæœ¬æ§åˆ¶**ï¼šä½¿ç”¨ç‰ˆæœ¬å·ç¡®ä¿é¡ºåºæ›´æ–°
- **æ—¶é—´æˆ³æ’åº**ï¼šåŸºäºäº‹ä»¶æ—¶é—´æˆ³æ’åº
- **çŠ¶æ€æœº**ï¼šå®ç°çŠ¶æ€è½¬æ¢éªŒè¯

**Kafkaé¡ºåºä¿è¯å®ç°**ï¼š
```java
@Configuration
public class KafkaConsumerConfig {
    @Bean
    public ConsumerFactory<String, Event> consumerFactory() {
        Map<String, Object> props = new HashMap<>();
        props.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, bootstrapServers);
        props.put(ConsumerConfig.GROUP_ID_CONFIG, "inventory-service");
        props.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class);
        props.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, JsonDeserializer.class);
        // é…ç½®ä¸ºå•çº¿ç¨‹æ¶ˆè´¹ï¼Œä¿è¯åˆ†åŒºå†…é¡ºåº
        props.put(ConsumerConfig.MAX_POLL_RECORDS_CONFIG, 100);
        props.put(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG, false);
        return new DefaultKafkaConsumerFactory<>(props);
    }

    @Bean
    public ConcurrentKafkaListenerContainerFactory<String, Event> kafkaListenerContainerFactory() {
        ConcurrentKafkaListenerContainerFactory<String, Event> factory = 
            new ConcurrentKafkaListenerContainerFactory<>();
        factory.setConsumerFactory(consumerFactory());
        // è®¾ç½®å¹¶å‘åº¦ç­‰äºåˆ†åŒºæ•°
        factory.setConcurrency(3);
        // æ‰¹å¤„ç†
        factory.setBatchListener(true);
        // è®¾ç½® AckMode ä¸ºæ‰‹åŠ¨ç¡®è®¤
        factory.getContainerProperties().setAckMode(AckMode.MANUAL_IMMEDIATE);
        // è®¾ç½®æ‰¹å¤„ç†é”™è¯¯å¤„ç†å™¨
        factory.setBatchErrorHandler(new SeekToCurrentBatchErrorHandler());
        return factory;
    }
}

@Service
public class OrderedEventProcessor {
    @Autowired
    private EventOrderingService orderingService;

    @KafkaListener(topics = "product-events", containerFactory = "kafkaListenerContainerFactory")
    public void processEvents(List<ConsumerRecord<String, Event>> records, Acknowledgment ack) {
        try {
            // æŒ‰äº‹ä»¶IDå’Œæ—¶é—´æˆ³æ’åº
            List<ConsumerRecord<String, Event>> orderedRecords = orderingService.orderEvents(records);

            // å¤„ç†æ’åºåçš„äº‹ä»¶
            for (ConsumerRecord<String, Event> record : orderedRecords) {
                processSingleEvent(record.value());
            }

            // æ‰‹åŠ¨ç¡®è®¤
            ack.acknowledge();
        } catch (Exception e) {
            log.error("Error processing events batch", e);
            // ä¸ç¡®è®¤ï¼Œè®©Kafkaé‡æ–°æŠ•é€’
        }
    }

    private void processSingleEvent(Event event) {
        // å¤„ç†å•ä¸ªäº‹ä»¶
        if (event instanceof ProductCreatedEvent) {
            handleProductCreated((ProductCreatedEvent) event);
        } else if (event instanceof ProductUpdatedEvent) {
            handleProductUpdated((ProductUpdatedEvent) event);
        } else if (event instanceof ProductDeletedEvent) {
            handleProductDeleted((ProductDeletedEvent) event);
        }
    }
}
```

### 10.4 åˆ†å¸ƒå¼è¿½è¸ª

åˆ†å¸ƒå¼è¿½è¸ªæä¾›äº†è·¨æœåŠ¡è·Ÿè¸ªäº‹ä»¶æµçš„èƒ½åŠ›ï¼Œæœ‰åŠ©äºé—®é¢˜æ’æŸ¥å’Œæ€§èƒ½ä¼˜åŒ–ã€‚

**Spring Cloud Sleuthä¸Zipkinå®ç°**ï¼š
```java
@Configuration
@EnableZipkinServer
public class ZipkinConfig {
}

@RestController
public class OrderController {
    private static final Logger logger = LoggerFactory.getLogger(OrderController.class);

    @Autowired
    private OrderService orderService;

    @PostMapping("/orders")
    public ResponseEntity<OrderDTO> createOrder(@RequestBody @Valid OrderRequest request) {
        logger.info("Received order creation request");
        OrderDTO order = orderService.createOrder(request);
        logger.info("Order created with id: {}", order.getId());
        return ResponseEntity.status(HttpStatus.CREATED).body(order);
    }
}

@Service
public class OrderService {
    private static final Logger logger = LoggerFactory.getLogger(OrderService.class);

    @Autowired
    private OrderRepository orderRepository;
    @Autowired
    private KafkaTemplate<String, OrderCreatedEvent> kafkaTemplate;
    @Autowired
    private Tracer tracer;

    public OrderDTO createOrder(OrderRequest request) {
        logger.info("Creating new order");

        // åˆ›å»ºè®¢å•
        Order order = new Order();
        order.setId(UUID.randomUUID().toString());
        order.setItems(request.getItems());
        order.setStatus(OrderStatus.CREATED);
        order.setCreatedAt(LocalDateTime.now());

        orderRepository.save(order);

        // åˆ›å»ºäº‹ä»¶ï¼Œæ·»åŠ è¿½è¸ªä¿¡æ¯
        OrderCreatedEvent event = new OrderCreatedEvent(order);
        event.setTraceId(tracer.currentSpan().context().traceIdString());
        event.setSpanId(tracer.currentSpan().context().spanIdString());

        // å‘å¸ƒäº‹ä»¶
        logger.info("Publishing OrderCreatedEvent for order: {}", order.getId());
        kafkaTemplate.send("order-events", order.getId(), event);

        return mapToDTO(order);
    }
}
```

---

## 11. ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ

### 11.1 äº‹ä»¶ç›‘æ§ä¸å¯è§‚æµ‹æ€§

**å…³é”®ç›‘æ§æŒ‡æ ‡**ï¼š
- äº‹ä»¶ååé‡ï¼šæ¯ç§’å¤„ç†çš„äº‹ä»¶æ•°é‡
- äº‹ä»¶å»¶è¿Ÿï¼šäº‹ä»¶ä»äº§ç”Ÿåˆ°å¤„ç†çš„æ—¶é—´
- äº‹ä»¶æˆåŠŸç‡ï¼šæˆåŠŸå¤„ç†çš„äº‹ä»¶ç™¾åˆ†æ¯”
- äº‹ä»¶å¤§å°ï¼šå¹³å‡äº‹ä»¶å¤§å°
- æ¶ˆè´¹è€…æ»åï¼šæ¶ˆè´¹è€…è½åç”Ÿäº§è€…çš„äº‹ä»¶æ•°é‡
- é‡è¯•æ¬¡æ•°ï¼šäº‹ä»¶å¤„ç†çš„å¹³å‡é‡è¯•æ¬¡æ•°

**Prometheusç›‘æ§å®ç°**ï¼š
```java
@Service
public class EventMetricsService {
    private final MeterRegistry meterRegistry;
    private final Counter eventReceivedCounter;
    private final Counter eventProcessedCounter;
    private final Counter eventFailedCounter;
    private final Timer eventProcessingTimer;

    public EventMetricsService(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        this.eventReceivedCounter = Counter.builder("event.received.total")
            .description("Total number of received events")
            .tag("application", "order-service")
            .register(meterRegistry);

        this.eventProcessedCounter = Counter.builder("event.processed.total")
            .description("Total number of processed events")
            .tag("application", "order-service")
            .register(meterRegistry);

        this.eventFailedCounter = Counter.builder("event.failed.total")
            .description("Total number of failed events")
            .tag("application", "order-service")
            .register(meterRegistry);

        this.eventProcessingTimer = Timer.builder("event.processing.time")
            .description("Time taken to process events")
            .tag("application", "order-service")
            .register(meterRegistry);
    }

    public <T> void recordEventProcessing(String eventType, String status, Runnable processing) {
        eventReceivedCounter.increment();

        Timer.Sample sample = Timer.start(meterRegistry);
        try {
            processing.run();
            eventProcessedCounter.increment();
            meterRegistry.counter("event.type.processed", "type", eventType).increment();
        } catch (Exception e) {
            eventFailedCounter.increment();
            meterRegistry.counter("event.type.failed", "type", eventType).increment();
            throw e;
        } finally {
            sample.stop(eventProcessingTimer);
            meterRegistry.gauge("event.status.current", 
                Tags.of("type", eventType, "status", status), 
                new AtomicInteger(1));
        }
    }
}
```

### 11.2 äº‹ä»¶é©±åŠ¨æµ‹è¯•ç­–ç•¥

**æµ‹è¯•ç±»å‹**ï¼š
- **å•å…ƒæµ‹è¯•**ï¼šæµ‹è¯•å•ä¸ªäº‹ä»¶å¤„ç†å™¨
- **é›†æˆæµ‹è¯•**ï¼šæµ‹è¯•äº‹ä»¶æµå’Œå¤„ç†é“¾
- **ç«¯åˆ°ç«¯æµ‹è¯•**ï¼šæµ‹è¯•æ•´ä¸ªäº‹ä»¶é©±åŠ¨æµç¨‹
- **è´Ÿè½½æµ‹è¯•**ï¼šæµ‹è¯•äº‹ä»¶å¤„ç†æ€§èƒ½
- **æ•…éšœæ³¨å…¥æµ‹è¯•**ï¼šæµ‹è¯•ç³»ç»Ÿå¼¹æ€§

**äº‹ä»¶å¤„ç†å™¨å•å…ƒæµ‹è¯•**ï¼š
```java
@ExtendWith(MockitoExtension.class)
public class OrderEventHandlerTest {
    @Mock
    private OrderRepository orderRepository;
    @Mock
    private InventoryService inventoryService;
    @InjectMocks
    private OrderEventHandler eventHandler;

    @Test
    public void testOrderCreatedEventHandling() {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        OrderCreatedEvent event = new OrderCreatedEvent();
        event.setEventId("event-123");
        event.setOrderId("order-123");
        event.setCustomerId("customer-123");
        event.setItems(Arrays.asList(
            new OrderItem("product-1", 2),
            new OrderItem("product-2", 1)
        ));

        // æ‰§è¡Œæµ‹è¯•
        eventHandler.handle(event);

        // éªŒè¯ç»“æœ
        verify(inventoryService, times(1)).deductInventory(eq(event.getItems()));
        verify(orderRepository, times(1)).findById(eq(event.getOrderId()));
    }
}
```

**é›†æˆæµ‹è¯•**ï¼š
```java
@SpringBootTest
@AutoConfigureMockMvc
@TestPropertySource(properties = {
    "spring.kafka.bootstrap-servers=${spring.embedded.kafka.brokers}"
})
@EmbeddedKafka(partitions = 1, topics = {"order-events", "inventory-events"})
public class EventFlowIntegrationTest {
    @Autowired
    private EmbeddedKafkaBroker embeddedKafkaBroker;
    @Autowired
    private OrderService orderService;
    @Autowired
    private InventoryRepository inventoryRepository;
    @Autowired
    private KafkaConsumer<String, InventoryEvent> inventoryEventConsumer;

    @BeforeEach
    public void setup() {
        // è®¾ç½®æµ‹è¯•æ•°æ®
        inventoryRepository.addStock("product-1", 10);
        inventoryRepository.addStock("product-2", 5);

        // è®¾ç½®æ¶ˆè´¹è€…
        Map<String, Object> consumerProps = KafkaTestUtils.consumerProps(
            "test-group", "true", embeddedKafkaBroker);
        inventoryEventConsumer = new DefaultKafkaConsumerFactory<>(consumerProps)
            .createConsumer();
        embeddedKafkaBroker.consumeFromAnEmbeddedTopic(inventoryEventConsumer, "inventory-events");
    }

    @Test
    public void testOrderEventFlow() throws Exception {
        // åˆ›å»ºè®¢å•
        OrderRequest request = new OrderRequest();
        request.setItems(Arrays.asList(
            new OrderItem("product-1", 2),
            new OrderItem("product-2", 1)
        ));

        OrderDTO order = orderService.createOrder(request);
        assertNotNull(order);

        // éªŒè¯è®¢å•äº‹ä»¶å·²å¤„ç†
        ConsumerRecords<String, InventoryEvent> records = KafkaTestUtils.getRecords(inventoryEventConsumer, 10000);
        assertThat(records.count()).isGreaterThan(0);
        
        // éªŒè¯åº“å­˜å·²æ›´æ–°
        int remainingStock1 = inventoryRepository.getStock("product-1");
        int remainingStock2 = inventoryRepository.getStock("product-2");
        assertThat(remainingStock1).isEqualTo(8); // 10 - 2
        assertThat(remainingStock2).isEqualTo(4); // 5 - 1
    }
}

### 11.3 äº‹ä»¶é©±åŠ¨éƒ¨ç½²ç­–ç•¥

#### 11.3.1 ç‹¬ç«‹éƒ¨ç½²

å°†äº‹ä»¶ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…éƒ¨ç½²ä¸ºç‹¬ç«‹æœåŠ¡ï¼Œé€šè¿‡æ¶ˆæ¯ä»£ç†é€šä¿¡ï¼Œå®ç°æœ€å¤§ç¨‹åº¦çš„è§£è€¦å’Œç‹¬ç«‹æ‰©å±•ã€‚

**ä¼˜åŠ¿**ï¼š
- æŠ€æœ¯æ ˆçµæ´»æ€§ï¼šå¯ä½¿ç”¨ä¸åŒæŠ€æœ¯æ ˆå¼€å‘ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…
- ç‹¬ç«‹æ‰©å±•ï¼šå¯æ ¹æ®è´Ÿè½½ç‹¬ç«‹æ‰©å±•å„ç»„ä»¶
- æ•…éšœéš”ç¦»ï¼šå•ä¸ªç»„ä»¶æ•…éšœä¸ä¼šå½±å“æ•´ä¸ªç³»ç»Ÿ

**å®ç°æ–¹å¼**ï¼š
- ç”Ÿäº§è€…æœåŠ¡ã€æ¶ˆè´¹è€…æœåŠ¡ã€æ¶ˆæ¯ä»£ç†åˆ†åˆ«éƒ¨ç½²
- ä½¿ç”¨å®¹å™¨ç¼–æ’å·¥å…·ï¼ˆå¦‚Kubernetesï¼‰ç®¡ç†æœåŠ¡
- é€šè¿‡æœåŠ¡å‘ç°å®ç°æœåŠ¡é—´é€šä¿¡

#### 11.3.2 æµå¤„ç†éƒ¨ç½²

å¯¹äºäº‹ä»¶æµå¤„ç†åº”ç”¨ï¼Œé‡‡ç”¨ä¸“ç”¨çš„æµå¤„ç†é›†ç¾¤éƒ¨ç½²æ¨¡å¼ã€‚

**Kafka Streamséƒ¨ç½²ç­–ç•¥**ï¼š
- åº”ç”¨å®ä¾‹æ•°ç­‰äºæˆ–å°äºè¾“å…¥ä¸»é¢˜åˆ†åŒºæ•°
- é…ç½®é€‚å½“çš„çŠ¶æ€å­˜å‚¨å’Œç¼“å­˜
- å®ç°åº”ç”¨é‡å¯æ—¶çš„çŠ¶æ€æ¢å¤æœºåˆ¶
- é…ç½®ç›‘æ§æŒ‡æ ‡è·Ÿè¸ªæµå¤„ç†å»¶è¿Ÿ

**Flinkéƒ¨ç½²æ¶æ„**ï¼š
- JobManagerï¼šè´Ÿè´£ä½œä¸šè°ƒåº¦å’Œèµ„æºç®¡ç†
- TaskManagerï¼šè´Ÿè´£å®é™…æ•°æ®å¤„ç†
- é«˜å¯ç”¨é…ç½®ï¼šä½¿ç”¨ZooKeeperå®ç°çŠ¶æ€æŒä¹…åŒ–
- æ£€æŸ¥ç‚¹æœºåˆ¶ï¼šå®šæœŸä¿å­˜ä½œä¸šçŠ¶æ€

### 11.4 äº‹ä»¶å®‰å…¨æœ€ä½³å®è·µ

#### 11.4.1 äº‹ä»¶æ•°æ®åŠ å¯†

- **ä¼ è¾“åŠ å¯†**ï¼šä½¿ç”¨TLS/SSLåŠ å¯†äº‹ä»¶ä¼ è¾“é€šé“
- **å­˜å‚¨åŠ å¯†**ï¼šåŠ å¯†æŒä¹…åŒ–çš„äº‹ä»¶æ•°æ®
- **å­—æ®µçº§åŠ å¯†**ï¼šå¯¹æ•æ„Ÿå­—æ®µï¼ˆå¦‚ä¸ªäººä¿¡æ¯ï¼‰å•ç‹¬åŠ å¯†

**KafkaåŠ å¯†é…ç½®**ï¼š
```properties
# ä¼ è¾“åŠ å¯†
security.protocol=SSL
ssl.truststore.location=/path/to/truststore.jks
ssl.truststore.password=truststore-password
ssl.keystore.location=/path/to/keystore.jks
ssl.keystore.password=keystore-password
ssl.key.password=key-password

# æ•°æ®åŠ å¯†ï¼ˆKafka 2.8+ï¼‰
server.encryption.key=your-encryption-key
```

#### 11.4.2 äº‹ä»¶è®¿é—®æ§åˆ¶

- **åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶**ï¼šé™åˆ¶å¯¹äº‹ä»¶ä¸»é¢˜çš„è®¿é—®æƒé™
- **äº‹ä»¶è¿‡æ»¤**ï¼šæ ¹æ®æ¶ˆè´¹è€…æƒé™è¿‡æ»¤æ•æ„Ÿäº‹ä»¶å†…å®¹
- **å®¡è®¡æ—¥å¿—**ï¼šè®°å½•äº‹ä»¶è®¿é—®å’Œå¤„ç†æƒ…å†µ

## 12. äº‹ä»¶é©±åŠ¨æ¡†æ¶é€‰å‹

### 12.1 ä¸»æµäº‹ä»¶é©±åŠ¨æ¡†æ¶å¯¹æ¯”

| æ¡†æ¶ | ç±»å‹ | ä¼˜åŠ¿ | åŠ£åŠ¿ | é€‚ç”¨åœºæ™¯ |
|------|------|------|------|----------|
| Apache Kafka | åˆ†å¸ƒå¼æµå¹³å° | é«˜ååé‡ã€æŒä¹…åŒ–ã€åˆ†åŒºæ‰©å±• | é…ç½®å¤æ‚ã€è¿ç»´æˆæœ¬é«˜ | é«˜ååäº‹ä»¶æµå¤„ç† |
| RabbitMQ | æ¶ˆæ¯ä»£ç† | å¤šåè®®æ”¯æŒã€çµæ´»è·¯ç”±ã€æˆç†Ÿç¨³å®š | ååé‡æœ‰é™ã€ä¸é€‚åˆæµå¤„ç† | ä¼ä¸šé›†æˆã€æ¶ˆæ¯è·¯ç”± |
| Apache Pulsar | åˆ†å¸ƒå¼æ¶ˆæ¯æµå¹³å° | å¤šç§Ÿæˆ·ã€åˆ†å±‚å­˜å‚¨ã€è·¨åœ°åŸŸå¤åˆ¶ | ç”Ÿæ€ç›¸å¯¹è¾ƒæ–° | æ··åˆæ¶ˆæ¯/æµå¤„ç†åœºæ™¯ |
| Axon Framework | äº‹ä»¶æº¯æº/CQRSæ¡†æ¶ | å®Œæ•´çš„äº‹ä»¶æº¯æºæ”¯æŒã€ä¸Springé›†æˆ | å­¦ä¹ æ›²çº¿é™¡å³­ | å¤æ‚ä¸šåŠ¡é¢†åŸŸæ¨¡å‹ |
| Eventuate | å¾®æœåŠ¡äº‹ä»¶é©±åŠ¨æ¡†æ¶ | äº‹ä»¶æº¯æº+CQRS+Sagaé›†æˆ | å•†ä¸šç‰ˆåŠŸèƒ½å—é™ | å¾®æœåŠ¡æ•°æ®ä¸€è‡´æ€§ |
| Spring Cloud Stream | äº‹ä»¶é©±åŠ¨å¾®æœåŠ¡æ¡†æ¶ | Springç”Ÿæ€é›†æˆã€ç®€åŒ–æ¶ˆæ¯ç¼–ç¨‹ | ä¾èµ–Springç”Ÿæ€ | Springå¾®æœåŠ¡æ¶æ„ |

### 12.2 æ¡†æ¶é€‰æ‹©å†³ç­–æŒ‡å—

1. **è¯„ä¼°ä¸šåŠ¡éœ€æ±‚**ï¼š
   - äº‹ä»¶ååé‡è¦æ±‚
   - äº‹ä»¶å¤„ç†å»¶è¿Ÿè¦æ±‚
   - æŒä¹…åŒ–éœ€æ±‚
   - å¤æ‚äº‹ä»¶å¤„ç†éœ€æ±‚

2. **æŠ€æœ¯æ ˆåŒ¹é…**ï¼š
   - ç°æœ‰æŠ€æœ¯æ ˆå…¼å®¹æ€§
   - å›¢é˜ŸæŠ€æœ¯èƒ½åŠ›
   - è¿ç»´å¤æ‚åº¦

3. **éåŠŸèƒ½éœ€æ±‚**ï¼š
   - å¯é æ€§å’Œå®¹é”™èƒ½åŠ›
   - å¯æ‰©å±•æ€§
   - ç›‘æ§å’Œå¯è§‚æµ‹æ€§
   - å®‰å…¨éœ€æ±‚

4. **æˆæœ¬è€ƒé‡**ï¼š
   - è®¸å¯æˆæœ¬
   - è¿ç»´æˆæœ¬
   - å¼€å‘æ•ˆç‡

## 13. æ¡ˆä¾‹åˆ†æ

### 13.1 ç”µå•†è®¢å•å¤„ç†ç³»ç»Ÿ

**ä¸šåŠ¡åœºæ™¯**ï¼š
å®ç°ç”µå•†å¹³å°çš„è®¢å•å¤„ç†æµç¨‹ï¼ŒåŒ…æ‹¬è®¢å•åˆ›å»ºã€åº“å­˜æ‰£å‡ã€æ”¯ä»˜å¤„ç†ã€ç‰©æµé…é€ç­‰ç¯èŠ‚ã€‚

**äº‹ä»¶é©±åŠ¨æ¶æ„è®¾è®¡**ï¼š
- **äº‹ä»¶**ï¼šOrderCreatedã€PaymentProcessedã€InventoryDeductedã€OrderShippedç­‰
- **ç”Ÿäº§è€…**ï¼šè®¢å•æœåŠ¡ã€æ”¯ä»˜æœåŠ¡ã€åº“å­˜æœåŠ¡ã€ç‰©æµæœåŠ¡
- **æ¶ˆè´¹è€…**ï¼šå„æœåŠ¡è®¢é˜…ç›¸å…³äº‹ä»¶
- **äº‹ä»¶æµ**ï¼šé€šè¿‡Kafkaå®ç°äº‹ä»¶ä¼ é€’
- **çŠ¶æ€ç®¡ç†**ï¼šä½¿ç”¨äº‹ä»¶æº¯æºè®°å½•è®¢å•çŠ¶æ€å˜åŒ–

**æ¶æ„ä¼˜åŠ¿**ï¼š
- æœåŠ¡è§£è€¦ï¼šå„æœåŠ¡é€šè¿‡äº‹ä»¶å¼‚æ­¥é€šä¿¡
- å¯æ‰©å±•æ€§ï¼šæ”¯æŒä¸šåŠ¡æµç¨‹æ‰©å±•
- æ•…éšœéš”ç¦»ï¼šå•ä¸ªç¯èŠ‚æ•…éšœä¸å½±å“æ•´ä½“æµç¨‹
- å¯è§‚æµ‹æ€§ï¼šé€šè¿‡äº‹ä»¶æµè¿½è¸ªè®¢å•å…¨ç”Ÿå‘½å‘¨æœŸ

### 13.2 å®æ—¶æ•°æ®åˆ†æå¹³å°

**ä¸šåŠ¡åœºæ™¯**ï¼š
æ„å»ºå®æ—¶ç”¨æˆ·è¡Œä¸ºåˆ†æå¹³å°ï¼Œå®æ—¶å¤„ç†ç”¨æˆ·ç‚¹å‡»æµæ•°æ®ï¼Œç”Ÿæˆå®æ—¶ç»Ÿè®¡æŒ‡æ ‡å’Œä¸ªæ€§åŒ–æ¨èã€‚

**äº‹ä»¶é©±åŠ¨æ¶æ„è®¾è®¡**ï¼š
- **äº‹ä»¶æº**ï¼šç”¨æˆ·è¡Œä¸ºäº‹ä»¶ï¼ˆé¡µé¢æµè§ˆã€ç‚¹å‡»ã€è´­ä¹°ç­‰ï¼‰
- **æµå¤„ç†**ï¼šä½¿ç”¨Kafka Streamså¤„ç†äº‹ä»¶æµ
- **äº‹ä»¶å­˜å‚¨**ï¼šKafkaæŒä¹…åŒ–äº‹ä»¶æµ
- **æŸ¥è¯¢æ¨¡å‹**ï¼šå®æ—¶è®¡ç®—ç”¨æˆ·è¡Œä¸ºæŒ‡æ ‡
- **è§¦å‘æœºåˆ¶**ï¼šåŸºäºç”¨æˆ·è¡Œä¸ºäº‹ä»¶è§¦å‘ä¸ªæ€§åŒ–æ¨è

**æŠ€æœ¯å®ç°**ï¼š
- å‰ç«¯åŸ‹ç‚¹æ”¶é›†ç”¨æˆ·è¡Œä¸ºäº‹ä»¶
- Kafkaæ¥æ”¶å¹¶å­˜å‚¨äº‹ä»¶æµ
- Kafka Streamså®æ—¶å¤„ç†äº‹ä»¶æµ
- Rediså­˜å‚¨å®æ—¶è®¡ç®—æŒ‡æ ‡
- æ¨èæœåŠ¡æ¶ˆè´¹äº‹ä»¶æ›´æ–°æ¨èç»“æœ

**æ¶æ„ä¼˜åŠ¿**ï¼š
- å®æ—¶å“åº”ï¼šæ¯«ç§’çº§äº‹ä»¶å¤„ç†
- å¯æ‰©å±•æ€§ï¼šæ°´å¹³æ‰©å±•æµå¤„ç†èƒ½åŠ›
- å†å²åˆ†æï¼šæ”¯æŒäº‹ä»¶æµé‡æ”¾è¿›è¡Œå†å²æ•°æ®åˆ†æ
- ä¸ªæ€§åŒ–ï¼šåŸºäºå®æ—¶è¡Œä¸ºæä¾›ä¸ªæ€§åŒ–ä½“éªŒ