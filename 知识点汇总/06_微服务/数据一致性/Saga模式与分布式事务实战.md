# Sagaæ¨¡å¼ä¸åˆ†å¸ƒå¼äº‹åŠ¡å®æˆ˜

> å¾®æœåŠ¡æ¶æ„ä¸‹çš„æ•°æ®ä¸€è‡´æ€§è§£å†³æ–¹æ¡ˆ

## ğŸ“‹ ç›®å½•

1. [åˆ†å¸ƒå¼äº‹åŠ¡æ¦‚è¿°](#1-åˆ†å¸ƒå¼äº‹åŠ¡æ¦‚è¿°)
2. [Sagaæ¨¡å¼æ ¸å¿ƒæ¦‚å¿µ](#2-sagaæ¨¡å¼æ ¸å¿ƒæ¦‚å¿µ)
3. [Sagaæ¨¡å¼å®ç°æ–¹å¼](#3-sagaæ¨¡å¼å®ç°æ–¹å¼)
4. [ç¼–æ’å¼Sagaå®æˆ˜](#4-ç¼–æ’å¼sagaå®æˆ˜)
5. [ååŒå¼Sagaå®æˆ˜](#5-ååŒå¼sagaå®æˆ˜)
6. [Sagaæ¨¡å¼ä¸å…¶ä»–æ¨¡å¼å¯¹æ¯”](#6-sagaæ¨¡å¼ä¸å…¶ä»–æ¨¡å¼å¯¹æ¯”)
7. [Sagaæ¨¡å¼é«˜çº§ç‰¹æ€§](#7-sagaæ¨¡å¼é«˜çº§ç‰¹æ€§)
8. [Sagaæ¨¡å¼æ€§èƒ½ä¼˜åŒ–](#8-sagaæ¨¡å¼æ€§èƒ½ä¼˜åŒ–)
9. [ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ](#9-ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ)
10. [å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ](#10-å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ)
11. [æ¡ˆä¾‹åˆ†æ](#11-æ¡ˆä¾‹åˆ†æ)
12. [Sagaæ¨¡å¼æ¡†æ¶é€‰å‹](#12-sagaæ¨¡å¼æ¡†æ¶é€‰å‹)

---

## 1. åˆ†å¸ƒå¼äº‹åŠ¡æ¦‚è¿°

### 1.1 åˆ†å¸ƒå¼äº‹åŠ¡æŒ‘æˆ˜

åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œä¸€ä¸ªä¸šåŠ¡æµç¨‹å¾€å¾€éœ€è¦å¤šä¸ªæœåŠ¡ååŒå®Œæˆï¼Œæ¯ä¸ªæœåŠ¡ç»´æŠ¤è‡ªå·±çš„æ•°æ®åº“ã€‚ä¼ ç»Ÿçš„ACIDäº‹åŠ¡æ— æ³•è·¨æœåŠ¡è¾¹ç•Œä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Œè¿™å°±å¼•å…¥äº†åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜ã€‚

**åˆ†å¸ƒå¼äº‹åŠ¡çš„æ ¸å¿ƒæŒ‘æˆ˜**ï¼š
- **æ•°æ®ä¸€è‡´æ€§**ï¼šå¦‚ä½•ä¿è¯è·¨æœåŠ¡æ•°æ®çš„ä¸€è‡´æ€§
- **å¯ç”¨æ€§**ï¼šå¦‚ä½•åœ¨ä¿è¯ä¸€è‡´æ€§çš„åŒæ—¶ä¸å½±å“ç³»ç»Ÿå¯ç”¨æ€§
- **æ€§èƒ½**ï¼šå¦‚ä½•å‡å°‘åˆ†å¸ƒå¼äº‹åŠ¡å¯¹ç³»ç»Ÿæ€§èƒ½çš„å½±å“
- **å¤æ‚æ€§**ï¼šå¦‚ä½•ç®€åŒ–åˆ†å¸ƒå¼äº‹åŠ¡çš„å®ç°å’Œç»´æŠ¤

### 1.2 CAPå®šç†ä¸BASEç†è®º

**CAPå®šç†**æŒ‡å‡ºï¼Œåˆ†å¸ƒå¼ç³»ç»Ÿåªèƒ½åŒæ—¶æ»¡è¶³ä»¥ä¸‹ä¸‰é¡¹ä¸­çš„ä¸¤é¡¹ï¼š
- **ä¸€è‡´æ€§(Consistency)**ï¼šæ‰€æœ‰èŠ‚ç‚¹åœ¨åŒä¸€æ—¶é—´å…·æœ‰ç›¸åŒçš„æ•°æ®
- **å¯ç”¨æ€§(Availability)**ï¼šä¿è¯æ¯ä¸ªè¯·æ±‚ä¸ç®¡æˆåŠŸæˆ–å¤±è´¥éƒ½æœ‰å“åº”
- **åˆ†åŒºå®¹é”™æ€§(Partition tolerance)**ï¼šç³»ç»Ÿåœ¨é‡åˆ°ç½‘ç»œåˆ†åŒºæ•…éšœæ—¶ä»ç„¶å¯ç”¨

åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œç½‘ç»œåˆ†åŒºæ˜¯ä¸å¯é¿å…çš„ï¼Œå› æ­¤é€šå¸¸é€‰æ‹©**AP**æˆ–**CP**æ¶æ„ï¼š
- **CPæ¶æ„**ï¼šä¿è¯ä¸€è‡´æ€§å’Œåˆ†åŒºå®¹é”™æ€§ï¼Œç‰ºç‰²å¯ç”¨æ€§
- **APæ¶æ„**ï¼šä¿è¯å¯ç”¨æ€§å’Œåˆ†åŒºå®¹é”™æ€§ï¼Œç‰ºç‰²å¼ºä¸€è‡´æ€§

**BASEç†è®º**æ˜¯å¯¹CAPå®šç†çš„å»¶ä¼¸ï¼Œæå‡ºé€šè¿‡ç‰ºç‰²å¼ºä¸€è‡´æ€§æ¥è·å¾—å¯ç”¨æ€§ï¼š
- **åŸºæœ¬å¯ç”¨(Basically Available)**ï¼šç³»ç»Ÿåœ¨æ•…éšœæ—¶ä»èƒ½æä¾›éƒ¨åˆ†æœåŠ¡
- **è½¯çŠ¶æ€(Soft State)**ï¼šå…è®¸ç³»ç»Ÿå­˜åœ¨ä¸­é—´çŠ¶æ€ï¼Œä¸å½±å“æ•´ä½“å¯ç”¨æ€§
- **æœ€ç»ˆä¸€è‡´æ€§(Eventually Consistent)**ï¼šç³»ç»Ÿæœ€ç»ˆä¼šè¾¾åˆ°ä¸€è‡´çŠ¶æ€

### 1.3 åˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å‹

| äº‹åŠ¡æ¨¡å‹ | ä¸€è‡´æ€§ | å¯ç”¨æ€§ | æ€§èƒ½ | å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ |
|---------|-------|-------|------|-------|---------|
| 2PC/3PC | å¼ºä¸€è‡´æ€§ | ä½ | ä½ | ä¸­ | çŸ­äº‹åŠ¡ã€å…³é”®ä¸šåŠ¡ |
| TCC | æœ€ç»ˆä¸€è‡´æ€§ | é«˜ | é«˜ | é«˜ | å¤æ‚ä¸šåŠ¡é€»è¾‘ |
| Saga | æœ€ç»ˆä¸€è‡´æ€§ | é«˜ | ä¸­ | ä¸­ | é•¿äº‹åŠ¡ã€è·¨å¤šæœåŠ¡ |
| æœ¬åœ°æ¶ˆæ¯è¡¨ | æœ€ç»ˆä¸€è‡´æ€§ | é«˜ | ä¸­ | ä½ | ç®€å•åœºæ™¯ |
| æ¶ˆæ¯é˜Ÿåˆ—äº‹åŠ¡ | æœ€ç»ˆä¸€è‡´æ€§ | é«˜ | ä¸­ | ä½ | å¼‚æ­¥é€šä¿¡åœºæ™¯ |

---

## 2. Sagaæ¨¡å¼æ ¸å¿ƒæ¦‚å¿µ

### 2.1 Sagaæ¨¡å¼å®šä¹‰

Sagaæ¨¡å¼æ˜¯ç”±Hector Garcia-Molinaå’ŒKenneth Salemåœ¨1987å¹´æå‡ºçš„ä¸€ç§åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼Œç”¨äºç»´æŠ¤è·¨å¤šä¸ªæ•°æ®å­˜å‚¨çš„ä¸€è‡´æ€§ã€‚

**Sagaæ¨¡å¼å®šä¹‰**ï¼šä¸€ä¸ªSagaæ˜¯ä¸€ä¸ªé•¿æ—¶é—´è¿è¡Œçš„äº‹åŠ¡ï¼Œè¢«æ‹†åˆ†ä¸ºä¸€ç³»åˆ—æœ¬åœ°äº‹åŠ¡ã€‚æ¯ä¸ªæœ¬åœ°äº‹åŠ¡æ›´æ–°æ•°æ®åº“å¹¶å‘å¸ƒæ¶ˆæ¯æˆ–äº‹ä»¶ã€‚å¦‚æœæŸä¸ªæœ¬åœ°äº‹åŠ¡å¤±è´¥ï¼ŒSagaä¼šæ‰§è¡Œè¡¥å¿äº‹åŠ¡æ¥æ’¤é”€ä¹‹å‰çš„æœ¬åœ°äº‹åŠ¡é€ æˆçš„å½±å“ã€‚

### 2.2 Sagaæ¨¡å¼æ ¸å¿ƒç»„ä»¶

- **äº‹åŠ¡æ´»åŠ¨(Transaction Activity)**ï¼šSagaä¸­çš„æ¯ä¸ªæœ¬åœ°äº‹åŠ¡ï¼Œæ˜¯æœ€å°æ‰§è¡Œå•å…ƒ
- **è¡¥å¿æ´»åŠ¨(Compensation Activity)**ï¼šç”¨äºæ’¤é”€å¯¹åº”äº‹åŠ¡æ´»åŠ¨æ‰€åšçš„æ›´æ”¹
- **Sagaåè°ƒå™¨(Saga Coordinator)**ï¼šè´Ÿè´£åè°ƒSagaä¸­æ‰€æœ‰äº‹åŠ¡æ´»åŠ¨çš„æ‰§è¡Œé¡ºåº
- **äº‹ä»¶é€šé“(Event Channel)**ï¼šç”¨äºåœ¨äº‹åŠ¡æ´»åŠ¨ä¹‹é—´ä¼ é€’äº‹ä»¶
- **çŠ¶æ€å­˜å‚¨(State Store)**ï¼šç”¨äºæŒä¹…åŒ–Sagaçš„æ‰§è¡ŒçŠ¶æ€

### 2.3 Sagaæ¨¡å¼æ‰§è¡Œæµç¨‹

![Sagaæ¨¡å¼æ‰§è¡Œæµç¨‹](https://i.imgur.com/saga_flow.png)

**æ­£å¸¸æ‰§è¡Œæµç¨‹**ï¼š
1. å®¢æˆ·ç«¯å‘èµ·Sagaäº‹åŠ¡è¯·æ±‚
2. Sagaåè°ƒå™¨æŒ‰é¡ºåºæ‰§è¡Œå„ä¸ªæœ¬åœ°äº‹åŠ¡
3. æ¯ä¸ªæœ¬åœ°äº‹åŠ¡å®Œæˆåæ›´æ–°æœ¬åœ°æ•°æ®åº“
4. æ‰€æœ‰æœ¬åœ°äº‹åŠ¡æˆåŠŸå®Œæˆï¼ŒSagaäº‹åŠ¡æˆåŠŸç»“æŸ

**å¼‚å¸¸æ¢å¤æµç¨‹**ï¼š
1. æŸä¸ªæœ¬åœ°äº‹åŠ¡æ‰§è¡Œå¤±è´¥
2. Sagaåè°ƒå™¨æ£€æµ‹åˆ°å¤±è´¥
3. æŒ‰ç›¸åé¡ºåºæ‰§è¡Œå·²å®Œæˆäº‹åŠ¡çš„è¡¥å¿äº‹åŠ¡
4. æ‰€æœ‰è¡¥å¿äº‹åŠ¡æ‰§è¡Œå®Œæˆï¼Œæ¢å¤åˆ°åˆå§‹çŠ¶æ€

### 2.4 Sagaæ¨¡å¼çŠ¶æ€æœº

Sagaæ¨¡å¼å¯ä»¥è¡¨ç¤ºä¸ºä¸€ä¸ªçŠ¶æ€æœºï¼ŒåŒ…å«ä»¥ä¸‹çŠ¶æ€ï¼š
- **åˆå§‹çŠ¶æ€(Initial)**ï¼šSagaäº‹åŠ¡å°šæœªå¼€å§‹
- **è¿è¡ŒçŠ¶æ€(Running)**ï¼šSagaäº‹åŠ¡æ­£åœ¨æ‰§è¡Œ
- **å®ŒæˆçŠ¶æ€(Completed)**ï¼šæ‰€æœ‰äº‹åŠ¡æ´»åŠ¨æˆåŠŸæ‰§è¡Œ
- **å¤±è´¥çŠ¶æ€(Failed)**ï¼šæŸä¸ªäº‹åŠ¡æ´»åŠ¨æ‰§è¡Œå¤±è´¥
- **è¡¥å¿çŠ¶æ€(Compensating)**ï¼šæ­£åœ¨æ‰§è¡Œè¡¥å¿äº‹åŠ¡
- **è¡¥å¿å®ŒæˆçŠ¶æ€(Compensated)**ï¼šæ‰€æœ‰è¡¥å¿äº‹åŠ¡æ‰§è¡Œå®Œæˆ
- **æŒ‚èµ·çŠ¶æ€(Suspended)**ï¼šSagaäº‹åŠ¡è¢«æš‚åœ
- **æ¢å¤çŠ¶æ€(Resuming)**ï¼šSagaäº‹åŠ¡ä»æŒ‚èµ·çŠ¶æ€æ¢å¤

---

## 3. Sagaæ¨¡å¼å®ç°æ–¹å¼

### 3.1 ç¼–æ’å¼Saga(Choreography)

**ç¼–æ’å¼Saga**ä¸­ï¼Œæ²¡æœ‰ä¸­å¤®åè°ƒå™¨ï¼Œæ¯ä¸ªæœåŠ¡é€šè¿‡äº‹ä»¶ç›¸äº’é€šä¿¡ï¼Œå†³å®šæ˜¯å¦æ‰§è¡Œæœ¬åœ°äº‹åŠ¡æˆ–è¡¥å¿äº‹åŠ¡ã€‚

![ç¼–æ’å¼Sagaæ¶æ„](https://i.imgur.com/saga_choreography.png)

**å·¥ä½œåŸç†**ï¼š
1. å¯åŠ¨æœåŠ¡æ‰§è¡Œæœ¬åœ°äº‹åŠ¡å¹¶å‘å¸ƒäº‹ä»¶
2. å…¶ä»–æœåŠ¡ç›‘å¬ç›¸å…³äº‹ä»¶å¹¶è§¦å‘è‡ªå·±çš„æœ¬åœ°äº‹åŠ¡
3. æ¯ä¸ªæœåŠ¡åªçŸ¥é“è‡ªå·±éœ€è¦å¤„ç†çš„äº‹ä»¶å’Œè¦å‘å¸ƒçš„äº‹ä»¶
4. å¤±è´¥æ—¶ï¼Œé€šè¿‡åå‘äº‹ä»¶è§¦å‘è¡¥å¿äº‹åŠ¡

**ä¼˜ç‚¹**ï¼š
- å»ä¸­å¿ƒåŒ–ï¼ŒæœåŠ¡è§£è€¦ç¨‹åº¦é«˜
- å¯æ‰©å±•æ€§å¥½
- æ— å•ç‚¹æ•…éšœé£é™©
- é€‚åˆç®€å•æµç¨‹

**ç¼ºç‚¹**ï¼š
- ä¸šåŠ¡é€»è¾‘åˆ†æ•£åœ¨å„ä¸ªæœåŠ¡ä¸­
- æµç¨‹å˜æ›´éœ€è¦ä¿®æ”¹å¤šä¸ªæœåŠ¡
- éš¾ä»¥è·Ÿè¸ªå’Œè°ƒè¯•æ•´ä¸ªæµç¨‹
- äº‹åŠ¡æ‰§è¡Œé¡ºåºä¸ç›´è§‚

### 3.2 ååŒå¼Saga(Orchestration)

**ååŒå¼Saga**ä¸­ï¼Œæœ‰ä¸€ä¸ªä¸­å¤®åè°ƒå™¨(Saga Orchestrator)ï¼Œè´Ÿè´£åè°ƒæ‰€æœ‰äº‹åŠ¡æ´»åŠ¨çš„æ‰§è¡Œé¡ºåºã€‚

![ååŒå¼Sagaæ¶æ„](https://i.imgur.com/saga_orchestration.png)

**å·¥ä½œåŸç†**ï¼š
1. å®¢æˆ·ç«¯å‘åè°ƒå™¨å‘èµ·äº‹åŠ¡è¯·æ±‚
2. åè°ƒå™¨æŒ‰é¢„å®šä¹‰é¡ºåºè°ƒç”¨å„ä¸ªæœåŠ¡çš„æœ¬åœ°äº‹åŠ¡
3. æ¯ä¸ªæœåŠ¡æ‰§è¡Œæœ¬åœ°äº‹åŠ¡å¹¶å‘åè°ƒå™¨è¿”å›ç»“æœ
4. åè°ƒå™¨æ ¹æ®è¿”å›ç»“æœå†³å®šç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ªäº‹åŠ¡è¿˜æ˜¯è§¦å‘è¡¥å¿

**ä¼˜ç‚¹**ï¼š
- ä¸šåŠ¡é€»è¾‘é›†ä¸­åœ¨åè°ƒå™¨ä¸­ï¼Œæ˜“äºç†è§£å’Œç»´æŠ¤
- æµç¨‹å˜æ›´åªéœ€ä¿®æ”¹åè°ƒå™¨
- ä¾¿äºè·Ÿè¸ªå’Œè°ƒè¯•æ•´ä¸ªæµç¨‹
- äº‹åŠ¡æ‰§è¡Œé¡ºåºæ¸…æ™°

**ç¼ºç‚¹**ï¼š
- åè°ƒå™¨å¯èƒ½æˆä¸ºå•ç‚¹æ•…éšœ
- åè°ƒå™¨å¯èƒ½æˆä¸ºæ€§èƒ½ç“¶é¢ˆ
- æœåŠ¡ä¸åè°ƒå™¨å­˜åœ¨ä¸€å®šè€¦åˆ
- åè°ƒå™¨é€»è¾‘å¯èƒ½å˜å¾—å¤æ‚

### 3.3 ä¸¤ç§æ¨¡å¼å¯¹æ¯”

| ç‰¹æ€§ | ç¼–æ’å¼Saga | ååŒå¼Saga |
|------|-----------|-----------|
| æ¶æ„å¤æ‚åº¦ | ä½ | ä¸­ |
| ä¸šåŠ¡é€»è¾‘é›†ä¸­ç¨‹åº¦ | åˆ†æ•£ | é›†ä¸­ |
| å¯ç»´æŠ¤æ€§ | ä½ | é«˜ |
| å¯æ‰©å±•æ€§ | é«˜ | ä¸­ |
| æ•…éšœæ’æŸ¥éš¾åº¦ | é«˜ | ä½ |
| æœåŠ¡è€¦åˆåº¦ | ä½ | ä¸­ |
| é€‚åˆåœºæ™¯ | ç®€å•æµç¨‹ï¼ŒæœåŠ¡æ•°é‡å°‘ | å¤æ‚æµç¨‹ï¼ŒæœåŠ¡æ•°é‡å¤š |
| å®ç°éš¾åº¦ | ç®€å• | ä¸­ç­‰ |
| æ€§èƒ½å¼€é”€ | ä½ | ä¸­ |
| å•ç‚¹é£é™© | æ—  | æœ‰ |

---

## 4. ç¼–æ’å¼Sagaå®æˆ˜

### 4.1 æŠ€æœ¯é€‰å‹

**æ¶ˆæ¯é˜Ÿåˆ—**ï¼šKafkaæˆ–RabbitMQ
**äº‹ä»¶æ ¼å¼**ï¼šJSONæˆ–Avro
**æœåŠ¡é€šä¿¡**ï¼šREST APIæˆ–gRPC
**çŠ¶æ€ç®¡ç†**ï¼šæœ¬åœ°æ•°æ®åº“
**æŠ€æœ¯æ ˆ**ï¼šSpring Boot + Spring Cloud Stream

### 4.2 è®¢å•å¤„ç†ç¤ºä¾‹

å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªç”µå•†è®¢å•å¤„ç†æµç¨‹ï¼Œæ¶‰åŠä¸‰ä¸ªæœåŠ¡ï¼šè®¢å•æœåŠ¡ã€åº“å­˜æœåŠ¡å’Œæ”¯ä»˜æœåŠ¡ã€‚

**æ­£å¸¸æµç¨‹**ï¼š
1. è®¢å•æœåŠ¡åˆ›å»ºè®¢å•(å¾…æ”¯ä»˜çŠ¶æ€)
2. åº“å­˜æœåŠ¡æ‰£å‡åº“å­˜
3. æ”¯ä»˜æœåŠ¡å¤„ç†æ”¯ä»˜
4. è®¢å•æœåŠ¡æ›´æ–°è®¢å•çŠ¶æ€ä¸ºå·²æ”¯ä»˜

**è¡¥å¿æµç¨‹**ï¼š
1. æ”¯ä»˜å¤±è´¥æ—¶ï¼Œåº“å­˜æœåŠ¡æ¢å¤åº“å­˜
2. è®¢å•æœåŠ¡æ›´æ–°è®¢å•çŠ¶æ€ä¸ºæ”¯ä»˜å¤±è´¥

### 4.3 æœåŠ¡å®ç°

**è®¢å•æœåŠ¡**ï¼š
```java
@Service
public class OrderService {
    @Autowired
    private OrderRepository orderRepository;
    @Autowired
    private KafkaTemplate<String, OrderEvent> kafkaTemplate;

    @Transactional
    public Order createOrder(OrderRequest request) {
        // åˆ›å»ºè®¢å•
        Order order = new Order();
        order.setUserId(request.getUserId());
        order.setProductId(request.getProductId());
        order.setQuantity(request.getQuantity());
        order.setStatus(OrderStatus.PENDING_PAYMENT);
        order = orderRepository.save(order);

        // å‘å¸ƒè®¢å•åˆ›å»ºäº‹ä»¶
        OrderCreatedEvent event = new OrderCreatedEvent();
        event.setOrderId(order.getId());
        event.setProductId(order.getProductId());
        event.setQuantity(order.getQuantity());
        kafkaTemplate.send("order-created-events", event);

        return order;
    }

    @KafkaListener(topics = "payment-completed-events")
    public void handlePaymentCompletedEvent(PaymentCompletedEvent event) {
        Order order = orderRepository.findById(event.getOrderId())
            .orElseThrow(() -> new OrderNotFoundException(event.getOrderId()));

        order.setStatus(OrderStatus.PAID);
        orderRepository.save(order);
    }

    @KafkaListener(topics = "payment-failed-events")
    public void handlePaymentFailedEvent(PaymentFailedEvent event) {
        Order order = orderRepository.findById(event.getOrderId())
            .orElseThrow(() -> new OrderNotFoundException(event.getOrderId()));

        order.setStatus(OrderStatus.PAYMENT_FAILED);
        order.setFailureReason(event.getReason());
        orderRepository.save(order);
    }
}
```

**åº“å­˜æœåŠ¡**ï¼š
```java
@Service
public class InventoryService {
    @Autowired
    private InventoryRepository inventoryRepository;
    @Autowired
    private KafkaTemplate<String, InventoryEvent> kafkaTemplate;

    @KafkaListener(topics = "order-created-events")
    public void handleOrderCreatedEvent(OrderCreatedEvent event) {
        try {
            // æ‰£å‡åº“å­˜
            Inventory inventory = inventoryRepository.findByProductId(event.getProductId())
                .orElseThrow(() -> new ProductNotFoundException(event.getProductId()));

            if (inventory.getQuantity() < event.getQuantity()) {
                // åº“å­˜ä¸è¶³ï¼Œå‘å¸ƒåº“å­˜ä¸è¶³äº‹ä»¶
                InventoryInsufficientEvent insufficientEvent = new InventoryInsufficientEvent();
                insufficientEvent.setOrderId(event.getOrderId());
                insufficientEvent.setProductId(event.getProductId());
                insufficientEvent.setRequestedQuantity(event.getQuantity());
                insufficientEvent.setAvailableQuantity(inventory.getQuantity());
                kafkaTemplate.send("inventory-insufficient-events", insufficientEvent);
                return;
            }

            inventory.setQuantity(inventory.getQuantity() - event.getQuantity());
            inventoryRepository.save(inventory);

            // å‘å¸ƒåº“å­˜å·²æ‰£å‡äº‹ä»¶
            InventoryDeductedEvent deductedEvent = new InventoryDeductedEvent();
            deductedEvent.setOrderId(event.getOrderId());
            deductedEvent.setProductId(event.getProductId());
            deductedEvent.setQuantity(event.getQuantity());
            kafkaTemplate.send("inventory-deducted-events", deductedEvent);
        } catch (Exception e) {
            // å¤„ç†å¼‚å¸¸
            InventoryFailedEvent failedEvent = new InventoryFailedEvent();
            failedEvent.setOrderId(event.getOrderId());
            failedEvent.setReason(e.getMessage());
            kafkaTemplate.send("inventory-failed-events", failedEvent);
        }
    }

    @KafkaListener(topics = "payment-failed-events")
    public void handlePaymentFailedEvent(PaymentFailedEvent event) {
        // æ¢å¤åº“å­˜
        Inventory inventory = inventoryRepository.findByProductId(event.getProductId())
            .orElseThrow(() -> new ProductNotFoundException(event.getProductId()));

        inventory.setQuantity(inventory.getQuantity() + event.getQuantity());
        inventoryRepository.save(inventory);

        // å‘å¸ƒåº“å­˜å·²æ¢å¤äº‹ä»¶
        InventoryRestoredEvent restoredEvent = new InventoryRestoredEvent();
        restoredEvent.setOrderId(event.getOrderId());
        restoredEvent.setProductId(event.getProductId());
        restoredEvent.setQuantity(event.getQuantity());
        kafkaTemplate.send("inventory-restored-events", restoredEvent);
    }
}
```

**æ”¯ä»˜æœåŠ¡**ï¼š
```java
@Service
public class PaymentService {
    @Autowired
    private PaymentRepository paymentRepository;
    @Autowired
    private KafkaTemplate<String, PaymentEvent> kafkaTemplate;
    @Autowired
    private PaymentGateway paymentGateway;

    @KafkaListener(topics = "inventory-deducted-events")
    public void handleInventoryDeductedEvent(InventoryDeductedEvent event) {
        try {
            // å¤„ç†æ”¯ä»˜
            Payment payment = new Payment();
            payment.setOrderId(event.getOrderId());
            payment.setAmount(calculateAmount(event.getProductId(), event.getQuantity()));
            payment.setStatus(PaymentStatus.PENDING);
            payment = paymentRepository.save(payment);

            // è°ƒç”¨æ”¯ä»˜ç½‘å…³
            PaymentResult result = paymentGateway.processPayment(
                payment.getId(), event.getUserId(), payment.getAmount());

            if (result.isSuccess()) {
                payment.setStatus(PaymentStatus.COMPLETED);
                payment.setTransactionId(result.getTransactionId());
                paymentRepository.save(payment);

                // å‘å¸ƒæ”¯ä»˜å®Œæˆäº‹ä»¶
                PaymentCompletedEvent completedEvent = new PaymentCompletedEvent();
                completedEvent.setOrderId(event.getOrderId());
                completedEvent.setPaymentId(payment.getId());
                completedEvent.setAmount(payment.getAmount());
                kafkaTemplate.send("payment-completed-events", completedEvent);
            } else {
                payment.setStatus(PaymentStatus.FAILED);
                payment.setFailureReason(result.getFailureReason());
                paymentRepository.save(payment);

                // å‘å¸ƒæ”¯ä»˜å¤±è´¥äº‹ä»¶
                PaymentFailedEvent failedEvent = new PaymentFailedEvent();
                failedEvent.setOrderId(event.getOrderId());
                failedEvent.setPaymentId(payment.getId());
                failedEvent.setReason(result.getFailureReason());
                failedEvent.setProductId(event.getProductId());
                failedEvent.setQuantity(event.getQuantity());
                kafkaTemplate.send("payment-failed-events", failedEvent);
            }
        } catch (Exception e) {
            // å¤„ç†å¼‚å¸¸
            PaymentFailedEvent failedEvent = new PaymentFailedEvent();
            failedEvent.setOrderId(event.getOrderId());
            failedEvent.setReason(e.getMessage());
            kafkaTemplate.send("payment-failed-events", failedEvent);
        }
    }
}
```

### 4.4 äº‹ä»¶å®šä¹‰

**è®¢å•äº‹ä»¶**ï¼š
```java
public class OrderCreatedEvent {
    private String orderId;
    private String userId;
    private String productId;
    private int quantity;
    private LocalDateTime createdAt;
    // getters and setters
}
```

**åº“å­˜äº‹ä»¶**ï¼š
```java
public class InventoryDeductedEvent {
    private String orderId;
    private String productId;
    private int quantity;
    private LocalDateTime deductedAt;
    // getters and setters
}

public class InventoryRestoredEvent {
    private String orderId;
    private String productId;
    private int quantity;
    private LocalDateTime restoredAt;
    // getters and setters
}
```

**æ”¯ä»˜äº‹ä»¶**ï¼š
```java
public class PaymentCompletedEvent {
    private String orderId;
    private String paymentId;
    private BigDecimal amount;
    private LocalDateTime completedAt;
    // getters and setters
}

public class PaymentFailedEvent {
    private String orderId;
    private String paymentId;
    private String reason;
    private String productId;
    private int quantity;
    private LocalDateTime failedAt;
    // getters and setters
}
```

### 4.5 é…ç½®Kafka

```yaml
spring:
  cloud:
    stream:
      kafka:
        binder:
          brokers: localhost:9092
      bindings:
        orderCreatedOutput:
          destination: order-created-events
          contentType: application/json
        inventoryDeductedInput:
          destination: inventory-deducted-events
          contentType: application/json
        paymentCompletedOutput:
          destination: payment-completed-events
          contentType: application/json
        paymentFailedOutput:
          destination: payment-failed-events
          contentType: application/json
```

---

## 5. ååŒå¼Sagaå®æˆ˜

### 5.1 æŠ€æœ¯é€‰å‹

**åè°ƒå™¨æ¡†æ¶**ï¼šAxon Frameworkæˆ–Camunda
**æœåŠ¡é€šä¿¡**ï¼šgRPC
**çŠ¶æ€ç®¡ç†**ï¼šå…³ç³»å‹æ•°æ®åº“
**æŒä¹…åŒ–**ï¼šJPA/Hibernate
**æŠ€æœ¯æ ˆ**ï¼šSpring Boot + Axon Framework

### 5.2 è®¢å•å¤„ç†ç¤ºä¾‹

ä½¿ç”¨ä¸ç¼–æ’å¼ç›¸åŒçš„è®¢å•å¤„ç†æµç¨‹ï¼Œä½†é‡‡ç”¨ååŒå¼Sagaå®ç°ã€‚

### 5.3 Sagaåè°ƒå™¨å®ç°

```java
@Saga
public class OrderSaga {
    @Autowired
    private transient CommandGateway commandGateway;
    @Autowired
    private transient Repository<OrderSaga> sagaRepository;

    private String orderId;
    private String productId;
    private int quantity;
    private BigDecimal amount;

    @StartSaga
    @SagaEventHandler(associationProperty = "orderId")
    public void handle(CreateOrderCommand command) {
        this.orderId = command.getOrderId();
        this.productId = command.getProductId();
        this.quantity = command.getQuantity();

        // å…³è”Saga
        SagaLifecycle.associateWith("orderId", orderId);

        // åˆ›å»ºè®¢å•
        commandGateway.send(new CreateOrderCommand(
            orderId, command.getUserId(), productId, quantity));
    }

    @SagaEventHandler(associationProperty = "orderId")
    public void handle(OrderCreatedEvent event) {
        // æ‰£å‡åº“å­˜
        commandGateway.send(new DeductInventoryCommand(
            UUID.randomUUID().toString(), orderId, productId, quantity));
    }

    @SagaEventHandler(associationProperty = "orderId")
    public void handle(InventoryDeductedEvent event) {
        // å¤„ç†æ”¯ä»˜
        this.amount = event.getAmount();
        commandGateway.send(new ProcessPaymentCommand(
            UUID.randomUUID().toString(), orderId, event.getUserId(), amount));
    }

    @SagaEventHandler(associationProperty = "orderId")
    public void handle(PaymentCompletedEvent event) {
        // å®Œæˆè®¢å•
        commandGateway.send(new CompleteOrderCommand(orderId));
    }

    @SagaEventHandler(associationProperty = "orderId")
    public void handle(OrderCompletedEvent event) {
        // ç»“æŸSaga
        SagaLifecycle.end();
    }

    // å¼‚å¸¸å¤„ç†
    @SagaEventHandler(associationProperty = "orderId")
    public void handle(InventoryInsufficientEvent event) {
        // å–æ¶ˆè®¢å•
        commandGateway.send(new CancelOrderCommand(
            orderId, "Insufficient inventory"));
    }

    @SagaEventHandler(associationProperty = "orderId")
    public void handle(PaymentFailedEvent event) {
        // æ¢å¤åº“å­˜
        commandGateway.send(new RestoreInventoryCommand(
            UUID.randomUUID().toString(), orderId, productId, quantity));
        // å–æ¶ˆè®¢å•
        commandGateway.send(new CancelOrderCommand(
            orderId, "Payment failed: " + event.getReason()));
    }

    @SagaEventHandler(associationProperty = "orderId")
    public void handle(OrderCancelledEvent event) {
        // ç»“æŸSaga
        SagaLifecycle.end();
    }
}
```

### 5.4 å‘½ä»¤å’Œäº‹ä»¶å®šä¹‰

**å‘½ä»¤**ï¼š
```java
public class CreateOrderCommand {
    @TargetAggregateIdentifier
    private final String orderId;
    private final String userId;
    private final String productId;
    private final int quantity;
    // constructor, getters
}

public class DeductInventoryCommand {
    @TargetAggregateIdentifier
    private final String inventoryId;
    private final String orderId;
    private final String productId;
    private final int quantity;
    // constructor, getters
}

public class ProcessPaymentCommand {
    @TargetAggregateIdentifier
    private final String paymentId;
    private final String orderId;
    private final String userId;
    private final BigDecimal amount;
    // constructor, getters
}
```

**äº‹ä»¶**ï¼š
```java
public class OrderCreatedEvent {
    private final String orderId;
    private final String userId;
    private final String productId;
    private final int quantity;
    private final LocalDateTime createdAt;
    // constructor, getters
}

public class InventoryDeductedEvent {
    private final String inventoryId;
    private final String orderId;
    private final String productId;
    private final int quantity;
    private final BigDecimal amount;
    // constructor, getters
}

public class PaymentCompletedEvent {
    private final String paymentId;
    private final String orderId;
    private final BigDecimal amount;
    private final String transactionId;
    // constructor, getters
}
```

### 5.5 èšåˆæ ¹å®ç°

**è®¢å•èšåˆæ ¹**ï¼š
```java
@Aggregate
public class Order {
    @AggregateIdentifier
    private String orderId;
    private String userId;
    private String productId;
    private int quantity;
    private OrderStatus status;
    private String cancellationReason;

    @CommandHandler
    public Order(CreateOrderCommand command) {
        AggregateLifecycle.apply(new OrderCreatedEvent(
            command.getOrderId(),
            command.getUserId(),
            command.getProductId(),
            command.getQuantity(),
            LocalDateTime.now()));
    }

    @EventSourcingHandler
    public void on(OrderCreatedEvent event) {
        this.orderId = event.getOrderId();
        this.userId = event.getUserId();
        this.productId = event.getProductId();
        this.quantity = event.getQuantity();
        this.status = OrderStatus.PENDING;
    }

    @CommandHandler
    public void handle(CompleteOrderCommand command) {
        AggregateLifecycle.apply(new OrderCompletedEvent(
            orderId, LocalDateTime.now()));
    }

    @EventSourcingHandler
    public void on(OrderCompletedEvent event) {
        this.status = OrderStatus.COMPLETED;
    }

    @CommandHandler
    public void handle(CancelOrderCommand command) {
        AggregateLifecycle.apply(new OrderCancelledEvent(
            orderId, command.getReason(), LocalDateTime.now()));
    }

    @EventSourcingHandler
    public void on(OrderCancelledEvent event) {
        this.status = OrderStatus.CANCELLED;
        this.cancellationReason = event.getReason();
    }

    protected Order() {
        // ç”¨äºäº‹ä»¶æº¯æº
    }
}
```

### 5.6 Axoné…ç½®

```java
@Configuration
public class AxonConfig {
    @Bean
    public EventStorageEngine eventStorageEngine(DataSource dataSource) {
        return new JpaEventStorageEngine(dataSource);
    }

    @Bean
    public TokenStore tokenStore(DataSource dataSource) {
        return new JpaTokenStore(dataSource);
    }

    @Bean
    public SagaStore sagaStore(EntityManager entityManager) {
        return JpaSagaStore.builder().entityManagerProvider(
            () -> entityManager).build();
    }
}
```

```yaml
axon:
  serializer:
    general: jackson
    events: jackson
    commands: jackson
  eventhandling:
    processors:
      orderProcessor:
        mode: subscribing
  saga:
    repository:
      eventSourcingRepository: true
```

---

## 6. Sagaæ¨¡å¼ä¸å…¶ä»–æ¨¡å¼å¯¹æ¯”

### 6.1 ä¸2PC/3PCå¯¹æ¯”

**2PC(ä¸¤é˜¶æ®µæäº¤)**ï¼š
- å¼ºä¸€è‡´æ€§
- é˜»å¡å¼åè®®
- åè°ƒè€…æ•…éšœä¼šå¯¼è‡´èµ„æºé”å®š
- ä¸é€‚åˆé•¿äº‹åŠ¡
- æ€§èƒ½è¾ƒå·®

**Sagaæ¨¡å¼**ï¼š
- æœ€ç»ˆä¸€è‡´æ€§
- éé˜»å¡å¼
- æ— èµ„æºé”å®šé—®é¢˜
- é€‚åˆé•¿äº‹åŠ¡
- æ€§èƒ½è¾ƒå¥½

### 6.2 ä¸TCCæ¨¡å¼å¯¹æ¯”

**TCC(Try-Confirm-Cancel)**ï¼š
- éœ€è¦ä¸ºæ¯ä¸ªæœåŠ¡å®ç°Tryã€Confirmå’ŒCancelä¸‰ä¸ªæ¥å£
- ä¾µå…¥æ€§é«˜
- ä¸€è‡´æ€§å¼ºäºSaga
- å®ç°å¤æ‚åº¦é«˜
- é€‚åˆçŸ­äº‹åŠ¡

**Sagaæ¨¡å¼**ï¼š
- åŸºäºæœ¬åœ°äº‹åŠ¡å’Œè¡¥å¿äº‹åŠ¡
- ä¾µå…¥æ€§ä½
- æœ€ç»ˆä¸€è‡´æ€§
- å®ç°å¤æ‚åº¦ä¸­ç­‰
- é€‚åˆé•¿äº‹åŠ¡

### 6.3 ä¸äº‹ä»¶æº¯æºå¯¹æ¯”

**äº‹ä»¶æº¯æº(Event Sourcing)**ï¼š
- å­˜å‚¨äº‹ä»¶åºåˆ—è€Œéå½“å‰çŠ¶æ€
- é€šè¿‡é‡æ”¾äº‹ä»¶é‡å»ºçŠ¶æ€
- é€‚åˆå®¡è®¡å’Œåˆè§„åœºæ™¯
- å¯ä¸Sagaç»“åˆä½¿ç”¨
- å­¦ä¹ æ›²çº¿é™¡å³­

**Sagaæ¨¡å¼**ï¼š
- å…³æ³¨è·¨æœåŠ¡äº‹åŠ¡ä¸€è‡´æ€§
- å­˜å‚¨å½“å‰çŠ¶æ€
- è¡¥å¿äº‹åŠ¡æ˜¾å¼å®šä¹‰
- å¯å•ç‹¬ä½¿ç”¨
- å­¦ä¹ æ›²çº¿ä¸­ç­‰

### 6.4 ä¸CQRSå¯¹æ¯”

**CQRS(å‘½ä»¤æŸ¥è¯¢èŒè´£åˆ†ç¦»)**ï¼š
- å°†è¯»æ“ä½œå’Œå†™æ“ä½œåˆ†ç¦»
- å†™æ¨¡å‹ä¼˜åŒ–æ›´æ–°æ€§èƒ½
- è¯»æ¨¡å‹ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
- å¯ä¸Sagaç»“åˆä½¿ç”¨
- å¢åŠ ç³»ç»Ÿå¤æ‚åº¦

**Sagaæ¨¡å¼**ï¼š
- å…³æ³¨è·¨æœåŠ¡äº‹åŠ¡ä¸€è‡´æ€§
- ä¸åŒºåˆ†è¯»å†™æ“ä½œ
- å¯ä¸CQRSç»“åˆä½¿ç”¨
- å•ç‹¬ä½¿ç”¨æ—¶å¤æ‚åº¦ä¸­ç­‰

---

## 7. Sagaæ¨¡å¼é«˜çº§ç‰¹æ€§

### 7.1 å¹¶å‘æ§åˆ¶

Sagaæ¨¡å¼éœ€è¦å¤„ç†å¹¶å‘æ‰§è¡Œçš„é—®é¢˜ï¼Œç‰¹åˆ«æ˜¯åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­ã€‚

**ä¹è§‚é”**ï¼š
- åœ¨å®ä½“ä¸Šæ·»åŠ ç‰ˆæœ¬å·
- æ›´æ–°æ—¶æ£€æŸ¥ç‰ˆæœ¬å·
- ç‰ˆæœ¬ä¸åŒ¹é…æ—¶é‡è¯•

```java
@Entity
public class Inventory {
    @Id
    private String id;
    private String productId;
    private int quantity;
    @Version
    private Long version;
    // getters and setters
}
```

**æ‚²è§‚é”**ï¼š
- ä½¿ç”¨æ•°æ®åº“é”æœºåˆ¶
- é€‚åˆå†™å†²çªé¢‘ç¹çš„åœºæ™¯
- å¯èƒ½å¯¼è‡´æ€§èƒ½é—®é¢˜

```java
@Transactional
public void deductInventory(String productId, int quantity) {
    Inventory inventory = inventoryRepository.findByProductIdWithLock(productId);
    inventory.setQuantity(inventory.getQuantity() - quantity);
    inventoryRepository.save(inventory);
}
```

### 7.2 äº‹åŠ¡éš”ç¦»çº§åˆ«

Sagaæ¨¡å¼æ— æ³•å®ç°ä¼ ç»Ÿæ•°æ®åº“çš„ACIDéš”ç¦»çº§åˆ«ï¼Œä½†å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æä¾›ä¸€å®šç¨‹åº¦çš„éš”ç¦»ï¼š

**è¯»æœªæäº¤(Read Uncommitted)**ï¼š
- å…è®¸äº‹åŠ¡è¯»å–æœªæäº¤çš„æ•°æ®
- å¯èƒ½å¯¼è‡´è„è¯»
- Sagaé»˜è®¤è¡Œä¸º

**è¯»å·²æäº¤(Read Committed)**ï¼š
- åªå…è®¸è¯»å–å·²æäº¤çš„æ•°æ®
- é€šè¿‡ç‰ˆæœ¬æ§åˆ¶å®ç°
- é€‚åˆå¤§å¤šæ•°åœºæ™¯**å¯é‡å¤è¯»(Repeatable Read)**ï¼š
- ä¿è¯åŒä¸€äº‹åŠ¡ä¸­å¤šæ¬¡è¯»å–ç»“æœä¸€è‡´
- é€šè¿‡äº‹åŠ¡å†…ç¼“å­˜å®ç°
- å®ç°å¤æ‚åº¦é«˜**ä¸²è¡ŒåŒ–(Serializable)**ï¼š
- æœ€é«˜éš”ç¦»çº§åˆ«
- é€šè¿‡åˆ†å¸ƒå¼é”å®ç°
- æ€§èƒ½å¼€é”€å¤§

### 7.3 å¹‚ç­‰æ€§ä¿éšœ

åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œæ¶ˆæ¯å¯èƒ½è¢«é‡å¤å‘é€ï¼Œå› æ­¤Sagaäº‹åŠ¡å¿…é¡»ä¿è¯å¹‚ç­‰æ€§ã€‚

**å®ç°æ–¹å¼**ï¼š
- **å”¯ä¸€æ ‡è¯†ç¬¦**ï¼šä¸ºæ¯ä¸ªè¯·æ±‚åˆ†é…å”¯ä¸€ID
- **çŠ¶æ€æœºæ£€æŸ¥**ï¼šæ£€æŸ¥å½“å‰çŠ¶æ€æ˜¯å¦å…è®¸æ“ä½œ
- **ç‰ˆæœ¬æ§åˆ¶**ï¼šä½¿ç”¨ä¹è§‚é”
- **æ“ä½œæ—¥å¿—**ï¼šè®°å½•å·²æ‰§è¡Œçš„æ“ä½œ

```java
@Transactional
public void processPayment(ProcessPaymentCommand command) {
    // æ£€æŸ¥æ˜¯å¦å·²å¤„ç†
    if (paymentRepository.existsByOrderId(command.getOrderId())) {
        // å·²å¤„ç†ï¼Œè¿”å›æˆåŠŸ
        return;
    }
    // å¤„ç†æ”¯ä»˜...
}
```

###7.4 è¡¥å¿äº‹åŠ¡è®¾è®¡

**è¡¥å¿äº‹åŠ¡åŸåˆ™**ï¼š
- **å¹‚ç­‰æ€§**ï¼šå¯ä»¥å®‰å…¨åœ°é‡å¤æ‰§è¡Œ
- **å¯æ’¤é”€æ€§**ï¼šèƒ½å¤Ÿå®Œå…¨æ’¤é”€åŸäº‹åŠ¡çš„å½±å“
- **åŸå­æ€§**ï¼šè¡¥å¿äº‹åŠ¡æœ¬èº«åº”è¯¥æ˜¯åŸå­çš„
- **æ— å‰¯ä½œç”¨**ï¼šè¡¥å¿æ“ä½œä¸åº”äº§ç”Ÿæ–°çš„å‰¯ä½œç”¨
- **åŠæ—¶æ€§**ï¼šå°½å¿«æ‰§è¡Œè¡¥å¿äº‹åŠ¡

**è¡¥å¿ç­–ç•¥**ï¼š
- **ç›´æ¥è¡¥å¿**ï¼šç›´æ¥æ’¤é”€åŸæ“ä½œ
- **é—´æ¥è¡¥å¿**ï¼šé€šè¿‡ç›¸åæ“ä½œæ¢å¤çŠ¶æ€
- **è¡¥å¿æ—¥å¿—**ï¼šè®°å½•åŸæ“ä½œä»¥ä¾¿åç»­æ‰‹åŠ¨è¡¥å¿

---

##8. Sagaæ¨¡å¼æ€§èƒ½ä¼˜åŒ–

###8.1 å¹¶è¡Œæ‰§è¡Œ

å¯¹äºä¸ç›¸äº’ä¾èµ–çš„æ­¥éª¤ï¼Œå¯ä»¥å¹¶è¡Œæ‰§è¡Œä»¥æé«˜æ€§èƒ½ã€‚

**ååŒå¼Sagaå¹¶è¡Œæ‰§è¡Œ**ï¼š
```java
@SagaEventHandler(associationProperty = "orderId")
public void handle(OrderCreatedEvent event) {
    // å¹¶è¡Œæ‰§è¡Œå¤šä¸ªä»»åŠ¡
    CompletableFuture.allOf(
        CompletableFuture.runAsync(() -> commandGateway.send(new ValidateUserCommand(...))),
        CompletableFuture.runAsync(() -> commandGateway.send(new CheckInventoryCommand(...))),
        CompletableFuture.runAsync(() -> commandGateway.send(new CalculateTaxCommand(...)))
    ).thenRun(() -> {
        // æ‰€æœ‰å¹¶è¡Œä»»åŠ¡å®Œæˆåç»§ç»­
        commandGateway.send(new ProcessPaymentCommand(...));
    });
}
```

###8.2 å¼‚æ­¥å¤„ç†

å°†éå…³é”®è·¯å¾„æ“ä½œæ”¹ä¸ºå¼‚æ­¥æ‰§è¡Œï¼Œå‡å°‘ä¸»æµç¨‹è€—æ—¶ã€‚

```java
@Transactional
public void processOrder(Order order) {
    // åŒæ­¥æ‰§è¡Œå…³é”®æ“ä½œ
    orderRepository.save(order);
    inventoryService.deductInventory(order);
    paymentService.processPayment(order);

    // å¼‚æ­¥æ‰§è¡Œéå…³é”®æ“ä½œ
    CompletableFuture.runAsync(() -> notificationService.sendConfirmation(order));
    CompletableFuture.runAsync(() -> analyticsService.recordOrder(order));
}
```

###8.3 çŠ¶æ€æŒä¹…åŒ–ä¼˜åŒ–

**ä¼˜åŒ–ç­–ç•¥**ï¼š
- åªæŒä¹…åŒ–å¿…è¦çš„çŠ¶æ€ä¿¡æ¯
- ä½¿ç”¨é«˜æ•ˆçš„åºåˆ—åŒ–æ–¹å¼
- è€ƒè™‘ä½¿ç”¨ç¼“å­˜å‡å°‘æ•°æ®åº“è®¿é—®
- å®šæœŸæ¸…ç†å·²å®Œæˆçš„SagaçŠ¶æ€

###8.4 é‡è¯•æœºåˆ¶

å®ç°æ™ºèƒ½é‡è¯•æœºåˆ¶ï¼Œå¤„ç†ä¸´æ—¶æ•…éšœã€‚

```java
@Retry(maxAttempts = 3, delay = 1000, backoff = BackoffPolicy.EXPONENTIAL)
public void deductInventory(DeductInventoryCommand command) {
    // æ‰£å‡åº“å­˜é€»è¾‘
}
```

###8.5 æ‰¹é‡å¤„ç†

å¯¹äºé«˜é¢‘ä½ä»·å€¼çš„æ“ä½œï¼Œé‡‡ç”¨æ‰¹é‡å¤„ç†æ–¹å¼ã€‚

```java
@Scheduled(fixedRate = 60000)
public void batchProcessCompensations() {
    List<PendingCompensation> compensations = compensationRepository.findTop100ByStatus(PENDING);
    for (PendingCompensation compensation : compensations) {
        processCompensation(compensation);
    }
}
```

---

##9. ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ

###9.1 ç›‘æ§ä¸å¯è§‚æµ‹æ€§

**å…³é”®ç›‘æ§æŒ‡æ ‡**ï¼š
- Sagaæ‰§è¡ŒæˆåŠŸç‡
- Sagaå¹³å‡æ‰§è¡Œæ—¶é—´
- è¡¥å¿äº‹åŠ¡è§¦å‘é¢‘ç‡
- å„æ­¥éª¤æ‰§è¡Œæ—¶é—´åˆ†å¸ƒ
- é‡è¯•æ¬¡æ•°ç»Ÿè®¡

**åˆ†å¸ƒå¼è¿½è¸ª**ï¼š
- ä½¿ç”¨Zipkinæˆ–Jaegerè¿½è¸ªSagaæµç¨‹
- ä¸ºæ¯ä¸ªSagaå®ä¾‹ç”Ÿæˆå”¯ä¸€è¿½è¸ªID
- è®°å½•æ¯ä¸ªæ­¥éª¤çš„å¼€å§‹å’Œç»“æŸæ—¶é—´
- ä¼ é€’è¿½è¸ªä¸Šä¸‹æ–‡

```java
@SagaEventHandler(associationProperty = "orderId")
public void handle(OrderCreatedEvent event) {
    // è®¾ç½®è¿½è¸ªä¸Šä¸‹æ–‡
    MDC.put("traceId", event.getTraceId());
    MDC.put("sagaId", this.sagaId);
    // å¤„ç†äº‹ä»¶...
}
```

###9.2 é”™è¯¯å¤„ç†ç­–ç•¥

**å¤šçº§é”™è¯¯å¤„ç†**ï¼š
1. **é‡è¯•**ï¼šå¯¹ä¸´æ—¶é”™è¯¯è¿›è¡Œæœ‰é™æ¬¡æ•°é‡è¯•
2. **é™çº§**ï¼šä½¿ç”¨å¤‡ç”¨æœåŠ¡æˆ–é»˜è®¤å€¼
3. **è¡¥å¿**ï¼šè§¦å‘è¡¥å¿äº‹åŠ¡
4. **å‘Šè­¦**ï¼šé€šçŸ¥è¿ç»´äººå‘˜
5. **æ‰‹åŠ¨å¹²é¢„**ï¼šæ— æ³•è‡ªåŠ¨æ¢å¤æ—¶

**æ­»ä¿¡é˜Ÿåˆ—**ï¼š
- å°†æ— æ³•å¤„ç†çš„äº‹ä»¶å‘é€åˆ°æ­»ä¿¡é˜Ÿåˆ—
- å®šæœŸç›‘æ§å’Œå¤„ç†æ­»ä¿¡é˜Ÿåˆ—
- æä¾›æ‰‹åŠ¨é‡è¯•æœºåˆ¶

###9.3 äº‹åŠ¡æ¢å¤

**å®šæœŸæ¢å¤**ï¼š
- å®šæœŸæ‰«æé•¿æ—¶é—´è¿è¡Œçš„Saga
- æ£€æŸ¥å¡ä½çš„äº‹åŠ¡å¹¶å°è¯•æ¢å¤
- è®°å½•æ¢å¤æ“ä½œä»¥ä¾¿å®¡è®¡

```java
@Scheduled(fixedRate = 3600000) // æ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡
public void recoverStuckSagas() {
    List<OrderSaga> stuckSagas = sagaRepository.findByStatusAndLastUpdatedBefore(
        SagaStatus.RUNNING, LocalDateTime.now().minusHours(2));

    for (OrderSaga saga : stuckSagas) {
        log.warn("Saga stuck: {}", saga.getSagaId());
        // å°è¯•æ¢å¤
        saga.recover();
        sagaRepository.save(saga);
    }
}
```

###9.4 æ•°æ®å¤‡ä»½ä¸æ¢å¤

- å®šæœŸå¤‡ä»½SagaçŠ¶æ€æ•°æ®
- æµ‹è¯•æ¢å¤æµç¨‹
- ç¡®ä¿è¡¥å¿äº‹åŠ¡å¯ä»¥åœ¨æ•°æ®æ¢å¤åæ­£ç¡®æ‰§è¡Œ

###9.5 å®‰å…¨è€ƒè™‘

- å¯¹æ•æ„Ÿæ•°æ®è¿›è¡ŒåŠ å¯†
- å®ç°è®¿é—®æ§åˆ¶
- éªŒè¯æ‰€æœ‰è¾“å…¥
- é˜²æ­¢é‡æ”¾æ”»å‡»
- å®¡è®¡æ‰€æœ‰å…³é”®æ“ä½œ

---

##10. å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

###10.1 è¡¥å¿äº‹åŠ¡å¤±è´¥

**é—®é¢˜**ï¼šè¡¥å¿äº‹åŠ¡æœ¬èº«å¯èƒ½å¤±è´¥ï¼Œå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
- è¡¥å¿äº‹åŠ¡é‡è¯•æœºåˆ¶
- è¡¥å¿äº‹åŠ¡æ—¥å¿—
- æ‰‹åŠ¨æ¢å¤æµç¨‹
- è¡¥å¿äº‹åŠ¡ä¼˜å…ˆçº§é˜Ÿåˆ—

###10.2 é•¿æ—¶é—´è¿è¡Œçš„Saga

**é—®é¢˜**ï¼šé•¿æ—¶é—´è¿è¡Œçš„Sagaå¯èƒ½å¯¼è‡´çŠ¶æ€ç®¡ç†å¤æ‚ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
- å®šæœŸçŠ¶æ€æŒä¹…åŒ–
- åˆ†é˜¶æ®µSaga
- æ£€æŸ¥ç‚¹æœºåˆ¶
- è¶…æ—¶å¤„ç†

###10.3 æ•°æ®ä¸€è‡´æ€§æŒ‘æˆ˜

**é—®é¢˜**ï¼šåœ¨Sagaæ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå…¶ä»–äº‹åŠ¡å¯èƒ½çœ‹åˆ°ä¸­é—´çŠ¶æ€ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
- çŠ¶æ€éšè—ï¼šåªæš´éœ²ç¨³å®šçŠ¶æ€
- ç‰ˆæœ¬æ§åˆ¶ï¼šä½¿ç”¨ä¹è§‚é”
- è¯»å†™åˆ†ç¦»ï¼šè¯»æ¨¡å‹åæ˜ å·²å®Œæˆçš„äº‹åŠ¡
- é¢†åŸŸäº‹ä»¶ï¼šé€šè¿‡äº‹ä»¶æ›´æ–°è¯»æ¨¡å‹

###10.4 ç½‘ç»œåˆ†åŒº

**é—®é¢˜**ï¼šç½‘ç»œåˆ†åŒºå¯èƒ½å¯¼è‡´SagaçŠ¶æ€ä¸ä¸€è‡´ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ¶ˆæ¯æŒä¹…åŒ–
- é‡è¯•æœºåˆ¶
- æœ€ç»ˆä¸€è‡´æ€§æ¥å—
- å†²çªæ£€æµ‹ä¸è§£å†³

###10.5 æœåŠ¡ç‰ˆæœ¬å…¼å®¹æ€§

**é—®é¢˜**ï¼šæœåŠ¡å‡çº§å¯èƒ½ç ´åSagaå…¼å®¹æ€§ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
- äº‹ä»¶ç‰ˆæœ¬æ§åˆ¶
- å‘åå…¼å®¹çš„APIè®¾è®¡
- è“ç»¿éƒ¨ç½²
- ç‰¹æ€§å¼€å…³

---

##11. æ¡ˆä¾‹åˆ†æ

###11.1 ç”µå•†è®¢å•å¤„ç†ç³»ç»Ÿ

**èƒŒæ™¯**ï¼šå¤§å‹ç”µå•†å¹³å°ï¼Œæ—¥å‡è®¢å•100ä¸‡+
**æŒ‘æˆ˜**ï¼šä¿è¯è®¢å•å¤„ç†çš„ä¸€è‡´æ€§ï¼Œæ¶‰åŠå¤šä¸ªæœåŠ¡
**è§£å†³æ–¹æ¡ˆ**ï¼šååŒå¼Sagaæ¨¡å¼
**æŠ€æœ¯æ ˆ**ï¼šSpring Boot + Axon Framework + Kafka
**æˆæœ**ï¼š
- è®¢å•å¤„ç†æˆåŠŸç‡æå‡è‡³99.9%
- ç³»ç»Ÿååé‡æå‡40%
- æ•…éšœæ¢å¤æ—¶é—´ä»å°æ—¶çº§é™è‡³åˆ†é’Ÿçº§
- å‡å°‘äº†80%çš„äººå·¥å¹²é¢„

###11.2 é“¶è¡Œè½¬è´¦ç³»ç»Ÿ

**èƒŒæ™¯**ï¼šé“¶è¡Œé—´è½¬è´¦ç³»ç»Ÿ
**æŒ‘æˆ˜**ï¼šè·¨é“¶è¡Œæ•°æ®ä¸€è‡´æ€§ï¼Œä¸¥æ ¼çš„åˆè§„è¦æ±‚
**è§£å†³æ–¹æ¡ˆ**ï¼šæ··åˆå¼Sagaæ¨¡å¼(ååŒå¼+ç¼–æ’å¼)
**æŠ€æœ¯æ ˆ**ï¼šJava + Apache Camel + PostgreSQL
**æˆæœ**ï¼š
- æ»¡è¶³é‡‘èåˆè§„è¦æ±‚
- è½¬è´¦æˆåŠŸç‡99.99%
- å®ç°åˆ†é’Ÿçº§åˆ°è´¦
- å®Œå–„çš„å®¡è®¡è·Ÿè¸ª

###11.3 ç‰©æµé…é€ç³»ç»Ÿ

**èƒŒæ™¯**ï¼šå…¨çƒç‰©æµé…é€å¹³å°
**æŒ‘æˆ˜**ï¼šé•¿äº‹åŠ¡å‘¨æœŸï¼Œå¤šå‚ä¸æ–¹
**è§£å†³æ–¹æ¡ˆ**ï¼šç¼–æ’å¼Sagaæ¨¡å¼
**æŠ€æœ¯æ ˆ**ï¼šNode.js + RabbitMQ + MongoDB
**æˆæœ**ï¼š
- é…é€æµç¨‹è‡ªåŠ¨åŒ–ç‡æå‡60%
- å¼‚å¸¸å¤„ç†æ—¶é—´å‡å°‘70%
- å®¢æˆ·æ»¡æ„åº¦æå‡30%
- è¿è¥æˆæœ¬é™ä½25%

---

##12. Sagaæ¨¡å¼æ¡†æ¶é€‰å‹

###12.1 Javaç”Ÿæ€ç³»ç»Ÿ

**Axon Framework**ï¼š
- å®Œæ•´çš„CQRSå’Œäº‹ä»¶æº¯æºæ”¯æŒ
- å¼ºå¤§çš„Sagaå®ç°
- ä¸Springç”Ÿæ€é›†æˆè‰¯å¥½
- æ´»è·ƒçš„ç¤¾åŒº
- ä¼ä¸šçº§æ”¯æŒ

**Camunda**ï¼š
- åŸºäºBPMN 2.0çš„å·¥ä½œæµå¼•æ“
- å¯è§†åŒ–æµç¨‹è®¾è®¡
- å¼ºå¤§çš„ä»»åŠ¡ç®¡ç†
- é€‚åˆå¤æ‚ä¸šåŠ¡æµç¨‹
- æˆç†Ÿç¨³å®š

**Apache Camel**ï¼š
- ä¼ä¸šé›†æˆæ¨¡å¼å®ç°
- ä¸°å¯Œçš„ç»„ä»¶åº“
- çµæ´»çš„è·¯ç”±è§„åˆ™
- é€‚åˆç¼–æ’å¼Saga
- è½»é‡çº§

###12.2 .NETç”Ÿæ€ç³»ç»Ÿ

**NServiceBus**ï¼š
- ä¸“ä¸ºåˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡
- å†…ç½®Sagaæ”¯æŒ
- å¯é çš„æ¶ˆæ¯ä¼ é€’
- ä¼ä¸šçº§ç‰¹æ€§
- è‰¯å¥½çš„æ–‡æ¡£

**MassTransit**ï¼š
- å¼€æºæ¶ˆæ¯æ€»çº¿
- æ”¯æŒå¤šç§æ¶ˆæ¯é˜Ÿåˆ—
- å†…ç½®SagaçŠ¶æ€æœº
- è½»é‡çº§
- çµæ´»çš„é…ç½®

###12.3 å…¶ä»–è¯­è¨€æ¡†æ¶

**Python**ï¼š
- Celery + Flower
- Dramatiq
- Nameko

**Go**ï¼š
- Temporal
- Eventuate
- Watermill

**Node.js**ï¼š
- Eventuate Tram
- Bull
- Step

###12.4 æ¡†æ¶å¯¹æ¯”

| æ¡†æ¶ | ç¼–ç¨‹æ¨¡å‹ | å­¦ä¹ æ›²çº¿ | ä¼ä¸šç‰¹æ€§ | æ€§èƒ½ | ç¤¾åŒºæ´»è·ƒåº¦ |
|------|---------|---------|---------|------|-----------|
| Axon Framework | äº‹ä»¶é©±åŠ¨ | ä¸­ | â˜…â˜…â˜…â˜…â˜… | â˜…â˜…â˜…â˜…â˜† | â˜…â˜…â˜…â˜…â˜† |
| Camunda | BPMN | é«˜ | â˜…â˜…â˜…â˜…â˜… | â˜…â˜…â˜…â˜†â˜† | â˜…â˜…â˜…â˜…â˜† |
| Apache Camel | è·¯ç”±è§„åˆ™ | ä¸­ | â˜…â˜…â˜…â˜…â˜† | â˜…â˜…â˜…â˜…â˜† | â˜…â˜…â˜…â˜…â˜† |
| NServiceBus | æ¶ˆæ¯é©±åŠ¨ | ä¸­ | â˜…â˜…â˜…â˜…â˜… | â˜…â˜…â˜…â˜…â˜† | â˜…â˜…â˜…â˜†â˜† |
| MassTransit | æ¶ˆæ¯é©±åŠ¨ | ä½ | â˜…â˜…â˜…â˜†â˜† | â˜…â˜…â˜…â˜…â˜† | â˜…â˜…â˜…â˜†â˜† |
| Temporal | å·¥ä½œæµ | ä¸­ | â˜…â˜…â˜…â˜…â˜† | â˜…â˜…â˜…â˜…â˜… | â˜…â˜…â˜…â˜†â˜† |

---

## ğŸ“š å‚è€ƒèµ„æº

1. [Saga Pattern - Microservices.io](https://microservices.io/patterns/data/saga.html)
2. [Axon Framework Documentation](https://docs.axoniq.io/reference-guide/)
3. [Camunda Documentation](https://docs.camunda.org/manual/latest/)
4. [Saga: Distributed Transactions without Two-Phase Commit](https://www.cs.cornell.edu/andru/cs711/2002fa/reading/sagas.pdf)
5. [Building Microservices with Spring Boot and Spring Cloud](https://www.manning.com/books/building-microservices-with-spring-boot-and-spring-cloud)
6. [Event-Driven Architecture in Action](https://www.manning.com/books/event-driven-architecture-in-action)
7. [Distributed Systems for Fun and Profit](https://book.mixu.net/distsys/saga.html)
8. [Patterns, Principles, and Practices of Domain-Driven Design](https://www.wiley.com/en-us/Patterns%2C+Principles%2C+and+Practices+of+Domain+Driven+Design-p-9781118714706)