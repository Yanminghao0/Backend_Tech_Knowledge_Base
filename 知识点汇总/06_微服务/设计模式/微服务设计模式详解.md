# å¾®æœåŠ¡è®¾è®¡æ¨¡å¼è¯¦è§£

> æ„å»ºå¼¹æ€§ã€å¯æ‰©å±•å’Œå¯ç»´æŠ¤çš„å¾®æœåŠ¡æ¶æ„çš„æ ¸å¿ƒè®¾è®¡åŸåˆ™ä¸å®è·µ

## ğŸ“‹ ç›®å½•

1. [å¾®æœåŠ¡è®¾è®¡æ¨¡å¼æ¦‚è¿°](#1-å¾®æœåŠ¡è®¾è®¡æ¨¡å¼æ¦‚è¿°)
2. [æœåŠ¡é€šä¿¡æ¨¡å¼](#2-æœåŠ¡é€šä¿¡æ¨¡å¼)
3. [æ•°æ®ç®¡ç†æ¨¡å¼](#3-æ•°æ®ç®¡ç†æ¨¡å¼)
4. [å¼¹æ€§è®¾è®¡æ¨¡å¼](#4-å¼¹æ€§è®¾è®¡æ¨¡å¼)
5. [æœåŠ¡å‘ç°ä¸è·¯ç”±æ¨¡å¼](#5-æœåŠ¡å‘ç°ä¸è·¯ç”±æ¨¡å¼)
6. [éƒ¨ç½²ä¸è¿ç»´æ¨¡å¼](#6-éƒ¨ç½²ä¸è¿ç»´æ¨¡å¼)
7. [å®‰å…¨è®¾è®¡æ¨¡å¼](#7-å®‰å…¨è®¾è®¡æ¨¡å¼)
8. [ç»„åˆä¸é›†æˆæ¨¡å¼](#8-ç»„åˆä¸é›†æˆæ¨¡å¼)
9. [è®¾è®¡æ¨¡å¼å®æˆ˜æ¡ˆä¾‹](#9-è®¾è®¡æ¨¡å¼å®æˆ˜æ¡ˆä¾‹)
10. [æ¨¡å¼é€‰æ‹©ä¸æƒè¡¡](#10-æ¨¡å¼é€‰æ‹©ä¸æƒè¡¡)

---

## 1. å¾®æœåŠ¡è®¾è®¡æ¨¡å¼æ¦‚è¿°

### 1.1 ä»€ä¹ˆæ˜¯å¾®æœåŠ¡è®¾è®¡æ¨¡å¼

å¾®æœåŠ¡è®¾è®¡æ¨¡å¼æ˜¯è§£å†³å¾®æœåŠ¡æ¶æ„ä¸­å¸¸è§é—®é¢˜çš„æœ€ä½³å®è·µå’Œå¯å¤ç”¨è§£å†³æ–¹æ¡ˆã€‚å®ƒä»¬æä¾›äº†ç»è¿‡éªŒè¯çš„è®¾è®¡æ€è·¯ï¼Œå¸®åŠ©å¼€å‘å›¢é˜Ÿæ„å»ºå¼¹æ€§å¼ºã€å¯æ‰©å±•ä¸”æ˜“äºç»´æŠ¤çš„åˆ†å¸ƒå¼ç³»ç»Ÿã€‚

ä¸å•ä½“åº”ç”¨ç›¸æ¯”ï¼Œå¾®æœåŠ¡æ¶æ„å¼•å…¥äº†é¢å¤–çš„å¤æ‚æ€§ï¼ŒåŒ…æ‹¬åˆ†å¸ƒå¼ç³»ç»Ÿé€šä¿¡ã€æ•°æ®ä¸€è‡´æ€§ã€æœåŠ¡å‘ç°ã€å®¹é”™å¤„ç†ç­‰æŒ‘æˆ˜ã€‚è®¾è®¡æ¨¡å¼é€šè¿‡æä¾›æ ‡å‡†åŒ–çš„è§£å†³æ–¹æ¡ˆï¼Œå¸®åŠ©å›¢é˜Ÿåº”å¯¹è¿™äº›æŒ‘æˆ˜ã€‚

### 1.2 è®¾è®¡æ¨¡å¼åˆ†ç±»

å¾®æœåŠ¡è®¾è®¡æ¨¡å¼å¯åˆ†ä¸ºä»¥ä¸‹å‡ å¤§ç±»ï¼š

| ç±»åˆ« | å…³æ³¨ç‚¹ | å…¸å‹æ¨¡å¼ |
|------|--------|----------|
| **æœåŠ¡é€šä¿¡** | æœåŠ¡é—´äº¤äº’æ–¹å¼ | åŒæ­¥RESTã€å¼‚æ­¥æ¶ˆæ¯ã€è¯·æ±‚-å“åº”ã€å‘å¸ƒ-è®¢é˜… |
| **æ•°æ®ç®¡ç†** | åˆ†å¸ƒå¼æ•°æ®å¤„ç† | æ•°æ®åº“æ¯æœåŠ¡ã€å…±äº«æ•°æ®åº“ã€CQRSã€äº‹ä»¶æº¯æº |
| **å¼¹æ€§è®¾è®¡** | ç³»ç»Ÿå®¹é”™èƒ½åŠ› | ç†”æ–­å™¨ã€èˆ±å£ã€é‡è¯•ã€è¶…æ—¶ã€é™æµ |
| **æœåŠ¡å‘ç°** | æœåŠ¡å®šä½ä¸è·¯ç”± | å®¢æˆ·ç«¯å‘ç°ã€æœåŠ¡ç«¯å‘ç°ã€APIç½‘å…³ |
| **éƒ¨ç½²è¿ç»´** | æœåŠ¡äº¤ä»˜ä¸ç®¡ç† | è“ç»¿éƒ¨ç½²ã€é‡‘ä¸é›€å‘å¸ƒã€åŸºç¡€è®¾æ–½å³ä»£ç  |
| **å®‰å…¨è®¾è®¡** | æœåŠ¡è®¿é—®æ§åˆ¶ | APIå¯†é’¥ã€OAuth2.0ã€JWTã€æœåŠ¡é—´è®¤è¯ |
| **ç»„åˆé›†æˆ** | æœåŠ¡åä½œæœºåˆ¶ | èšåˆå™¨ã€é“¾å¼ã€åˆ†æ”¯ã€BFFæ¨¡å¼ |

### 1.3 è®¾è®¡åŸåˆ™

åœ¨åº”ç”¨å¾®æœåŠ¡è®¾è®¡æ¨¡å¼æ—¶ï¼Œåº”éµå¾ªä»¥ä¸‹æ ¸å¿ƒåŸåˆ™ï¼š

- **å•ä¸€èŒè´£**ï¼šæ¯ä¸ªæœåŠ¡ä¸“æ³¨äºè§£å†³ç‰¹å®šä¸šåŠ¡é¢†åŸŸé—®é¢˜
- **è‡ªæ²»æ€§**ï¼šæœåŠ¡åº”èƒ½ç‹¬ç«‹å¼€å‘ã€æµ‹è¯•ã€éƒ¨ç½²å’Œæ‰©å±•
- **å»ä¸­å¿ƒåŒ–**ï¼šé¿å…ä¸­å¤®æ§åˆ¶ï¼Œå®ç°æ•°æ®å’Œæ²»ç†çš„å»ä¸­å¿ƒåŒ–
- **å¼¹æ€§è®¾è®¡**ï¼šå‡è®¾æ•…éšœä¸å¯é¿å…ï¼Œè®¾è®¡æ—¶è€ƒè™‘å„ç§å¼‚å¸¸åœºæ™¯
- **æ¼”è¿›å¼æ¶æ„**ï¼šç³»ç»Ÿåº”èƒ½éšä¸šåŠ¡éœ€æ±‚å˜åŒ–è€Œæ¼”è¿›
- **é¢†åŸŸé©±åŠ¨**ï¼šåŸºäºä¸šåŠ¡é¢†åŸŸè¾¹ç•Œå®šä¹‰æœåŠ¡è¾¹ç•Œ
- **DevOpsæ–‡åŒ–**ï¼šå¼ºè°ƒå¼€å‘ä¸è¿ç»´çš„ç´§å¯†åä½œ

---

## 2. æœåŠ¡é€šä¿¡æ¨¡å¼

### 2.1 åŒæ­¥é€šä¿¡æ¨¡å¼

#### 2.1.1 è¯·æ±‚-å“åº”æ¨¡å¼

æœ€å¸¸è§çš„æœåŠ¡é€šä¿¡æ¨¡å¼ï¼Œå®¢æˆ·ç«¯å‘é€è¯·æ±‚å¹¶ç­‰å¾…å“åº”ã€‚é€‚ç”¨äºéœ€è¦å³æ—¶ç»“æœçš„åœºæ™¯ã€‚

**å®ç°æ–¹å¼**ï¼šREST APIã€gRPC

**REST APIç¤ºä¾‹**ï¼š
```java
@RestController
@RequestMapping("/orders")
public class OrderController {
    @Autowired
    private OrderService orderService;

    @GetMapping("/{id}")
    public ResponseEntity<OrderDTO> getOrder(@PathVariable Long id) {
        return orderService.findById(id)
            .map(ResponseEntity::ok)
            .orElse(ResponseEntity.notFound().build());
    }

    @PostMapping
    public ResponseEntity<OrderDTO> createOrder(@RequestBody @Valid OrderRequest request) {
        OrderDTO created = orderService.createOrder(request);
        URI location = ServletUriComponentsBuilder
            .fromCurrentRequest()
            .path("/{id}")
            .buildAndExpand(created.getId())
            .toUri();
        return ResponseEntity.created(location).body(created);
    }
}
```

**gRPCç¤ºä¾‹**ï¼š
```protobuf
// order.proto
syntax = "proto3";

package com.example.order;

service OrderService {
  rpc GetOrder (OrderRequest) returns (OrderResponse);
  rpc CreateOrder (CreateOrderRequest) returns (OrderResponse);
}

message OrderRequest {
  int64 order_id = 1;
}

message CreateOrderRequest {
  int64 user_id = 1;
  repeated OrderItem items = 2;
}

message OrderItem {
  int64 product_id = 1;
  int32 quantity = 2;
}

message OrderResponse {
  int64 order_id = 1;
  int64 user_id = 2;
  repeated OrderItem items = 3;
  string status = 4;
  double total_amount = 5;
}
```

#### 2.1.2 è¯·æ±‚-å¼‚æ­¥å“åº”æ¨¡å¼

å®¢æˆ·ç«¯å‘é€è¯·æ±‚åä¸é˜»å¡ï¼Œé€šè¿‡å›è°ƒæˆ–è½®è¯¢è·å–ç»“æœã€‚é€‚ç”¨äºå¤„ç†æ—¶é—´è¾ƒé•¿çš„æ“ä½œã€‚

**å®ç°æ–¹å¼**ï¼šå¼‚æ­¥RESTã€WebSocketã€Server-Sent Events

**Spring WebFluxç¤ºä¾‹**ï¼š
```java
@RestController
@RequestMapping("/long-running-tasks")
public class LongRunningTaskController {
    @Autowired
    private TaskService taskService;

    @PostMapping
    public Mono<ResponseEntity<TaskStatusDTO>> submitTask(@RequestBody TaskRequest request) {
        return taskService.submitTask(request)
            .map(taskId -> ResponseEntity.accepted()
                .header("Location", "/long-running-tasks/" + taskId)
                .body(new TaskStatusDTO(taskId, "PENDING")));
    }

    @GetMapping("/{taskId}")
    public Mono<TaskStatusDTO> getTaskStatus(@PathVariable String taskId) {
        return taskService.getTaskStatus(taskId);
    }
}
```

### 2.2 å¼‚æ­¥é€šä¿¡æ¨¡å¼

#### 2.2.1 å‘å¸ƒ-è®¢é˜…æ¨¡å¼

å‘é€è€…ï¼ˆå‘å¸ƒè€…ï¼‰å‘é€æ¶ˆæ¯åˆ°ä¸»é¢˜ï¼Œå¤šä¸ªæ¥æ”¶è€…ï¼ˆè®¢é˜…è€…ï¼‰å¯åŒæ—¶æ¥æ”¶æ¶ˆæ¯ã€‚é€‚ç”¨äºäº‹ä»¶é€šçŸ¥ã€æ•°æ®æ›´æ–°ç­‰åœºæ™¯ã€‚

**å®ç°æ–¹å¼**ï¼šKafkaã€RabbitMQã€ActiveMQ

**Kafkaç¤ºä¾‹**ï¼š
```java
// ç”Ÿäº§è€…
@Service
public class OrderEventProducer {
    private final KafkaTemplate<String, OrderEvent> kafkaTemplate;
    private final String topicName = "order-events";

    public OrderEventProducer(KafkaTemplate<String, OrderEvent> kafkaTemplate) {
        this.kafkaTemplate = kafkaTemplate;
    }

    public void publishOrderCreatedEvent(Order order) {
        OrderEvent event = new OrderEvent(
            UUID.randomUUID().toString(),
            "ORDER_CREATED",
            order.getId(),
            LocalDateTime.now(),
            order);

        kafkaTemplate.send(topicName, order.getId().toString(), event)
            .addCallback(
                result -> log.info("Order event published: {}", event.getEventId()),
                ex -> log.error("Failed to publish order event", ex)
            );
    }
}

// æ¶ˆè´¹è€…
@Service
public class OrderEventConsumer {
    @KafkaListener(topics = "order-events", groupId = "payment-service")
    public void consumeOrderEvent(@Payload OrderEvent event, @Header(KafkaHeaders.RECEIVED_KEY) String key) {
        log.info("Received order event: {} for order: {}", event.getEventType(), key);

        if ("ORDER_CREATED".equals(event.getEventType())) {
            // å¤„ç†è®¢å•åˆ›å»ºäº‹ä»¶ï¼Œå¦‚åˆ›å»ºæ”¯ä»˜
            paymentService.createPayment(event.getOrder());
        }
    }
}
```

#### 2.2.2 æ¶ˆæ¯é˜Ÿåˆ—æ¨¡å¼

å‘é€è€…å°†æ¶ˆæ¯å‘é€åˆ°é˜Ÿåˆ—ï¼Œä¸€ä¸ªæ¥æ”¶è€…å¤„ç†æ¶ˆæ¯ã€‚é€‚ç”¨äºä»»åŠ¡å¼‚æ­¥å¤„ç†ã€è§£è€¦æœåŠ¡ç­‰åœºæ™¯ã€‚

**RabbitMQç¤ºä¾‹**ï¼š
```java
// å‘é€è€…
@Service
public class OrderMessageSender {
    private final RabbitTemplate rabbitTemplate;

    public OrderMessageSender(RabbitTemplate rabbitTemplate) {
        this.rabbitTemplate = rabbitTemplate;
    }

    public void sendOrderToProcessing(Order order) {
        OrderMessage message = new OrderMessage(order.getId(), order.getItems(), order.getUserId());
        rabbitTemplate.convertAndSend("order.exchange", "order.process", message);
    }
}

// æ¥æ”¶è€…
@Service
public class OrderMessageReceiver {
    @RabbitListener(queues = "order.process.queue")
    public void receiveOrderMessage(OrderMessage message) {
        log.info("Processing order: {}", message.getOrderId());
        orderProcessingService.processOrder(message);
    }
}

// é…ç½®
@Configuration
public class RabbitConfig {
    @Bean
    public Queue orderProcessQueue() {
        return QueueBuilder.durable("order.process.queue")
            .withArgument("x-dead-letter-exchange", "order.dlq.exchange")
            .withArgument("x-dead-letter-routing-key", "order.dlq")
            .build();
    }

    @Bean
    public DirectExchange orderExchange() {
        return new DirectExchange("order.exchange");
    }

    @Bean
    public Binding orderProcessBinding() {
        return BindingBuilder.bind(orderProcessQueue())
            .to(orderExchange())
            .with("order.process");
    }
}
```

---

## 3. æ•°æ®ç®¡ç†æ¨¡å¼

### 3.1 æ•°æ®åº“æ¯æœåŠ¡æ¨¡å¼

æ¯ä¸ªæœåŠ¡æ‹¥æœ‰è‡ªå·±çš„æ•°æ®åº“ï¼Œç¡®ä¿æœåŠ¡çš„ç‹¬ç«‹æ€§å’Œè‡ªæ²»æ€§ã€‚

**å®ç°æ–¹å¼**ï¼šå…³ç³»å‹æ•°æ®åº“ã€NoSQLæ•°æ®åº“

**ä¼˜åŠ¿**ï¼š
- æœåŠ¡é—´æ¾è€¦åˆ
- å¯ç‹¬ç«‹é€‰æ‹©æ•°æ®åº“æŠ€æœ¯
- æ•°æ®è®¿é—®æ€§èƒ½ä¼˜åŒ–
- æ•…éšœéš”ç¦»

**æŒ‘æˆ˜**ï¼š
- åˆ†å¸ƒå¼äº‹åŠ¡
- è·¨æœåŠ¡æŸ¥è¯¢
- æ•°æ®ä¸€è‡´æ€§ç»´æŠ¤

**å®ç°ç¤ºä¾‹**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   è®¢å•æœåŠ¡    â”‚    â”‚   åº“å­˜æœåŠ¡    â”‚    â”‚   ç”¨æˆ·æœåŠ¡    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  è®¢å•æ•°æ®åº“   â”‚    â”‚  åº“å­˜æ•°æ®åº“   â”‚    â”‚  ç”¨æˆ·æ•°æ®åº“   â”‚
â”‚  (PostgreSQL) â”‚    â”‚   (MongoDB)   â”‚    â”‚    (MySQL)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 å…±äº«æ•°æ®åº“æ¨¡å¼

å¤šä¸ªæœåŠ¡å…±äº«åŒä¸€ä¸ªæ•°æ®åº“ï¼Œé€‚ç”¨äºæœåŠ¡é—´æ•°æ®ç´§å¯†å…³è”ä¸”äº‹åŠ¡è¦æ±‚é«˜çš„åœºæ™¯ã€‚

**æ³¨æ„**ï¼šè°¨æ…ä½¿ç”¨ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡é—´ç´§è€¦åˆã€‚

### 3.3 CQRSæ¨¡å¼ï¼ˆå‘½ä»¤æŸ¥è¯¢è´£ä»»åˆ†ç¦»ï¼‰

å°†è¯»å†™æ“ä½œåˆ†ç¦»åˆ°ä¸åŒæ¨¡å‹ï¼šå‘½ä»¤æ¨¡å‹å¤„ç†å†™æ“ä½œï¼ŒæŸ¥è¯¢æ¨¡å‹å¤„ç†è¯»æ“ä½œã€‚

**å®ç°ç¤ºä¾‹**ï¼š
```java
// å‘½ä»¤æ¨¡å‹
@Service
public class OrderCommandService {
    @Autowired
    private OrderRepository orderRepository;
    @Autowired
    private OrderEventPublisher eventPublisher;

    @Transactional
    public OrderDTO createOrder(OrderCreateCommand command) {
        Order order = new Order(command.getUserId(), command.getItems());
        Order saved = orderRepository.save(order);
        eventPublisher.publish(new OrderCreatedEvent(saved));
        return OrderMapper.toDTO(saved);
    }
}

// æŸ¥è¯¢æ¨¡å‹
@Service
public class OrderQueryService {
    @Autowired
    private OrderReadRepository readRepository;

    public OrderDetailDTO getOrderDetail(Long orderId) {
        return readRepository.findOrderDetailById(orderId)
            .orElseThrow(() -> new OrderNotFoundException(orderId));
    }

    public Page<OrderSummaryDTO> findUserOrders(Long userId, Pageable pageable) {
        return readRepository.findUserOrders(userId, pageable);
    }
}
```

### 3.4 äº‹ä»¶æº¯æºæ¨¡å¼

å­˜å‚¨å®ä½“çŠ¶æ€çš„å˜æ›´äº‹ä»¶ï¼Œè€Œéå½“å‰çŠ¶æ€ã€‚é€šè¿‡é‡æ”¾äº‹ä»¶é‡å»ºå®ä½“çŠ¶æ€ã€‚

**å®ç°ç¤ºä¾‹**ï¼š
```java
@Entity
public class Order {
    @Id
    private Long id;
    private Long userId;
    @Embedded
    private OrderState state;
    // å…¶ä»–åŸºæœ¬å­—æ®µ

    // ä»äº‹ä»¶é‡å»º
    public static Order reconstruct(Long id, List<OrderEvent> events) {
        Order order = new Order();
        order.id = id;
        for (OrderEvent event : events) {
            order.apply(event);
        }
        return order;
    }

    // åº”ç”¨äº‹ä»¶
    private void apply(OrderEvent event) {
        if (event instanceof OrderCreatedEvent) {
            this.userId = ((OrderCreatedEvent) event).getUserId();
            this.state = OrderState.CREATED;
            // å…¶ä»–åˆå§‹åŒ–é€»è¾‘
        } else if (event instanceof OrderPaidEvent) {
            this.state = OrderState.PAID;
            // å…¶ä»–çŠ¶æ€å˜æ›´é€»è¾‘
        }
        // å¤„ç†å…¶ä»–äº‹ä»¶ç±»å‹
    }
}

@Service
public class EventSourcedOrderRepository {
    @Autowired
    private OrderEventStore eventStore;

    public Order findById(Long id) {
        List<OrderEvent> events = eventStore.getEventsForAggregate(id);
        if (events.isEmpty()) {
            throw new OrderNotFoundException(id);
        }
        return Order.reconstruct(id, events);
    }

    public void save(Order order, OrderEvent event) {
        eventStore.appendEvent(order.getId(), event);
    }
}
```

---

## 4. å¼¹æ€§è®¾è®¡æ¨¡å¼

### 4.1 ç†”æ–­å™¨æ¨¡å¼

é˜²æ­¢æ•…éšœçº§è”ä¼ æ’­ï¼Œå½“ä¾èµ–æœåŠ¡å¤±è´¥ç‡é«˜æ—¶å¿«é€Ÿå¤±è´¥ï¼Œé¿å…èµ„æºè€—å°½ã€‚

**å®ç°æ–¹å¼**ï¼šResilience4jã€Hystrix

**Resilience4jç¤ºä¾‹**ï¼š
```java
@Service
public class PaymentService {
    private final RestTemplate restTemplate;
    private final CircuitBreakerRegistry circuitBreakerRegistry;

    public PaymentService(RestTemplate restTemplate, CircuitBreakerRegistry registry) {
        this.restTemplate = restTemplate;
        this.circuitBreakerRegistry = registry;
    }

    public Mono<PaymentResponse> processPayment(PaymentRequest request) {
        CircuitBreaker circuitBreaker = circuitBreakerRegistry.circuitBreaker("paymentService");

        return CircuitBreaker.decorateMonoSupplier(circuitBreaker, () -> {
            return Mono.fromCallable(() -> {
                // è°ƒç”¨å¤–éƒ¨æ”¯ä»˜æœåŠ¡
                return restTemplate.postForObject(
                    "https://payment-gateway-service/api/payments",
                    request,
                    PaymentResponse.class);
            }).subscribeOn(Schedulers.boundedElastic());
        }).onErrorResume(e -> {
            // é™çº§å¤„ç†
            log.error("æ”¯ä»˜å¤„ç†å¤±è´¥ï¼Œæ‰§è¡Œé™çº§ç­–ç•¥", e);
            return Mono.just(createFallbackPaymentResponse(request));
        });
    }

    private PaymentResponse createFallbackPaymentResponse(PaymentRequest request) {
        // è¿”å›é™çº§å“åº”
        return new PaymentResponse(
            UUID.randomUUID().toString(),
            request.getOrderId(),
            PaymentStatus.PENDING,
            "æ”¯ä»˜å¤„ç†æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•");
    }
}
```

### 4.2 èˆ±å£æ¨¡å¼

å°†ç³»ç»Ÿèµ„æºéš”ç¦»åˆ°ä¸åŒæ± ä¸­ï¼Œé˜²æ­¢å•ä¸ªæœåŠ¡æ¶ˆè€—æ‰€æœ‰èµ„æºã€‚

**å®ç°æ–¹å¼**ï¼šçº¿ç¨‹æ± éš”ç¦»ã€ä¿¡å·é‡éš”ç¦»

**çº¿ç¨‹æ± éš”ç¦»ç¤ºä¾‹**ï¼š
```java
@Configuration
public class ThreadPoolConfig {
    @Bean(name = "inventoryServiceExecutor")
    public Executor inventoryServiceExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(5);
        executor.setMaxPoolSize(10);
        executor.setQueueCapacity(20);
        executor.setThreadNamePrefix("inventory-");
        executor.initialize();
        return executor;
    }

    @Bean(name = "paymentServiceExecutor")
    public Executor paymentServiceExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(3);
        executor.setMaxPoolSize(5);
        executor.setQueueCapacity(10);
        executor.setThreadNamePrefix("payment-");
        executor.initialize();
        return executor;
    }
}

@Service
public class OrderService {
    private final InventoryService inventoryService;
    private final PaymentService paymentService;
    private final Executor inventoryExecutor;
    private final Executor paymentExecutor;

    public OrderService(InventoryService inventoryService,
                       PaymentService paymentService,
                       @Qualifier("inventoryServiceExecutor") Executor inventoryExecutor,
                       @Qualifier("paymentServiceExecutor") Executor paymentExecutor) {
        this.inventoryService = inventoryService;
        this.paymentService = paymentService;
        this.inventoryExecutor = inventoryExecutor;
        this.paymentExecutor = paymentExecutor;
    }

    public CompletableFuture<OrderResult> processOrder(OrderRequest request) {
        // ä½¿ç”¨ä¸åŒçº¿ç¨‹æ± è°ƒç”¨ä¸åŒæœåŠ¡
        CompletableFuture<InventoryCheckResult> inventoryCheck = CompletableFuture
            .supplyAsync(() -> inventoryService.checkInventory(request.getItems()), inventoryExecutor);

        return inventoryCheck.thenCompose(result -> {
            if (result.isAvailable()) {
                return CompletableFuture.supplyAsync(() -> {
                    return paymentService.processPayment(
                        new PaymentRequest(request.getOrderId(), request.getTotalAmount()));
                }, paymentExecutor).thenApply(paymentResult -> {
                    return new OrderResult(request.getOrderId(), OrderStatus.COMPLETED);
                });
            } else {
                return CompletableFuture.completedFuture(
                    new OrderResult(request.getOrderId(), OrderStatus.INVENTORY_SHORTAGE));
            }
        });
    }
}
```

### 4.3 è¶…æ—¶ä¸é‡è¯•æ¨¡å¼

è®¾ç½®è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼Œå¹¶åœ¨å¤±è´¥æ—¶è‡ªåŠ¨é‡è¯•ï¼Œæé«˜æ“ä½œæˆåŠŸç‡ã€‚

**Resilience4jç¤ºä¾‹**ï¼š
```java
@Service
public class ProductService {
    private final WebClient webClient;

    public ProductService(WebClient.Builder webClientBuilder) {
        this.webClient = webClientBuilder.baseUrl("https://product-service")
            .build();
    }

    public Mono<ProductDetail> getProductDetail(String productId) {
        Retry retry = RetryConfig.custom()
            .maxAttempts(3)
            .waitDuration(Duration.ofMillis(1000))
            .retryExceptions(TimeoutException.class, IOException.class)
            .ignoreExceptions(IllegalArgumentException.class)
            .build();

        TimeLimiter timeLimiter = TimeLimiterConfig.custom()
            .timeoutDuration(Duration.ofSeconds(2))
            .build();

        return TimeLimiter.decorateMonoSupplier(timeLimiter, () -> {
            return Retry.decorateMonoSupplier(retry, () -> {
                return webClient.get()
                    .uri("/products/{id}", productId)
                    .retrieve()
                    .bodyToMono(ProductDetail.class);
            });
        });
    }
}
```

### 4.4 é™æµæ¨¡å¼

æ§åˆ¶æœåŠ¡çš„å¹¶å‘è®¿é—®é‡ï¼Œé˜²æ­¢æœåŠ¡è¿‡è½½ã€‚

**å®ç°æ–¹å¼**ï¼šResilience4jã€APIç½‘å…³

**Resilience4jé™æµç¤ºä¾‹**ï¼š
```java
@RestController
@RequestMapping("/products")
public class ProductController {
    private final ProductService productService;
    private final RateLimiter rateLimiter;

    public ProductController(ProductService productService, RateLimiterRegistry registry) {
        this.productService = productService;
        this.rateLimiter = registry.rateLimiter("productApi");
    }

    @GetMapping("/{id}")
    public ResponseEntity<ProductDetail> getProduct(@PathVariable String id) {
        return Try.ofSupplier(RateLimiter.decorateSupplier(rateLimiter, () -> {
            return productService.getProductDetail(id);
        }))
        .map(ResponseEntity::ok)
        .recover(RateLimitExceededException.class, e -> {
            return ResponseEntity.status(HttpStatus.TOO_MANY_REQUESTS)
                .body(null);
        })
        .get();
    }
}
```

---

## 5. æœåŠ¡å‘ç°ä¸è·¯ç”±æ¨¡å¼

### 5.1 å®¢æˆ·ç«¯å‘ç°æ¨¡å¼

å®¢æˆ·ç«¯ç›´æ¥æŸ¥è¯¢æœåŠ¡æ³¨å†Œè¡¨ï¼Œé€‰æ‹©å¯ç”¨æœåŠ¡å®ä¾‹å¹¶å‘èµ·è¯·æ±‚ã€‚

**å®ç°æ–¹å¼**ï¼šSpring Cloud Eureka + Ribbon

**ç¤ºä¾‹**ï¼š
```java
@Configuration
public class EurekaClientConfig {
    @Bean
    @LoadBalanced
    public RestTemplate restTemplate() {
        return new RestTemplate();
    }
}

@Service
public class OrderService {
    private final RestTemplate restTemplate;

    public OrderService(RestTemplate restTemplate) {
        this.restTemplate = restTemplate;
    }

    public ProductDetail getProductDetails(String productId) {
        // ä½¿ç”¨æœåŠ¡åè€Œéå…·ä½“URL
        return restTemplate.getForObject(
            "http://product-service/products/" + productId,
            ProductDetail.class);
    }
}
```

### 5.2 APIç½‘å…³æ¨¡å¼

æä¾›ç»Ÿä¸€å…¥å£ï¼Œå¤„ç†è·¨åˆ‡é¢å…³æ³¨ç‚¹å¦‚è·¯ç”±ã€è®¤è¯ã€é™æµã€ç›‘æ§ç­‰ã€‚

**Spring Cloud Gatewayç¤ºä¾‹**ï¼š
```yaml
# application.yml
spring:
  cloud:
    gateway:
      routes:
        - id: product-service
          uri: lb://product-service
          predicates:
            - Path=/api/products/**filters:
            - StripPrefix=1
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 10
                redis-rate-limiter.burstCapacity: 20

        - id: order-service
          uri: lb://order-service
          predicates:
            - Path=/api/orders/**filters:
            - StripPrefix=1
            - name: CircuitBreaker
              args:
                name: orderServiceCircuitBreaker
                fallbackUri: forward:/fallback/orders

        - id: user-service
          uri: lb://user-service
          predicates:
            - Path=/api/users/**filters:
            - StripPrefix=1
            - name: AuthenticationFilter
```

---

## 6. éƒ¨ç½²ä¸è¿ç»´æ¨¡å¼

### 6.1 è“ç»¿éƒ¨ç½²æ¨¡å¼

åŒæ—¶ç»´æŠ¤ä¸¤ä¸ªç›¸åŒç¯å¢ƒï¼ˆè“ç»¿ï¼‰ï¼Œæ–°ç‰ˆæœ¬éƒ¨ç½²åˆ°éæ´»åŠ¨ç¯å¢ƒï¼Œæµ‹è¯•é€šè¿‡ååˆ‡æ¢æµé‡ã€‚

**å®ç°æ–¹å¼**ï¼šKubernetesã€æœåŠ¡ç½‘æ ¼

**Kubernetesç¤ºä¾‹**ï¼š
```yaml
# è“ç¯å¢ƒ
apiVersion: apps/v1
kind: Deployment
metadata:
  name: order-service-blue
spec:
  replicas: 3
  selector:
    matchLabels:
      app: order-service
      version: blue
  template:
    metadata:
      labels:
        app: order-service
        version: blue
    spec:
      containers:
      - name: order-service
        image: example/order-service:1.0.0
---
# ç»¿ç¯å¢ƒ
apiVersion: apps/v1
kind: Deployment
metadata:
  name: order-service-green
spec:
  replicas: 3
  selector:
    matchLabels:
      app: order-service
      version: green
  template:
    metadata:
      labels:
        app: order-service
        version: green
    spec:
      containers:
      - name: order-service
        image: example/order-service:2.0.0
---
# æ´»åŠ¨æœåŠ¡
apiVersion: v1
kind: Service
metadata:
  name: order-service
spec:
  selector:
    app: order-service
    version: blue  # åˆ‡æ¢åˆ°greenå®Œæˆéƒ¨ç½²
  ports:
  - port: 80
    targetPort: 8080
```

### 6.2 é‡‘ä¸é›€å‘å¸ƒæ¨¡å¼

å°†æ–°ç‰ˆæœ¬é€æ­¥éƒ¨ç½²åˆ°éƒ¨åˆ†ç”¨æˆ·ï¼ŒéªŒè¯ç¨³å®šæ€§åæ‰©å¤§èŒƒå›´ã€‚

**å®ç°æ–¹å¼**ï¼šIstioã€Spring Cloud Gateway

**Istioç¤ºä¾‹**ï¼š
```yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: order-service
  namespace: default
spec:
  hosts:
  - order-service
  http:
  - route:
    - destination:
        host: order-service
        subset: v1
      weight: 90
    - destination:
        host: order-service
        subset: v2
      weight: 10
---
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: order-service
spec:
  host: order-service
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
```

---

## 7. å®‰å…¨è®¾è®¡æ¨¡å¼

### 7.1 APIç½‘å…³è®¤è¯æ¨¡å¼

åœ¨APIç½‘å…³å±‚é›†ä¸­å¤„ç†è®¤è¯å’Œæˆæƒï¼Œä¿æŠ¤åç«¯æœåŠ¡ã€‚

**Spring Cloud Gateway + Spring Securityç¤ºä¾‹**ï¼š
```java
@Component
public class AuthenticationFilter implements GlobalFilter, Ordered {
    private final JwtTokenProvider tokenProvider;

    public AuthenticationFilter(JwtTokenProvider tokenProvider) {
        this.tokenProvider = tokenProvider;
    }

    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        // è·å–token
        String token = extractToken(exchange.getRequest());

        if (token == null || !tokenProvider.validateToken(token)) {
            exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);
            return exchange.getResponse().setComplete();
        }

        // éªŒè¯tokenå¹¶è®¾ç½®ç”¨æˆ·ä¿¡æ¯
        Authentication auth = tokenProvider.getAuthentication(token);
        SecurityContextHolder.getContext().setAuthentication(auth);

        // å°†ç”¨æˆ·ä¿¡æ¯ä¼ é€’ç»™ä¸‹æ¸¸æœåŠ¡
        exchange.getRequest().mutate()
            .header("X-User-ID", auth.getName())
            .header("X-User-Roles", String.join(",", getRoles(auth)))
            .build();

        return chain.filter(exchange);
    }

    private String extractToken(ServerHttpRequest request) {
        String bearerToken = request.getHeaders().getFirst(HttpHeaders.AUTHORIZATION);
        if (bearerToken != null && bearerToken.startsWith("Bearer ")) {
            return bearerToken.substring(7);
        }
        return null;
    }

    private List<String> getRoles(Authentication auth) {
        return auth.getAuthorities().stream()
            .map(GrantedAuthority::getAuthority)
            .collect(Collectors.toList());
    }

    @Override
    public int getOrder() {
        return -1;
    }
}
```

### 7.2 æœåŠ¡é—´è®¤è¯æ¨¡å¼

ç¡®ä¿æœåŠ¡é—´é€šä¿¡å®‰å…¨ï¼ŒéªŒè¯æœåŠ¡èº«ä»½ã€‚

**Spring Cloudç¤ºä¾‹**ï¼š
```java
@Configuration
@EnableResourceServer
public class ResourceServerConfig extends ResourceServerConfigurerAdapter {
    @Override
    public void configure(HttpSecurity http) throws Exception {
        http
            .authorizeRequests()
            .antMatchers("/api/public/**").permitAll()
            .antMatchers("/api/**").access("#oauth2.hasScope('service')")
            .and()
            .cors()
            .and()
            .csrf().disable();
    }
}

// æœåŠ¡é—´è°ƒç”¨é…ç½®
@Configuration
public class ServiceToServiceConfig {
    @Bean
    public OAuth2RestTemplate oauth2RestTemplate(OAuth2ClientContext context) {
        ClientCredentialsResourceDetails details = new ClientCredentialsResourceDetails();
        details.setClientId("service-client");
        details.setClientSecret("client-secret");
        details.setAccessTokenUri("https://auth-server/oauth/token");
        details.setScope(Arrays.asList("service"));

        return new OAuth2RestTemplate(details, context);
    }
}
```

---

## 8. ç»„åˆä¸é›†æˆæ¨¡å¼

### 8.1 èšåˆå™¨æ¨¡å¼

èšåˆå¤šä¸ªæœåŠ¡çš„å“åº”ï¼Œå½¢æˆç»Ÿä¸€ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚

**å®ç°ç¤ºä¾‹**ï¼š
```java
@RestController
@RequestMapping("/product-details")
public class ProductDetailController {
    private final ProductService productService;
    private final InventoryService inventoryService;
    private final ReviewService reviewService;

    public ProductDetailController(ProductService productService,
                                  InventoryService inventoryService,
                                  ReviewService reviewService) {
        this.productService = productService;
        this.inventoryService = inventoryService;
        this.reviewService = reviewService;
    }

    @GetMapping("/{productId}")
    public Mono<ProductDetailDTO> getProductDetail(@PathVariable String productId) {
        // å¹¶è¡Œè°ƒç”¨å¤šä¸ªæœåŠ¡
        Mono<ProductInfo> productInfo = productService.getProductInfo(productId);
        Mono<InventoryStatus> inventoryStatus = inventoryService.getInventoryStatus(productId);
        Mono<List<Review>> reviews = reviewService.getReviewsForProduct(productId);

        // èšåˆç»“æœ
        return Mono.zip(productInfo, inventoryStatus, reviews)
            .map(tuple -> {
                ProductInfo info = tuple.getT1();
                InventoryStatus status = tuple.getT2();
                List<Review> rs = tuple.getT3();

                return new ProductDetailDTO(
                    info.getId(),
                    info.getName(),
                    info.getDescription(),
                    info.getPrice(),
                    status.isInStock(),
                    status.getAvailableQuantity(),
                    rs,
                    calculateRating(rs)
                );
            });
    }

    private double calculateRating(List<Review> reviews) {
        if (reviews.isEmpty()) return 0;
        return reviews.stream()
            .mapToInt(Review::getRating)
            .average()
            .orElse(0);
    }
}
```

### 8.2 BFFæ¨¡å¼ï¼ˆBackend for Frontendï¼‰

ä¸ºä¸åŒå®¢æˆ·ç«¯åˆ›å»ºä¸“ç”¨åç«¯æœåŠ¡ï¼Œä¼˜åŒ–å®¢æˆ·ç«¯æ•°æ®éœ€æ±‚ã€‚

**å®ç°ç¤ºä¾‹**ï¼š
```java
@RestController
@RequestMapping("/bff/mobile")
public class MobileBFFController {
    private final OrderService orderService;
    private final ProductService productService;
    private final UserService userService;

    // æ„é€ å‡½æ•°æ³¨å…¥...

    @GetMapping("/dashboard")
    public Mono<MobileDashboardDTO> getMobileDashboard(@RequestParam String userId) {
        // ä¸ºç§»åŠ¨ç«¯èšåˆæ‰€éœ€æ•°æ®
        Mono<UserSummary> userSummary = userService.getUserSummary(userId);
        Mono<List<OrderSummary>> recentOrders = orderService.getRecentOrders(userId, 5);
        Mono<List<ProductRecommendation>> recommendations = productService.getRecommendations(userId, 10);

        return Mono.zip(userSummary, recentOrders, recommendations)
            .map(tuple -> new MobileDashboardDTO(
                tuple.getT1(),
                tuple.getT2(),
                tuple.getT3()
            ));
    }
}

@RestController
@RequestMapping("/bff/web")
public class WebBFFController {
    // ä¸ºWebç«¯æä¾›ä¸åŒçš„æ•°æ®èšåˆ
    @GetMapping("/dashboard")
    public Mono<WebDashboardDTO> getWebDashboard(@RequestParam String userId) {
        // Webç«¯éœ€è¦æ›´å¤šæ•°æ®å’Œä¸åŒæ ¼å¼
        // ...
    }
}
```

### 8.3 äº‹ä»¶é©±åŠ¨æ¨¡å¼

åŸºäºäº‹ä»¶çš„æ¾è€¦åˆé›†æˆï¼ŒæœåŠ¡é€šè¿‡å‘å¸ƒå’Œè®¢é˜…äº‹ä»¶è¿›è¡Œé€šä¿¡ã€‚

**å®ç°ç¤ºä¾‹**ï¼š
```java
// äº‹ä»¶å®šä¹‰
@Data
@AllArgsConstructor
@NoArgsConstructor
public class OrderCreatedEvent {
    private String eventId;
    private String orderId;
    private String userId;
    private List<OrderItem> items;
    private LocalDateTime createdAt;
}

// äº‹ä»¶å‘å¸ƒè€…
@Service
public class OrderEventPublisher {
    private final ApplicationEventPublisher applicationEventPublisher;
    private final KafkaTemplate<String, OrderCreatedEvent> kafkaTemplate;

    public OrderEventPublisher(ApplicationEventPublisher applicationEventPublisher,
                              KafkaTemplate<String, OrderCreatedEvent> kafkaTemplate) {
        this.applicationEventPublisher = applicationEventPublisher;
        this.kafkaTemplate = kafkaTemplate;
    }

    @Transactional
    public void publish(Order order) {
        OrderCreatedEvent event = new OrderCreatedEvent(
            UUID.randomUUID().toString(),
            order.getId(),
            order.getUserId(),
            order.getItems(),
            LocalDateTime.now()
        );

        // æœ¬åœ°äº‹ä»¶
        applicationEventPublisher.publishEvent(event);

        // è·¨æœåŠ¡äº‹ä»¶
        kafkaTemplate.send("order-events", order.getId(), event);
    }
}

// æœ¬åœ°äº‹ä»¶å¤„ç†
@Component
public class OrderCreatedEventListener {
    @EventListener
    public void handleOrderCreatedEvent(OrderCreatedEvent event) {
        // æœ¬åœ°å¤„ç†é€»è¾‘
        log.info("Order created: {}", event.getOrderId());
        // ...
    }
}

// è·¨æœåŠ¡äº‹ä»¶å¤„ç†ï¼ˆå¦ä¸€ä¸ªæœåŠ¡ä¸­ï¼‰
@Service
public class OrderEventConsumer {
    @KafkaListener(topics = "order-events")
    public void consumeOrderEvent(@Payload OrderCreatedEvent event, @Header(KafkaHeaders.RECEIVED_KEY) String orderId) {
        log.info("Received order created event: {}", event.getEventId());
        // å¤„ç†è®¢å•åˆ›å»ºäº‹ä»¶ï¼Œå¦‚æ›´æ–°åº“å­˜ã€åˆ›å»ºå‘è´§å•ç­‰
        // ...
    }
}
```

---

## 9. è®¾è®¡æ¨¡å¼å®æˆ˜æ¡ˆä¾‹

### 9.1 ç”µå•†è®¢å•å¤„ç†æµç¨‹

**åœºæ™¯**ï¼šç”¨æˆ·ä¸‹å•åï¼Œç³»ç»Ÿéœ€æ£€æŸ¥åº“å­˜ã€å¤„ç†æ”¯ä»˜ã€åˆ›å»ºç‰©æµå•ã€å‘é€é€šçŸ¥ç­‰ã€‚

**é‡‡ç”¨æ¨¡å¼**ï¼š
- **èšåˆå™¨æ¨¡å¼**ï¼šè®¢å•æœåŠ¡èšåˆå…¶ä»–æœåŠ¡å“åº”
- **å¼‚æ­¥é€šä¿¡æ¨¡å¼**ï¼šä½¿ç”¨äº‹ä»¶é©±åŠ¨å¤„ç†åç»­æµç¨‹
- **ç†”æ–­å™¨æ¨¡å¼**ï¼šé˜²æ­¢ä¾èµ–æœåŠ¡æ•…éšœå½±å“æ•´ä¸ªæµç¨‹
- **äº‹åŠ¡è¡¥å¿æ¨¡å¼**ï¼šå®ç°æœ€ç»ˆä¸€è‡´æ€§

**æ¶æ„å›¾**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  APIç½‘å…³    â”‚â”€â”€â”€â”€â–¶â”‚  è®¢å•æœåŠ¡   â”‚â”€â”€â”€â”€â–¶â”‚  åº“å­˜æœåŠ¡   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚                    â–²
                           â–¼                    â”‚
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚  æ”¯ä»˜æœåŠ¡   â”‚â”€â”€â”€â”€â–¶â”‚ åº“å­˜è¡¥å¿æœåŠ¡ â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚ äº‹ä»¶æ€»çº¿(Kafka)â—€â”€â”€â”€â”€â”‚ é€šçŸ¥æœåŠ¡   â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â–¼            â–¼           â–¼              â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ç‰©æµæœåŠ¡  â”‚ â”‚ç§¯åˆ†æœåŠ¡  â”‚ â”‚ç»Ÿè®¡æœåŠ¡  â”‚  â”‚åˆ†ææœåŠ¡  â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®ç°ä»£ç **ï¼š
```java
@Service
public class OrderProcessingService {
    private final OrderRepository orderRepository;
    private final InventoryService inventoryService;
    private final PaymentService paymentService;
    private final OrderEventPublisher eventPublisher;
    private final TransactionStatusRepository transactionStatusRepository;

    // æ„é€ å‡½æ•°æ³¨å…¥...

    @Transactional
    public OrderDTO processOrder(OrderRequest request) {
        // 1. åˆ›å»ºè®¢å•
        Order order = new Order();
        order.setUserId(request.getUserId());
        order.setItems(request.getItems());
        order.setTotalAmount(calculateTotal(request.getItems()));
        order.setStatus(OrderStatus.PENDING);
        order = orderRepository.save(order);

        // è®°å½•äº‹åŠ¡çŠ¶æ€
        String transactionId = UUID.randomUUID().toString();
        transactionStatusRepository.save(new TransactionStatus(
            transactionId, order.getId(), "ORDER_CREATED", LocalDateTime.now()));

        try {
            // 2. æ£€æŸ¥åº“å­˜
            InventoryCheckResult inventoryResult = inventoryService.checkAndReserveInventory(
                order.getId(), request.getItems());
            if (!inventoryResult.isSuccess()) {
                order.setStatus(OrderStatus.FAILED_INVENTORY);
                orderRepository.save(order);
                throw new InsufficientInventoryException(inventoryResult.getErrorMessage());
            }

            // 3. å¤„ç†æ”¯ä»˜
            PaymentResult paymentResult = paymentService.processPayment(
                new PaymentRequest(transactionId, order.getId(), order.getTotalAmount()));
            if (!paymentResult.isSuccess()) {
                // åº“å­˜è¡¥å¿
                inventoryService.releaseInventory(order.getId());
                order.setStatus(OrderStatus.FAILED_PAYMENT);
                orderRepository.save(order);
                throw new PaymentFailedException(paymentResult.getErrorMessage());
            }

            // 4. è®¢å•å®Œæˆ
            order.setStatus(OrderStatus.COMPLETED);
            order.setPaymentId(paymentResult.getPaymentId());
            orderRepository.save(order);

            // 5. å‘å¸ƒè®¢å•å®Œæˆäº‹ä»¶
            eventPublisher.publishOrderCompletedEvent(order);

            return OrderMapper.toDTO(order);
        } catch (Exception e) {
            // è®°å½•å¤±è´¥çŠ¶æ€
            transactionStatusRepository.save(new TransactionStatus(
                transactionId, order.getId(), "FAILED: " + e.getMessage(), LocalDateTime.now()));
            throw e;
        }
    }
}
```

---

## 10. æ¨¡å¼é€‰æ‹©ä¸æƒè¡¡

### 10.1 æ¨¡å¼é€‰æ‹©å†³ç­–æŒ‡å—

é€‰æ‹©å¾®æœåŠ¡è®¾è®¡æ¨¡å¼æ—¶ï¼Œåº”è€ƒè™‘ä»¥ä¸‹å› ç´ ï¼š

1. **ä¸šåŠ¡éœ€æ±‚**ï¼šåŠŸèƒ½éœ€æ±‚ã€æ€§èƒ½è¦æ±‚ã€å®‰å…¨è¦æ±‚
2. **å›¢é˜Ÿèƒ½åŠ›**ï¼šå¼€å‘ç»éªŒã€è¿ç»´èƒ½åŠ›ã€æŠ€æœ¯æ ˆç†Ÿæ‚‰åº¦
3. **ç³»ç»Ÿè§„æ¨¡**ï¼šæœåŠ¡æ•°é‡ã€æ•°æ®é‡ã€ç”¨æˆ·è§„æ¨¡
4. **éƒ¨ç½²ç¯å¢ƒ**ï¼šåŸºç¡€è®¾æ–½ã€äº‘å¹³å°ã€å®¹å™¨æ”¯æŒ
5. **è´¨é‡å±æ€§**ï¼šå¯ç”¨æ€§ã€å¯æ‰©å±•æ€§ã€å¯ç»´æŠ¤æ€§ã€å®‰å…¨æ€§

### 10.2 å¸¸è§æƒè¡¡

| å†³ç­–ç»´åº¦ | é€‰é¡¹A | é€‰é¡¹B | æƒè¡¡è€ƒè™‘ |
|---------|-------|-------|---------|
| **é€šä¿¡æ–¹å¼** | åŒæ­¥REST | å¼‚æ­¥æ¶ˆæ¯ | ç®€å•æ€§ vs å¯é æ€§ã€ä¸€è‡´æ€§ |
| **æ•°æ®ç®¡ç†** | å…±äº«æ•°æ®åº“ | æ•°æ®åº“æ¯æœåŠ¡ | å¼€å‘é€Ÿåº¦ vs æœåŠ¡è‡ªæ²» |
| **éƒ¨ç½²ç­–ç•¥** | å•ä½“éƒ¨ç½² | ç‹¬ç«‹éƒ¨ç½² | è¿ç»´å¤æ‚åº¦ vs æ‰©å±•çµæ´»æ€§ |
| **æ•…éšœå¤„ç†** | ç†”æ–­å™¨ | é‡è¯•æœºåˆ¶ | å“åº”é€Ÿåº¦ vs æˆåŠŸç‡ |
| **æœåŠ¡ç²’åº¦** | ç²—ç²’åº¦æœåŠ¡ | ç»†ç²’åº¦æœåŠ¡ | é€šä¿¡å¼€é”€ vs å¼€å‘çµæ´»æ€§ |

### 10.3 åæ¨¡å¼ä¸é™·é˜±

é¿å…ä»¥ä¸‹å¸¸è§çš„å¾®æœåŠ¡åæ¨¡å¼ï¼š

- **åˆ†å¸ƒå¼å•ä½“**ï¼šæœåŠ¡é—´ç´§è€¦åˆï¼Œéœ€ååŒéƒ¨ç½²
- **è¿‡åº¦æ‹†åˆ†**ï¼šæœåŠ¡è¿‡å¤šå¯¼è‡´å¤æ‚æ€§å¢åŠ 
- **åŒæ­¥è°ƒç”¨é“¾è¿‡é•¿**ï¼šå½¢æˆè„†å¼±çš„"è°ƒç”¨åœ°ç‹±"
- **å…±äº«æ•°æ®åº“**ï¼šç ´åæœåŠ¡è‡ªæ²»æ€§
- **ä¸­å¤®å¼äº‹åŠ¡ç®¡ç†**ï¼šéš¾ä»¥æ‰©å±•ä¸”æ˜“æˆä¸ºç“¶é¢ˆ
- **å¿½è§†é¢†åŸŸè¾¹ç•Œ**ï¼šæœåŠ¡åˆ’åˆ†ä¸ç¬¦åˆä¸šåŠ¡é¢†åŸŸ
- **"å¾®æœåŠ¡ä¸€åˆ‡"**ï¼šä¸è€ƒè™‘å®é™…éœ€æ±‚ç›²ç›®é‡‡ç”¨å¾®æœåŠ¡

### 10.4 æ¼”è¿›å¼æ¶æ„

å¾®æœåŠ¡æ¶æ„åº”éšä¸šåŠ¡å‘å±•è€Œæ¼”è¿›ï¼š

1. **ä»å°å¤„ç€æ‰‹**ï¼šä»æ ¸å¿ƒæœåŠ¡å¼€å§‹ï¼Œé€æ­¥æ‰©å±•
2. **æŒç»­è¯„ä¼°**ï¼šå®šæœŸå®¡æŸ¥æœåŠ¡è®¾è®¡å’Œè¾¹ç•Œ
3. **å¢é‡é‡æ„**ï¼šæ ¹æ®ä¸šåŠ¡å˜åŒ–è°ƒæ•´æœåŠ¡åˆ’åˆ†
4. **å®éªŒéªŒè¯**ï¼šå°è¯•ä¸åŒæ¨¡å¼å¹¶æµ‹é‡æ•ˆæœ
5. **æ–‡æ¡£æ›´æ–°**ï¼šä¿æŒæ¶æ„å†³ç­–å’Œæ¨¡å¼åº”ç”¨çš„æ–‡æ¡£åŒæ­¥

---

## ğŸ“š å‚è€ƒèµ„æº

- ã€Šå¾®æœåŠ¡æ¶æ„è®¾è®¡æ¨¡å¼ã€‹- Chris Richardson
- ã€Šé¢†åŸŸé©±åŠ¨è®¾è®¡ã€‹- Eric Evans
- ã€Šä¼ä¸šé›†æˆæ¨¡å¼ã€‹- Gregor Hohpe
- ã€Šè®¾è®¡æ•°æ®å¯†é›†å‹åº”ç”¨ã€‹- Martin Kleppmann
- Spring Cloud å®˜æ–¹æ–‡æ¡£
- Kubernetes å®˜æ–¹æ–‡æ¡£
- Netflix OSS æ–‡æ¡£