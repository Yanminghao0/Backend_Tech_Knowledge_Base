# æœåŠ¡ç½‘æ ¼å®æˆ˜

> æ„å»ºç°ä»£åŒ–å¾®æœåŠ¡é€šä¿¡ä¸æ²»ç†å¹³å°

## ğŸ“‹ ç›®å½•

1. [æœåŠ¡ç½‘æ ¼æ¦‚è¿°](#1-æœåŠ¡ç½‘æ ¼æ¦‚è¿°)
2. [ä¸»æµæœåŠ¡ç½‘æ ¼å¯¹æ¯”](#2-ä¸»æµæœåŠ¡ç½‘æ ¼å¯¹æ¯”)
3. [Istioæ ¸å¿ƒç»„ä»¶ä¸æ¶æ„](#3-istioæ ¸å¿ƒç»„ä»¶ä¸æ¶æ„)
4. [Istioå®‰è£…ä¸éƒ¨ç½²](#4-istioå®‰è£…ä¸éƒ¨ç½²)
5. [æµé‡ç®¡ç†å®æˆ˜](#5-æµé‡ç®¡ç†å®æˆ˜)
6. [å®‰å…¨é€šä¿¡é…ç½®](#6-å®‰å…¨é€šä¿¡é…ç½®)
7. [å¯è§‚æµ‹æ€§å®ç°](#7-å¯è§‚æµ‹æ€§å®ç°)
8. [ç­–ç•¥æ‰§è¡Œä¸æ§åˆ¶](#8-ç­–ç•¥æ‰§è¡Œä¸æ§åˆ¶)
9. [æœåŠ¡ç½‘æ ¼è¿ç»´å®è·µ](#9-æœåŠ¡ç½‘æ ¼è¿ç»´å®è·µ)
10. [ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ](#10-ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ)
11. [æœåŠ¡ç½‘æ ¼è¿ç§»ç­–ç•¥](#11-æœåŠ¡ç½‘æ ¼è¿ç§»ç­–ç•¥)
12. [æ¡ˆä¾‹åˆ†æä¸é—®é¢˜æ’æŸ¥](#12-æ¡ˆä¾‹åˆ†æä¸é—®é¢˜æ’æŸ¥)

---

## 1. æœåŠ¡ç½‘æ ¼æ¦‚è¿°

### 1.1 æœåŠ¡ç½‘æ ¼å®šä¹‰ä¸ä»·å€¼

æœåŠ¡ç½‘æ ¼(Service Mesh)æ˜¯ä¸€ä¸ªä¸“é—¨å¤„ç†æœåŠ¡é—´é€šä¿¡çš„åŸºç¡€è®¾æ–½å±‚ï¼Œå®ƒé€šè¿‡åœ¨æœåŠ¡æ—è¾¹éƒ¨ç½²è½»é‡çº§çš„ç½‘ç»œä»£ç†ï¼ˆç§°ä¸ºSidecarï¼‰ï¼Œé€æ˜åœ°å¤„ç†æœåŠ¡é—´é€šä¿¡ï¼Œä»è€Œè§£æ”¾å¼€å‘äººå‘˜ï¼Œè®©ä»–ä»¬ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘è€Œéåˆ†å¸ƒå¼ç³»ç»Ÿçš„å¤æ‚æ€§ã€‚

![æœåŠ¡ç½‘æ ¼æ¶æ„å›¾](https://i.imgur.com/service_mesh_architecture.png)

**æ ¸å¿ƒä»·å€¼**ï¼š
- **æµé‡ç®¡ç†**ï¼šç²¾ç»†æ§åˆ¶æœåŠ¡é—´æµé‡
- **å®‰å…¨é€šä¿¡**ï¼šè‡ªåŠ¨åŠ å¯†æœåŠ¡é—´é€šä¿¡ï¼Œæä¾›è®¤è¯æˆæƒ
- **å¯è§‚æµ‹æ€§**ï¼šæä¾›ä¸°å¯Œçš„ç›‘æ§æŒ‡æ ‡ã€åˆ†å¸ƒå¼è¿½è¸ªå’Œæ—¥å¿—
- **ç­–ç•¥æ‰§è¡Œ**ï¼šç»Ÿä¸€å®æ–½è®¿é—®æ§åˆ¶ã€é™æµã€ç†”æ–­ç­‰ç­–ç•¥
- **ç®€åŒ–å¼€å‘**ï¼šå°†åˆ†å¸ƒå¼ç³»ç»Ÿå…³æ³¨ç‚¹ä»ä¸šåŠ¡ä»£ç ä¸­å‰¥ç¦»

### 1.2 æœåŠ¡ç½‘æ ¼è§£å†³çš„æ ¸å¿ƒé—®é¢˜

| æŒ‘æˆ˜ | æœåŠ¡ç½‘æ ¼è§£å†³æ–¹æ¡ˆ |
|------|----------------|
| æœåŠ¡é—´é€šä¿¡å¤æ‚æ€§ | é€æ˜ä»£ç†ï¼Œç»Ÿä¸€æµé‡ç®¡ç† |
| æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡ | å†…ç½®æœåŠ¡å‘ç°ï¼Œæ™ºèƒ½è´Ÿè½½å‡è¡¡ |
| å¯é æ€§ä¿éšœ | è¶…æ—¶ã€é‡è¯•ã€ç†”æ–­ã€èˆ±å£ |
| å®‰å…¨é€šä¿¡ | mTLSåŠ å¯†ï¼Œç»†ç²’åº¦è®¿é—®æ§åˆ¶ |
| å¯è§‚æµ‹æ€§ | åˆ†å¸ƒå¼è¿½è¸ªï¼ŒæŒ‡æ ‡æ”¶é›†ï¼Œæ—¥å¿—èšåˆ |
| ç°åº¦å‘å¸ƒä¸æµé‡æ§åˆ¶ | æµé‡é•œåƒï¼ŒA/Bæµ‹è¯•ï¼Œé‡‘ä¸é›€å‘å¸ƒ |
| ç­–ç•¥æ‰§è¡Œ | ç»Ÿä¸€ç­–ç•¥å¼•æ“ï¼ŒåŠ¨æ€é…ç½® |

### 1.3 æœåŠ¡ç½‘æ ¼é€‚ç”¨åœºæ™¯

- **å¤§å‹å¾®æœåŠ¡æ¶æ„**ï¼šæœåŠ¡æ•°é‡å¤šï¼ˆ>50ï¼‰ï¼ŒæŠ€æœ¯æ ˆå¤šæ ·åŒ–
- **å¤æ‚æµé‡æ§åˆ¶éœ€æ±‚**ï¼šéœ€è¦ç²¾ç»†åŒ–çš„æµé‡è·¯ç”±ã€ç°åº¦å‘å¸ƒ
- **ä¸¥æ ¼çš„å®‰å…¨åˆè§„è¦æ±‚**ï¼šéœ€è¦ç«¯åˆ°ç«¯åŠ å¯†ã€ç»†ç²’åº¦æˆæƒ
- **é«˜å¯é æ€§è¦æ±‚**ï¼šéœ€è¦å®Œå–„çš„æ•…éšœæ¢å¤æœºåˆ¶
- **å¤šå›¢é˜Ÿåä½œ**ï¼šéœ€è¦ç»Ÿä¸€çš„é€šä¿¡æ ‡å‡†å’Œç­–ç•¥
- **å¤šäº‘/æ··åˆäº‘ç¯å¢ƒ**ï¼šè·¨ç¯å¢ƒæœåŠ¡é€šä¿¡

---

## 2. ä¸»æµæœåŠ¡ç½‘æ ¼å¯¹æ¯”

### 2.1 åŠŸèƒ½å¯¹æ¯”

| ç‰¹æ€§ | Istio | Linkerd | Consul Connect | Traefik Mesh |
|------|-------|---------|----------------|--------------|
| æµé‡ç®¡ç† | â˜…â˜…â˜…â˜…â˜… | â˜…â˜…â˜…â˜…â˜† | â˜…â˜…â˜…â˜†â˜† | â˜…â˜…â˜…â˜†â˜† |
| å®‰å…¨ç‰¹æ€§ | â˜…â˜…â˜…â˜…â˜… | â˜…â˜…â˜…â˜…â˜† | â˜…â˜…â˜…â˜…â˜† | â˜…â˜…â˜…â˜†â˜† |
| å¯è§‚æµ‹æ€§ | â˜…â˜…â˜…â˜…â˜… | â˜…â˜…â˜…â˜…â˜… | â˜…â˜…â˜…â˜†â˜† | â˜…â˜…â˜…â˜…â˜† |
| æ˜“ç”¨æ€§ | â˜…â˜…â˜…â˜†â˜† | â˜…â˜…â˜…â˜…â˜… | â˜…â˜…â˜…â˜…â˜† | â˜…â˜…â˜…â˜…â˜† |
| æ€§èƒ½å¼€é”€ | â˜…â˜…â˜…â˜†â˜† | â˜…â˜…â˜…â˜…â˜… | â˜…â˜…â˜…â˜…â˜† | â˜…â˜…â˜…â˜…â˜† |
| ç”Ÿæ€ç³»ç»Ÿ | â˜…â˜…â˜…â˜…â˜… | â˜…â˜…â˜…â˜†â˜† | â˜…â˜…â˜…â˜…â˜† | â˜…â˜…â˜…â˜†â˜† |
| ç¤¾åŒºæ´»è·ƒåº¦ | â˜…â˜…â˜…â˜…â˜… | â˜…â˜…â˜…â˜…â˜† | â˜…â˜…â˜…â˜…â˜† | â˜…â˜…â˜…â˜†â˜† |
| ä¼ä¸šæ”¯æŒ | â˜…â˜…â˜…â˜…â˜… | â˜…â˜…â˜…â˜…â˜† | â˜…â˜…â˜…â˜…â˜† | â˜…â˜…â˜…â˜†â˜† |

### 2.2 æ¶æ„å¯¹æ¯”

**Istioæ¶æ„**ï¼š
- æ•°æ®å¹³é¢ï¼šEnvoyä»£ç†
- æ§åˆ¶å¹³é¢ï¼šIstiodï¼ˆæ•´åˆPilotã€Citadelã€Galleyç­‰ç»„ä»¶ï¼‰
- é‡‡ç”¨xDSåè®®æ—è¿›è¡Œé…ç½®åˆ†å‘
- æ”¯æŒä¸°å¯Œçš„æµé‡ç®¡ç†åŠŸèƒ½

**Linkerdæ¶æ„**ï¼š
- æ•°æ®å¹³é¢ï¼šè½»é‡çº§ä¸“ç”¨ä»£ç†ï¼ˆåŸºäºNettyï¼‰
- æ§åˆ¶å¹³é¢ï¼šå¤šä¸ªå¾®æœåŠ¡ç»„ä»¶
- ä¸“æ³¨äºç®€å•æ€§å’Œæ€§èƒ½
- å†…ç½®å¯è§‚æµ‹æ€§åŠŸèƒ½

**Consul Connectæ¶æ„**ï¼š
- åŸºäºConsulæœåŠ¡å‘ç°
- æ•°æ®å¹³é¢ï¼šEnvoyæˆ–å†…ç½®ä»£ç†
- æ§åˆ¶å¹³é¢ï¼šConsulæœåŠ¡å™¨
- ä¸HashiCorpå·¥å…·é“¾é›†æˆè‰¯å¥½

### 2.3 é€‰å‹å»ºè®®

| åœºæ™¯ | æ¨èæ–¹æ¡ˆ | ç†ç”± |
|------|---------|------|
| å¤§å‹ä¼ä¸šçº§åº”ç”¨ | Istio | åŠŸèƒ½å…¨é¢ï¼Œç”Ÿæ€å®Œå–„ï¼Œç¤¾åŒºæ´»è·ƒ |
| å¯¹æ€§èƒ½æ•æ„Ÿçš„ç³»ç»Ÿ | Linkerd | æ€§èƒ½å¼€é”€ä½ï¼Œèµ„æºå ç”¨å°‘ |
| å·²æœ‰HashiCorpå·¥å…·é“¾ | Consul Connect | é›†æˆåº¦é«˜ï¼Œç®¡ç†ç»Ÿä¸€ |
| KubernetesåŸç”Ÿç¯å¢ƒ | Istio/Linkerd | ä¸K8sæ·±åº¦é›†æˆï¼Œæ“ä½œå‹å¥½ |
| ä¸­å°è§„æ¨¡å¾®æœåŠ¡ | Linkerd/Consul Connect | éƒ¨ç½²ç®€å•ï¼Œæ˜“äºç»´æŠ¤ |
| å¤šé›†ç¾¤/å¤šäº‘ç¯å¢ƒ | Istio | è·¨é›†ç¾¤èƒ½åŠ›å¼ºï¼Œé…ç½®çµæ´» |

---

## 3. Istioæ ¸å¿ƒç»„ä»¶ä¸æ¶æ„

### 3.1 Istioæ¶æ„ overview

![Istioæ¶æ„å›¾](https://i.imgur.com/istio_architecture.png)

Istioæ¶æ„åˆ†ä¸ºæ•°æ®å¹³é¢å’Œæ§åˆ¶å¹³é¢ï¼š
- **æ•°æ®å¹³é¢**ï¼šç”±Envoyä»£ç†ç»„æˆï¼Œéƒ¨ç½²ä¸ºSidecarï¼Œå¤„ç†å’Œè½¬å‘æœåŠ¡é—´æµé‡
- **æ§åˆ¶å¹³é¢**ï¼šç®¡ç†å’Œé…ç½®ä»£ç†ï¼Œå®ç°æµé‡æ§åˆ¶ã€å®‰å…¨ç­–ç•¥ç­‰

### 3.2 æ ¸å¿ƒç»„ä»¶è¯¦è§£

**Istiod**ï¼š
- æ•´åˆäº†å¤šä¸ªæ§åˆ¶å¹³é¢ç»„ä»¶
- æä¾›æœåŠ¡å‘ç°ã€é…ç½®ç®¡ç†å’Œè¯ä¹¦ç®¡ç†
- è´Ÿè´£å°†é…ç½®åˆ†å‘åˆ°Envoyä»£ç†

**Envoyä»£ç†**ï¼š
- é«˜æ€§èƒ½L7ä»£ç†å’Œé€šä¿¡æ€»çº¿
- æœåŠ¡å‘ç°ã€è´Ÿè½½å‡è¡¡ã€TLSç»ˆæ­¢
- æµé‡è·¯ç”±ã€æ•…éšœæ³¨å…¥ã€æŒ‡æ ‡æ”¶é›†
- æ”¯æŒåŠ¨æ€é…ç½®æ›´æ–°

**Pilot**ï¼š
- æœåŠ¡å‘ç°å’Œæµé‡ç®¡ç†
- ä¸ºEnvoyæä¾›è·¯ç”±é…ç½®
- æ”¯æŒA/Bæµ‹è¯•ã€é‡‘ä¸é›€å‘å¸ƒ

**Citadel**ï¼š
- è¯ä¹¦ç®¡ç†å’Œèº«ä»½è®¤è¯
- è‡ªåŠ¨ç”Ÿæˆå’Œè½®æ¢TLSè¯ä¹¦
- å®ç°æœåŠ¡é—´åŒå‘TLS

**Galley**ï¼š
- é…ç½®éªŒè¯å’Œå¤„ç†
- ç¡®ä¿é…ç½®çš„æ­£ç¡®æ€§å’Œä¸€è‡´æ€§
- æ”¯æŒå¤šç§é…ç½®æ ¼å¼

### 3.3 Envoyä»£ç†æ ¸å¿ƒåŠŸèƒ½

- **HTTP/HTTPSä»£ç†**ï¼šæ”¯æŒHTTP/1.1ã€HTTP/2ã€gRPC
- **TCPä»£ç†**ï¼šæ”¯æŒåŸå§‹TCPæµé‡è½¬å‘
- **æœåŠ¡å‘ç°**ï¼šåŠ¨æ€å‘ç°æœåŠ¡å®ä¾‹
- **è´Ÿè½½å‡è¡¡**ï¼šå¤šç§è´Ÿè½½å‡è¡¡ç®—æ³•
- **å¥åº·æ£€æŸ¥**ï¼šä¸»åŠ¨/è¢«åŠ¨å¥åº·æ£€æŸ¥
- **TLSç»ˆæ­¢**ï¼šå…¥ç«™/å‡ºç«™TLSç»ˆæ­¢
- **æµé‡æ§åˆ¶**ï¼šè·¯ç”±ã€é‡å®šå‘ã€é‡è¯•ã€è¶…æ—¶
- **æ•…éšœæ³¨å…¥**ï¼šå»¶è¿Ÿã€ä¸­æ–­æ³¨å…¥
- **æŒ‡æ ‡æ”¶é›†**ï¼šå†…ç½®PrometheusæŒ‡æ ‡
- **åˆ†å¸ƒå¼è¿½è¸ª**ï¼šæ”¯æŒJaegerã€Zipkin

---

## 4. Istioå®‰è£…ä¸éƒ¨ç½²

### 4.1 ç¯å¢ƒå‡†å¤‡

**ç¡¬ä»¶è¦æ±‚**ï¼š
- æ§åˆ¶å¹³é¢ï¼š2 CPUæ ¸å¿ƒï¼Œ4GBå†…å­˜
- æ•°æ®å¹³é¢ï¼šæ¯ä¸ªèŠ‚ç‚¹1 CPUæ ¸å¿ƒï¼Œ2GBå†…å­˜
- æŒä¹…åŒ–å­˜å‚¨ï¼šæ§åˆ¶å¹³é¢éœ€è¦10GB+å­˜å‚¨ç©ºé—´

**è½¯ä»¶è¦æ±‚**ï¼š
- Kubernetesé›†ç¾¤ï¼š1.21+ç‰ˆæœ¬
- kubectlå‘½ä»¤è¡Œå·¥å…·
- Helm 3.xï¼ˆå¯é€‰ï¼‰
- å®¹å™¨è¿è¡Œæ—¶ï¼šDockerã€containerdç­‰

### 4.2 ä½¿ç”¨Istioctlå®‰è£…

```bash
# ä¸‹è½½Istio
curl -L https://istio.io/downloadIstio | sh -
cd istio-1.16.0
 export PATH=$PWD/bin:$PATH

# æŸ¥çœ‹å¯ç”¨çš„å®‰è£…é…ç½®æ–‡ä»¶
istioctl profile list

# ä½¿ç”¨demoé…ç½®æ–‡ä»¶å®‰è£…ï¼ˆé€‚åˆæµ‹è¯•å’Œæ¼”ç¤ºï¼‰
istioctl install --set profile=demo -y

# éªŒè¯å®‰è£…
istioctl verify-install

# æŸ¥çœ‹Istioç»„ä»¶
kubectl get pods -n istio-system
```

### 4.3 ä½¿ç”¨Helmå®‰è£…

```bash
# æ·»åŠ Istio Helmä»“åº“
helm repo add istio https://istio-release.storage.googleapis.com/charts
helm repo update

# åˆ›å»ºå‘½åç©ºé—´
kubectl create namespace istio-system

# å®‰è£…åŸºç¡€ç»„ä»¶
helm install istio-base istio/base -n istio-system --set defaultRevision=default

# å®‰è£… istiod
helm install istiod istio/istiod -n istio-system --wait

# å®‰è£…Ingress Gateway
helm install istio-ingressgateway istio/gateway -n istio-system --wait

# éªŒè¯å®‰è£…
kubectl get pods -n istio-system
```

### 4.4 å¯ç”¨Sidecaræ³¨å…¥

**è‡ªåŠ¨æ³¨å…¥**ï¼š
```bash
# ä¸ºå‘½åç©ºé—´å¯ç”¨è‡ªåŠ¨æ³¨å…¥
kubectl label namespace default istio-injection=enabled --overwrite

# éªŒè¯æ ‡ç­¾
kubectl get namespace -L istio-injection
```

**æ‰‹åŠ¨æ³¨å…¥**ï¼š
```bash
# ä½¿ç”¨istioctlæ‰‹åŠ¨æ³¨å…¥Sidecar
istioctl kube-inject -f deployment.yaml | kubectl apply -f -
```

### 4.5 å®‰è£…éªŒè¯

```bash
# æ£€æŸ¥IstioçŠ¶æ€
istioctl ps

# æ£€æŸ¥Istioé…ç½®
istioctl config dump

# æŸ¥çœ‹Istioæ§åˆ¶é¢æ¿æ—¥å¿—
kubectl logs -n istio-system -l app=istiod -f

# æŸ¥çœ‹æ•°æ®å¹³é¢ä»£ç†æ—¥å¿—
kubectl logs -l app=your-app -c istio-proxy -f
```

---

## 5. æµé‡ç®¡ç†å®æˆ˜

### 5.1 è™šæ‹ŸæœåŠ¡(Virtual Service)

**åŸºæœ¬æ¦‚å¿µ**ï¼š
- å®šä¹‰æµé‡è·¯ç”±è§„åˆ™
- å°†æµé‡æ˜ å°„åˆ°ç›®æ ‡æœåŠ¡
- æ”¯æŒåŸºäºå¤šç§æ¡ä»¶çš„è·¯ç”±
- å¯é…ç½®é‡è¯•ã€è¶…æ—¶ç­‰ç­–ç•¥

**ç¤ºä¾‹ï¼šåŸºæœ¬è·¯ç”±**
```yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: order-service
  namespace: default
spec:
  hosts:
  - order-service
  http:
  - route:
    - destination:
        host: order-service
        subset: v1
```

**ç¤ºä¾‹ï¼šåŸºäºæƒé‡çš„è·¯ç”±ï¼ˆé‡‘ä¸é›€å‘å¸ƒï¼‰**
```yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: order-service
  namespace: default
spec:
  hosts:
  - order-service
  http:
  - route:
    - destination:
        host: order-service
        subset: v1
      weight: 90
    - destination:
        host: order-service
        subset: v2
      weight: 10
---
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: order-service
  namespace: default
spec:
  host: order-service
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
```

**ç¤ºä¾‹ï¼šåŸºäºè¯·æ±‚å¤´çš„è·¯ç”±ï¼ˆA/Bæµ‹è¯•ï¼‰**
```yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: order-service
  namespace: default
spec:
  hosts:
  - order-service
  http:
  - match:
    - headers:
        user-agent:
          regex: ".*Chrome.*"
      route:
      - destination:
          host: order-service
          subset: v2
  - route:
    - destination:
        host: order-service
        subset: v1
```

### 5.2 ç›®æ ‡è§„åˆ™(Destination Rule)

**åŸºæœ¬æ¦‚å¿µ**ï¼š
- å®šä¹‰æœåŠ¡çš„è®¿é—®ç­–ç•¥
- é…ç½®è´Ÿè½½å‡è¡¡ç­–ç•¥
- è®¾ç½®TLSç­–ç•¥
- é…ç½®ç†”æ–­ã€å¥åº·æ£€æŸ¥

**ç¤ºä¾‹ï¼šé…ç½®è´Ÿè½½å‡è¡¡å’Œè¿æ¥æ± **
```yaml
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: payment-service
  namespace: default
spec:
  host: payment-service
  trafficPolicy:
    loadBalancer:
      simple: ROUND_ROBIN
    connectionPool:
      tcp:
        maxConnections: 100
      http:
        http1MaxPendingRequests: 100
        maxRequestsPerConnection: 10
    outlierDetection:
      consecutiveErrors: 5
      interval: 30s
      baseEjectionTime: 30s
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
```

### 5.3 ç½‘å…³(Gateway)

**ç¤ºä¾‹ï¼šé…ç½®Ingress Gateway**
```yaml
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: http-gateway
  namespace: istio-system
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "*"
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: webapp-gateway
  namespace: default
spec:
  hosts:
  - "example.com"
  gateways:
  - http-gateway.istio-system.svc.cluster.local
  http:
  - route:
    - destination:
        host: webapp-service
        port:
          number: 80
```

### 5.4 æµé‡é•œåƒ

**ç¤ºä¾‹ï¼šé…ç½®æµé‡é•œåƒ**
```yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: product-service
  namespace: default
spec:
  hosts:
  - product-service
  http:
  - route:
    - destination:
        host: product-service
        subset: v1
      weight: 100
    mirror:
      host: product-service
      subset: v2
    mirrorPercentage:
      value: 10.0
```

### 5.5 æ•…éšœæ³¨å…¥

**ç¤ºä¾‹ï¼šæ³¨å…¥å»¶è¿Ÿæ•…éšœ**
```yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: inventory-service
  namespace: default
spec:
  hosts:
  - inventory-service
  http:
  - match:
    - headers:
        user-agent:
          regex: ".*Firefox.*"
    fault:
      delay:
        percentage:
          value: 50
        fixedDelay: 2s
    route:
    - destination:
        host: inventory-service
        subset: v1
  - route:
    - destination:
        host: inventory-service
        subset: v1
```

**ç¤ºä¾‹ï¼šæ³¨å…¥ä¸­æ–­æ•…éšœ**
```yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: recommendation-service
  namespace: default
spec:
  hosts:
  - recommendation-service
  http:
  - fault:
      abort:
        percentage:
          value: 10
        httpStatus: 503
    route:
    - destination:
        host: recommendation-service
        subset: v1
```

---

## 6. å®‰å…¨é€šä¿¡é…ç½®

### 6.1 åŒå‘TLSé…ç½®

**å…¨å±€å¯ç”¨mTLS**ï¼š
```yaml
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: default
  namespace: istio-system
spec:
  mtls:
    mode: STRICT
```

**å‘½åç©ºé—´çº§åˆ«é…ç½®**ï¼š
```yaml
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: default
  namespace: default
spec:
  mtls:
    mode: STRICT
```

**æœåŠ¡çº§åˆ«é…ç½®**ï¼š
```yaml
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: payment-service
  namespace: default
spec:
  selector:
    matchLabels:
      app: payment-service
  mtls:
    mode: STRICT
```

### 6.2 è®¤è¯ç­–ç•¥

**è¯·æ±‚è®¤è¯**ï¼š
```yaml
apiVersion: security.istio.io/v1beta1
kind: RequestAuthentication
metadata:
  name: jwt-auth
  namespace: default
spec:
  selector:
    matchLabels:
      app: order-service
  jwtRules:
  - issuer: "https://auth.example.com"
    jwksUri: "https://auth.example.com/.well-known/jwks.json"
    fromHeaders:
    - name: Authorization
      prefix: "Bearer "
    audiences:
    - "order-service"
```

### 6.3 æˆæƒç­–ç•¥

**å…è®¸æ‰€æœ‰è¯·æ±‚**ï¼š
```yaml
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: allow-all
  namespace: default
spec:
  action: ALLOW
  rules:
  - {}  # ç©ºè§„åˆ™åŒ¹é…æ‰€æœ‰è¯·æ±‚
```

**åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶**ï¼š
```yaml
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: order-service-policy
  namespace: default
spec:
  selector:
    matchLabels:
      app: order-service
  action: ALLOW
  rules:
  - from:
    - source:
        principals:
        - "cluster.local/ns/default/sa/webapp"
    to:
    - operation:
        methods:
        - GET
        paths:
        - "/api/orders/*"
  - from:
    - source:
        principals:
        - "cluster.local/ns/default/sa/admin"
    to:
    - operation:
        methods:
        - GET
        - POST
        - PUT
        - DELETE
        paths:
        - "/api/orders/*"
```

### 6.4 è¯ä¹¦ç®¡ç†

**è‡ªå®šä¹‰CAé…ç½®**ï¼š
```yaml
# åœ¨Istioå®‰è£…æ—¶é…ç½®è‡ªå®šä¹‰CA
istioctl install --set values.global.mtls.enabled=true \
  --set values.global.certificatesé¢æœºæ„=custom \
  --set values.global.customCA.enabled=true
```

**è¯ä¹¦è½®æ¢ç›‘æ§**ï¼š
```bash
# æ£€æŸ¥è¯ä¹¦è¿‡æœŸæ—¶é—´
istioctl proxy-config secret <pod-name> -n <namespace> --type=istio.io/key-and-cert
```

---

## 7. å¯è§‚æµ‹æ€§å®ç°

### 7.1 æŒ‡æ ‡æ”¶é›†

**å†…ç½®æŒ‡æ ‡**ï¼š
- æœåŠ¡æŒ‡æ ‡ï¼šè¯·æ±‚æ•°ã€å»¶è¿Ÿã€é”™è¯¯ç‡
- ç½‘æ ¼æŒ‡æ ‡ï¼šæœåŠ¡ä¾èµ–ã€æµé‡åˆ†å¸ƒ
- ä»£ç†æŒ‡æ ‡ï¼šCPUã€å†…å­˜ã€ç½‘ç»œä½¿ç”¨

**Prometheusä¸Grafanaéƒ¨ç½²**ï¼š
```bash
# å®‰è£…Prometheuså’ŒGrafana
kubectl apply -f samples/addons/prometheus.yaml
kubectl apply -f samples/addons/grafana.yaml

# ç«¯å£è½¬å‘è®¿é—®Grafana
kubectl -n istio-system port-forward svc/grafana 3000:3000
```

**å¸¸ç”¨ç›‘æ§é¢æ¿**ï¼š
- Istio Service Dashboard
- Istio Workload Dashboard
- Istio Mesh Dashboard
- Istio Performance Dashboard
- Istio Control Plane Dashboard

### 7.2 åˆ†å¸ƒå¼è¿½è¸ª

**Jaegeréƒ¨ç½²**ï¼š
```bash
# å®‰è£…Jaeger
kubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.16/samples/addons/jaeger.yaml

# ç«¯å£è½¬å‘è®¿é—®Jaeger UI
kubectl port-forward -n istio-system svc/jaeger-query 16686:16686
```

**è¿½è¸ªé…ç½®**ï¼š
```yaml
apiVersion: telemetry.istio.io/v1alpha1
kind: Telemetry
metadata:
  name: default
  namespace: istio-system
spec:
  tracing:
  - providers:
    - name: jaeger
    randomSamplingPercentage: 100.0
```

### 7.3 æ—¥å¿—æ”¶é›†

**é…ç½®è®¿é—®æ—¥å¿—**ï¼š
```yaml
apiVersion: telemetry.istio.io/v1alpha1
kind: Telemetry
metadata:
  name: default
  namespace: istio-system
spec:
  accessLogging:
  - providers:
    - name: envoy
```

**è‡ªå®šä¹‰æ—¥å¿—æ ¼å¼**ï¼š
```yaml
apiVersion: telemetry.istio.io/v1alpha1
kind: Telemetry
metadata:
  name: default
  namespace: istio-system
spec:
  accessLogging:
  - providers:
    - name: envoy
    match:
      mode: SERVER
    envoy:
      logFormat:
        json:
          application: "istio-proxy"
          request_method: "%REQ(:METHOD)%"
          request_path: "%REQ(X-ENVOY-ORIGINAL-PATH?:PATH)%"
          request_id: "%REQ(X-REQUEST-ID)%"
          response_code: "%RESPONSE_CODE%"
          response_flags: "%RESPONSE_FLAGS%"
          upstream_service_time: "%RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)%"
          duration: "%DURATION%"
          upstream_host: "%UPSTREAM_HOST%"
          user_agent: "%REQ(USER-AGENT)%"
          client_ip: "%REQ(X-FORWARDED-FOR)%"
```

### 7.4 å‘Šè­¦é…ç½®

**Prometheuså‘Šè­¦è§„åˆ™**ï¼š
```yaml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: istio-alerts
  namespace: istio-system
  labels:
    release: prometheus
spec:
  groups:
  - name: istio.rules
    rules:
    - alert: HighErrorRate
      expr: sum(rate(istio_requests_total{reporter=~"source|destination", response_code=~"5.."}[5m])) / sum(rate(istio_requests_total{reporter=~"source|destination"}[5m])) > 0.05
      for: 1m
      labels:
        severity: critical
      annotations:
        summary: "High error rate detected"
        description: "Error rate is {{ $value | humanizePercentage }} for the last 5 minutes"

    - alert: HighLatency
      expr: histogram_quantile(0.95, sum(rate(istio_request_duration_milliseconds_bucket[5m])) by (le, service)) > 500
      for: 1m
      labels:
        severity: warning
      annotations:
        summary: "High latency detected"
        description: "95th percentile latency is above 500ms for service {{ $labels.service }}"
```

---

## 8. ç­–ç•¥æ‰§è¡Œä¸æ§åˆ¶

### 8.1 é€Ÿç‡é™åˆ¶

**å…¨å±€é€Ÿç‡é™åˆ¶é…ç½®**ï¼š
```yaml
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: global-rate-limit
  namespace: istio-system
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  configPatches:
  - applyTo: HTTP_FILTER
    match:
      context: GATEWAY
      listener:
        filterChain:
          filter:
            name: "envoy.filters.network.http_connection_manager"
            subFilter:
              name: "envoy.filters.http.router"
    patch:
      operation: INSERT_BEFORE
      value:
        name: envoy.filters.http.local_ratelimit
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: type.googleapis.com/envoy.extensions.filters.http.local_ratelimit.v3.LocalRateLimit
          value:
            stat_prefix: http_local_rate_limiter
            token_bucket:
              max_tokens: 1000
              tokens_per_fill: 100
              fill_interval: 60s
            filter_enabled:
              runtime_key: local_rate_limit_enabled
              default_value:
                numerator: 100
                denominator: HUNDRED
            filter_enforced:
              runtime_key: local_rate_limit_enforced
              default_value:
                numerator: 100
                denominator: HUNDRED
            response_headers_to_add:
            - append: false
              key: x-local-rate-limit
              value: 'true'
```

### 8.2 è¯·æ±‚å¤§å°é™åˆ¶

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: request-size-limit
  namespace: default
spec:
  workloadSelector:
    labels:
      app: order-service
  configPatches:
  - applyTo: HTTP_FILTER
    match:
      context: SIDECAR_INBOUND
      listener:
        filterChain:
          filter:
            name: "envoy.filters.network.http_connection_manager"
            subFilter:
              name: "envoy.filters.http.router"
    patch:
      operation: INSERT_BEFORE
      value:
        name: envoy.filters.http.buffer
        typed_config:
          "@type": type.googleapis.com/udpa.type.v1.TypedStruct
          type_url: type.googleapis.com/envoy.extensions.filters.http.buffer.v3.Buffer
          value:
            max_request_bytes: 1048576  # 1MB
            max_request_time: 30s
```

### 8.3 å¤–éƒ¨æœåŠ¡è®¿é—®æ§åˆ¶

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: ServiceEntry
metadata:
  name: external-api
  namespace: default
spec:
  hosts:
  - api.external-service.com
  ports:
  - number: 443
    name: https
    protocol: HTTPS
  resolution: DNS
  location: MESH_EXTERNAL
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: external-api
  namespace: default
spec:
  hosts:
  - api.external-service.com
  tls:
  - match:
    - port: 443
      sniHosts:
      - api.external-service.com
    route:
    - destination:
        host: api.external-service.com
        port:
          number: 443
      weight: 100
---
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: external-api-policy
  namespace: default
spec:
  selector:
    matchLabels:
      app: order-service
  action: ALLOW
  rules:
  - to:
    - service:
        hosts:
        - api.external-service.com
```

---

## 9. æœåŠ¡ç½‘æ ¼è¿ç»´å®è·µ

### 9.1 æ—¥å¸¸è¿ç»´å‘½ä»¤

```bash
# æŸ¥çœ‹Istioé…ç½®
istioctl config dump

# æŸ¥çœ‹æœåŠ¡åˆ—è¡¨
istioctl proxy-status

# æŸ¥çœ‹æœåŠ¡è¯¦æƒ…
istioctl describe service order-service

# æŸ¥çœ‹Podçš„Istioé…ç½®
istioctl proxy-config all <pod-name> -n <namespace>

# æŸ¥çœ‹æµé‡ç»Ÿè®¡
istioctl experimental metrics service order-service.default.svc.cluster.local

# æ”¶é›†è¯Šæ–­ä¿¡æ¯
istioctl bug-report

# æ£€æŸ¥Istioé…ç½®
istioctl analyze
```

### 9.2 å‡çº§Istio

```bash
# ä¸‹è½½æ–°ç‰ˆæœ¬Istio
curl -L https://istio.io/downloadIstio | sh -
cd istio-<new-version>
 export PATH=$PWD/bin:$PATH

# æ£€æŸ¥å½“å‰é…ç½®
istioctl profile dump > current-config.yaml

# å‡çº§æ§åˆ¶å¹³é¢
istioctl upgrade -f current-config.yaml

# é‡å¯æ•°æ®å¹³é¢Pod
kubectl rollout restart deployment -n default

# éªŒè¯å‡çº§
istioctl version
```

### 9.3 ç›‘æ§æœåŠ¡ç½‘æ ¼

**å…³é”®ç›‘æ§æŒ‡æ ‡**ï¼š
- æ§åˆ¶å¹³é¢å¥åº·çŠ¶æ€
- æ•°æ®å¹³é¢ä»£ç†çŠ¶æ€
- æœåŠ¡ç½‘æ ¼æ€§èƒ½æŒ‡æ ‡
- æµé‡æŒ‡æ ‡ï¼ˆè¯·æ±‚é‡ã€å»¶è¿Ÿã€é”™è¯¯ç‡ï¼‰
- èµ„æºä½¿ç”¨æƒ…å†µ

**Grafanaç›‘æ§é¢æ¿**ï¼š
- Istio Mesh Dashboard
- Istio Service Dashboard
- Istio Workload Dashboard
- Istio Performance Dashboard
- Istio Control Plane Dashboard

### 9.4 æ•…éšœæ’æŸ¥æµç¨‹

1. **æ£€æŸ¥æ§åˆ¶å¹³é¢çŠ¶æ€**
   ```bash
   kubectl get pods -n istio-system
   kubectl logs -n istio-system -l app=istiod
   ```

2. **æ£€æŸ¥æ•°æ®å¹³é¢çŠ¶æ€**
   ```bash
   istioctl proxy-status
   kubectl logs <pod-name> -c istio-proxy
   ```

3. **æ£€æŸ¥ç½‘ç»œè¿æ¥**
   ```bash
   kubectl exec -it <pod-name> -c istio-proxy -- curl -v http://service-name:port
   ```

4. **æ£€æŸ¥Istioé…ç½®**
   ```bash
   istioctl analyze
   istioctl proxy-config routes <pod-name> -o json
   ```

5. **æ£€æŸ¥æŒ‡æ ‡å’Œè¿½è¸ª**
   - æŸ¥çœ‹PrometheusæŒ‡æ ‡
   - æ£€æŸ¥Jaegerè¿½è¸ª
   - åˆ†æGrafanaé¢æ¿

---

## 10. ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ

### 10.1 æ€§èƒ½ä¼˜åŒ–

**èµ„æºé…ç½®**ï¼š
```yaml
# Sidecarèµ„æºé…ç½®
apiVersion: networking.istio.io/v1alpha3
kind: Sidecar
metadata:
  name: default
  namespace: default
spec:
  egress:
  - hosts:
    - "default/*"
    - "istio-system/*"
---
# èµ„æºé™åˆ¶
apiVersion: v1
kind: LimitRange
metadata:
  name: istio-sidecar
  namespace: default
spec:
  limits:
  - default:
      cpu: 500m
      memory: 512Mi
    defaultRequest:
      cpu: 100m
      memory: 128Mi
    type: Container
    containerSelector:
      matchLabels:
        istio: sidecar
```

**æ€§èƒ½è°ƒä¼˜**ï¼š
- è°ƒæ•´è¿æ¥æ± å¤§å°
- ä¼˜åŒ–Envoyé…ç½®
- å¯ç”¨HTTP/2
- é…ç½®é€‚å½“çš„è¶…æ—¶å’Œé‡è¯•ç­–ç•¥
- å¯ç”¨å‹ç¼©
- åˆç†è®¾ç½®å¹¶å‘è¿æ¥æ•°

### 10.2 é«˜å¯ç”¨éƒ¨ç½²

**å¤šå¯ç”¨åŒºéƒ¨ç½²**ï¼š
- æ§åˆ¶å¹³é¢è·¨å¯ç”¨åŒºéƒ¨ç½²
- æ•°æ®å¹³é¢å‡åŒ€åˆ†å¸ƒ
- é…ç½®Podæ‹“æ‰‘åˆ†å¸ƒçº¦æŸ

**ç¤ºä¾‹ï¼šIstioæ§åˆ¶å¹³é¢é«˜å¯ç”¨é…ç½®**
```yaml
# åœ¨å®‰è£…æ—¶æŒ‡å®šé«˜å¯ç”¨é…ç½®
istioctl install --set profile=default \
  --set values.pilot.replicaCount=3 \
  --set values.pilot.autoscaleEnabled=true \
  --set values.pilot.resources.requests.cpu=100m \
  --set values.pilot.resources.requests.memory=128Mi \
  --set values.ingressGateways[0].replicaCount=3 \
  --set values.ingressGateways[0].autoscaleEnabled=true
```

### 10.3 å®‰å…¨åŠ å›º

**å®‰å…¨æœ€ä½³å®è·µ**ï¼š
- æœ€å°æƒé™åŸåˆ™
- å®šæœŸè½®æ¢è¯ä¹¦
- å¯ç”¨ä¸¥æ ¼çš„mTLS
- å®æ–½ç½‘ç»œåˆ†æ®µ
- é™åˆ¶Sidecaræƒé™
- ä¿æŠ¤æ§åˆ¶å¹³é¢
- åŠ å¯†æ•æ„Ÿé…ç½®
- å®šæœŸå®‰å…¨å®¡è®¡

**ç¤ºä¾‹ï¼šé™åˆ¶Sidecaræƒé™**
```yaml
apiVersion: security.istio.io/v1beta1
kind: PodSecurityPolicy
metadata:
  name: istio-sidecar
  annotations:
    seccomp.security.alpha.kubernetes.io/allowedProfileNames: docker/default
    apparmor.security.beta.kubernetes.io/allowedProfileNames: runtime/default
    seccomp.security.alpha.kubernetes.io/defaultProfileName: docker/default
    apparmor.security.beta.kubernetes.io/defaultProfileName: runtime/default
spec:
  privileged: false
  allowPrivilegeEscalation: false
  requiredDropCapabilities:
  - ALL
  volumes:
  - configMap
  - secret
  - emptyDir
  hostNetwork: false
  hostPorts:
  - min: 1024
    max: 65535
  hostIPC: false
  hostPID: false
  runAsUser:
    rule: RunAsAny
  seLinux:
    rule: RunAsAny
  supplementalGroups:
    rule: RunAsAny
  fsGroup:
    rule: RunAsAny
```

### 10.4 èµ„æºè§„åˆ’

**èµ„æºä¼°ç®—æŒ‡å—**ï¼š
- æ§åˆ¶å¹³é¢ï¼šæ¯ä¸ªèŠ‚ç‚¹2 CPUæ ¸å¿ƒï¼Œ4GBå†…å­˜
- æ•°æ®å¹³é¢ï¼šæ¯ä¸ªæœåŠ¡å®ä¾‹0.1-0.5 CPUæ ¸å¿ƒï¼Œ128-512MBå†…å­˜
- ç½‘ç»œå¸¦å®½ï¼šæ ¹æ®æœåŠ¡æµé‡ä¼°ç®—ï¼Œé¢å¤–é¢„ç•™30%å¸¦å®½

**è‡ªåŠ¨æ‰©ç¼©å®¹é…ç½®**ï¼š
```yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: istiod
  namespace: istio-system
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: istiod
  minReplicas: 2
  maxReplicas: 5
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
```

---

## 11. æœåŠ¡ç½‘æ ¼è¿ç§»ç­–ç•¥

### 11.1 å¢é‡è¿ç§»

**æ­¥éª¤**ï¼š
1. éƒ¨ç½²Istioæ§åˆ¶å¹³é¢
2. ä¸ºéå…³é”®æœåŠ¡å¯ç”¨Sidecaræ³¨å…¥
3. éªŒè¯æœåŠ¡é€šä¿¡å’ŒåŠŸèƒ½
4. é€æ­¥æ‰©å±•åˆ°æ›´å¤šæœåŠ¡
5. æœ€åè¿ç§»å…³é”®æœåŠ¡
6. å¯ç”¨å…¨å±€ç­–ç•¥

**ä¼˜åŠ¿**ï¼šé£é™©ä½ï¼Œå½±å“èŒƒå›´å°
**åŠ£åŠ¿**ï¼šè¿ç§»å‘¨æœŸé•¿

### 11.2 é‡‘ä¸é›€è¿ç§»

**æ­¥éª¤**ï¼š
1. éƒ¨ç½²Istioæ§åˆ¶å¹³é¢
2. ä¸ºæœåŠ¡çš„éƒ¨åˆ†å®ä¾‹å¯ç”¨Sidecar
3. å°†å°‘é‡æµé‡è·¯ç”±åˆ°å¸¦Sidecarçš„å®ä¾‹
4. ç›‘æ§å¹¶éªŒè¯åŠŸèƒ½å’Œæ€§èƒ½
5. é€æ­¥å¢åŠ å¸¦Sidecarçš„å®ä¾‹æ¯”ä¾‹
6. å®Œæˆè¿ç§»åä¸‹çº¿æ—§å®ä¾‹

**ç¤ºä¾‹é…ç½®**ï¼š
```yaml
# ä¸ºéƒ¨åˆ†å®ä¾‹å¯ç”¨Sidecar
apiVersion: v1
kind: Deployment
metadata:
  name: order-service
  namespace: default
spec:
  replicas: 10
  selector:
    matchLabels:
      app: order-service
  template:
    metadata:
      labels:
        app: order-service
        istio-injection: enabled
      annotations:
        sidecar.istio.io/inject: "true"
```

### 11.3 åŒç½‘æ ¼å¹¶è¡Œ

**æ­¥éª¤**ï¼š
1. éƒ¨ç½²Istioç½‘æ ¼ï¼Œä¸ç°æœ‰ç³»ç»Ÿå¹¶è¡Œ
2. é…ç½®æœåŠ¡åŒæ—¶æ³¨å†Œåˆ°ä¸¤ä¸ªç½‘æ ¼
3. é€æ­¥å°†æµé‡åˆ‡æ¢åˆ°Istioç½‘æ ¼
4. éªŒè¯åŠŸèƒ½å’Œæ€§èƒ½
5. å®Œå…¨åˆ‡æ¢åä¸‹çº¿æ—§ç½‘æ ¼

**ä¼˜åŠ¿**ï¼šå›æ»šæ–¹ä¾¿ï¼Œé£é™©å¯æ§
**åŠ£åŠ¿**ï¼šèµ„æºæ¶ˆè€—å¤§ï¼Œé…ç½®å¤æ‚

### 11.4 è¿ç§»éªŒè¯

**éªŒè¯æ¸…å•**ï¼š
- æœåŠ¡é—´é€šä¿¡æ­£å¸¸
- æ€§èƒ½æŒ‡æ ‡ä¸åŠ£äºè¿ç§»å‰
- å®‰å…¨ç­–ç•¥æ­£ç¡®å®æ–½
- ç›‘æ§å’Œå‘Šè­¦å·¥ä½œæ­£å¸¸
- ä¸šåŠ¡åŠŸèƒ½ä¸å—å½±å“
- æ•…éšœæ¢å¤æœºåˆ¶æœ‰æ•ˆ

---

## 12. æ¡ˆä¾‹åˆ†æä¸é—®é¢˜æ’æŸ¥

### 12.1 æ¡ˆä¾‹ï¼šç”µå•†å¹³å°æœåŠ¡ç½‘æ ¼å®æ–½

**èƒŒæ™¯**ï¼š
- 50+å¾®æœåŠ¡ï¼Œå¤šè¯­è¨€æŠ€æœ¯æ ˆ
- éœ€è¦æ”¯æŒç°åº¦å‘å¸ƒå’ŒA/Bæµ‹è¯•
- è¦æ±‚ç«¯åˆ°ç«¯åŠ å¯†å’Œç»†ç²’åº¦æˆæƒ
- éœ€è¦å®Œå–„çš„å¯è§‚æµ‹æ€§

**è§£å†³æ–¹æ¡ˆ**ï¼š
- é€‰æ‹©Istioä½œä¸ºæœåŠ¡ç½‘æ ¼
- åˆ†é˜¶æ®µè¿ç§»ç­–ç•¥ï¼Œå…ˆéå…³é”®æœåŠ¡
- å®æ–½ä¸¥æ ¼çš„mTLSå’Œæˆæƒç­–ç•¥
- éƒ¨ç½²Prometheusã€Grafanaå’ŒJaeger
- é…ç½®è‡ªåŠ¨åŒ–å‘Šè­¦

**æˆæœ**ï¼š
- éƒ¨ç½²æ—¶é—´ä»å°æ—¶çº§é™è‡³åˆ†é’Ÿçº§
- çº¿ä¸Šé—®é¢˜å®šä½æ—¶é—´ç¼©çŸ­70%
- å®‰å…¨åˆè§„è¦æ±‚æ»¡è¶³
- æœåŠ¡å¯ç”¨æ€§æå‡è‡³99.99%

### 12.2 å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

**é—®é¢˜1ï¼šSidecaræ³¨å…¥å¤±è´¥**

**ç—‡çŠ¶**ï¼šPodå¯åŠ¨åæ²¡æœ‰istio-proxyå®¹å™¨
**æ’æŸ¥**ï¼š
```bash
# æŸ¥è¯¢å‘½åç©ºé—´æ ‡ç­¾
kubectl get namespace -L istio-injection

# æ£€æŸ¥Podæ³¨è§£
kubectl get pod <pod-name> -o yaml | grep istio-injection

# æŸ¥çœ‹Istiodæ—¥å¿—
kubectl logs -n istio-system -l app=istiod
```
**è§£å†³æ–¹æ¡ˆ**ï¼š
- ç¡®ä¿å‘½åç©ºé—´æ ‡ç­¾æ­£ç¡®
- æ£€æŸ¥Podæ³¨è§£é…ç½®
- éªŒè¯Istiodå¥åº·çŠ¶æ€
- é‡å¯Istiodå’Œç›®æ ‡Pod

**é—®é¢˜2ï¼šæœåŠ¡é—´é€šä¿¡å¤±è´¥**

**ç—‡çŠ¶**ï¼šæœåŠ¡è°ƒç”¨è¶…æ—¶æˆ–è¿”å›503é”™è¯¯
**æ’æŸ¥**ï¼š
```bash
# æŸ¥çœ‹æœåŠ¡ç«¯ç‚¹
kubectl get endpoints <service-name>

# æŸ¥çœ‹Istioé…ç½®
istioctl describe service <service-name>

# æŸ¥çœ‹Sidecaræ—¥å¿—
kubectl logs <pod-name> -c istio-proxy

# æ£€æŸ¥ç½‘ç»œç­–ç•¥
kubectl get networkpolicy
```
**è§£å†³æ–¹æ¡ˆ**ï¼š
- ç¡®ä¿æœåŠ¡ç«¯ç‚¹æ­£å¸¸
- æ£€æŸ¥è™šæ‹ŸæœåŠ¡å’Œç›®æ ‡è§„åˆ™é…ç½®
- éªŒè¯SidecarçŠ¶æ€
- æ£€æŸ¥ç½‘ç»œç­–ç•¥å’Œæˆæƒç­–ç•¥

**é—®é¢˜3ï¼šæ€§èƒ½ä¸‹é™**

**ç—‡çŠ¶**ï¼šå“åº”å»¶è¿Ÿå¢åŠ ï¼Œååé‡ä¸‹é™
**æ’æŸ¥**ï¼š
```bash
# æŸ¥çœ‹æ€§èƒ½æŒ‡æ ‡
istioctl experimental metrics service <service-name>

# æ£€æŸ¥èµ„æºä½¿ç”¨
kubectl top pod

# åˆ†æè¿½è¸ªæ•°æ®
# åœ¨Jaeger UIä¸­æŸ¥çœ‹å»¶è¿Ÿåˆ†å¸ƒ
```
**è§£å†³æ–¹æ¡ˆ**ï¼š
- è°ƒæ•´Sidecarèµ„æºé…ç½®
- ä¼˜åŒ–Envoyé…ç½®
- æ£€æŸ¥è¿æ¥æ± å’Œè¶…æ—¶è®¾ç½®
- å¯ç”¨HTTP/2å’Œè¿æ¥å¤ç”¨

---

## ğŸ“š å‚è€ƒèµ„æº

1. [Istioå®˜æ–¹æ–‡æ¡£](https://istio.io/latest/docs/)
2. [Linkerdå®˜æ–¹æ–‡æ¡£](https://linkerd.io/2.12/overview/)
3. [Service Mesh Patterns](https://microservices.io/patterns/service-mesh.html)
4. [Istio in Action](https://www.manning.com/books/istio-in-action)
5. [Cloud Native DevOps with Kubernetes](https://www.oreilly.com/library/view/cloud-native-devops-with/9781492043772/)
6. [Envoy Proxy Documentation](https://www.envoyproxy.io/docs/envoy/latest/)
7. [Istio GitHubä»“åº“](https://github.com/istio/istio)
8. [Istio Community Forum](https://discuss.istio.io/)