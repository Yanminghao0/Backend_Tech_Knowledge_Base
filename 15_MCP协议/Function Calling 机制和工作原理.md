# Function Calling æœºåˆ¶å’Œå·¥ä½œåŸç†

> ğŸ” æ·±å…¥ç†è§£AIå¤§æ¨¡å‹çš„Function Callingèƒ½åŠ›ï¼šä»åŸç†åˆ°å®æˆ˜

---

## ğŸ“‹ ç›®å½•

1. [æ ¸å¿ƒæ¦‚å¿µ](#1-æ ¸å¿ƒæ¦‚å¿µ)
2. [å·¥ä½œåŸç†](#2-å·¥ä½œåŸç†)
3. [æŠ€æœ¯å®ç°](#3-æŠ€æœ¯å®ç°)
4. [ä¸»æµå¹³å°å¯¹æ¯”](#4-ä¸»æµå¹³å°å¯¹æ¯”)
5. [æœ€ä½³å®è·µ](#5-æœ€ä½³å®è·µ)
6. [å¸¸è§é—®é¢˜](#6-å¸¸è§é—®é¢˜)
7. [å®æˆ˜æ¡ˆä¾‹](#7-å®æˆ˜æ¡ˆä¾‹)
8. [è¿›é˜¶æŠ€å·§](#8-è¿›é˜¶æŠ€å·§)

---

## 1. æ ¸å¿ƒæ¦‚å¿µ

### 1.1 ä»€ä¹ˆæ˜¯Function Callingï¼Ÿ

**å®šä¹‰**ï¼š
```
Function Callingï¼ˆå‡½æ•°è°ƒç”¨ï¼‰æ˜¯AIå¤§æ¨¡å‹çš„ä¸€ç§èƒ½åŠ›ï¼Œ
ä½¿æ¨¡å‹èƒ½å¤Ÿè¯†åˆ«ç”¨æˆ·æ„å›¾ï¼Œå¹¶ç”Ÿæˆç»“æ„åŒ–çš„å‡½æ•°è°ƒç”¨è¯·æ±‚ï¼Œ
è®©AIèƒ½å¤Ÿä¸å¤–éƒ¨ç³»ç»Ÿè¿›è¡Œäº¤äº’ã€‚
```

**æ ¸å¿ƒä»·å€¼**ï¼š
```
âŒ ä¼ ç»ŸAIï¼šåªèƒ½ç”Ÿæˆæ–‡æœ¬å›ç­”ï¼Œæ— æ³•æ‰§è¡Œå®é™…æ“ä½œ
âœ… Function Callingï¼šAIèƒ½å¤Ÿè°ƒç”¨å¤–éƒ¨å‡½æ•°ï¼Œè·å–å®æ—¶æ•°æ®ã€æ‰§è¡Œæ“ä½œ
```

**ç®€å•ç¤ºä¾‹**ï¼š
```
ç”¨æˆ·ï¼š"åŒ—äº¬ä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ"

ä¼ ç»ŸAIå›ç­”ï¼š
"å¯¹ä¸èµ·ï¼Œæˆ‘æ— æ³•è·å–å®æ—¶å¤©æ°”ä¿¡æ¯..."

Function Calling AIï¼š
1. è¯†åˆ«æ„å›¾ï¼šéœ€è¦æŸ¥è¯¢å¤©æ°”
2. ç”Ÿæˆè°ƒç”¨ï¼šget_weather(location="åŒ—äº¬")
3. æ‰§è¡Œå‡½æ•°ï¼šè°ƒç”¨å¤©æ°”API
4. æ•´åˆç»“æœï¼šåŒ—äº¬ä»Šå¤©æ™´å¤©ï¼Œæ°”æ¸©25Â°C
```

### 1.2 æ ¸å¿ƒç‰¹ç‚¹

| ç‰¹ç‚¹ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| **æ„å›¾è¯†åˆ«** | AIè‡ªåŠ¨è¯†åˆ«éœ€è¦è°ƒç”¨å“ªä¸ªå‡½æ•° | è¯†åˆ«"æŸ¥å¤©æ°”"â†’é€‰æ‹©get_weather |
| **å‚æ•°æå–** | AIä»å¯¹è¯ä¸­æå–å‡½æ•°å‚æ•° | "åŒ—äº¬çš„å¤©æ°”"â†’location="åŒ—äº¬" |
| **ç»“æ„åŒ–è¾“å‡º** | è¿”å›æ ‡å‡†JSONæ ¼å¼çš„è°ƒç”¨è¯·æ±‚ | {"name":"get_weather","arguments":{...}} |
| **ä¸Šä¸‹æ–‡ç†è§£** | èƒ½å¤Ÿå¤„ç†å¤æ‚å¯¹è¯å’Œå¤šè½®äº¤äº’ | "é‚£ä¸Šæµ·å‘¢ï¼Ÿ"â†’è®°ä½åœ¨æŸ¥å¤©æ°” |
| **å¤šå‡½æ•°é€‰æ‹©** | ä»å¤šä¸ªå‡½æ•°ä¸­é€‰æ‹©æœ€åˆé€‚çš„ | æä¾›10ä¸ªå‡½æ•°ï¼ŒAIé€‰æ‹©æ­£ç¡®çš„1ä¸ª |

### 1.3 å·¥ä½œæµç¨‹æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·è¾“å…¥   â”‚ "å¸®æˆ‘æŸ¥ä¸€ä¸‹åŒ—äº¬ä»Šå¤©çš„å¤©æ°”"
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AIæ¨¡å‹ï¼ˆGPT-4/Claude/Geminiï¼‰       â”‚
â”‚                                     â”‚
â”‚  1. åˆ†æç”¨æˆ·æ„å›¾                    â”‚
â”‚     â†’ ç”¨æˆ·æƒ³æŸ¥è¯¢å¤©æ°”ä¿¡æ¯            â”‚
â”‚                                     â”‚
â”‚  2. é€‰æ‹©åˆé€‚çš„å‡½æ•°                  â”‚
â”‚     â†’ ä»functionsåˆ—è¡¨é€‰æ‹©           â”‚
â”‚     â†’ get_weather æœ€åŒ¹é…            â”‚
â”‚                                     â”‚
â”‚  3. æå–å‡½æ•°å‚æ•°                    â”‚
â”‚     â†’ location: "åŒ—äº¬"              â”‚
â”‚     â†’ unit: "celsius" (æ¨æ–­)        â”‚
â”‚                                     â”‚
â”‚  4. ç”Ÿæˆå‡½æ•°è°ƒç”¨è¯·æ±‚                â”‚
â”‚     â†’ è¿”å›JSONæ ¼å¼                  â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  function_call å“åº”                 â”‚
â”‚  {                                  â”‚
â”‚    "name": "get_weather",           â”‚
â”‚    "arguments": {                   â”‚
â”‚      "location": "åŒ—äº¬",            â”‚
â”‚      "unit": "celsius"              â”‚
â”‚    }                                â”‚
â”‚  }                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¼€å‘è€…åº”ç”¨                         â”‚
â”‚                                     â”‚
â”‚  1. è§£æfunction_call               â”‚
â”‚  2. æ‰§è¡Œå®é™…å‡½æ•°                    â”‚
â”‚     result = get_weather("åŒ—äº¬")    â”‚
â”‚  3. è·å–ç»“æœ                        â”‚
â”‚     {"temp": 25, "condition": ...}  â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å°†ç»“æœè¿”å›ç»™AI                     â”‚
â”‚                                     â”‚
â”‚  messages.append({                  â”‚
â”‚    "role": "function",              â”‚
â”‚    "name": "get_weather",           â”‚
â”‚    "content": "{...result...}"      â”‚
â”‚  })                                 â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AIç”Ÿæˆæœ€ç»ˆå›ç­”                     â”‚
â”‚                                     â”‚
â”‚  "åŒ—äº¬ä»Šå¤©æ™´å¤©ï¼Œæ°”æ¸©25Â°Cï¼Œ          â”‚
â”‚   é€‚åˆæˆ·å¤–æ´»åŠ¨ï¼"                   â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¿”å›ç”¨æˆ·    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.4 å…³é”®è§’è‰²

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è§’è‰²åˆ’åˆ†                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                              â”‚
â”‚  1. AIæ¨¡å‹ï¼ˆæ™ºèƒ½å†³ç­–è€…ï¼‰                      â”‚
â”‚     â€¢ ç†è§£ç”¨æˆ·æ„å›¾                           â”‚
â”‚     â€¢ é€‰æ‹©åˆé€‚çš„å‡½æ•°                         â”‚
â”‚     â€¢ æå–å‡½æ•°å‚æ•°                           â”‚
â”‚     â€¢ ç”Ÿæˆç»“æ„åŒ–è°ƒç”¨è¯·æ±‚                     â”‚
â”‚     â€¢ åŸºäºå‡½æ•°ç»“æœç”Ÿæˆå›ç­”                   â”‚
â”‚                                              â”‚
â”‚  2. å¼€å‘è€…ï¼ˆæ‰§è¡Œè€…+é…ç½®è€…ï¼‰                   â”‚
â”‚     â€¢ å®šä¹‰å¯ç”¨çš„å‡½æ•°åˆ—è¡¨                     â”‚
â”‚     â€¢ ç¼–å†™å‡½æ•°çš„å®é™…å®ç°                     â”‚
â”‚     â€¢ è§£æAIçš„è°ƒç”¨è¯·æ±‚                       â”‚
â”‚     â€¢ æ‰§è¡Œå‡½æ•°å¹¶è·å–ç»“æœ                     â”‚
â”‚     â€¢ å°†ç»“æœè¿”å›ç»™AI                         â”‚
â”‚                                              â”‚
â”‚  3. Functions Schemaï¼ˆæ¥å£å®šä¹‰ï¼‰              â”‚
â”‚     â€¢ å‡½æ•°åç§°å’Œæè¿°                         â”‚
â”‚     â€¢ å‚æ•°å®šä¹‰ï¼ˆç±»å‹ã€å¿…å¡«é¡¹ï¼‰               â”‚
â”‚     â€¢ è®©AIç†è§£å‡½æ•°çš„ä½œç”¨                     â”‚
â”‚                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**åˆ†å·¥æ˜ç¡®**ï¼š
```
AIè´Ÿè´£ï¼š
âœ… æ™ºèƒ½éƒ¨åˆ†ï¼ˆæ„å›¾è¯†åˆ«ã€å‚æ•°æå–ã€å¯¹è¯ç”Ÿæˆï¼‰
âŒ ä¸è´Ÿè´£å®é™…æ‰§è¡Œå‡½æ•°

å¼€å‘è€…è´Ÿè´£ï¼š
âœ… æ‰§è¡Œéƒ¨åˆ†ï¼ˆå‡½æ•°å®ç°ã€å®é™…è°ƒç”¨ï¼‰
âœ… é…ç½®éƒ¨åˆ†ï¼ˆå®šä¹‰functions schemaï¼‰
âŒ ä¸éœ€è¦å†™å¤æ‚çš„NLPé€»è¾‘
```


### 1.5 ä¸ä¼ ç»ŸAPIè°ƒç”¨çš„åŒºåˆ«

```
ä¼ ç»ŸAPIè°ƒç”¨ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     å›ºå®šé€»è¾‘      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·è¾“å…¥ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚ APIè°ƒç”¨  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ç¤ºä¾‹ï¼š
if ("å¤©æ°”" in user_input):
    call_weather_api()
elif ("ç¿»è¯‘" in user_input):
    call_translate_api()
# âŒ ç¡¬ç¼–ç ï¼Œéš¾ä»¥æ‰©å±•ï¼Œæ— æ³•ç†è§£å¤æ‚æ„å›¾

Function Callingï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     AIç†è§£      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     æ™ºèƒ½é€‰æ‹©     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·è¾“å…¥ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚ AIåˆ†æ  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚ å‡½æ•°è°ƒç”¨  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ç¤ºä¾‹ï¼š
ç”¨æˆ·ï¼š"å¸®æˆ‘çœ‹çœ‹æ˜å¤©é€‚ä¸é€‚åˆå»åŒ—äº¬æ—…æ¸¸"
AIç†è§£ï¼šéœ€è¦å¤©æ°”ä¿¡æ¯ â†’ é€‰æ‹©get_weather("åŒ—äº¬")
# âœ… æ™ºèƒ½ç†è§£ï¼Œè‡ªåŠ¨é€‰æ‹©ï¼Œå¤„ç†å¤æ‚è¯­ä¹‰
```

**æ ¸å¿ƒå·®å¼‚**ï¼š

| ç»´åº¦ | ä¼ ç»ŸAPIè°ƒç”¨ | Function Calling |
|------|------------|------------------|
| **è§¦å‘æ–¹å¼** | if-elseç¡¬ç¼–ç  | AIæ™ºèƒ½è¯†åˆ« |
| **å‚æ•°æå–** | æ­£åˆ™/è§„åˆ™æå– | AIè‡ªç„¶è¯­è¨€ç†è§£ |
| **çµæ´»æ€§** | ä½ï¼ˆå›ºå®šæ¨¡å¼ï¼‰ | é«˜ï¼ˆç†è§£å˜åŒ–è¡¨è¾¾ï¼‰ |
| **å¯æ‰©å±•æ€§** | å·®ï¼ˆéœ€è¦ä¿®æ”¹ä»£ç ï¼‰ | å¥½ï¼ˆåªéœ€æ·»åŠ functionå®šä¹‰ï¼‰ |
| **å¤æ‚åº¦** | ç®€å•åœºæ™¯å¯ç”¨ | å¤„ç†å¤æ‚å¯¹è¯ |
| **å¼€å‘æˆæœ¬** | æ¯ä¸ªæ„å›¾éƒ½è¦å†™é€»è¾‘ | å®šä¹‰schemaå³å¯ |

**ä¸¾ä¾‹å¯¹æ¯”**ï¼š

```python
# âŒ ä¼ ç»Ÿæ–¹å¼
def handle_user_input(text):
    if "å¤©æ°”" in text and "åŒ—äº¬" in text:
        return get_weather("åŒ—äº¬")
    elif "å¤©æ°”" in text and "ä¸Šæµ·" in text:
        return get_weather("ä¸Šæµ·")
    # éœ€è¦ç©·ä¸¾æ‰€æœ‰å¯èƒ½...
    
# é—®é¢˜ï¼š
# 1. æ— æ³•å¤„ç†ï¼š"é¦–éƒ½ä»Šå¤©çƒ­ä¸çƒ­ï¼Ÿ"
# 2. æ— æ³•å¤„ç†ï¼š"å¸®æˆ‘æŸ¥ä¸€ä¸‹BJçš„æ°”æ¸©"
# 3. æ¯æ·»åŠ ä¸€ä¸ªåŸå¸‚éƒ½è¦æ”¹ä»£ç 

# âœ… Function Callingæ–¹å¼
functions = [{
    "name": "get_weather",
    "description": "è·å–åŸå¸‚å¤©æ°”",
    "parameters": {
        "location": {"type": "string", "description": "åŸå¸‚åç§°"}
    }
}]

# AIè‡ªåŠ¨å¤„ç†ï¼š
# âœ… "é¦–éƒ½ä»Šå¤©çƒ­ä¸çƒ­ï¼Ÿ" â†’ get_weather("åŒ—äº¬")
# âœ… "å¸®æˆ‘æŸ¥ä¸€ä¸‹BJçš„æ°”æ¸©" â†’ get_weather("åŒ—äº¬")
# âœ… "Paris weather please" â†’ get_weather("Paris")
# æ— éœ€ä¿®æ”¹ä»£ç ï¼
```

---

## 2. å·¥ä½œåŸç†

### 2.1 å®Œæ•´å·¥ä½œæµç¨‹

```
é˜¶æ®µä¸€ï¼šé…ç½®é˜¶æ®µï¼ˆå¼€å‘è€…ï¼‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. å®šä¹‰Functions Schema             â”‚
â”‚                                     â”‚
â”‚ functions = [                       â”‚
â”‚   {                                 â”‚
â”‚     "name": "get_weather",          â”‚
â”‚     "description": "è·å–å¤©æ°”ä¿¡æ¯",   â”‚
â”‚     "parameters": {...}             â”‚
â”‚   },                                â”‚
â”‚   {                                 â”‚
â”‚     "name": "search_web",           â”‚
â”‚     "description": "æœç´¢ç½‘é¡µ",       â”‚
â”‚     "parameters": {...}             â”‚
â”‚   }                                 â”‚
â”‚ ]                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é˜¶æ®µäºŒï¼šè¿è¡Œé˜¶æ®µï¼ˆè‡ªåŠ¨ï¼‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. ç”¨æˆ·å‘èµ·å¯¹è¯                     â”‚
â”‚                                     â”‚
â”‚ user: "åŒ—äº¬ä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ"         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. è°ƒç”¨AI API                       â”‚
â”‚                                     â”‚
â”‚ openai.ChatCompletion.create(       â”‚
â”‚   model="gpt-4",                    â”‚
â”‚   messages=[...],                   â”‚
â”‚   functions=functions  â† ä¼ é€’å®šä¹‰   â”‚
â”‚ )                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. AIå†…éƒ¨å¤„ç†ï¼ˆé»‘ç›’ï¼‰                â”‚
â”‚                                     â”‚
â”‚ a) æ„å›¾è¯†åˆ«                         â”‚
â”‚    â†’ ç”¨æˆ·æƒ³æŸ¥è¯¢å¤©æ°”                 â”‚
â”‚                                     â”‚
â”‚ b) å‡½æ•°åŒ¹é…                         â”‚
â”‚    â†’ get_weather æœ€ç›¸å…³             â”‚
â”‚    â†’ search_web ä¸ç›¸å…³              â”‚
â”‚                                     â”‚
â”‚ c) å‚æ•°æå–                         â”‚
â”‚    â†’ location: "åŒ—äº¬"               â”‚
â”‚    â†’ unit: æ¨æ–­ä¸º "celsius"         â”‚
â”‚                                     â”‚
â”‚ d) éªŒè¯å‚æ•°                         â”‚
â”‚    â†’ æ£€æŸ¥å¿…å¡«å‚æ•°æ˜¯å¦å®Œæ•´           â”‚
â”‚    â†’ æ£€æŸ¥å‚æ•°ç±»å‹æ˜¯å¦åŒ¹é…           â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. AIè¿”å›Function Callè¯·æ±‚          â”‚
â”‚                                     â”‚
â”‚ {                                   â”‚
â”‚   "choices": [{                     â”‚
â”‚     "message": {                    â”‚
â”‚       "role": "assistant",          â”‚
â”‚       "function_call": {            â”‚
â”‚         "name": "get_weather",      â”‚
â”‚         "arguments": "{             â”‚
â”‚           \"location\": \"åŒ—äº¬\",   â”‚
â”‚           \"unit\": \"celsius\"     â”‚
â”‚         }"                          â”‚
â”‚       }                             â”‚
â”‚     }                               â”‚
â”‚   }]                                â”‚
â”‚ }                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. å¼€å‘è€…è§£æå¹¶æ‰§è¡Œ                 â”‚
â”‚                                     â”‚
â”‚ fc = response["function_call"]      â”‚
â”‚ name = fc["name"]                   â”‚
â”‚ args = json.loads(fc["arguments"])  â”‚
â”‚                                     â”‚
â”‚ if name == "get_weather":           â”‚
â”‚   result = get_weather(**args)      â”‚
â”‚                                     â”‚
â”‚ # result = {                        â”‚
â”‚ #   "temperature": 25,              â”‚
â”‚ #   "condition": "sunny"            â”‚
â”‚ # }                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ï¿½ï¿½â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. å°†ç»“æœè¿”å›ç»™AI                   â”‚
â”‚                                     â”‚
â”‚ messages.append({                   â”‚
â”‚   "role": "function",               â”‚
â”‚   "name": "get_weather",            â”‚
â”‚   "content": json.dumps(result)     â”‚
â”‚ })                                  â”‚
â”‚                                     â”‚
â”‚ second_response = openai...create(  â”‚
â”‚   messages=messages                 â”‚
â”‚ )                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. AIç”Ÿæˆæœ€ç»ˆå›ç­”                   â”‚
â”‚                                     â”‚
â”‚ {                                   â”‚
â”‚   "choices": [{                     â”‚
â”‚     "message": {                    â”‚
â”‚       "role": "assistant",          â”‚
â”‚       "content": "åŒ—äº¬ä»Šå¤©æ™´å¤©ï¼Œ    â”‚
â”‚                   æ°”æ¸©25Â°Cï¼Œ        â”‚
â”‚                   å¤©æ°”ä¸é”™å“¦ï¼"     â”‚
â”‚     }                               â”‚
â”‚   }]                                â”‚
â”‚ }                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 9. å±•ç¤ºç»™ç”¨æˆ·                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


### 2.2 AIçš„å†³ç­–è¿‡ç¨‹ï¼ˆæ·±å…¥è§£æï¼‰

#### 2.2.1 æ„å›¾è¯†åˆ«

**AIå¦‚ä½•ç†è§£ç”¨æˆ·æƒ³åšä»€ä¹ˆï¼Ÿ**

```
è¾“å…¥ï¼š"åŒ—äº¬ä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ"

AIåˆ†æè¿‡ç¨‹ï¼š
1. åˆ†è¯ï¼š[åŒ—äº¬, ä»Šå¤©, å¤©æ°”, æ€ä¹ˆæ ·]
2. å…³é”®è¯è¯†åˆ«ï¼š
   - "å¤©æ°”" â†’ æ ¸å¿ƒæ„å›¾
   - "åŒ—äº¬" â†’ åœ°ç‚¹ä¿¡æ¯
   - "ä»Šå¤©" â†’ æ—¶é—´ä¿¡æ¯
3. æ„å›¾åˆ†ç±»ï¼š
   - æŸ¥è¯¢ç±» âœ“
   - æ“ä½œç±» âœ—
   - å¯¹è¯ç±» âœ—
4. ç¡®å®šéœ€æ±‚ï¼šè·å–å¤©æ°”ä¿¡æ¯
```

**å¤æ‚ç¤ºä¾‹**ï¼š
```
è¾“å…¥ï¼š"æ˜å¤©å»åŒ—äº¬å‡ºå·®ï¼Œå¸®æˆ‘çœ‹çœ‹éœ€ä¸éœ€è¦å¸¦ä¼"

AIåˆ†æï¼š
1. è¯†åˆ«éšå«æ„å›¾ï¼š
   - éœ€è¦æŸ¥è¯¢å¤©æ°”
   - å…³æ³¨é™é›¨æƒ…å†µ
   - ç›®çš„æ˜¯åšå‡ºè¡Œå†³ç­–
   
2. æå–å…³é”®ä¿¡æ¯ï¼š
   - åœ°ç‚¹ï¼šåŒ—äº¬
   - æ—¶é—´ï¼šæ˜å¤©
   - å…³æ³¨ç‚¹ï¼šé™é›¨

3. ç¡®å®šè°ƒç”¨ï¼š
   - get_weather(location="åŒ—äº¬", date="æ˜å¤©")
   
4. åç»­å¤„ç†ï¼š
   - åŸºäºå¤©æ°”ç»“æœåˆ¤æ–­æ˜¯å¦éœ€è¦å¸¦ä¼
```

#### 2.2.2 å‡½æ•°é€‰æ‹©

**AIå¦‚ä½•ä»å¤šä¸ªå‡½æ•°ä¸­é€‰æ‹©ï¼Ÿ**

```python
# å‡è®¾å®šä¹‰äº†å¤šä¸ªå‡½æ•°
functions = [
    {
        "name": "get_weather",
        "description": "è·å–æŒ‡å®šåŸå¸‚çš„å¤©æ°”ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ¸©åº¦ã€å¤©æ°”çŠ¶å†µã€é™é›¨æ¦‚ç‡ç­‰"
    },
    {
        "name": "search_web",
        "description": "åœ¨äº’è”ç½‘ä¸Šæœç´¢ä¿¡æ¯"
    },
    {
        "name": "get_stock_price",
        "description": "è·å–è‚¡ç¥¨å®æ—¶ä»·æ ¼"
    },
    {
        "name": "send_email",
        "description": "å‘é€ç”µå­é‚®ä»¶"
    }
]
```

**é€‰æ‹©è¿‡ç¨‹**ï¼š
```
ç”¨æˆ·è¾“å…¥ï¼š"åŒ—äº¬ä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ"

AIåŒ¹é…åˆ†æ•°ï¼ˆå†…éƒ¨æ¨ç†ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‡½æ•°å            â”‚ ç›¸å…³åº¦  â”‚ åŸå›             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ get_weather      â”‚ â˜…â˜…â˜…â˜…â˜…  â”‚ å®Œå…¨åŒ¹é…å¤©æ°”æŸ¥è¯¢ â”‚
â”‚ search_web       â”‚ â˜…â˜†â˜†â˜†â˜†  â”‚ å¯ä»¥æœä½†ä¸ä¸“ä¸š   â”‚
â”‚ get_stock_price  â”‚ â˜†â˜†â˜†â˜†â˜†  â”‚ å®Œå…¨ä¸ç›¸å…³       â”‚
â”‚ send_email       â”‚ â˜†â˜†â˜†â˜†â˜†  â”‚ å®Œå…¨ä¸ç›¸å…³       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æœ€ç»ˆé€‰æ‹©ï¼šget_weatherï¼ˆæœ€é«˜åˆ†ï¼‰
```

**è¾¹ç•Œæ¡ˆä¾‹**ï¼š
```
ç”¨æˆ·ï¼š"å¸®æˆ‘æŸ¥ä¸€ä¸‹è‹¹æœå…¬å¸çš„ä¿¡æ¯"

å¯èƒ½çš„ç†è§£ï¼š
1. æœç´¢ç½‘é¡µ â†’ search_web("Apple Inc")
2. æŸ¥è¯¢è‚¡ç¥¨ â†’ get_stock_price("AAPL")

AIçš„å†³ç­–ï¼š
- å¦‚æœdescriptionæ˜ç¡®åŒºåˆ†ï¼Œé€‰æ‹©æœ€åˆé€‚çš„
- å¦‚æœæ¨¡ç³Šï¼Œå¯èƒ½è¯¢é—®ç”¨æˆ·
- åŸºäºä¸Šä¸‹æ–‡å†å²åˆ¤æ–­
```

#### 2.2.3 å‚æ•°æå–

**AIå¦‚ä½•æå–å‡½æ•°å‚æ•°ï¼Ÿ**

```python
# å‡½æ•°å®šä¹‰
{
    "name": "get_weather",
    "parameters": {
        "type": "object",
        "properties": {
            "location": {
                "type": "string",
                "description": "åŸå¸‚åç§°ï¼Œå¦‚ï¼šåŒ—äº¬ã€ä¸Šæµ·ã€çº½çº¦"
            },
            "unit": {
                "type": "string",
                "enum": ["celsius", "fahrenheit"],
                "description": "æ¸©åº¦å•ä½"
            },
            "date": {
                "type": "string",
                "description": "æ—¥æœŸï¼Œæ ¼å¼ï¼šYYYY-MM-DD"
            }
        },
        "required": ["location"]
    }
}
```

**æå–ç¤ºä¾‹**ï¼š

```
ç¤ºä¾‹1ï¼šç›´æ¥æ˜ç¡®
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
è¾“å…¥ï¼š"æŸ¥è¯¢åŒ—äº¬çš„å¤©æ°”ï¼Œç”¨æ‘„æ°åº¦"
æå–ï¼š
{
  "location": "åŒ—äº¬",     â† ç›´æ¥æå–
  "unit": "celsius"       â† å…³é”®è¯æ˜ å°„
}

ç¤ºä¾‹2ï¼šéœ€è¦æ¨æ–­
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
è¾“å…¥ï¼š"å¸®æˆ‘çœ‹çœ‹å¸éƒ½ä»Šå¤©çƒ­ä¸çƒ­"
æå–ï¼š
{
  "location": "åŒ—äº¬",     â† å¸éƒ½ = åŒ—äº¬ï¼ˆçŸ¥è¯†æ¨ç†ï¼‰
  "unit": "celsius"       â† ä¸­å›½ç”¨æˆ·é»˜è®¤æ‘„æ°åº¦
}

ç¤ºä¾‹3ï¼šä¸Šä¸‹æ–‡å…³è”
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å¯¹è¯å†å²ï¼š
ç”¨æˆ·ï¼š"åŒ—äº¬å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ"
AIï¼š"åŒ—äº¬ä»Šå¤©æ™´å¤©..."
ç”¨æˆ·ï¼š"é‚£ä¸Šæµ·å‘¢ï¼Ÿ"

æå–ï¼š
{
  "location": "ä¸Šæµ·",     â† æ›¿æ¢åœ°ç‚¹
  "unit": "celsius"       â† ç»§æ‰¿å‰é¢çš„è®¾ç½®
}
# AIç†è§£ï¼šç”¨æˆ·æƒ³æŸ¥ä¸Šæµ·çš„å¤©æ°”ï¼ˆåŒæ ·çš„æŸ¥è¯¢ç±»å‹ï¼‰

ç¤ºä¾‹4ï¼šç¼ºå¤±å¿…å¡«å‚æ•°
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
è¾“å…¥ï¼š"ä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ"
AIè¡Œä¸ºï¼š
1. å°è¯•ä»ä¸Šä¸‹æ–‡è·å–location
2. å¦‚æœæ— æ³•è·å–ï¼Œå¯èƒ½ï¼š
   a) è¯¢é—®ç”¨æˆ·ï¼š"æ‚¨æƒ³æŸ¥è¯¢å“ªä¸ªåŸå¸‚çš„å¤©æ°”ï¼Ÿ"
   b) ä½¿ç”¨é»˜è®¤å€¼ï¼ˆå¦‚æœå®šä¹‰äº†ï¼‰
   c) è¿”å›é”™è¯¯æç¤º
```

**å‚æ•°ç±»å‹è½¬æ¢**ï¼š
```
å®šä¹‰ç±»å‹ï¼šinteger
ç”¨æˆ·è¾“å…¥ï¼š"å¸®æˆ‘æŸ¥3å¤©å†…çš„å¤©æ°”"

AIå¤„ç†ï¼š
- "3å¤©" â†’ æå–æ•°å­— "3"
- è½¬æ¢ä¸º integer: 3

å®šä¹‰ç±»å‹ï¼šboolean
ç”¨æˆ·è¾“å…¥ï¼š"è¦åŒ…å«è¯¦ç»†ä¿¡æ¯"

AIå¤„ç†ï¼š
- "è¦åŒ…å«" â†’ ç†è§£ä¸º true
- è¾“å‡ºï¼š{"detailed": true}

å®šä¹‰ç±»å‹ï¼šarray
ç”¨æˆ·è¾“å…¥ï¼š"æŸ¥è¯¢åŒ—äº¬ã€ä¸Šæµ·ã€æ·±åœ³çš„å¤©æ°”"

AIå¤„ç†ï¼š
- è¯†åˆ«å¤šä¸ªåŸå¸‚
- è¾“å‡ºï¼š{"cities": ["åŒ—äº¬", "ä¸Šæµ·", "æ·±åœ³"]}
```

#### 2.2.4 å‚æ•°éªŒè¯

**AIçš„å†…éƒ¨éªŒè¯æœºåˆ¶**ï¼š

```
éªŒè¯å±‚çº§ï¼š

1. å¿…å¡«å‚æ•°æ£€æŸ¥
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
required: ["location"]

ç”¨æˆ·ï¼š"å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ"
â†“
æ£€æŸ¥ï¼šlocationç¼ºå¤±
â†“
è¡Œä¸ºï¼š
  - è¯¢é—®ç”¨æˆ·
  - æˆ–è¿”å›å‚æ•°ä¸è¶³é”™è¯¯

2. ç±»å‹æ£€æŸ¥
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
location: {type: "string"}

ç”¨æˆ·ï¼š"æŸ¥è¯¢123çš„å¤©æ°”"
â†“
æ£€æŸ¥ï¼š123æ˜¯å¦ä¸ºæœ‰æ•ˆåŸå¸‚å
â†“
è¡Œä¸ºï¼š
  - å¦‚æœæ˜¯é‚®ç¼–ï¼Œå°è¯•è½¬æ¢
  - å¦‚æœæ— æ•ˆï¼Œæç¤ºé”™è¯¯

3. æšä¸¾å€¼æ£€æŸ¥
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
unit: {enum: ["celsius", "fahrenheit"]}

ç”¨æˆ·ï¼š"ç”¨å¼€å°”æ–‡æ¸©åº¦"
â†“
æ£€æŸ¥ï¼škelvinä¸åœ¨æšä¸¾ä¸­
â†“
è¡Œä¸ºï¼š
  - é€‰æ‹©æœ€æ¥è¿‘çš„ï¼šcelsius
  - æˆ–æç¤ºç”¨æˆ·é€‰æ‹©æœ‰æ•ˆå€¼

4. æ ¼å¼éªŒè¯
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
date: {pattern: "YYYY-MM-DD"}

ç”¨æˆ·ï¼š"æ˜å¤©çš„å¤©æ°”"
â†“
å¤„ç†ï¼š
  - å°†"æ˜å¤©"è½¬æ¢ä¸ºæ—¥æœŸæ ¼å¼
  - è¾“å‡ºï¼š"2024-10-28"
```

**éªŒè¯å¤±è´¥å¤„ç†**ï¼š

```python
# åœºæ™¯1ï¼šç¼ºå°‘å¿…å¡«å‚æ•°
ç”¨æˆ·è¾“å…¥ï¼š"æŸ¥å¤©æ°”"
AIå“åº”ï¼š
{
  "role": "assistant",
  "content": "è¯·é—®æ‚¨æƒ³æŸ¥è¯¢å“ªä¸ªåŸå¸‚çš„å¤©æ°”ï¼Ÿ"
  # ä¸è¿”å›function_callï¼Œè€Œæ˜¯è¯¢é—®
}

# åœºæ™¯2ï¼šå‚æ•°ç±»å‹é”™è¯¯
ç”¨æˆ·è¾“å…¥ï¼š"æŸ¥è¯¢åœ°çƒçš„å¤©æ°”"
AIå“åº”ï¼š
{
  "role": "assistant",
  "content": "æŠ±æ­‰ï¼Œæˆ‘åªèƒ½æŸ¥è¯¢å…·ä½“åŸå¸‚çš„å¤©æ°”ï¼Œè¯·å‘Šè¯‰æˆ‘åŸå¸‚åç§°ã€‚"
}

# åœºæ™¯3ï¼šå‚æ•°è¶…å‡ºèŒƒå›´
å‡½æ•°å®šä¹‰ï¼šmax_days: 7
ç”¨æˆ·è¾“å…¥ï¼š"æŸ¥è¯¢æœªæ¥30å¤©çš„å¤©æ°”"
AIè¡Œä¸ºï¼š
- æå–ï¼šmax_days = 7ï¼ˆè‡ªåŠ¨é™åˆ¶ï¼‰
- æˆ–æç¤ºï¼š"æœ€å¤šåªèƒ½æŸ¥è¯¢7å¤©"
```


### 2.3 æ¶ˆæ¯æµè½¬æœºåˆ¶

**å®Œæ•´çš„æ¶ˆæ¯äº¤äº’æµç¨‹**ï¼š

```python
# é˜¶æ®µ1ï¼šåˆå§‹å¯¹è¯
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
messages = [
    {
        "role": "user",
        "content": "åŒ—äº¬ä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ"
    }
]

# é˜¶æ®µ2ï¼šç¬¬ä¸€æ¬¡APIè°ƒç”¨
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
response_1 = openai.ChatCompletion.create(
    model="gpt-4",
    messages=messages,
    functions=functions
)

# AIè¿”å›
response_1 = {
    "choices": [{
        "message": {
            "role": "assistant",
            "content": null,  # âš ï¸ æ²¡æœ‰æ–‡æœ¬å›ç­”
            "function_call": {
                "name": "get_weather",
                "arguments": '{"location": "åŒ—äº¬", "unit": "celsius"}'
            }
        }
    }]
}

# é˜¶æ®µ3ï¼šå¼€å‘è€…æ‰§è¡Œå‡½æ•°
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function_call = response_1["choices"][0]["message"]["function_call"]
function_name = function_call["name"]
function_args = json.loads(function_call["arguments"])

# æ‰§è¡Œå®é™…å‡½æ•°
result = get_weather(**function_args)
# result = {"temperature": 25, "condition": "sunny"}

# é˜¶æ®µ4ï¼šæ„å»ºæ–°çš„æ¶ˆæ¯å†å²
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
messages.append(response_1["choices"][0]["message"])  # AIçš„function_call
messages.append({
    "role": "function",
    "name": function_name,
    "content": json.dumps(result)
})

# æ­¤æ—¶messageså˜ä¸ºï¼š
messages = [
    {"role": "user", "content": "åŒ—äº¬ä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ"},
    {
        "role": "assistant",
        "function_call": {
            "name": "get_weather",
            "arguments": '{"location": "åŒ—äº¬"}'
        }
    },
    {
        "role": "function",
        "name": "get_weather",
        "content": '{"temperature": 25, "condition": "sunny"}'
    }
]

# é˜¶æ®µ5ï¼šç¬¬äºŒæ¬¡APIè°ƒç”¨
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
response_2 = openai.ChatCompletion.create(
    model="gpt-4",
    messages=messages  # åŒ…å«å®Œæ•´å†å²
)

# AIè¿”å›æœ€ç»ˆå›ç­”
response_2 = {
    "choices": [{
        "message": {
            "role": "assistant",
            "content": "åŒ—äº¬ä»Šå¤©å¤©æ°”å¾ˆå¥½ï¼æ™´å¤©ï¼Œæ°”æ¸©25Â°Cï¼Œé€‚åˆå¤–å‡ºæ´»åŠ¨ã€‚"
        }
    }]
}
```

**æ¶ˆæ¯è§’è‰²è¯´æ˜**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ role: "user" ï¼ˆç”¨æˆ·æ¶ˆæ¯ï¼‰                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ ç”¨æˆ·çš„è¾“å…¥                                   â”‚
â”‚ â€¢ å¯ä»¥æ˜¯æ–‡æœ¬ã€å›¾ç‰‡ç­‰                           â”‚
â”‚                                                â”‚
â”‚ ç¤ºä¾‹ï¼š                                         â”‚
â”‚ {"role": "user", "content": "å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ"}    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ role: "assistant" ï¼ˆAIæ¶ˆæ¯ï¼‰                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ AIçš„å›å¤                                     â”‚
â”‚ â€¢ å¯ä»¥æ˜¯æ–‡æœ¬å›ç­”                               â”‚
â”‚ â€¢ æˆ–function_callï¼ˆå‡½æ•°è°ƒç”¨è¯·æ±‚ï¼‰              â”‚
â”‚                                                â”‚
â”‚ ç¤ºä¾‹1ï¼ˆæ™®é€šå›ç­”ï¼‰ï¼š                            â”‚
â”‚ {                                              â”‚
â”‚   "role": "assistant",                         â”‚
â”‚   "content": "ä»Šå¤©å¤©æ°”ä¸é”™"                    â”‚
â”‚ }                                              â”‚
â”‚                                                â”‚
â”‚ ç¤ºä¾‹2ï¼ˆå‡½æ•°è°ƒç”¨ï¼‰ï¼š                            â”‚
â”‚ {                                              â”‚
â”‚   "role": "assistant",                         â”‚
â”‚   "function_call": {                           â”‚
â”‚     "name": "get_weather",                     â”‚
â”‚     "arguments": "{...}"                       â”‚
â”‚   }                                            â”‚
â”‚ }                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ role: "function" ï¼ˆå‡½æ•°ç»“æœï¼‰                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ å‡½æ•°æ‰§è¡Œçš„ç»“æœ                               â”‚
â”‚ â€¢ å¿…é¡»åŒ…å«nameå­—æ®µï¼ˆå‡½æ•°åï¼‰                   â”‚
â”‚ â€¢ contentæ˜¯ç»“æœï¼ˆé€šå¸¸æ˜¯JSONå­—ç¬¦ä¸²ï¼‰            â”‚
â”‚                                                â”‚
â”‚ ç¤ºä¾‹ï¼š                                         â”‚
â”‚ {                                              â”‚
â”‚   "role": "function",                          â”‚
â”‚   "name": "get_weather",                       â”‚
â”‚   "content": '{"temp": 25, "condition": ...}'  â”‚
â”‚ }                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ role: "system" ï¼ˆç³»ç»Ÿæ¶ˆæ¯ï¼‰                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ è®¾å®šAIçš„è¡Œä¸ºå’Œè§’è‰²                           â”‚
â”‚ â€¢ é€šå¸¸æ”¾åœ¨messagesæœ€å‰é¢                       â”‚
â”‚                                                â”‚
â”‚ ç¤ºä¾‹ï¼š                                         â”‚
â”‚ {                                              â”‚
â”‚   "role": "system",                            â”‚
â”‚   "content": "ä½ æ˜¯ä¸€ä¸ªå‹å¥½çš„å¤©æ°”åŠ©æ‰‹"          â”‚
â”‚ }                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å¤šè½®å¯¹è¯ç¤ºä¾‹**ï¼š

```python
# å®Œæ•´çš„å¤šè½®å¯¹è¯
messages = []

# Round 1: ç”¨æˆ·è¯¢é—®åŒ—äº¬å¤©æ°”
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
messages.append({"role": "user", "content": "åŒ—äº¬å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ"})

response = call_ai(messages)
# AI: function_call -> get_weather(location="åŒ—äº¬")

messages.append(response.message)  # assistantçš„function_call
result = get_weather("åŒ—äº¬")
messages.append({"role": "function", "name": "get_weather", "content": result})

response = call_ai(messages)
# AI: "åŒ—äº¬ä»Šå¤©æ™´å¤©ï¿½ï¿½ï¿½25Â°C"

messages.append(response.message)  # assistantçš„å›ç­”

# æ­¤æ—¶messages = [
#   user: "åŒ—äº¬å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ",
#   assistant: function_call(get_weather),
#   function: result,
#   assistant: "åŒ—äº¬ä»Šå¤©æ™´å¤©ï¼Œ25Â°C"
# ]

# Round 2: ç”¨æˆ·ç»§ç»­è¯¢é—®ä¸Šæµ·
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
messages.append({"role": "user", "content": "é‚£ä¸Šæµ·å‘¢ï¼Ÿ"})

response = call_ai(messages)
# AIåŸºäºä¸Šä¸‹æ–‡ç†è§£ï¼šç”¨æˆ·æƒ³æŸ¥ä¸Šæµ·å¤©æ°”
# AI: function_call -> get_weather(location="ä¸Šæµ·")

# ... ç»§ç»­ç›¸åŒæµç¨‹
```

### 2.4 function_callæ§åˆ¶å‚æ•°

**æ§åˆ¶AIæ˜¯å¦è°ƒç”¨å‡½æ•°**ï¼š

```python
# 1. function_call="auto" ï¼ˆé»˜è®¤ï¼Œæ¨èï¼‰
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
response = openai.ChatCompletion.create(
    model="gpt-4",
    messages=messages,
    functions=functions,
    function_call="auto"  # AIè‡ªåŠ¨å†³å®š
)
# AIè¡Œä¸ºï¼š
# - å¦‚æœéœ€è¦è°ƒç”¨å‡½æ•° â†’ è¿”å›function_call
# - å¦‚æœä¸éœ€è¦ â†’ ç›´æ¥è¿”å›æ–‡æœ¬å›ç­”

# ç¤ºä¾‹ï¼š
# ç”¨æˆ·ï¼š"ä½ å¥½" â†’ AIç›´æ¥å›ç­”ï¼š"ä½ å¥½ï¼æœ‰ä»€ä¹ˆå¯ä»¥å¸®ä½ çš„ï¼Ÿ"
# ç”¨æˆ·ï¼š"å¤©æ°”" â†’ AIè°ƒç”¨get_weatherå‡½æ•°

# 2. function_call="none"
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
response = openai.ChatCompletion.create(
    functions=functions,
    function_call="none"  # ç¦æ­¢è°ƒç”¨å‡½æ•°
)
# AIè¡Œä¸ºï¼š
# - å³ä½¿å®šä¹‰äº†functionsï¼Œä¹Ÿä¸ä¼šè°ƒç”¨
# - å§‹ç»ˆè¿”å›æ–‡æœ¬å›ç­”

# ä½¿ç”¨åœºæ™¯ï¼š
# - æŸäº›æƒ…å†µä¸‹ä¸æƒ³è®©AIè°ƒç”¨å‡½æ•°
# - åªæƒ³è¦æ–‡æœ¬å¯¹è¯

# 3. function_call={"name": "get_weather"}
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
response = openai.ChatCompletion.create(
    functions=functions,
    function_call={"name": "get_weather"}  # å¼ºåˆ¶è°ƒç”¨æŒ‡å®šå‡½æ•°
)
# AIè¡Œä¸ºï¼š
# - æ— è®ºç”¨æˆ·è¯´ä»€ä¹ˆï¼Œéƒ½è°ƒç”¨get_weather
# - AIä¼šå°½åŠ›ä»è¾“å…¥ä¸­æå–å‚æ•°

# ä½¿ç”¨åœºæ™¯ï¼š
# - æ˜ç¡®çŸ¥é“è¦è°ƒç”¨å“ªä¸ªå‡½æ•°
# - å¼•å¯¼å¼å¯¹è¯ï¼ˆç¡®å®šç”¨æˆ·ä¸€å®šè¦æŸ¥å¤©æ°”ï¼‰

# âš ï¸ é£é™©ï¼š
# ç”¨æˆ·ï¼š"ä»Šå¤©æ˜ŸæœŸå‡ ï¼Ÿ"
# AIå¼ºåˆ¶è°ƒç”¨ï¼šget_weather(location="ä»Šå¤©")  # å¯èƒ½å¾—åˆ°é”™è¯¯å‚æ•°
```

**å¯¹æ¯”**ï¼š

```
åœºæ™¯ï¼šç”¨æˆ·è¯´"ä½ å¥½"

function_call="auto":
â†’ AI: "ä½ å¥½ï¼æœ‰ä»€ä¹ˆå¯ä»¥å¸®ä½ çš„ï¼Ÿ"
âœ… æ­£å¸¸å¯¹è¯

function_call="none":
â†’ AI: "ä½ å¥½ï¼æœ‰ä»€ä¹ˆå¯ä»¥å¸®ä½ çš„ï¼Ÿ"
âœ… æ­£å¸¸å¯¹è¯

function_call={"name": "get_weather"}:
â†’ AI: function_call(get_weather, location="ä½ å¥½")
âŒ å‚æ•°æ— æ„ä¹‰

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

åœºæ™¯ï¼šç”¨æˆ·è¯´"åŒ—äº¬å¤©æ°”"

function_call="auto":
â†’ AI: function_call(get_weather, location="åŒ—äº¬")
âœ… æ™ºèƒ½è°ƒç”¨

function_call="none":
â†’ AI: "æŠ±æ­‰ï¼Œæˆ‘æ— æ³•æŸ¥è¯¢å®æ—¶å¤©æ°”ä¿¡æ¯..."
âŒ æ— æ³•æä¾›å®æ—¶æ•°æ®

function_call={"name": "get_weather"}:
â†’ AI: function_call(get_weather, location="åŒ—äº¬")
âœ… æ­£ç¡®è°ƒç”¨
```

**æœ€ä½³å®è·µ**ï¼š
```python
# âœ… æ¨èï¼šä½¿ç”¨autoï¼Œè®©AIæ™ºèƒ½å†³ç­–
function_call="auto"

# âš ï¸ ç‰¹æ®Šåœºæ™¯ï¼šå¼•å¯¼å¼æµç¨‹
# ä¾‹å¦‚ï¼šå¤©æ°”æŸ¥è¯¢æœºå™¨äººï¼Œç”¨æˆ·ä¸€å®šæ˜¯è¦æŸ¥å¤©æ°”
if user_in_weather_context:
    function_call={"name": "get_weather"}
else:
    function_call="auto"

# âŒ ä¸æ¨èï¼šä¸€ç›´ä½¿ç”¨none
# è¿™æ ·å°±å¤±å»äº†Function Callingçš„æ„ä¹‰
```


---

## 3. æŠ€æœ¯å®ç°

### 3.1 Function Schemaå®šä¹‰è§„èŒƒ

#### 3.1.1 åŸºæœ¬ç»“æ„

```python
{
    "name": "function_name",           # å‡½æ•°åç§°ï¼ˆå¿…å¡«ï¼‰
    "description": "å‡½æ•°æè¿°",          # å‡½æ•°ä½œç”¨ï¼ˆå¿…å¡«ï¼Œè¶Šè¯¦ç»†è¶Šå¥½ï¼‰
    "parameters": {                    # å‚æ•°å®šä¹‰ï¼ˆå¿…å¡«ï¼‰
        "type": "object",              # å›ºå®šä¸ºobject
        "properties": {                # å‚æ•°åˆ—è¡¨
            "param_name": {            # å‚æ•°å
                "type": "string",      # å‚æ•°ç±»å‹
                "description": "...",  # å‚æ•°æè¿°ï¼ˆé‡è¦ï¼ï¼‰
                "enum": [...]          # å¯é€‰ï¼šæšä¸¾å€¼
            }
        },
        "required": ["param_name"]     # å¿…å¡«å‚æ•°åˆ—è¡¨
    }
}
```

#### 3.1.2 å‚æ•°ç±»å‹æ”¯æŒ

```python
# 1. stringï¼ˆå­—ç¬¦ä¸²ï¼‰
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
{
    "location": {
        "type": "string",
        "description": "åŸå¸‚åç§°ï¼Œå¦‚ï¼šåŒ—äº¬ã€ä¸Šæµ·ã€New York"
    }
}

# AIç†è§£ï¼š
# - å¯ä»¥æ¥å—ä»»ä½•æ–‡æœ¬
# - descriptionå¸®åŠ©AIç†è§£æœŸæœ›çš„æ ¼å¼

# 2. numberï¼ˆæ•°å­—ï¼‰
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
{
    "temperature": {
        "type": "number",
        "description": "æ¸©åº¦å€¼ï¼Œå¯ä»¥æ˜¯å°æ•°"
    }
}

# AIç†è§£ï¼š
# - æ¥å—æ•´æ•°æˆ–æµ®ç‚¹æ•°
# - ç”¨æˆ·è¯´"25åº¦" â†’ AIæå–ï¼š25

# 3. integerï¼ˆæ•´æ•°ï¼‰
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
{
    "days": {
        "type": "integer",
        "description": "æŸ¥è¯¢å¤©æ•°ï¼Œ1-7ä¹‹é—´çš„æ•´æ•°"
    }
}

# AIç†è§£ï¼š
# - åªæ¥å—æ•´æ•°
# - ç”¨æˆ·è¯´"3.5å¤©" â†’ AIå¯èƒ½è½¬ä¸ºï¼š3 æˆ– 4

# 4. booleanï¼ˆå¸ƒå°”å€¼ï¼‰
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
{
    "include_forecast": {
        "type": "boolean",
        "description": "æ˜¯å¦åŒ…å«æœªæ¥å¤©æ°”é¢„æŠ¥"
    }
}

# AIç†è§£ï¼š
# - trueæˆ–false
# - ç”¨æˆ·è¯´"è¦é¢„æŠ¥" â†’ AI: true
# - ç”¨æˆ·è¯´"ä¸è¦é¢„æŠ¥" â†’ AI: false

# 5. arrayï¼ˆæ•°ç»„ï¼‰
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
{
    "cities": {
        "type": "array",
        "items": {
            "type": "string"
        },
        "description": "åŸå¸‚åˆ—è¡¨"
    }
}

# AIç†è§£ï¼š
# - æ¥å—å¤šä¸ªå€¼
# - ç”¨æˆ·è¯´"åŒ—äº¬ã€ä¸Šæµ·ã€æ·±åœ³" â†’ AI: ["åŒ—äº¬", "ä¸Šæµ·", "æ·±åœ³"]

# 6. objectï¼ˆå¯¹è±¡ï¼‰
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
{
    "filter": {
        "type": "object",
        "properties": {
            "min_temp": {"type": "number"},
            "max_temp": {"type": "number"}
        },
        "description": "æ¸©åº¦è¿‡æ»¤æ¡ä»¶"
    }
}

# AIç†è§£ï¼š
# - åµŒå¥—ç»“æ„
# - ç”¨æˆ·è¯´"æ¸©åº¦åœ¨20åˆ°30åº¦ä¹‹é—´" â†’ AI: {"min_temp": 20, "max_temp": 30}

# 7. enumï¼ˆæšä¸¾ï¼‰
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
{
    "unit": {
        "type": "string",
        "enum": ["celsius", "fahrenheit", "kelvin"],
        "description": "æ¸©åº¦å•ä½"
    }
}

# AIç†è§£ï¼š
# - åªèƒ½æ˜¯åˆ—å‡ºçš„å€¼ä¹‹ä¸€
# - ç”¨æˆ·è¯´"æ‘„æ°åº¦" â†’ AI: "celsius"
# - ç”¨æˆ·è¯´"åæ°åº¦" â†’ AI: "fahrenheit"
# - ç”¨æˆ·è¯´"å¼€å°”æ–‡" â†’ AI: "kelvin"
# âš ï¸ å¦‚æœç”¨æˆ·è¯´çš„æ— æ³•æ˜ å°„ï¼ŒAIå¯èƒ½è¯¢é—®æˆ–é€‰é»˜è®¤å€¼
```

#### 3.1.3 å®Œæ•´ç¤ºä¾‹

```python
# ç¤ºä¾‹ï¼šå¤æ‚çš„å¤©æ°”æŸ¥è¯¢å‡½æ•°
weather_function = {
    "name": "get_weather_forecast",
    "description": """
    è·å–æŒ‡å®šåŸå¸‚çš„è¯¦ç»†å¤©æ°”é¢„æŠ¥ä¿¡æ¯ã€‚
    æ”¯æŒæŸ¥è¯¢å½“å‰å¤©æ°”å’Œæœªæ¥7å¤©çš„å¤©æ°”é¢„æŠ¥ã€‚
    å¯ä»¥æŒ‡å®šæ¸©åº¦å•ä½å’Œæ˜¯å¦åŒ…å«è¯¦ç»†ä¿¡æ¯ã€‚
    """,
    "parameters": {
        "type": "object",
        "properties": {
            # å¿…å¡«å‚æ•°
            "location": {
                "type": "string",
                "description": "åŸå¸‚åç§°æˆ–é‚®æ”¿ç¼–ç ã€‚ä¾‹å¦‚ï¼šåŒ—äº¬ã€ä¸Šæµ·ã€100000ã€New York"
            },
            
            # å¯é€‰å‚æ•° - æšä¸¾
            "unit": {
                "type": "string",
                "enum": ["celsius", "fahrenheit"],
                "description": "æ¸©åº¦å•ä½ã€‚celsiusè¡¨ç¤ºæ‘„æ°åº¦ï¼Œfahrenheitè¡¨ç¤ºåæ°åº¦ã€‚é»˜è®¤ä¸ºcelsius"
            },
            
            # å¯é€‰å‚æ•° - æ•´æ•°
            "days": {
                "type": "integer",
                "description": "é¢„æŠ¥å¤©æ•°ï¼Œ1-7ä¹‹é—´ã€‚1è¡¨ç¤ºåªæŸ¥å½“å¤©ï¼Œ7è¡¨ç¤ºæŸ¥è¯¢æœªæ¥7å¤©ã€‚é»˜è®¤ä¸º1",
                "minimum": 1,
                "maximum": 7
            },
            
            # å¯é€‰å‚æ•° - å¸ƒå°”
            "detailed": {
                "type": "boolean",
                "description": "æ˜¯å¦è¿”å›è¯¦ç»†ä¿¡æ¯ï¼ˆé£é€Ÿã€æ¹¿åº¦ã€æ°”å‹ç­‰ï¼‰ã€‚é»˜è®¤ä¸ºfalse"
            },
            
            # å¯é€‰å‚æ•° - æ•°ç»„
            "metrics": {
                "type": "array",
                "items": {
                    "type": "string",
                    "enum": ["temperature", "humidity", "wind", "pressure"]
                },
                "description": "éœ€è¦æŸ¥è¯¢çš„å…·ä½“æŒ‡æ ‡ã€‚å¦‚æœä¸æŒ‡å®šï¼Œè¿”å›æ‰€æœ‰æŒ‡æ ‡"
            }
        },
        "required": ["location"]  # åªæœ‰locationæ˜¯å¿…å¡«çš„
    }
}
```

**AIå¦‚ä½•ä½¿ç”¨è¿™ä¸ªschema**ï¼š

```
ç”¨æˆ·è¾“å…¥ï¼š"åŒ—äº¬æœªæ¥3å¤©çš„å¤©æ°”ï¼Œè¦è¯¦ç»†ä¿¡æ¯"

AIåˆ†æï¼š
1. location = "åŒ—äº¬" ï¼ˆä»è¾“å…¥æå–ï¼‰
2. days = 3 ï¼ˆæå–æ•°å­—ï¼‰
3. detailed = true ï¼ˆ"è¦è¯¦ç»†ä¿¡æ¯"â†’trueï¼‰
4. unit = "celsius" ï¼ˆä¸­å›½ç”¨æˆ·é»˜è®¤æ‘„æ°åº¦ï¼‰
5. metrics = æœªæŒ‡å®šï¼Œä¸å¡«

ç”Ÿæˆè°ƒç”¨ï¼š
{
    "name": "get_weather_forecast",
    "arguments": {
        "location": "åŒ—äº¬",
        "days": 3,
        "detailed": true,
        "unit": "celsius"
    }
}
```


#### 3.1.4 Descriptionçš„é‡è¦æ€§

**descriptionæ˜¯AIç†è§£å‡½æ•°çš„å…³é”®ï¼**

```python
# âŒ å·®çš„description
{
    "name": "get_weather",
    "description": "get weather",
    "parameters": {
        "properties": {
            "loc": {
                "type": "string",
                "description": "location"
            }
        }
    }
}

# é—®é¢˜ï¼š
# - descriptionè¿‡äºç®€å•ï¼ŒAIæ— æ³•å……åˆ†ç†è§£
# - å‚æ•°åç¼©å†™ï¼ˆlocï¼‰ï¼Œä¸æ¸…æ™°
# - ç¼ºå°‘ç¤ºä¾‹å’Œæ ¼å¼è¯´æ˜

# âœ… å¥½çš„description
{
    "name": "get_weather",
    "description": """
    è·å–æŒ‡å®šåŸå¸‚çš„å®æ—¶å¤©æ°”ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ¸©åº¦ã€å¤©æ°”çŠ¶å†µã€æ¹¿åº¦ç­‰ã€‚
    
    é€‚ç”¨åœºæ™¯ï¼š
    - ç”¨æˆ·è¯¢é—®æŸåœ°å¤©æ°”
    - ç”¨æˆ·è®¡åˆ’å‡ºè¡Œéœ€è¦å¤©æ°”å‚è€ƒ
    - ç”¨æˆ·å…³å¿ƒå¤©æ°”å˜åŒ–
    
    è¿”å›ä¿¡æ¯åŒ…å«ï¼š
    - å½“å‰æ¸©åº¦
    - å¤©æ°”çŠ¶å†µï¼ˆæ™´/é›¨/é›ªç­‰ï¼‰
    - æ¹¿åº¦ç™¾åˆ†æ¯”
    - é£é€Ÿ
    """,
    "parameters": {
        "properties": {
            "location": {
                "type": "string",
                "description": """
                åŸå¸‚åç§°æˆ–åœ°ç‚¹ã€‚
                
                æ”¯æŒæ ¼å¼ï¼š
                - ä¸­æ–‡åŸå¸‚åï¼šåŒ—äº¬ã€ä¸Šæµ·ã€æ·±åœ³
                - è‹±æ–‡åŸå¸‚åï¼šNew York, London, Tokyo
                - åŸå¸‚+å›½å®¶ï¼šParis, France
                - é‚®æ”¿ç¼–ç ï¼š100000
                
                ç¤ºä¾‹ï¼š
                - "åŒ—äº¬" â†’ æŸ¥è¯¢åŒ—äº¬å¸‚å¤©æ°”
                - "San Francisco" â†’ æŸ¥è¯¢æ—§é‡‘å±±å¤©æ°”
                - "æœé˜³åŒº" â†’ æŸ¥è¯¢åŒ—äº¬æœé˜³åŒºå¤©æ°”
                """
            },
            "unit": {
                "type": "string",
                "enum": ["celsius", "fahrenheit"],
                "description": """
                æ¸©åº¦å•ä½ã€‚
                
                - celsius: æ‘„æ°åº¦ï¼ˆÂ°Cï¼‰ï¼Œé€‚ç”¨äºä¸­å›½ã€æ¬§æ´²ç­‰åœ°åŒº
                - fahrenheit: åæ°åº¦ï¼ˆÂ°Fï¼‰ï¼Œé€‚ç”¨äºç¾å›½ç­‰åœ°åŒº
                
                å¦‚æœç”¨æˆ·æ²¡æœ‰æ˜ç¡®æŒ‡å®šï¼Œæ ¹æ®åœ°åŒºæ¨æ–­ï¼š
                - ä¸­å›½ç”¨æˆ·é»˜è®¤celsius
                - ç¾å›½ç”¨æˆ·é»˜è®¤fahrenheit
                """
            }
        }
    }
}
```

**descriptionçš„æœ€ä½³å®è·µ**ï¼š

```python
âœ… å¥½çš„descriptionç‰¹ç‚¹ï¼š

1. è¯¦ç»†æè¿°åŠŸèƒ½
   "è·å–æŒ‡å®šåŸå¸‚çš„å®æ—¶å¤©æ°”ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ¸©åº¦ã€å¤©æ°”çŠ¶å†µã€æ¹¿åº¦ç­‰"
   
2. è¯´æ˜é€‚ç”¨åœºæ™¯
   "é€‚ç”¨äºç”¨æˆ·è¯¢é—®å¤©æ°”ã€è®¡åˆ’å‡ºè¡Œæ—¶ä½¿ç”¨"
   
3. æä¾›ç¤ºä¾‹
   "ç¤ºä¾‹ï¼š'åŒ—äº¬' â†’ æŸ¥è¯¢åŒ—äº¬å¸‚å¤©æ°”"
   
4. åˆ—å‡ºæ”¯æŒçš„æ ¼å¼
   "æ”¯æŒä¸­æ–‡åŸå¸‚åã€è‹±æ–‡åŸå¸‚åã€é‚®æ”¿ç¼–ç ç­‰æ ¼å¼"
   
5. è¯´æ˜é»˜è®¤è¡Œä¸º
   "å¦‚æœæœªæŒ‡å®šå•ä½ï¼Œä¸­å›½ç”¨æˆ·é»˜è®¤ä½¿ç”¨æ‘„æ°åº¦"
   
6. æ³¨æ˜çº¦æŸæ¡ä»¶
   "dayså‚æ•°èŒƒå›´ï¼š1-7å¤©"

âŒ å·®çš„descriptionï¼š

1. è¿‡äºç®€å•
   "get weather"
   
2. æ²¡æœ‰ç¤ºä¾‹
   "åŸå¸‚åç§°"
   
3. ç¼©å†™å’Œæœ¯è¯­
   "loc"è€Œä¸æ˜¯"location"
   
4. æ²¡æœ‰è¯´æ˜æ ¼å¼
   "æ—¥æœŸ"ï¼ˆä»€ä¹ˆæ ¼å¼ï¼ŸYYYY-MM-DDï¼Ÿè¿˜æ˜¯MM/DD/YYYYï¼Ÿï¼‰
```

### 3.2 å®Œæ•´ä»£ç ç¤ºä¾‹

#### 3.2.1 OpenAI GPT-4ç¤ºä¾‹

```python
import openai
import json
from datetime import datetime

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1. å®šä¹‰å®é™…çš„å‡½æ•°
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def get_current_weather(location: str, unit: str = "celsius") -> dict:
    """
    è·å–å¤©æ°”ä¿¡æ¯ï¼ˆè¿™é‡Œæ˜¯æ¨¡æ‹Ÿï¼Œå®é™…åº”è¯¥è°ƒç”¨å¤©æ°”APIï¼‰
    """
    # æ¨¡æ‹Ÿæ•°æ®
    weather_data = {
        "åŒ—äº¬": {"temp": 25, "condition": "sunny", "humidity": 45},
        "ä¸Šæµ·": {"temp": 28, "condition": "cloudy", "humidity": 65},
        "æ·±åœ³": {"temp": 32, "condition": "rainy", "humidity": 80},
    }
    
    data = weather_data.get(location, {"temp": 20, "condition": "unknown", "humidity": 50})
    
    return {
        "location": location,
        "temperature": data["temp"],
        "unit": unit,
        "condition": data["condition"],
        "humidity": data["humidity"],
        "timestamp": datetime.now().isoformat()
    }

def search_web(query: str, max_results: int = 5) -> dict:
    """
    ç½‘é¡µæœç´¢ï¼ˆæ¨¡æ‹Ÿï¼‰
    """
    return {
        "query": query,
        "results": [
            {"title": f"ç»“æœ {i+1}", "url": f"https://example.com/{i+1}"}
            for i in range(max_results)
        ]
    }

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2. å®šä¹‰Functions Schema
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
functions = [
    {
        "name": "get_current_weather",
        "description": "è·å–æŒ‡å®šåŸå¸‚çš„å½“å‰å¤©æ°”ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ¸©åº¦ã€å¤©æ°”çŠ¶å†µã€æ¹¿åº¦ç­‰",
        "parameters": {
            "type": "object",
            "properties": {
                "location": {
                    "type": "string",
                    "description": "åŸå¸‚åç§°ï¼Œä¾‹å¦‚ï¼šåŒ—äº¬ã€ä¸Šæµ·ã€New York"
                },
                "unit": {
                    "type": "string",
                    "enum": ["celsius", "fahrenheit"],
                    "description": "æ¸©åº¦å•ä½ï¼Œcelsiusä¸ºæ‘„æ°åº¦ï¼Œfahrenheitä¸ºåæ°åº¦"
                }
            },
            "required": ["location"]
        }
    },
    {
        "name": "search_web",
        "description": "åœ¨äº’è”ç½‘ä¸Šæœç´¢ä¿¡æ¯ï¼Œè¿”å›ç›¸å…³ç½‘é¡µåˆ—è¡¨",
        "parameters": {
            "type": "object",
            "properties": {
                "query": {
                    "type": "string",
                    "description": "æœç´¢å…³é”®è¯æˆ–é—®é¢˜"
                },
                "max_results": {
                    "type": "integer",
                    "description": "è¿”å›çš„æœ€å¤§ç»“æœæ•°é‡ï¼Œé»˜è®¤ä¸º5"
                }
            },
            "required": ["query"]
        }
    }
]

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3. å®šä¹‰å‡½æ•°æ‰§è¡Œå™¨
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
available_functions = {
    "get_current_weather": get_current_weather,
    "search_web": search_web
}

def execute_function_call(function_call):
    """æ‰§è¡Œå‡½æ•°è°ƒç”¨"""
    function_name = function_call["name"]
    function_args = json.loads(function_call["arguments"])
    
    function_to_call = available_functions.get(function_name)
    if not function_to_call:
        return {"error": f"Unknown function: {function_name}"}
    
    try:
        result = function_to_call(**function_args)
        return result
    except Exception as e:
        return {"error": str(e)}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 4. ä¸»å¯¹è¯å¾ªç¯
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def chat_with_function_calling(user_message: str):
    """
    ä¸AIå¯¹è¯ï¼Œæ”¯æŒFunction Calling
    """
    messages = [
        {"role": "system", "content": "ä½ æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„åŠ©æ‰‹ï¼Œå¯ä»¥æŸ¥è¯¢å¤©æ°”å’Œæœç´¢ç½‘é¡µã€‚"},
        {"role": "user", "content": user_message}
    ]
    
    print(f"\nç”¨æˆ·: {user_message}")
    print("-" * 50)
    
    # ç¬¬ä¸€æ¬¡è°ƒç”¨ï¼šè®©AIå†³å®šæ˜¯å¦éœ€è¦è°ƒç”¨å‡½æ•°
    response = openai.ChatCompletion.create(
        model="gpt-4-1106-preview",
        messages=messages,
        functions=functions,
        function_call="auto"
    )
    
    message = response.choices[0].message
    
    # æ£€æŸ¥AIæ˜¯å¦è¦è°ƒç”¨å‡½æ•°
    if message.get("function_call"):
        print(f"AIå†³å®šè°ƒç”¨å‡½æ•°: {message['function_call']['name']}")
        print(f"å‚æ•°: {message['function_call']['arguments']}")
        
        # æ‰§è¡Œå‡½æ•°
        function_result = execute_function_call(message["function_call"])
        print(f"å‡½æ•°è¿”å›: {json.dumps(function_result, ensure_ascii=False, indent=2)}")
        
        # å°†å‡½æ•°è°ƒç”¨å’Œç»“æœæ·»åŠ åˆ°æ¶ˆæ¯å†å²
        messages.append(message)
        messages.append({
            "role": "function",
            "name": message["function_call"]["name"],
            "content": json.dumps(function_result, ensure_ascii=False)
        })
        
        # ç¬¬äºŒæ¬¡è°ƒç”¨ï¼šè®©AIåŸºäºå‡½æ•°ç»“æœç”Ÿæˆå›ç­”
        second_response = openai.ChatCompletion.create(
            model="gpt-4-1106-preview",
            messages=messages
        )
        
        final_answer = second_response.choices[0].message["content"]
        print(f"\nAI: {final_answer}")
        
    else:
        # AIç›´æ¥å›ç­”ï¼Œä¸éœ€è¦è°ƒç”¨å‡½æ•°
        print(f"AI: {message['content']}")
    
    return messages

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 5. æµ‹è¯•ç”¨ä¾‹
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if __name__ == "__main__":
    # æµ‹è¯•1ï¼šéœ€è¦è°ƒç”¨å‡½æ•°
    chat_with_function_calling("åŒ—äº¬ä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ")
    
    # æµ‹è¯•2ï¼šéœ€è¦è°ƒç”¨ä¸åŒçš„å‡½æ•°
    chat_with_function_calling("å¸®æˆ‘æœç´¢ä¸€ä¸‹Pythonæ•™ç¨‹")
    
    # æµ‹è¯•3ï¼šæ™®é€šå¯¹è¯ï¼Œä¸éœ€è¦è°ƒç”¨å‡½æ•°
    chat_with_function_calling("ä½ å¥½ï¼Œä½ æ˜¯è°ï¼Ÿ")
    
    # æµ‹è¯•4ï¼šå¤æ‚æ„å›¾è¯†åˆ«
    chat_with_function_calling("æˆ‘æ˜å¤©è¦å»åŒ—äº¬å‡ºå·®ï¼Œéœ€è¦å¸¦ä¼å—ï¼Ÿ")
```

**è¿è¡Œç»“æœç¤ºä¾‹**ï¼š

```
ç”¨æˆ·: åŒ—äº¬ä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ
--------------------------------------------------
AIå†³å®šè°ƒç”¨å‡½æ•°: get_current_weather
å‚æ•°: {"location": "åŒ—äº¬", "unit": "celsius"}
å‡½æ•°è¿”å›: {
  "location": "åŒ—äº¬",
  "temperature": 25,
  "unit": "celsius",
  "condition": "sunny",
  "humidity": 45,
  "timestamp": "2024-10-27T10:30:00"
}

AI: åŒ—äº¬ä»Šå¤©å¤©æ°”å¾ˆå¥½ï¼ç›®å‰æ˜¯æ™´å¤©ï¼Œæ°”æ¸©25Â°Cï¼Œæ¹¿åº¦45%ï¼Œé€‚åˆå¤–å‡ºæ´»åŠ¨ã€‚

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ç”¨æˆ·: å¸®æˆ‘æœç´¢ä¸€ä¸‹Pythonæ•™ç¨‹
--------------------------------------------------
AIå†³å®šè°ƒç”¨å‡½æ•°: search_web
å‚æ•°: {"query": "Pythonæ•™ç¨‹", "max_results": 5}
å‡½æ•°è¿”å›: {
  "query": "Pythonæ•™ç¨‹",
  "results": [
    {"title": "ç»“æœ 1", "url": "https://example.com/1"},
    {"title": "ç»“æœ 2", "url": "https://example.com/2"},
    ...
  ]
}

AI: æˆ‘ä¸ºæ‚¨æ‰¾åˆ°äº†ä¸€äº›Pythonæ•™ç¨‹èµ„æºï¼š
1. ç»“æœ 1 - https://example.com/1
2. ç»“æœ 2 - https://example.com/2
...

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ç”¨æˆ·: ä½ å¥½ï¼Œä½ æ˜¯è°ï¼Ÿ
--------------------------------------------------
AI: ä½ å¥½ï¼æˆ‘æ˜¯ä¸€ä¸ªAIåŠ©æ‰‹ï¼Œå¯ä»¥å¸®ä½ æŸ¥è¯¢å¤©æ°”ä¿¡æ¯ã€æœç´¢ç½‘é¡µç­‰ã€‚æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®ä½ çš„å—ï¼Ÿ
```


#### 3.2.2 Claude Tool Useç¤ºä¾‹

```python
import anthropic
import json

client = anthropic.Anthropic(api_key="your-api-key")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1. å®šä¹‰å·¥å…·Schema
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
tools = [
    {
        "name": "get_weather",
        "description": "è·å–æŒ‡å®šåŸå¸‚çš„å¤©æ°”ä¿¡æ¯",
        "input_schema": {
            "type": "object",
            "properties": {
                "location": {
                    "type": "string",
                    "description": "åŸå¸‚åç§°"
                },
                "unit": {
                    "type": "string",
                    "enum": ["celsius", "fahrenheit"],
                    "description": "æ¸©åº¦å•ä½"
                }
            },
            "required": ["location"]
        }
    },
    {
        "name": "calculate",
        "description": "æ‰§è¡Œæ•°å­¦è®¡ç®—",
        "input_schema": {
            "type": "object",
            "properties": {
                "expression": {
                    "type": "string",
                    "description": "æ•°å­¦è¡¨è¾¾å¼ï¼Œå¦‚ï¼š2 + 2ï¼Œsqrt(16)"
                }
            },
            "required": ["expression"]
        }
    }
]

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2. å®šä¹‰å®é™…å‡½æ•°
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def get_weather(location: str, unit: str = "celsius") -> dict:
    weather_data = {
        "åŒ—äº¬": {"temp": 25, "condition": "sunny"},
        "ä¸Šæµ·": {"temp": 28, "condition": "cloudy"},
    }
    data = weather_data.get(location, {"temp": 20, "condition": "unknown"})
    return {
        "location": location,
        "temperature": data["temp"],
        "unit": unit,
        "condition": data["condition"]
    }

def calculate(expression: str) -> dict:
    try:
        # âš ï¸ ç”Ÿäº§ç¯å¢ƒåº”ä½¿ç”¨å®‰å…¨çš„evalæ›¿ä»£æ–¹æ¡ˆ
        import math
        result = eval(expression, {"__builtins__": {}}, {
            "sqrt": math.sqrt,
            "pow": math.pow,
            "sin": math.sin,
            "cos": math.cos
        })
        return {"result": result}
    except Exception as e:
        return {"error": str(e)}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3. å·¥å…·æ‰§è¡Œå™¨
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def execute_tool(tool_name: str, tool_input: dict) -> str:
    if tool_name == "get_weather":
        result = get_weather(**tool_input)
    elif tool_name == "calculate":
        result = calculate(**tool_input)
    else:
        result = {"error": f"Unknown tool: {tool_name}"}
    
    return json.dumps(result, ensure_ascii=False)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 4. å¯¹è¯å‡½æ•°
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def chat_with_claude(user_message: str):
    print(f"\nç”¨æˆ·: {user_message}")
    print("-" * 50)
    
    messages = [{"role": "user", "content": user_message}]
    
    # ç¬¬ä¸€æ¬¡è°ƒç”¨
    response = client.messages.create(
        model="claude-3-5-sonnet-20241022",
        max_tokens=1024,
        tools=tools,
        messages=messages
    )
    
    print(f"Claudeå“åº”ç±»å‹: {[c.type for c in response.content]}")
    
    # å¤„ç†tool_use
    while response.stop_reason == "tool_use":
        # æå–tool_useå†…å®¹
        tool_uses = [c for c in response.content if c.type == "tool_use"]
        
        # å‡†å¤‡tool_resultæ¶ˆæ¯
        tool_results = []
        for tool_use in tool_uses:
            print(f"\nClaudeè°ƒç”¨å·¥å…·: {tool_use.name}")
            print(f"å‚æ•°: {json.dumps(tool_use.input, ensure_ascii=False)}")
            
            # æ‰§è¡Œå·¥å…·
            result = execute_tool(tool_use.name, tool_use.input)
            print(f"å·¥å…·è¿”å›: {result}")
            
            tool_results.append({
                "type": "tool_result",
                "tool_use_id": tool_use.id,
                "content": result
            })
        
        # å°†assistantæ¶ˆæ¯å’Œtool_resultæ·»åŠ åˆ°å†å²
        messages.append({"role": "assistant", "content": response.content})
        messages.append({"role": "user", "content": tool_results})
        
        # ç»§ç»­å¯¹è¯
        response = client.messages.create(
            model="claude-3-5-sonnet-20241022",
            max_tokens=1024,
            tools=tools,
            messages=messages
        )
    
    # æå–æ–‡æœ¬å›ç­”
    text_content = [c.text for c in response.content if hasattr(c, "text")]
    final_answer = " ".join(text_content)
    
    print(f"\nClaude: {final_answer}")
    return messages

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 5. æµ‹è¯•
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if __name__ == "__main__":
    # æµ‹è¯•1ï¼šå¤©æ°”æŸ¥è¯¢
    chat_with_claude("åŒ—äº¬ä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ")
    
    # æµ‹è¯•2ï¼šæ•°å­¦è®¡ç®—
    chat_with_claude("å¸®æˆ‘è®¡ç®—sqrt(144) + pow(2, 3)")
    
    # æµ‹è¯•3ï¼šå¤šå·¥å…·è°ƒç”¨
    chat_with_claude("åŒ—äº¬å’Œä¸Šæµ·çš„æ¸©åº¦å·®æ˜¯å¤šå°‘ï¼Ÿ")
```

**Claudeä¸OpenAIçš„å·®å¼‚**ï¼š

```python
# OpenAIæ ¼å¼
{
    "function_call": {
        "name": "get_weather",
        "arguments": '{"location": "åŒ—äº¬"}'  # JSONå­—ç¬¦ä¸²
    }
}

# Claudeæ ¼å¼
{
    "type": "tool_use",
    "id": "toolu_123",
    "name": "get_weather",
    "input": {"location": "åŒ—äº¬"}  # ç›´æ¥æ˜¯å¯¹è±¡
}
```


---

## 4. ä¸»æµå¹³å°å¯¹æ¯”

### 4.1 OpenAI Function Calling

**æ”¯æŒæ¨¡å‹**ï¼š
- GPT-4 ç³»åˆ—ï¼ˆæ¨èï¼‰
- GPT-3.5-turboï¼ˆåŸºç¡€æ”¯æŒï¼‰

**æ ¼å¼**ï¼š
```python
# å®šä¹‰
functions = [{
    "name": "function_name",
    "description": "...",
    "parameters": {...}  # JSON Schema
}]

# è°ƒç”¨
openai.ChatCompletion.create(
    model="gpt-4",
    messages=messages,
    functions=functions,
    function_call="auto"  # æˆ–"none"æˆ–{"name": "..."}
)

# è¿”å›
{
    "function_call": {
        "name": "function_name",
        "arguments": "{...}"  # JSONå­—ç¬¦ä¸²
    }
}
```

**ç‰¹ç‚¹**ï¼š
- âœ… æˆç†Ÿç¨³å®šï¼Œæ–‡æ¡£å®Œå–„
- âœ… GPT-4ç†è§£èƒ½åŠ›å¼º
- âœ… æ”¯æŒparallel function callingï¼ˆå¹¶è¡Œè°ƒç”¨å¤šä¸ªå‡½æ•°ï¼‰
- âŒ argumentsè¿”å›å­—ç¬¦ä¸²ï¼Œéœ€è¦json.loads()
- âŒ GPT-3.5æ•ˆæœä¸€èˆ¬

### 4.2 Claude Tool Use

**æ”¯æŒæ¨¡å‹**ï¼š
- Claude 3 Opusï¼ˆæœ€å¼ºï¼‰
- Claude 3 Sonnetï¼ˆå¹³è¡¡ï¼‰
- Claude 3 Haikuï¼ˆå¿«é€Ÿï¼‰

**æ ¼å¼**ï¼š
```python
# å®šä¹‰
tools = [{
    "name": "tool_name",
    "description": "...",
    "input_schema": {...}  # JSON Schema
}]

# è°ƒç”¨
client.messages.create(
    model="claude-3-opus-20240229",
    max_tokens=1024,
    tools=tools,
    messages=messages
)

# è¿”å›
{
    "type": "tool_use",
    "id": "toolu_xxx",
    "name": "tool_name",
    "input": {...}  # ç›´æ¥æ˜¯å¯¹è±¡
}
```

**ç‰¹ç‚¹**ï¼š
- âœ… ç†è§£èƒ½åŠ›å¼ºï¼Œå°¤å…¶æ˜¯å¤æ‚åœºæ™¯
- âœ… inputç›´æ¥æ˜¯å¯¹è±¡ï¼Œä¸éœ€è¦è§£æ
- âœ… æ”¯æŒå¤šè½®tool_use
- âœ… æä¾›tool_use_idæ–¹ä¾¿è¿½è¸ª
- âŒ é€Ÿåº¦ç›¸å¯¹è¾ƒæ…¢
- âŒ tokenæˆæœ¬è¾ƒé«˜

### 4.3 Google Gemini Function Calling

**æ”¯æŒæ¨¡å‹**ï¼š
- Gemini Pro
- Gemini Ultra

**æ ¼å¼**ï¼š
```python
# å®šä¹‰
tools = [{
    "function_declarations": [{
        "name": "function_name",
        "description": "...",
        "parameters": {...}
    }]
}]

# è°ƒç”¨
model.generate_content(
    prompt,
    tools=tools
)

# è¿”å›
{
    "function_call": {
        "name": "function_name",
        "args": {...}
    }
}
```

**ç‰¹ç‚¹**ï¼š
- âœ… å…è´¹ä½¿ç”¨ï¼ˆæœ‰é™é¢ï¼‰
- âœ… é€Ÿåº¦å¿«
- âœ… æ”¯æŒå¤šæ¨¡æ€ï¼ˆå›¾ç‰‡+æ–‡æœ¬ï¼‰
- âŒ ç†è§£èƒ½åŠ›ç¨å¼±
- âŒ æ–‡æ¡£ç›¸å¯¹ä¸å®Œå–„

### 4.4 å¹³å°å¯¹æ¯”æ€»ç»“

| ç‰¹æ€§ | OpenAI | Claude | Gemini |
|------|--------|--------|--------|
| **ç†è§£èƒ½åŠ›** | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­ |
| **å“åº”é€Ÿåº¦** | â­â­â­â­ | â­â­â­ | â­â­â­â­â­ |
| **ä»·æ ¼** | ä¸­ç­‰ | è¾ƒé«˜ | è¾ƒä½/å…è´¹ |
| **æ–‡æ¡£å®Œå–„åº¦** | â­â­â­â­â­ | â­â­â­â­ | â­â­â­ |
| **å‚æ•°æ ¼å¼** | JSONå­—ç¬¦ä¸² | å¯¹è±¡ | å¯¹è±¡ |
| **å¹¶è¡Œè°ƒç”¨** | âœ… | âœ… | âŒ |
| **å¤šæ¨¡æ€** | éƒ¨åˆ†æ”¯æŒ | âœ… | âœ… |
| **ç¨³å®šæ€§** | â­â­â­â­â­ | â­â­â­â­ | â­â­â­ |

**é€‰å‹å»ºè®®**ï¼š

```
ç”Ÿäº§ç¯å¢ƒ â†’ OpenAIï¼ˆGPT-4ï¼‰
- ç¨³å®šæ€§æœ€å¥½
- æ–‡æ¡£å®Œå–„
- ç”Ÿæ€æˆç†Ÿ

å¤æ‚å¯¹è¯ â†’ Claude
- ç†è§£èƒ½åŠ›æœ€å¼º
- é€‚åˆå¤æ‚ä¸šåŠ¡é€»è¾‘
- ä¸Šä¸‹æ–‡çª—å£å¤§

æˆæœ¬æ•æ„Ÿ â†’ Gemini
- å…è´¹ä½¿ç”¨
- é€‚åˆå®éªŒå’Œå¼€å‘
- ç®€å•åœºæ™¯å¤Ÿç”¨

å¤šæ¨¡æ€éœ€æ±‚ â†’ Claudeæˆ–Gemini
- æ”¯æŒå›¾ç‰‡ç†è§£
- å¯ä»¥åŸºäºå›¾ç‰‡è°ƒç”¨å‡½æ•°
```

---

## 5. æœ€ä½³å®è·µ

### 5.1 å‡½æ•°è®¾è®¡åŸåˆ™

#### 5.1.1 å•ä¸€èŒè´£åŸåˆ™

```python
# âŒ ä¸å¥½ï¼šä¸€ä¸ªå‡½æ•°åšå¤ªå¤šäº‹
{
    "name": "handle_user_request",
    "description": "å¤„ç†ç”¨æˆ·è¯·æ±‚ï¼Œå¯ä»¥æŸ¥å¤©æ°”ã€æœç´¢ã€å‘é‚®ä»¶ç­‰",
    "parameters": {
        "action": {"type": "string", "enum": ["weather", "search", "email"]},
        "location": {"type": "string"},  # åªæœ‰weatheréœ€è¦
        "query": {"type": "string"},      # åªæœ‰searchéœ€è¦
        "recipient": {"type": "string"},  # åªæœ‰emailéœ€è¦
        ...
    }
}
# é—®é¢˜ï¼š
# - å‚æ•°æ··ä¹±
# - AIéš¾ä»¥æ­£ç¡®è¯†åˆ«å“ªäº›å‚æ•°æ˜¯å¿…éœ€çš„
# - éš¾ä»¥ç»´æŠ¤

# âœ… å¥½ï¼šæ‹†åˆ†æˆå¤šä¸ªä¸“é—¨çš„å‡½æ•°
[
    {
        "name": "get_weather",
        "description": "è·å–å¤©æ°”ä¿¡æ¯",
        "parameters": {
            "location": {"type": "string"}
        }
    },
    {
        "name": "search_web",
        "description": "æœç´¢ç½‘é¡µ",
        "parameters": {
            "query": {"type": "string"}
        }
    },
    {
        "name": "send_email",
        "description": "å‘é€é‚®ä»¶",
        "parameters": {
            "recipient": {"type": "string"},
            "subject": {"type": "string"},
            "body": {"type": "string"}
        }
    }
]
# ä¼˜ç‚¹ï¼š
# - èŒè´£æ¸…æ™°
# - AIå®¹æ˜“é€‰æ‹©æ­£ç¡®çš„å‡½æ•°
# - å®¹æ˜“æ‰©å±•å’Œç»´æŠ¤
```

#### 5.1.2 å‚æ•°ç®€æ´æ˜äº†

```python
# âŒ ä¸å¥½ï¼šå‚æ•°è¿‡äºå¤æ‚
{
    "name": "get_weather",
    "parameters": {
        "location_info": {
            "type": "object",
            "properties": {
                "city": {"type": "string"},
                "country": {"type": "string"},
                "coordinates": {
                    "type": "object",
                    "properties": {
                        "lat": {"type": "number"},
                        "lng": {"type": "number"}
                    }
                },
                "timezone": {"type": "string"}
            }
        },
        "options": {
            "type": "object",
            "properties": {
                "unit": {"type": "string"},
                "detailed": {"type": "boolean"},
                "forecast_days": {"type": "integer"}
            }
        }
    }
}
# é—®é¢˜ï¼šåµŒå¥—å¤ªæ·±ï¼ŒAIéš¾ä»¥æ­£ç¡®å¡«å……

# âœ… å¥½ï¼šæ‰å¹³åŒ–å‚æ•°
{
    "name": "get_weather",
    "parameters": {
        "location": {
            "type": "string",
            "description": "åŸå¸‚åç§°ï¼Œå¦‚ï¼šåŒ—äº¬ã€New York"
        },
        "unit": {
            "type": "string",
            "enum": ["celsius", "fahrenheit"],
            "description": "æ¸©åº¦å•ä½"
        },
        "days": {
            "type": "integer",
            "description": "é¢„æŠ¥å¤©æ•°ï¼Œ1-7"
        }
    },
    "required": ["location"]
}
# ä¼˜ç‚¹ï¼š
# - ç»“æ„ç®€å•
# - AIå®¹æ˜“ç†è§£å’Œå¡«å……
# - ç”¨æˆ·è¾“å…¥ä¹Ÿç®€å•
```

#### 5.1.3 æä¾›æ¸…æ™°çš„Description

```python
# âŒ ä¸å¥½
{
    "name": "query_db",
    "description": "query database",
    "parameters": {
        "q": {"type": "string", "description": "query"}
    }
}

# âœ… å¥½
{
    "name": "query_product_database",
    "description": """
    æŸ¥è¯¢äº§å“æ•°æ®åº“ï¼Œæ”¯æŒæŒ‰åç§°ã€åˆ†ç±»ã€ä»·æ ¼èŒƒå›´ç­‰æ¡ä»¶æœç´¢äº§å“ã€‚
    
    ä½¿ç”¨åœºæ™¯ï¼š
    - ç”¨æˆ·æƒ³æŸ¥æ‰¾ç‰¹å®šäº§å“
    - ç”¨æˆ·æƒ³æµè§ˆæŸä¸ªåˆ†ç±»çš„äº§å“
    - ç”¨æˆ·æƒ³æ‰¾ä»·æ ¼åœ¨æŸä¸ªèŒƒå›´å†…çš„äº§å“
    
    è¿”å›ä¿¡æ¯ï¼š
    - äº§å“ID
    - äº§å“åç§°
    - ä»·æ ¼
    - åº“å­˜çŠ¶æ€
    """,
    "parameters": {
        "search_query": {
            "type": "string",
            "description": """
            æœç´¢å…³é”®è¯ï¼Œå¯ä»¥æ˜¯äº§å“åç§°çš„ä¸€éƒ¨åˆ†ã€‚
            
            ç¤ºä¾‹ï¼š
            - "iPhone" â†’ æœç´¢æ‰€æœ‰iPhoneäº§å“
            - "ç¬”è®°æœ¬ç”µè„‘" â†’ æœç´¢ç¬”è®°æœ¬ç”µè„‘
            - "è€å…‹" â†’ æœç´¢è€å…‹å“ç‰Œäº§å“
            """
        },
        "category": {
            "type": "string",
            "description": "äº§å“åˆ†ç±»ï¼Œå¦‚ï¼šç”µå­äº§å“ã€æœè£…ã€é£Ÿå“"
        },
        "min_price": {
            "type": "number",
            "description": "æœ€ä½ä»·æ ¼ï¼ˆå…ƒï¼‰"
        },
        "max_price": {
            "type": "number",
            "description": "æœ€é«˜ä»·æ ¼ï¼ˆå…ƒï¼‰"
        }
    }
}
```


### 5.2 é”™è¯¯å¤„ç†

#### 5.2.1 å‡½æ•°æ‰§è¡Œé”™è¯¯

```python
def execute_function_call(function_call):
    """æ‰§è¡Œå‡½æ•°å¹¶å¤„ç†é”™è¯¯"""
    function_name = function_call.get("name")
    
    try:
        # 1. éªŒè¯å‡½æ•°æ˜¯å¦å­˜åœ¨
        if function_name not in available_functions:
            return {
                "error": True,
                "message": f"æœªçŸ¥å‡½æ•°: {function_name}",
                "type": "function_not_found"
            }
        
        # 2. è§£æå‚æ•°
        try:
            function_args = json.loads(function_call.get("arguments", "{}"))
        except json.JSONDecodeError as e:
            return {
                "error": True,
                "message": f"å‚æ•°è§£æå¤±è´¥: {str(e)}",
                "type": "invalid_arguments"
            }
        
        # 3. æ‰§è¡Œå‡½æ•°
        function_to_call = available_functions[function_name]
        result = function_to_call(**function_args)
        
        return {
            "error": False,
            "result": result
        }
        
    except TypeError as e:
        # å‚æ•°ç±»å‹é”™è¯¯
        return {
            "error": True,
            "message": f"å‚æ•°é”™è¯¯: {str(e)}",
            "type": "invalid_parameter_type"
        }
    except Exception as e:
        # å…¶ä»–é”™è¯¯
        return {
            "error": True,
            "message": f"å‡½æ•°æ‰§è¡Œå¤±è´¥: {str(e)}",
            "type": "execution_error"
        }

# ä½¿ç”¨ç¤ºä¾‹
result = execute_function_call(function_call)

if result.get("error"):
    # å°†é”™è¯¯ä¿¡æ¯è¿”å›ç»™AI
    error_message = {
        "role": "function",
        "name": function_call["name"],
        "content": json.dumps({
            "error": result["message"],
            "type": result["type"]
        })
    }
    messages.append(error_message)
    
    # AIä¼šåŸºäºé”™è¯¯ä¿¡æ¯ç”Ÿæˆå‹å¥½çš„å›å¤ç»™ç”¨æˆ·
else:
    # æ­£å¸¸å¤„ç†ç»“æœ
    messages.append({
        "role": "function",
        "name": function_call["name"],
        "content": json.dumps(result["result"])
    })
```

#### 5.2.2 å‚æ•°éªŒè¯

```python
def validate_weather_params(location: str, unit: str = "celsius") -> dict:
    """
    éªŒè¯å¤©æ°”æŸ¥è¯¢å‚æ•°
    è¿”å›: {"valid": bool, "error": str}
    """
    # éªŒè¯location
    if not location or len(location.strip()) == 0:
        return {"valid": False, "error": "åŸå¸‚åç§°ä¸èƒ½ä¸ºç©º"}
    
    if len(location) > 100:
        return {"valid": False, "error": "åŸå¸‚åç§°è¿‡é•¿"}
    
    # éªŒè¯unit
    valid_units = ["celsius", "fahrenheit", "kelvin"]
    if unit not in valid_units:
        return {
            "valid": False,
            "error": f"æ— æ•ˆçš„æ¸©åº¦å•ä½: {unit}ï¼Œæ”¯æŒçš„å•ä½: {', '.join(valid_units)}"
        }
    
    return {"valid": True}

def get_weather(location: str, unit: str = "celsius") -> dict:
    """è·å–å¤©æ°”ï¼ˆå¸¦éªŒè¯ï¼‰"""
    # å‚æ•°éªŒè¯
    validation = validate_weather_params(location, unit)
    if not validation["valid"]:
        return {
            "error": True,
            "message": validation["error"]
        }
    
    # å®é™…æŸ¥è¯¢
    try:
        weather_data = fetch_weather_from_api(location, unit)
        return {
            "error": False,
            "data": weather_data
        }
    except Exception as e:
        return {
            "error": True,
            "message": f"æŸ¥è¯¢å¤©æ°”å¤±è´¥: {str(e)}"
        }
```

### 5.3 æ€§èƒ½ä¼˜åŒ–

#### 5.3.1 å¹¶è¡Œå‡½æ•°è°ƒç”¨ï¼ˆOpenAIï¼‰

```python
# OpenAI GPT-4æ”¯æŒåœ¨ä¸€æ¬¡å“åº”ä¸­è°ƒç”¨å¤šä¸ªå‡½æ•°
response = openai.ChatCompletion.create(
    model="gpt-4-1106-preview",
    messages=[
        {"role": "user", "content": "åŒ—äº¬å’Œä¸Šæµ·çš„å¤©æ°”åˆ†åˆ«æ˜¯ä»€ä¹ˆï¼Ÿ"}
    ],
    functions=functions
)

# AIå¯èƒ½è¿”å›å¤šä¸ªfunction_call
# æ£€æŸ¥æ˜¯å¦æœ‰å¤šä¸ªå‡½æ•°è°ƒç”¨
message = response.choices[0].message

if hasattr(message, "tool_calls"):  # æ–°ç‰ˆAPI
    # å¹¶è¡Œæ‰§è¡Œæ‰€æœ‰å‡½æ•°è°ƒç”¨
    tool_results = []
    for tool_call in message.tool_calls:
        result = execute_function_call(tool_call.function)
        tool_results.append({
            "role": "tool",
            "tool_call_id": tool_call.id,
            "content": json.dumps(result)
        })
    
    # ä¸€æ¬¡æ€§è¿”å›æ‰€æœ‰ç»“æœ
    messages.append(message)
    messages.extend(tool_results)
```

#### 5.3.2 ç¼“å­˜å‡½æ•°ç»“æœ

```python
from functools import lru_cache
from datetime import datetime, timedelta

# ç¼“å­˜å¤©æ°”æ•°æ®ï¼ˆ5åˆ†é’Ÿæœ‰æ•ˆï¼‰
weather_cache = {}

def get_weather_with_cache(location: str, unit: str = "celsius") -> dict:
    """å¸¦ç¼“å­˜çš„å¤©æ°”æŸ¥è¯¢"""
    cache_key = f"{location}_{unit}"
    
    # æ£€æŸ¥ç¼“å­˜
    if cache_key in weather_cache:
        cached_data, cached_time = weather_cache[cache_key]
        # å¦‚æœç¼“å­˜åœ¨5åˆ†é’Ÿå†…ï¼Œç›´æ¥è¿”å›
        if datetime.now() - cached_time < timedelta(minutes=5):
            return cached_data
    
    # æŸ¥è¯¢æ–°æ•°æ®
    weather_data = fetch_weather_from_api(location, unit)
    
    # æ›´æ–°ç¼“å­˜
    weather_cache[cache_key] = (weather_data, datetime.now())
    
    return weather_data
```

#### 5.3.3 è¶…æ—¶æ§åˆ¶

```python
import signal
from contextlib import contextmanager

@contextmanager
def timeout(seconds):
    """å‡½æ•°æ‰§è¡Œè¶…æ—¶æ§åˆ¶"""
    def timeout_handler(signum, frame):
        raise TimeoutError(f"å‡½æ•°æ‰§è¡Œè¶…è¿‡{seconds}ç§’")
    
    # è®¾ç½®ä¿¡å·å¤„ç†å™¨
    old_handler = signal.signal(signal.SIGALRM, timeout_handler)
    signal.alarm(seconds)
    
    try:
        yield
    finally:
        signal.alarm(0)
        signal.signal(signal.SIGALRM, old_handler)

def get_weather(location: str, unit: str = "celsius") -> dict:
    """å¸¦è¶…æ—¶çš„å¤©æ°”æŸ¥è¯¢"""
    try:
        with timeout(5):  # 5ç§’è¶…æ—¶
            return fetch_weather_from_api(location, unit)
    except TimeoutError as e:
        return {
            "error": True,
            "message": f"æŸ¥è¯¢è¶…æ—¶: {str(e)}"
        }
```

### 5.4 å®‰å…¨æ€§

#### 5.4.1 å‚æ•°ç™½åå•éªŒè¯

```python
# å®šä¹‰å…è®¸çš„åŸå¸‚åˆ—è¡¨
ALLOWED_CITIES = [
    "åŒ—äº¬", "ä¸Šæµ·", "æ·±åœ³", "å¹¿å·",
    "New York", "London", "Tokyo", "Paris"
]

def get_weather(location: str, unit: str = "celsius") -> dict:
    """å¸¦ç™½åå•éªŒè¯çš„å¤©æ°”æŸ¥è¯¢"""
    # ç™½åå•æ£€æŸ¥
    if location not in ALLOWED_CITIES:
        return {
            "error": True,
            "message": f"ä¸æ”¯æŒæŸ¥è¯¢{location}çš„å¤©æ°”ï¼Œæ”¯æŒçš„åŸå¸‚: {', '.join(ALLOWED_CITIES)}"
        }
    
    # æ­£å¸¸æŸ¥è¯¢
    return fetch_weather_from_api(location, unit)
```

#### 5.4.2 æ•æ„Ÿæ“ä½œç¡®è®¤

```python
def send_email(recipient: str, subject: str, body: str) -> dict:
    """å‘é€é‚®ä»¶ï¼ˆéœ€è¦ç¡®è®¤ï¼‰"""
    # æ•æ„Ÿæ“ä½œè®°å½•
    import logging
    logging.info(f"å°è¯•å‘é€é‚®ä»¶: to={recipient}, subject={subject}")
    
    # éªŒè¯é‚®ç®±æ ¼å¼
    import re
    email_pattern = r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'
    if not re.match(email_pattern, recipient):
        return {
            "error": True,
            "message": "æ— æ•ˆçš„é‚®ç®±åœ°å€"
        }
    
    # å†…å®¹é•¿åº¦é™åˆ¶
    if len(body) > 10000:
        return {
            "error": True,
            "message": "é‚®ä»¶å†…å®¹è¿‡é•¿ï¼ˆæœ€å¤š10000å­—ç¬¦ï¼‰"
        }
    
    # å®é™…å‘é€ï¼ˆè¿™é‡Œåº”è¯¥æœ‰é¢å¤–çš„ç¡®è®¤æœºåˆ¶ï¼‰
    try:
        send_email_via_api(recipient, subject, body)
        return {
            "success": True,
            "message": f"é‚®ä»¶å·²å‘é€åˆ°{recipient}"
        }
    except Exception as e:
        return {
            "error": True,
            "message": f"å‘é€å¤±è´¥: {str(e)}"
        }
```

#### 5.4.3 æƒé™æ§åˆ¶

```python
# å®šä¹‰å‡½æ•°æƒé™çº§åˆ«
FUNCTION_PERMISSIONS = {
    "get_weather": "read",      # åªè¯»æ“ä½œ
    "search_web": "read",       # åªè¯»æ“ä½œ
    "send_email": "write",      # å†™æ“ä½œ
    "delete_user": "admin"      # ç®¡ç†å‘˜æ“ä½œ
}

def check_permission(user_role: str, function_name: str) -> bool:
    """æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æƒé™æ‰§è¡Œå‡½æ•°"""
    required_permission = FUNCTION_PERMISSIONS.get(function_name, "admin")
    
    role_hierarchy = {
        "admin": ["admin", "write", "read"],
        "user": ["write", "read"],
        "guest": ["read"]
    }
    
    allowed = role_hierarchy.get(user_role, [])
    return required_permission in allowed

def execute_function_call(function_call, user_role="guest"):
    """å¸¦æƒé™æ£€æŸ¥çš„å‡½æ•°æ‰§è¡Œ"""
    function_name = function_call["name"]
    
    # æƒé™æ£€æŸ¥
    if not check_permission(user_role, function_name):
        return {
            "error": True,
            "message": f"æƒé™ä¸è¶³ï¼Œæ— æ³•æ‰§è¡Œ{function_name}",
            "required_permission": FUNCTION_PERMISSIONS[function_name]
        }
    
    # æ‰§è¡Œå‡½æ•°...
```


---

## 6. å¸¸è§é—®é¢˜

### 6.1 AIä¸ºä»€ä¹ˆä¸è°ƒç”¨å‡½æ•°ï¼Ÿ

**å¯èƒ½åŸå› **ï¼š

```python
# 1. descriptionä¸æ¸…æ™°
# âŒ é—®é¢˜
{
    "name": "get_weather",
    "description": "get weather"  # å¤ªç®€å•
}

# âœ… è§£å†³
{
    "name": "get_weather",
    "description": "è·å–æŒ‡å®šåŸå¸‚çš„å®æ—¶å¤©æ°”ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ¸©åº¦ã€å¤©æ°”çŠ¶å†µã€æ¹¿åº¦ç­‰ã€‚é€‚ç”¨äºç”¨æˆ·è¯¢é—®å¤©æ°”ç›¸å…³çš„é—®é¢˜ã€‚"
}

# 2. å‡½æ•°åä¸å¤Ÿè¯­ä¹‰åŒ–
# âŒ é—®é¢˜
{
    "name": "func1",  # æ— æ„ä¹‰çš„åå­—
    "description": "..."
}

# âœ… è§£å†³
{
    "name": "get_current_weather",  # æ¸…æ™°æ˜ç¡®
    "description": "..."
}

# 3. ç”¨æˆ·æ„å›¾ä¸æ˜ç¡®
ç”¨æˆ·ï¼š"å¤©æ°”"
# AIå¯èƒ½æ— æ³•ç¡®å®šè¦æŸ¥è¯¢å“ªä¸ªåŸå¸‚

# âœ… è§£å†³ï¼šå¼•å¯¼ç”¨æˆ·
if not location_in_user_input:
    AI: "è¯·é—®æ‚¨æƒ³æŸ¥è¯¢å“ªä¸ªåŸå¸‚çš„å¤©æ°”ï¼Ÿ"

# 4. function_callè®¾ç½®ä¸º"none"
response = openai.ChatCompletion.create(
    functions=functions,
    function_call="none"  # âŒ ç¦æ­¢äº†å‡½æ•°è°ƒç”¨
)

# âœ… è§£å†³
function_call="auto"  # è®©AIè‡ªåŠ¨å†³å®š
```

### 6.2 AIè°ƒç”¨äº†é”™è¯¯çš„å‡½æ•°

**è°ƒè¯•æ–¹æ³•**ï¼š

```python
# 1. æ£€æŸ¥functionsåˆ—è¡¨
print("å¯ç”¨å‡½æ•°:")
for func in functions:
    print(f"- {func['name']}: {func['description']}")

# 2. æ·»åŠ æ—¥å¿—
response = openai.ChatCompletion.create(...)
message = response.choices[0].message

if message.get("function_call"):
    print(f"AIé€‰æ‹©çš„å‡½æ•°: {message['function_call']['name']}")
    print(f"åŸå› åˆ†æ: å¯èƒ½æ˜¯å› ä¸º...")

# 3. ä¼˜åŒ–descriptionï¼Œæ˜ç¡®åŒºåˆ†
functions = [
    {
        "name": "get_weather",
        "description": "è·å–å¤©æ°”ä¿¡æ¯ã€‚ä»…åœ¨ç”¨æˆ·æ˜ç¡®è¯¢é—®å¤©æ°”æ—¶ä½¿ç”¨ã€‚å…³é”®è¯ï¼šå¤©æ°”ã€æ°”æ¸©ã€ä¸‹é›¨ã€æ™´å¤©ç­‰"
    },
    {
        "name": "search_web",
        "description": "æœç´¢ç½‘é¡µã€‚åœ¨éœ€è¦æŸ¥æ‰¾ç½‘ç»œä¿¡æ¯æ—¶ä½¿ç”¨ã€‚å…³é”®è¯ï¼šæœç´¢ã€æŸ¥æ‰¾ã€ä»€ä¹ˆæ˜¯ã€äº†è§£ç­‰"
    }
]

# 4. ä½¿ç”¨ç¤ºä¾‹å¢å¼ºç†è§£
{
    "name": "get_weather",
    "description": """
    è·å–å¤©æ°”ä¿¡æ¯
    
    é€‚ç”¨åœºæ™¯ï¼š
    - "åŒ—äº¬å¤©æ°”æ€ä¹ˆæ ·" âœ“
    - "æ˜å¤©ä¼šä¸‹é›¨å—" âœ“
    - "æ°”æ¸©å¤šå°‘åº¦" âœ“
    
    ä¸é€‚ç”¨åœºæ™¯ï¼š
    - "æœç´¢å¤©æ°”é¢„æŠ¥ç½‘ç«™" âœ— (åº”è¯¥ç”¨search_web)
    - "ä»€ä¹ˆæ˜¯å¤©æ°”" âœ— (åº”è¯¥ç”¨search_web)
    """
}
```

### 6.3 å‚æ•°æå–é”™è¯¯

**å¸¸è§é—®é¢˜**ï¼š

```python
# é—®é¢˜1ï¼šAIæ²¡æœ‰æå–åˆ°å‚æ•°
ç”¨æˆ·ï¼š"åŒ—äº¬å¤©æ°”"
AIè¿”å›ï¼š{"location": ""}  # âŒ ç©ºå€¼

# åŸå› ï¼šdescriptionä¸å¤Ÿè¯¦ç»†
{
    "location": {
        "type": "string",
        "description": "location"  # å¤ªç®€å•
    }
}

# è§£å†³ï¼š
{
    "location": {
        "type": "string",
        "description": "åŸå¸‚åç§°ï¼Œä»ç”¨æˆ·è¾“å…¥ä¸­æå–ã€‚ä¾‹å¦‚ï¼šç”¨æˆ·è¯´'åŒ—äº¬å¤©æ°”'ï¼Œåˆ™æå–'åŒ—äº¬'"
    }
}

# é—®é¢˜2ï¼šå‚æ•°ç±»å‹ä¸åŒ¹é…
ç”¨æˆ·ï¼š"æŸ¥è¯¢3å¤©çš„å¤©æ°”"
AIè¿”å›ï¼š{"days": "3"}  # âŒ åº”è¯¥æ˜¯æ•°å­—

# è§£å†³ï¼šå¼ºè°ƒç±»å‹
{
    "days": {
        "type": "integer",  # æ˜ç¡®æŒ‡å®šinteger
        "description": "å¤©æ•°ï¼Œå¿…é¡»æ˜¯æ•´æ•°ã€‚ä¾‹å¦‚ï¼šç”¨æˆ·è¯´'3å¤©'ï¼Œæå–æ•°å­—3"
    }
}

# é—®é¢˜3ï¼šç†è§£é”™è¯¯
ç”¨æˆ·ï¼š"å¸®æˆ‘çœ‹çœ‹å¸éƒ½çš„å¤©æ°”"
AIè¿”å›ï¼š{"location": "å¸éƒ½"}  # âŒ åº”è¯¥ç†è§£ä¸º"åŒ—äº¬"

# è§£å†³ï¼šåœ¨å‡½æ•°å†…éƒ¨å¤„ç†
def get_weather(location: str, unit: str = "celsius") -> dict:
    # åŸå¸‚åˆ«åæ˜ å°„
    city_aliases = {
        "å¸éƒ½": "åŒ—äº¬",
        "é­”éƒ½": "ä¸Šæµ·",
        "BJ": "åŒ—äº¬",
        "SH": "ä¸Šæµ·"
    }
    
    # æ ‡å‡†åŒ–åŸå¸‚å
    location = city_aliases.get(location, location)
    
    # ç»§ç»­æŸ¥è¯¢...
```

### 6.4 å¦‚ä½•å¤„ç†å¤šè½®å¯¹è¯ï¼Ÿ

**å®Œæ•´ç¤ºä¾‹**ï¼š

```python
class ChatSession:
    def __init__(self):
        self.messages = [
            {"role": "system", "content": "ä½ æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„åŠ©æ‰‹"}
        ]
    
    def chat(self, user_input: str) -> str:
        """å¤„ç†ä¸€è½®å¯¹è¯"""
        # æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
        self.messages.append({
            "role": "user",
            "content": user_input
        })
        
        # è°ƒç”¨AI
        response = openai.ChatCompletion.create(
            model="gpt-4",
            messages=self.messages,
            functions=functions,
            function_call="auto"
        )
        
        message = response.choices[0].message
        
        # å¤„ç†å‡½æ•°è°ƒç”¨
        if message.get("function_call"):
            # æ‰§è¡Œå‡½æ•°
            result = execute_function_call(message["function_call"])
            
            # æ·»åŠ åˆ°å†å²
            self.messages.append(message)
            self.messages.append({
                "role": "function",
                "name": message["function_call"]["name"],
                "content": json.dumps(result)
            })
            
            # å†æ¬¡è°ƒç”¨AIè·å–æœ€ç»ˆå›ç­”
            second_response = openai.ChatCompletion.create(
                model="gpt-4",
                messages=self.messages
            )
            
            final_message = second_response.choices[0].message
            self.messages.append(final_message)
            
            return final_message["content"]
        else:
            # ç›´æ¥å›ç­”
            self.messages.append(message)
            return message["content"]

# ä½¿ç”¨
session = ChatSession()

# Round 1
print(session.chat("åŒ—äº¬å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ"))
# AI: "åŒ—äº¬ä»Šå¤©æ™´å¤©ï¼Œ25Â°C"

# Round 2: AIèƒ½è®°ä½ä¸Šä¸‹æ–‡
print(session.chat("é‚£ä¸Šæµ·å‘¢ï¼Ÿ"))
# AIç†è§£ï¼šç”¨æˆ·æƒ³æŸ¥ä¸Šæµ·çš„å¤©æ°”
# AI: "ä¸Šæµ·ä»Šå¤©å¤šäº‘ï¼Œ28Â°C"

# Round 3
print(session.chat("å“ªä¸ªåŸå¸‚æ›´çƒ­ï¼Ÿ"))
# AIåŸºäºä¹‹å‰çš„æ•°æ®å›ç­”
# AI: "ä¸Šæµ·æ›´çƒ­ï¼Œ28Â°Cæ¯”åŒ—äº¬çš„25Â°Cé«˜3åº¦"
```

### 6.5 å¦‚ä½•é™åˆ¶AIçš„å‡½æ•°è°ƒç”¨ï¼Ÿ

```python
# æ–¹æ³•1ï¼šåŠ¨æ€æ§åˆ¶function_callå‚æ•°
def chat_with_control(user_input: str, allow_functions: bool = True):
    if allow_functions:
        function_call = "auto"
    else:
        function_call = "none"  # ç¦æ­¢è°ƒç”¨å‡½æ•°
    
    response = openai.ChatCompletion.create(
        model="gpt-4",
        messages=[{"role": "user", "content": user_input}],
        functions=functions,
        function_call=function_call
    )

# æ–¹æ³•2ï¼šåŠ¨æ€æä¾›å‡½æ•°åˆ—è¡¨
def chat_with_selective_functions(user_input: str, allowed_functions: list):
    # åªæä¾›å…è®¸çš„å‡½æ•°
    filtered_functions = [
        f for f in all_functions
        if f["name"] in allowed_functions
    ]
    
    response = openai.ChatCompletion.create(
        model="gpt-4",
        messages=[{"role": "user", "content": user_input}],
        functions=filtered_functions
    )

# ä½¿ç”¨
# åœºæ™¯1ï¼šåªå…è®¸æŸ¥å¤©æ°”
chat_with_selective_functions("...", allowed_functions=["get_weather"])

# åœºæ™¯2ï¼šå…è®¸æŸ¥å¤©æ°”å’Œæœç´¢
chat_with_selective_functions("...", allowed_functions=["get_weather", "search_web"])

# æ–¹æ³•3ï¼šåŸºäºç”¨æˆ·è§’è‰²
def chat_with_role_based_functions(user_input: str, user_role: str):
    # æ ¹æ®è§’è‰²æä¾›ä¸åŒçš„å‡½æ•°
    role_functions = {
        "guest": ["get_weather", "search_web"],
        "user": ["get_weather", "search_web", "send_email"],
        "admin": ["get_weather", "search_web", "send_email", "delete_data"]
    }
    
    allowed = role_functions.get(user_role, [])
    filtered_functions = [f for f in all_functions if f["name"] in allowed]
    
    response = openai.ChatCompletion.create(
        model="gpt-4",
        messages=[{"role": "user", "content": user_input}],
        functions=filtered_functions
    )
```

### 6.6 å‡½æ•°æ‰§è¡Œå¤±è´¥æ€ä¹ˆåŠï¼Ÿ

```python
def execute_with_retry(function_call, max_retries=3):
    """å¸¦é‡è¯•çš„å‡½æ•°æ‰§è¡Œ"""
    for attempt in range(max_retries):
        try:
            result = execute_function_call(function_call)
            
            # å¦‚æœæˆåŠŸï¼Œè¿”å›ç»“æœ
            if not result.get("error"):
                return result
            
            # å¦‚æœæ˜¯å¯é‡è¯•çš„é”™è¯¯
            if result.get("retry"):
                time.sleep(2 ** attempt)  # æŒ‡æ•°é€€é¿
                continue
            else:
                # ä¸å¯é‡è¯•ï¼Œç›´æ¥è¿”å›é”™è¯¯
                return result
                
        except Exception as e:
            if attempt == max_retries - 1:
                # æœ€åä¸€æ¬¡å°è¯•å¤±è´¥
                return {
                    "error": True,
                    "message": f"å‡½æ•°æ‰§è¡Œå¤±è´¥ï¼ˆé‡è¯•{max_retries}æ¬¡åï¼‰: {str(e)}"
                }
            time.sleep(2 ** attempt)
    
    return {
        "error": True,
        "message": f"å‡½æ•°æ‰§è¡Œå¤±è´¥ï¼ˆè¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°{max_retries}ï¼‰"
    }

# å°†é”™è¯¯å‹å¥½åœ°è¿”å›ç»™AI
result = execute_with_retry(function_call)

if result.get("error"):
    # è®©AIåŸºäºé”™è¯¯ç”Ÿæˆå‹å¥½çš„å›å¤
    messages.append({
        "role": "function",
        "name": function_call["name"],
        "content": json.dumps({
            "error": result["message"],
            "suggestion": "è¯·ç¨åå†è¯•ï¼Œæˆ–è€…æ¢ä¸€ä¸ªåŸå¸‚æŸ¥è¯¢"
        })
    })
    
    # AIä¼šç”Ÿæˆç±»ä¼¼è¿™æ ·çš„å›å¤ï¼š
    # "æŠ±æ­‰ï¼Œæš‚æ—¶æ— æ³•æŸ¥è¯¢å¤©æ°”ä¿¡æ¯ï¼Œè¯·ç¨åå†è¯•æˆ–è€…å‘Šè¯‰æˆ‘å…¶ä»–åŸå¸‚"
```


---

## 7. å®æˆ˜æ¡ˆä¾‹

### 7.1 æ™ºèƒ½å®¢æœç³»ç»Ÿ

```python
import openai
import json
from typing import Dict, List

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1. å®šä¹‰ä¸šåŠ¡å‡½æ•°
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def query_order_status(order_id: str) -> dict:
    """æŸ¥è¯¢è®¢å•çŠ¶æ€"""
    # æ¨¡æ‹Ÿæ•°æ®åº“æŸ¥è¯¢
    orders = {
        "ORD001": {"status": "å·²å‘è´§", "tracking": "SF1234567890"},
        "ORD002": {"status": "å¤„ç†ä¸­", "tracking": None},
        "ORD003": {"status": "å·²å®Œæˆ", "tracking": "YT9876543210"}
    }
    
    if order_id in orders:
        return {
            "order_id": order_id,
            "status": orders[order_id]["status"],
            "tracking_number": orders[order_id]["tracking"]
        }
    else:
        return {"error": "è®¢å•ä¸å­˜åœ¨"}

def query_product_info(product_name: str) -> dict:
    """æŸ¥è¯¢äº§å“ä¿¡æ¯"""
    products = {
        "iPhone 15": {
            "name": "iPhone 15",
            "price": 5999,
            "stock": 100,
            "description": "Appleæœ€æ–°æ¬¾æ‰‹æœº"
        },
        "MacBook Pro": {
            "name": "MacBook Pro 14è‹±å¯¸",
            "price": 14999,
            "stock": 50,
            "description": "M3èŠ¯ç‰‡ï¼Œä¸“ä¸šçº§ç¬”è®°æœ¬"
        }
    }
    
    # æ¨¡ç³ŠåŒ¹é…
    for key, product in products.items():
        if product_name.lower() in key.lower():
            return product
    
    return {"error": "æœªæ‰¾åˆ°äº§å“"}

def create_ticket(issue_type: str, description: str, priority: str = "normal") -> dict:
    """åˆ›å»ºå·¥å•"""
    import uuid
    ticket_id = str(uuid.uuid4())[:8]
    
    return {
        "ticket_id": ticket_id,
        "issue_type": issue_type,
        "description": description,
        "priority": priority,
        "status": "å·²åˆ›å»º",
        "message": "å·¥å•å·²åˆ›å»ºï¼Œå®¢æœä¼šåœ¨24å°æ—¶å†…å›å¤"
    }

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2. å®šä¹‰Functions Schema
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
customer_service_functions = [
    {
        "name": "query_order_status",
        "description": """
        æŸ¥è¯¢è®¢å•çŠ¶æ€å’Œç‰©æµä¿¡æ¯ã€‚
        é€‚ç”¨äºç”¨æˆ·è¯¢é—®è®¢å•ç›¸å…³é—®é¢˜ï¼Œå¦‚ï¼š"æˆ‘çš„è®¢å•æ€ä¹ˆæ ·äº†"ã€"è®¢å•å‘è´§äº†å—"ã€"ç‰©æµå•å·æ˜¯å¤šå°‘"ç­‰ã€‚
        """,
        "parameters": {
            "type": "object",
            "properties": {
                "order_id": {
                    "type": "string",
                    "description": "è®¢å•å·ï¼Œæ ¼å¼é€šå¸¸ä¸ºORDå¼€å¤´çš„ç¼–å·ï¼Œå¦‚ï¼šORD001"
                }
            },
            "required": ["order_id"]
        }
    },
    {
        "name": "query_product_info",
        "description": """
        æŸ¥è¯¢äº§å“çš„ä»·æ ¼ã€åº“å­˜å’Œè¯¦ç»†ä¿¡æ¯ã€‚
        é€‚ç”¨äºç”¨æˆ·è¯¢é—®äº§å“ç›¸å…³é—®é¢˜ï¼Œå¦‚ï¼š"iPhoneå¤šå°‘é’±"ã€"æœ‰è´§å—"ã€"äº§å“å‚æ•°æ˜¯ä»€ä¹ˆ"ç­‰ã€‚
        """,
        "parameters": {
            "type": "object",
            "properties": {
                "product_name": {
                    "type": "string",
                    "description": "äº§å“åç§°æˆ–å…³é”®è¯ï¼Œå¦‚ï¼šiPhoneã€MacBookã€ç¬”è®°æœ¬"
                }
            },
            "required": ["product_name"]
        }
    },
    {
        "name": "create_ticket",
        "description": """
        åˆ›å»ºå®¢æœå·¥å•ï¼Œç”¨äºå¤„ç†å¤æ‚é—®é¢˜æˆ–æŠ•è¯‰ã€‚
        é€‚ç”¨äºæ— æ³•ç›´æ¥è§£å†³çš„é—®é¢˜ï¼Œå¦‚ï¼šé€€è´§ã€æ¢è´§ã€æŠ•è¯‰ã€ç‰¹æ®Šéœ€æ±‚ç­‰ã€‚
        """,
        "parameters": {
            "type": "object",
            "properties": {
                "issue_type": {
                    "type": "string",
                    "enum": ["é€€è´§", "æ¢è´§", "æŠ•è¯‰", "å’¨è¯¢", "å…¶ä»–"],
                    "description": "é—®é¢˜ç±»å‹"
                },
                "description": {
                    "type": "string",
                    "description": "é—®é¢˜è¯¦ç»†æè¿°"
                },
                "priority": {
                    "type": "string",
                    "enum": ["low", "normal", "high", "urgent"],
                    "description": "ä¼˜å…ˆçº§ï¼Œé»˜è®¤ä¸ºnormal"
                }
            },
            "required": ["issue_type", "description"]
        }
    }
]

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3. æ™ºèƒ½å®¢æœç±»
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
class SmartCustomerService:
    def __init__(self):
        self.functions_map = {
            "query_order_status": query_order_status,
            "query_product_info": query_product_info,
            "create_ticket": create_ticket
        }
        
        self.conversation_history = []
    
    def handle_customer_query(self, user_message: str) -> str:
        """å¤„ç†å®¢æˆ·å’¨è¯¢"""
        # ç³»ç»Ÿæç¤º
        if not self.conversation_history:
            self.conversation_history.append({
                "role": "system",
                "content": """
                ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç”µå•†å®¢æœåŠ©æ‰‹ã€‚
                - ç¤¼è²Œã€å‹å¥½ã€ä¸“ä¸š
                - èƒ½å¤ŸæŸ¥è¯¢è®¢å•ã€äº§å“ä¿¡æ¯
                - é‡åˆ°æ— æ³•è§£å†³çš„é—®é¢˜ï¼Œåˆ›å»ºå·¥å•
                - ä½¿ç”¨ç®€æ´æ¸…æ™°çš„è¯­è¨€
                """
            })
        
        # æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
        self.conversation_history.append({
            "role": "user",
            "content": user_message
        })
        
        # è°ƒç”¨AI
        response = openai.ChatCompletion.create(
            model="gpt-4",
            messages=self.conversation_history,
            functions=customer_service_functions,
            function_call="auto"
        )
        
        message = response.choices[0].message
        
        # å¤„ç†å‡½æ•°è°ƒç”¨
        if message.get("function_call"):
            function_call = message["function_call"]
            function_name = function_call["name"]
            function_args = json.loads(function_call["arguments"])
            
            print(f"[ç³»ç»Ÿ] è°ƒç”¨å‡½æ•°: {function_name}({function_args})")
            
            # æ‰§è¡Œå‡½æ•°
            function_to_call = self.functions_map[function_name]
            result = function_to_call(**function_args)
            
            print(f"[ç³»ç»Ÿ] å‡½æ•°ç»“æœ: {result}")
            
            # æ·»åŠ åˆ°å†å²
            self.conversation_history.append(message)
            self.conversation_history.append({
                "role": "function",
                "name": function_name,
                "content": json.dumps(result, ensure_ascii=False)
            })
            
            # å†æ¬¡è°ƒç”¨AIç”Ÿæˆå›ç­”
            second_response = openai.ChatCompletion.create(
                model="gpt-4",
                messages=self.conversation_history
            )
            
            final_message = second_response.choices[0].message
            self.conversation_history.append(final_message)
            
            return final_message["content"]
        else:
            # ç›´æ¥å›ç­”
            self.conversation_history.append(message)
            return message["content"]

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 4. æµ‹è¯•åœºæ™¯
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if __name__ == "__main__":
    service = SmartCustomerService()
    
    print("=== æ™ºèƒ½å®¢æœç³»ç»Ÿ ===\n")
    
    # åœºæ™¯1ï¼šæŸ¥è¯¢è®¢å•
    print("å®¢æˆ·: æˆ‘çš„è®¢å•ORD001æ€ä¹ˆæ ·äº†ï¼Ÿ")
    response = service.handle_customer_query("æˆ‘çš„è®¢å•ORD001æ€ä¹ˆæ ·äº†ï¼Ÿ")
    print(f"å®¢æœ: {response}\n")
    
    # åœºæ™¯2ï¼šæŸ¥è¯¢äº§å“
    print("å®¢æˆ·: iPhone 15å¤šå°‘é’±ï¼Ÿæœ‰è´§å—ï¼Ÿ")
    response = service.handle_customer_query("iPhone 15å¤šå°‘é’±ï¼Ÿæœ‰è´§å—ï¼Ÿ")
    print(f"å®¢æœ: {response}\n")
    
    # åœºæ™¯3ï¼šå¤æ‚é—®é¢˜åˆ›å»ºå·¥å•
    print("å®¢æˆ·: æˆ‘è¦é€€è´§ï¼Œäº§å“æœ‰è´¨é‡é—®é¢˜")
    response = service.handle_customer_query("æˆ‘è¦é€€è´§ï¼Œäº§å“æœ‰è´¨é‡é—®é¢˜")
    print(f"å®¢æœ: {response}\n")
    
    # åœºæ™¯4ï¼šå¤šè½®å¯¹è¯
    print("å®¢æˆ·: é‚£MacBook Proå‘¢ï¼Ÿ")
    response = service.handle_customer_query("é‚£MacBook Proå‘¢ï¼Ÿ")
    print(f"å®¢æœ: {response}\n")
```

**è¿è¡Œæ•ˆæœ**ï¼š

```
=== æ™ºèƒ½å®¢æœç³»ç»Ÿ ===

å®¢æˆ·: æˆ‘çš„è®¢å•ORD001æ€ä¹ˆæ ·äº†ï¼Ÿ
[ç³»ç»Ÿ] è°ƒç”¨å‡½æ•°: query_order_status({'order_id': 'ORD001'})
[ç³»ç»Ÿ] å‡½æ•°ç»“æœ: {'order_id': 'ORD001', 'status': 'å·²å‘è´§', 'tracking': 'SF1234567890'}
å®¢æœ: æ‚¨å¥½ï¼æ‚¨çš„è®¢å•ORD001å·²ç»å‘è´§å•¦ï¼Œç‰©æµå•å·æ˜¯SF1234567890ã€‚
     æ‚¨å¯ä»¥é€šè¿‡é¡ºä¸°å®˜ç½‘æˆ–AppæŸ¥è¯¢å®æ—¶ç‰©æµä¿¡æ¯ã€‚é¢„è®¡2-3å¤©å†…é€è¾¾ï¼Œè¯·æ³¨æ„æŸ¥æ”¶ï¼

å®¢æˆ·: iPhone 15å¤šå°‘é’±ï¼Ÿæœ‰è´§å—ï¼Ÿ
[ç³»ç»Ÿ] è°ƒç”¨å‡½æ•°: query_product_info({'product_name': 'iPhone 15'})
[ç³»ç»Ÿ] å‡½æ•°ç»“æœ: {'name': 'iPhone 15', 'price': 5999, 'stock': 100, 'description': 'Appleæœ€æ–°æ¬¾æ‰‹æœº'}
å®¢æœ: iPhone 15ç›®å‰çš„ä»·æ ¼æ˜¯5999å…ƒï¼Œåº“å­˜å……è¶³ï¼ˆ100å°ï¼‰ã€‚
     è¿™æ˜¯Appleæœ€æ–°æ¬¾æ‰‹æœºï¼Œæ€§èƒ½å¼ºå¤§ï¼Œæ¬¢è¿ä¸‹å•ï¼å¦‚éœ€å¸®åŠ©ï¼Œè¯·éšæ—¶å‘Šè¯‰æˆ‘ã€‚

å®¢æˆ·: æˆ‘è¦é€€è´§ï¼Œäº§å“æœ‰è´¨é‡é—®é¢˜
[ç³»ç»Ÿ] è°ƒç”¨å‡½æ•°: create_ticket({'issue_type': 'é€€è´§', 'description': 'äº§å“æœ‰è´¨é‡é—®é¢˜'})
[ç³»ç»Ÿ] å‡½æ•°ç»“æœ: {'ticket_id': 'a3b4c5d6', 'issue_type': 'é€€è´§', ...}
å®¢æœ: éå¸¸æŠ±æ­‰ç»™æ‚¨å¸¦æ¥äº†ä¸ä¾¿ã€‚æˆ‘å·²ç»ä¸ºæ‚¨åˆ›å»ºäº†é€€è´§å·¥å•ï¼ˆå·¥å•å·ï¼ša3b4c5d6ï¼‰ã€‚
     æˆ‘ä»¬çš„ä¸“ä¸šå®¢æœä¼šåœ¨24å°æ—¶å†…ä¸æ‚¨è”ç³»ï¼ŒååŠ©æ‚¨å¤„ç†é€€è´§äº‹å®œã€‚
     è¯·ä¿æŒç”µè¯ç•…é€šï¼Œæ„Ÿè°¢æ‚¨çš„ç†è§£ï¼
```

### 7.2 æ•°æ®åˆ†æåŠ©æ‰‹

```python
import pandas as pd
import numpy as np
import json

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1. æ•°æ®åˆ†æå‡½æ•°
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# æ¨¡æ‹Ÿæ•°æ®
sales_data = pd.DataFrame({
    'date': pd.date_range('2024-01-01', periods=100),
    'product': np.random.choice(['A', 'B', 'C'], 100),
    'sales': np.random.randint(100, 1000, 100),
    'revenue': np.random.randint(1000, 10000, 100)
})

def get_sales_summary(start_date: str = None, end_date: str = None) -> dict:
    """è·å–é”€å”®æ±‡æ€»"""
    df = sales_data.copy()
    
    if start_date:
        df = df[df['date'] >= start_date]
    if end_date:
        df = df[df['date'] <= end_date]
    
    return {
        "total_sales": int(df['sales'].sum()),
        "total_revenue": int(df['revenue'].sum()),
        "avg_sales": float(df['sales'].mean()),
        "date_range": f"{df['date'].min()} åˆ° {df['date'].max()}"
    }

def get_product_ranking(metric: str = "sales", limit: int = 3) -> dict:
    """è·å–äº§å“æ’å"""
    if metric == "sales":
        ranking = sales_data.groupby('product')['sales'].sum().sort_values(ascending=False)
    else:
        ranking = sales_data.groupby('product')['revenue'].sum().sort_values(ascending=False)
    
    return {
        "metric": metric,
        "ranking": [
            {"product": product, "value": int(value)}
            for product, value in ranking.head(limit).items()
        ]
    }

def analyze_trend(product: str = None) -> dict:
    """åˆ†æé”€å”®è¶‹åŠ¿"""
    df = sales_data.copy()
    
    if product:
        df = df[df['product'] == product]
    
    # ç®€å•çš„è¶‹åŠ¿åˆ†æï¼ˆçº¿æ€§å›å½’ï¼‰
    from scipy import stats
    x = np.arange(len(df))
    y = df['sales'].values
    slope, intercept, r_value, p_value, std_err = stats.linregress(x, y)
    
    trend = "ä¸Šå‡" if slope > 0 else "ä¸‹é™"
    
    return {
        "product": product if product else "å…¨éƒ¨",
        "trend": trend,
        "slope": float(slope),
        "correlation": float(r_value)
    }

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2. Functions Schema
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
analyst_functions = [
    {
        "name": "get_sales_summary",
        "description": "è·å–é”€å”®æ•°æ®æ±‡æ€»ï¼ŒåŒ…æ‹¬æ€»é”€é‡ã€æ€»æ”¶å…¥ã€å¹³å‡å€¼ç­‰",
        "parameters": {
            "type": "object",
            "properties": {
                "start_date": {
                    "type": "string",
                    "description": "å¼€å§‹æ—¥æœŸï¼Œæ ¼å¼ï¼šYYYY-MM-DD"
                },
                "end_date": {
                    "type": "string",
                    "description": "ç»“æŸæ—¥æœŸï¼Œæ ¼å¼ï¼šYYYY-MM-DD"
                }
            }
        }
    },
    {
        "name": "get_product_ranking",
        "description": "è·å–äº§å“æ’åï¼Œå¯ä»¥æŒ‰é”€é‡æˆ–æ”¶å…¥æ’åº",
        "parameters": {
            "type": "object",
            "properties": {
                "metric": {
                    "type": "string",
                    "enum": ["sales", "revenue"],
                    "description": "æ’åæŒ‡æ ‡ï¼šsalesï¼ˆé”€é‡ï¼‰æˆ–revenueï¼ˆæ”¶å…¥ï¼‰"
                },
                "limit": {
                    "type": "integer",
                    "description": "è¿”å›å‰Nåï¼Œé»˜è®¤3"
                }
            }
        }
    },
    {
        "name": "analyze_trend",
        "description": "åˆ†æé”€å”®è¶‹åŠ¿ï¼Œåˆ¤æ–­æ˜¯ä¸Šå‡è¿˜æ˜¯ä¸‹é™",
        "parameters": {
            "type": "object",
            "properties": {
                "product": {
                    "type": "string",
                    "description": "äº§å“åç§°ï¼Œå¦‚æœä¸æŒ‡å®šåˆ™åˆ†æå…¨éƒ¨äº§å“"
                }
            }
        }
    }
]

# ä½¿ç”¨ç¤ºä¾‹
"""
ç”¨æˆ·: "æœ€è¿‘ä¸€å‘¨é”€å”®æƒ…å†µæ€ä¹ˆæ ·ï¼Ÿ"
AI: è°ƒç”¨get_sales_summary(start_date="2024-04-20", end_date="2024-04-27")

ç”¨æˆ·: "å“ªä¸ªäº§å“å–å¾—æœ€å¥½ï¼Ÿ"
AI: è°ƒç”¨get_product_ranking(metric="sales", limit=3)

ç”¨æˆ·: "äº§å“Açš„é”€å”®è¶‹åŠ¿å¦‚ä½•ï¼Ÿ"
AI: è°ƒç”¨analyze_trend(product="A")
```


---

## 8. è¿›é˜¶æŠ€å·§

### 8.1 æ¡ä»¶å‡½æ•°è°ƒç”¨

```python
def get_available_functions(user_context: dict) -> list:
    """æ ¹æ®ç”¨æˆ·ä¸Šä¸‹æ–‡åŠ¨æ€æä¾›å‡½æ•°"""
    all_functions = {
        "get_weather": weather_function,
        "send_email": email_function,
        "query_database": database_function,
        "delete_data": delete_function
    }
    
    available = []
    
    # æ‰€æœ‰ç”¨æˆ·éƒ½èƒ½æŸ¥å¤©æ°”
    available.append(all_functions["get_weather"])
    
    # ç™»å½•ç”¨æˆ·èƒ½å‘é‚®ä»¶
    if user_context.get("logged_in"):
        available.append(all_functions["send_email"])
    
    # VIPç”¨æˆ·èƒ½æŸ¥è¯¢æ•°æ®åº“
    if user_context.get("is_vip"):
        available.append(all_functions["query_database"])
    
    # ç®¡ç†å‘˜èƒ½åˆ é™¤æ•°æ®
    if user_context.get("is_admin"):
        available.append(all_functions["delete_data"])
    
    return available

# ä½¿ç”¨
user_context = {"logged_in": True, "is_vip": False, "is_admin": False}
functions = get_available_functions(user_context)

response = openai.ChatCompletion.create(
    model="gpt-4",
    messages=messages,
    functions=functions  # åŠ¨æ€å‡½æ•°åˆ—è¡¨
)
```

### 8.2 å‡½æ•°é“¾å¼è°ƒç”¨

```python
def handle_complex_query(user_input: str):
    """å¤„ç†éœ€è¦å¤šä¸ªå‡½æ•°çš„å¤æ‚æŸ¥è¯¢"""
    
    # ç¤ºä¾‹ï¼šç”¨æˆ·é—®"åŒ—äº¬å’Œä¸Šæµ·å“ªä¸ªåŸå¸‚æ¸©åº¦æ›´é€‚åˆæ—…æ¸¸ï¼Ÿ"
    # éœ€è¦ï¼š1. æŸ¥åŒ—äº¬å¤©æ°”  2. æŸ¥ä¸Šæµ·å¤©æ°”  3. å¯¹æ¯”åˆ†æ
    
    messages = [{"role": "user", "content": user_input}]
    
    # ç¬¬ä¸€è½®ï¼šAIå¯èƒ½å†³å®šè°ƒç”¨å¤šä¸ªå‡½æ•°
    response = openai.ChatCompletion.create(
        model="gpt-4",
        messages=messages,
        functions=functions
    )
    
    # å¾ªç¯å¤„ç†ï¼Œç›´åˆ°AIä¸å†è°ƒç”¨å‡½æ•°
    while True:
        message = response.choices[0].message
        
        if not message.get("function_call"):
            # AIå·²ç»æœ‰è¶³å¤Ÿä¿¡æ¯ï¼Œç”Ÿæˆæœ€ç»ˆå›ç­”
            return message["content"]
        
        # æ‰§è¡Œå‡½æ•°
        function_call = message["function_call"]
        result = execute_function_call(function_call)
        
        # æ·»åŠ åˆ°å†å²
        messages.append(message)
        messages.append({
            "role": "function",
            "name": function_call["name"],
            "content": json.dumps(result)
        })
        
        # ç»§ç»­å¯¹è¯
        response = openai.ChatCompletion.create(
            model="gpt-4",
            messages=messages,
            functions=functions
        )

# æµ‹è¯•
result = handle_complex_query("åŒ—äº¬å’Œä¸Šæµ·å“ªä¸ªåŸå¸‚æ¸©åº¦æ›´é€‚åˆæ—…æ¸¸ï¼Ÿ")
print(result)

# AIçš„å¤„ç†æµç¨‹ï¼š
# 1. è°ƒç”¨get_weather(location="åŒ—äº¬")
# 2. è°ƒç”¨get_weather(location="ä¸Šæµ·")
# 3. åŸºäºä¸¤æ¬¡ç»“æœè¿›è¡Œå¯¹æ¯”
# 4. ç”Ÿæˆå›ç­”ï¼š"åŒ—äº¬æ°”æ¸©25Â°Cï¼Œä¸Šæµ·28Â°Cï¼ŒåŒ—äº¬æ›´å‡‰çˆ½èˆ’é€‚..."
```

### 8.3 æµå¼å“åº”ï¼ˆStreamingï¼‰

```python
import openai

def chat_with_streaming(user_input: str):
    """æ”¯æŒæµå¼è¾“å‡ºçš„Function Calling"""
    messages = [{"role": "user", "content": user_input}]
    
    # æµå¼è°ƒç”¨
    stream = openai.ChatCompletion.create(
        model="gpt-4",
        messages=messages,
        functions=functions,
        stream=True  # å¯ç”¨æµå¼å“åº”
    )
    
    accumulated_message = {
        "role": "assistant",
        "content": "",
        "function_call": None
    }
    
    # å¤„ç†æµå¼æ•°æ®
    for chunk in stream:
        delta = chunk.choices[0].delta
        
        # ç´¯ç§¯å†…å®¹
        if delta.get("content"):
            accumulated_message["content"] += delta["content"]
            print(delta["content"], end="", flush=True)
        
        # å¤„ç†function_call
        if delta.get("function_call"):
            if not accumulated_message["function_call"]:
                accumulated_message["function_call"] = {
                    "name": "",
                    "arguments": ""
                }
            
            if delta["function_call"].get("name"):
                accumulated_message["function_call"]["name"] += delta["function_call"]["name"]
            
            if delta["function_call"].get("arguments"):
                accumulated_message["function_call"]["arguments"] += delta["function_call"]["arguments"]
    
    # å¦‚æœæœ‰function_callï¼Œæ‰§è¡Œå®ƒ
    if accumulated_message["function_call"]:
        print(f"\n\n[è°ƒç”¨å‡½æ•°: {accumulated_message['function_call']['name']}]")
        
        result = execute_function_call(accumulated_message["function_call"])
        
        # å°†ç»“æœè¿”å›AIï¼Œç»§ç»­æµå¼è¾“å‡º
        messages.append(accumulated_message)
        messages.append({
            "role": "function",
            "name": accumulated_message["function_call"]["name"],
            "content": json.dumps(result)
        })
        
        # å†æ¬¡æµå¼è°ƒç”¨
        print("\n")
        second_stream = openai.ChatCompletion.create(
            model="gpt-4",
            messages=messages,
            stream=True
        )
        
        for chunk in second_stream:
            delta = chunk.choices[0].delta
            if delta.get("content"):
                print(delta["content"], end="", flush=True)
        
        print("\n")
```

### 8.4 å¹¶è¡Œå‡½æ•°è°ƒç”¨ä¼˜åŒ–

```python
import asyncio
import aiohttp

async def execute_function_async(function_name: str, function_args: dict):
    """å¼‚æ­¥æ‰§è¡Œå‡½æ•°"""
    # æ¨¡æ‹Ÿå¼‚æ­¥APIè°ƒç”¨
    await asyncio.sleep(1)  # æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
    
    if function_name == "get_weather":
        return await fetch_weather_async(**function_args)
    elif function_name == "search_web":
        return await search_web_async(**function_args)

async def handle_parallel_function_calls(function_calls: list):
    """å¹¶è¡Œæ‰§è¡Œå¤šä¸ªå‡½æ•°è°ƒç”¨"""
    # åˆ›å»ºæ‰€æœ‰ä»»åŠ¡
    tasks = [
        execute_function_async(fc["name"], json.loads(fc["arguments"]))
        for fc in function_calls
    ]
    
    # å¹¶è¡Œæ‰§è¡Œ
    results = await asyncio.gather(*tasks)
    
    # è¿”å›ç»“æœ
    return [
        {
            "role": "function",
            "name": function_calls[i]["name"],
            "content": json.dumps(results[i])
        }
        for i in range(len(function_calls))
    ]

# ä½¿ç”¨ç¤ºä¾‹
async def main():
    user_input = "åŒ—äº¬ã€ä¸Šæµ·ã€æ·±åœ³çš„å¤©æ°”åˆ†åˆ«æ˜¯ä»€ä¹ˆï¼Ÿ"
    
    # ç¬¬ä¸€æ¬¡è°ƒç”¨AI
    response = openai.ChatCompletion.create(
        model="gpt-4",
        messages=[{"role": "user", "content": user_input}],
        functions=functions
    )
    
    # æ£€æŸ¥æ˜¯å¦æœ‰å¤šä¸ªå‡½æ•°è°ƒç”¨ï¼ˆGPT-4æ”¯æŒï¼‰
    message = response.choices[0].message
    
    if hasattr(message, "tool_calls"):
        # å¹¶è¡Œæ‰§è¡Œæ‰€æœ‰å‡½æ•°
        function_results = await handle_parallel_function_calls(
            [tc.function for tc in message.tool_calls]
        )
        
        print(f"å¹¶è¡Œæ‰§è¡Œäº† {len(function_results)} ä¸ªå‡½æ•°")
        
        # ç»§ç»­å¯¹è¯...

# è¿è¡Œ
asyncio.run(main())
```

### 8.5 å‡½æ•°è°ƒç”¨ç»Ÿè®¡å’Œç›‘æ§

```python
from datetime import datetime
from collections import defaultdict

class FunctionCallMonitor:
    """å‡½æ•°è°ƒç”¨ç›‘æ§"""
    def __init__(self):
        self.call_history = []
        self.stats = defaultdict(int)
    
    def log_call(self, function_name: str, arguments: dict, result: any, duration: float):
        """è®°å½•å‡½æ•°è°ƒç”¨"""
        log_entry = {
            "timestamp": datetime.now().isoformat(),
            "function": function_name,
            "arguments": arguments,
            "result": result,
            "duration": duration,
            "success": not result.get("error")
        }
        
        self.call_history.append(log_entry)
        self.stats[function_name] += 1
    
    def get_stats(self) -> dict:
        """è·å–ç»Ÿè®¡ä¿¡æ¯"""
        total_calls = len(self.call_history)
        success_calls = sum(1 for log in self.call_history if log["success"])
        
        avg_duration_by_function = {}
        for function_name in self.stats.keys():
            durations = [
                log["duration"]
                for log in self.call_history
                if log["function"] == function_name
            ]
            avg_duration_by_function[function_name] = sum(durations) / len(durations)
        
        return {
            "total_calls": total_calls,
            "success_rate": success_calls / total_calls if total_calls > 0 else 0,
            "calls_by_function": dict(self.stats),
            "avg_duration_by_function": avg_duration_by_function
        }
    
    def get_recent_failures(self, limit: int = 10) -> list:
        """è·å–æœ€è¿‘çš„å¤±è´¥è®°å½•"""
        failures = [log for log in self.call_history if not log["success"]]
        return failures[-limit:]

# ä½¿ç”¨
monitor = FunctionCallMonitor()

def execute_function_call_with_monitoring(function_call):
    """å¸¦ç›‘æ§çš„å‡½æ•°æ‰§è¡Œ"""
    import time
    
    start_time = time.time()
    function_name = function_call["name"]
    function_args = json.loads(function_call["arguments"])
    
    # æ‰§è¡Œå‡½æ•°
    result = execute_function_call(function_call)
    
    # è®°å½•
    duration = time.time() - start_time
    monitor.log_call(function_name, function_args, result, duration)
    
    return result

# æŸ¥çœ‹ç»Ÿè®¡
print(monitor.get_stats())
# {
#   "total_calls": 150,
#   "success_rate": 0.96,
#   "calls_by_function": {
#     "get_weather": 80,
#     "search_web": 50,
#     "send_email": 20
#   },
#   "avg_duration_by_function": {
#     "get_weather": 0.5,
#     "search_web": 1.2,
#     "send_email": 0.3
#   }
# }
```

### 8.6 A/Bæµ‹è¯•ä¸åŒçš„Function Descriptions

```python
class FunctionABTester:
    """æµ‹è¯•ä¸åŒçš„å‡½æ•°æè¿°æ•ˆæœ"""
    def __init__(self):
        self.variants = {}
        self.results = defaultdict(lambda: {"calls": 0, "correct": 0})
    
    def add_variant(self, variant_name: str, functions: list):
        """æ·»åŠ æµ‹è¯•å˜ä½“"""
        self.variants[variant_name] = functions
    
    def test_query(self, user_query: str, expected_function: str):
        """æµ‹è¯•æŸ¥è¯¢"""
        for variant_name, functions in self.variants.items():
            # è°ƒç”¨AI
            response = openai.ChatCompletion.create(
                model="gpt-4",
                messages=[{"role": "user", "content": user_query}],
                functions=functions,
                function_call="auto"
            )
            
            # æ£€æŸ¥AIé€‰æ‹©çš„å‡½æ•°
            message = response.choices[0].message
            if message.get("function_call"):
                chosen_function = message["function_call"]["name"]
                
                self.results[variant_name]["calls"] += 1
                
                if chosen_function == expected_function:
                    self.results[variant_name]["correct"] += 1
    
    def get_results(self) -> dict:
        """è·å–æµ‹è¯•ç»“æœ"""
        return {
            variant: {
                "accuracy": results["correct"] / results["calls"] if results["calls"] > 0 else 0,
                "total_calls": results["calls"]
            }
            for variant, results in self.results.items()
        }

# ä½¿ç”¨ç¤ºä¾‹
tester = FunctionABTester()

# å˜ä½“Aï¼šç®€å•æè¿°
tester.add_variant("simple", [
    {
        "name": "get_weather",
        "description": "Get weather information",
        "parameters": {...}
    }
])

# å˜ä½“Bï¼šè¯¦ç»†æè¿°
tester.add_variant("detailed", [
    {
        "name": "get_weather",
        "description": """
        è·å–æŒ‡å®šåŸå¸‚çš„å®æ—¶å¤©æ°”ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ¸©åº¦ã€å¤©æ°”çŠ¶å†µã€æ¹¿åº¦ç­‰ã€‚
        é€‚ç”¨åœºæ™¯ï¼šç”¨æˆ·è¯¢é—®å¤©æ°”ã€æ°”æ¸©ã€ä¸‹é›¨ç­‰ç›¸å…³é—®é¢˜ã€‚
        å…³é”®è¯ï¼šå¤©æ°”ã€æ°”æ¸©ã€ä¸‹é›¨ã€æ™´å¤©ã€å¤šäº‘ç­‰ã€‚
        """,
        "parameters": {...}
    }
])

# æµ‹è¯•å¤šä¸ªæŸ¥è¯¢
test_cases = [
    ("åŒ—äº¬å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ", "get_weather"),
    ("ä»Šå¤©ä¸‹é›¨å—ï¼Ÿ", "get_weather"),
    ("æ°”æ¸©å¤šå°‘åº¦ï¼Ÿ", "get_weather"),
]

for query, expected in test_cases:
    tester.test_query(query, expected)

# æŸ¥çœ‹ç»“æœ
print(tester.get_results())
# {
#   "simple": {"accuracy": 0.85, "total_calls": 3},
#   "detailed": {"accuracy": 0.95, "total_calls": 3}
# }
```

---

## 9. æ€»ç»“

### 9.1 æ ¸å¿ƒè¦ç‚¹

```
1. Function Calling æ˜¯ä»€ä¹ˆï¼Ÿ
   - AIæ¨¡å‹çš„èƒ½åŠ›ï¼Œè€Œéç‹¬ç«‹åè®®
   - è®©AIèƒ½å¤Ÿç”Ÿæˆç»“æ„åŒ–çš„å‡½æ•°è°ƒç”¨è¯·æ±‚
   - å¼€å‘è€…è´Ÿè´£æ‰§è¡Œå‡½æ•°

2. å·¥ä½œåŸç†
   - å®šä¹‰Functions Schema
   - AIåˆ†æç”¨æˆ·æ„å›¾ï¼Œé€‰æ‹©å‡½æ•°ï¼Œæå–å‚æ•°
   - è¿”å›function_callç»“æ„
   - å¼€å‘è€…æ‰§è¡Œå¹¶è¿”å›ç»“æœ
   - AIåŸºäºç»“æœç”Ÿæˆå›ç­”

3. æ ¸å¿ƒä»·å€¼
   - è®©AIèƒ½ä¸å¤–éƒ¨ç³»ç»Ÿäº¤äº’
   - è·å–å®æ—¶æ•°æ®
   - æ‰§è¡Œå®é™…æ“ä½œ
   - æ‰©å±•AIèƒ½åŠ›è¾¹ç•Œ

4. å…³é”®æŠ€å·§
   - descriptionè¦è¯¦ç»†æ¸…æ™°
   - å‡½æ•°è®¾è®¡éµå¾ªå•ä¸€èŒè´£
   - åšå¥½é”™è¯¯å¤„ç†å’Œå‚æ•°éªŒè¯
   - æ³¨æ„å®‰å…¨æ€§å’Œæƒé™æ§åˆ¶
```

### 9.2 é€‚ç”¨åœºæ™¯

```
âœ… é€‚åˆä½¿ç”¨Function Callingï¼š
- éœ€è¦å®æ—¶æ•°æ®ï¼ˆå¤©æ°”ã€è‚¡ç¥¨ã€æ–°é—»ï¼‰
- éœ€è¦æŸ¥è¯¢æ•°æ®åº“
- éœ€è¦è°ƒç”¨å¤–éƒ¨API
- éœ€è¦æ‰§è¡Œæ“ä½œï¼ˆå‘é‚®ä»¶ã€åˆ›å»ºå·¥å•ï¼‰
- æ™ºèƒ½å®¢æœã€æ•°æ®åˆ†æç­‰åœºæ™¯

âŒ ä¸é€‚åˆä½¿ç”¨ï¼š
- çº¯ç²¹çš„çŸ¥è¯†é—®ç­”ï¼ˆAIè‡ªå¸¦çŸ¥è¯†ï¼‰
- ç®€å•çš„æ–‡æœ¬å¯¹è¯
- ä¸éœ€è¦å¤–éƒ¨æ•°æ®çš„åœºæ™¯
```

### 9.3 ä¸MCPçš„å…³ç³»

```
Function Callingï¼š
- AIæ¨¡å‹çš„èƒ½åŠ›
- æ‰‹åŠ¨æ‰§è¡Œå’Œç®¡ç†
- é€‚åˆå•ä¸ªåº”ç”¨

MCPï¼ˆModel Context Protocolï¼‰ï¼š
- ç‹¬ç«‹çš„åè®®æ ‡å‡†
- Serverè‡ªåŠ¨æ‰§è¡Œ
- é€‚åˆè·¨åº”ç”¨å¤ç”¨

é€‰æ‹©å»ºè®®ï¼š
- ç®€å•åœºæ™¯ â†’ Function Calling
- å¤æ‚åœºæ™¯ + å¤šåº”ç”¨å¤ç”¨ â†’ MCP
- ä¹Ÿå¯ä»¥ç»“åˆä½¿ç”¨
```

---

## é™„å½•

### A. å¸¸ç”¨Resources Schema

```python
# å¤©æ°”æŸ¥è¯¢
weather_function = {
    "name": "get_weather",
    "description": "è·å–åŸå¸‚å¤©æ°”ä¿¡æ¯",
    "parameters": {
        "type": "object",
        "properties": {
            "location": {"type": "string", "description": "åŸå¸‚å"},
            "unit": {"type": "string", "enum": ["celsius", "fahrenheit"]}
        },
        "required": ["location"]
    }
}

# ç½‘é¡µæœç´¢
search_function = {
    "name": "search_web",
    "description": "æœç´¢äº’è”ç½‘ä¿¡æ¯",
    "parameters": {
        "type": "object",
        "properties": {
            "query": {"type": "string", "description": "æœç´¢å…³é”®è¯"},
            "max_results": {"type": "integer", "description": "æœ€å¤§ç»“æœæ•°"}
        },
        "required": ["query"]
    }
}

# æ•°æ®åº“æŸ¥è¯¢
database_function = {
    "name": "query_database",
    "description": "æŸ¥è¯¢æ•°æ®åº“",
    "parameters": {
        "type": "object",
        "properties": {
            "table": {"type": "string", "description": "è¡¨å"},
            "conditions": {"type": "object", "description": "æŸ¥è¯¢æ¡ä»¶"}
        },
        "required": ["table"]
    }
}
```

### B. å‚è€ƒèµ„æº

- OpenAI Function Callingæ–‡æ¡£ï¼šhttps://platform.openai.com/docs/guides/function-calling
- Claude Tool Useæ–‡æ¡£ï¼šhttps://docs.anthropic.com/claude/docs/tool-use
- Google Gemini Function Callingï¼šhttps://ai.google.dev/docs/function_calling

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2024-10-27  
**ä½œè€…**: AIæŠ€æœ¯æ–‡æ¡£å›¢é˜Ÿ

